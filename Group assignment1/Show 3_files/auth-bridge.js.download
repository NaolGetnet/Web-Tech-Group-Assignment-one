/**
 * IMPORTANT NOTE:
 *
 * This file is licensed only for the use of Apple developers in providing MusicKit Web Services,
 * and is subject to the Apple Media Services Terms and Conditions and the Apple Developer Program
 * License Agreement. You may not copy, modify, re-host, or create derivative works of this file or the
 * accompanying Documentation, or any part thereof, including any updates, without Apple's written consent.
 *
 * ACKNOWLEDGEMENTS:
 * https://js-cdn.music.apple.com/musickit/v1/acknowledgements.txt
 */

!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";void 0!==typeof self&&self;function getCookie(e="",t=document.cookie){const o=t.match(new RegExp(`(?:^|;\\s*)${e}=([^;]*)`));if(o)return o[1]}function setCookie(e,t,o="",i=14,n,r){const s=new Date;n=null!=n?n:window;const a=(r=null!=r?r:/\./.test(n.location.hostname)?n.location.hostname:"").length>0?`domain=${r}; `:"";s.setTime(s.getTime()+24*i*60*60*1e3);let l="";"https:"===n.location.protocol&&(l="; secure"),n.document.cookie=`${e}=${t}; expires=${s.toUTCString()}; ${a}path=${o}${l}`}function removeCookie(e,t,o){setCookie(e,"","/",0,t,o)}function getLocalStorage(){let e;return function(){let e=!1;try{e="undefined"!=typeof localStorage}catch(t){}return e}()&&(e=localStorage),e}var e="undefined"!=typeof FastBoot?FastBoot.require("buffer").Buffer:"undefined"!=typeof process&&null!==process.versions&&null!==process.versions.node?Buffer:window.Buffer;function memoize(e){return function(...t){let o="",i=t.length;for(e._memoized=e._memoized||{};i--;){const e=t[i];o+=e===Object(e)?JSON.stringify(e):e}return o in e._memoized?e._memoized[o]:e._memoized[o]=e(...t)}}function isNodeEnvironment(e){const isDefined=e=>null!=e;return 0===arguments.length&&"undefined"!=typeof process&&(e=process),isDefined(e)&&isDefined(e.versions)&&isDefined(e.versions.node)||"undefined"!=typeof FastBoot}memoize(isNodeEnvironment()?t=>e.from(t,"base64").toString("binary"):e=>window.atob(e)),memoize(isNodeEnvironment()?t=>e.from(t).toString("base64"):e=>window.btoa(e));const debounce=(e,t=250,o={isImmediate:!1})=>{let i;return function(...n){const r=this,s=o.isImmediate&&void 0===i;void 0!==i&&clearTimeout(i),i=setTimeout((function(){i=void 0,o.isImmediate||e.apply(r,n)}),t),s&&e.apply(r,n)}};function hasOwn(e,t){return Object.prototype.hasOwnProperty.call(Object(e),t)}const t=["trace","debug","info","warn","error"];class Nonsole{}t.forEach(e=>{Nonsole.prototype[e]=()=>{}});const o=new Nonsole,getConsole=()=>"undefined"==typeof console?o:console,i={};class StringDevFlag extends class{get value(){return this.get()}get configured(){return void 0!==this.value}read(){var e,t;const o=null!==(t=null===(e=getLocalStorage())||void 0===e?void 0:e.getItem(this.key))&&void 0!==t?t:null;return null!==o?o:void 0}write(e){var t;null===(t=getLocalStorage())||void 0===t||t.setItem(this.key,e)}clear(){var e;null===(e=getLocalStorage())||void 0===e||e.removeItem(this.key)}constructor(e){if("string"!=typeof e||""===e.trim())throw new Error("DevFlag requires a non-empty string key");this.key=e}}{static register(e){return function(e,t){const o=e.toLowerCase().replace(/[^a-zA-Z0-9]+(.)/g,(e,t)=>t.toUpperCase());if(hasOwn(i,o)){const n=i[o];if(t!==n.constructor)throw new Error(`DevFlag ${e} was already registered with a different type (${n.constructor.name})`);return n}const n=new t(e);return Object.defineProperty(i,o,{configurable:!0,enumerable:!0,get:function(){return n},set(e){n.set(e)}}),n}(e,this)}static get(e){return this.register(e).get()}static set(e,t){this.register(e).set(t)}get(){return this.read()}set(e){"string"!=typeof e&&console.warn("Value for StringDevFlag should be a string"),this.write(e)}}StringDevFlag.register("mk-debug"),StringDevFlag.register("mk-debug-topic");const n=getLocalStorage(),getConfiguredLevel=(e="mk-debug",o=t.length)=>parseInt(r(e,o),10),r=memoize((e,t)=>{var o,i;return null!==(i=null==n||null===(o=n.getItem)||void 0===o?void 0:o.call(n,e))&&void 0!==i?i:""+t}),getAllowedLevels=e=>isNaN(e)||e<0?[]:t.slice(e),canLogTopic=(e,t)=>{const o=((e="mk-debug-topic",t="*")=>r(e,t))(t);return s(o).some(t=>t.test(e))},s=memoize(e=>e.split(/[\s,]+/).map(e=>{const t=e.replace(/\*/g,".*?");return new RegExp("^"+t+"$")}));function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},i=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(o).filter((function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable})))),i.forEach((function(t){_defineProperty(e,t,o[t])}))}return e}const trace=(e,...t)=>logMessage(_objectSpread({level:"trace"},e),...t),debug=(e,...t)=>logMessage(_objectSpread({level:"debug"},e),...t),info=(e,...t)=>logMessage(_objectSpread({level:"info"},e),...t),warn=(e,...t)=>logMessage(_objectSpread({level:"warn"},e),...t),error=(e,...t)=>logMessage(_objectSpread({level:"error"},e),...t),log=(e,...t)=>logMessage(e,...t),logMessage=(e,...t)=>{let{level:o,levelKey:i,topic:n,topicKey:r}=e;if(o=null!=o?o:"debug",!((e,t)=>-1!==getAllowedLevels(getConfiguredLevel(t)).indexOf(e))(o,i))return;if(!canLogTopic(n,r))return;const s=getConsole();if("function"!=typeof s[o])return;let[a,...l]=t;void 0!==n&&(a=`${n}: ${a}`),s[o](a,...l)};class Logger{get enabled(){return this.level<5}set enabled(e){this.level=e?1:5}debug(e,...t){this.callLogMethod(debug,e,...t)}error(e,...t){this.callLogMethod(error,e,...t)}log(e,...t){this.callLogMethod(log,e,...t)}info(e,...t){this.callLogMethod(info,e,...t)}trace(e,...t){this.callLogMethod(trace,e,...t)}warn(e,...t){this.callLogMethod(warn,e,...t)}callLogMethod(e,t,...o){const i={levelKey:this._levelFilterKey,topicKey:this._topicFilterKey,topic:this.topic};let n=t;var r,s,a;"object"==typeof(a=t)&&null!==a&&"string"==typeof a.topic&&(i.topic=null!==(r=t.topic)&&void 0!==r?r:i.topic,n=null!==(s=t.message)&&void 0!==s?s:o.shift());e(i,n,...o)}generateDefaultTopicFilterStorageKey(e){return e+"-topic"}constructor(e){if(this._levelFilterKey="mk-debug","string"==typeof e)this._levelFilterKey=e,this.level=getConfiguredLevel(this._levelFilterKey,5);else if("object"==typeof e){var t,o,i;this._levelFilterKey=null!==(t=e.levelFilterStorageKey)&&void 0!==t?t:this._levelFilterKey,this._topicFilterKey=null!==(o=e.topicFilterStorageKey)&&void 0!==o?o:this.generateDefaultTopicFilterStorageKey(this._levelFilterKey),this.topic=e.topic,this.level=null!==(i=e.level)&&void 0!==i?i:getConfiguredLevel(this._levelFilterKey,5)}else this.level=null!=e?e:getConfiguredLevel(this._levelFilterKey,5);var n;this._topicFilterKey=null!==(n=this._topicFilterKey)&&void 0!==n?n:this.generateDefaultTopicFilterStorageKey(this._levelFilterKey)}}new Logger;const a=new Logger("sk-debug");var l,c;!function(e){e.DEFAULT_CID="pldfltcid",e.TV_CID="pltvcid",e.RESTRICTIONS_ENABLED="itre",e.STOREFRONT_COUNTRY_CODE="itua",e.USER_TOKEN="media-user-token"}(l||(l={})),function(e){e[e.MUSIC=0]="MUSIC",e[e.PODCAST=1]="PODCAST",e[e.TV=2]="TV"}(c||(c={}));const d=["apps.apple.com","books.apple.com","fitness.apple.com","mediaauth.apple.com","multidev.apple.com","music.apple.com","one.apple.com","podcasts.apple.com","tv.apple.com"];const u=Object.keys(l).map(e=>l[e]);function isFrameCookie(e){return-1!==u.indexOf(e)}function setFrameCookie(e,t){a.debug("auth-bridge: setFrameCookie",e,t),isFrameCookie(e)?(t=null!=t?t:"")?setCookie(e,t,"/",7):removeCookie(e):a.debug("auth-bridge: setFrameCookie ignoring",e)}(new class extends class{init(e,t){var o;this._receiveWindow=e,this._sendWindow=t,this.handleMessage=this.handleMessage.bind(this),null===(o=this._receiveWindow)||void 0===o||o.addEventListener("message",this.handleMessage)}sendMessage(e,t){const o={action:"mediakit:"+e,data:t};this._sendWindow&&this._sendWindow.postMessage(JSON.stringify(o),this._targetOrigin)}handleMessage(e){if(!this._isOriginAllowed(e.origin))return;let t;try{t=JSON.parse(e.data)}catch(i){}if(!t||!this._isNamespacedData(t))return;"*"===this._targetOrigin&&(this._targetOrigin=e.origin),a.debug("auth-bridge: handleMessage",t);const o=t.action.replace("mediakit:","");this[o]?this[o](t.data):a.debug("auth-bridge: unsupported method",o)}_isOriginAllowed(e){if(!e)return!1;const[t,o]=e.split("://");let i="";return o&&(i=o.split(":")[0],i&&(i=i.toLocaleLowerCase())),"https"===t&&!!i&&d.some(e=>i===e||i.endsWith("."+e))}_isNamespacedData(e){return e.action&&-1!==e.action.indexOf("mediakit:")}constructor(){this._targetOrigin="*"}}{destroy(){window.removeEventListener("storage",this.onStorageChange)}sendFrameInit(){this.sendMessage("frameInit")}onStorageChange(e){var t;const o=null===(t=e.key)||void 0===t?void 0:t.replace("mk-auth-bridge-storage-event-","");"cookie-updated"===o?this.debouncedRequestAuthUpdate():"auth-cleared"===o&&this.sendMessage("authClearedFromOtherFrame")}sendStorageEvent(e){const t=getLocalStorage();if(t)try{t.setItem("mk-auth-bridge-storage-event-"+e,""+Date.now())}catch(o){}}requestAuthUpdate(){const e={},t={enabled:this._enabled,cookies:e};this._cookieNames.forEach(t=>{const o=getCookie(t);o?(e[t]=o,this._enabled&&setFrameCookie(t,o)):e[t]=null}),this.sendMessage("updateAuth",t),this._enabled&&setTimeout(()=>this._cookieNames.forEach(e=>removeCookie(e,window,"apple.com")),1e3)}setCookieItem(e){const{name:t,value:o}=e;this._enabled&&setFrameCookie(t,o),this.debouncedRequestAuthUpdate(),isFrameCookie(t)&&this.sendStorageEvent("cookie-updated")}clearAuth(){let e=!1;this._cookieNames.forEach(t=>{getCookie(t)&&(e=!0),this._enabled&&removeCookie(t)}),this.requestAuthUpdate(),e&&this.sendStorageEvent("auth-cleared")}constructor(e){super(),this._cookieNames=[...u],this._enabled=!0,e&&hasOwn(e,"enabled")&&(this._enabled=e.enabled),this.debouncedRequestAuthUpdate=debounce(this.requestAuthUpdate.bind(this),2e3),this.onStorageChange=this.onStorageChange.bind(this),window.addEventListener("storage",this.onStorageChange),this.init(window,window.parent)}}).sendFrameInit()}));
