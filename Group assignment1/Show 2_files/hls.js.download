/*! For license information please see hls.js.LICENSE.txt */
!function l0(d0){const u0=this;var e,t;e=this,t=function(){"use strict";var _,e=e=>e&&e.Math===Math&&e,l=e("object"==typeof globalThis&&globalThis)||e("object"==typeof window&&window)||e("object"==typeof u0&&u0)||e("object"==typeof global&&global)||Function("return this")();class d{constructor(){this.keySize=null,this.ksRows=null,this.keySchedule=null,this.invKeySchedule=null,this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=Math.floor(t.byteLength/4),r=new Uint32Array(i);for(let e=0;e<i;e++)r[e]=t.getUint32(4*e);return r}initTable(){const e=this["sBox"],t=this["invSBox"],i=this["subMix"],r=i[0],n=i[1],s=i[2],a=i[3],o=this["invSubMix"],l=o[0],d=o[1],u=o[2],c=o[3],h=new Uint32Array(256);let p=0,f=0,m=0;for(m=0;m<256;m++)h[m]=m<128?m<<1:m<<1^283;for(m=0;m<256;m++){var g=(g=f^f<<1^f<<2^f<<3^f<<4)>>>8^255&g^99;e[p]=g,t[g]=p;const o=h[p],m=h[o],v=h[m];var y=257*h[g]^16843008*g;r[p]=y<<24|y>>>8,n[p]=y<<16|y>>>16,s[p]=y<<8|y>>>24,a[p]=y,y=16843009*v^65537*m^257*o^16843008*p,l[g]=y<<24|y>>>8,d[g]=y<<16|y>>>16,u[g]=y<<8|y>>>24,c[g]=y,p?(p=o^h[h[h[v^o]]],f^=h[h[f]]):p=f=1}}expandKey(e){var n=this.uint8ArrayToUint32Array_(e);let t=!0,i=0;for(;i<n.length&&t;)t=n[i]===this.key[i],i++;if(!t){this.key=n;var s=this.keySize=n.length;if(4!==s&&6!==s&&8!==s)throw new Error("Invalid aes key size="+s);var a=this.ksRows=4*(s+6+1);let e,t;const o=this.keySchedule=new Uint32Array(a),l=this.invKeySchedule=new Uint32Array(a),d=this.sBox,u=this["rcon"],c=this["invSubMix"],h=c[0],p=c[1],f=c[2],m=c[3];let i,r;for(e=0;e<a;e++)e<s?i=o[e]=n[e]:(r=i,e%s==0?(r=r<<8|r>>>24,r=d[r>>>24]<<24|d[r>>>16&255]<<16|d[r>>>8&255]<<8|d[255&r],r^=u[e/s|0]<<24):6<s&&e%s==4&&(r=d[r>>>24]<<24|d[r>>>16&255]<<16|d[r>>>8&255]<<8|d[255&r]),o[e]=i=(o[e-s]^r)>>>0);for(t=0;t<a;t++)e=a-t,r=3&t?o[e]:o[e-4],l[t]=t<4||e<=4?r:h[d[r>>>24]]^p[d[r>>>16&255]]^f[d[r>>>8&255]]^m[d[255&r]],l[t]=l[t]>>>0}}networkToHostOrderSwap(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,i){var r=this.keySize+6,n=this["invKeySchedule"],s=this.invSBox,a=this["invSubMix"],o=a[0],l=a[1],d=a[2],u=a[3],i=this.uint8ArrayToUint32Array_(i);let c=i[0],h=i[1],p=i[2],f=i[3];const m=new Int32Array(e),g=new Int32Array(m.length);let y,v,S,b,T,I,E,w,O,A,R,k,C,M;const P=this.networkToHostOrderSwap;for(;t<m.length;){for(O=P(m[t]),A=P(m[t+1]),R=P(m[t+2]),k=P(m[t+3]),T=O^n[0],I=k^n[1],E=R^n[2],w=A^n[3],C=4,M=1;M<r;M++)y=o[T>>>24]^l[I>>16&255]^d[E>>8&255]^u[255&w]^n[C],v=o[I>>>24]^l[E>>16&255]^d[w>>8&255]^u[255&T]^n[C+1],S=o[E>>>24]^l[w>>16&255]^d[T>>8&255]^u[255&I]^n[C+2],b=o[w>>>24]^l[T>>16&255]^d[I>>8&255]^u[255&E]^n[C+3],T=y,I=v,E=S,w=b,C+=4;y=s[T>>>24]<<24^s[I>>16&255]<<16^s[E>>8&255]<<8^s[255&w]^n[C],v=s[I>>>24]<<24^s[E>>16&255]<<16^s[w>>8&255]<<8^s[255&T]^n[C+1],S=s[E>>>24]<<24^s[w>>16&255]<<16^s[T>>8&255]<<8^s[255&I]^n[C+2],b=s[w>>>24]<<24^s[T>>16&255]<<16^s[I>>8&255]<<8^s[255&E]^n[C+3],C+=3,g[t]=P(y^c),g[t+1]=P(b^h),g[t+2]=P(S^p),g[t+3]=P(v^f),c=O,h=A,p=R,f=k,t+=4}return g.buffer}destroy(){this.key=void 0,this.keySize=void 0,this.ksRows=void 0,this.sBox=void 0,this.invSBox=void 0,this.subMix=void 0,this.invSubMix=void 0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.rcon=void 0}}class i{constructor(e,t){this.rpc=e,this.logger=t,this.decrypt=(r,n,s,a,o)=>t=>{const i=l.crypto;if(null!=o&&o.useJSCrypto||null==i||!i.subtle){const s=new d;var e;s.expandKey(r);const i=s.decrypt(a,0,n);e=o.plainTextLength?i.slice(0,o.plainTextLength):function(e){var t=new Uint8Array(e),i=t[e.byteLength-1],r=e.byteLength-1;let n=0;if(1<=i&&i<=16)for(let e=r;e>r-i&&t[e]===i;e--)n++;return e=n===i?e.slice(0,r-i+1):e}(i),t(e,void 0,[e])}else i.subtle.importKey("raw",r,s,!1,["decrypt"]).then(e=>i.subtle.decrypt({name:s,iv:n},e,a)).then(e=>{t(e,void 0,[e])}).catch(e=>t(void 0,e))},e.register("decrypt",this.decrypt)}}(Ti=_=_||{}).MEDIA_ATTACHING="hlsMediaAttaching",Ti.MEDIA_ATTACHED="hlsMediaAttached",Ti.MEDIA_DETACHING="hlsMediaDetaching",Ti.MEDIA_DETACHED="hlsMediaDetached",Ti.BUFFER_CREATED="hlsBufferCreated",Ti.BUFFER_APPENDING="hlsBufferAppending",Ti.BUFFER_APPENDED="hlsBufferAppended",Ti.BUFFER_FLUSHED="hlsBufferFlushed",Ti.MANIFEST_LOADING="hlsManifestLoading",Ti.MANIFEST_LOADED="hlsManifestLoaded",Ti.MANIFEST_PARSED="hlsManifestParsed",Ti.LEVEL_SWITCHING="hlsLevelSwitching",Ti.LEVEL_SWITCHED="hlsLevelSwitched",Ti.LEVEL_LOADING="hlsLevelLoading",Ti.LEVEL_LOADED="hlsLevelLoaded",Ti.LEVEL_UPDATED="hlsLevelUpdated",Ti.LEVELS_CHANGED="hlsLevelsChanged",Ti.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",Ti.AUDIO_TRACK_SWITCH="hlsAudioTrackSwitch",Ti.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",Ti.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",Ti.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",Ti.SUBTITLE_TRACKS_CREATED="hlsSubtitleTracksCreated",Ti.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",Ti.INLINE_STYLES_PARSED="hlsInlineStylesParsed",Ti.SESSION_DATA_COMPLETE="hlsSessionDataComplete",Ti.FRAG_LOADING="hlsFragLoading",Ti.FRAG_LOADED="hlsFragLoaded",Ti.FRAG_BUFFERED="hlsFragBuffered",Ti.FRAG_CHANGED="hlsFragChanged",Ti.INTERNAL_ERROR="hlsInternalError",Ti.ERROR="hlsError",Ti.DESTROYING="hlsDestroying",Ti.KEY_REQUEST_STARTED="hlsKeyRequestStarted",Ti.LICENSE_CHALLENGE_CREATED="hlsLicenseChallengeCreated",Ti.LICENSE_RELEASED="hlsLicenseReleased",Ti.KEY_LOADED="hlsKeyLoaded",Ti.UNRESOLVED_URI_LOADING="hlsUnresolvedUriLoading",Ti.DESIRED_RATE_CHANGED="hlsDesiredRateChanged",Ti.PLAYER_STATE_CHANGE="hlsPlayerStateChange",Ti.SEEKING="hlsSeeking",Ti.SEEKED="hlsSeeked",Ti.STALLED="hlsStalled",Ti.RESUME_FROM_STALL="hlsResumeFromStall",Ti.READY_FOR_NEXT_ITEM="hlsReadyForNextItem",Ti.ITEM_TRANSITIONED="hlsItemTransitioned",Ti.ITEM_EVICTED="hlsItemEvicted",Ti.DATERANGE_UPDATED="hlsDaterangeUpdated",Ti.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",Ti.INTERSTITIAL_STARTED="hlsInterstitialStarted",Ti.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",Ti.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",Ti.INTERSTITIAL_ENDED="hlsInterstitialEnded";var I,M,P,D=_;(Ee=I=I||{}).FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",Ee.FRAG_PARSING_DATA="hlsFragParsingData",Ee.FRAG_PARSED="hlsFragParsed",Ee.INIT_PTS_FOUND="hlsInitPtsFound";class g extends Error{constructor(e,t,i,r,n){super(r),this.type=e,this.details=t,this.fatal=i,this.reason=r,this.response=n,this.handled=!1}}class L extends g{constructor(e,t,i,r,n){super(e,t,i,r,n),this.response=n}}const K={PlaylistNotReceived:{code:-12884,text:"Playlist not received"},CryptResponseReceivedSlowly:{code:-16833,text:"Crypt key received slowly"},LivePlaylistUpdateError:{code:-12888,text:"Live playlist not updated"},NoResponseFromMediaRequest:{code:-12889,text:"No response for fragment"},IncompatibleAsset:{code:-12927,text:"IncompatibleAsset"},CorruptStream:{code:-16041,text:"Corrupt fragment"},InternalError:{code:-12645,text:"InternalException"},CantSwitchInTime:{code:-12644,text:"CantSwitchInTime"},VideoDecoderBadDataErr:{code:-12909,text:"Buffer error"},InsufficientDataAvailable:{code:-12928,text:"Incomplete data"},AllocationFailed:{code:-12862,text:"AllocationFailed"},PlaylistErrorMissingEXTM3U:{code:-12269,text:"Response doesnt have #EXTM3U tag"},PlaylistErrorInvalidEntry:{code:-12264,text:"Invalid entry"},PlaylistErrorBadTargetDuration:{code:-12271,text:"Invalid targetduration"},NoValidAlternates:{code:-12925,text:"No valid alternates"},FormatError:{code:-12642,text:"Incorrect playlist format"},ContentHasGap:{code:-15419,text:"Gap fragment encountered"},UnsupportedKeySystemError:{code:-6e4,text:"Unsupported Key System"},EmptyLoadSourceError:{code:-60001,text:"Empty loadSource url"},UndefinedItemIdError:{code:-60002,text:"Undefined itemId"},ManifestParseError:{code:-60003,text:"Manifest parse error"},DemuxWorkerError:{code:-60004,text:"Demux worker error"},DecryptWorkerError:{code:-60005,text:"Decrypt worker error"},OutOfRangeSeekError:{code:-60006,text:"Seeked out of playable range"},ExceptionInKeyLoadError:{code:-60007,text:"Exception in Key load"},FragmentAbortError:{code:-60008,text:"Fragment abort error"},ManifestTimeoutError:{code:-60009,text:"Manifest Timeout Error"},PlaylistTimeoutError:{code:-60010,text:"Playlist Timeout Error"},FragmentTimeoutError:{code:-60011,text:"Fragment Timeout Error"},IncompleteSessionData:{code:-60012,text:"Session data not complete after loading all items"},SessionDataLoadTimeout:{code:-60013,text:"Session data load timeout"},FailedDemuxerSanityCheck:{code:-60014,text:"Failed demuxer sanity check"},InvalidADTSSamplingIndex:{code:-60015,text:"Invalid ADTS sampling index"},DemuxerNotFound:{code:-60016,text:"No demux matching with content found"},InvalidAC3Magic:{code:-60029,text:"Invalid ac-3 magic"},InvalidInitTimestamp:{code:-60017,text:"Invalid initPTS or initDTS"},NoAVSamplesFound:{code:-60018,text:"no audio/video samples found"},NoTSSyncByteFound:{code:-60019,text:"TS packet did not start with 0x47"},PESDidNotStartWithADTS:{code:-60020,text:"AAC PES did not start with ADTS header"},NoADTSHeaderInPES:{code:-60021,text:"No ADTS header found in AAC PES"},InvalidDolbyAudioMagic:{code:-60022,text:"Invalid dolby audio magic"},FailedToAllocateVideoMdat:{code:-60023,text:"Fail allocating video mdat"},FailedToAllocateAudioMdat:{code:-60024,text:"Fail allocating audio mdat"},InsufficientEC3Data:{code:-60025,text:"Error parsing ec-3, not enough data"},InvalidEC3Magic:{code:-60026,text:"Invalid ec-3 magic"},ReservedStreamType:{code:-60027,text:"Reserved stream type"},InsufficientAC3Data:{code:-60028,text:"error parsing ac-3, not enough data"},InvalidAC3SamplingRateCode:{code:-60030,text:"Invalid ac-3 samplingRateCode"},LivePlaylistTooFar:{code:-60031,text:"Live playlist too far"},XhrError:{code:-60032,text:"Generic XHR error"},PlaylistErrorInvalidEXTXDEFINE:{code:-61e3,text:"Encountered undefined/not imported EXT-X-DEFINE property"},PlaylistErrorMissingImportReference:{code:-61001,text:"IMPORT references variable not in master playlist and/or NAME"},PlaylistErrorInvalidSERVERURI:{code:-61002,text:"Encountered undefined/invalid SERVER-URI attribute for EXT-X-CONTENT-STEERING tag"},PlaylistErrorInvalidPATHWAYID:{code:-61003,text:"Encountered invalid PATHWAY-ID attribute for EXT-X-CONTENT-STEERING tag"},PlaylistErrorInvalidSCORE:{code:-61004,text:"Encountered negative/non-number SCORE property"},KeySystemFailedToUpdateSession:{code:-62e3,text:"KeySystem: Promise Rejected while updating session"},KeySystemFailedToGenerateLicenseRenewal:{code:-62001,text:"KeySystem: Failed to generate license renewal"},KeySystemFailedToGenerateLicenseRequest:{code:-62002,text:"KeySystem: Failed to generate license request"},KeySystemAbort:{code:-62003,text:"KeySystem: Aborted"},KeySystemUnexpectedStateTransition:{code:-62004,text:"KeySystem: Unexpected state transition"},KeySystemUnexpectedState:{code:-62005,text:"KeySystem: Unexpected state"},KeySystemCDMUnknownError:{code:-62006,text:"KeySystem: Unknown error from CDM"},KeySystemRequestTimedOut:{code:-62007,text:"Key request timed out"},KeySystemUnexpectedMETHOD:{code:-62008,text:"Unexpected METHOD attribute"},KeySystemUnmatchedString:{code:-62009,text:"KeySystem: string does not match"},KeySystemInternalError:{code:-62010,text:"KeySystem: internal-error"},KeySystemOutputRestricted:{code:-62011,text:"KeySystem: output-restricted"},KeySystemSetupError:{code:-62012,text:"KeySystem: setup error"},KeySystemFailedToInitialize:{code:-62013,text:"KeySystem: could not initialize"},KeySystemFailedToCreateSession:{code:-62014,text:"KeySystem: could not create session"},KeySystemUndefinedNavigator:{code:-62015,text:"KeySystem: navigator undefined"},KeySystemNoKeySystemsToTry:{code:-62016,text:"KeySystem: no key systems to try"},KeySystemNoConstructor:{code:-62017,text:"KeySystem: No constructor"},KeySystemNoKeySystemAccess:{code:-62018,text:"KeySystem: No KeySystemAccess"},KeySystemCertificateLoadError:{code:-62019,text:"KeySystem: Certificate Load Error"}};(Sr=M=M||{}).NETWORK_ERROR="networkError",Sr.MEDIA_ERROR="mediaError",Sr.MUX_ERROR="muxError",Sr.KEY_SYSTEM_ERROR="keySystemError",Sr.OTHER_ERROR="otherError",(pl=P=P||{}).MANIFEST_LOAD_ERROR="manifestLoadError",pl.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",pl.MANIFEST_PARSING_ERROR="manifestParsingError",pl.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",pl.MANIFEST_INCOMPATIBLE_VIDEO_RANGE_ERROR="manifestIncompatibleVideoRangeError",pl.LEVEL_LOAD_ERROR="levelLoadError",pl.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",pl.LEVEL_SWITCH_ERROR="levelSwitchError",pl.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",pl.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",pl.SUBTITLE_TRACK_LOAD_ERROR="subtitleTrackLoadError",pl.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeout",pl.FRAG_LOAD_ERROR="fragLoadError",pl.FRAG_LOOP_LOADING_ERROR="fragLoopLoadingError",pl.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",pl.FRAG_DECRYPT_ERROR="fragDecryptError",pl.FRAG_PARSING_ERROR="fragParsingError",pl.FRAG_ABORT_ERROR="fragAbortError",pl.REMUX_ALLOC_ERROR="remuxAllocError",pl.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",pl.BUFFER_APPEND_ERROR="bufferAppendError",pl.BUFFER_APPENDING_ERROR="bufferAppendingError",pl.BUFFER_STALLED_ERROR="bufferStalledError",pl.BUFFER_FULL_ERROR="bufferFullError",pl.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",pl.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",pl.INTERNAL_EXCEPTION="internalException",pl.WEBVTT_EXCEPTION="webVTTException",pl.KEY_LOAD_ERROR="keyLoadError",pl.KEY_LOAD_TIMEOUT="keyLoadTimeOut",pl.KEY_SYSTEM_GENERIC_ERROR="keySystemGenericError",pl.CERT_LOAD_ERROR="certificateLoadError",pl.CERT_LOAD_TIMEOUT="certificateLoadTimeOut",pl.SESSION_DATA_LOAD_ERROR="sessionDataLoadError",pl.SESSION_DATA_LOAD_TIMEOUT="sessionDataLoadTimeOut",pl.STEERING_MANIFEST_LOAD_ERROR="steeringManifestLoadError",pl.STEERING_MANIFEST_LOAD_TIMEOUT="steeringManifestLoadTimeOut",pl.STEERING_MANIFEST_PARSING_ERROR="steeringManifestParsingError",pl.INTERSTITIAL_ASSET_LIST_LOAD_ERROR="interstitialAssetListLoadError",pl.INTERSTITIAL_ASSET_LIST_LOAD_TIMEOUT="interstitialAssetListLoadTimeout",pl.INTERSTITIAL_ASSET_LIST_PARSING_ERROR="interstitialAssetListParsingError",pl.UNKNOWN="";class Q extends g{constructor(e,t,i){super(M.OTHER_ERROR,P.INTERNAL_EXCEPTION,e,t,i)}}class b extends g{constructor(e,t,i){super(M.MEDIA_ERROR,P.FRAG_PARSING_ERROR,e,t,i)}}class N extends g{constructor(e,t,i,r){super(M.MUX_ERROR,P.REMUX_ALLOC_ERROR,e,t,i),this.bytes=r}}function E(e){return e.baseTime/e.timescale}function F(e,t){return{baseTime:Math.floor(e*t),timescale:t}}function w(e,t){return E(e)>E(t)?e:t}function y(e,t){return E(e)-E(t)}var t=void 0!==l.Buffer?require("events").EventEmitter:class{constructor(){this.eventMap={}}_on(e,t,i=!1){return null==this.eventMap[e]&&(this.eventMap[e]=[]),i?this.eventMap[e].splice(0,0,t):this.eventMap[e].push(t),this}_off(e,t){return null!=this.eventMap[e]&&(this.eventMap[e]=this.eventMap[e].filter(e=>e.listener!==t.listener),0===this.eventMap[e].length&&delete this.eventMap[e]),this}on(e,t){return this._on(e,{listener:t,once:!1})}off(e,t){return this._off(e,{listener:t})}addListener(e,t){return this.on(e,t)}once(e,t){return this._on(e,{listener:t,once:!0})}removeListener(e,t){return this.off(e,t)}removeAllListeners(e){return delete this.eventMap[e],this}setMaxListeners(e){return this}getMaxListeners(){return 1/0}listeners(e){return null==this.eventMap[e]?[]:this.eventMap[e].map(e=>e.listener)}rawListeners(e){return this.listeners(e)}emit(e,...t){if(null==this.eventMap[e])return!1;let i=!1;for(const r of this.eventMap[e]){try{r.listener.apply(this,t)}catch(e){}i=!0}return i}listenerCount(e){return null==this.eventMap[e]?0:this.eventMap[e].length}prependListener(e,t){return this._on(e,{listener:t,once:!1},!0)}prependOnceListener(e,t){return this._on(e,{listener:t,once:!0},!0)}eventNames(){return Object.keys(this.eventMap)}};class r extends t{trigger(e,t){this.emit(e,t)}}function v(e,t,i,r,n){let s,a,o,l;const d=navigator.userAgent.toLowerCase(),u=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];s=1+((192&t[i+2])>>>6);var c=(60&t[i+2])>>>2;if(!(u.length-1<c))return o=(1&t[i+2])<<2,o|=(192&t[i+3])>>>6,/firefox/i.test(d)?6<=c?(s=5,l=new Array(4),a=c-3):(s=2,l=new Array(2)):-1!==d.indexOf("android")?(s=2,l=new Array(2)):(s=5,l=new Array(4),a=r&&(-1!==r.indexOf("mp4a.40.29")||-1!==r.indexOf("mp4a.40.5"))||!r&&6<=c?c-3:((r&&-1!==r.indexOf("mp4a.40.2")||!r&&1==o)&&(s=2,l=new Array(2)),c)),l[0]=s<<3,l[0]|=(14&c)>>1,l[1]|=(1&c)<<7,l[1]|=o<<3,5===s&&(l[1]|=(14&a)>>1,l[2]=(1&a)<<7,l[2]|=8,l[3]=0),{esdsConfig:l,samplerate:u[c],channelCount:o,segmentCodec:"aac",codec:"mp4a.40."+s};{const t=new b(!0,`invalid ADTS sampling index:${c}`,K.InvalidADTSSamplingIndex);e.trigger(D.INTERNAL_ERROR,t)}}class n{constructor(e,t,i,r,n){this.observer=e,this.remuxer=t,this.config=i,this.typeSupported=r,this.logger=n}static probe(e,t){throw new Error("Method not implemented")}resetTimeStamp(e){}resetInitSegment(e,t,i,r){}destroy(){}}class s extends n{constructor(e,t,i,r,n){super(e,t,i,r,n),this.observer=e,this.remuxer=t,this.config=i,this.typeSupported=r,this.logger=n,this.esRemuxer=t}}class a{constructor(e,t,i){this.observer=e,this.config=t,this.logger=i}resetInitSegment(){}resetTimeStamp(e){}destroy(){}}function o(e){return String.fromCharCode.apply(null,new Uint16Array(e))}function u(t){const e=new ArrayBuffer(2*t.length),i=new Uint16Array(e);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return e}let c,h;var p={strToUtf8array:e=>(c=c||new TextEncoder,c.encode(e)),utf8arrayToStr:e=>(h=h||new TextDecoder("utf-8"),h.decode(e)),str2ab:u,ab2str:o},f={strToUtf8array(e){e=l.Buffer.from(e,"utf-8");return new Uint8Array(e.buffer,e.byteOffset,e.byteLength)},utf8arrayToStr:e=>l.Buffer.from(e).toString("utf-8"),str2ab:u,ab2str:o};let B={strToUtf8array(e){const t=unescape(encodeURIComponent(e)),i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return i},utf8arrayToStr:e=>String.fromCharCode.apply(null,Array.from(e)),str2ab:u,ab2str:o};"undefined"!=typeof TextEncoder&&"undefined"!=typeof TextDecoder?B=p:"function"==typeof(null===(fl=l.Buffer)||void 0===fl?void 0:fl.from)&&(B=f);const m={name:"ID3"};class S{constructor(e,t){this.logger=t,this._hasTimeStamp=!1,this._audioType=null,this._length=0,this._frames=[];let i,r,n,s,a=0;for(;;)if(n=S.readUTF(e,a,3),a+=3,"ID3"===n){this._minor=e[a++],this._revision=e[a++];const t=e[a++];if(128&t&&(this._unsynchronized=!0,this.logger.error(m,"id3 tag is unsynchronized")),64&t&&(this._hasExtendedHeader=!0,this.logger.warn(m,"id3 tag has extended header")),i=S.readSynchSafeUint32(e.subarray(a,a+4)),a+=4,r=a+i,this._hasExtendedHeader){const t=S.readSynchSafeUint32(e.subarray(a,a+4));this.logger.warn(m,`id3 tag has ${t}-byte extended header. usually 6 or 10 bytes`),a+=t}2<this.minor?this._parseID3Frames(e,a,r):this.logger.error(m,"[id3] doesn't support older than v2.3 tags"),a=r}else{if("3DI"!==n)return a-=3,void((s=a)&&(this.hasTimeStamp||this.logger.warn(m,"ID3 tag found, but no timestamp"),this._length=s,this._payload=e.slice(0,s)));a+=7}}static isHeader(e,t){return 73===e[t]&&68===e[t+1]&&51===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128}static readSynchSafeUint32(e){return 2097152*(127&e[0])+16384*(127&e[1])+128*(127&e[2])+(127&e[3])}static readUTF(e,t,i){let r="",n=t;for(var s=t+i;r+=String.fromCharCode(e[n++]),n<s;);return r}isID3Frame(e,t){return e[t+4]<128&&e[t+5]<128&&e[t+6]<128&&e[t+7]<128}decodeID3Frame(e){return"TXXX"===e.type?this.decodeTxxxFrame(e):"WXXX"===e.type?this.decodeWxxxFrame(e):"PRIV"===e.type?this.decodePrivFrame(e):"T"===e.type[0]?this.decodeTextFrame(e):{key:e.type,data:e.data}}decodeTxxxFrame(e){if(!(e.size<2)&&3===e.data[0]){var t=1,i=this.id3utf8ArrayToStr(e.data.subarray(1));return t+=i.length+1,{key:"TXXX",description:i,data:this.id3utf8ArrayToStr(e.data.subarray(t))}}}decodeWxxxFrame(e){if(!(e.size<2)&&3===e.data[0]){var t=1,i=this.id3utf8ArrayToStr(e.data.subarray(1));return t+=i.length+1,{key:"WXXX",description:i,data:B.utf8arrayToStr(e.data.subarray(t))}}}decodeTextFrame(e){if(!(e.size<2)&&3===e.data[0]){var t=e.data.subarray(1);return{key:e.type,data:this.id3utf8ArrayToStr(t)}}}decodePrivFrame(e){if(!(e.size<2)){var t=this.id3utf8ArrayToStr(e.data);return{key:"PRIV",info:t,data:e.data.slice(t.length+1)}}}_extractID3Frame(e,t,i,r,n){var s=r+i;let a;return s<=n?a={type:t,data:e.slice(r,s)}:this.logger.error(m,`id3 frame ${t} size ${i} exceeded ${n}`),a}_parseID3Frames(e,t,i){let r,n,s,a;for(;t+8<=i;){if(!this.isID3Frame(e,t))return void this.logger.error(m,`[id3] illegal id3 frame @ offset ${t}. skip this id3 tag`);if(r=S.readUTF(e,t,4),t+=4,""===r)return;if(0===(n=S.readSynchSafeUint32(e.subarray(t,t+4))))return;t+=4,e[t++],e[t++],s=t;var o=this._extractID3Frame(e,r,n,s,i);if(o){const e=this.decodeID3Frame(o);this._frames.push(e)}if("PRIV"===r)if(53===n&&"com.apple.streaming.transportStreamTimestamp"===S.readUTF(e,t,44)){t+=44,t+=4;const i=1&e[t++];this._hasTimeStamp=!0,a=((e[t++]<<23)+(e[t++]<<15)+(e[t++]<<7)+e[t++])/45,i&&(a+=47721858.84),a=Math.round(a),this._timeStamp=a}else 45<=n&&"com.apple.streaming.audioDescription"===S.readUTF(e,t,36)?(t+=37,this._audioType=S.readUTF(e,t,4),t+=4,t+=n-41):t+=n;else t+=n}}id3utf8ArrayToStr(e){let t,i,r="",n=0;const s=e.length;for(;n<s;){const s=e[n++];switch(s>>4){case 0:return r;case 1:case 2:case 3:case 4:case 5:case 6:case 7:r+=String.fromCharCode(s);break;case 12:case 13:t=e[n++],r+=String.fromCharCode((31&s)<<6|63&t);break;case 14:t=e[n++],i=e[n++],r+=String.fromCharCode((15&s)<<12|(63&t)<<6|(63&i)<<0)}}}get hasTimeStamp(){return this._hasTimeStamp}get timeStamp(){return this._timeStamp}get audioType(){return this._audioType}get length(){return this._length}get payload(){return this._payload}get frames(){return this._frames}get minor(){return this._minor}get revision(){return this._revision}}var O=S;const A={name:"AACDemuxer"};class R extends s{resetInitSegment(e,t){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=t}static probe(e,t){let i,r;for(i=new O(e,t).length,r=Math.min(e.length-1,i+100);i<r;i++)if(255===e[i]&&240==(246&e[i+1]))return!0;return!1}append(e,t,i,r,n){var s=new O(e,this.logger),a=s.hasTimeStamp?90*s.timeStamp:9e4*t;let o,l,d,u,c,h,p,f,m,g;for(s.length&&(g=s.payload,s.frames.length&&(m=s.frames),f={id3Samples:[{pts:a,dts:a,data:g,frames:m}],inputTimescale:9e4}),d=s.length,h=e.length;d<h-1&&(255!==e[d]||240!=(246&e[d+1]));d++);if(!this.audioConfig&&(this.audioConfig=v(this.observer,e,d,void 0,this.logger),!this.audioConfig))throw"failed to parse adts config";if(!this.audioTrack){const e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,keyTagInfo:n},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}"zaac"!==s.audioType&&"zach"!==s.audioType&&"zacp"!==s.audioType||(this.audioTrack.info.encrypted=!0),l=0;for(var y=9216e4/this.audioConfig.samplerate;d+5<h&&(u=1&e[d+1]?7:9,o=(3&e[d+3])<<11|e[d+4]<<3|(224&e[d+5])>>>5,o-=u,0<o&&d+u+o<=h);)for(c=a+l*y,p={unit:e.subarray(d+u,d+u+o),pts:c,dts:c,keyTagInfo:n},this.audioTrack.parsingData.esSamples.push(p),this.audioTrack.parsingData.len+=o,d+=o+u,l++;d<h-1;d++){if(O.isHeader(e,d)){const t=new O(e.subarray(d),this.logger);if(0<t.length){d+=t.length;const e=t.hasTimeStamp?90*t.timeStamp:a;f.id3Samples.push({pts:e,dts:e,data:t.payload,frames:t.frames})}else this.logger.error(A,`[id3] invalid length ${h}`)}if(255===e[d]&&240==(246&e[d+1]))break}this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,f,void 0,t,i,r,n)}}class x{bsReadAndUpdate(e,t,i){e=this.readBits(e,t,i);return this.updateOffset(t,i),e}bsWriteAndUpdate(e,t,i,r){r=this.writeBits(e,t,i,r);return this.updateOffset(t,i),r}bsSkip(e,t){this.updateOffset(e,t)}readBits(i,r,n){if(i&&r){let t=r.byteOffset;const s=r["usedBits"];if(!(8<=s||32<s+n)){let e;const a=new Uint32Array(1),o=new Uint32Array(1),l=new Uint8Array(1);if(!(8<=s||32<n)){if(s){const r=8-s,a=n<r?r-n:0;o[0]=4278190080>>>32-r,e=(i[t]&o[0])>>>a,t+=1,n-=r}for(;0<n;){l[0]=i[t];const r=Math.min(n,8),s=8-r;o[0]=4278190080>>>24+s<<s,a[0]=(l[0]&o[0])>>s,e=e?e<<r|a[0]:a[0],t+=1,n-=r}return e}}}}writeBits(t,i,r,n){if(t&&i){let e=i.byteOffset;var i=i["usedBits"];if(!(8<=i||32<i+r)){const s=new Uint32Array(1),a=new Uint32Array(1),o=new Uint32Array(1),l=new Uint8Array(1);for(s[0]=n,i&&(a[0]=s[0]<<32-r,o[0]=4278190080,l[0]=(a[0]&o[0])>>>24+i,t[e]&=~(o[0]>>>24+i),t[e]|=l[0],e+=1,r-=8-i);0<r;){a[0]=s[0]<<32-r,o[0]=4278190080,l[0]=(a[0]&o[0])>>>24;const d=r<0?8-r:0;t[e]&=~(o[0]>>>24>>>d<<d),t[e]|=l[0],r-=8,e+=1}return 0}}}updateOffset(e,t){var i,r;!e||!t||32<e.usedBits+t||(i=e.usedBits%8,r=Math.floor((i+t)/8),t=(i+t)%8,e.byteOffset+=r,e.usedBits=t)}}function k(e,t){return 1536/e.samplerate*t}function C(e,t,i,r){let n;if(i+8>t.length)return n=new b(!0,"error parsing ac-3, not enough data",K.InsufficientAC3Data),void e.trigger(D.INTERNAL_ERROR,n);if(11!==t[i]||119!==t[i+1])return n=new b(!0,"invalid ac-3 magic",K.InvalidAC3Magic),void e.trigger(D.INTERNAL_ERROR,n);var s=t[i+4]>>6;if(3<=s)return n=new b(!0,`invalid ac-3 samplingRateCode:${s}`,K.InvalidAC3SamplingRateCode),void e.trigger(D.INTERNAL_ERROR,n);var a=63&t[i+4],o=t[i+6]>>5;let l=0;2==o?l+=2:(1&o&&1!=o&&(l+=2),4&o&&(l+=2));var d=(t[i+6]<<8|t[i+7])>>12-l&1,u=[2,1,2,3,3,4,4,5][o]+d,e=t[i+5]>>3,i=7&t[i+5];return{samplerate:$[s],channelCount:u,segmentCodec:"ac3",codec:"ac-3",extraData:s<<22|e<<17|i<<14|o<<11|d<<10|a>>1<<5}}function U(e,t,i){let r;if(i+8>t.length)return r=new b(!0,"error parsing ac-3, not enough data",K.InsufficientAC3Data),void e.trigger(D.INTERNAL_ERROR,r);if(11!==t[i]||119!==t[i+1])return r=new b(!0,"invalid ac-3 magic",K.InvalidAC3Magic),void e.trigger(D.INTERNAL_ERROR,r);var n=t[i+4]>>6;return 3<=n?(r=new b(!0,`invalid ac-3 samplingRateCode:${n}`,K.InvalidAC3SamplingRateCode),void e.trigger(D.INTERNAL_ERROR,r)):(i=63&t[i+4],2*V[3*i+n])}const $=[48e3,44100,32e3],V=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920];class q extends s{resetInitSegment(e,t){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=t}static probe(e,t){var i=new O(e,t),t=i.length;return!!(i.hasTimeStamp&&11===e[t]&&119===e[t+1]&&(new x).bsReadAndUpdate(e,{byteOffset:t+5,usedBits:0},5)<16)}append(e,t,i,r,n){var s=new O(e,this.logger),a=90*s.timeStamp,o=e.byteLength;let l=0,d=s.length;if(this.audioConfig||(this.audioConfig=C(this.observer,e,d,this.logger)),!this.audioConfig)throw"failed to parse ac3 config";if(!this.audioTrack){const e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,keyTagInfo:n},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}var u=k(this.audioConfig,this.audioTrack.info.inputTimescale);for("zac3"===s.audioType&&(this.audioTrack.info.encrypted=!0);d<o;){if(O.isHeader(e,d)&&(d+=new O(e.subarray(d),this.logger).length),11!==e[d]||119!==e[d+1]){const e=new b(!0,"invalid ac-3 magic",K.InvalidAC3Magic);return void this.observer.trigger(D.INTERNAL_ERROR,e)}const t=U(this.observer,e,d),i=a+l*u,r={unit:e.subarray(d,d+t),pts:i,dts:i,keyTagInfo:n};this.audioTrack.parsingData.esSamples.push(r),this.audioTrack.parsingData.len+=t,d+=t,l++}this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,{id3Samples:[{pts:a,dts:a,data:s.payload,frames:s.frames}],inputTimescale:this.audioTrack.info.inputTimescale},void 0,t,i,r,n)}}function j(t,i,r,n){const s=new x;let a,o=!1,l=0;for(;r<i.length;){if(r+8>i.length)return a=new b(!0,"error parsing ec-3, not enough data",K.InsufficientEC3Data),void t.trigger(D.INTERNAL_ERROR,a);let e=0;if(O.isHeader(i,r)&&(e=new O(i.subarray(r),n).length||0,r+=e),11!==i[r]||119!==i[r+1])return a=new b(!0,"invalid ec-3 magic",K.InvalidEC3Magic),void t.trigger(D.INTERNAL_ERROR,a);var d={byteOffset:r+2,usedBits:0},u=s.bsReadAndUpdate(i,d,2),c=s.bsReadAndUpdate(i,d,3);if(0===u||2===u)if(!0===o){if(0===c)break}else o=!0;else if(1!==u)return a=new b(!0,"reserved stream type",K.ReservedStreamType),void t.trigger(D.INTERNAL_ERROR,a);d=2*(s.bsReadAndUpdate(i,d,11)+1);r+=d,l+=d+(e||0)}return l}function H(t,i,r,n){const s={frmsiz:0,fscod:0,numblkscod:0,acmod:0,lfeon:0,bsid:0,strmtyp:0,substreamid:0,chanmape:0,chanmap:0,mixdef:0,mixdeflen:0,bsmod:0},a={fscod:0,acmod:0,lfeon:0,bsid:0,bsmod:0,chan_loc:0,data_rate:0,num_ind_sub:0,num_dep_sub:[],complexity_index_type_a:0},o=new x;let l,d=!1,u=0;for(;r<i.length;){if(r+8>i.length)return l=new b(!0,"error parsing ec-3, not enough data",K.InsufficientEC3Data),void t.trigger(D.INTERNAL_ERROR,l);let e=0;if(O.isHeader(i,r)&&(e=new O(i.subarray(r),n).length||0,r+=e),11!==i[r]||119!==i[r+1])return l=new b(!0,"invalid ec-3 magic",K.InvalidEC3Magic),void t.trigger(D.INTERNAL_ERROR,l);const h={byteOffset:r+2,usedBits:0};if(s.strmtyp=o.bsReadAndUpdate(i,h,2),s.substreamid=o.bsReadAndUpdate(i,h,3),0===s.strmtyp||2===s.strmtyp){if(!0===d){if(0===s.substreamid)break}else d=!0;a.num_ind_sub++,a.num_dep_sub.push(0)}else{if(1!==s.strmtyp)return l=new b(!0,"reserved stream type",K.ReservedStreamType),void t.trigger(D.INTERNAL_ERROR,l);a.num_dep_sub[a.num_ind_sub-1]++}if(s.frmsiz=o.bsReadAndUpdate(i,h,11),s.fscod=o.bsReadAndUpdate(i,h,2),3===s.fscod?(o.bsSkip(h,2),s.numblkscod=3):s.numblkscod=o.bsReadAndUpdate(i,h,2),s.acmod=o.bsReadAndUpdate(i,h,3),s.lfeon=o.bsReadAndUpdate(i,h,1),s.bsid=o.bsReadAndUpdate(i,h,5),o.bsSkip(h,5),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,8),0===s.acmod&&(o.bsSkip(h,5),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,8)),1===s.strmtyp&&(s.chanmape=o.bsReadAndUpdate(i,h,1),s.chanmape&&(s.chanmap=o.bsReadAndUpdate(i,h,16))),o.bsReadAndUpdate(i,h,1)&&(2<s.acmod&&o.bsSkip(h,2),1&s.acmod&&2<s.acmod&&o.bsSkip(h,6),4&s.acmod&&o.bsSkip(h,6),s.lfeon&&o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,5),0===s.strmtyp)){if(o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,6),0===s.acmod&&o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,6),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,6),s.mixdef=o.bsReadAndUpdate(i,h,2),1===s.mixdef)o.bsSkip(h,5);else if(2===s.mixdef)o.bsSkip(h,12);else if(3===s.mixdef){s.mixdeflen=o.bsReadAndUpdate(i,h,5),o.bsReadAndUpdate(i,h,1)&&(o.bsSkip(h,5),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&(o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4))),o.bsReadAndUpdate(i,h,1)&&(o.bsSkip(h,5),o.bsReadAndUpdate(i,h,1)&&(o.bsSkip(h,7),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,8)));const t=s.mixdeflen+2+(h.usedBits?1:0);h.byteOffset+=t}if(s.acmod<2&&(o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,14),0===s.acmod&&o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,14)),o.bsReadAndUpdate(i,h,1))if(0===s.numblkscod)o.bsSkip(h,5);else for(let e=0;e<s.numblkscod;e++)o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,5)}if(s.bsmod=0,o.bsReadAndUpdate(i,h,1)&&(s.bsmod=o.bsReadAndUpdate(i,h,3),o.bsSkip(h,2),2===s.acmod&&o.bsSkip(h,4),6<=s.acmod&&o.bsSkip(h,2),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,8),0===s.acmod&&o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,8),s.fscod<3&&o.bsSkip(h,1)),0===s.strmtyp&&3!==s.numblkscod&&o.bsSkip(h,1),2!==s.strmtyp||(3===s.numblkscod?1:o.bsReadAndUpdate(i,h,1))&&o.bsReadAndUpdate(i,h,6),o.bsReadAndUpdate(i,h,1)){const t=o.bsReadAndUpdate(i,h,6);if(0===s.strmtyp&&0===s.substreamid&&1===t){const t=o.bsReadAndUpdate(i,h,7),r=o.bsReadAndUpdate(i,h,1),n=o.bsReadAndUpdate(i,h,8);0===t&&1===r&&1<=n&&n<=16&&(a.complexity_index_type_a=n)}}if(s.chanmape)a.chan_loc|=s.chanmap;else{const t=[40960,16384,40960,57344,41472,57856,47104,63488];a.chan_loc|=t[s.acmod]}0===s.strmtyp&&(a.fscod=s.fscod,a.bsid=s.bsid,a.bsmod=s.bsmod,a.acmod=s.acmod,a.lfeon=s.lfeon),a.chan_loc|=s.lfeon?1:0;const p=2*(s.frmsiz+1);r+=p,u+=p+(e||0)}let c=0;for(let e=0;e<16;e++)a.chan_loc&1<<e&&c++;a.lfeon&&c++;let h=10+3*a.num_ind_sub;const p=[48e3,44100,32e3][a.fscod];a.data_rate=p/1536*u*8,h=10+3*a.num_ind_sub;for(let e=0;e<a.num_ind_sub;e++)0<a.num_dep_sub[e]&&h++;0<a.complexity_index_type_a&&(h+=2);var f=new Uint8Array(h),m={byteOffset:0,usedBits:0};o.bsWriteAndUpdate(f,m,32,h),o.bsWriteAndUpdate(f,m,32,1684366131),o.bsWriteAndUpdate(f,m,13,a.data_rate),o.bsWriteAndUpdate(f,m,3,a.num_ind_sub);for(let e=0;e<a.num_ind_sub;e++)o.bsWriteAndUpdate(f,m,2,a.fscod),o.bsWriteAndUpdate(f,m,5,a.bsid),o.bsWriteAndUpdate(f,m,1,0),o.bsWriteAndUpdate(f,m,1,0===e?0:1),o.bsWriteAndUpdate(f,m,3,a.bsmod),o.bsWriteAndUpdate(f,m,3,a.acmod),o.bsWriteAndUpdate(f,m,1,a.lfeon),o.bsWriteAndUpdate(f,m,3,0),o.bsWriteAndUpdate(f,m,4,a.num_dep_sub[e]),0<a.num_dep_sub[e]?o.bsWriteAndUpdate(f,m,9,a.chan_loc):o.bsWriteAndUpdate(f,m,1,0);return 0<a.complexity_index_type_a&&(o.bsWriteAndUpdate(f,m,7,0),o.bsWriteAndUpdate(f,m,1,1),o.bsWriteAndUpdate(f,m,8,a.complexity_index_type_a)),{samplerate:p,channelCount:c,segmentCodec:"ec3",codec:"ec-3",extraDataBytes:f}}class G extends s{resetInitSegment(e,t){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=t}static probe(e,t){var i=new O(e,t),t=i.length;return!(!i.hasTimeStamp||11!==e[t]||119!==e[t+1]||16!==(new x).bsReadAndUpdate(e,{byteOffset:t+5,usedBits:0},5))}append(e,t,i,r,n){var s=new O(e,this.logger),a=90*s.timeStamp,o=e.length;let l=0,d=s.length;if(this.audioConfig||(this.audioConfig=H(this.observer,e,d,this.logger)),!this.audioConfig)throw"failed to parse ec-3 config";if(!this.audioTrack){const e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,keyTagInfo:n},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}var u=k(this.audioConfig,this.audioTrack.info.inputTimescale);for("zec3"===s.audioType&&(this.audioTrack.info.encrypted=!0);d<o;){const t=j(this.observer,e,d,this.logger),i=a+l*u,r={unit:e.subarray(d,d+t),pts:i,dts:i,keyTagInfo:n};this.audioTrack.parsingData.esSamples.push(r),this.audioTrack.parsingData.len+=t,d+=t,l++}this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,{id3Samples:[{pts:a,dts:a,data:s.payload,frames:s.frames}],inputTimescale:this.audioTrack.info.inputTimescale},void 0,t,i,r,n)}}const W={BitratesMap:[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],SamplingRateMap:[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],SamplesCoefficients:[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],BytesInSlot:[0,1,1,4],onFrame:function(e,t,i,r,n,s,a){r=a+s*(10368e4/r);e.esSamples.push({unit:t,pts:r,dts:r}),e.len+=t.length},onNoise:function(e,t){t.warn("mpeg audio has noise: "+e.length+" bytes")},parseFrames:function(e,t,i,r,n,s,a){if(r<i+2)return-1;if(255===t[i]||224==(224&t[i+1])){if(r<i+24)return-1;const a=t[i+1]>>3&3,c=t[i+1]>>1&3,h=t[i+2]>>4&15,p=t[i+2]>>2&3,f=!!(2&t[i+2]);if(1!=a&&0!=h&&15!=h&&3!=p){var o=1e3*[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160][14*(3==a?3-c:3==c?3:4)+h-1],l=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3][3*(3==a?0:2==a?1:2)+p],d=f?1:0,u=t[i+3]>>6==3?1:2,d=3==c?(3==a?12:6)*o/l+d<<2:(3==a?144:72)*o/l+d|0;return r<i+d?-1:(W.onFrame(e,t.subarray(i,i+d),o,l,u,n,s),d)}}let c=i+2;for(;c<r;){if(255===t[c-1]&&224==(224&t[c]))return W.onNoise(t.subarray(i,c-1),a),c-i-1;c++}return-1},parse:function(e,t,i,r,n){var s=t.length;let a,o=0;for(;i<s&&0<(a=W.parseFrames(e,t,i,s,o++,r,n));)i+=a},getAudioConfig:function(e,t){var i=e[t+1]>>3&3,r=e[t+1]>>1&3,n=e[t+2]>>4&15,s=e[t+2]>>2&3,a=e[t+2]>>1&1;if(1!=i&&0!=n&&15!=n&&3!=s){var o=3==i?3-r:3==r?3:4,o=1e3*W.BitratesMap[14*o+n-1],n=3==i?0:2==i?1:2,s=W.SamplingRateMap[3*n+s],t=e[t+3]>>6==3?1:2,i=W.SamplesCoefficients[i][r],r=W.BytesInSlot[r];return{segmentCodec:"mp3",codec:"mp3",samplerate:s,channelCount:t,frameLength:parseInt(i*o/s+a,10)*r}}},isHeaderPattern:function(e,t){return 255===e[t]&&224==(224&e[t+1])&&0!=(6&e[t+1])},probe:function(t,i){if(i+1<t.length&&W.isHeaderPattern(t,i)){var r=W.getAudioConfig(t,i);let e=4;r&&r.frameLength&&(e=r.frameLength);i=i+e;if(i===t.length||i+1<t.length&&W.isHeaderPattern(t,i))return!0}return!1}};var z=W;const Y={name:"MP3Demuxer"};class X extends s{resetInitSegment(e,t){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=t}static probe(e,t){var i=new O(e,t);let r,n;if(i.hasTimeStamp)for(r=i.length,n=Math.min(e.length-1,r+100);r<n;r++)if(z.probe(e,r))return t.warn(Y,"MPEG Audio sync word found !"),!0;return!1}append(e,t,i,r,n){var s=new O(e,this.logger),a=90*s.timeStamp;if(this.audioConfig||(this.audioConfig=z.getAudioConfig(e,s.length)),!this.audioConfig)throw"unable to parse mp3 header";if(!this.audioTrack){const e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,keyTagInfo:n},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}z.parse(this.audioTrack.parsingData,e,s.length,a,this.logger),this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,{id3Samples:[{pts:a,dts:a,data:s.payload,frames:s.frames}],inputTimescale:9e4},void 0,t,i,r)}}function J(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}function Z(e){return"number"==typeof e&&isFinite(e)}function ee(e,t){return Z(e)?e:t}function te(e,i=3){return JSON.stringify(e,(e,t)=>!isNaN(t)&&null!=t&&t.toFixed?Number(null==t?void 0:t.toFixed(i)):t)}let ie=!0;function re(e){return ie?"<redacted>":e}function ne(e){if(!e)return e;if("object"!=typeof e)return e;{if(Array.isArray(e))return e.map(ne);if(e instanceof Set)return new Set(Array.from(e).map(ne));const r={};for(var[t,i]of Object.entries(e))r[t]=ne(i);return r}}function se(e){const t=[...e];for(let e=0;e<t.length;e++)t[e]=Object.assign({},t[e]),t[e].url=re(t[e].url);return t}function ae(e){const t=[...e];for(let e=0;e<t.length;e++)t[e]=Object.assign({},t[e]),t[e].url=re(t[e].url);return t}function oe(t,e){var i;return e.length<1?[]:null!==(i=le(e,([e])=>e<=t))&&void 0!==i?i:e[0]}function le(t,i){if(Array.isArray(t)&&!(t.length<1))for(let e=t.length-1;0<=e;e--){var r=t[e];if(i(r,e,t))return r}}const de=Math.pow(2,32)-1;class ue{static init(){let e;for(e in ue.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],free:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],dec3:[],"ec-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[],uuid:[],encv:[],enca:[],frma:[],schm:[],schi:[],senc:[],saio:[],saiz:[],sinf:[],tenc:[],sbgp:[],seig:[],sgpd:[],pssh:[]},ue.types)ue.types.hasOwnProperty(e)&&(ue.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);var t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);ue.HDLR_TYPES={video:t,audio:i};var r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),n=new Uint8Array([0,0,0,0,0,0,0,0]);ue.STTS=ue.STSC=ue.STCO=n,ue.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),ue.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),ue.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),ue.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);t=new Uint8Array([105,115,111,109]),i=new Uint8Array([97,118,99,49]),n=new Uint8Array([0,0,0,1]);ue.FTYP=ue.box(ue.types.ftyp,t,n,t,i),ue.DINF=ue.box(ue.types.dinf,ue.box(ue.types.dref,r))}static set16(e,t,i){return t[i]=e>>8&255,t[i+1]=255&e,i+2}static set32(e,t,i){return t[i]=e>>24&255,t[i+1]=e>>16&255,t[i+2]=e>>8&255,t[i+3]=255&e,i+4}static box(e){var t=Array.prototype.slice.call(arguments,1);let i=8,r=t.length;for(var n=r;r--;)i+=t[r].byteLength;const s=new Uint8Array(i);for(s[0]=i>>24&255,s[1]=i>>16&255,s[2]=i>>8&255,s[3]=255&i,s.set(e,4),r=0,i=8;r<n;r++)s.set(t[r],i),i+=t[r].byteLength;return s}static hdlr(e){return ue.box(ue.types.hdlr,ue.HDLR_TYPES[e])}static mdat(e){return ue.box(ue.types.mdat,e)}static mdhd(e,t){t*=e;var i=Math.floor(t/(1+de)),t=Math.floor(t%(1+de));return ue.box(ue.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,t>>24,t>>16&255,t>>8&255,255&t,85,196,0,0]))}static mdia(e){var t=ue.mdhd(e.info.timescale,e.info.duration),i=ue.hdlr(e.type),e=ue.minf(e);return ue.box(ue.types.mdia,t,i,e)}static mfhd(e){return ue.box(ue.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?ue.box(ue.types.minf,ue.box(ue.types.smhd,ue.SMHD),ue.DINF,ue.stbl(e)):ue.box(ue.types.minf,ue.box(ue.types.vmhd,ue.VMHD),ue.DINF,ue.stbl(e))}static moof(e,t,i=null){ue.types||ue.init();i=ue.traf(t,e,i);return ue.box(ue.types.moof,ue.mfhd(t.sequenceNumber),i)}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=ue.trak(e[t]);return ue.box.apply(null,[ue.types.moov,ue.mvhd(e[0].info.timescale,e[0].info.duration)].concat(i).concat(ue.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=ue.trex(e[t]);return ue.box(ue.types.mvex,...i)}static mvhd(e,t){t*=e;var i=Math.floor(t/(1+de)),t=Math.floor(t%(1+de)),t=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,t>>24,t>>16&255,t>>8&255,255&t,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return ue.box(ue.types.mvhd,t)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let r,n;for(n=0;n<t.length;n++)r=t[n].flags,i[n+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return ue.box(ue.types.sdtp,i)}static stbl(e){var t=ue.stsd(e),i=ue.box(ue.types.stts,ue.STTS),r=ue.box(ue.types.stsc,ue.STSC),n=ue.box(ue.types.stsz,ue.STSZ),e=ue.box(ue.types.stco,ue.STCO);return ue.box(ue.types.stbl,t,i,r,n,e)}static avc1(e){let t,i,r,n=[],s=[];var a=e.info.encrypted?ue.types.encv:ue.types.avc1;for(t=0;t<e.config.sps.length;t++)i=e.config.sps[t],r=i.byteLength,n.push(r>>>8&255),n.push(255&r),n=n.concat(Array.prototype.slice.call(i));for(t=0;t<e.config.pps.length;t++)i=e.config.pps[t],r=i.byteLength,s.push(r>>>8&255),s.push(255&r),s=s.concat(Array.prototype.slice.call(i));var o=ue.box(ue.types.avcC,new Uint8Array([1,n[3],n[4],n[5],255,224|e.config.sps.length].concat(n).concat([e.config.pps.length]).concat(s))),l=e.config.width,d=e.config.height,u=e.config.pixelRatio[0],c=e.config.pixelRatio[1],h=e.info.encrypted&&e.info.keyTagInfo?ue.sinf(e.info.keyTagInfo,e.type,ue.types.avc1):new Uint8Array;return ue.box(a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,255&l,d>>8&255,255&d,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,h,ue.box(ue.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),ue.box(ue.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,255&u,c>>24,c>>16&255,c>>8&255,255&c])))}static esds(e){var t=e.esdsConfig.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.esdsConfig).concat([6,1,2]))}static audioStsd(e){var t=e.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0])}static dac3(e){e=e.extraData;return new Uint8Array([e>>16&255,e>>8&255,255&e])}static dec3(e){return e.extraDataBytes}static mp4a(e,t){let i=ue.types.mp4a,r=null;r=e.encrypted&&e.keyTagInfo?(i=ue.types.enca,ue.sinf(e.keyTagInfo,"audio",ue.types.mp4a)):new Uint8Array;e=ue.audioStsd(t),t=ue.box(ue.types.esds,ue.esds(t));return ue.box(i,e,t,r)}static mp3(e){return ue.box(ue.types[".mp3"],ue.audioStsd(e))}static ac3(e,t){let i=ue.types["ac-3"],r=null;return r=e.encrypted&&e.keyTagInfo?(i=ue.types.enca,ue.sinf(e.keyTagInfo,"audio",ue.types["ac-3"])):new Uint8Array,ue.box(i,ue.audioStsd(t),ue.box(ue.types.dac3,ue.dac3(t)),r)}static ec3(e,t){let i=ue.types["ec-3"],r=null;return r=e.encrypted&&e.keyTagInfo?(i=ue.types.enca,ue.sinf(e.keyTagInfo,"audio",ue.types["ec-3"])):new Uint8Array,ue.box(i,ue.audioStsd(t),ue.box(ue.types.dec3,ue.dec3(t)),r)}static stsd(e){if("audio"!==e.type)return ue.box(ue.types.stsd,ue.STSD,ue.avc1(e));if("mp3"===e.config.segmentCodec&&"mp3"===e.config.codec)return ue.box(ue.types.stsd,ue.STSD,ue.mp3(e.config));if("ac3"===e.config.segmentCodec)return ue.box(ue.types.stsd,ue.STSD,ue.ac3(e.info,e.config));if("ec3"===e.config.segmentCodec)return ue.box(ue.types.stsd,ue.STSD,ue.ec3(e.info,e.config));if("aac"===e.config.segmentCodec)return ue.box(ue.types.stsd,ue.STSD,ue.mp4a(e.info,e.config));throw`unknown segmentCodec ${e.config.segmentCodec}`}static tkhd(e){var t=e.info.id,i=e.info.duration*e.info.timescale,r=Math.floor(i/(1+de)),i=Math.floor(i%(1+de));let n=0,s=0;return"video"===e.type&&(n=e.config.width,s=e.config.height),ue.box(ue.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r,i>>24,i>>16&255,i>>8&255,255&i,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,n>>8&255,255&n,0,0,s>>8&255,255&s,0,0]))}static traf(e,t,i=0){var r=ue.senc(e),n=ue.sdtp(e),s=r.boxData,a=s.length?ue.saio(76):new Uint8Array,o=s.length?ue.saiz(r.defaultSampleInfoSize,r.sampleInfoSizes):new Uint8Array,l=ue.sbgp(e),d=ue.sgpd(e),u=e.id,r=Math.floor(t/(1+de)),t=Math.floor(t%(1+de));return ue.box(ue.types.traf,ue.box(ue.types.tfhd,new Uint8Array([0,2,0,0,u>>24,u>>16&255,u>>8&255,255&u])),ue.box(ue.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,255&r,t>>24,t>>16&255,t>>8&255,255&t])),s,a,o,l,d,ue.trun(e,n.length+s.length+l.length+d.length+a.length+o.length+16+20+8+16+8+8),n)}static trak(e){if("trakData"in e)return e.trakData;e.info.duration=e.info.duration||4294967295;var t=ue.types.trak,i=ue.tkhd(e),e=ue.mdia(e);return ue.box(t,i,e)}static trex(e){e=e.info.id;return ue.box(ue.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],r=i.length,n=12+16*r,s=new Uint8Array(n);let a,o,l,d,u,c;for(t+=8+n,s.set([1,0,15,1,r>>>24&255,r>>>16&255,r>>>8&255,255&r,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),a=0;a<r;a++)l=(o=i[a]).duration,d=o.size,u=o.flags,c=o.cts,s.set([l>>>24&255,l>>>16&255,l>>>8&255,255&l,d>>>24&255,d>>>16&255,d>>>8&255,255&d,u.isLeading<<2|u.dependsOn,u.isDependedOn<<6|u.hasRedundancy<<4|u.paddingValue<<1|u.isNonSync,61440&u.degradPrio,15&u.degradPrio,c>>>24&255,c>>>16&255,c>>>8&255,255&c],12+16*a);return ue.box(ue.types.trun,s)}static initSegment(e){ue.types||ue.init();const t=ue.moov(e),i=new Uint8Array(ue.FTYP.byteLength+t.byteLength);return i.set(ue.FTYP),i.set(t,ue.FTYP.byteLength),i}static saio(e){e=e+4+4;return ue.box(ue.types.saio,new Uint8Array([0,0,0,0,0,0,0,1,e>>24&255,e>>16&255,e>>8&255,255&e]))}static saiz(e,t){Z(e)||(e=0);var i=t.length,t=0===e?new Uint8Array(t):new Uint8Array;return ue.box(ue.types.saiz,new Uint8Array([0,0,0,0,e,i>>24&255,i>>16&255,i>>8&255,255&i]),t)}static senc(e){const t=e.samples||[],i=t.length;let r=0,n=NaN,s=!0;const a=[];if(!e.encrypted||i<=0)return{boxData:new Uint8Array,sampleInfoSizes:a,defaultSampleInfoSize:0};e=e.defaultPerSampleIVSize||0;for(const d of t)d.subsamples&&(r+=d.subsamples.length);if(r<=0)return{boxData:new Uint8Array,sampleInfoSizes:a,defaultSampleInfoSize:0};const o=new Uint8Array(2*i+i*e+6*r+4);let l=this.set32(i,o,0);for(const d of t){const t=d.subsamples||[];let e=2;d.iv&&(o.set(d.iv,l),l+=d.iv.byteLength,e+=d.iv.byteLength),l=this.set16(t.length,o,l);for(const d of t)l=this.set16(d[0],o,l),l=this.set32(d[1],o,l),e+=6;a.push(e),Z(n)||(n=e),s=s&&n===e,n=e}return{boxData:ue.box(ue.types.senc,new Uint8Array([0,0,0,2]),o),defaultSampleInfoSize:s?n:0,sampleInfoSizes:a}}static sinf(e,t,i){return ue.box(ue.types.sinf,ue.frma(i),ue.schm(),ue.schi(e,t))}static frma(e){return ue.box(ue.types.frma,new Uint8Array(e))}static schm(){return ue.box(ue.types.schm,new Uint8Array([0,0,0,0,99,98,99,115,0,1,0,0]))}static schi(e,t){return ue.box(ue.types.schi,ue.tenc(e,t))}static tenc(e,t){let i=0;"video"===t&&(i=25);const r=new Uint8Array(17);if(r[0]=16,e.iv&&16===e.iv.byteLength&&r.set(e.iv,1),!e.keyId)throw"tenc: no key id found in decryptdata";return ue.box(ue.types.tenc,new Uint8Array([1,0,0,0,0,i,1,0]),e.keyId,r)}static sbgp(e){if(!e.encrypted||0===e.samples.length||!e.samples[0].keyTagInfo)return new Uint8Array;e=e.samples.length;return ue.box(ue.types.sbgp,new Uint8Array([0,0,0,0]),new Uint8Array(ue.types.seig),new Uint8Array([0,0,0,1,e>>24&255,e>>16&255,e>>8&255,255&e,0,1,0,1]))}static sgpd(e){if(!e.encrypted||0===e.samples.length||!e.samples[0].keyTagInfo)return new Uint8Array;var t=e.samples[0].keyTagInfo;let i=0;"video"===e.type&&(i=25);const r=new Uint8Array(17);if(r[0]=16,t.iv&&r.set(t.iv,1),!t.keyId)throw"sgpd: no keyid in decryptdata";return ue.box(ue.types.sgpd,new Uint8Array([1,0,0,0]),new Uint8Array(ue.types.seig),new Uint8Array([0,0,0,37,0,0,0,1]),new Uint8Array([0,i,1,0]),t.keyId,r)}static pssh(e,t,i){if(ue.types||ue.init(),!e)throw new TypeError("Bad system id");if(16!==e.byteLength)throw new RangeError("Invalid system id");let r,n,s;if(t){r=1,n=new Uint8Array(16*t.length);for(let e=0;e<t.length;e++){const i=t[e];if(16!==i.byteLength)throw new RangeError("Invalid key");n.set(i,16*e)}}else r=0,n=new Uint8Array;0<r?(s=new Uint8Array(4),0<t.length&&new DataView(s.buffer).setUint32(0,t.length,!1)):s=new Uint8Array;var a=new Uint8Array(4);return i&&0<i.byteLength&&new DataView(a.buffer).setUint32(0,i.byteLength,!1),ue.box(ue.types.pssh,new Uint8Array([r,0,0,0]),e,s,n,a,i||new Uint8Array)}}var ce,he,pe=ue;(e=ce=ce||{})[e.SDR=0]="SDR",e[e.HDR=1]="HDR",e[e.HDR10=2]="HDR10",e[e.DolbyVision=3]="DolbyVision",e[e.HLG=4]="HLG",(Ti=he=he||{})[Ti.H264=16]="H264",Ti[Ti.HEVC=64]="HEVC",Ti[Ti.VP09=65]="VP09";const fe=new Set(["ac-3","mp4a.a5","mp4a.A5"]),me=new Set(["ec-3","mp4a.a6","mp4a.A6"]),ge={aac:1024,mp3:1024,ac3:1536,ec3:1536},ye={isAC3:e=>Boolean(e&&fe.has(e)),isEC3:e=>Boolean(e&&me.has(e)),isDolbyAtmos(e,t){const i=t.split("/");return Boolean(ye.isEC3(e)&&1<i.length&&i[1].split(",").find(e=>"JOC"===e))},isAAC(e){return Boolean(e&&("aac"===e||null!==(e=e.match(/^mp4a\.40\.(.*)/))&&"34"!==e[1]))},isMP3(e){return Boolean(e&&("mp3"===e||null!==(e=e.match(/^mp4a\.40\.(.*)/))&&"34"===e[1]))},isAVC:e=>Boolean(e&&e.match(/^avc[13]\.(.*)/)),isXHEAAC:function(e){return Boolean("mp4a.40.42"===e)},isALAC:function(e){return Boolean("alac"===e)},isFLAC:function(e){return Boolean("fLaC"===e)},isHEVC:e=>Boolean(e&&e.match(/^(hev|hvc)1\..*/)),isDolby:e=>Boolean(e&&e.match(/^dv(h1|he|a1|av)\..*/)),isVP09:e=>Boolean(e&&e.match(/^vp09\..*/)),isCompatibleCodecString(e,t){const i=e.split(","),r=t.split(","),n=i.filter(e=>ye.isVideoCodec(e)),s=r.filter(e=>ye.isVideoCodec(e)),a=i.filter(e=>ye.isAudioCodec(e)),o=r.filter(e=>ye.isAudioCodec(e)),l=0===n.length&&0===s.length||n.length===s.length&&ye.isCompatibleVideoCodec(n[0],s[0]),d=0===a.length&&0===o.length||a.length===o.length&&ye.isCompatibleAudioCodec(a[0],o[0]);return l&&d},isVideoCodec:e=>ye.isAVC(e)||ye.isDolby(e)||ye.isHEVC(e)||ye.isVP09(e),isAudioCodec:e=>ye.isAC3(e)||ye.isEC3(e)||ye.isAAC(e)||ye.isMP3(e),isCompatibleVideoCodec:(e,t)=>Boolean(e&&t&&(e===t||ye.isDolby(e)&&ye.isDolby(t)||ye.isHEVC(e)&&ye.isHEVC(t)||ye.isAVC(e)&&ye.isAVC(t)||ye.isVP09(e)&&ye.isVP09(t))),isCompatibleAudioCodec:(e,t)=>Boolean(e&&t&&(e===t||ye.isAAC(e)&&ye.isAAC(t)||ye.isAC3(e)&&ye.isAC3(t)||ye.isEC3(e)&&ye.isEC3(t)||ye.isMP3(e)&&ye.isMP3(t))),getSegmentCodec(e){let t;if(ye.isAAC(e))t="aac";else if(ye.isAC3(e))t="ac3";else if(ye.isEC3(e))t="ec3";else{if("mp3"!==e)throw new Error(`invalid audio config, codec ${e}`);t="mp3"}return t},getChannelCount(e){if(!e)return 0;e=e.split("/"),e=parseInt(e[0]);return Z(e)?e:0},avc1toavcoti(e){var t;const i=e.split(".");let r;return 2<i.length?(r=i.shift()+".",r+=parseInt(null!==(t=i.shift())&&void 0!==t?t:"").toString(16),r+=("000"+parseInt(null!==(t=i.shift())&&void 0!==t?t:"").toString(16)).substr(-4)):r=e,r},getDynamicRangeType(e,t){let i=ce.SDR;return"PQ"===e&&ye.isDolby(t)?i=ce.DolbyVision:"PQ"===e&&(ye.isHEVC(t)||ye.isVP09(t))?i=ce.HDR10:"HLG"!==e||-1===t.indexOf("hvc1")&&!ye.isVP09(t)||(i=ce.HLG),i},getCompressionType(e){let t=he.H264;return ye.isHEVC(e)||ye.isDolby(e)?t=he.HEVC:ye.isVP09(e)&&(t=he.VP09),t},isHigherCodecByFamily(e,t){if(!e)return!0;const i=e.split("."),r=t.split(".");if(i[0]!==r[0])throw new Error(`mismatch in codec family current/new: ${i[0]}/${r[0]}`);switch(i[0]){case"avc1":case"avc3":return r[1]>i[1];case"vp09":return e<t;case"hvc1":case"hev1":var n="H"===i[3].substring(0,1)?1:0,s=i[3].substring(1),a="H"===r[3].substring(0,1)?1:0,o=r[3].substring(1);return r[1]>i[1]||r[2]>i[2]||n<a||s<o;case"dvh1":return r[1]>i[1]||r[2]>i[2]}}};class ve{static getTrack(e,t,i,r,n){let s;switch(ye.getSegmentCodec(i)){case"aac":var a=v(e,1===r?new Uint8Array([255,241,92,64,1,127,252]):new Uint8Array([255,241,92,128,1,191,252]),0,i);a&&(s={type:"audio",info:{id:t,timescale:a.samplerate,duration:0,encrypted:!1,keyTagInfo:void 0},config:a});break;case"ac3":case"ec3":{const i=C(e,new Uint8Array([11,119,69,17,128,64,47,132]),0);i&&(s={type:"audio",info:{id:t,timescale:i.samplerate,duration:0,encrypted:!1,keyTagInfo:void 0},config:i})}}return s}static getSample(e,t){let i;switch(e){case"mp4a.40.2":case"mp4a.40.5":i=1===t?new Uint8Array([0,208,0,7]):new Uint8Array([33,0,3,64,104,28]);break;case"ac-3":case"ec-3":i=new Uint8Array([11,119,69,17,128,64,47,132,41,3,253,214,124,253,243,215,233,95,185,123,78,20,40,106,97,190,74,253,43,218,208,140,191,176,144,120,214,181,44,124,129,251,91,109,187,109,198,225,43,172,116,140,176,123,38,144,211,247,225,64,29,53,175,96,16,57,121,87,78,203,81,37,7,72,228,132,37,169,38,231,97,229,247,194,208,8,12,83,74,139,137,17,22,26,221,203,107,113,94,93,75,33,208,247,146,105,39,143,6,36,1,227,108,70,11,180,152,218,182,218,209,59,85,104,201,70,37,82,219,68,55,225,144,99,149,0,119,26,14,69,164,241,204,222,81,177,142,80,20,100,97,143,101,221,140,113,31,208,124,25,64,29,49,77,140,30,155,74,214,204,138,229,109,172,95,130,70,230,134,88,59,179,212,155,232,0,0,0,0,0,173,234])}return i}static getSegment(e,i,r,n){if(e){var s=e.info["timescale"],a=e.config["segmentCodec"],o=ve.getSample(e.config.codec,e.config.channelCount);if(o){const l=[],d={id:e.info.id,sequenceNumber:i,type:"audio",encrypted:!1,samples:l,defaultPerSampleIVSize:0},u=ge[a],c=Math.ceil(n*s/u),h={baseTime:Math.round(c*u+r),timescale:s};let t=0;const p=c*o.byteLength+8,f=new Uint8Array(p);f[0]=p>>24&255,f[1]=p>>16&255,f[2]=p>>8&255,f[3]=255&p,pe.types||pe.init(),f.set(pe.types.mdat,4),t+=8;for(let e=0;e<c;e++)l.push({duration:u,size:o.byteLength,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,isNonSync:0,paddingValue:0}}),f.set(o,t),t+=o.byteLength;const m=pe.moof(r,d),g=new Uint8Array(m.byteLength+f.byteLength);return g.set(m),g.set(f,m.byteLength),{silentFragData:g,endTs:h}}}}}let Se=null;class be extends a{constructor(e,t,i,r,n){super(e,t,n),this.typeSupported=i,this.nextAudioTimeOffset=null,this.nextAvcTimeOffset=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.logger=n.child({name:"EsRemuxer"});const s=navigator.userAgent||"";if(null===Se){const e=s.match(/Chrome\/(\d+)/i);Se=e?parseInt(e[1]):0}}resetTimeStamp(e){this._initPTS=this._initDTS=e,this.nextAudioTimeOffset=this.nextAvcTimeOffset=null}resetInitSegment(){this.currentInitTrack=void 0,this._silentAudioTrack=void 0}remuxEsTracks(r,n,s,a,o,l,d,u,c,h){l||(this.isVideoContiguous=this.isAudioContiguous=!1);var p=this.isVideoContiguous,f=this.isAudioContiguous,m=r&&0<r.parsingData.esSamples.length,g=n&&0<n.parsingData.esSamples.length;let y;l=void 0===c?o:c;let v=l,S=l;if(!this.currentInitTrack){if(r&&r.config.codec&&(this._audioTrackInfo={id:r.info.id,codec:r.config.codec,channelCount:r.config.channelCount}),n&&h&&this._audioTrackInfo){const r=ve.getTrack(this.observer,this._audioTrackInfo.id,this._audioTrackInfo.codec,this._audioTrackInfo.channelCount,this.logger);if(r){this._silentAudioTrack=Object.assign(Object.assign({},r),{info:Object.assign(Object.assign({},r.info),{inputTimescale:9e4}),parsingData:{len:0,sequenceNumber:0,esSamples:[]}});const s=this._initPTS+Math.round(l*this._silentAudioTrack.info.timescale);y=ve.getSegment(this._silentAudioTrack,n.parsingData.sequenceNumber,s,h),n.parsingData.sequenceNumber++}}else this._silentAudioTrack=void 0;this.updateInitPTSDTS(n,r,o),this.generateIS(this._silentAudioTrack||r,n)}if(this.currentInitTrack){let t,i,e;if(m&&g&&void 0===c){const s=Ie(n.parsingData.esSamples),b=(Te(r.parsingData.esSamples[0].pts,s)-s)/n.info.inputTimescale;v+=Math.max(0,b),S+=Math.max(0,-b)}if(n&&h&&this._silentAudioTrack&&!y){const r=this._initPTS+Math.round((l+this.config.audioPrimingDelay)*this._silentAudioTrack.info.timescale);y=ve.getSegment(this._silentAudioTrack,n.parsingData.sequenceNumber,r,h)}if(m){if(Z(r.info.timescale)||(this.logger.warn("regenerate InitSegment as audio detected"),this.updateInitPTSDTS(n,r,o),this.generateIS(r,n)),t=this.remuxAudio(r,v,f,d,g?S:void 0,u),g){let e;t&&(e=E(t.endPTS)-E(t.startPTS)),Z(n.info.timescale)||(this.logger.warn("regenerate InitSegment as video detected"),this.updateInitPTSDTS(n,r,o),this.generateIS(r,n)),i=this.remuxVideo(n,S,p,e,h)}}else g&&(i=this.remuxVideo(n,S,p,void 0,h)),i&&r&&r.config.codec&&(t=this.remuxEmptyAudio(r,v,f,d,g?S:void 0,i,u));if(y)e={data1:i.data1,data2:y.silentFragData,startDTS:i.startDTS,startPTS:i.startPTS,endDTS:w(i.endDTS,y.endTs),endPTS:w(i.endPTS,y.endTs),type:"audiovideo",track:this.currentInitTrack};else if(i&&t)e={data1:i.data1,data2:t.data1,startDTS:(g=i.startDTS,u=t.startDTS,E(g)<E(u)?g:u),startPTS:i.startPTS,endDTS:i.endDTS,endPTS:i.endPTS,type:"audiovideo",track:this.currentInitTrack,dropped:i.dropped,framesWithoutIDR:i.framesWithoutIDR,firstKeyframePts:i.firstKeyframePts};else if(i)e={data1:i.data1,startDTS:i.startDTS,startPTS:i.startPTS,endDTS:i.endDTS,endPTS:i.endPTS,type:"video",track:this.currentInitTrack,dropped:i.dropped,framesWithoutIDR:i.framesWithoutIDR,firstKeyframePts:i.firstKeyframePts};else if(t)e={data1:t.data1,startDTS:t.startDTS,startPTS:t.startPTS,endDTS:t.endDTS,endPTS:t.endPTS,type:"audio",track:this.currentInitTrack};else if(this.logger.error("Missing video and audio data"),c){const r=F(c,1);e={data1:new Uint8Array(0),startDTS:r,startPTS:r,endDTS:r,endPTS:r,type:"video",track:this.currentInitTrack,dropped:1,framesWithoutIDR:1,firstKeyframePts:r}}null!=a&&a.captionSamples.length&&e&&this.remuxText(a,e),null!==(a=null==s?void 0:s.id3Samples)&&void 0!==a&&a.length&&e&&this.remuxID3(s,e),this.observer.trigger(I.FRAG_PARSING_DATA,e)}else this.logger.error("failed to generate IS");this.observer.trigger(I.FRAG_PARSED)}updateInitPTSDTS(e,t,i){let r=1/0,n=1/0;const s=e?e.parsingData.esSamples:[],a=t?t.parsingData.esSamples:[];if(!Z(this._initPTS)){if(t&&a.length&&(r=n=a[0].pts-t.info.inputTimescale*i),e&&s.length&&e.config.sps&&e.config.pps){const t=e.info.inputTimescale,a=Ie(s),o=Math.round(t*i);e.info.timescale=t,r=Math.min(r,a-o),n=Math.min(n,Te(s[0].dts,a)-o),this.observer.trigger(I.INIT_PTS_FOUND,{initPTS:F(r,t)})}if(Z(r)&&Z(n))this._initPTS=r,this._initDTS=n;else{const e=new b(!1,"invalid initPTS or initDTS",K.InvalidInitTimestamp);this.observer.trigger(D.INTERNAL_ERROR,e)}}}generateIS(e,t){const i=t?t.parsingData.esSamples:[],r=this.typeSupported;let n,s="audio/mp4";if(e&&t&&i.length&&t.config.sps&&t.config.pps){const i=t.info.inputTimescale;t.info.timescale=i,e.info.timescale=e.config.samplerate;const r=ue.initSegment([t,e]);n={type:"audiovideo",container:"video/mp4",codec:`${t.config.codec},${e.config.codec}`,initSegment:r}}else if(e){"mp3"===(e.info.timescale=e.config.samplerate,e.config.segmentCodec)&&(r.mpeg?(s="audio/mpeg",e.config.codec=""):r.mp3&&(e.config.codec="mp3"));const t="mp3"===e.config.segmentCodec&&r.mpeg?new Uint8Array:ue.initSegment([e]);n={type:"audio",container:s,codec:e.config.codec,initSegment:t}}else if(t&&i.length&&t.config.sps&&t.config.pps){const e=t.info.inputTimescale;t.info.timescale=e;const i=ue.initSegment([t]);n={type:"video",container:"video/mp4",codec:t.config.codec,initSegment:i}}if(n){this.currentInitTrack=n;const e={track:n};this.observer.trigger(I.FRAG_PARSING_INIT_SEGMENT,e)}else{const e=new b(!1,"no audio/video samples found",K.NoAVSamplesFound);this.observer.trigger(D.INTERNAL_ERROR,e)}}remuxVideo(n,s,e,a,t){let o,l,d,u=8,c=this.videoSampleDuration,h=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,r=n.parsingData.dropped,p=this.nextAvcTimeOffset;const f=!e&&this.config.forceKeyFrameOnDiscontinuity,m=n.parsingData.esSamples,g=n.info.inputTimescale,y=[],v=this._initDTS,S=n.info.encrypted,b=Z(t);let T,I=m.length,E=!1;e&&null!==p||(p=s*g-(m[0].pts-Te(m[0].dts,m[0].pts)));for(let e=0;e<I;e++){const s=m[e];s.pts=Te(s.pts,v),s.dts=Te(s.dts,v),s.dts<m[0<e?e-1:e].dts&&(E=!0)}E&&m.sort(function(e,t){var i=e.dts-t.dts,r=e.pts-t.pts;return i||r||e.id-t.id});var w=m.findIndex(e=>e.key);m[w]&&(T=m[w].pts),f&&(0<w?(this.logger.warn(`Dropped ${w} out of ${m.length} video samples due to a missing keyframe`),m.splice(0,w),I=m.length,r+=w):-1===w&&(this.logger.warn(`No keyframe found out of ${m.length} video samples`),r+=m.length)),d=b?(l=h=T=p=s*g,c=t*g/I,i=l+c*(I-1)):(l=m[0].dts,m[m.length-1].dts);var t=d-l,O=t?Math.round(t/(I-1)):c||g/30;if(e&&!b){const n=l-(p+v),s=n>O,P=n<-1;if(s||P){const P=(l-v)/g;s?this.logger.warn(`AVC: ${n}/${g} hole between fragments detected @ ${P.toFixed(3)}s`):this.logger.warn(`AVC: ${n}/${g} overlap between fragments detected @ ${P.toFixed(3)}s`)}}l=Math.max(0,l);let A=0,R=0;for(let e=0;e<I;e++){const s=m[e],P=s.units,a=P.length;let t=0;for(let e=0;e<a;e++)t+=P[e].data.length;R+=t,A+=a,s.length=t,s.dts=Math.max(s.dts,l),b||(h=Math.min(s.pts,h),i=Math.max(s.pts,i))}b||(d=m[I-1].dts,i=Math.max(i,0,h+O));t=R+4*A+8;try{o=new Uint8Array(t)}catch(n){const s=new N(!1,`fail allocating video mdat ${t}`,K.FailedToAllocateVideoMdat,t);return void this.observer.trigger(D.INTERNAL_ERROR,s)}const k=new DataView(o.buffer);k.setUint32(0,t),o.set(ue.types.mdat,4);let C=!1;for(let t=0;t<I;t++){const s=m[t],P=s.units;let i=0;const l=[];let e,r=0;for(let e=0,t=P.length;e<t;e++){const s=P[e],a=s.data,d=s.data.byteLength;if(k.setUint32(u,d),u+=4,o.set(a,u),u+=d,i+=4+d,S)if(d<=48||1!==s.type&&5!==s.type)r+=4+d;else{let e=d-32;e%16==0&&(e-=16),l.push([r+36,e]),r=d-32-e}}if(0<r&&l.push([r,0]),b)e=0;else{if(t<I-1)c=m[t+1].dts-s.dts;else{const P=this.config,x=0<t?s.dts-m[t-1].dts:O;if(P.stretchShortVideoTrack&&null!==this.nextAvcTimeOffset){const{maxBufferHole:n,maxSeekHole:o}=P,l=Math.floor(Math.min(n,o)*g),d=(a?h+a*g:this.nextAudioTimeOffset+this._initPTS)-s.pts;d>l?(c=d-x,c<0?c=x:C=!0):c=x}else c=x}e=Math.round(s.pts-s.dts)}y.push({size:i,duration:c,cts:e,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:s.key?2:1,isNonSync:s.key?0:1,paddingValue:0},keyTagInfo:s.keyTagInfo,subsamples:l})}if(y.length&&Se&&Se<70){const n=y[0].flags;n.dependsOn=2,n.isNonSync=0}e=d+c;this.nextAvcTimeOffset=e-(b?0:v),this.videoSampleDuration=C||!c?O:c,this.isVideoContiguous=!0;t={sequenceNumber:n.parsingData.sequenceNumber++,id:n.info.id,type:n.type,encrypted:n.info.encrypted,samples:y,defaultPerSampleIVSize:0},t=ue.moof(l+this.config.audioPrimingDelay*g,t);n.parsingData.esSamples=[];const M=new Uint8Array(t.byteLength+o.byteLength);return M.set(t),M.set(o,t.byteLength),{data1:M,startPTS:F(h/g,g),endPTS:F(i/g,g),startDTS:F(l/g,g),endDTS:F(e/g,g),type:"video",dropped:r,framesWithoutIDR:w,firstKeyframePts:F(T/g,g)}}remuxAudio(n,e,i,s,a,o){const l=n.info.inputTimescale,d=l/n.info.timescale,u=("aac"===n.config.segmentCodec?1024:"mp3"===n.config.segmentCodec?1152:1536)*d,c=this._initPTS,r="mp3"===n.config.segmentCodec&&this.typeSupported.mpeg,h=[],p=n.info.encrypted,t=void 0!==a;let f,m,g,y=r?0:8;const v=new x,S=n.parsingData.esSamples;let b=this.nextAudioTimeOffset||-1;var T=e*l,e=S.length&&0<b&&(s&&Math.abs(T-b)<9e3||Math.abs(Te(S[0].pts-c,T)-b)<20*u),I=this.isAudioContiguous=i=i||e;S.forEach(e=>{e.pts=e.dts=Te(e.pts,c)}),I&&-1!==b||(b=0===a?0:s&&!t?T:S[0].pts-c);let E=Math.max(0,b+c);if("aac"===n.config.segmentCodec)for(let i=0,r=E;i<S.length;i++){const s=S[i],a=s.pts,d=a-r,D=d/l;if(d<=-u&&t)0===i&&(this.logger.warn(`Audio frame @ ${((a-c)/l).toFixed(3)}s overlaps nextAudioPts by ${Math.round(D)} ms.`),E=r=a,this.nextAudioTimeOffset=E-c);else if(d>=u&&D<1e4&&t){let t=Math.round(d/u);r=a-t*u,r<0&&(t--,r+=u),0===i&&(E=r,this.nextAudioTimeOffset=E-c),this.logger.warn(`Injecting ${t} audio frame @ ${((r-c)/l).toFixed(3)}s due to ${Math.round(D)} ms gap.`);for(let e=0;e<t;e++){let e=J(n.config.codec,n.config.channelCount);e||(this.logger.warn("Unable to get silent frame for given audio codec; duplicating last frame instead."),e=s.unit.subarray(0)),S.splice(i,0,{unit:e,pts:r,dts:r,keyTagInfo:o}),n.parsingData.len+=e.length,r+=u,i++}}r+=u}let w,O=null,A=null,R=0,k=S.length;for(;k--;)R+=S[k].unit.byteLength;for(let t=0,e=S.length;t<e;t++){const i=S[t],s=i.unit;let e=i.pts;if(null!==A)h[t-1].duration=Math.round((e-A)/d);else{if(I&&"aac"===n.config.segmentCodec&&(e=E),O=e,!(0<R))return;R+=y;try{w=new Uint8Array(R)}catch(n){const C=new N(!1,`fail allocating audio mdat ${R}`,K.FailedToAllocateAudioMdat,R);return void this.observer.trigger(D.INTERNAL_ERROR,C)}r||(f=new DataView(w.buffer),f.setUint32(0,R),w.set(ue.types.mdat,4))}w.set(s,y);const o=s.byteLength;y+=o;const l=[];if(p)if("ec3"===n.config.segmentCodec){let e=0;for(;e<s.byteLength;){const C=2*(v.bsReadAndUpdate(s,{byteOffset:e+2,usedBits:5},11)+1);e+=C;const i=Math.min(C,16);l.push([i,C-i])}}else{const n=Math.min(o,16);l.push([n,o-n])}m={size:o,cts:0,duration:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,paddingValue:0,isNonSync:0},keyTagInfo:i.keyTagInfo,subsamples:l},h.push(m),A=e}T=h.length;if(T){let e=h[T-1].duration;if(2<=T&&(e=h[T-2].duration,m.duration=e),E=A+d*e,this.nextAudioTimeOffset=E-c,n.parsingData.len=0,r)g=new Uint8Array;else{const C={sequenceNumber:n.parsingData.sequenceNumber++,id:n.info.id,type:n.type,encrypted:n.info.encrypted,samples:h,defaultPerSampleIVSize:0};g=ue.moof((O+this.config.audioPrimingDelay*l)/d,C)}const i=new Uint8Array(g.byteLength+w.byteLength);i.set(g),i.set(w,g.byteLength),n.parsingData.esSamples=[];const s={data1:i,startPTS:F(O/l,l),endPTS:F(E/l,l),startDTS:F(O/l,l),endDTS:F(E/l,l),type:"audio"};return this.isAudioContiguous=!0,s}return null}remuxEmptyAudio(t,e,i,r,n,s,a){var o=t.info.inputTimescale,l=o/(t.config.samplerate||o),d=this.nextAudioTimeOffset+this._initPTS,u=d+this._initDTS,o=E(s.endDTS)*o+this._initDTS,c=1024*l,h=Math.ceil((o-u)/c),p=J(t.config.codec,t.config.channelCount);if(this.logger.warn("remux empty Audio"),!p)return this.logger.error("Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec!"),null;const f=[];for(let e=0;e<h;e++){const i=u+e*c;f.push({unit:p,pts:i,dts:i,keyTagInfo:a}),t.parsingData.len+=p.length}return t.parsingData.esSamples=f,this.remuxAudio(t,e,i,r,n,a)}remuxID3(t,e){var i=t.id3Samples.length;let r;var n=t.inputTimescale;if(i){for(let e=0;e<i;e++)r=t.id3Samples[e],r.pts=r.pts/n,r.dts=r.dts/n;e.id3Samples=t.id3Samples}t.id3Samples=[]}remuxText(t,e){t.captionSamples.sort(function(e,t){return e.pts-t.pts});var i=t.captionSamples.length;let r;var n=t.inputTimescale;if(i){for(let e=0;e<i;e++)r=t.captionSamples[e],r.pts=r.pts/n;e.captionData||(e.captionData={}),e.captionData.ts=t.captionSamples}t.captionSamples=[]}}function Te(e,t){var i;if(void 0===t)return e;for(i=t<e?-8589934592:8589934592;4294967296<Math.abs(e-t);)e+=i;return e}function Ie(e){return e.reduce((e,t)=>{var i=t.pts-e;return i<-4294967296?Te(e,t.pts):0<i?e:t.pts},e[0].pts)}var Ee="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:void 0!==u0?u0:{};function we(e){try{return JSON.stringify(e)}catch(e){return'"[Circular]"'}}function Oe(e,t,i){var r=i&&i.stringify||we;if("object"==typeof e&&null!==e){var n=t.length+1;if(1===n)return e;var s=new Array(n);s[0]=r(e);for(var a=1;a<n;a++)s[a]=r(t[a]);return s.join(" ")}if("string"!=typeof e)return e;var o=t.length;if(0===o)return e;for(var l="",d=0,u=-1,c=e&&e.length||0,h=0;h<c;){if(37===e.charCodeAt(h)&&h+1<c){switch(u=-1<u?u:0,e.charCodeAt(h+1)){case 100:if(o<=d)break;if(u<h&&(l+=e.slice(u,h)),null==t[d])break;l+=Number(t[d]),u=h+=2;break;case 79:case 111:case 106:if(o<=d)break;if(u<h&&(l+=e.slice(u,h)),void 0===t[d])break;var p=typeof t[d];if("string"==p){l+="'"+t[d]+"'",u=h+2,h++;break}if("function"==p){l+=t[d].name||"<anonymous>",u=h+2,h++;break}l+=r(t[d]),u=h+2,h++;break;case 115:if(o<=d)break;u<h&&(l+=e.slice(u,h)),l+=String(t[d]),u=h+2,h++;break;case 37:u<h&&(l+=e.slice(u,h)),l+="%",u=h+2,h++}++d}++h}return-1===u?e:(u<c&&(l+=e.slice(u)),l)}var Ae=Ce;const Re=function(){function t(e){return void 0!==e&&e}try{return"undefined"!=typeof globalThis||Object.defineProperty(Object.prototype,"globalThis",{get:function(){return delete Object.prototype.globalThis,this.globalThis=this},configurable:!0}),globalThis}catch(e){return t(u0)||t(window)||t(this)||{}}}().console||{},ke={mapHttpRequest:_e,mapHttpResponse:_e,wrapRequestSerializer:Le,wrapResponseSerializer:Le,wrapErrorSerializer:Le,req:_e,res:_e,err:function(e){const t={type:e.constructor.name,msg:e.message,stack:e.stack};for(const i in e)void 0===t[i]&&(t[i]=e[i]);return t}};function Ce(s){(s=s||{}).browser=s.browser||{};const a=s.browser.transmit;if(a&&"function"!=typeof a.send)throw Error("pino: transmit option must have a send function");const e=s.browser.write||Re;s.browser.write&&(s.browser.asObject=!0);const o=s.serializers||{},l=(t=s.browser.serialize,i=o,Array.isArray(t)?t.filter(function(e){return"!stdSerializers.err"!==e}):!0===t&&Object.keys(i));var t,i;let r=s.browser.serialize;Array.isArray(s.browser.serialize)&&-1<s.browser.serialize.indexOf("!stdSerializers.err")&&(r=!1),"function"==typeof e&&(e.error=e.fatal=e.warn=e.info=e.debug=e.trace=e),!1===s.enabled&&(s.level="silent");const n=s.level||"info",d=Object.create(e);d.log||(d.log=Ne),Object.defineProperty(d,"levelVal",{get:function(){return"silent"===this.level?1/0:this.levels.values[this.level]}}),Object.defineProperty(d,"level",{get:function(){return this._level},set:function(e){if("silent"!==e&&!this.levels.values[e])throw Error("unknown level "+e);this._level=e,Me(u,d,"error","log"),Me(u,d,"fatal","error"),Me(u,d,"warn","error"),Me(u,d,"info","log"),Me(u,d,"debug","log"),Me(u,d,"trace","log")}});const u={transmit:a,serialize:l,asObject:s.browser.asObject,levels:["error","fatal","warn","info","debug","trace"],timestamp:"function"==typeof(i=s).timestamp?i.timestamp:!1===i.timestamp?Fe:Be};return d.levels=Ce.levels,d.level=n,d.setMaxListeners=d.getMaxListeners=d.emit=d.addListener=d.on=d.prependListener=d.once=d.prependOnceListener=d.removeListener=d.removeAllListeners=d.listeners=d.listenerCount=d.eventNames=d.write=d.flush=Ne,d.serializers=o,d._serialize=l,d._stdErrSerialize=r,d.child=function(t){if(!t)throw new Error("missing bindings for child Pino");var i,r,e=t.serializers;function n(e){this._childLevel=1+(0|e._childLevel),this.error=xe(e,t,"error"),this.fatal=xe(e,t,"fatal"),this.warn=xe(e,t,"warn"),this.info=xe(e,t,"info"),this.debug=xe(e,t,"debug"),this.trace=xe(e,t,"trace"),i&&(this.serializers=i,this._serialize=r),a&&(this._logEvent=De([].concat(e._logEvent.bindings,t)))}return l&&e&&(i=Object.assign({},o,e),r=!0===s.browser.serialize?Object.keys(i):l,delete t.serializers,Pe([t],r,i,this._stdErrSerialize)),n.prototype=this,new n(this)},a&&(d._logEvent=De()),d}function Me(e,t,i,r){var n,s,a,o,l=Object.getPrototypeOf(t);t[i]=!(t.levelVal>t.levels.values[i])&&(l[i]||Re[i]||Re[r])||Ne,s=t,a=i,!(n=e).transmit&&s[a]===Ne||(s[a]=(o=s[a],function(){const e=n.timestamp(),t=new Array(arguments.length),i=Object.getPrototypeOf&&Object.getPrototypeOf(this)===Re?Re:this;for(var r=0;r<t.length;r++)t[r]=arguments[r];if(n.serialize&&!n.asObject&&Pe(t,this._serialize,this.serializers,this._stdErrSerialize),n.asObject?o.call(i,function(e,t,i,r){e._serialize&&Pe(i,e._serialize,e.serializers,e._stdErrSerialize);const n=i.slice();let s=n[0];const a={};r&&(a.time=r),a.level=Ce.levels.values[t];let o=1+(0|e._childLevel);if(o<1&&(o=1),null!==s&&"object"==typeof s){for(;o--&&"object"==typeof n[0];)Object.assign(a,n.shift());s=n.length?Oe(n.shift(),n):void 0}else"string"==typeof s&&(s=Oe(n.shift(),n));return void 0!==s&&(a.msg=s),a}(this,a,t,e)):o.apply(i,t),n.transmit){const o=n.transmit.level||s.level,i=Ce.levels.values[o],r=Ce.levels.values[a];r<i||function(e,t,i){const r=t.send,n=t.ts,s=t.methodLevel,a=t.methodValue,o=t.val,l=e._logEvent.bindings;Pe(i,e._serialize||Object.keys(e.serializers),e.serializers,void 0===e._stdErrSerialize||e._stdErrSerialize),e._logEvent.ts=n,e._logEvent.messages=i.filter(function(e){return-1===l.indexOf(e)}),e._logEvent.level.label=s,e._logEvent.level.value=a,r(s,e._logEvent,o),e._logEvent=De(l)}(this,{ts:e,methodLevel:a,methodValue:r,transmitLevel:o,transmitValue:Ce.levels.values[n.transmit.level||s.level],send:n.transmit.send,val:s.levelVal},t)}}))}function Pe(e,t,i,r){for(const n in e)if(r&&e[n]instanceof Error)e[n]=Ce.stdSerializers.err(e[n]);else if("object"==typeof e[n]&&!Array.isArray(e[n]))for(const r in e[n])t&&-1<t.indexOf(r)&&r in i&&(e[n][r]=i[r](e[n][r]))}function xe(i,r,n){return function(){const e=new Array(1+arguments.length);e[0]=r;for(var t=1;t<e.length;t++)e[t]=arguments[t-1];return i[n].apply(this,e)}}function De(e){return{ts:0,messages:[],bindings:e||[],level:{label:"",value:0}}}function _e(){return{}}function Le(e){return e}function Ne(){}function Fe(){return!1}function Be(){return Date.now()}let Ue;function $e(e={}){return Object.assign(Object.assign({},e),{customLevels:Object.assign(Object.assign({},e.customLevels||{}),{qe:35})})}function Ve(t=[],i=[]){return t.length&&i.length?e=>Ue.error("Invalid configuration received, cannot have both an allowed and a disallowed list passed to configureQELogMessages()"):i.length||t.length?t.length?e=>t.includes(e.name)&&Ue.info(e):i.length?e=>!i.includes(e.name)&&Ue.info(e):void 0:e=>Ue.info(e)}Ce.levels={values:{fatal:60,error:50,warn:40,info:30,debug:20,trace:10},labels:{10:"trace",20:"debug",30:"info",40:"warn",50:"error",60:"fatal"}},Ce.stdSerializers=ke,Ce.stdTimeFunctions=Object.assign({},{nullTime:Fe,epochTime:Be,unixTime:function(){return Math.round(Date.now()/1e3)},isoTime:function(){return new Date(Date.now()).toISOString()}});const Ke=()=>{};function Qe(e,t){const i=(e=t in e?e:console)[t]||e.log;return i?i.bind(e):Ke}function qe(r,n,e,t,i){var{time:s,sessionId:a,critical:o,name:l,msg:d}=i;if(!(e.size&&!e.has(l)||t.has(l))){let e="";if("data"in i)try{const r=[],n=[];e=JSON.stringify(i.data,(e,t)=>{if("object"==typeof t&&null!==t){var i=n.indexOf(t);if(-1!==i)return`[Circular object reference: '${r[i]}']`;r.push(e),n.push(t)}return t})}catch(r){e=`Log serialization error: "${r}"`}r(`${function(){const e=new Date(s),t=e.getTimezoneOffset(),i=je(Math.floor(Math.abs(t)/60)),r=je(Math.abs(t)%60);let n=t<=0?"UTC+"+i:"UTC-"+i;return n=r?n+":"+r:n,e.getFullYear()+"-"+je(e.getMonth()+1)+"-"+je(e.getDate())+" "+je(e.getHours())+":"+je(e.getMinutes())+":"+je(e.getSeconds())+"."+(e.getMilliseconds()/1e3).toFixed(3).slice(2,5)+" "+n}()}| [SessionID: ${a}] | [${n}] >${o?" [QE Critical]":""} [${l}] ${d||""} ${e}`)}}function je(e){return e<10?"0"+e:e.toString()}function He(e,t=1/0){if(!e)return"";const i=new Uint8Array(e);let r,n="";for(r=0;r<i.length&&r<t;r++){let e=i[r].toString(16);e.length<2&&(e="0"+e),n+=e}return n}const Ge=()=>(Ue||(Ue=Ae($e()).child({name:"hls"}),Ue.qe=Ve(),Ue.warn("getLogger called without hls object instantiated, returning a logger that is not configured")),Ue),We={bin2str:e=>String.fromCharCode.apply(null,Array.from(e)),readUint16(e,t){t=e[t]<<8|e[t+1];return t<0?65536+t:t},readSint32:(e,t)=>e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],readUint32(e,t){t=We.readSint32(e,t);return t<0?4294967296+t:t},writeUint32(e,t,i){e[t]=i>>24,e[t+1]=i>>16&255,e[t+2]=i>>8&255,e[t+3]=255&i},readUint64(e,t){var i=We.readUint32(e,t);return i*=Math.pow(2,32),i+=We.readUint32(e,t+4)},writeUint64(e,t,i){var r=Math.pow(2,32)-1,n=Math.floor(i/(1+r)),r=Math.floor(i%(1+r));We.writeUint32(e,t,n),We.writeUint32(e,t+4,r)},findBox(e,t){let i,r,n,s,a,o=[];if(!t.length)return[];for(i=0;i<e.byteLength;)r=We.readUint32(e,i),n=We.bin2str(e.subarray(i+4,i+8)),s=1<r?i+r:e.byteLength,n===t[0]&&(1===t.length?o.push(e.subarray(i+8,s)):(a=We.findBox(e.subarray(i+8,s),t.slice(1))).length&&(o=o.concat(a))),i=s;return o},findBoxWithOffset(e,t,i,r){let n,s,a,o,l,d=[];if(!i.length)return[];for(n=0;n<e.byteLength;)s=We.readUint32(e,n),a=We.bin2str(e.subarray(n+4,n+8)),o=1<s?n+s:e.byteLength,a===i[0]&&(r&&r.push({offset:n+t,type:a,size:s}),1===i.length?d.push({offset:n+t,type:a,data:e.subarray(n+8,o),boxSize:s,walkedPath:r?r.slice(0):void 0}):(l=We.findBoxWithOffset(e.subarray(n+8,o),n+t+8,i.slice(1),r?r.slice(0):void 0)).length&&(d=d.concat(l),r=r?r.slice(0,-1):void 0)),n=o;return d}},ze={name:"MP4EncryptionRemuxer"};class Ye extends a{constructor(e,t,i,r,n){super(e,t,n)}static _isCommonEncryptionInternal(e){return Boolean(e&&!("NONE"===e||"AES-128"===e))}static remuxInitSegment(c,h,p,f){if(!p)return c;let e=c;if(Ye._isCommonEncryptionInternal(p.method)){const m=p.keyId;let u=!1;const g=[];We.findBoxWithOffset(c,0,["moov","trak"]).forEach(t=>{const o=t.data;let l,i=0;const d=We.findBoxWithOffset(o,0,["mdia","minf","stbl","stsd"],[])[0],e=d.data.subarray(8);let r=!0,n=We.findBoxWithOffset(e,d.offset+16,["enca"]);0===n.length&&(r=!1,n=We.findBoxWithOffset(e,d.offset+16,["encv"])),n.forEach(s=>{let e=null,a=null;i=r?(e=s.data.subarray(28),l="audio",d.offset+16+8+28):(e=s.data.subarray(78),l="video",d.offset+16+8+78),e&&We.findBoxWithOffset(e,i,["sinf"]).forEach(e=>{const t=e.data,i=We.findBox(t,["frma"])[0],r=We.findBox(t,["schm"])[0];if(i)if(r){var n=We.bin2str(r.subarray(4,8));if("aac "===We.bin2str(i.subarray(0,4))&&(pe.types||pe.init(),i.set(pe.types.mp4a,0)),"cbcs"===n||"cenc"===n){f&&f.push(t);const e=We.findBox(t,["schi","tenc"])[0];if(e){const h=8;e.subarray(8,24),e.set(m,8);const f=e[6],t=e[7];if(1===f&&0===t){const h=e[24];0<h&&p.iv&&h===p.iv.length&&e.set(p.iv,25)}}}else if("cbc2"===n){u=!0,pe.types||pe.init();const h=We.findBoxWithOffset(t,0,["frma"])[0],f=pe.box(pe.types.schi,pe.tenc(p,l)),m=pe.box(pe.types.sinf,t.subarray(h.offset,h.boxSize),pe.schm(),f);a=pe.box(pe.types.trak,o.subarray(0,e.offset),m,o.subarray(e.offset+e.boxSize));const i=a.subarray(8),r=m.byteLength-e.boxSize;d.walkedPath&&(d.walkedPath.push({type:"stsd",offset:s.offset,size:s.boxSize}),d.walkedPath.forEach(e=>{We.writeUint32(i,e.offset,e.size+r)}))}}else h.error(ze,"missing schm box");else h.error(ze,"missing frma box")}),a=a||c.subarray(t.offset,t.offset+t.boxSize),g.push(a)});var s=We.findBoxWithOffset(o,0,["edts"])[0];s&&(pe.types||pe.init(),o.set(pe.types.free,s.offset+4))}),u&&(e=Ye.remuxCbc2InitSegment(c,g,h)||c)}return e}static remuxCbc2InitSegment(i,r,n){const s=We.findBoxWithOffset(i,0,["ftyp"])[0];if(s){const a=We.findBoxWithOffset(i,s.boxSize,["moov"])[0];let e=[],t=0;for(;t<a.data.byteLength;){const i=We.readUint32(a.data,t),n=We.bin2str(a.data.subarray(t+4,t+8)),s=1<i?t+i:a.data.byteLength;"trak"===n?r&&(e=e.concat(r),r=void 0):e.push(a.data.subarray(t,s)),t=s}const o=pe.box(pe.types.moov,...e),l=new Uint8Array(s.boxSize+o.byteLength);return l.set(i.subarray(0,s.boxSize)),l.set(o,s.boxSize),l}n.error(ze,"no ftyp found")}static remuxOverflowSegment(i,e){pe.types||pe.init();const t=We.findBoxWithOffset(i,0,["moof","traf","tfdt"],[]);let r,n=i.byteLength;if(t.forEach(e=>{0===e.data[0]&&(n+=4)}),n>i.byteLength){r=new Uint8Array(n);let e=0,t=0;for(;t<i.byteLength;){const n=We.readUint32(i,t),s=We.bin2str(i.subarray(t+4,t+8)),a=1<n?t+n:i.byteLength;if("moof"===s){const n=Ye.remuxOverflowMoof(i.subarray(t+8,a));r.set(n,e),e+=n.byteLength}else r.set(i.subarray(t,a),e),e+=n;t=a}}else e.warn(ze,"no increase in size");return r||i}static remuxOverflowMoof(e){let t=0;const i=[];for(;t<e.byteLength;){const r=We.readUint32(e,t);if("traf"===We.bin2str(e.subarray(t+4,t+8))){const s=Ye.remuxOverflowTraf(e.subarray(t+8,t+r));i.push(s)}else i.push(e.subarray(t,t+r));t=1<r?t+r:e.byteLength}const r=pe.box(pe.types.moof,...i),s=r.byteLength-e.byteLength-8;return We.findBoxWithOffset(r,0,["moof","traf","trun"],[]).forEach(e=>{var t;0!=(1&e.data[3])&&(t=We.readUint32(e.data,8),We.writeUint32(e.data,8,t+s))}),We.findBoxWithOffset(r,0,["moof","traf","saio"],[]).forEach(t=>{const i=1&t.data[0];let r=4;1&t.data[3]&&(r+=8);var n=We.readUint32(t.data,r);if(r+=4,i)for(let e=0;e<n;e++){const i=We.readUint64(t.data,r);We.writeUint64(t.data,r,i+s),r+=8}else for(let e=0;e<n;e++){const i=We.readUint32(t.data,r);We.writeUint32(t.data,r,i+s),r+=4}}),r}static remuxOverflowTraf(e){let t=0;const i=[];for(;t<e.byteLength;){var r,n=We.readUint32(e,t);"tfdt"===We.bin2str(e.subarray(t+4,t+8))&&0===e[t+8]?(r=We.readUint32(e,t+12),r=pe.box(pe.types.tfdt,new Uint8Array([1,0,0,0,0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r])),i.push(r)):i.push(e.subarray(t,t+n)),t=1<n?t+n:e.byteLength}return pe.box(pe.types.traf,...i)}remuxText(e,t){e.captionSamples.sort(function(e,t){return e.pts-t.pts}),e.captionSamples.length&&(t.captionData||(t.captionData={}),t.captionData.mp4=e.captionSamples),e.captionSamples=[]}remuxIFrame(e,t,i,r,n){if(!t.samples||!t.samples.length||!t.samples[0].data)return null;let s;const a=pe.moof(e*t.timescale,t,this.logger),o=new Uint8Array(a.byteLength+t.samples[0].data.byteLength+8);o.set(a),We.writeUint32(o,a.byteLength,t.samples[0].data.byteLength+8),o.set(pe.types.mdat,a.byteLength+4),o.set(t.samples[0].data,a.byteLength+8),t.sequenceNumber++;var l=t.timescale,d=F(e+r,l),l=F(e,l);let u,c;u=i?(s="audiovideo",i.sequenceNumber=t.sequenceNumber,t.sequenceNumber++,c=ve.getSegment(i,i.sequenceNumber,e*i.info.timescale,r),w(c.endTs,d)):(s="video",d);n={data1:o,data2:null==c?void 0:c.silentFragData,startPTS:l,startDTS:l,endPTS:u,endDTS:u,type:s,dropped:0,track:n};this.observer.trigger(I.FRAG_PARSING_DATA,n),this.observer.trigger(I.FRAG_PARSED)}remuxEmsgAndRawData(e,t,i,r,n,s,a,o,l,d){let u;t&&r?u="audiovideo":t?u="audio":r&&(u="video");const c=Math.max(i,e),h={data1:l,track:d,startPTS:F(a,o),startDTS:F(a,o),endPTS:void 0,endDTS:void 0,type:u,dropped:0};return c&&(h.endPTS=F(a+c,o),h.endDTS=F(a+c,o)),n&&n.captionSamples.length&&this.remuxText(n,h),s&&0<s.id3Samples.length&&this.remuxID3(s,h),this.observer.trigger(I.FRAG_PARSING_DATA,h),this.observer.trigger(I.FRAG_PARSED),h}remuxID3(t,e){let i;var r=t.id3Samples.length;if(r){for(let e=0;e<r;e++)i=t.id3Samples[e],i.pts=i.pts-10,i.dts=i.dts-10;e.id3Samples=[...t.id3Samples]}t.id3Samples=[]}}const Xe=Math.pow(2,32)-1,Je=Math.pow(2,20)-1,Ze={name:"MP4Demuxer"};class et extends n{constructor(e,t,i,r,n){super(e,t,i,{},n),this.mp4Remuxer=t,this.audioPrimingDelay=i.audioPrimingDelay}resetTimeStamp(e){Z(e)?this.initData.audio&&!this.initData.video?this.initPtsTs={baseTime:Math.round(e*this.initData.audio.timescale/9e4),timescale:this.initData.audio.timescale}:this.initPtsTs={baseTime:e,timescale:9e4}:this.initPtsTs=void 0}static isHEVCFlavor(e){if(!e)return!1;var t=e.indexOf("."),t=t<0?e:e.substring(0,t);return"hvc1"===t||"hev1"===t||"chvc"===t||"qhvc"===t||"qhev"===t||"muxa"===t||"dvh1"===t||"dvhe"===t||"cdh1"===t||"qdh1"===t||"qdhe"===t}resetInitSegment(t,i,r){if(this._silentAudioTrack=void 0,t&&t.byteLength){var n=Ye.remuxInitSegment(t,this.logger,r),s=this.initData=et.parseInitSegment(n);let e;s.foundLargeTimescale&&this.logger.warn(Ze,"large timescale found, will check for 32 bit tfdts");var a=s.audioCodec,r=s.videoCodec;if(s.audio&&s.video?e={type:"audiovideo",container:"video/mp4",codec:a+","+r,initSegment:n}:(s.audio&&a&&(e={type:"audio",container:"audio/mp4",codec:a,initSegment:n}),s.video&&r&&(e={type:"video",container:"video/mp4",codec:r,initSegment:n})),s.video){const o=s.video,l=t.subarray(o.trakOffset,o.trakOffset+o.trakSize);this._videoTrack=Object.assign(Object.assign({},o),{info:{id:o.id,timescale:o.timescale,duration:i},trakData:l,sequenceNumber:0,samples:[]}),this.trySEICaptions=!ye.isVP09(r),this._captionTrack=Object.assign(Object.assign({},s.caption),{sequenceNumber:0,captionSamples:[]})}s.audio&&a&&(this._audioTrack=Object.assign({},s.audio)),s.caption&&(this.trySEICaptions=!1,this._captionTrack=Object.assign(Object.assign({},s.caption),{sequenceNumber:0,captionSamples:[]})),this.remuxedInitDataTrack=e;s={track:e};this.observer.trigger(I.FRAG_PARSING_INIT_SEGMENT,s)}}static probe(e,t){return 0<We.findBox(e.subarray(0,Math.min(e.length,512e3)),["moof"]).length}static probeInitSegment(e){return 0<We.findBox(e.subarray(0,Math.min(e.length,512e3)),["moov","trak"]).length}static parseHvcC(e){let t;var i,r;return e?1===(i=e[0])?(r=e[1],t={profileSpace:r>>6,tierFlag:(32&r)>>5?"H":"L",profileIDC:31&r,profileCompat:We.readUint32(e,2),constraintIndicator:e.subarray(6,12),levelIDC:e[12]}):Ge().warn(Ze,`Unhandled version ${i} in hvcC box`):Ge().warn(Ze,"No hvcC box"),t}static hvcCToCodecString(t,i){const r=t+"."+(i.profileSpace?String.fromCharCode(i.profileSpace+"A"-1):"")+i.profileIDC+"."+i.profileCompat.toString(16).toUpperCase()+"."+i.tierFlag+i.levelIDC;let n="";for(let e=i.constraintIndicator.length-1;0<=e;--e){const r=i.constraintIndicator[e];if(0!==r||""!==n){const t=r.toString(16).toUpperCase();n="."+(""===n?t:t+n)}}return r+n}static parseDvcC(e){let t;return e?t={versionMajor:e[0],versionMinor:e[1],profile:e[2]>>1&127,level:e[2]<<5&32|e[3]>>3&31}:Ge().warn(Ze,"No dvcC box"),t}static dvcCToCodecString(e,t){return e+"."+et.checkAndAddLeadingZero(t.profile)+"."+et.checkAndAddLeadingZero(t.level)}static parseVpcC(e){let t;return e?t={profile:e[4],level:e[5],bitDepth:e[6]>>4&15}:Ge().warn(Ze,"No vpcC box"),t}static vpcCToCodecString(e,t){return e+"."+et.checkAndAddLeadingZero(t.profile)+"."+et.checkAndAddLeadingZero(t.level)+"."+et.checkAndAddLeadingZero(t.bitDepth)}static checkAndAddLeadingZero(e){return(e<10?"0":"")+e}static parseInitSegment(e){const c={foundLargeTimescale:!1,tracksById:{}};return We.findBoxWithOffset(e,0,["moov","trak"]).forEach(t=>{const i=t.data,r=We.findBox(i,["tkhd"])[0];if(r){var n=0===(a=r[0])?12:20,s=We.readUint32(r,n),e=We.findBox(i,["mdia","mdhd"])[0];if(e){var a,o=0===(a=e[0])?12:20,n=We.readUint32(e,o);o+=4,1e6<=n&&(c.foundLargeTimescale=!0);const l=0===a?We.readUint32(e,o):0,d=We.findBox(i,["mdia","hdlr"])[0];if(d){const r=We.bin2str(d.subarray(8,12)),u={soun:"audio",vide:"video",clcp:"caption"}[r]||r;if(u){const r=We.findBox(i,["mdia","minf","stbl","stsd"]);if(r.length){const i=r[0];We.bin2str(i.subarray(12,16));o=et.parseStsd(i);let e;if("caption"===u){const t=Object.assign({id:s,type:u,timescale:n,duration:l,isTimingTrack:!1,sequenceNumber:0,captionSamples:[]},o);c.caption=t,e=t}else{const i=Object.assign({id:s,type:u,timescale:n,duration:l,isTimingTrack:!0,trakOffset:t.offset,trakSize:t.boxSize,sequenceNumber:0,samples:[],fragmentDuration:0},o);"video"===u?(c.video=i,c.videoCodec=i.codec):(c.audio=i,c.audioCodec=i.codec),e=i}c.tracksById[s]=e}}}}}}),We.findBoxWithOffset(e,0,["moov","mvex","trex"]).forEach(e=>{var t=e.data,e=We.readUint32(t,4),t=We.readUint32(t,16);c.tracksById[e].defaultSampleSize=t}),c}static parseStsd(e){let r,t;const i=e.subarray(8);let n=We.bin2str(i.subarray(4,8)),s=null,a=null;"enca"===n?(s=We.findBox(i,["enca"])[0],a=s.subarray(28)):"encv"===n&&(s=We.findBox(i,["encv"])[0],a=s.subarray(78));e=!!a;let o;r=0,a&&We.findBox(a,["sinf"]).forEach(e=>{const t=We.findBox(e,["schm"])[0];if(t){var i=We.bin2str(t.subarray(4,8));if("cbcs"===i||"cenc"===i){const t=We.findBox(e,["frma"])[0];t&&(n=We.bin2str(t));e=We.findBox(e,["schi","tenc"])[0];e&&(r=e[7])}}});var l=i.subarray(86);switch(n){case"mp4a":t="mp4a.40.5";break;case"ac-3":case"ec-3":case"alac":case"fLaC":t=n;break;case"avc1":case"avc3":t=n+".640028";break;case"hvc1":case"hev1":const d=We.findBox(l,["hvcC"])[0];o=et.parseHvcC(d),t=o?et.hvcCToCodecString(n,o):n+".2.4.H150.B0";break;case"dvh1":case"dvhe":const r=We.findBox(l,["dvcC"])[0];o=et.parseDvcC(r),t=o?et.dvcCToCodecString(n,o):n+".05.01";break;case"c608":t=n;break;case"vp09":const i=We.findBox(l,["vpcC"])[0];o=et.parseVpcC(i),t=et.vpcCToCodecString(n,o);break;default:t=n}return{codec:t,encrypted:e,defaultPerSampleIVSize:r}}static has32BitTfdts(e){const t=We.findBox(e,["moof","traf","tfdt"]);let i=!1;return t.forEach(e=>{0===e[0]&&(i=!0)}),i}static getStartDtsTs(r,e){const t=We.findBox(e,["moof","traf"]);let n,s=Number.MAX_SAFE_INTEGER;return t.map(function(i){return We.findBox(i,["tfhd"]).forEach(e=>{var t=We.readUint32(e,4),e=r.tracksById[t];if(e){if(!e.isTimingTrack)return 1/0;t=e.timescale||9e4,e=We.findBox(i,["tfdt"]).map(function(e){let t;var i=e[0];return t=We.readUint32(e,4),1===i&&(t>Je&&Ge().warn(Ze,`Value larger than can be represented by float for upper 32 bits ${t}`),t*=Math.pow(2,32),t+=We.readUint32(e,8)),t}),e=0<e.length?e[0]:1/0;isFinite(e)&&e/t<s&&(s=e/t,n={baseTime:e,timescale:t})}})}),n}static offsetStartDTS(r,e,l,n){We.findBox(e,["moof","traf"]).map(function(i){return We.findBox(i,["tfhd"]).map(function(e){const t=We.readUint32(e,4),s=r.tracksById[t];if(s){const a=s.timescale||9e4,o="caption"===s.type?0:n;We.findBox(i,["tfdt"]).map(function(t){const i=t[0],r=s.type;if(0===i){let e=We.readUint32(t,4)-Math.round(l.baseTime*a/l.timescale);"video"===r&&e<0&&(Ge().warn(Ze,`video tdft would have gone negative by ${e/a} seconds`),e=0),e+=Math.round(o*a),e=Math.max(e,0),We.writeUint32(t,4,e)}else{const i=We.readUint32(t,4);i>Je&&Ge().error(Ze,`baseMediaDecodeTime larger than can be represented by float for upper 32 bits ${i}`);let e=i;e*=Math.pow(2,32),e+=We.readUint32(t,8),e-=Math.round(l.baseTime*a/l.timescale),"video"===r&&e<0&&(Ge().warn(Ze,`video tdft would have gone negative by ${e/a} seconds`),e=0),e+=Math.round(o*a),e=Math.max(e,0);const n=Math.floor(e/(1+Xe)),s=Math.floor(e%(1+Xe));We.writeUint32(t,4,n),We.writeUint32(t,8,s)}})}})})}static writeStartDTS(i,e,s){We.findBox(e,["moof","traf"]).map(function(t){return We.findBox(t,["tfhd"]).map(function(e){e=We.readUint32(e,4),e=i.tracksById[e];if(e){const r=e.timescale||9e4,n=Math.round(s*r)/r;.01<Math.abs(n-s)&&Ge().warn(Ze,`[iframes] large rounding error when adjusting timestamps, startDTS: ${s}, roundedStartDTS: ${n}`),We.findBox(t,["tfdt"]).map(function(e){var t,i;0===e[0]?We.writeUint32(e,4,n*r):(i=n*r,i=Math.max(i,0),t=Math.floor(i/(1+Xe)),i=Math.floor(i%(1+Xe)),We.writeUint32(e,4,t),We.writeUint32(e,8,i))})}})})}static parseSAIO(e){let t=0,i=0;var r=e[0];i+=4,0!=(1&We.readUint32(e,0))&&(i+=8);var n=16777215&We.readUint32(e,i);return 1==n?(i+=4,t=We.readUint32(e,i),1===r&&(i+=4,t*=Math.pow(2,32),t+=We.readUint32(e,i))):Ge().error(Ze,`saio entry count error, count is: ${n}`),t}static parseSAIZ(e){let t=0,i=0;return i+=4,0!=(1&We.readUint32(e,0))&&(i+=8),t=e[i],i++,i+=4,0===t&&(t=e[i]),t}static parseSubsample(e,t){const i={subsamples:[]};let r=0;for(e&&(i.iv=t.subarray(0,e),r+=e),r+=2;r+6<=t.byteLength;){const e=We.readUint16(t,r);r+=2;var n=We.readUint32(t,r);r+=4,i.subsamples.push([e,n])}return i}static isSEIMessage(e,t){return e?39===t||40===t:6===t}static parseCLCPSample(e,t,i){let r=0;const n=[];let s=0;for(;r<i;){var a=t+r,o=We.readUint32(e,a);a+=4;var l=We.bin2str(e.subarray(a,a+4));if(a+=4,"cdat"!==l)break;{const t=o-8,d=e.subarray(a,a+t);s+=t,n.push(d),r+=o}}return{cdatList:n,cdatTotalSize:s}}static parseSamples(e,S,b,T,I,E){const w=b.timescale,c=b.id;let O,A=e,R=0,k=!1;const h=Ge();We.findBoxWithOffset(S,0,["moof"]).map(function(e){const t=e.data,u=e.offset;We.findBox(t,["traf"]).map(function(d){var e=We.findBox(d,["tfdt"]).map(function(e){let t;var i=e[0];return t=We.readUint32(e,4),1===i&&(t*=Math.pow(2,32),t+=We.readUint32(e,8)),t/w})[0];return void 0!==e&&(A=e),We.findBox(d,["tfhd"]).map(function(e){var t=We.readUint32(e,4),i=16777215&We.readUint32(e,0),r=0!=(1&i);let g=0;var n=0!=(2&i),s=0!=(8&i);let y=0;var a=0!=(16&i);let v=0;var o=0!=(32&i),i=!r&&0!=(131072&i);let l=8;if(Z(b.defaultSampleSize)&&(v=b.defaultSampleSize),t===c){if(r?(g=We.readUint32(e,l),l+=4,g>Je&&h.warn(Ze,`base data offset larger than can be represented by float for upper 32 bits ${g}`),g*=Math.pow(2,32),g+=We.readUint32(e,l),l+=4):i&&(g=u),n&&(We.readUint32(e,l),l+=4),s&&(y=We.readUint32(e,l),l+=4),a&&(v=We.readUint32(e,l),l+=4),o&&(We.readUint32(e,l),l+=4),"video"===b.type){let t=0,i=0;We.findBox(d,["saio"]).map(function(e){t=et.parseSAIO(e)}),We.findBox(d,["saiz"]).map(function(e){i=et.parseSAIZ(e)}),t&&i&&(O=et.parseSubsample(b.defaultPerSampleIVSize,S.subarray(g+t,g+t+i))),k=et.isHEVCFlavor(b.codec)}We.findBox(d,["trun"]).map(function(i){var t=i[0],e=16777215&We.readUint32(i,0),r=0!=(1&e);let n=0;var s=0!=(4&e),a=0!=(256&e);let o=0;var l=0!=(512&e);let d=0;var u=0!=(1024&e),c=0!=(2048&e);let h=0;var p=We.readUint32(i,4);let f=8;r&&(n=We.readSint32(i,f),f+=4),s&&(f+=4);let m=n+g;for(let e=0;e<p&&(E<0||R<E);e++){if(a?(o=We.readUint32(i,f),f+=4):o=y,l?(d=We.readUint32(i,f),f+=4):d=v,u&&(f+=4),c&&(h=0===t?We.readUint32(i,f):We.readSint32(i,f),f+=4),"video"===b.type){if(Z(T))b.samples.push({data:S.subarray(m,m+d),size:d,duration:T*w,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:2,isNonSync:0,paddingValue:0},subsamples:O?O.subsamples:[],iv:O?O.iv:void 0});else if(b.fragmentDuration+=o,I){let e=0;for(;e<d;){const T=We.readUint32(S,m);m+=4;const I=31&S[m];if(b.seiSamples||(b.seiSamples=[]),et.isSEIMessage(k,I)){const i=S.subarray(m,m+T);b.seiSamples.push({pts:A+h/w,type:I,data:i,sampleOffset:m,naluSize:T})}m+=T,e+=T+4}}}else if("audio"===b.type)b.fragmentDuration+=o;else if("caption"===b.type){const{cdatList:i,cdatTotalSize:T}=et.parseCLCPSample(S,m,d);if(m+=d,i.length){let t;if(1===i.length)t=new Uint8Array(i[0]);else if(1<i.length){let e=0;t=new Uint8Array(T);for(const T of i)t.set(T,e),e+=T.length}b.captionSamples.push({type:3,pts:A,bytes:t})}}R++,A+=o/w}})}})})})}static parseEmsg(e){let t,i,r,n,s,a="",o="",l=0;if(0===e[0]){for(;"\0"!==We.bin2str(e.subarray(l,l+1));)a+=We.bin2str(e.subarray(l,l+1)),l+=1;for(a+=We.bin2str(e.subarray(l,l+1)),l+=1;"\0"!==We.bin2str(e.subarray(l,l+1));)o+=We.bin2str(e.subarray(l,l+1)),l+=1;o+=We.bin2str(e.subarray(l,l+1)),l+=1,t=We.readUint32(e,12),i=We.readUint32(e,16),n=We.readUint32(e,20),s=We.readUint32(e,24),l=28}else{l+=4,t=We.readUint32(e,l),l+=4;const i=We.readUint32(e,l);l+=4;var d=We.readUint32(e,l);for(l+=4,r=Math.pow(2,32)*i+d,Number.isSafeInteger(r)||(r=Number.MAX_SAFE_INTEGER,Ge().warn(Ze,"Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),n=We.readUint32(e,l),l+=4,s=We.readUint32(e,l),l+=4;"\0"!==We.bin2str(e.subarray(l,l+1));)a+=We.bin2str(e.subarray(l,l+1)),l+=1;for(a+=We.bin2str(e.subarray(l,l+1)),l+=1;"\0"!==We.bin2str(e.subarray(l,l+1));)o+=We.bin2str(e.subarray(l,l+1)),l+=1;o+=We.bin2str(e.subarray(l,l+1)),l+=1}return{schemeIdUri:a,value:o,timeScale:t,presentationTime:r,presentationTimeDelta:i,eventDuration:n,id:s,payload:e.subarray(l,e.byteLength)}}static extractID3PayloadCreateID3Track(e,t,i,r){const n=new O(e.payload,r),s=new Uint8Array(e.payload),a=s.byteLength;let o=0,l=0;var d=Z(e.presentationTime)?e.presentationTime/e.timeScale:t+e.presentationTimeDelta/e.timeScale;if(Z(d)){const c=e.eventDuration,h=s.subarray(0,10),p=We.bin2str(h.subarray(l,l+3));l+=3,"ID3"!==p&&Ge().error(Ze,"No ID3 tag found when extracting ID3 payload"),l+=2;var t=s.subarray(l,l+1),e=64&t[0],u=16&t[0];if(l+=1,O.readSynchSafeUint32(s.subarray(l,l+4)),l+=4,e){const f=O.readSynchSafeUint32(s.subarray(l,l+4));l+=4,l+=f}for(;l+2<a;){We.bin2str(s.subarray(l,l+4)),l+=4;const m=O.readSynchSafeUint32(s.subarray(l,l+4));l+=4;const r=d+o*c,a={data:s,pts:r,dts:r,keyTagInfo:void 0,frames:n.frames};i.id3Samples.push(a),l+=m,o++,u&&("DI3"!==We.bin2str(s.subarray(l,l+3))&&Ge().error(Ze,"End should be DI3 if footer present in extracting ID3 payload"),l+=3,l+=7)}l+2===a&&0!==We.readUint16(s,l)&&Ge().warn(Ze,"Padding should be 0 when extracting ID3 payload")}else Ge().error(Ze,"No pts found in emsg info when extracting ID3 payload")}append(e,t,i,r,n,s,a){let o=this.initData,l=0,d=0,u=!1,c=!1;void 0===o&&(this.resetInitSegment(e,0),o=this.initData);let h,p=this.initPtsTs;p||(h=et.getStartDtsTs(o,e),this.initPtsTs=p={baseTime:h.baseTime-Math.round(t*h.timescale),timescale:h.timescale},this.observer.trigger(I.INIT_PTS_FOUND,{initPTS:p})),o.foundLargeTimescale&&et.has32BitTfdts(e)&&!a&&(e=Ye.remuxOverflowSegment(e,this.logger)),h=et.getStartDtsTs(o,e);const f=We.findBox(e,["emsg"]);if(o.video&&o.video.encrypted&&(We.findBox(e,["moof","traf"]).find(function(e){return Boolean(We.findBox(e,["senc"])[0]||We.findBox(e,["saiz"])[0]&&We.findBox(e,["saio"])[0])})||this.logger.warn(Ze,`Missing subsample information for encrypted content codec=${o.videoCodec}`)),a){const t=this._videoTrack.timescale;a=Math.ceil(a*t)/t;const i=(h.baseTime+this.audioPrimingDelay*h.timescale)/h.timescale;if(this._videoTrack&&this._audioTrack&&!this._silentAudioTrack){const e=ve.getTrack(this.observer,this._audioTrack.id,this._audioTrack.codec,2,this.logger);if(!e)throw`unable to create silent audio track for codec ${this._audioTrack.codec}`;this._silentAudioTrack=Object.assign(Object.assign({},e),{sequenceNumber:0});const t=pe.initSegment([this._videoTrack,this._silentAudioTrack]);this.remuxedInitDataTrack={type:"audiovideo",container:"video/mp4",codec:this._silentAudioTrack.config.codec+","+this._videoTrack.codec,initSegment:t};const i={track:this.remuxedInitDataTrack};this.observer.trigger(I.FRAG_PARSING_INIT_SEGMENT,i)}et.parseSamples(i,e,this._videoTrack,a,!1,1),this.mp4Remuxer.remuxIFrame(i,this._videoTrack,this._silentAudioTrack,a,this.remuxedInitDataTrack),this._videoTrack.samples=[]}else{a=(h.baseTime-this.audioPrimingDelay*h.timescale)/h.timescale,a=Math.max(0,a);if(f&&0<f.length){const e=f.map(e=>{e=et.parseEmsg(e);return"https://aomedia.org/emsg/ID3\0"!==e.schemeIdUri||this._id3Track||(this._id3Track={id3Samples:[],inputTimescale:9e4}),e});this._id3Track&&e.map(e=>{et.extractID3PayloadCreateID3Track(e,t,this._id3Track,this.logger)})}this._videoTrack&&(et.parseSamples(a,e,this._videoTrack,void 0,this.trySEICaptions,-1),l=this._videoTrack.fragmentDuration/this._videoTrack.timescale,u=!0,this._videoTrack.fragmentDuration=0,this.trySEICaptions?(et.extractSEICaptionsFromNALu(this._videoTrack.seiSamples,this._captionTrack),this._videoTrack.seiSamples=[]):this._captionTrack&&et.parseSamples(a,e,this._captionTrack,void 0,!1,Number.MAX_SAFE_INTEGER)),this._audioTrack&&(et.parseSamples(a,e,this._audioTrack,void 0,!1,-1),d=this._audioTrack.fragmentDuration/this._audioTrack.timescale,c=!0,this._audioTrack.fragmentDuration=0),this.mp4Remuxer.remuxEmsgAndRawData(d,c,l,u,this._captionTrack,this._id3Track,a,h.timescale,e,this.remuxedInitDataTrack),this._id3Track&&(this._id3Track.id3Samples=[])}}static extractSEICaptionsFromNALu(a,o){if(a){for(let s=0;s<a.length;++s){var l=a[s],d=l.pts;let t=0;t++;let e=0,i=0,r=!1,n=0;for(;!r&&t<l.data.length;){for(e=0;!(t>=l.data.length)&&(n=l.data[t++],e+=n,255===n););for(i=0;!(t>=l.data.length)&&(n=l.data[t++],i+=n,255===n););const a=l.data.length-t;if(4===e&&t<l.data.length){if(r=!0,181===l.data[t++]){const a=We.readUint16(l.data,t);if(t+=2,49===a){const a=We.readUint32(l.data,t);if(t+=4,1195456820===a&&3===l.data[t++]){const a=l.data[t++];t++;const u=31&a,c=[];if(64&a)for(let e=0;e<u;e++){const a=l.data[t++];if(a===(252&a)){const o=3&a;if(0==o||1==o){const a=l.data[t++],o=l.data[t++];c.push(a),c.push(o)}}else t+=2}0<c.length&&o.captionSamples.push({type:3,pts:d,bytes:c})}}}}else if(i<a)t+=i;else if(i>a)break}}return o}}}const tt={name:"ExpGolomb"};class it{constructor(e,t){this.data=e,this.logger=t,this._bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}get bytesAvailable(){return this._bytesAvailable}loadWord(){const e=this.data,t=this._bytesAvailable,i=e.byteLength-t,r=new Uint8Array(4),n=Math.min(4,t);if(0===n)throw new Error("no bytes available");r.set(e.subarray(i,i+n)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=8*n,this._bytesAvailable-=n}skipBits(e){var t;this.bitsAvailable>e||(t=(e-=this.bitsAvailable)>>3,e-=t>>3,this._bytesAvailable-=t,this.loadWord()),this.word<<=e,this.bitsAvailable-=e}readBits(e){let t=Math.min(this.bitsAvailable,e);var i=this.word>>>32-t;return 32<e&&this.logger.error(tt,"Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,0<this.bitsAvailable?this.word<<=t:0<this._bytesAvailable&&this.loadWord(),t=e-t,0<t&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(0!=(this.word&2147483648>>>e))return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){var e=this.skipLZ();return this.readBits(e+1)-1}readEG(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){let t,i,r=8,n=8;for(t=0;t<e;t++)0!==n&&(i=this.readEG(),n=(r+i+256)%256),r=0===n?r:n}readSPS(){let e,t,i,r=0,n=0,s=0,a=0;const o=this.readUByte.bind(this),l=this.readBits.bind(this),d=this.readUEG.bind(this),u=this.readBoolean.bind(this),c=this.skipBits.bind(this),h=this.skipEG.bind(this),p=this.skipUEG.bind(this),f=this.skipScalingList.bind(this);o();var m=o();if(l(5),c(3),o(),p(),100===m||110===m||122===m||244===m||44===m||83===m||86===m||118===m||128===m){const e=d();if(3===e&&c(1),p(),p(),c(1),u())for(t=3!==e?8:12,i=0;i<t;i++)u()&&f(i<6?16:64)}p();var g=d();if(0===g)d();else if(1===g)for(c(1),h(),h(),e=d(),i=0;i<e;i++)h();p(),c(1);var y=d(),m=d(),g=l(1);0===g&&c(1),c(1),u()&&(r=d(),n=d(),s=d(),a=d());let v=[1,1];if(u()&&u())switch(o()){case 1:v=[1,1];break;case 2:v=[12,11];break;case 3:v=[10,11];break;case 4:v=[16,11];break;case 5:v=[40,33];break;case 6:v=[24,11];break;case 7:v=[20,11];break;case 8:v=[32,11];break;case 9:v=[80,33];break;case 10:v=[18,11];break;case 11:v=[15,11];break;case 12:v=[64,33];break;case 13:v=[160,99];break;case 14:v=[4,3];break;case 15:v=[3,2];break;case 16:v=[2,1];break;case 255:v=[o()<<8|o(),o()<<8|o()]}return{width:Math.ceil(16*(y+1)-2*r-2*n),height:(2-g)*(m+1)*16-(g?2:4)*(s+a),pixelRatio:v}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}const rt={name:"TS Demuxer"};class nt extends s{constructor(e,t,i,r,n){super(e,t,i,r,n)}static probe(e,t){return 376<=e.length&&71===e[0]&&71===e[188]}resetInitSegment(e,t,i){this.pmtParsed=!1;var r={id:this._pmtId=-1,inputTimescale:9e4,timescale:NaN,duration:0,encrypted:i&&i.isEncrypted,keyTagInfo:i},i={len:0,sequenceNumber:0};this._avcContext={info:Object.assign({},r),parsingData:Object.assign(Object.assign({},i),{esSamples:new Array,dropped:0}),config:{},container:"video/mp2t",type:"video"},this._audioContext={info:Object.assign({},r),parsingData:Object.assign(Object.assign({},i),{esSamples:new Array}),container:"video/mp2t",type:"audio"},this._id3Track={id:-1,inputTimescale:9e4,id3Samples:[]},this._txtTrack={inputTimescale:9e4,captionSamples:[]},this._duration=t,nt.probe(e,this.logger)?this._initSegment=e:e.length&&(this.logger.warn(`initSegment data passed to TS demuxer is not MPEG-2 TS. length: ${e.length}`),this._initSegment=void 0)}append(e,t,i,r,n,s,a){this.contiguous=i,this.iframeMode=void 0!==a;var o=this._initSegment;o&&(this.parseTransportStream(o,n),this._initSegment=void 0),this.parseTransportStream(e,n),this.remuxResult(t,i,r,n,s,a)}parseTransportStream(e,t){const i=this._avcContext,r=this._audioContext,n=this._id3Track;let s,a,o,l,d,u=this.pmtParsed,c=i.info.id,h=r.info.id,p=n.id,f=this._pmtId,m=i.pesData,g=r.pesData,y=n.pesData,v=!1,S=e.length;for(S-=S%188,s=0;s<S;s+=188){if(71!==e[s]){const e=new b(!1,"TS packet did not start with 0x47",K.NoTSSyncByteFound);return void this.observer.trigger(D.INTERNAL_ERROR,e)}if(a=!!(64&e[s+1]),o=((31&e[s+1])<<8)+e[s+2],1<(48&e[s+3])>>4){if(l=s+5+e[s+4],l===s+188)continue}else l=s+4;switch(o){case c:a&&(m&&(d=this._parsePES(m))&&this._parseAVCPES(d,!1),m={data:[],size:0,keyTagInfo:t}),m&&(m.data.push(e.subarray(l,s+188)),m.size+=s+188-l);break;case h:if(a&&!this.iframeMode){if(g&&(d=this._parsePES(g)))switch(r.segmentCodec){case"aac":this._parseAACPES(d);break;case"mp3":this._parseMPEGPES(d);break;case"ac3":case"ec3":this._parseDolbyPES(d)}g={data:[],size:0,keyTagInfo:t}}g&&(g.data.push(e.subarray(l,s+188)),g.size+=s+188-l);break;case p:a&&(y&&(d=this._parsePES(y))&&n.id3Samples.push(d),y={data:[],size:0}),y&&(y.data.push(e.subarray(l,s+188)),y.size+=s+188-l);break;case 0:a&&(l+=e[l]+1),f=this._pmtId=this._parsePAT(e,l);break;case f:a&&(l+=e[l]+1);const o=this._parsePMT(e,l,this.typeSupported);c=o.avcId,0<c&&(i.info.id=c,i.info.encrypted=o.videoEncrypted),h=o.audioId,0<h&&(r.info.id=h,r.segmentCodec=o.audioSegmentCodec,r.info.encrypted=o.audioEncrypted),p=o.id3Id,0<p&&(n.id=p),v&&!u&&(v=!1,s=-188),u=this.pmtParsed=!0;break;case 17:case 8191:break;default:v=!0}}if(m&&(d=this._parsePES(m))?(this._parseAVCPES(d,!0),i.pesData=void 0):i.pesData=m,g&&(d=this._parsePES(g))){switch(r.segmentCodec){case"aac":this._parseAACPES(d);break;case"mp3":this._parseMPEGPES(d);break;case"ac3":case"ec3":this._parseDolbyPES(d)}r.pesData=void 0}else g&&g.size&&this.logger.warn(rt,"last AAC PES packet truncated,might overlap between fragments"),r.pesData=g;y&&(d=this._parsePES(y))?(n.id3Samples.push(d),n.pesData=void 0):n.pesData=y}remuxResult(e,t,i,r,n,s){var a=this._avcContext,o=this._audioContext,l=this._id3Track;let d,u;o.config&&o.segmentCodec&&(d={type:"audio",info:o.info,config:o.config,parsingData:o.parsingData});var c=a.config;"string"==typeof(o=c).codec&&Array.isArray(o.sps)&&Array.isArray(o.pps)&&"number"==typeof o.width&&"number"==typeof o.height&&Array.isArray(o.pixelRatio)&&(u={type:"video",info:a.info,config:c,parsingData:a.parsingData}),this.esRemuxer.remuxEsTracks(d,u,l,this._txtTrack,e,t,i,r,n,s)}destroy(){this._duration=0}_parsePAT(e,t){return(31&e[t+10])<<8|e[t+11]}_parsePMT(e,t,i){var r;const n={audioId:-1,avcId:-1,id3Id:-1,audioEncrypted:!1,videoEncrypted:!1},s=t+3+((15&e[t+1])<<8|e[t+2])-4;for(t+=12+((15&e[t+10])<<8|e[t+11]);t<s;){switch(r=(31&e[t+1])<<8|e[t+2],e[t]){case 207:n.audioEncrypted=!0;case 15:-1===n.audioId&&(n.audioId=r,n.audioSegmentCodec="aac");break;case 21:-1===n.id3Id&&(n.id3Id=r);break;case 219:n.videoEncrypted=!0;case 27:-1===n.avcId&&(n.avcId=r);break;case 3:case 4:!0!==i.mpeg&&!0!==i.mp3?this.logger.warn(rt,"MPEG audio found, not supported in this browser for now"):-1===n.audioId&&(n.audioId=r,n.audioSegmentCodec="mp3");break;case 193:n.audioEncrypted=!0;case 129:!0!==i.ac3?this.logger.warn(rt,"AC-3 audio found, not supported in this browser for now"):-1===n.audioId&&(n.audioId=r,n.audioSegmentCodec="ac3");break;case 194:n.audioEncrypted=!0;case 135:!0!==i.ec3?this.logger.warn(rt,"EC-3 audio found, not supported in this browser for now"):-1===n.audioId&&(n.audioId=r,n.audioSegmentCodec="ec3");break;case 36:this.logger.warn(rt,"HEVC stream type found, not supported for now")}t+=5+((15&e[t+3])<<8|e[t+4])}return n}_parsePES(e){let i,t,r,n,s,a,o=0;const l=e.data,d=e.keyTagInfo;let u=NaN,c=NaN;if(e&&0!==e.size){for(;l[0].length<19&&1<l.length;){const e=new Uint8Array(l[0].length+l[1].length);e.set(l[0]),e.set(l[1],l[0].length),l[0]=e,l.splice(1,1)}if(i=l[0],1===(i[0]<<16)+(i[1]<<8)+i[2]&&(r=(i[4]<<8)+i[5],!(r&&r>e.size-6))){192&(t=i[7])&&(u=536870912*(14&i[9])+4194304*(255&i[10])+16384*(254&i[11])+128*(255&i[12])+(254&i[13])/2,64&t?(c=536870912*(14&i[14])+4194304*(255&i[15])+16384*(254&i[16])+128*(255&i[17])+(254&i[18])/2,54e5<u-c&&(this.logger.warn(rt,`${Math.round((u-c)/9e4)}s delta between PTS and DTS, align them`),u=c)):c=u),n=i[8],a=n+9,e.size-=a,s=new Uint8Array(e.size);for(let t=0,e=l.length;t<e;t++){i=l[t];let e=i.byteLength;if(a){if(a>e){a-=e;continue}i=i.subarray(a),e-=a,a=0}s.set(i,o),o+=e}return r&&(r-=n+3),{data:s,pts:u,dts:c,len:r,keyTagInfo:d}}}}pushAccesUnit(e,t){const i=e.avcSample;if(i&&i.units.length&&i.frame){const r=e.parsingData.esSamples,n=r.length;((!0===i.key||e.config.sps&&(n||this.contiguous))&&(i.id=n,i.keyTagInfo=t,e.info.encrypted)&&i.units.forEach(e=>{if(48<e.data.byteLength)switch(e.type){case 1:case 5:e.data=this.discardEPB(e.data)}}),n||isFinite(i.pts))?r.push(i):e.parsingData.dropped++}}_parseAVCPES(o,e){if(!o.data)throw"invalid pes data";const l=this._avcContext,t=this._parseAVCNALu(o.data);let d,u,c,h=l.avcSample;const p=o.keyTagInfo;o.data=void 0,t.forEach(n=>{switch(n.type){case 1:if(h&&!this.iframeMode){u=!0,h.frame=!0;const o=n.data;if(4<o.length){const n=new it(o,this.logger).readSliceType();2!==n&&4!==n&&7!==n&&9!==n||(h.key=!0)}}break;case 5:u=!0,h&&(h=h||(l.avcSample=this._createAVCSample(!0,o.pts,o.dts,"")),h.key=!0,h.frame=!0);break;case 6:u=!0,d=new it(this.discardEPB(n.data),this.logger),d.readUByte();let e=0,t=0,i=!1,r=0;for(;!i&&1<d.bytesAvailable;){for(e=0;r=d.readUByte(),e+=r,255===r;);for(t=0;r=d.readUByte(),t+=r,255===r;);if(4===e&&0!==d.bytesAvailable){if(i=!0,181===d.readUByte()&&49===d.readUShort()&&1195456820===d.readUInt()&&3===d.readUByte()){const n=d.readUByte(),l=31&n,s=[n,d.readUByte()];for(c=0;c<l;c++)s.push(d.readUByte()),s.push(d.readUByte()),s.push(d.readUByte());this._insertSampleInOrder(this._txtTrack.captionSamples,{type:3,pts:o.pts,bytes:s})}}else if(t<d.bytesAvailable)for(c=0;c<t;c++)d.readUByte()}break;case 7:if(u=!0,!l.config.sps){d=new it(n.data,this.logger);const o=d.readSPS();l.config.width=o.width,l.config.height=o.height,l.config.pixelRatio=o.pixelRatio,l.config.sps=[n.data],l.info.duration=this._duration;const a=n.data.subarray(1,4);let t="avc1.";for(c=0;c<3;c++){let e=a[c].toString(16);e.length<2&&(e="0"+e),t+=e}l.config.codec=t}break;case 8:u=!0,l.config.pps||(l.config.pps=[n.data]);break;case 9:u=!1,h&&this.pushAccesUnit(l,p),h=l.avcSample=this._createAVCSample(!1,o.pts,o.dts,"");break;case 12:u=!0;break;default:u=!1,h&&(h.debug+="unknown NAL "+n.type+" ")}h&&u&&h.units.push(n)}),e&&h&&(this.pushAccesUnit(l,p),l.avcSample=void 0)}_createAVCSample(e,t,i,r){return{id:NaN,key:e,pts:t,dts:i,units:new Array,debug:r}}_insertSampleInOrder(t,i){var r=t.length;if(0<r){if(i.pts>=t[r-1].pts)t.push(i);else for(let e=r-1;0<=e;e--)if(i.pts<t[e].pts){t.splice(e,0,i);break}}else t.push(i)}_getLastNalUnit(){const e=this._avcContext;let t,i=e.avcSample;if(!i||0===i.units.length){const t=e.parsingData.esSamples;i=t[t.length-1]}if(i){const e=i.units;t=e[e.length-1]}return t}_parseAVCNALu(e){const t=e.byteLength;let i,r,n=0;const s=this._avcContext;let a=s.naluState||0;const o=a,l=[];let d,u,c,h=-1;for(-1===a&&(h=0,c=31&e[0],a=0,n=1);n<t;)if(i=e[n++],a)if(1!==a)if(i)if(1===i){if(0<=h)d={data:e.subarray(h,n-a-1),type:c},l.push(d);else{const t=this._getLastNalUnit();if(t&&(o&&n<=4-o&&t.state&&(t.data=t.data.subarray(0,t.data.byteLength-o)),r=n-a-1,0<r)){const i=new Uint8Array(t.data.byteLength+r);i.set(t.data,0),i.set(e.subarray(0,r),t.data.byteLength),t.data=i,t.state=0}}a=n<t?(u=31&e[n],h=n,c=u,0):-1}else a=0;else a=3;else a=i?0:2;else a=i?0:1;if(0<=h&&0<=a&&(d={data:e.subarray(h,t),type:c,state:a},l.push(d)),0===l.length){const t=this._getLastNalUnit();if(t){const i=new Uint8Array(t.data.byteLength+e.byteLength);i.set(t.data,0),i.set(e,t.data.byteLength),t.data=i}}return s.naluState=a,l}discardEPB(e){const t=e.byteLength,i=[];let r=1;for(;r<t-2;)0===e[r]&&0===e[r+1]&&3===e[r+2]?(i.push(r+2),r+=2):r++;if(0===i.length)return e;const n=t-i.length,s=new Uint8Array(n);let a=0;for(r=0;r<n;a++,r++)a===i[0]&&(a++,i.shift()),s[r]=e[a];return s}_parseAACPES(e){const t=this._audioContext,i=t.audioLastPTS,r=e.keyTagInfo;let n,s,a,o,l,d,u,c=e.data,h=e.pts,p=t.audioOverFlow;if(p){const e=new Uint8Array(p.byteLength+c.byteLength);e.set(p,0),e.set(c,p.byteLength),c=e}for(a=0,d=c.length;a<d-1&&(255!==c[a]||240!=(240&c[a+1]));a++);if(a){let e,t,i;i=a<d-1?(e=`AAC PES did not start with ADTS header,offset:${a}`,t=!1,K.PESDidNotStartWithADTS):(e="no ADTS header found in AAC PES",t=!0,K.NoADTSHeaderInPES),this.logger.warn(rt,`parsing error:${e}`);const r=new b(t,e,i);if(this.observer.trigger(D.INTERNAL_ERROR,r),t)return}if(!t.config){const e=v(this.observer,c,a,void 0,this.logger);if(!e)throw"unable to parse adts header";t.config=e}s=0;var f=9216e4/t.config.samplerate;if(p&&i){const e=i+f;1<Math.abs(e-h)&&(h=e)}for(;a+5<d&&(o=1&c[a+1]?7:9,n=(3&c[a+3])<<11|c[a+4]<<3|(224&c[a+5])>>>5,n-=o,0<n&&a+o+n<=d);)for(l=h+s*f,u={unit:c.subarray(a+o,a+o+n),pts:l,dts:l,keyTagInfo:r},t.parsingData.esSamples.push(u),t.parsingData.len+=n,a+=n+o,s++;a<d-1&&(255!==c[a]||240!=(240&c[a+1]));a++);p=a<d?c.subarray(a,d):void 0,t.audioOverFlow=p,t.audioLastPTS=l}_parseMPEGPES(e){"mp3"===this._audioContext.segmentCodec&&z.parse(this._audioContext.parsingData,e.data,0,e.pts,this.logger)}_parseDolbyPES(e){const t=this._audioContext;let i=e.data,r=e.pts;var n=e.keyTagInfo;let s=0,a=0,o=t.audioOverFlow;e=t.audioLastPTS;if(!t.config){let e;if("ac3"===t.segmentCodec?e=C(this.observer,i,a,this.logger):"ec3"===t.segmentCodec&&(e=H(this.observer,i,a,this.logger)),!e)throw"unable to parse dolby header";t.config=e}if("ac3"!==t.config.segmentCodec&&"ec3"!==t.config.segmentCodec)throw"unexpected config type";var l=1536/t.config.samplerate*t.info.inputTimescale;if(o){const c=new Uint8Array(o.byteLength+i.byteLength);c.set(o,0),c.set(i,o.byteLength),i=c}var d=i.length;if(o&&e){const c=e+l;1<Math.abs(c-r)&&(r=c)}let u=0;for(;a+u<=d;){if(11!==i[a]||119!==i[a+1]){const c=new b(!0,"invalid dolby audio magic",K.InvalidDolbyAudioMagic);return void this.observer.trigger(D.INTERNAL_ERROR,c)}"ac3"===t.segmentCodec?u=U(this.observer,i,a):"ec3"===t.segmentCodec&&(u=j(this.observer,i,a,this.logger));const c=r+s*l;t.audioLastPTS=c;const o={unit:i.subarray(a,a+u),pts:c,dts:c,keyTagInfo:n};t.parsingData.esSamples.push(o),t.info.duration=this._duration,t.parsingData.len+=u,a+=u,s++}o=a<d?i.subarray(a,d):void 0,t.audioOverFlow=o}}var st,at=nt;class ot extends r{constructor(e,t,i,r){super(),this.typeSupported=e,this.config=t,this.vendor=i,this.logger=r}destroy(){this.removeAllListeners();const e=this.demuxer,t=this.remuxer;e&&e.destroy(),t&&t.destroy()}push(t,i,r,n,s,a,o,l,d,u,c,h){if(t){let e=this.demuxer;var p=new Uint8Array(t);if(!e||(s||a)&&!this.probeFn(p,this.logger)){const{typeSupported:t,config:i}=this,r=[{demux:et,remux:Ye},{demux:at,remux:be},{demux:G,remux:be},{demux:q,remux:be},{demux:R,remux:be},{demux:X,remux:be}];for(const n of r){const r=n.demux["probe"];if(r(p,this.logger)){this.remuxer=new n.remux(this,i,t,this.vendor,this.logger),e=new n.demux(this,this.remuxer,i,t,this.logger),this.probeFn=r;break}}if(!e){const t=new b(!0,"no demux matching with content found",K.DemuxerNotFound);return void this.trigger(D.INTERNAL_ERROR,t)}this.demuxer=e}const f=this.remuxer,m=!this.lastKeyTagInfo||i&&"NONE"!==i.method&&this.lastKeyTagInfo.uri!==i.uri;if(this.lastKeyTagInfo=i,(s||a||m)&&(e.resetInitSegment(new Uint8Array(r),l,i,s),f.resetInitSegment()),s){const t=u?E(u):void 0;e.resetTimeStamp(t),f.resetTimeStamp(t)}e.append(p,n,o,d,i,c,h)}}}function lt(){let e=`${Date.now()}-${Math.random()}`;return"undefined"!=typeof performance&&"function"==typeof performance.now&&(e+=`-${performance.now()}`),e}class dt{constructor(e,t){this.rpc=e,this.logger=t,this.init=(t,n,s)=>e=>{const i=lt(),r=this.demuxers[i]=new ot(t,n,s,this.logger);[I.INIT_PTS_FOUND,I.FRAG_PARSING_INIT_SEGMENT,I.FRAG_PARSING_DATA,I.FRAG_PARSED,D.INTERNAL_ERROR].forEach(t=>{r.on(t,e=>this.rpc.invoke("demuxer.event",[i,t,e])(()=>{}))}),e(i)},this.push=(i,r,n,s,a,o,l,d,u,c,h,p,f)=>e=>{const t=this.demuxers[i];t?(t.push(r,n,s,a,o,l,d,u,c,h,p,f),e()):e(void 0,`Demuxer with id "${i}" does not exist on push`)},this.destroy=i=>e=>{const t=this.demuxers[i];t?(t.destroy(),delete this.demuxers[i],e()):this.logger.error(`Demuxer with id "${i}" does not exist on destroy`)},this.demuxers={},e.register("demuxer.init",this.init),e.register("demuxer.push",this.push),e.register("demuxer.destroy",this.destroy)}}class ut{constructor(e){this.worker=e,this.handlers={},this.deferers={},this._messageHandler=e=>{var{type:t,id:i,command:r,args:n,result:e,error:s}=e.data;if(t===st.Invoke)try{if(null==this.handlers[r])throw new Error(`command ${r} not found`);this.handlers[r](...n)(this._respond.bind(this,i,r))}catch(s){this._respond(i,r,null,new Error(`command ${r} not found`))}else t===st.Result&&null!=this.deferers[i]&&(this.deferers[i](e,s),delete this.deferers[i])},e.addEventListener("message",this._messageHandler)}register(e,t){if(null!=this.handlers[e])return!1;this.handlers[e]=t}unregister(e){if(null!=this.handlers[e])return!1;delete this.handlers[e]}invoke(i,r,n){return(e=ut._fallbackCallback)=>{var t=lt();this.deferers[t]=e;t={type:st.Invoke,id:t,command:i,args:r};this._send(t,n)}}teardown(e){this.worker.removeEventListener("message",this._messageHandler),e()}_respond(e,t,i,r,n){r instanceof Error&&(r=`[${r.name}] ${r.message}\n${r.stack}`);r={type:st.Result,id:e,command:t,result:i,error:r};this._send(r,n)}_send(e,t=[]){this.worker.postMessage(e,t.map(e=>ArrayBuffer.isView(e)?e.buffer:e).filter(e=>void 0!==e))}}ut._fallbackCallback=(e,t)=>{if(null!=t)throw t},(Sr=st=st||{})[Sr.Invoke=0]="Invoke",Sr[Sr.Result=1]="Result",ArrayBuffer.isView||(ArrayBuffer.isView=function(e){return null!==e&&"object"==typeof e&&e.buffer instanceof ArrayBuffer}),void 0!==d0&&d0&&(Kr=new ut(l),su=(n=>{const t=(i=[])=>{const r={};return["fatal","error","warn","info","debug","trace","qe"].forEach(e=>{return r[e]=(t=e,(...e)=>{n.invoke("logger.log",[i,t,...e])((e,t)=>{if(null!=t)throw t})});var t}),r.child=e=>t([...i,e]),r};return t()})(Kr),new i(Kr,su),new dt(Kr,su));var ct=function(e,t){return(ct=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])})(e,t)};function ht(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}ct(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}var pt=function(){return(pt=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function ft(e,t,i,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;0<=o;o--)(n=e[o])&&(a=(s<3?n(a):3<s?n(t,i,a):n(t,i))||a);return 3<s&&a&&Object.defineProperty(t,i,a),a}function mt(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function gt(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],r=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return{value:(e=e&&r>=e.length?void 0:e)&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function yt(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var r,n,s=i.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(r=s.next()).done;)a.push(r.value)}catch(e){n={error:e}}finally{try{r&&!r.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}return a}function vt(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(yt(arguments[t]));return e}function St(e){return"function"==typeof e}var bt=!1,Tt={Promise:void 0,set useDeprecatedSynchronousErrorHandling(e){bt=e},get useDeprecatedSynchronousErrorHandling(){return bt}};function It(e){setTimeout(function(){throw e},0)}var Et={closed:!0,next:function(e){},error:function(e){if(Tt.useDeprecatedSynchronousErrorHandling)throw e;It(e)},complete:function(){}},wt=Array.isArray||function(e){return e&&"number"==typeof e.length};function Ot(e){return null!==e&&"object"==typeof e}var At=(Ct.prototype=Object.create(Error.prototype),Ct),Rt=(kt.prototype.unsubscribe=function(){var t;if(!this.closed){var e=this._parentOrParents,i=this._ctorUnsubscribe,r=this._unsubscribe,n=this._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,e instanceof kt)e.remove(this);else if(null!==e)for(var s=0;s<e.length;++s)e[s].remove(this);if(St(r)){i&&(this._unsubscribe=void 0);try{r.call(this)}catch(e){t=e instanceof At?Mt(e.errors):[e]}}if(wt(n))for(var s=-1,a=n.length;++s<a;){var o=n[s];if(Ot(o))try{o.unsubscribe()}catch(e){t=t||[],e instanceof At?t=t.concat(Mt(e.errors)):t.push(e)}}if(t)throw new At(t)}},kt.prototype.add=function(e){var t,i=e;if(!e)return kt.EMPTY;switch(typeof e){case"function":i=new kt(e);case"object":if(i===this||i.closed||"function"!=typeof i.unsubscribe)return i;if(this.closed)return i.unsubscribe(),i;i instanceof kt||(t=i,(i=new kt)._subscriptions=[t]);break;default:throw new Error("unrecognized teardown "+e+" added to Subscription.")}var r=i._parentOrParents;if(null===r)i._parentOrParents=this;else if(r instanceof kt){if(r===this)return i;i._parentOrParents=[r,this]}else{if(-1!==r.indexOf(this))return i;r.push(this)}r=this._subscriptions;return null===r?this._subscriptions=[i]:r.push(i),i},kt.prototype.remove=function(e){var t=this._subscriptions;!t||-1!==(e=t.indexOf(e))&&t.splice(e,1)},kt.EMPTY=((pl=new kt).closed=!0,pl),kt);function kt(e){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,e&&(this._ctorUnsubscribe=!0,this._unsubscribe=e)}function Ct(e){return Error.call(this),this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map(function(e,t){return t+1+") "+e.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e,this}function Mt(e){return e.reduce(function(e,t){return e.concat(t instanceof At?t.errors:t)},[])}var Pt,xt,Dt="function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random(),_t=(ht(Bt,xt=Rt),Bt.prototype[Dt]=function(){return this},Bt.create=function(e,t,i){i=new Bt(e,t,i);return i.syncErrorThrowable=!1,i},Bt.prototype.next=function(e){this.isStopped||this._next(e)},Bt.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},Bt.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},Bt.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,xt.prototype.unsubscribe.call(this))},Bt.prototype._next=function(e){this.destination.next(e)},Bt.prototype._error=function(e){this.destination.error(e),this.unsubscribe()},Bt.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},Bt.prototype._unsubscribeAndRecycle=function(){var e=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=e,this},Bt),Lt=(ht(Ft,Pt=_t),Ft.prototype.next=function(e){var t;!this.isStopped&&this._next&&(t=this._parentSubscriber,Tt.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?this.__tryOrSetError(t,this._next,e)&&this.unsubscribe():this.__tryOrUnsub(this._next,e))},Ft.prototype.error=function(e){if(!this.isStopped){var t=this._parentSubscriber,i=Tt.useDeprecatedSynchronousErrorHandling;if(this._error)i&&t.syncErrorThrowable?this.__tryOrSetError(t,this._error,e):this.__tryOrUnsub(this._error,e),this.unsubscribe();else if(t.syncErrorThrowable)i?(t.syncErrorValue=e,t.syncErrorThrown=!0):It(e),this.unsubscribe();else{if(this.unsubscribe(),i)throw e;It(e)}}},Ft.prototype.complete=function(){var e,t,i=this;this.isStopped||(e=this._parentSubscriber,this._complete&&(t=function(){return i._complete.call(i._context)},Tt.useDeprecatedSynchronousErrorHandling&&e.syncErrorThrowable?this.__tryOrSetError(e,t):this.__tryOrUnsub(t)),this.unsubscribe())},Ft.prototype.__tryOrUnsub=function(e,t){try{e.call(this._context,t)}catch(e){if(this.unsubscribe(),Tt.useDeprecatedSynchronousErrorHandling)throw e;It(e)}},Ft.prototype.__tryOrSetError=function(e,t,i){if(!Tt.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{t.call(this._context,i)}catch(t){return Tt.useDeprecatedSynchronousErrorHandling?(e.syncErrorValue=t,e.syncErrorThrown=!0):It(t),!0}return!1},Ft.prototype._unsubscribe=function(){var e=this._parentSubscriber;this._context=null,this._parentSubscriber=null,e.unsubscribe()},Ft),Nt="function"==typeof Symbol&&Symbol.observable||"@@observable";function Ft(e,t,i,r){var n,s=Pt.call(this)||this;s._parentSubscriber=e;e=s;return St(t)?n=t:t&&(n=t.next,i=t.error,r=t.complete,t!==Et&&(St((e=Object.create(t)).unsubscribe)&&s.add(e.unsubscribe.bind(e)),e.unsubscribe=s.unsubscribe.bind(s))),s._context=e,s._next=n,s._error=i,s._complete=r,s}function Bt(e,t,i){var r=xt.call(this)||this;switch(r.syncErrorValue=null,r.syncErrorThrown=!1,r.syncErrorThrowable=!1,r.isStopped=!1,arguments.length){case 0:r.destination=Et;break;case 1:if(!e){r.destination=Et;break}if("object"==typeof e){e instanceof Bt?(r.syncErrorThrowable=e.syncErrorThrowable,(r.destination=e).add(r)):(r.syncErrorThrowable=!0,r.destination=new Lt(r,e));break}default:r.syncErrorThrowable=!0,r.destination=new Lt(r,e,t,i)}return r}function Ut(e){return e}function $t(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Vt(e)}function Vt(t){return 0===t.length?Ut:1===t.length?t[0]:function(e){return t.reduce(function(e,t){return t(e)},e)}}var Kt=(Qt.prototype.lift=function(e){var t=new Qt;return t.source=this,t.operator=e,t},Qt.prototype.subscribe=function(e,t,i){var r=this.operator,i=function(e,t,i){if(e){if(e instanceof _t)return e;if(e[Dt])return e[Dt]()}return e||t||i?new _t(e,t,i):new _t(Et)}(e,t,i);if(r?i.add(r.call(i,this.source)):i.add(this.source||Tt.useDeprecatedSynchronousErrorHandling&&!i.syncErrorThrowable?this._subscribe(i):this._trySubscribe(i)),Tt.useDeprecatedSynchronousErrorHandling&&i.syncErrorThrowable&&(i.syncErrorThrowable=!1,i.syncErrorThrown))throw i.syncErrorValue;return i},Qt.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){Tt.useDeprecatedSynchronousErrorHandling&&(t.syncErrorThrown=!0,t.syncErrorValue=e),function(e){for(;e;){var t=e,i=t.closed,r=t.destination,t=t.isStopped;if(i||t)return;e=r&&r instanceof _t?r:null}return 1}(t)?t.error(e):console.warn(e)}},Qt.prototype.forEach=function(r,e){var n=this;return new(e=qt(e))(function(e,t){var i=n.subscribe(function(e){try{r(e)}catch(e){t(e),i&&i.unsubscribe()}},t,e)})},Qt.prototype._subscribe=function(e){var t=this.source;return t&&t.subscribe(e)},Qt.prototype[Nt]=function(){return this},Qt.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 0===e.length?this:Vt(e)(this)},Qt.prototype.toPromise=function(e){var r=this;return new(e=qt(e))(function(e,t){var i;r.subscribe(function(e){return i=e},function(e){return t(e)},function(){return e(i)})})},Qt.create=function(e){return new Qt(e)},Qt);function Qt(e){this._isScalar=!1,e&&(this._subscribe=e)}function qt(e){if(!(e=e||(Tt.Promise||Promise)))throw new Error("no Promise impl found");return e}var jt,Ht,Gt,Wt,zt=(ni.prototype=Object.create(Error.prototype),ni),Yt=(ht(ri,Wt=Rt),ri.prototype.unsubscribe=function(){var e,t;this.closed||(this.closed=!0,e=(t=this.subject).observers,this.subject=null,!e||0===e.length||t.isStopped||t.closed||-1!==(t=e.indexOf(this.subscriber))&&e.splice(t,1))},ri),Xt=(ht(ii,Gt=_t),ii),Jt=(ht(ti,Ht=Kt),ti.prototype[Dt]=function(){return new Xt(this)},ti.prototype.lift=function(e){var t=new Zt(this,this);return t.operator=e,t},ti.prototype.next=function(e){if(this.closed)throw new zt;if(!this.isStopped)for(var t=this.observers,i=t.length,r=t.slice(),n=0;n<i;n++)r[n].next(e)},ti.prototype.error=function(e){if(this.closed)throw new zt;this.hasError=!0,this.thrownError=e,this.isStopped=!0;for(var t=this.observers,i=t.length,r=t.slice(),n=0;n<i;n++)r[n].error(e);this.observers.length=0},ti.prototype.complete=function(){if(this.closed)throw new zt;this.isStopped=!0;for(var e=this.observers,t=e.length,i=e.slice(),r=0;r<t;r++)i[r].complete();this.observers.length=0},ti.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},ti.prototype._trySubscribe=function(e){if(this.closed)throw new zt;return Ht.prototype._trySubscribe.call(this,e)},ti.prototype._subscribe=function(e){if(this.closed)throw new zt;return this.hasError?(e.error(this.thrownError),Rt.EMPTY):this.isStopped?(e.complete(),Rt.EMPTY):(this.observers.push(e),new Yt(this,e))},ti.prototype.asObservable=function(){var e=new Kt;return e.source=this,e},ti.create=function(e,t){return new Zt(e,t)},ti),Zt=(ht(ei,jt=Jt),ei.prototype.next=function(e){var t=this.destination;t&&t.next&&t.next(e)},ei.prototype.error=function(e){var t=this.destination;t&&t.error&&this.destination.error(e)},ei.prototype.complete=function(){var e=this.destination;e&&e.complete&&this.destination.complete()},ei.prototype._subscribe=function(e){return this.source?this.source.subscribe(e):Rt.EMPTY},ei);function ei(e,t){var i=jt.call(this)||this;return i.destination=e,i.source=t,i}function ti(){var e=Ht.call(this)||this;return e.observers=[],e.closed=!1,e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}function ii(e){var t=Gt.call(this,e)||this;return t.destination=e,t}function ri(e,t){var i=Wt.call(this)||this;return i.subject=e,i.subscriber=t,i.closed=!1,i}function ni(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}function si(){return function(e){return e.lift(new mi(e))}}var ai,oi,li,di,ui,ci,hi,pi,fi,mi=(Li.prototype.call=function(e,t){var i=this.connectable;i._refCount++;e=new gi(e,i),t=t.subscribe(e);return e.closed||(e.connection=i.connect()),t},Li),gi=(ht(_i,fi=_t),_i.prototype._unsubscribe=function(){var e,t=this.connectable;t?(this.connectable=null,(e=t._refCount)<=0?this.connection=null:(t._refCount=e-1,1<e?this.connection=null:(e=this.connection,t=t._connection,this.connection=null,!t||e&&t!==e||t.unsubscribe()))):this.connection=null},_i),p=(ht(Di,pi=Kt),Di.prototype._subscribe=function(e){return this.getSubject().subscribe(e)},Di.prototype.getSubject=function(){var e=this._subject;return e&&!e.isStopped||(this._subject=this.subjectFactory()),this._subject},Di.prototype.connect=function(){var e=this._connection;return e||(this._isComplete=!1,(e=this._connection=new Rt).add(this.source.subscribe(new vi(this.getSubject(),this))),e.closed&&(this._connection=null,e=Rt.EMPTY)),e},Di.prototype.refCount=function(){return si()(this)},Di),yi={operator:{value:null},_refCount:{value:0,writable:!0},_subject:{value:null,writable:!0},_connection:{value:null,writable:!0},_subscribe:{value:(fl=p.prototype)._subscribe},_isComplete:{value:fl._isComplete,writable:!0},getSubject:{value:fl.getSubject},connect:{value:fl.connect},refCount:{value:fl.refCount}},vi=(ht(xi,hi=Xt),xi.prototype._error=function(e){this._unsubscribe(),hi.prototype._error.call(this,e)},xi.prototype._complete=function(){this.connectable._isComplete=!0,this._unsubscribe(),hi.prototype._complete.call(this)},xi.prototype._unsubscribe=function(){var e,t=this.connectable;t&&(this.connectable=null,e=t._connection,t._refCount=0,t._subject=null,t._connection=null,e&&e.unsubscribe())},xi),Si=(ht(Pi,ci=Jt),Object.defineProperty(Pi.prototype,"value",{get:function(){return this.getValue()},enumerable:!0,configurable:!0}),Pi.prototype._subscribe=function(e){var t=ci.prototype._subscribe.call(this,e);return t&&!t.closed&&e.next(this._value),t},Pi.prototype.getValue=function(){if(this.hasError)throw this.thrownError;if(this.closed)throw new zt;return this._value},Pi.prototype.next=function(e){ci.prototype.next.call(this,this._value=e)},Pi),f=(ht(Mi,ui=Rt),Mi.prototype.schedule=function(e,t){return this},ht(Ci,di=Mi),Ci.prototype.schedule=function(e,t){if(void 0===t&&(t=0),this.closed)return this;this.state=e;var i=this.id,e=this.scheduler;return null!=i&&(this.id=this.recycleAsyncId(e,i,t)),this.pending=!0,this.delay=t,this.id=this.id||this.requestAsyncId(e,this.id,t),this},Ci.prototype.requestAsyncId=function(e,t,i){return void 0===i&&(i=0),setInterval(e.flush.bind(e,this),i)},Ci.prototype.recycleAsyncId=function(e,t,i){if(null!==(i=void 0===i?0:i)&&this.delay===i&&!1===this.pending)return t;clearInterval(t)},Ci.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;t=this._execute(e,t);if(t)return t;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},Ci.prototype._execute=function(e,t){var i=!1,r=void 0;try{this.work(e)}catch(e){i=!0,r=!!e&&e||new Error(e)}if(i)return this.unsubscribe(),r},Ci.prototype._unsubscribe=function(){var e=this.id,t=this.scheduler,i=t.actions,r=i.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==r&&i.splice(r,1),null!=e&&(this.id=this.recycleAsyncId(t,e,null)),this.delay=null},Ci),e=(ht(ki,li=f),ki.prototype.schedule=function(e,t){return 0<(t=void 0===t?0:t)?li.prototype.schedule.call(this,e,t):(this.delay=t,this.state=e,this.scheduler.flush(this),this)},ki.prototype.execute=function(e,t){return 0<t||this.closed?li.prototype.execute.call(this,e,t):this._execute(e,t)},ki.prototype.requestAsyncId=function(e,t,i){return null!==(i=void 0===i?0:i)&&0<i||null===i&&0<this.delay?li.prototype.requestAsyncId.call(this,e,t,i):e.flush(this)},ki),bi=(Ri.prototype.schedule=function(e,t,i){return void 0===t&&(t=0),new this.SchedulerAction(this,e).schedule(i,t)},Ri.now=function(){return Date.now()},Ri),Ti=(ht(Ai,oi=bi),Ai.prototype.schedule=function(e,t,i){return void 0===t&&(t=0),Ai.delegate&&Ai.delegate!==this?Ai.delegate.schedule(e,t,i):oi.prototype.schedule.call(this,e,t,i)},Ai.prototype.flush=function(e){var t,i=this.actions;if(this.active)i.push(e);else{this.active=!0;do{if(t=e.execute(e.state,e.delay))break}while(e=i.shift());if(this.active=!1,t){for(;e=i.shift();)e.unsubscribe();throw t}}},Ai),Ii=(ht(Oi,ai=Ti),new Oi(e)),Ei=Ii,wi=new Kt(function(e){return e.complete()});function Oi(){return null!==ai&&ai.apply(this,arguments)||this}function Ai(e,t){void 0===t&&(t=bi.now);var i=oi.call(this,e,function(){return Ai.delegate&&Ai.delegate!==i?Ai.delegate.now():t()})||this;return i.actions=[],i.active=!1,i.scheduled=void 0,i}function Ri(e,t){void 0===t&&(t=Ri.now),this.SchedulerAction=e,this.now=t}function ki(e,t){var i=li.call(this,e,t)||this;return i.scheduler=e,i.work=t,i}function Ci(e,t){var i=di.call(this,e,t)||this;return i.scheduler=e,i.work=t,i.pending=!1,i}function Mi(e,t){return ui.call(this)||this}function Pi(e){var t=ci.call(this)||this;return t._value=e,t}function xi(e,t){e=hi.call(this,e)||this;return e.connectable=t,e}function Di(e,t){var i=pi.call(this)||this;return i.source=e,i.subjectFactory=t,i._refCount=0,i._isComplete=!1,i}function _i(e,t){e=fi.call(this,e)||this;return e.connectable=t,e}function Li(e){this.connectable=e}function Ni(e){return e?(t=e,new Kt(function(e){return t.schedule(function(){return e.complete()})})):wi;var t}function Fi(e){return e&&"function"==typeof e.schedule}var Bi=function(r){return function(e){for(var t=0,i=r.length;t<i&&!e.closed;t++)e.next(r[t]);e.complete()}};function Ui(r,n){return new Kt(function(e){var t=new Rt,i=0;return t.add(n.schedule(function(){i!==r.length?(e.next(r[i++]),e.closed||t.add(this.schedule())):e.complete()})),t})}function $i(e,t){return t?Ui(e,t):new Kt(Bi(e))}function Vi(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=e[e.length-1];return Fi(i)?(e.pop(),Ui(e,i)):$i(e)}function Ki(t,i){return new Kt(i?function(e){return i.schedule(Qi,0,{error:t,subscriber:e})}:function(e){return e.error(t)})}function Qi(e){var t=e.error;e.subscriber.error(t)}var qi=(ji.prototype.observe=function(e){switch(this.kind){case"N":return e.next&&e.next(this.value);case"E":return e.error&&e.error(this.error);case"C":return e.complete&&e.complete()}},ji.prototype.do=function(e,t,i){switch(this.kind){case"N":return e&&e(this.value);case"E":return t&&t(this.error);case"C":return i&&i()}},ji.prototype.accept=function(e,t,i){return e&&"function"==typeof e.next?this.observe(e):this.do(e,t,i)},ji.prototype.toObservable=function(){switch(this.kind){case"N":return Vi(this.value);case"E":return Ki(this.error);case"C":return Ni()}throw new Error("unexpected notification kind value")},ji.createNext=function(e){return void 0!==e?new ji("N",e):ji.undefinedValueNotification},ji.createError=function(e){return new ji("E",void 0,e)},ji.createComplete=function(){return ji.completeNotification},ji.completeNotification=new ji("C"),ji.undefinedValueNotification=new ji("N",void 0),ji);function ji(e,t,i){this.kind=e,this.value=t,this.error=i,this.hasValue="N"===e}function Hi(t,i){return void 0===i&&(i=0),function(e){return e.lift(new Yi(t,i))}}var Gi,Wi,zi,Yi=(or.prototype.call=function(e,t){return t.subscribe(new Xi(e,this.scheduler,this.delay))},or),Xi=(ht(ar,zi=_t),ar.dispatch=function(e){var t=e.notification,e=e.destination;t.observe(e),this.unsubscribe()},ar.prototype.scheduleMessage=function(e){this.destination.add(this.scheduler.schedule(ar.dispatch,this.delay,new Ji(e,this.destination)))},ar.prototype._next=function(e){this.scheduleMessage(qi.createNext(e))},ar.prototype._error=function(e){this.scheduleMessage(qi.createError(e)),this.unsubscribe()},ar.prototype._complete=function(){this.scheduleMessage(qi.createComplete()),this.unsubscribe()},ar),Ji=function(e,t){this.notification=e,this.destination=t},Zi=(ht(sr,Wi=Jt),sr.prototype.nextInfiniteTimeWindow=function(e){var t;this.isStopped||((t=this._events).push(e),t.length>this._bufferSize&&t.shift()),Wi.prototype.next.call(this,e)},sr.prototype.nextTimeWindow=function(e){this.isStopped||(this._events.push(new er(this._getNow(),e)),this._trimBufferThenGetEvents()),Wi.prototype.next.call(this,e)},sr.prototype._subscribe=function(e){var t,i=this._infiniteTimeWindow,r=i?this._events:this._trimBufferThenGetEvents(),n=this.scheduler,s=r.length;if(this.closed)throw new zt;if(t=this.isStopped||this.hasError?Rt.EMPTY:(this.observers.push(e),new Yt(this,e)),n&&e.add(e=new Xi(e,n)),i)for(var a=0;a<s&&!e.closed;a++)e.next(r[a]);else for(a=0;a<s&&!e.closed;a++)e.next(r[a].value);return this.hasError?e.error(this.thrownError):this.isStopped&&e.complete(),t},sr.prototype._getNow=function(){return(this.scheduler||Ei).now()},sr.prototype._trimBufferThenGetEvents=function(){for(var e=this._getNow(),t=this._bufferSize,i=this._windowTime,r=this._events,n=r.length,s=0;s<n&&!(e-r[s].time<i);)s++;return 0<(s=t<n?Math.max(s,n-t):s)&&r.splice(0,s),r},sr),er=function(e,t){this.time=e,this.value=t},tr=(ht(nr,Gi=Jt),nr.prototype._subscribe=function(e){return this.hasError?(e.error(this.thrownError),Rt.EMPTY):this.hasCompleted&&this.hasNext?(e.next(this.value),e.complete(),Rt.EMPTY):Gi.prototype._subscribe.call(this,e)},nr.prototype.next=function(e){this.hasCompleted||(this.value=e,this.hasNext=!0)},nr.prototype.error=function(e){this.hasCompleted||Gi.prototype.error.call(this,e)},nr.prototype.complete=function(){this.hasCompleted=!0,this.hasNext&&Gi.prototype.next.call(this,this.value),Gi.prototype.complete.call(this)},nr),ir=new Ti(f),rr=ir;function nr(){var e=null!==Gi&&Gi.apply(this,arguments)||this;return e.value=null,e.hasNext=!1,e.hasCompleted=!1,e}function sr(e,t,i){void 0===e&&(e=Number.POSITIVE_INFINITY),void 0===t&&(t=Number.POSITIVE_INFINITY);var r=Wi.call(this)||this;return r.scheduler=i,r._events=[],r._infiniteTimeWindow=!1,r._bufferSize=e<1?1:e,r._windowTime=t<1?1:t,t===Number.POSITIVE_INFINITY?(r._infiniteTimeWindow=!0,r.next=r.nextInfiniteTimeWindow):r.next=r.nextTimeWindow,r}function ar(e,t,i){void 0===i&&(i=0);e=zi.call(this,e)||this;return e.scheduler=t,e.delay=i,e}function or(e,t){void 0===t&&(t=0),this.scheduler=e,this.delay=t}function lr(){}var dr=(hr.prototype=Object.create(Error.prototype),hr),ur=(cr.prototype=Object.create(Error.prototype),cr);function cr(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}function hr(){return Error.call(this),this.message="argument out of range",this.name="ArgumentOutOfRangeError",this}function pr(t,i){return function(e){if("function"!=typeof t)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return e.lift(new yr(t,i))}}var fr,mr,gr,yr=(wr.prototype.call=function(e,t){return t.subscribe(new vr(e,this.project,this.thisArg))},wr),vr=(ht(Er,gr=_t),Er.prototype._next=function(e){var t;try{t=this.project.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}this.destination.next(t)},Er),Sr=(ht(Ir,mr=_t),Ir.prototype.notifyNext=function(e,t,i,r,n){this.destination.next(t)},Ir.prototype.notifyError=function(e,t){this.destination.error(e)},Ir.prototype.notifyComplete=function(e){this.destination.complete()},Ir),br=(ht(Tr,fr=_t),Tr.prototype._next=function(e){this.parent.notifyNext(this.outerValue,e,this.outerIndex,this.index++,this)},Tr.prototype._error=function(e){this.parent.notifyError(e,this),this.unsubscribe()},Tr.prototype._complete=function(){this.parent.notifyComplete(this),this.unsubscribe()},Tr);function Tr(e,t,i){var r=fr.call(this)||this;return r.parent=e,r.outerValue=t,r.outerIndex=i,r.index=0,r}function Ir(){return null!==mr&&mr.apply(this,arguments)||this}function Er(e,t,i){e=gr.call(this,e)||this;return e.project=t,e.count=0,e.thisArg=i||e,e}function wr(e,t){this.project=e,this.thisArg=t}var Or="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator",Ar=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function Rr(e){return e&&"function"!=typeof e.subscribe&&"function"==typeof e.then}var kr=function(e){if(e&&"function"==typeof e[Nt])return n=e,function(e){var t=n[Nt]();if("function"!=typeof t.subscribe)throw new TypeError("Provided object does not correctly implement Symbol.observable");return t.subscribe(e)};if(Ar(e))return Bi(e);if(Rr(e))return i=e,function(t){return i.then(function(e){t.closed||(t.next(e),t.complete())},function(e){return t.error(e)}).then(null,It),t};if(e&&"function"==typeof e[Or])return r=e,function(t){for(var e=r[Or]();;){var i=void 0;try{i=e.next()}catch(e){return t.error(e),t}if(i.done){t.complete();break}if(t.next(i.value),t.closed)break}return"function"==typeof e.return&&t.add(function(){e.return&&e.return()}),t};var r,i,n,e=Ot(e)?"an invalid object":"'"+e+"'";throw new TypeError("You provided "+e+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.")};function Cr(e,t,i,r,n){if(!(n=void 0===n?new br(e,i,r):n).closed)return t instanceof Kt?t.subscribe(n):kr(t)(n)}var Mr={};function Pr(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=void 0,r=void 0;return Fi(e[e.length-1])&&(r=e.pop()),"function"==typeof e[e.length-1]&&(i=e.pop()),$i(e=1===e.length&&wt(e[0])?e[0]:e,r).lift(new Dr(i))}var xr,Dr=(Nr.prototype.call=function(e,t){return t.subscribe(new _r(e,this.resultSelector))},Nr),_r=(ht(Lr,xr=Sr),Lr.prototype._next=function(e){this.values.push(Mr),this.observables.push(e)},Lr.prototype._complete=function(){var e=this.observables,t=e.length;if(0===t)this.destination.complete();else{this.active=t,this.toRespond=t;for(var i=0;i<t;i++){var r=e[i];this.add(Cr(this,r,void 0,i))}}},Lr.prototype.notifyComplete=function(e){0==--this.active&&this.destination.complete()},Lr.prototype.notifyNext=function(e,t,i){var r=this.values,n=r[i],n=this.toRespond?n===Mr?--this.toRespond:this.toRespond:0;r[i]=t,0===n&&(this.resultSelector?this._tryResultSelector(r):this.destination.next(r.slice()))},Lr.prototype._tryResultSelector=function(e){var t;try{t=this.resultSelector.apply(this,e)}catch(e){return void this.destination.error(e)}this.destination.next(t)},Lr);function Lr(e,t){e=xr.call(this,e)||this;return e.resultSelector=t,e.active=0,e.values=[],e.observables=[],e}function Nr(e){this.resultSelector=e}function Fr(e,t){if(null!=e){if(e&&"function"==typeof e[Nt])return s=e,a=t,new Kt(function(t){var i=new Rt;return i.add(a.schedule(function(){var e=s[Nt]();i.add(e.subscribe({next:function(e){i.add(a.schedule(function(){return t.next(e)}))},error:function(e){i.add(a.schedule(function(){return t.error(e)}))},complete:function(){i.add(a.schedule(function(){return t.complete()}))}}))})),i});if(Rr(e))return r=e,n=t,new Kt(function(t){var i=new Rt;return i.add(n.schedule(function(){return r.then(function(e){i.add(n.schedule(function(){t.next(e),i.add(n.schedule(function(){return t.complete()}))}))},function(e){i.add(n.schedule(function(){return t.error(e)}))})})),i});if(Ar(e))return Ui(e,t);if(e&&"function"==typeof e[Or]||"string"==typeof e)return function(t,i){if(!t)throw new Error("Iterable cannot be null");return new Kt(function(r){var n,e=new Rt;return e.add(function(){n&&"function"==typeof n.return&&n.return()}),e.add(i.schedule(function(){n=t[Or](),e.add(i.schedule(function(){if(!r.closed){try{var e=n.next(),t=e.value,i=e.done}catch(t){return void r.error(t)}i?r.complete():(r.next(t),this.schedule())}}))})),e})}(e,t)}var r,n,s,a;throw new TypeError((null!==e&&typeof e||e)+" is not observable")}function Br(e,t){return t?Fr(e,t):e instanceof Kt?e:new Kt(kr(e))}var Ur,$r,Vr=(ht(qr,$r=_t),qr.prototype._next=function(e){this.parent.notifyNext(e)},qr.prototype._error=function(e){this.parent.notifyError(e),this.unsubscribe()},qr.prototype._complete=function(){this.parent.notifyComplete(),this.unsubscribe()},qr),Kr=(ht(Qr,Ur=_t),Qr.prototype.notifyNext=function(e){this.destination.next(e)},Qr.prototype.notifyError=function(e){this.destination.error(e)},Qr.prototype.notifyComplete=function(){this.destination.complete()},Qr);function Qr(){return null!==Ur&&Ur.apply(this,arguments)||this}function qr(e){var t=$r.call(this)||this;return t.parent=e,t}function jr(e,t){if(!t.closed)return e instanceof Kt?e.subscribe(t):kr(e)(t)}function Hr(t,n,i){return void 0===i&&(i=Number.POSITIVE_INFINITY),"function"==typeof n?function(e){return e.pipe(Hr(function(i,r){return Br(t(i,r)).pipe(pr(function(e,t){return n(i,e,r,t)}))},i))}:("number"==typeof n&&(i=n),function(e){return e.lift(new Wr(t,i))})}var Gr,Wr=(Xr.prototype.call=function(e,t){return t.subscribe(new zr(e,this.project,this.concurrent))},Xr),zr=(ht(Yr,Gr=Kr),Yr.prototype._next=function(e){this.active<this.concurrent?this._tryNext(e):this.buffer.push(e)},Yr.prototype._tryNext=function(e){var t,i=this.index++;try{t=this.project(e,i)}catch(e){return void this.destination.error(e)}this.active++,this._innerSub(t)},Yr.prototype._innerSub=function(e){var t=new Vr(this),i=this.destination;i.add(t);e=jr(e,t);e!==t&&i.add(e)},Yr.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&this.destination.complete(),this.unsubscribe()},Yr.prototype.notifyNext=function(e){this.destination.next(e)},Yr.prototype.notifyComplete=function(){var e=this.buffer;this.active--,0<e.length?this._next(e.shift()):0===this.active&&this.hasCompleted&&this.destination.complete()},Yr);function Yr(e,t,i){void 0===i&&(i=Number.POSITIVE_INFINITY);e=Gr.call(this,e)||this;return e.project=t,e.concurrent=i,e.hasCompleted=!1,e.buffer=[],e.active=0,e.index=0,e}function Xr(e,t){void 0===t&&(t=Number.POSITIVE_INFINITY),this.project=e,this.concurrent=t}function Jr(e){return Hr(Ut,e=void 0===e?Number.POSITIVE_INFINITY:e)}function Zr(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Jr(1)(Vi.apply(void 0,e))}function en(i){return new Kt(function(t){var e;try{e=i()}catch(e){return void t.error(e)}return(e?Br(e):Ni()).subscribe(t)})}function tn(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){var i=e[0];if(wt(i))return rn(i,null);if(Ot(i)&&Object.getPrototypeOf(i)===Object.prototype){var r=Object.keys(i);return rn(r.map(function(e){return i[e]}),r)}}if("function"!=typeof e[e.length-1])return rn(e,null);var n=e.pop();return rn(e=1===e.length&&wt(e[0])?e[0]:e,null).pipe(pr(function(e){return n.apply(void 0,e)}))}function rn(l,d){return new Kt(function(r){var n=l.length;if(0!==n)for(var s=new Array(n),a=0,o=0,e=0;e<n;e++)!function(t){var e=Br(l[t]),i=!1;r.add(e.subscribe({next:function(e){i||(i=!0,o++),s[t]=e},error:function(e){return r.error(e)},complete:function(){++a!==n&&i||(o===n&&r.next(d?d.reduce(function(e,t,i){return e[t]=s[i],e},{}):s),r.complete())}}))}(e);else r.complete()})}function nn(e,i,r,t){return St(r)&&(t=r,r=void 0),t?nn(e,i,r).pipe(pr(function(e){return wt(e)?t.apply(void 0,e):t(e)})):new Kt(function(t){!function e(t,i,r,n,s){var a;if(function(e){return e&&"function"==typeof e.addEventListener&&"function"==typeof e.removeEventListener}(t)){var o=t;t.addEventListener(i,r,s),a=function(){return o.removeEventListener(i,r,s)}}else if(function(e){return e&&"function"==typeof e.on&&"function"==typeof e.off}(t)){var l=t;t.on(i,r),a=function(){return l.off(i,r)}}else if(function(e){return e&&"function"==typeof e.addListener&&"function"==typeof e.removeListener}(t)){var d=t;t.addListener(i,r),a=function(){return d.removeListener(i,r)}}else{if(!t||!t.length)throw new TypeError("Invalid event target");for(var u=0,c=t.length;u<c;u++)e(t[u],i,r,n,s)}n.add(a)}(e,i,function(e){1<arguments.length?t.next(Array.prototype.slice.call(arguments)):t.next(e)},t,r)})}function sn(r,n,t){return t?sn(r,n).pipe(pr(function(e){return wt(e)?t.apply(void 0,e):t(e)})):new Kt(function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return i.next(1===e.length?e[0]:e)}var t;try{t=r(e)}catch(e){return void i.error(e)}if(St(n))return function(){return n(e,t)}})}function an(e,t,i){return void 0===t&&(t=wi),void 0===i&&(i=wi),en(function(){return e()?t:i})}function on(e){return!wt(e)&&0<=e-parseFloat(e)+1}function ln(e){var t=e.subscriber,i=e.counter,e=e.period;t.next(i),this.schedule({subscriber:t,counter:i+1,period:e},e)}function dn(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=Number.POSITIVE_INFINITY,r=null,n=e[e.length-1];return Fi(n)?(r=e.pop(),1<e.length&&"number"==typeof e[e.length-1]&&(i=e.pop())):"number"==typeof n&&(i=e.pop()),null===r&&1===e.length&&e[0]instanceof Kt?e[0]:Jr(i)($i(e,r))}var un=new Kt(lr);function cn(t,i){return function(e){return e.lift(new pn(t,i))}}var hn,pn=(gn.prototype.call=function(e,t){return t.subscribe(new fn(e,this.predicate,this.thisArg))},gn),fn=(ht(mn,hn=_t),mn.prototype._next=function(e){var t;try{t=this.predicate.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}t&&this.destination.next(e)},mn);function mn(e,t,i){e=hn.call(this,e)||this;return e.predicate=t,e.thisArg=i,e.count=0,e}function gn(e,t){this.predicate=e,this.thisArg=t}function yn(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){if(!wt(e[0]))return e[0];e=e[0]}return $i(e,void 0).lift(new Sn)}var vn,Sn=(In.prototype.call=function(e,t){return t.subscribe(new bn(e))},In),bn=(ht(Tn,vn=Sr),Tn.prototype._next=function(e){this.observables.push(e)},Tn.prototype._complete=function(){var e=this.observables,t=e.length;if(0===t)this.destination.complete();else{for(var i=0;i<t&&!this.hasFirst;i++){var r=Cr(this,e[i],void 0,i);this.subscriptions&&this.subscriptions.push(r),this.add(r)}this.observables=null}},Tn.prototype.notifyNext=function(e,t,i){if(!this.hasFirst){this.hasFirst=!0;for(var r,n=0;n<this.subscriptions.length;n++)n!==i&&((r=this.subscriptions[n]).unsubscribe(),this.remove(r));this.subscriptions=null}this.destination.next(t)},Tn);function Tn(e){e=vn.call(this,e)||this;return e.hasFirst=!1,e.observables=[],e.subscriptions=[],e}function In(){}function En(i,e,r){void 0===i&&(i=0);var n=-1;return on(e)?n=Number(e)<1?1:Number(e):Fi(e)&&(r=e),Fi(r)||(r=rr),new Kt(function(e){var t=on(i)?i:+i-r.now();return r.schedule(wn,t,{index:0,period:n,subscriber:e})})}function wn(e){var t=e.index,i=e.period,r=e.subscriber;if(r.next(t),!r.closed){if(-1===i)return r.complete();e.index=t+1,this.schedule(e,i)}}var On,An,Rn,kn=(Vn.prototype.call=function(e,t){return t.subscribe(new Cn(e,this.resultSelector))},Vn),Cn=(ht($n,Rn=_t),$n.prototype._next=function(e){var t=this.iterators;wt(e)?t.push(new Pn(e)):"function"==typeof e[Or]?t.push(new Mn(e[Or]())):t.push(new xn(this.destination,this,e))},$n.prototype._complete=function(){var e=this.iterators,t=e.length;if(this.unsubscribe(),0!==t){this.active=t;for(var i=0;i<t;i++){var r=e[i];r.stillUnsubscribed?this.destination.add(r.subscribe()):this.active--}}else this.destination.complete()},$n.prototype.notifyInactive=function(){this.active--,0===this.active&&this.destination.complete()},$n.prototype.checkIterators=function(){for(var e=this.iterators,t=e.length,i=this.destination,r=0;r<t;r++)if("function"==typeof(a=e[r]).hasValue&&!a.hasValue())return;for(var n=!1,s=[],r=0;r<t;r++){var a,o=(a=e[r]).next();if(a.hasCompleted()&&(n=!0),o.done)return void i.complete();s.push(o.value)}this.resultSelector?this._tryresultSelector(s):i.next(s),n&&i.complete()},$n.prototype._tryresultSelector=function(e){var t;try{t=this.resultSelector.apply(this,e)}catch(e){return void this.destination.error(e)}this.destination.next(t)},$n),Mn=(Un.prototype.hasValue=function(){return!0},Un.prototype.next=function(){var e=this.nextResult;return this.nextResult=this.iterator.next(),e},Un.prototype.hasCompleted=function(){var e=this.nextResult;return Boolean(e&&e.done)},Un),Pn=(Bn.prototype[Or]=function(){return this},Bn.prototype.next=function(e){var t=this.index++,i=this.array;return t<this.length?{value:i[t],done:!1}:{value:null,done:!0}},Bn.prototype.hasValue=function(){return this.array.length>this.index},Bn.prototype.hasCompleted=function(){return this.array.length===this.index},Bn),xn=(ht(Fn,An=Kr),Fn.prototype[Or]=function(){return this},Fn.prototype.next=function(){var e=this.buffer;return 0===e.length&&this.isComplete?{value:null,done:!0}:{value:e.shift(),done:!1}},Fn.prototype.hasValue=function(){return 0<this.buffer.length},Fn.prototype.hasCompleted=function(){return 0===this.buffer.length&&this.isComplete},Fn.prototype.notifyComplete=function(){0<this.buffer.length?(this.isComplete=!0,this.parent.notifyInactive()):this.destination.complete()},Fn.prototype.notifyNext=function(e){this.buffer.push(e),this.parent.checkIterators()},Fn.prototype.subscribe=function(){return jr(this.observable,new Vr(this))},Fn),Dn=(Nn.prototype.call=function(e,t){return t.subscribe(new _n(e,this.durationSelector))},Nn),_n=(ht(Ln,On=Kr),Ln.prototype._next=function(e){if(this.value=e,this.hasValue=!0,!this.throttled){var t=void 0;try{t=(0,this.durationSelector)(e)}catch(e){return this.destination.error(e)}t=jr(t,new Vr(this));!t||t.closed?this.clearThrottle():this.add(this.throttled=t)}},Ln.prototype.clearThrottle=function(){var e=this.value,t=this.hasValue,i=this.throttled;i&&(this.remove(i),this.throttled=void 0,i.unsubscribe()),t&&(this.value=void 0,this.hasValue=!1,this.destination.next(e))},Ln.prototype.notifyNext=function(){this.clearThrottle()},Ln.prototype.notifyComplete=function(){this.clearThrottle()},Ln);function Ln(e,t){e=On.call(this,e)||this;return e.durationSelector=t,e.hasValue=!1,e}function Nn(e){this.durationSelector=e}function Fn(e,t,i){e=An.call(this,e)||this;return e.parent=t,e.observable=i,e.stillUnsubscribed=!0,e.buffer=[],e.isComplete=!1,e}function Bn(e){this.array=e,this.index=0,this.length=0,this.length=e.length}function Un(e){this.iterator=e,this.nextResult=e.next()}function $n(e,t,i){e=Rn.call(this,e)||this;return e.resultSelector=t,e.iterators=[],e.active=0,e.resultSelector="function"==typeof t?t:void 0,e}function Vn(e){this.resultSelector=e}function Kn(e,t){return void 0===t&&(t=rr),i=function(){return En(e,t)},function(e){return e.lift(new Dn(i))};var i}function Qn(i){return function(e){var t=new jn(i),e=e.lift(t);return t.caught=e}}var qn,jn=(Wn.prototype.call=function(e,t){return t.subscribe(new Hn(e,this.selector,this.caught))},Wn),Hn=(ht(Gn,qn=Kr),Gn.prototype.error=function(e){if(!this.isStopped){var t=void 0;try{t=this.selector(e,this.caught)}catch(e){return void qn.prototype.error.call(this,e)}this._unsubscribeAndRecycle();var i=new Vr(this);this.add(i);t=jr(t,i);t!==i&&this.add(t)}},Gn);function Gn(e,t,i){e=qn.call(this,e)||this;return e.selector=t,e.caught=i,e}function Wn(e){this.selector=e}function zn(e,t){return Hr(e,t,1)}function Yn(t,i){return void 0===i&&(i=rr),function(e){return e.lift(new Jn(t,i))}}var Xn,Jn=(ts.prototype.call=function(e,t){return t.subscribe(new Zn(e,this.dueTime,this.scheduler))},ts),Zn=(ht(es,Xn=_t),es.prototype._next=function(e){this.clearDebounce(),this.lastValue=e,this.hasValue=!0,this.add(this.debouncedSubscription=this.scheduler.schedule(is,this.dueTime,this))},es.prototype._complete=function(){this.debouncedNext(),this.destination.complete()},es.prototype.debouncedNext=function(){var e;this.clearDebounce(),this.hasValue&&(e=this.lastValue,this.lastValue=null,this.hasValue=!1,this.destination.next(e))},es.prototype.clearDebounce=function(){var e=this.debouncedSubscription;null!==e&&(this.remove(e),e.unsubscribe(),this.debouncedSubscription=null)},es);function es(e,t,i){e=Xn.call(this,e)||this;return e.dueTime=t,e.scheduler=i,e.debouncedSubscription=null,e.lastValue=null,e.hasValue=!1,e}function ts(e,t){this.dueTime=e,this.scheduler=t}function is(e){e.debouncedNext()}var rs,ns=(os.prototype.call=function(e,t){return t.subscribe(new ss(e,this.defaultValue))},os),ss=(ht(as,rs=_t),as.prototype._next=function(e){this.isEmpty=!1,this.destination.next(e)},as.prototype._complete=function(){this.isEmpty&&this.destination.next(this.defaultValue),this.destination.complete()},as);function as(e,t){e=rs.call(this,e)||this;return e.defaultValue=t,e.isEmpty=!0,e}function os(e){this.defaultValue=e}function ls(e){return e instanceof Date&&!isNaN(+e)}var ds,us,cs=(Ss.prototype.call=function(e,t){return t.subscribe(new hs(e,this.delay,this.scheduler))},Ss),hs=(ht(vs,us=_t),vs.dispatch=function(e){for(var t,i=e.source,r=i.queue,n=e.scheduler,s=e.destination;0<r.length&&r[0].time-n.now()<=0;)r.shift().notification.observe(s);0<r.length?(t=Math.max(0,r[0].time-n.now()),this.schedule(e,t)):(this.unsubscribe(),i.active=!1)},vs.prototype._schedule=function(e){this.active=!0,this.destination.add(e.schedule(vs.dispatch,this.delay,{source:this,destination:this.destination,scheduler:e}))},vs.prototype.scheduleNotification=function(e){var t;!0!==this.errored&&(t=this.scheduler,e=new ps(t.now()+this.delay,e),this.queue.push(e),!1===this.active&&this._schedule(t))},vs.prototype._next=function(e){this.scheduleNotification(qi.createNext(e))},vs.prototype._error=function(e){this.errored=!0,this.queue=[],this.destination.error(e),this.unsubscribe()},vs.prototype._complete=function(){this.scheduleNotification(qi.createComplete()),this.unsubscribe()},vs),ps=function(e,t){this.time=e,this.notification=t},fs=(ys.prototype.call=function(e,t){return t.subscribe(new ms(e,this.delayDurationSelector))},ys),ms=(ht(gs,ds=Sr),gs.prototype.notifyNext=function(e,t,i,r,n){this.destination.next(e),this.removeSubscription(n),this.tryComplete()},gs.prototype.notifyError=function(e,t){this._error(e)},gs.prototype.notifyComplete=function(e){e=this.removeSubscription(e);e&&this.destination.next(e),this.tryComplete()},gs.prototype._next=function(e){var t=this.index++;try{var i=this.delayDurationSelector(e,t);i&&this.tryDelay(i,e)}catch(e){this.destination.error(e)}},gs.prototype._complete=function(){this.completed=!0,this.tryComplete(),this.unsubscribe()},gs.prototype.removeSubscription=function(e){e.unsubscribe();var t=this.delayNotifierSubscriptions.indexOf(e);return-1!==t&&this.delayNotifierSubscriptions.splice(t,1),e.outerValue},gs.prototype.tryDelay=function(e,t){t=Cr(this,e,t);t&&!t.closed&&(this.destination.add(t),this.delayNotifierSubscriptions.push(t))},gs.prototype.tryComplete=function(){this.completed&&0===this.delayNotifierSubscriptions.length&&this.destination.complete()},gs);function gs(e,t){e=ds.call(this,e)||this;return e.delayDurationSelector=t,e.completed=!1,e.delayNotifierSubscriptions=[],e.index=0,e}function ys(e){this.delayDurationSelector=e}function vs(e,t,i){e=us.call(this,e)||this;return e.delay=t,e.scheduler=i,e.queue=[],e.active=!1,e.errored=!1,e}function Ss(e,t){this.delay=e,this.scheduler=t}function bs(t,i){return function(e){return e.lift(new Is(t,i))}}var Ts,Is=(Os.prototype.call=function(e,t){return t.subscribe(new Es(e,this.compare,this.keySelector))},Os),Es=(ht(ws,Ts=_t),ws.prototype.compare=function(e,t){return e===t},ws.prototype._next=function(e){try{var t=this.keySelector,i=t?t(e):e}catch(e){return this.destination.error(e)}t=!1;if(this.hasKey)try{t=(0,this.compare)(this.key,i)}catch(e){return this.destination.error(e)}else this.hasKey=!0;t||(this.key=i,this.destination.next(e))},ws);function ws(e,t,i){e=Ts.call(this,e)||this;return e.keySelector=i,e.hasKey=!1,"function"==typeof t&&(e.compare=t),e}function Os(e,t){this.compare=e,this.keySelector=t}function As(t){return function(e){return 0===t?Ni():e.lift(new ks(t))}}var Rs,ks=(Ps.prototype.call=function(e,t){return t.subscribe(new Cs(e,this.total))},Ps),Cs=(ht(Ms,Rs=_t),Ms.prototype._next=function(e){var t=this.total,i=++this.count;i<=t&&(this.destination.next(e),i===t&&(this.destination.complete(),this.unsubscribe()))},Ms);function Ms(e,t){e=Rs.call(this,e)||this;return e.total=t,e.count=0,e}function Ps(e){if(this.total=e,this.total<0)throw new dr}function xs(t,n){return n?function(e){return e.pipe(xs(function(i,r){return Br(t(i,r)).pipe(pr(function(e,t){return n(i,e,r,t)}))}))}:function(e){return e.lift(new _s(t))}}var Ds,_s=(Fs.prototype.call=function(e,t){return t.subscribe(new Ls(e,this.project))},Fs),Ls=(ht(Ns,Ds=Kr),Ns.prototype._next=function(e){this.hasSubscription||this.tryNext(e)},Ns.prototype.tryNext=function(e){var t,i=this.index++;try{t=this.project(e,i)}catch(e){return void this.destination.error(e)}this.hasSubscription=!0,this._innerSub(t)},Ns.prototype._innerSub=function(e){var t=new Vr(this),i=this.destination;i.add(t);e=jr(e,t);e!==t&&i.add(e)},Ns.prototype._complete=function(){this.hasCompleted=!0,this.hasSubscription||this.destination.complete(),this.unsubscribe()},Ns.prototype.notifyNext=function(e){this.destination.next(e)},Ns.prototype.notifyError=function(e){this.destination.error(e)},Ns.prototype.notifyComplete=function(){this.hasSubscription=!1,this.hasCompleted&&this.destination.complete()},Ns);function Ns(e,t){e=Ds.call(this,e)||this;return e.project=t,e.hasSubscription=!1,e.hasCompleted=!1,e.index=0,e}function Fs(e){this.project=e}function Bs(t){return function(e){return e.lift(new $s(t))}}var Us,$s=(Qs.prototype.call=function(e,t){return t.subscribe(new Vs(e,this.callback))},Qs),Vs=(ht(Ks,Us=_t),Ks);function Ks(e,t){e=Us.call(this,e)||this;return e.add(new Rt(t)),e}function Qs(e){this.callback=e}function qs(t){return function(e){return 0===t?Ni():e.lift(new Hs(t))}}var js,Hs=(zs.prototype.call=function(e,t){return t.subscribe(new Gs(e,this.total))},zs),Gs=(ht(Ws,js=_t),Ws.prototype._next=function(e){var t=this.ring,i=this.total,r=this.count++;t.length<i?t.push(e):t[r%i]=e},Ws.prototype._complete=function(){var e=this.destination,t=this.count;if(0<t)for(var i=this.count>=this.total?this.total:this.count,r=this.ring,n=0;n<i;n++){var s=t++%i;e.next(r[s])}e.complete()},Ws);function Ws(e,t){e=js.call(this,e)||this;return e.total=t,e.ring=new Array,e.count=0,e}function zs(e){if(this.total=e,this.total<0)throw new dr}function Ys(t){return function(e){return e.lift(new Js(t))}}var Xs,Js=(ta.prototype.call=function(e,t){return t.subscribe(new Zs(e,this.value))},ta),Zs=(ht(ea,Xs=_t),ea.prototype._next=function(e){this.destination.next(this.value)},ea);function ea(e,t){e=Xs.call(this,e)||this;return e.value=t,e}function ta(e){this.value=e}function ia(t,i){var r=2<=arguments.length?!0:!1;return function(e){return e.lift(new na(t,i,r))}}var ra,na=(oa.prototype.call=function(e,t){return t.subscribe(new sa(e,this.accumulator,this.seed,this.hasSeed))},oa),sa=(ht(aa,ra=_t),Object.defineProperty(aa.prototype,"seed",{get:function(){return this._seed},set:function(e){this.hasSeed=!0,this._seed=e},enumerable:!0,configurable:!0}),aa.prototype._next=function(e){if(this.hasSeed)return this._tryNext(e);this.seed=e,this.destination.next(e)},aa.prototype._tryNext=function(e){var t,i=this.index++;try{t=this.accumulator(this.seed,e,i)}catch(e){this.destination.error(e)}this.seed=t,this.destination.next(t)},aa);function aa(e,t,i,r){e=ra.call(this,e)||this;return e.accumulator=t,e._seed=i,e.hasSeed=r,e.index=0,e}function oa(e,t,i){void 0===i&&(i=!1),this.accumulator=e,this.seed=t,this.hasSeed=i}function la(r,i){return 2<=arguments.length?function(e){return $t(ia(r,i),qs(1),(void 0===(t=i)&&(t=null),function(e){return e.lift(new ns(t))}))(e);var t}:function(e){return $t(ia(function(e,t,i){return r(e,t,i+1)}),qs(1))(e)}}function da(){return function(e){return e.lift(new ha)}}var ua,ca,ha=(Sa.prototype.call=function(e,t){return t.subscribe(new pa(e))},Sa),pa=(ht(va,ca=_t),va.prototype._next=function(e){var t;this.hasPrev?t=[this.prev,e]:this.hasPrev=!0,this.prev=e,t&&this.destination.next(t)},va),fa=(ya.prototype.call=function(e,t){return t.subscribe(new ma(e,this.notifier,t))},ya),ma=(ht(ga,ua=Kr),ga.prototype.notifyNext=function(){this.sourceIsBeingSubscribedTo=!0,this.source.subscribe(this)},ga.prototype.notifyComplete=function(){if(!1===this.sourceIsBeingSubscribedTo)return ua.prototype.complete.call(this)},ga.prototype.complete=function(){if(this.sourceIsBeingSubscribedTo=!1,!this.isStopped){if(this.retries||this.subscribeToRetries(),!this.retriesSubscription||this.retriesSubscription.closed)return ua.prototype.complete.call(this);this._unsubscribeAndRecycle(),this.notifications.next(void 0)}},ga.prototype._unsubscribe=function(){var e=this.notifications,t=this.retriesSubscription;e&&(e.unsubscribe(),this.notifications=void 0),t&&(t.unsubscribe(),this.retriesSubscription=void 0),this.retries=void 0},ga.prototype._unsubscribeAndRecycle=function(){var e=this._unsubscribe;return this._unsubscribe=null,ua.prototype._unsubscribeAndRecycle.call(this),this._unsubscribe=e,this},ga.prototype.subscribeToRetries=function(){var e;this.notifications=new Jt;try{e=(0,this.notifier)(this.notifications)}catch(e){return ua.prototype.complete.call(this)}this.retries=e,this.retriesSubscription=jr(e,new Vr(this))},ga);function ga(e,t,i){e=ua.call(this,e)||this;return e.notifier=t,e.source=i,e.sourceIsBeingSubscribedTo=!0,e}function ya(e){this.notifier=e}function va(e){e=ca.call(this,e)||this;return e.hasPrev=!1,e}function Sa(){}function ba(t){return function(e){return e.lift(new Ia(t,e))}}var Ta,Ia=(Oa.prototype.call=function(e,t){return t.subscribe(new Ea(e,this.notifier,this.source))},Oa),Ea=(ht(wa,Ta=Kr),wa.prototype.error=function(e){if(!this.isStopped){var t=this.errors,i=this.retries,r=this.retriesSubscription;if(i)this.errors=void 0,this.retriesSubscription=void 0;else{t=new Jt;try{i=(0,this.notifier)(t)}catch(e){return Ta.prototype.error.call(this,e)}r=jr(i,new Vr(this))}this._unsubscribeAndRecycle(),this.errors=t,this.retries=i,this.retriesSubscription=r,t.next(e)}},wa.prototype._unsubscribe=function(){var e=this.errors,t=this.retriesSubscription;e&&(e.unsubscribe(),this.errors=void 0),t&&(t.unsubscribe(),this.retriesSubscription=void 0),this.retries=void 0},wa.prototype.notifyNext=function(){var e=this._unsubscribe;this._unsubscribe=null,this._unsubscribeAndRecycle(),this._unsubscribe=e,this.source.subscribe(this)},wa);function wa(e,t,i){e=Ta.call(this,e)||this;return e.notifier=t,e.source=i,e}function Oa(e,t){this.notifier=e,this.source=t}function Aa(){return new Jt}function Ra(){return function(e){return si()((t=e,i="function"==typeof(r=Aa)?r:function(){return r},(e=Object.create(t,yi)).source=t,e.subjectFactory=i,e));var t,i,r}}function ka(t){return function(e){return e.lift(new Ma(t))}}var Ca,Ma=(Da.prototype.call=function(e,t){return t.subscribe(new Pa(e,this.total))},Da),Pa=(ht(xa,Ca=_t),xa.prototype._next=function(e){++this.count>this.total&&this.destination.next(e)},xa);function xa(e,t){e=Ca.call(this,e)||this;return e.total=t,e.count=0,e}function Da(e){this.total=e}function _a(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=t[t.length-1];return Fi(i)?(t.pop(),function(e){return Zr(t,e,i)}):function(e){return Zr(t,e)}}function La(t,n){return"function"==typeof n?function(e){return e.pipe(La(function(i,r){return Br(t(i,r)).pipe(pr(function(e,t){return n(i,e,r,t)}))}))}:function(e){return e.lift(new Fa(t))}}var Na,Fa=($a.prototype.call=function(e,t){return t.subscribe(new Ba(e,this.project))},$a),Ba=(ht(Ua,Na=Kr),Ua.prototype._next=function(e){var t,i=this.index++;try{t=this.project(e,i)}catch(e){return void this.destination.error(e)}this._innerSub(t)},Ua.prototype._innerSub=function(e){var t=this.innerSubscription;t&&t.unsubscribe();var i=new Vr(this),t=this.destination;t.add(i),this.innerSubscription=jr(e,i),this.innerSubscription!==i&&t.add(this.innerSubscription)},Ua.prototype._complete=function(){var e=this.innerSubscription;e&&!e.closed||Na.prototype._complete.call(this),this.unsubscribe()},Ua.prototype._unsubscribe=function(){this.innerSubscription=void 0},Ua.prototype.notifyComplete=function(){this.innerSubscription=void 0,this.isStopped&&Na.prototype._complete.call(this)},Ua.prototype.notifyNext=function(e){this.destination.next(e)},Ua);function Ua(e,t){e=Na.call(this,e)||this;return e.project=t,e.index=0,e}function $a(e){this.project=e}function Va(e,t){return t?La(function(){return e},t):La(function(){return e})}function Ka(t){return function(e){return e.lift(new qa(t))}}var Qa,qa=(Ga.prototype.call=function(e,t){var i=new ja(e),e=jr(this.notifier,new Vr(i));return e&&!i.seenValue?(i.add(e),t.subscribe(i)):i},Ga),ja=(ht(Ha,Qa=Kr),Ha.prototype.notifyNext=function(){this.seenValue=!0,this.complete()},Ha.prototype.notifyComplete=function(){},Ha);function Ha(e){e=Qa.call(this,e)||this;return e.seenValue=!1,e}function Ga(e){this.notifier=e}function Wa(t,i){return void 0===i&&(i=!1),function(e){return e.lift(new Ya(t,i))}}var za,Ya=(Za.prototype.call=function(e,t){return t.subscribe(new Xa(e,this.predicate,this.inclusive))},Za),Xa=(ht(Ja,za=_t),Ja.prototype._next=function(e){var t,i=this.destination;try{t=this.predicate(e,this.index++)}catch(e){return void i.error(e)}this.nextOrComplete(e,t)},Ja.prototype.nextOrComplete=function(e,t){var i=this.destination;Boolean(t)?i.next(e):(this.inclusive&&i.next(e),i.complete())},Ja);function Ja(e,t,i){e=za.call(this,e)||this;return e.predicate=t,e.inclusive=i,e.index=0,e}function Za(e,t){this.predicate=e,this.inclusive=t}function eo(t,i,r){return function(e){return e.lift(new io(t,i,r))}}var to,io=(ao.prototype.call=function(e,t){return t.subscribe(new ro(e,this.nextOrObserver,this.error,this.complete))},ao),ro=(ht(so,to=_t),so.prototype._next=function(e){try{this._tapNext.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.next(e)},so.prototype._error=function(e){try{this._tapError.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.error(e)},so.prototype._complete=function(){try{this._tapComplete.call(this._context)}catch(e){return void this.destination.error(e)}return this.destination.complete()},so),no={leading:!0,trailing:!1};function so(e,t,i,r){e=to.call(this,e)||this;return e._tapNext=lr,e._tapError=lr,e._tapComplete=lr,e._tapError=i||lr,e._tapComplete=r||lr,St(t)?(e._context=e)._tapNext=t:t&&(e._context=t,e._tapNext=t.next||lr,e._tapError=t.error||lr,e._tapComplete=t.complete||lr),e}function ao(e,t,i){this.nextOrObserver=e,this.error=t,this.complete=i}function oo(t,i,r){return void 0===i&&(i=rr),void 0===r&&(r=no),function(e){return e.lift(new uo(t,i,r.leading,r.trailing))}}var lo,uo=(po.prototype.call=function(e,t){return t.subscribe(new co(e,this.duration,this.scheduler,this.leading,this.trailing))},po),co=(ht(ho,lo=_t),ho.prototype._next=function(e){this.throttled?this.trailing&&(this._trailingValue=e,this._hasTrailingValue=!0):(this.add(this.throttled=this.scheduler.schedule(fo,this.duration,{subscriber:this})),this.leading?this.destination.next(e):this.trailing&&(this._trailingValue=e,this._hasTrailingValue=!0))},ho.prototype._complete=function(){this._hasTrailingValue&&this.destination.next(this._trailingValue),this.destination.complete()},ho.prototype.clearThrottle=function(){var e=this.throttled;e&&(this.trailing&&this._hasTrailingValue&&(this.destination.next(this._trailingValue),this._trailingValue=null,this._hasTrailingValue=!1),e.unsubscribe(),this.remove(e),this.throttled=null)},ho);function ho(e,t,i,r,n){e=lo.call(this,e)||this;return e.duration=t,e.scheduler=i,e.leading=r,e.trailing=n,e._hasTrailingValue=!1,e._trailingValue=null,e}function po(e,t,i,r){this.duration=e,this.scheduler=t,this.leading=i,this.trailing=r}function fo(e){e.subscriber.clearThrottle()}var mo,go=(So.prototype.call=function(e,t){return t.subscribe(new yo(e,this.absoluteTimeout,this.waitFor,this.withObservable,this.scheduler))},So),yo=(ht(vo,mo=Kr),vo.dispatchTimeout=function(e){var t=e.withObservable;e._unsubscribeAndRecycle(),e.add(jr(t,new Vr(e)))},vo.prototype.scheduleTimeout=function(){var e=this.action;e?this.action=e.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(vo.dispatchTimeout,this.waitFor,this))},vo.prototype._next=function(e){this.absoluteTimeout||this.scheduleTimeout(),mo.prototype._next.call(this,e)},vo.prototype._unsubscribe=function(){this.action=void 0,this.scheduler=null,this.withObservable=null},vo);function vo(e,t,i,r,n){e=mo.call(this,e)||this;return e.absoluteTimeout=t,e.waitFor=i,e.withObservable=r,e.scheduler=n,e.scheduleTimeout(),e}function So(e,t,i,r){this.waitFor=e,this.absoluteTimeout=t,this.withObservable=i,this.scheduler=r}function bo(e,t){return void 0===t&&(t=rr),r=e,n=Ki(new ur),void 0===(s=t)&&(s=rr),function(e){var t=ls(r),i=t?+r-s.now():Math.abs(r);return e.lift(new go(i,t,n,s))};var r,n,s}function To(){for(var i=[],e=0;e<arguments.length;e++)i[e]=arguments[e];return function(e){var t;return"function"==typeof i[i.length-1]&&(t=i.pop()),e.lift(new Eo(i,t))}}var Io,Eo=(ko.prototype.call=function(e,t){return t.subscribe(new wo(e,this.observables,this.project))},ko),wo=(ht(Ro,Io=Sr),Ro.prototype.notifyNext=function(e,t,i){this.values[i]=t;t=this.toRespond;0<t.length&&(-1!==(i=t.indexOf(i))&&t.splice(i,1))},Ro.prototype.notifyComplete=function(){},Ro.prototype._next=function(e){0===this.toRespond.length&&(e=[e].concat(this.values),this.project?this._tryProject(e):this.destination.next(e))},Ro.prototype._tryProject=function(e){var t;try{t=this.project.apply(this,e)}catch(e){return void this.destination.error(e)}this.destination.next(t)},Ro),Oo={type:null,entityIds:null,skip:!1},Ao=!1;function Ro(e,t,i){var r=Io.call(this,e)||this;r.observables=t,r.project=i,r.toRespond=[];var n=t.length;r.values=new Array(n);for(var s=0;s<n;s++)r.toRespond.push(s);for(s=0;s<n;s++){var a=t[s];r.add(Cr(r,a,void 0,s))}return r}function ko(e,t){this.observables=e,this.project=t}function Co(e,t){Mo(e,t),Ao=!0}function Mo(e,t){!1===Ao&&(Oo.type=e,Oo.entityIds=t)}function Po(e,t){return e.hasOwnProperty(t)}function xo(e){return null==e}function Do(e){return xo(e)?[]:Array.isArray(e)?e:[e]}var _o;(su=_o=_o||{}).Set="Set",su.Add="Add",su.Update="Update",su.Remove="Remove";var Lo="undefined"!=typeof window,No=!0;function Fo(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}function Bo(e){return Array.isArray(e)}function Uo(e){return!1===xo(e)}function $o(e){return Bo(e)&&0===e.length}function Vo(e){return"function"==typeof e}function Ko(e){return void 0===e}function Qo(e){return e.hasOwnProperty("active")}function qo(e){return Bo(e)}function jo(e){var t,i=e.active,r=e.ids,n=e.entities;return qo(i)?(t=r,(r=(e=i).filter(function(e){return-1<t.indexOf(e)})).length===e.length?e:r):!1===Po(n,i)?null:i}function Ho(e,t){var i,r,n={};try{for(var s=gt(Object.keys(e)),a=s.next();!a.done;a=s.next()){var o=a.value;n[o]=t(e[o])}}catch(e){i={error:e}}finally{try{a&&!a.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return n}var Go={resettable:!1,ttl:null,producerFn:void 0};function Wo(t){Object.freeze(t);var i="function"==typeof t,r=Object.prototype.hasOwnProperty;return Object.getOwnPropertyNames(t).forEach(function(e){!r.call(t,e)||i&&("caller"===e||"callee"===e||"arguments"===e)||null===t[e]||"object"!=typeof t[e]&&"function"!=typeof t[e]||Object.isFrozen(t[e])||Wo(t[e])}),t}var zo,Yo=new Jt,Xo=new Zi(50,5e3),Jo=new Jt;function Zo(e){return null!=e&&""+e!="false"}function el(e){return Zo(e)&&"Object"===e.constructor.name}ht(function(e){return zo.call(this,e)||this},zo=Error);var tl={},il={};Lo&&(window.$$stores=tl,window.$$queries=il);var rl=new Jt,nl=new Si(!1),sl={activeTransactions:0,batchTransaction:null};function al(){return 0<sl.activeTransactions}function ol(e,t){void 0===t&&(t=void 0),al()||(sl.batchTransaction=new Jt),sl.activeTransactions++,nl.next(!0);try{return e.apply(t)}finally{Co("@Transaction"),0==--sl.activeTransactions&&(sl.batchTransaction.next(!0),sl.batchTransaction.complete(),nl.next(!1),rl.next(!0))}}function ll(){return function(e,t,i){var r=i.value;return i.value=function(){for(var e=this,t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];return ol(function(){return r.apply(e,t)},this)},i}}function dl(t){return function(e){return e.pipe(eo(function(e){return ol(function(){return t(e)})}))}}var ul,cl,hl,pl=(vl.prototype.setLoading=function(t){(t=void 0===t?!1:t)!==this._value().loading&&(No&&Mo("Set Loading"),this._setState(function(e){return pt({},e,{loading:t})}))},vl.prototype.setHasCache=function(e,t){var i,r=this;void 0===t&&(t={restartTTL:!1}),e!==this.cache.active.value&&this.cache.active.next(e),t.restartTTL&&(i=this.getCacheTTL())&&(null!==this.cache.ttl&&clearTimeout(this.cache.ttl),this.cache.ttl=setTimeout(function(){return r.setHasCache(!1)},i))},vl.prototype.getValue=function(){return this.storeValue},vl.prototype.setError=function(t){t!==this._value().error&&(No&&Mo("Set Error"),this._setState(function(e){return pt({},e,{error:t})}))},vl.prototype._select=function(t){return this.store.asObservable().pipe(pr(function(e){return t(e.state)}),bs())},vl.prototype._value=function(){return this.storeValue},vl.prototype._cache=function(){return this.cache.active},Object.defineProperty(vl.prototype,"config",{get:function(){return this.constructor.akitaConfig||{}},enumerable:!0,configurable:!0}),Object.defineProperty(vl.prototype,"storeName",{get:function(){return this.config.storeName||this.options.storeName||this.options.name},enumerable:!0,configurable:!0}),Object.defineProperty(vl.prototype,"deepFreeze",{get:function(){return this.config.deepFreezeFn||this.options.deepFreezeFn||Wo},enumerable:!0,configurable:!0}),Object.defineProperty(vl.prototype,"cacheConfig",{get:function(){return this.config.cache||this.options.cache},enumerable:!0,configurable:!0}),Object.defineProperty(vl.prototype,"_producerFn",{get:function(){return this.config.producerFn||this.options.producerFn||Go.producerFn},enumerable:!0,configurable:!0}),Object.defineProperty(vl.prototype,"resettable",{get:function(){return(Uo(this.config.resettable)?this.config:this.options).resettable},enumerable:!0,configurable:!0}),vl.prototype._setState=function(e,t){var i,r=this;if(void 0===t&&(t=!0),Vo(e)?(i=e(this._value()),this.storeValue=No?this.deepFreeze(i):i):this.storeValue=e,!this.store)return this.store=new Si({state:this.storeValue}),void(No&&this.store.subscribe(function(e){var t=e.action;t&&(e=r.storeName,Jo.next({storeName:e,action:t}))}));al()?this.handleTransaction():this.dispatch(this.storeValue,t)},vl.prototype.reset=function(){var e=this;this.isResettable()?(No&&Mo("Reset"),this._setState(function(){return Object.assign({},e._initialState)}),this.setHasCache(!1)):No&&console.warn("You need to enable the reset functionality")},vl.prototype.update=function(e){No&&Mo("Update");var t=this._value(),e=Vo(e)?Vo(this._producerFn)?this._producerFn(t,e):e(t):e,e=this.akitaPreUpdate(t,pt({},t,e)),e=el(t)?e:new t.constructor(e);this._setState(e)},vl.prototype.updateStoreConfig=function(e){this.options=pt({},this.options,e)},vl.prototype.akitaPreUpdate=function(e,t){return t},vl.prototype.ngOnDestroy=function(){this.destroy()},vl.prototype.destroy=function(){var e;Lo&&window.hmrEnabled||this!==tl[this.storeName]||(delete tl[this.storeName],e=this.storeName,Yo.next(e),this.setHasCache(!1),this.cache.active.complete(),this.store.complete())},vl.prototype.onInit=function(e){var t,i;(tl[this.storeName]=this)._setState(function(){return e}),i=this.storeName,Xo.next(i),this.isResettable()&&(this._initialState=e),No&&(t=this.storeName,i=this.constructor.name,t||console.error("@StoreConfig({ name }) is missing in "+i))},vl.prototype.dispatch=function(e,t){var i=void 0;(t=void 0===t?!0:t)&&(i=Oo,Ao=!1),this.store.next({state:e,action:i})},vl.prototype.watchTransaction=function(){var e=this;(sl.batchTransaction?sl.batchTransaction.asObservable():Vi(!0)).subscribe(function(){e.inTransaction=!1,e.dispatch(e._value())})},vl.prototype.isResettable=function(){return!1!==this.resettable&&(this.resettable||Go.resettable)},vl.prototype.handleTransaction=function(){this.inTransaction||(this.watchTransaction(),this.inTransaction=!0)},vl.prototype.getCacheTTL=function(){return this.cacheConfig&&this.cacheConfig.ttl||Go.ttl},vl),fl=(ht(yl,hl=pl),Object.defineProperty(yl.prototype,"selectEntityAction$",{get:function(){return this.entityActions.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(yl.prototype,"selectEntityIdChanges$",{get:function(){return this.entityIdChanges.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(yl.prototype,"idKey",{get:function(){return this.config.idKey||this.options.idKey||"id"},enumerable:!0,configurable:!0}),yl.prototype.set=function(t,i){var r,n=this;void 0===i&&(i={}),xo(t)||(No&&Mo("Set Entity"),r=this.akitaPreAddEntity===yl.prototype.akitaPreAddEntity,this.setHasCache(!0,{restartTTL:!0}),this._setState(function(e){e=function(e){var t,i=e.state,r=e.entities,n=e.idKey,s=e.preAddEntity,e=e.isNativePreAdd;s=Bo(r)?(t=(n=function(e,t,i){var r,n,s={entities:{},ids:[]};try{for(var a=gt(e),o=a.next();!o.done;o=a.next()){var l=i(o.value);s.entities[l[t]]=l,s.ids.push(l[t])}}catch(e){r={error:e}}finally{try{o&&!o.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}return s}(r,n,s)).entities,n.ids):r.entities&&r.ids?(t=e?r.entities:Ho(r.entities,s),r.ids):(t=e?r:Ho(r,s),Object.keys(t).map(function(e){return isNaN(e)?e:Number(e)}));s=pt({},i,{entities:t,ids:s,loading:!1});return Qo(i)&&(s.active=jo(s)),s}({state:e,entities:t,idKey:n.idKey,preAddEntity:n.akitaPreAddEntity,isNativePreAdd:r});return!1===Ko(i.activeId)&&(e.active=i.activeId),e}),this.hasInitialUIState()&&this.handleUICreation(),this.entityActions.next({type:_o.Set,ids:this.ids}))},yl.prototype.add=function(e,t){void 0===t&&(t={loading:!1});var i,e=Do(e);$o(e)||(i=function(e){var t,i,r=e.state,n=e.entities,s=e.idKey,a=e.options,o=void 0===a?{}:a,l=e.preAddEntity,d={},u=[],c=!1;try{for(var h=gt(n),p=h.next();!p.done;p=h.next()){var f,m,g=p.value;!1===Po(r.entities,g[s])&&(d[m=(f=l(g))[s]]=f,o.prepend?u.unshift(m):u.push(m),c=!0)}}catch(e){t={error:e}}finally{try{p&&!p.done&&(i=h.return)&&i.call(h)}finally{if(t)throw t.error}}return c?{newState:pt({},r,{entities:pt({},r.entities,d),ids:o.prepend?vt(u,r.ids):vt(r.ids,u)}),newIds:u}:null}({state:this._value(),preAddEntity:this.akitaPreAddEntity,entities:e,idKey:this.idKey,options:t}))&&(No&&Mo("Add Entity"),i.newState.loading=t.loading,this._setState(function(){return i.newState}),this.hasInitialUIState()&&this.handleUICreation(!0),this.entityActions.next({type:_o.Add,ids:i.newIds}))},yl.prototype.update=function(t,i){var r,n,s=this;Ko(i)?hl.prototype.update.call(this,t):$o(n=Vo(t)?this.ids.filter(function(e){return t(s.entities[e])}):xo(t)?this.ids:Do(t))||(No&&Mo("Update Entity",n),this._setState(function(e){return function(e){var t=e.state,i=e.ids,r=e.idKey,n=e.newStateOrFn,s=e.preUpdateEntity,a=e.producerFn,o=e.onEntityIdChanges,l={},d=!1;try{for(var u=gt(i),c=u.next();!c.done;c=u.next()){var h,p,f,m,g,y,v=c.value;!1!==Po(t.entities,v)&&(h=t.entities[v],p=void 0,f=(p=Vo(n)?Vo(a)?a(h,n):n(h):n).hasOwnProperty(r)&&p[r]!==h[r],m=v,f&&(d=!0,m=p[r]),g=pt({},h,p),y=el(h)?g:new(el(p)?h:p).constructor(g),l[m]=s(h,y))}}catch(e){T={error:e}}finally{try{c&&!c.done&&(b=u.return)&&b.call(u)}finally{if(T)throw T.error}}var S,b=t.ids,T=t.entities;return d&&(S=yt(i,1)[0],T=function(e,t){var i={};for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(i[n[r]]=e[n[r]]);return i}(t.entities,["symbol"==typeof S?S:S+""]),b=t.ids.map(function(e){return e===S?m:e}),o(S,m)),pt({},t,{entities:pt({},T,l),ids:b})}({idKey:s.idKey,ids:n,preUpdateEntity:s.akitaPreUpdateEntity,state:e,newStateOrFn:i,producerFn:s._producerFn,onEntityIdChanges:function(e,t){r={oldId:e,newId:t},s.entityIdChanges.next(pt({},r,{pending:!0}))}})}),r&&this.entityIdChanges.next(pt({},r,{pending:!1})),this.entityActions.next({type:_o.Update,ids:n}))},yl.prototype.upsert=function(e,i,r,t){var n=this;void 0===t&&(t={});var s=Do(e),e=function(t){return function(e){return Po(n.entities,e)===t}},a=Vo(r)?t.baseClass:r?r.baseClass:void 0,o=Vo(a),t=s.filter(e(!0)),e=s.filter(e(!1)).map(function(e){var t="function"==typeof i?i({}):i,t=Vo(r)?r(e,t):t,t=pt({},t,((t={})[n.idKey]=e,t));return o?new a(t):t});this.update(t,i),this.add(e),No&&Co("Upsert Entity")},yl.prototype.upsertMany=function(e,t){var i,r;void 0===t&&(t={});var n=[],s=[],a={};try{for(var o=gt(e),l=o.next();!l.done;l=o.next()){var d,u,c,h,p,f,m=l.value,g=this.akitaPreCheckEntity(m),y=g[this.idKey];Po(this.entities,y)?(d=this._value().entities[y],u=pt({},this._value().entities[y],g),c=t.baseClass?new t.baseClass(u):u,f=(h=this.akitaPreUpdateEntity(d,c))[this.idKey],a[f]=h,s.push(f)):(p=t.baseClass?new t.baseClass(g):g,f=(h=this.akitaPreAddEntity(p))[this.idKey],n.push(f),a[f]=h)}}catch(e){i={error:e}}finally{try{l&&!l.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}No&&Co("Upsert Many"),this._setState(function(e){return pt({},e,{ids:n.length?vt(e.ids,n):e.ids,entities:pt({},e.entities,a),loading:!!t.loading})}),s.length&&this.entityActions.next({type:_o.Update,ids:s}),n.length&&this.entityActions.next({type:_o.Add,ids:n}),n.length&&this.hasUIStore()&&this.handleUICreation(!0)},yl.prototype.replace=function(e,t){var i,r,n=Do(e);if(!$o(n)){var s={};try{for(var a=gt(n),o=a.next();!o.done;o=a.next()){var l=o.value;t[this.idKey]=l,s[l]=t}}catch(e){i={error:e}}finally{try{o&&!o.done&&(r=a.return)&&r.call(a)}finally{if(i)throw i.error}}No&&Mo("Replace Entity",e),this._setState(function(e){return pt({},e,{entities:pt({},e.entities,s)})})}},yl.prototype.move=function(e,t){var i=this.ids.slice();i.splice(t<0?i.length+t:t,0,i.splice(e,1)[0]),No&&Mo("Move Entity"),this._setState(function(e){return pt({},e,{entities:pt({},e.entities),ids:i})})},yl.prototype.remove=function(t){var i,e,r=this;$o(this.ids)||(e=Uo(t),$o(i=Vo(t)?this.ids.filter(function(e){return t(r.entities[e])}):e?Do(t):this.ids)||(No&&Mo("Remove Entity",i),this._setState(function(e){return function(e){var t,i=e.state,r=e.ids;if(xo(r))return pt({},i,{entities:{},ids:[],active:qo(i.active)?[]:null});var n=i.entities,s={};try{for(var a=gt(i.ids),o=a.next();!o.done;o=a.next()){var l=o.value;!1===r.includes(l)&&(s[l]=n[l])}}catch(e){d={error:e}}finally{try{o&&!o.done&&(t=a.return)&&t.call(a)}finally{if(d)throw d.error}}var d=pt({},i,{entities:s,ids:i.ids.filter(function(e){return!1===r.includes(e)})});return Qo(i)&&(d.active=jo(d)),d}({state:e,ids:i})}),e||this.setHasCache(!1),this.handleUIRemove(i),this.entityActions.next({type:_o.Remove,ids:i})))},yl.prototype.updateActive=function(e){var t=Do(this.active);No&&Mo("Update Active",t),this.update(t,e)},yl.prototype.setActive=function(e){e=function(e,t,i){var r;if(Bo(e))r=e;else if(Fo(e)){if(xo(i))return;e=Object.assign({wrap:!0},e);var n=t.indexOf(i);if(e.prev){var s=0===n;if(s&&!e.wrap)return;r=s?t[t.length-1]:t[n-1]}else if(e.next){s=t.length===n+1;if(s&&!e.wrap)return;r=s?t[0]:t[n+1]}}else{if(e===i)return;r=e}return r}(e,this.ids,this.active);void 0!==e&&(No&&Mo("Set Active",e),this._setActive(e))},yl.prototype.addActive=function(e){var t=this,i=Do(e);$o(i)||i.every(function(e){return-1<t.active.indexOf(e)})||(No&&Mo("Add Active",e),this._setState(function(e){var t=Array.from(new Set(vt(e.active,i)));return pt({},e,{active:t})}))},yl.prototype.removeActive=function(e){var t=this,i=Do(e);$o(i)||i.some(function(e){return-1<t.active.indexOf(e)})&&(No&&Mo("Remove Active",e),this._setState(function(e){return pt({},e,{active:Array.isArray(e.active)?e.active.filter(function(e){return-1===i.indexOf(e)}):null})}))},yl.prototype.toggleActive=function(e){var i=this,t=Do(e),r=function(t){return function(e){return i.active.includes(e)===t}},e=t.filter(r(!0)),r=t.filter(r(!1));this.removeActive(e),this.addActive(r),No&&Co("Toggle Active")},yl.prototype.createUIStore=function(e,t){var i={name:"UI/"+this.storeName,idKey:this.idKey};return this.ui=new ml(e=void 0===e?{}:e,pt({},i,t=void 0===t?{}:t)),this.ui},yl.prototype.destroy=function(){hl.prototype.destroy.call(this),this.ui instanceof yl&&this.ui.destroy(),this.entityActions.complete()},yl.prototype.akitaPreUpdateEntity=function(e,t){return t},yl.prototype.akitaPreAddEntity=function(e){return e},yl.prototype.akitaPreCheckEntity=function(e){return e},Object.defineProperty(yl.prototype,"ids",{get:function(){return this._value().ids},enumerable:!0,configurable:!0}),Object.defineProperty(yl.prototype,"entities",{get:function(){return this._value().entities},enumerable:!0,configurable:!0}),Object.defineProperty(yl.prototype,"active",{get:function(){return this._value().active},enumerable:!0,configurable:!0}),yl.prototype._setActive=function(t){this._setState(function(e){return pt({},e,{active:t})})},yl.prototype.handleUICreation=function(e){var r=this,t=this.ids,n=Vo(this.ui._akitaCreateEntityFn),i=function(e){var t=r.entities[e],i=n?r.ui._akitaCreateEntityFn(t):r.ui._akitaCreateEntityFn;return pt(((e={})[r.idKey]=t[r.idKey],e),i)},i=((e=void 0===e?!1:e)?this.ids.filter(function(e){return Ko(r.ui.entities[e])}):t).map(i);e?this.ui.add(i):this.ui.set(i)},yl.prototype.hasInitialUIState=function(){return this.hasUIStore()&&!1===Ko(this.ui._akitaCreateEntityFn)},yl.prototype.handleUIRemove=function(e){this.hasUIStore()&&this.ui.remove(e)},yl.prototype.hasUIStore=function(){return this.ui instanceof ml},ft([ll(),mt("design:type",Function),mt("design:paramtypes",[Object,Object,Object,Object]),mt("design:returntype",void 0)],yl.prototype,"upsert",null),ft([ll(),mt("design:type",Function),mt("design:paramtypes",["function"==typeof(p="undefined"!=typeof T&&T)?p:Object]),mt("design:returntype",void 0)],yl.prototype,"toggleActive",null),yl),ml=(ht(gl,cl=fl),gl.prototype.setInitialEntityState=function(e){this._akitaCreateEntityFn=e},gl);function gl(e,t){return cl.call(this,e=void 0===e?{}:e,t=void 0===t?{}:t)||this}function yl(e,t){void 0===t&&(t={});e=hl.call(this,pt({},{entities:{},ids:[],loading:!0,error:null},e=void 0===e?{}:e),t)||this;return e.options=t,e.entityActions=new Jt,e.entityIdChanges=new Jt,e}function vl(e,t){this.options=t=void 0===t?{}:t,this.inTransaction=!1,this.cache={active:new Si(!1),ttl:null},this.onInit(e)}function Sl(){return bs(function(e,t){return e===t||!1!==Bo(e)&&!1!==Bo(t)&&(!(!$o(e)||!$o(t))||!bl(t,e)&&!1===bl(e,t))})}function bl(e,t){return t.some(function(t){return void 0===e.find(function(e){return e===t})})}function Tl(e){return"string"==typeof e}function Il(t,i){return function(e){e=e[t];if(!Ko(e))return i?Tl(i)?e[i]:i(e):e}}(e=ul=ul||{}).ASC="asc",e.DESC="desc";function El(e){return e.pipe(cn(function(e){return null!=e}))}var wl,Ol,Ti=(Ml.prototype.select=function(t){var e,n;if(Vo(t))e=t;else if(Tl(t))e=function(e){return e[t]};else{if(Array.isArray(t))return this.store._select(function(e){return e}).pipe(bs((n=t,function(t,i){var r=Vo(n[0]);return!1===n.some(function(e){return r?e(t)!==e(i):t[e]!==i[e]})})),pr(function(i){return Vo(t[0])?t.map(function(e){return e(i)}):t.reduce(function(e,t){return e[t]=i[t],e},{})}));e=function(e){return e}}return this.store._select(e)},Ml.prototype.selectLoading=function(){return this.select(function(e){return e.loading})},Ml.prototype.selectError=function(){return this.select(function(e){return e.error})},Ml.prototype.getValue=function(){return this.store._value()},Ml.prototype.selectHasCache=function(){return this.store._cache().asObservable()},Ml.prototype.getHasCache=function(){return this.store._cache().value},Object.defineProperty(Ml.prototype,"config",{get:function(){return this.constructor.akitaQueryConfig},enumerable:!0,configurable:!0}),Ml),Al=(ht(Cl,Ol=Ti),Cl.prototype.selectAll=function(e){var t=this;return void 0===e&&(e={asObject:!1}),this.select(function(e){return e.entities}).pipe(pr(function(){return t.getAll(e)}))},Cl.prototype.getAll=function(e){return(e=void 0===e?{asObject:!1,filterBy:void 0,limitTo:void 0}:e).asObject?function(e,t){var r={},n=t.filterBy,s=t.limitTo,a=e.ids,o=e.entities;if(!n&&!s)return o;e=!1===xo(s);if(n&&e)for(var l=0,i=0,d=a.length;i<d&&"break"!==function(t){if(l===s)return"break";var e=a[t],i=o[e];Do(n).every(function(e){return e(i,t)})&&(r[e]=i,l++)}(i);i++);else for(var u=Math.min(s||a.length,a.length),i=0;i<u;i++)!function(t){var e=a[t],i=o[e];if(!n)return r[e]=i;Do(n).every(function(e){return e(i,t)})&&(r[e]=i)}(i);return r}(this.getValue(),e):(t=e,i=this.config||this.options,t.sortBy=t.sortBy||i&&i.sortBy,t.sortByOrder=t.sortByOrder||i&&i.sortByOrder,function(i,e){for(var r,n,s,a=[],o=i.ids,l=i.entities,d=e.filterBy,t=e.limitTo,u=e.sortBy,e=e.sortByOrder,c=0;c<o.length;c++)!function(t){var i=l[o[t]];if(!d)return a.push(i);Do(d).every(function(e){return e(i,t)})&&a.push(i)}(c);u&&(s=Vo(u)?u:(r=u,void 0===(n=e)&&(n=ul.ASC),function(e,t){if(!e.hasOwnProperty(r)||!t.hasOwnProperty(r))return 0;var i="string"==typeof e[r]?e[r].toUpperCase():e[r],e="string"==typeof t[r]?t[r].toUpperCase():t[r],t=0;return e<i?t=1:i<e&&(t=-1),n==ul.DESC?-1*t:t}),a=a.sort(function(e,t){return s(e,t,i)}));t=Math.min(t||a.length,a.length);return t===a.length?a:a.slice(0,t)}(this.getValue(),e));var t,i},Cl.prototype.selectMany=function(e,i){return e&&e.length?this.select(function(e){return e.entities}).pipe(pr(function(t){return n=function(e){return Il(e,i)(t)},e.reduce(function(e,t,i,r){t=n(t);return void 0!==t&&e.push(t),e},[]);var n}),Sl()):Vi([])},Cl.prototype.selectEntity=function(e,t){var i=e;return Vo(e)&&(i=function(e,t){var i,r;try{for(var n=gt(Object.keys(t)),s=n.next();!s.done;s=n.next()){var a=s.value;if(!0===e(t[a]))return a}}catch(e){i={error:e}}finally{try{s&&!s.done&&(r=n.return)&&r.call(n)}finally{if(i)throw i.error}}}(e,this.getValue().entities)),this.select(function(e){return e.entities}).pipe(pr(Il(i,t)),bs())},Cl.prototype.getEntity=function(e){return this.getValue().entities[e]},Cl.prototype.selectActiveId=function(){return this.select(function(e){return e.active})},Cl.prototype.getActiveId=function(){return this.getValue().active},Cl.prototype.selectActive=function(t){var i=this;return Bo(this.getActive())?this.selectActiveId().pipe(La(function(e){return i.selectMany(e,t)})):this.selectActiveId().pipe(La(function(e){return i.selectEntity(e,t)}))},Cl.prototype.getActive=function(){var t=this,e=this.getActiveId();return Bo(e)?e.map(function(e){return t.getValue().entities[e]}):Zo(e)?this.getEntity(e):void 0},Cl.prototype.selectCount=function(e){var t=this;return this.select(function(e){return e.entities}).pipe(pr(function(){return t.getCount(e)}))},Cl.prototype.getCount=function(e){return(Vo(e)?this.getAll().filter(e):this.getValue().ids).length},Cl.prototype.selectLast=function(e){return this.selectAt(function(e){return e[e.length-1]},e)},Cl.prototype.selectFirst=function(e){return this.selectAt(function(e){return e[0]},e)},Cl.prototype.selectEntityAction=function(e){if(xo(e))return this.store.selectEntityAction$;var t=Bo(e)?function(e){return e}:function(e){return e.ids},i=Do(e);return this.store.selectEntityAction$.pipe(cn(function(e){e=e.type;return i.includes(e)}),pr(function(e){return t(e)}))},Cl.prototype.hasEntity=function(e){var t=this;return xo(e)?0<this.getValue().ids.length:Vo(e)?this.getAll().some(e):Bo(e)?e.every(function(e){return e in t.getValue().entities}):e in this.getValue().entities},Cl.prototype.hasActive=function(e){var t=this.getValue().active,i=Uo(e);return Array.isArray(t)?i?t.includes(e):0<t.length:i?t===e:Uo(t)},Cl.prototype.createUIQuery=function(){this.ui=new Rl(this.__store__.ui)},Cl.prototype.selectAt=function(e,t){var i=this;return this.select(function(e){return e.ids}).pipe(pr(e),bs(),La(function(e){return i.selectEntity(e,t)}))},Cl),Rl=(ht(kl,wl=Al),kl);function kl(e){return wl.call(this,e)||this}function Cl(e,t){void 0===t&&(t={});var i=Ol.call(this,e)||this;return i.options=t,i.__store__=e,i}function Ml(e){this.store=e,this.__store__=e,No&&(il[e.storeName]=this)}function Pl(e,t){return 1===t.split(".").length?e:t.split(".").slice(1).join(".").split(".").reduce(function(e,t){return e&&e[t]},e)}function xl(e,t,r){var i=t.split(".");if(1===i.length)return pt({},e,r);e=pt({},e);var n=i.length-2;return t.split(".").slice(1).reduce(function(e,t,i){return e[t]=i!==n?pt({},e[t]):Array.isArray(e[t])||!Fo(e[t])?r:pt({},e[t],r),e&&e[t]},e),e}new Zi(1);var Dl,_l,Ll,Nl,f=(Bl.prototype.getQuery=function(){return this.query},Bl.prototype.getStore=function(){return this.getQuery().__store__},Bl.prototype.isEntityBased=Zo,Bl.prototype.selectSource=function(e,t){var i=this;return this.isEntityBased(e)?this.getQuery().selectEntity(e).pipe(El):t?this.getQuery().select(function(e){return Pl(e,i.withStoreName(t))}):this.getQuery().select()},Bl.prototype.getSource=function(e,t){if(this.isEntityBased(e))return this.getQuery().getEntity(e);e=this.getQuery().getValue();return t?Pl(e,this.withStoreName(t)):e},Bl.prototype.withStoreName=function(e){return this.storeName+"."+e},Object.defineProperty(Bl.prototype,"storeName",{get:function(){return this.getStore().storeName},enumerable:!0,configurable:!0}),Bl.prototype.updateStore=function(t,e,i){var r=this;this.isEntityBased(e)?this.getStore().update(e,t):i?this.getStore()._setState(function(e){return xl(e,r.withStoreName(i),t)}):this.getStore()._setState(function(e){return pt({},e,t)})},Bl.prototype.onReset=function(i){var r=this,n=this.getStore().reset;this.getStore().reset=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];setTimeout(function(){n.apply(r.getStore(),e),i()})}},Bl),Fl={pagesControls:!1,range:!1,startWith:1,cacheTimeout:void 0,clearStoreWithCache:!0};function Bl(e,t){this.query=e}function Ul(e,t,i){void 0===i&&(i={});var r=Dl.call(this,e)||this;return r.query=e,r.factoryFnOrPath=t,r.params=i,r.params=pt({debounceTime:300,formKey:"akitaForm",emitEvent:!1,arrControlFactory:function(e){return r.builder.control(e)}},i),r.isRootKeys=!1===Zo(t),r.isKeyBased=Tl(t)||r.isRootKeys,r}function $l(e,t){void 0===t&&(t={});var i=_l.call(this,e,{resetFn:function(){i.initial=!1,i.destroy({clearCache:!0,currentPage:1})}})||this;i.query=e,i.config=t,i.metadata=new Map,i.pages=new Map,i.pagination={currentPage:1,perPage:0,total:0,lastPage:0,data:[]},i.initial=!0,i.isLoading$=i.query.selectLoading().pipe(function(t){void 0===t&&(t=rr);var i=ls(0)?0-t.now():Math.abs(0);return function(e){return e.lift(new cs(i,t))}}()),i.config=Object.assign(Fl,t);e=i.config,t=e.startWith,e=e.cacheTimeout;return i.page=new Si(t),e&&(e instanceof Kt||"function"==typeof e.lift&&"function"==typeof e.subscribe)&&(i.clearCacheSubscription=e.subscribe(function(){return i.clearCache()})),i}ht($l,_l=f),Object.defineProperty($l.prototype,"pageChanges",{get:function(){return this.page.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty($l.prototype,"currentPage",{get:function(){return this.pagination.currentPage},enumerable:!0,configurable:!0}),Object.defineProperty($l.prototype,"isFirst",{get:function(){return 1===this.currentPage},enumerable:!0,configurable:!0}),Object.defineProperty($l.prototype,"isLast",{get:function(){return this.currentPage===this.pagination.lastPage},enumerable:!0,configurable:!0}),$l.prototype.withControls=function(){return this.config.pagesControls=!0,this},$l.prototype.withRange=function(){return this.config.range=!0,this},$l.prototype.setLoading=function(e){void 0===e&&(e=!0),this.getStore().setLoading(e)},$l.prototype.update=function(e){this.pagination=e,this.addPage(e.data)},$l.prototype.addPage=function(e){var t=this;this.pages.set(this.currentPage,{ids:e.map(function(e){return e[t.getStore().idKey]})}),this.getStore().upsertMany(e)},$l.prototype.clearCache=function(e){void 0===e&&(e={}),this.initial||(Co("@Pagination - Clear Cache"),!1!==e.clearStore&&(this.config.clearStoreWithCache||e.clearStore)&&this.getStore().remove(),this.pages=new Map,this.metadata=new Map),this.initial=!1},$l.prototype.clearPage=function(e){this.pages.delete(e)},$l.prototype.destroy=function(e){var t=void 0===e?{}:e,e=t.clearCache,t=t.currentPage;this.clearCacheSubscription&&this.clearCacheSubscription.unsubscribe(),e&&this.clearCache(),Ko(t)||this.setPage(t),this.initial=!0},$l.prototype.isPageActive=function(e){return this.currentPage===e},$l.prototype.setPage=function(e){e===this.currentPage&&this.hasPage(e)||this.page.next(this.pagination.currentPage=e)},$l.prototype.nextPage=function(){this.currentPage!==this.pagination.lastPage&&this.setPage(this.pagination.currentPage+1)},$l.prototype.prevPage=function(){1<this.pagination.currentPage&&this.setPage(this.pagination.currentPage-1)},$l.prototype.setLastPage=function(){this.setPage(this.pagination.lastPage)},$l.prototype.setFirstPage=function(){this.setPage(1)},$l.prototype.hasPage=function(e){return this.pages.has(e)},$l.prototype.getPage=function(e){var t=this,i=this.pagination.currentPage;return this.hasPage(i)?this.selectPage(i):(this.setLoading(!0),Br(e()).pipe(La(function(e){return i=e.currentPage,ol(function(){t.setLoading(!1),t.update(e)}),t.selectPage(i)})))},$l.prototype.getQuery=function(){return this.query},$l.prototype.refreshCurrentPage=function(){!1===xo(this.currentPage)&&(this.clearPage(this.currentPage),this.setPage(this.currentPage))},$l.prototype.getFrom=function(){return this.isFirst?1:(this.currentPage-1)*this.pagination.perPage+1},$l.prototype.getTo=function(){return this.isLast?this.pagination.total:this.currentPage*this.pagination.perPage},$l.prototype.selectPage=function(n){var s=this;return this.query.selectAll({asObject:!0}).pipe(As(1),pr(function(t){var e=pt({},s.pagination,{data:s.pages.get(n).ids.map(function(e){return t[e]})}),i=s.config,r=i.range,i=i.pagesControls;return isNaN(s.pagination.total)&&(1===e.lastPage?e.total=e.data?e.data.length:0:e.total=e.perPage*e.lastPage,s.pagination.total=e.total),r&&(e.from=s.getFrom(),e.to=s.getTo()),i&&(e.pageControls=function(e,t){for(var i=Math.ceil(e/t),r=[],n=0;n<i;n++)r.push(n+1);return r}(s.pagination.total,s.pagination.perPage)),e}))},ft([(Ll="@Pagination - New Page",function(e,t,i){var r=i.value;return i.value=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Co(Ll,Nl),r.apply(this,e)},i}),mt("design:type",Function),mt("design:paramtypes",[Object]),mt("design:returntype",void 0)],$l.prototype,"update",null),ht(Ul,Dl=f),Ul.prototype.setForm=function(e,t){return this.form=e,this.builder=t,this.activate(),this},Ul.prototype.reset=function(e){var r=this,e=e||(this.isKeyBased?this.initialValue:this.factoryFnOrPath());this.isKeyBased&&Object.keys(this.initialValue).forEach(function(i){var e,t=r.initialValue[i];Array.isArray(t)&&r.builder&&(e=r.form.controls[i],r.cleanArray(e),t.forEach(function(e,t){r.form.get(i).insert(t,r.params.arrControlFactory(e))}))}),this.form.patchValue(e,{emitEvent:this.params.emitEvent});var t=this.isKeyBased?xl(this.getQuery().getValue(),this.getStore().storeName+"."+this.factoryFnOrPath,e):((t={})[this.params.formKey]=e,t);this.updateStore(t)},Ul.prototype.cleanArray=function(e){for(;0!==e.length;)e.removeAt(0)},Ul.prototype.resolveInitialValue=function(e,n){var s=this;if(e)return Object.keys(e).reduce(function(e,i){var r,t=n[i];return Array.isArray(t)&&s.builder&&(r=s.params.arrControlFactory,s.cleanArray(s.form.get(i)),t.forEach(function(e,t){s.form.get(i).insert(t,r(e))})),e[i]=n[i],e},{})},Ul.prototype.activate=function(){var i,e,t,r=this;this.isKeyBased?(this.isRootKeys?this.initialValue=this.resolveInitialValue(this.form.value,this.getQuery().getValue()):(i=this.getStore().storeName+"."+this.factoryFnOrPath,e=Pl(this.getQuery().getValue(),i),this.initialValue=this.resolveInitialValue(e,e)),this.form.patchValue(this.initialValue,{emitEvent:this.params.emitEvent})):(this.getQuery().getValue()[this.params.formKey]||(Co("@PersistNgFormPlugin activate"),this.updateStore(((t={})[this.params.formKey]=this.factoryFnOrPath(),t))),t=this.getQuery().getValue()[this.params.formKey],this.form.patchValue(t)),this.formChanges=this.form.valueChanges.pipe(Yn(this.params.debounceTime)).subscribe(function(t){var e;Co("@PersistForm - Update"),e=r.isKeyBased?r.isRootKeys?function(e){return pt({},e,t)}:function(e){return xl(e,i,t)}:function(){var e;return(e={})[r.params.formKey]=t,e},r.updateStore(e(r.getQuery().getValue()))})},Ul.prototype.destroy=function(){this.formChanges&&this.formChanges.unsubscribe(),this.form=null,this.builder=null};var Vl,Kl,Kr=(jl.prototype.getEntity=function(e){return this.entities.get(e)},jl.prototype.hasEntity=function(e){return this.entities.has(e)},jl.prototype.removeEntity=function(e){return this.destroy(e),this.entities.delete(e)},jl.prototype.createEntity=function(e,t){return this.entities.set(e,t)},jl.prototype.getIds=function(){return Ko(this.entityIds)?this.query.getValue().ids:Do(this.entityIds)},jl.prototype.resolvedIds=function(e){return Ko(e)?this.getIds():Do(e)},jl.prototype.rebase=function(i,r){var n=this;if(void 0===r&&(r={}),Zo(i))if(Ko(this.entityIds)){for(var e=0,t=i.length;e<t;e++){var s,a=i[e];!1===this.hasEntity(a)&&(Vo(r.beforeAdd)&&r.beforeAdd(a),s=this.instantiatePlugin(a),this.entities.set(a,s),Vo(r.afterAdd)&&r.afterAdd(s))}this.entities.forEach(function(e,t){-1===i.indexOf(t)&&(Vo(r.beforeRemove)&&r.beforeRemove(e),n.removeEntity(t))})}else for(var o=Do(this.entityIds),e=0,t=o.length;e<t;e++)a=o[e],-1<i.indexOf(a)&&!1===this.hasEntity(a)?(Vo(r.beforeAdd)&&r.beforeAdd(a),s=this.instantiatePlugin(a),this.entities.set(a,s),Vo(r.afterAdd)&&r.afterAdd(s)):this.entities.forEach(function(e,t){-1===i.indexOf(t)&&!0===n.hasEntity(t)&&(Vo(r.beforeRemove)&&r.beforeRemove(e),n.removeEntity(t))});else this.getIds().forEach(function(e){n.hasEntity(e)||n.createEntity(e,n.instantiatePlugin(e))})},jl.prototype.selectIds=function(){return this.query.select(function(e){return e.ids})},jl.prototype.activate=function(e){this.rebase(e)},jl.prototype.forEachId=function(e,t){for(var i=this.resolvedIds(e),r=0,n=i.length;r<n;r++){var s=i[r];this.hasEntity(s)&&t(this.getEntity(s))}},jl),Ql=(ht(ql,Vl=f),Object.defineProperty(ql.prototype,"hasPast$",{get:function(){return this._hasPast$},enumerable:!0,configurable:!0}),Object.defineProperty(ql.prototype,"hasFuture$",{get:function(){return this._hasFuture$},enumerable:!0,configurable:!0}),Object.defineProperty(ql.prototype,"hasPast",{get:function(){return 0<this.history.past.length},enumerable:!0,configurable:!0}),Object.defineProperty(ql.prototype,"hasFuture",{get:function(){return 0<this.history.future.length},enumerable:!0,configurable:!0}),Object.defineProperty(ql.prototype,"property",{get:function(){return this.params.watchProperty},enumerable:!0,configurable:!0}),ql.prototype.updateHasHistory=function(){this.hasFutureSubject.next(this.hasFuture),this.hasPastSubject.next(this.hasPast)},ql.prototype.activate=function(){var r=this;this.hasPastSubject=new Si(!1),this._hasPast$=this.hasPastSubject.asObservable().pipe(bs()),this.hasFutureSubject=new Si(!1),this._hasFuture$=this.hasFutureSubject.asObservable().pipe(bs()),this.history.present=this.getSource(this._entityId,this.property),this.subscription=this.selectSource(this._entityId,this.property).pipe(da()).subscribe(function(e){var t=yt(e,2),i=t[0],e=t[1];r.skip?r.skip=!1:(t=r.params.comparator(i,e),!r.skipUpdate&&t&&(r.history.past.length===r.params.maxAge&&(r.history.past=r.history.past.slice(1)),r.history.past=vt(r.history.past,[i]),r.history.present=e,r.updateHasHistory()))})},ql.prototype.undo=function(){var e,t,i;0<this.history.past.length&&(e=(i=this.history).past,t=i.present,i=e[e.length-1],this.history.past=e.slice(0,e.length-1),this.history.present=i,this.history.future=vt([t],this.history.future),this.update())},ql.prototype.redo=function(){var e,t,i,r;0<this.history.future.length&&(e=(r=this.history).past,t=r.present,i=this.history.future[0],r=this.history.future.slice(1),this.history.past=vt(e,[t]),this.history.present=i,this.history.future=r,this.update("Redo"))},ql.prototype.jumpToPast=function(e){var t,i,r,n;e<0||e>=this.history.past.length||(t=(r=this.history).past,n=r.future,i=r.present,r=t.slice(0,e),n=vt(t.slice(e+1),[i],n),e=t[e],this.history.past=r,this.history.present=e,this.history.future=n,this.update())},ql.prototype.jumpToFuture=function(e){var t,i,r;e<0||e>=this.history.future.length||(i=(r=this.history).past,t=r.future,i=vt(i,[r.present],t.slice(0,e)),r=t[e],e=t.slice(e+1),this.history.past=i,this.history.present=r,this.history.future=e,this.update("Redo"))},ql.prototype.jump=function(e){return 0<e?this.jumpToFuture(e-1):e<0?this.jumpToPast(this.history.past.length+e):void 0},ql.prototype.clear=function(e){this.history=Vo(e)?e(this.history):{past:[],present:null,future:[]},this.updateHasHistory()},ql.prototype.destroy=function(e){(e=void 0===e?!1:e)&&this.clear(),this.subscription.unsubscribe()},ql.prototype.ignoreNext=function(){this.skip=!0},ql.prototype.update=function(e){void 0===e&&(e="Undo"),this.skipUpdate=!0,Co("@StateHistory - "+e),this.updateStore(this.history.present,this._entityId,this.property),this.updateHasHistory(),this.skipUpdate=!1},ql);function ql(e,t,i){void 0===t&&(t={});var r=Vl.call(this,e,{resetFn:function(){return r.clear()}})||this;return r.query=e,r.params=t,r._entityId=i,r.skip=!1,r.history={past:[],present:null,future:[]},r.skipUpdate=!1,t.maxAge=t.maxAge||10,t.comparator=t.comparator||function(){return!0},r.activate(),r}function jl(e,t){this.query=e,this.entityIds=t,this.entities=new Map}function Hl(e,t){var i=Kl.call(this,e,(t=void 0===t?{}:t).entityIds)||this;return i.query=e,(i.params=t).maxAge=Zo(t.maxAge)?t.maxAge:10,i.activate(),i.selectIds().pipe(ka(1)).subscribe(function(e){return i.activate(e)}),i}ht(Hl,Kl=Kr),Hl.prototype.redo=function(e){this.forEachId(e,function(e){return e.redo()})},Hl.prototype.undo=function(e){this.forEachId(e,function(e){return e.undo()})},Hl.prototype.hasPast=function(e){if(this.hasEntity(e))return this.getEntity(e).hasPast},Hl.prototype.hasFuture=function(e){if(this.hasEntity(e))return this.getEntity(e).hasFuture},Hl.prototype.jumpToFuture=function(e,t){this.forEachId(e,function(e){return e.jumpToFuture(t)})},Hl.prototype.jumpToPast=function(e,t){this.forEachId(e,function(e){return e.jumpToPast(t)})},Hl.prototype.clear=function(e){this.forEachId(e,function(e){return e.clear()})},Hl.prototype.destroy=function(e,t){void 0===t&&(t=!1),this.forEachId(e,function(e){return e.destroy(t)})},Hl.prototype.ignoreNext=function(e){this.forEachId(e,function(e){return e.ignoreNext()})},Hl.prototype.instantiatePlugin=function(e){return new Ql(this.query,this.params,e)};var Gl={comparator:function(e,t){return JSON.stringify(e)!==JSON.stringify(t)}};function Wl(e,t){return t.split(".").reduce(function(e,t){return e&&"undefined"!==e[t]?e[t]:void 0},e)}var zl,Yl,Xl=(ht(Jl,zl=f),Jl.prototype.reset=function(e){var t=this.head;Vo((e=void 0===e?{}:e).updateFn)&&(t=this.isEntityBased(this._entityId)?e.updateFn(this.head,this.getQuery().getEntity(this._entityId)):e.updateFn(this.head,this.getQuery().getValue())),Co("@DirtyCheck - Revert"),this.updateStore(t,this._entityId),this._reset.next()},Jl.prototype.setHead=function(){return this.active?this.head=this._getHead():(this.activate(),this.active=!0),this.updateDirtiness(!1),this},Jl.prototype.isDirty=function(){return!!this.dirty.value},Jl.prototype.hasHead=function(){return!!this.getHead()},Jl.prototype.destroy=function(){this.head=null,this.subscription&&this.subscription.unsubscribe(),this._reset&&this._reset.complete()},Jl.prototype.isPathDirty=function(e){var t=this.getHead(),i=Wl(this.getQuery().getValue(),e),e=Wl(t,e);return this.params.comparator(i,e)},Jl.prototype.getHead=function(){return this.head},Jl.prototype.activate=function(){var i=this;this.head=this._getHead();var e=this.params.watchProperty?this.params.watchProperty.map(function(t){return i.query.select(function(e){return e[t]}).pipe(pr(function(e){return{val:e,__akitaKey:t}}))}):[this.selectSource(this._entityId)];this.subscription=Pr.apply(void 0,vt(e)).pipe(ka(1)).subscribe(function(e){Ko(i.head)||(e=e.some(function(e){var t=e.__akitaKey?i.head[e.__akitaKey]:i.head,e=e.__akitaKey?e.val:e;return i.params.comparator(t,e)}),i.updateDirtiness(e))})},Jl.prototype.updateDirtiness=function(e){this.dirty.next(e)},Jl.prototype._getHead=function(){var e=this.getSource(this._entityId);return e=this.params.watchProperty?this.getWatchedValues(e):e},Jl.prototype.getWatchedValues=function(i){return this.params.watchProperty.reduce(function(e,t){return e[t]=i[t],e},{})},Jl);function Jl(e,t,i){var r=zl.call(this,e)||this;return r.query=e,r.params=t,r._entityId=i,r.dirty=new Si(!1),r.active=!1,r._reset=new Jt,r.isDirty$=r.dirty.asObservable().pipe(bs()),r.reset$=r._reset.asObservable(),r.params=pt({},Gl,t),r.params.watchProperty&&(t=Do(r.params.watchProperty),e instanceof Al&&t.includes("entities")&&!t.includes("ids")&&t.push("ids"),r.params.watchProperty=t),r}function Zl(){return Math.random().toString(36).slice(2)}function ed(e,t,i,r){var n,s;return void 0===r&&(r="id"),s=Vo(t)?t:(n=Do(t),function(e){return!0===n.includes(Fo(e)?e[r]:e)}),e.map(function(e,t){return!0===s(e,t)?Fo(e)?pt({},e,i):i:e})}function td(e,t,i){void 0===i&&(i={});t=Do(t),e=e||[];return i.prepend?vt(t,e):vt(e,t)}function id(e,t,i){var r,n;if(void 0===i&&(i="id"),t=Vo(t)?(n=t,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return!n.apply(void 0,vt(e))}):(r=Do(t),function(e){return!1===r.includes(Fo(e)?e[i]:e)}),Array.isArray(e))return e.filter(t)}function rd(e){return Pr(e).pipe(Kn(0))}function nd(e,t){var i=Yl.call(this,e,(t=void 0===t?{}:t).entityIds)||this;return i.query=e,i.params=t,i._someDirty=new Jt,i.someDirty$=dn(i.query.select(function(e){return e.entities}),i._someDirty.asObservable()).pipe(Kn(0),pr(function(){return i.checkSomeDirty()})),i.params=pt({},Gl,t),i.activate(),i.selectIds().pipe(ka(1)).subscribe(function(e){Yl.prototype.rebase.call(i,e,{afterAdd:function(e){return e.setHead()}})}),i}ht(nd,Yl=Kr),nd.prototype.setHead=function(e){if(this.params.entityIds&&e){var t=Do(e);if(!1===Do(this.params.entityIds).some(function(e){return-1<t.indexOf(e)}))return this}return this.forEachId(e,function(e){return e.setHead()}),this._someDirty.next(),this},nd.prototype.hasHead=function(e){return!!this.entities.has(e)&&this.getEntity(e).hasHead()},nd.prototype.reset=function(e,t){void 0===t&&(t={}),this.forEachId(e,function(e){return e.reset(t)})},nd.prototype.isDirty=function(e,t){if(void 0===t&&(t=!0),this.entities.has(e)){e=this.getEntity(e);return t?e.isDirty$:e.isDirty()}return!1},nd.prototype.someDirty=function(){return this.checkSomeDirty()},nd.prototype.isPathDirty=function(e,t){if(this.entities.has(e)){var i=this.getEntity(e).getHead(),e=Wl(this.query.getEntity(e),t),t=Wl(i,t);return this.params.comparator(e,t)}return null},nd.prototype.destroy=function(e){this.forEachId(e,function(e){return e.destroy()}),e||this._someDirty.complete()},nd.prototype.instantiatePlugin=function(e){return new Xl(this.query,this.params,e)},nd.prototype.checkSomeDirty=function(){var e,t,i=this.resolvedIds();try{for(var r=gt(i),n=r.next();!n.done;n=r.next()){var s=n.value;if(this.getEntity(s).isDirty())return!0}}catch(t){e={error:t}}finally{try{n&&!n.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}return!1},(nu=nu||{}).Update="UPDATE",{}[nu.Update]="update",(Sr=au=au||{}).Update="UPDATE",Sr.AddEntities="ADD_ENTITIES",Sr.SetEntities="SET_ENTITIES",Sr.UpdateEntities="UPDATE_ENTITIES",Sr.RemoveEntities="REMOVE_ENTITIES",Sr.UpsertEntities="UPSERT_ENTITIES",Sr.UpsertManyEntities="UPSERT_MANY_ENTITIES",(su={})[au.Update]="update",su[au.AddEntities]="add",su[au.SetEntities]="set",su[au.UpdateEntities]="update",su[au.RemoveEntities]="remove",su[au.UpsertEntities]="upsert",su[au.UpsertManyEntities]="upsertMany";p={};Object.defineProperty(p,"__esModule",{value:!0});var e="undefined"!=typeof Symbol&&"symbol"==typeof Symbol("x"),sd="undefined"!=typeof Map,ad="undefined"!=typeof Set,od="undefined"!=typeof Proxy&&void 0!==Proxy.revocable&&"undefined"!=typeof Reflect,ld=e?Symbol.for("immer-nothing"):((ou={})["immer-nothing"]=!0,ou),dd=e?Symbol.for("immer-draftable"):"__$immer_draftable",ud=e?Symbol.for("immer-state"):"__$immer_state",cd="undefined"!=typeof Symbol&&Symbol.iterator||"@@iterator",hd={0:"Illegal state",1:"Immer drafts cannot have computed properties",2:"This object has been frozen and should not be mutated",3:function(e){return"Cannot use a proxy that has been revoked. Did you pass an object from inside an immer function to an async process? "+e},4:"An immer producer returned a new value *and* modified its draft. Either return a new value *or* modify the draft.",5:"Immer forbids circular references",6:"The first or second argument to `produce` must be a function",7:"The third argument to `produce` must be a function or undefined",8:"First argument to `createDraft` must be a plain object, an array, or an immerable object",9:"First argument to `finishDraft` must be a draft returned by `createDraft`",10:"The given draft is already finalized",11:"Object.defineProperty() cannot be used on an Immer draft",12:"Object.setPrototypeOf() cannot be used on an Immer draft",13:"Immer only supports deleting array indices",14:"Immer only supports setting array indices and the 'length' property",15:function(e){return"Cannot apply patch, path doesn't resolve: "+e},16:'Sets cannot have "replace" patches.',17:function(e){return"Unsupported patch operation: "+e},18:function(e){return"The plugin for '"+e+"' has not been loaded into Immer. To enable the plugin, import and call `enable"+e+"()` when initializing your application."},20:"Cannot use proxies if Proxy, Proxy.revocable or Reflect are not available",21:function(e){return"produce can only be called on things that are draftable: plain objects, arrays, Map, Set or classes that are marked with '[immerable]: true'. Got '"+e+"'"},22:function(e){return"'current' expects a draft, got: "+e},23:function(e){return"'original' expects a draft, got: "+e}};function pd(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];var n=hd[e],e=n?"function"==typeof n?n.apply(null,i):n:"unknown error nr: "+e;throw new Error("[Immer] "+e)}function fd(e){return!!e&&!!e[ud]}function md(t){return!!t&&(function(){if(!t||"object"!=typeof t)return!1;var e=Object.getPrototypeOf(t);return!e||e===Object.prototype}()||Array.isArray(t)||!!t[dd]||!!t.constructor[dd]||wd(t)||Od(t))}var gd="undefined"!=typeof Reflect&&Reflect.ownKeys?Reflect.ownKeys:void 0!==Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Object.getOwnPropertyNames,yd=Object.getOwnPropertyDescriptors||function(t){var i={};return gd(t).forEach(function(e){i[e]=Object.getOwnPropertyDescriptor(t,e)}),i};function vd(i,r,t){void 0===t&&(t=!1),0===Sd(i)?(t?Object.keys:gd)(i).forEach(function(e){t&&"symbol"==typeof e||r(e,i[e],i)}):i.forEach(function(e,t){return r(t,e,i)})}function Sd(e){var t=e[ud];return t?3<t.type_?t.type_-4:t.type_:Array.isArray(e)?1:wd(e)?2:Od(e)?3:0}function bd(e,t){return 2===Sd(e)?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function Td(e,t){return 2===Sd(e)?e.get(t):e[t]}function Id(e,t,i){var r=Sd(e);2===r?e.set(t,i):3===r?(e.delete(t),e.add(i)):e[t]=i}function Ed(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}function wd(e){return sd&&e instanceof Map}function Od(e){return ad&&e instanceof Set}function Ad(e){return e.copy_||e.base_}function Rd(e){if(Array.isArray(e))return Array.prototype.slice.call(e);var t=yd(e);delete t[ud];for(var i=gd(t),r=0;r<i.length;r++){var n=i[r],s=t[n];!1===s.writable&&(s.writable=!0,s.configurable=!0),(s.get||s.set)&&(t[n]={configurable:!0,writable:!0,enumerable:s.enumerable,value:e[n]})}return Object.create(Object.getPrototypeOf(e),t)}function kd(e,t){Md(e)||fd(e)||!md(e)||(1<Sd(e)&&(e.set=e.add=e.clear=e.delete=Cd),Object.freeze(e),t&&vd(e,function(e,t){return kd(t,!0)},!0))}function Cd(){pd(2)}function Md(e){return null==e||"object"!=typeof e||Object.isFrozen(e)}var Pd,xd={};function Dd(e){var t=xd[e];return t||pd(18,e),t}function _d(e,t){xd[e]||(xd[e]=t)}function Ld(){return Pd||pd(0),Pd}function Nd(e,t){t&&(Dd("Patches"),e.patches_=[],e.inversePatches_=[],e.patchListener_=t)}function Fd(e){Bd(e),e.drafts_.forEach($d),e.drafts_=null}function Bd(e){e===Pd&&(Pd=e.parent_)}function Ud(e){return Pd={drafts_:[],parent_:Pd,immer_:e,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function $d(e){e=e[ud];0===e.type_||1===e.type_?e.revoke_():e.revoked_=!0}function Vd(e,t){t.unfinalizedDrafts_=t.drafts_.length;var i=t.drafts_[0],r=void 0!==e&&e!==i;return t.immer_.useProxies_||Dd("ES5").willFinalizeES5_(t,e,r),r?(i[ud].modified_&&(Fd(t),pd(4)),md(e)&&(e=Kd(t,e),t.parent_||qd(t,e)),t.patches_&&Dd("Patches").generateReplacementPatches_(i[ud],e,t.patches_,t.inversePatches_)):e=Kd(t,i,[]),Fd(t),t.patches_&&t.patchListener_(t.patches_,t.inversePatches_),e!==ld?e:void 0}function Kd(i,r,n){if(Md(r))return r;var s,a=r[ud];return a?a.scope_!==i?r:a.modified_?(a.finalized_||(a.finalized_=!0,a.scope_.unfinalizedDrafts_--,s=4===a.type_||5===a.type_?a.copy_=Rd(a.draft_):a.copy_,vd(3===a.type_?new Set(s):s,function(e,t){return Qd(i,a,s,e,t,n)}),qd(i,s,!1),n&&i.patches_&&Dd("Patches").generatePatches_(a,n,i.patches_,i.inversePatches_)),a.copy_):(qd(i,a.base_,!0),a.base_):(vd(r,function(e,t){return Qd(i,a,r,e,t,n)},!0),r)}function Qd(e,t,i,r,n,s){if(n===i&&pd(5),fd(n)){s=Kd(e,n,s&&t&&3!==t.type_&&!bd(t.assigned_,r)?s.concat(r):void 0);if(Id(i,r,s),!fd(s))return;e.canAutoFreeze_=!1}md(n)&&!Md(n)&&(!e.immer_.autoFreeze_&&e.unfinalizedDrafts_<1||(Kd(e,n),t&&t.scope_.parent_||qd(e,n)))}function qd(e,t,i){void 0===i&&(i=!1),e.immer_.autoFreeze_&&e.canAutoFreeze_&&kd(t,i)}var jd={get:function(e,t){if(t===ud)return e;var i,r,n=Ad(e);if(!bd(n,t))return i=e,(r=Wd(n,t))?"value"in r?r.value:null===(r=r.get)||void 0===r?void 0:r.call(i.draft_):void 0;n=n[t];return!e.finalized_&&md(n)&&n===Gd(e.base_,t)?(Yd(e),e.copy_[t]=Jd(e.scope_.immer_,n,e)):n},has:function(e,t){return t in Ad(e)},ownKeys:function(e){return Reflect.ownKeys(Ad(e))},set:function(e,t,i){var r=Wd(Ad(e),t);if(null!=r&&r.set)return r.set.call(e.draft_,i),!0;if(!e.modified_){var n=Gd(Ad(e),t),r=null==n?void 0:n[ud];if(r&&r.base_===i)return e.copy_[t]=i,!(e.assigned_[t]=!1);if(Ed(i,n)&&(void 0!==i||bd(e.base_,t)))return!0;Yd(e),zd(e)}return e.copy_[t]=i,e.assigned_[t]=!0},deleteProperty:function(e,t){return void 0!==Gd(e.base_,t)||t in e.base_?(e.assigned_[t]=!1,Yd(e),zd(e)):delete e.assigned_[t],e.copy_&&delete e.copy_[t],!0},getOwnPropertyDescriptor:function(e,t){var i=Ad(e),r=Reflect.getOwnPropertyDescriptor(i,t);return r&&{writable:!0,configurable:1!==e.type_||"length"!==t,enumerable:r.enumerable,value:i[t]}},defineProperty:function(){pd(11)},getPrototypeOf:function(e){return Object.getPrototypeOf(e.base_)},setPrototypeOf:function(){pd(12)}},Hd={};function Gd(e,t){var i=e[ud];return(i?Ad(i):e)[t]}function Wd(e,t){if(t in e)for(var i=Object.getPrototypeOf(e);i;){var r=Object.getOwnPropertyDescriptor(i,t);if(r)return r;i=Object.getPrototypeOf(i)}}function zd(e){e.modified_||(e.modified_=!0,e.parent_&&zd(e.parent_))}function Yd(e){e.copy_||(e.copy_=Rd(e.base_))}vd(jd,function(e,t){Hd[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}}),Hd.deleteProperty=function(e,t){return isNaN(parseInt(t))&&pd(13),jd.deleteProperty.call(this,e[0],t)},Hd.set=function(e,t,i){return"length"!==t&&isNaN(parseInt(t))&&pd(14),jd.set.call(this,e[0],t,i,e[0])};(f=Xd.prototype).produce=function(e,s,t){if("function"==typeof e&&"function"!=typeof s){var a=s;s=e;var o=this;return function(e){var t=this;void 0===e&&(e=a);for(var i=arguments.length,r=new Array(1<i?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];return o.produce(e,function(e){return s.call.apply(s,[t,e].concat(r))})}}var i;if("function"!=typeof s&&pd(6),void 0!==t&&"function"!=typeof t&&pd(7),md(e)){var r=Ud(this),n=Jd(this,e,void 0),l=!0;try{i=s(n),l=!1}finally{(l?Fd:Bd)(r)}return"undefined"!=typeof Promise&&i instanceof Promise?i.then(function(e){return Nd(r,t),Vd(e,r)},function(e){throw Fd(r),e}):(Nd(r,t),Vd(i,r))}if(!e||"object"!=typeof e)return(i=s(e))===ld?void 0:(void 0===i&&(i=e),this.autoFreeze_&&kd(i,!0),i);pd(21,e)},f.produceWithPatches=function(n,e,t){var i,r,s=this;return"function"==typeof n?function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return s.produceWithPatches(e,function(e){return n.apply(void 0,[e].concat(i))})}:[this.produce(n,e,function(e,t){i=e,r=t}),i,r]},f.createDraft=function(e){md(e)||pd(8),fd(e)&&(e=Zd(e));var t=Ud(this),e=Jd(this,e,void 0);return e[ud].isManual_=!0,Bd(t),e},f.finishDraft=function(e,t){e=e&&e[ud];e&&e.isManual_||pd(9),e.finalized_&&pd(10);e=e.scope_;return Nd(e,t),Vd(void 0,e)},f.setAutoFreeze=function(e){this.autoFreeze_=e},f.setUseProxies=function(e){e&&!od&&pd(20),this.useProxies_=e},f.applyPatches=function(e,t){for(var i=t.length-1;0<=i;i--){var r=t[i];if(0===r.path.length&&"replace"===r.op){e=r.value;break}}var n=Dd("Patches").applyPatches_;return fd(e)?n(e,t):this.produce(e,function(e){return n(e,t.slice(i+1))})},Kr=Xd;function Xd(e){this.useProxies_=od,this.autoFreeze_=!0,"boolean"==typeof(null==e?void 0:e.useProxies)&&this.setUseProxies(e.useProxies),"boolean"==typeof(null==e?void 0:e.autoFreeze)&&this.setAutoFreeze(e.autoFreeze),this.produce=this.produce.bind(this),this.produceWithPatches=this.produceWithPatches.bind(this)}function Jd(e,t,i){t=wd(t)?Dd("MapSet").proxyMap_(t,i):Od(t)?Dd("MapSet").proxySet_(t,i):e.useProxies_?function(e,t){var i=Array.isArray(e),r={type_:i?1:0,scope_:t?t.scope_:Ld(),modified_:!1,finalized_:!1,assigned_:{},parent_:t,base_:e,draft_:null,copy_:null,revoke_:null,isManual_:!1},t=r,e=jd;i&&(t=[r],e=Hd);t=Proxy.revocable(t,e),e=t.revoke,t=t.proxy;return r.draft_=t,r.revoke_=e,t}(t,i):Dd("ES5").createES5Proxy_(t,i);return(i?i.scope_:Ld()).drafts_.push(t),t}function Zd(e){return fd(e)||pd(22,e),function i(e){if(!md(e))return e;var r,n=e[ud],t=Sd(e);if(n){if(!n.modified_&&(n.type_<4||!Dd("ES5").hasChanges_(n)))return n.base_;n.finalized_=!0,r=eu(e,t),n.finalized_=!1}else r=eu(e,t);return vd(r,function(e,t){n&&Td(n.base_,e)===t||Id(r,e,i(t))}),3===t?new Set(r):r}(e)}function eu(e,t){switch(t){case 2:return new Map(e);case 3:return Array.from(e)}return Rd(e)}function tu(){var r={};function l(i,e){var t=r[i];return t?t.enumerable=e:r[i]=t={configurable:!0,enumerable:e,get:function(){var e=this[ud];return a(e),jd.get(e,i)},set:function(e){var t=this[ud];a(t),jd.set(t,i,e)}},t}function n(e){for(var t=e.length-1;0<=t;t--){var i=e[t][ud];if(!i.modified_)switch(i.type_){case 5:u(i)&&zd(i);break;case 4:s(i)&&zd(i)}}}function s(e){for(var t=e.base_,i=e.draft_,r=gd(i),n=r.length-1;0<=n;n--){var s=r[n];if(s!==ud){var a=t[s];if(void 0===a&&!bd(t,s))return!0;var o=i[s],s=o&&o[ud];if(s?s.base_!==a:!Ed(o,a))return!0}}e=!!t[ud];return r.length!==gd(t).length+(e?0:1)}function u(e){var t=e.draft_;if(t.length!==e.base_.length)return!0;t=Object.getOwnPropertyDescriptor(t,t.length-1);return!(!t||t.get)}function a(e){e.revoked_&&pd(3,JSON.stringify(Ad(e)))}_d("ES5",{createES5Proxy_:function(e,t){var i=Array.isArray(e),r=function(e,t){if(e){for(var i=new Array(t.length),r=0;r<t.length;r++)Object.defineProperty(i,""+r,l(r,!0));return i}var n=yd(t);delete n[ud];for(var s=gd(n),a=0;a<s.length;a++){var o=s[a];n[o]=l(o,e||!!n[o].enumerable)}return Object.create(Object.getPrototypeOf(t),n)}(i,e),e={type_:i?5:4,scope_:t?t.scope_:Ld(),modified_:!1,finalized_:!1,assigned_:{},parent_:t,base_:e,draft_:r,copy_:null,revoked_:!1,isManual_:!1};return Object.defineProperty(r,ud,{value:e,writable:!0}),r},willFinalizeES5_:function(e,t,i){i?fd(t)&&t[ud].scope_===e&&n(e.drafts_):(e.patches_&&function t(e){if(e&&"object"==typeof e){var i=e[ud];if(i){var r=i.base_,n=i.draft_,s=i.assigned_;if(4===(e=i.type_))vd(n,function(e){e!==ud&&(void 0!==r[e]||bd(r,e)?s[e]||t(n[e]):(s[e]=!0,zd(i)))}),vd(r,function(e){void 0!==n[e]||bd(n,e)||(s[e]=!1,zd(i))});else if(5===e){if(u(i)&&(zd(i),s.length=!0),n.length<r.length)for(var a=n.length;a<r.length;a++)s[a]=!1;else for(var o=r.length;o<n.length;o++)s[o]=!0;for(var l=Math.min(n.length,r.length),d=0;d<l;d++)void 0===s[d]&&t(n[d])}}}}(e.drafts_[0]),n(e.drafts_))},hasChanges_:function(e){return(4===e.type_?s:u)(e)}})}function iu(){var m="replace",g="add",y="remove";function d(e){if(!md(e))return e;if(Array.isArray(e))return e.map(d);if(wd(e))return new Map(Array.from(e.entries()).map(function(e){return[e[0],d(e[1])]}));if(Od(e))return new Set(Array.from(e).map(d));var t,i=Object.create(Object.getPrototypeOf(e));for(t in e)i[t]=d(e[t]);return i}function v(e){return fd(e)?d(e):e}_d("Patches",{applyPatches_:function(l,e){return e.forEach(function(e){for(var t=e.path,i=e.op,r=l,n=0;n<t.length-1;n++)"object"!=typeof(r=Td(r,t[n]))&&pd(15,t.join("/"));var s=Sd(r),a=d(e.value),o=t[t.length-1];switch(i){case m:switch(s){case 2:return r.set(o,a);case 3:pd(16);default:return r[o]=a}case g:switch(s){case 1:return r.splice(o,0,a);case 2:return r.set(o,a);case 3:return r.add(a);default:return r[o]=a}case y:switch(s){case 1:return r.splice(o,1);case 2:return r.delete(o);case 3:return r.delete(e.value);default:return delete r[o]}default:pd(17,i)}}),l},generatePatches_:function(c,e,t,i){switch(c.type_){case 0:case 4:case 2:return d=e,u=t,h=i,p=c.base_,f=c.copy_,void vd(c.assigned_,function(e,t){var i=Td(p,e),r=Td(f,e),t=t?bd(p,e)?m:g:y;i===r&&t==m||(e=d.concat(e),u.push(t==y?{op:t,path:e}:{op:t,path:e,value:r}),h.push(t==g?{op:y,path:e}:t==y?{op:g,path:e,value:v(i)}:{op:m,path:e,value:v(i)}))});case 5:case 1:return function(e,t,i){var r,n=c.base_,s=c.assigned_,a=c.copy_;a.length<n.length&&(n=(r=[a,n])[0],a=r[1],t=(r=[i,t])[0],i=r[1]);for(var o,l=0;l<n.length;l++)s[l]&&a[l]!==n[l]&&(o=e.concat([l]),t.push({op:m,path:o,value:v(a[l])}),i.push({op:m,path:o,value:v(n[l])}));for(var d=n.length;d<a.length;d++){var u=e.concat([d]);t.push({op:g,path:u,value:v(a[d])})}n.length<a.length&&i.push({op:m,path:e.concat(["length"]),value:n.length})}(e,t,i);case 3:return r=e,n=t,s=i,a=c.base_,o=c.copy_,l=0,a.forEach(function(e){var t;o.has(e)||(t=r.concat([l]),n.push({op:y,path:t,value:e}),s.unshift({op:g,path:t,value:e})),l++}),l=0,void o.forEach(function(e){var t;a.has(e)||(t=r.concat([l]),n.push({op:g,path:t,value:e}),s.unshift({op:y,path:t,value:e})),l++})}var r,n,s,a,o,l,d,u,h,p,f},generateReplacementPatches_:function(e,t,i,r){i.push({op:m,path:[],value:t}),r.push({op:m,path:[],value:e.base_})}})}function ru(){var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};function i(e,t){function i(){this.constructor=e}r(e,t),e.prototype=(i.prototype=t.prototype,new i)}var n=function(){function e(e,t){return this[ud]={type_:2,parent_:t,scope_:t?t.scope_:Ld(),modified_:!1,finalized_:!1,copy_:void 0,assigned_:void 0,base_:e,draft_:this,isManual_:!1,revoked_:!1},this}i(e,Map);var t=e.prototype;return Object.defineProperty(t,"size",{get:function(){return Ad(this[ud]).size}}),t.has=function(e){return Ad(this[ud]).has(e)},t.set=function(e,t){var i=this[ud];return l(i),Ad(i).has(e)&&Ad(i).get(e)===t||(s(i),zd(i),i.assigned_.set(e,!0),i.copy_.set(e,t),i.assigned_.set(e,!0)),this},t.delete=function(e){if(!this.has(e))return!1;var t=this[ud];return l(t),s(t),zd(t),t.assigned_.set(e,!1),t.copy_.delete(e),!0},t.clear=function(){var t=this[ud];l(t),Ad(t).size&&(s(t),zd(t),t.assigned_=new Map,vd(t.base_,function(e){t.assigned_.set(e,!1)}),t.copy_.clear())},t.forEach=function(r,n){var s=this;Ad(this[ud]).forEach(function(e,t,i){r.call(n,s.get(t),t,s)})},t.get=function(e){var t=this[ud];l(t);var i=Ad(t).get(e);if(t.finalized_||!md(i))return i;if(i!==t.base_.get(e))return i;i=Jd(t.scope_.immer_,i,t);return s(t),t.copy_.set(e,i),i},t.keys=function(){return Ad(this[ud]).keys()},t.values=function(){var e,t=this,i=this.keys();return(e={})[cd]=function(){return t.values()},e.next=function(){var e=i.next();return e.done?e:{done:!1,value:t.get(e.value)}},e},t.entries=function(){var e,i=this,r=this.keys();return(e={})[cd]=function(){return i.entries()},e.next=function(){var e=r.next();if(e.done)return e;var t=i.get(e.value);return{done:!1,value:[e.value,t]}},e},t[cd]=function(){return this.entries()},e}();function s(e){e.copy_||(e.assigned_=new Map,e.copy_=new Map(e.base_))}var a=function(){function e(e,t){return this[ud]={type_:3,parent_:t,scope_:t?t.scope_:Ld(),modified_:!1,finalized_:!1,copy_:void 0,base_:e,draft_:this,drafts_:new Map,revoked_:!1,isManual_:!1},this}i(e,Set);var t=e.prototype;return Object.defineProperty(t,"size",{get:function(){return Ad(this[ud]).size}}),t.has=function(e){var t=this[ud];return l(t),t.copy_?!!t.copy_.has(e)||!(!t.drafts_.has(e)||!t.copy_.has(t.drafts_.get(e))):t.base_.has(e)},t.add=function(e){var t=this[ud];return l(t),this.has(e)||(o(t),zd(t),t.copy_.add(e)),this},t.delete=function(e){if(!this.has(e))return!1;var t=this[ud];return l(t),o(t),zd(t),t.copy_.delete(e)||!!t.drafts_.has(e)&&t.copy_.delete(t.drafts_.get(e))},t.clear=function(){var e=this[ud];l(e),Ad(e).size&&(o(e),zd(e),e.copy_.clear())},t.values=function(){var e=this[ud];return l(e),o(e),e.copy_.values()},t.entries=function(){var e=this[ud];return l(e),o(e),e.copy_.entries()},t.keys=function(){return this.values()},t[cd]=function(){return this.values()},t.forEach=function(e,t){for(var i=this.values(),r=i.next();!r.done;)e.call(t,r.value,r.value,this),r=i.next()},e}();function o(i){i.copy_||(i.copy_=new Set,i.base_.forEach(function(e){var t;md(e)?(t=Jd(i.scope_.immer_,e,i),i.drafts_.set(e,t),i.copy_.add(t)):i.copy_.add(e)}))}function l(e){e.revoked_&&pd(3,JSON.stringify(Ad(e)))}_d("MapSet",{proxyMap_:function(e,t){return new n(e,t)},proxySet_:function(e,t){return new a(e,t)}})}var nu=new Kr,Sr=nu.produce,su=nu.produceWithPatches.bind(nu),au=nu.setAutoFreeze.bind(nu),ou=nu.setUseProxies.bind(nu),e=nu.applyPatches.bind(nu),f=nu.createDraft.bind(nu),nu=nu.finishDraft.bind(nu);p.Immer=Kr,p.applyPatches=e,p.castDraft=function(e){return e},p.castImmutable=function(e){return e},p.createDraft=f,p.current=Zd,p.default=Sr,p.enableAllPlugins=function(){tu(),ru(),iu()},p.enableES5=tu;f=p.enableMapSet=ru;p.enablePatches=iu,p.finishDraft=nu,p.immerable=dd,p.isDraft=fd,p.isDraftable=md,p.nothing=ld,p.original=function(e){return fd(e)||pd(23,e),e[ud].base_};var lu=p.produce=Sr;p.produceWithPatches=su;var du=p.setAutoFreeze=au;p.setUseProxies=ou;const uu=["SDR","PQ","HLG"];function cu(e){return"bitrate"in e}const hu=/^((?:[^\/;?#]+:)?)(\/\/[^\/\;?#]*)?(.*?)??(;.*?)?(\?.*?)?(#.*?)?$/,pu=/^([^\/;?#]*)(.*)$/,fu=/(?:\/|^)\.(?=\/)/g,mu=/(?:\/|^)\.\.\/(?!\.\.\/).*?(?=\/)/g,gu={buildAbsoluteURL:function(e,t,i){if(i=i||{},e=e.trim(),!(t=t.trim())){if(!i.alwaysNormalize)return e;const t=gu.parseURL(e);if(!t)throw new Error("Error trying to parse base URL.");return t.path=gu.normalizePath(t.path),gu.buildURLFromParts(t)}const r=gu.parseURL(t);if(!r)throw new Error("Error trying to parse relative URL.");if(r.scheme)return i.alwaysNormalize?(r.path=gu.normalizePath(r.path),gu.buildURLFromParts(r)):t;const n=gu.parseURL(e);if(!n)throw new Error("Error trying to parse base URL.");if(!n.netLoc&&n.path&&"/"!==n.path[0]){const e=pu.exec(n.path);n.netLoc=e[1],n.path=e[2]}n.netLoc&&!n.path&&(n.path="/");const s={scheme:n.scheme,netLoc:r.netLoc,path:null,params:r.params,query:r.query,fragment:r.fragment};if(!r.netLoc&&(s.netLoc=n.netLoc,"/"!==r.path[0]))if(r.path){const e=n.path,t=e.substring(0,e.lastIndexOf("/")+1)+r.path;s.path=gu.normalizePath(t)}else s.path=n.path,r.params||(s.params=n.params,r.query||(s.query=n.query));return null===s.path&&(s.path=i.alwaysNormalize?gu.normalizePath(r.path):r.path),gu.buildURLFromParts(s)},parseURL:function(e){e=hu.exec(e);return e?{scheme:e[1]||"",netLoc:e[2]||"",path:e[3]||"",params:e[4]||"",query:e[5]||"",fragment:e[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(fu,"");e.length!==(e=e.replace(mu,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment},getHostName:function(e){let t;return e&&(t=-1<e.indexOf("://")?e.split("/")[2]:e.split("/")[0],t=t.split(":")[0],t=t.split("?")[0]),t}};var yu,vu,Su,bu,Tu,Iu,Eu,wu,Ou,Au=gu;function Ru(e){return null!=e&&!e.startsWith("http://")&&!e.startsWith("https://")}function ku(e){return null==e||Ru(e)?null:gu.getHostName(e)}const Cu=[".*.itunes.apple.com"],Mu={deviceName:"&xapdn=",deviceModel:"&xapdm=",language:"&xapdl=",dsid:"&xapdsid=",subs:"&xapsub="};function Pu(e,t){return null==e||null==t||e===t}function xu(e,t){var i,r,n=cu(e),s=cu(t),i=ku(e.url),r=t.url;return(!i||i===ku(r))&&(!n&&!s||n&&s&&Pu(e.pathwayID,t.pathwayID))}(su=yu=yu||{})[su.DOVI=4]="DOVI",su[su.HEVC=3]="HEVC",su[su.VP09=2]="VP09",su[su.AVC=1]="AVC",su[su.UNKNOWN=0]="UNKNOWN",(au=vu=vu||{})[au.PQ=3]="PQ",au[au.HLG=2]="HLG",au[au.SDR=1]="SDR",au[au.UNKNOWN=0]="UNKNOWN",(p=Su=Su||{})[p.ALAC=7]="ALAC",p[p.FLAC=6]="FLAC",p[p.EC3=5]="EC3",p[p.AC3=4]="AC3",p[p.XHEAAC=3]="XHEAAC",p[p.AAC=2]="AAC",p[p.MP3=1]="MP3",p[p.UNKNOWN=0]="UNKNOWN",(ou=bu=bu||{})[ou.VALID=1]="VALID",ou[ou.INVALID=0]="INVALID";const Du=["via","x-apple-request-uuid"],_u=["fragLoadPolicy","keyLoadPolicy","certLoadPolicy","playlistLoadPolicy","manifestLoadPolicy","steeringManifestLoadPolicy"],Lu={maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},Nu={maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3},Fu={maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},Bu={default:{maxTimeToFirstByteMs:5e3,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Fu,errorRetry:Fu},interstitial:{maxTimeToFirstByteMs:5e3,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Fu,errorRetry:Fu},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Fu,errorRetry:Fu}},Uu={maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},$u=Object.assign(Object.assign({},Uu),{maxNumRetry:1}),Vu={default:{maxTimeToFirstByteMs:5e3,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:$u,errorRetry:Uu},interstitial:{maxTimeToFirstByteMs:5e3,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:$u,errorRetry:Uu},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:$u,errorRetry:Uu}},Ku={supportedStorebagVersion:"0.0.0",testGroupId:""},Qu=Object.assign(Object.assign({startPosition:NaN,debug:!1,debugLevel:"info",buildType:void 0,abrTrickplayLevelLocked:!1,minFramesBeforeSwitchingLevel:11,minTargetDurations:3,maxBufferLength:60,maxBufferHole:.5,maxSeekHole:2,nudgeFromEventSeek:!0,jaggedSeekTolerance:0,discontinuitySeekTolerance:2,bufferedSegmentEjectionToleranceMs:.5,almostDryBufferSec:.5,maxTotalDurationTolerance:.1,changeType:!1,lowBufferThreshold:.5,lowBufferWatchdogPeriod:.5,highBufferWatchdogPeriod:3,seekWatchdogPeriod:5,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.2,liveSyncDurationCount:3,liveSyncDuration:void 0,liveMaxUnchangedPlaylistRefresh:3,liveEdgeForZeroStartPositon:!1,liveAllowTrickplay:!1,livePlaylistUpdateStaleness:2,allowFastSwitchUp:!1,desiredIframeFPS:8,leftMediaTimeToAutoPause:10,startTargetDurationFactor:.9,minRequiredStartDuration:4,maxRequiredStartDuration:15,enableWorker:!0,enableWebCrypto:!0,keySystemPreference:void 0,useMultipleKeySessions:!1,enablePlayReadyKeySystem:!1,useMediaKeySystemAccessFilter:!1,playReadyMessageFormat:"utf16",offlinePlayback:!1,livePlaylistRefreshDelay:2500,liveMinPlayingBufferLen:5,enableIFramePreloading:!0,enableInterstitialPlayback:!1,livePlaylistPreloadDelayMs:250,allowServerGeneratedInterstitials:!1,forcePauseOnInterstitialBoundary:!1,adjustedSeekToleranceMs:500,enablePartialInterstitialPlaybackForLiveEdge:!1,useMediaCapabilities:!1,enableID3Cues:!0,certLoadPolicy:Bu,keyLoadPolicy:Vu,manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}},interstitial:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0}},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:1e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},trickPlaybackConfig:{enabled:!0,minIframeDuration:8},minSteeringRunway:2},Ku),{playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}},interstitial:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0}},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:1e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:5e3,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Lu,errorRetry:Nu,forceContentLenCheckIfNoHeader:!1,reportCDNServer:!0},interstitial:{maxTimeToFirstByteMs:5e3,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},forceContentLenCheckIfNoHeader:!1,reportCDNServer:!0},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Lu,errorRetry:Nu,reportCDNServer:!0}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}},interstitial:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0}},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:1e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},maxNumAddLevelToPenaltyBox:4,firstAudioMustOverlapVideoStart:!1,keyMinHoldTimeBeforeCleanup:15e3,appendErrorMaxRetry:3,xhrSetup:void 0,audioPrimingDelay:0,enableCEA708Captions:!0,customTextTrackCueRenderer:!1,enableWebVTT:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",condenseSubtitleTrack:!1,nativeTextTrackChangeHandling:!0,earlyFragTolerance:7,vttConcurrentLoadCount:1,trottleCheckInterval:2e3,subtitleLeadTime:30,lateTolerance:2,stretchShortVideoTrack:!1,forceKeyFrameOnDiscontinuity:!0,abrAlgorithm:"default",abrBandWidthFactor:.95,abrBandWidthUpFactor:.9,abrSamplePeriodMs:200,maxStarvationDelay:4,enableRtcReporting:!1,rtcIntervalTimeout:3e5,useHTTPPlaybackSessionId:!1,warmupCdms:!1,enablePerformanceLogging:!1,overridePlaybackRate:!1,nativeControlsEnabled:!1,useCustomMediaFunctions:!0,seekEventThrottleMs:150,timeAccuracyThresholdSeconds:.25,contentGapPlaythroughIntervalSeconds:.5,enableAdaptiveStartup:!0,bandwidthHistoryWindowSize:12e4,bandwidthHistoryTTL:6e5,bandwidthHistoryAggregationMethod:"quadratic-time-weighted",defaultTargetDuration:10,targetStartupMs:4e3,bandwidthHistoryStorageKey:"AppleHLS-bandwidth-estimation",storageKeyPrefix:"AppleHLS-",storage:{get:"undefined"==typeof localStorage?void 0:localStorage.getItem.bind(localStorage),set:"undefined"==typeof localStorage?void 0:localStorage.setItem.bind(localStorage)},minFragmentCount:10,minPlaylistCount:5,enableQueryParamsForITunes:!1,gapless:!1,useViewportSizeForLevelCap:!1,statDefaults:{playlistLoadTimeMs:500,playlistParseTimeMs:50,fragParseTimeMs:50,fragBufferCreationDelayMs:200,dataFragAppendMs:50,initFragAppendMs:50},disableVideoCodecList:new Set([]),disableAudioCodecList:new Set([Su.ALAC,Su.FLAC,Su.XHEAAC]),useHighestVideoCodecPrivate:!0,sessionDataAutoLoad:{"com.apple.hls.chapters":!0},canUseNetworkResourcesForLiveStreamingWhilePaused:!1,liveResumeAtWindowStart:!1,liveOldCueRemovalOffsetSec:600}),qu=Object.assign(Object.assign({},{itemId:"Nah",mediaOptionId:"Nah"}),{mediaOptionType:void 0}),ju=e=>{var{itemId:t,mediaOptionId:e}=e;return"Nah"!==t&&"Nah"!==e},Hu=(e,t)=>e.itemId===t.itemId&&e.mediaOptionId===t.mediaOptionId;(su=Tu=Tu||{})[su.Variant=0]="Variant",su[su.AltAudio=1]="AltAudio",su[su.Subtitle=2]="Subtitle";const Gu=["variant","altAudio","subtitle"],Wu=[Tu.Variant,Tu.AltAudio,Tu.Subtitle],zu=[Tu.Variant,Tu.AltAudio];(au=Iu=Iu||{})[au.Variant=0]="Variant",au[au.AltAudio=1]="AltAudio";const Yu=["variant","altAudio"];function Xu(e){switch(e){case Tu.Variant:return Iu.Variant;case Tu.AltAudio:return Iu.AltAudio;default:return null}}function Ju(e){return e===Iu.Variant?Tu.Variant:Tu.AltAudio}(p=Eu=Eu||{})[p.Primary=0]="Primary",p[p.Interstitial=1]="Interstitial",(ou=wu=wu||{})[ou.NO=0]="NO",ou[ou.YES=1]="YES",(su=Ou=Ou||{}).UNKNOWN="unkn",su.VIDEO="vide",su.AUDIO="soun",su.SUBTITLE="sbtl",su.CLOSEDCAPTION="clcp";const Zu={search:function(e,t){let i,r,n=0,s=(null==e?void 0:e.length)-1;for(;n<=s;){var a=t(r=e[i=(n+s)/2|0]);if(0<a)n=1+i;else{if(!(a<0))return r;s=i-1}}return null}};var ec=Zu,tc={findFragmentBySNAndBuffer:function(e,t,i=0,r=0,n=0){let s;e=e?t[e.mediaSeqNum-t[0].mediaSeqNum+1]:null;return s=i<r?(r-n<i&&(n=0),e&&!this.fragmentWithinToleranceTest(i,n,e)?e:Zu.search(t,this.fragmentWithinToleranceTest.bind(null,i,n))):t[t.length-1],s},fragmentWithinToleranceTest:function(e,t,i){t=Math.min(t,i.duration);return i.start+i.duration-t<=e?1:i.start-t>e&&i.start?-1:0}};const ic={startFragmentInCC:function(e,t,i){let r=t-i.discoSeqNum;if(0===r){const t=e[i.mediaSeqNum-e[0].mediaSeqNum-1];r=t&&t.discoSeqNum===i.discoSeqNum?-1:0}return r},endFragmentInCC:function(e,t,i){let r=t-i.discoSeqNum;if(0===r){const t=e[i.mediaSeqNum-e[0].mediaSeqNum+1];r=t&&t.discoSeqNum===i.discoSeqNum?1:0}return r},findStartEndFragmentsInCC:function(e,t,i){let r,n;return 0<(null==e?void 0:e.length)&&Z(t)&&(r=Zu.search(e,ic.startFragmentInCC.bind(null,e,t)),n=Zu.search(e,ic.endFragmentInCC.bind(null,e,t))),r&&!Z(r.discoSeqNum)&&(r=void 0),n&&!Z(n.discoSeqNum)&&(n=void 0),{startFrag:r,endFrag:n}},getTimeRangeDictForCC:function(e,t,i){var{startFrag:t,endFrag:i}=ic.findStartEndFragmentsInCC(e,t,i);return{start:t.start,end:i.start+i.duration}},getTimeRangeForCC:function(e,t,i){var{startFrag:t,endFrag:i}=ic.findStartEndFragmentsInCC(e,t,i);return t&&i?[t.start,i.start+i.duration]:[]},snapToCCTimeRange:function(e,t,i,r){r=ic.getTimeRangeForCC(t,i,r);return r.length?Math.min(r[1],Math.max(r[0],e)):e},getMinTimeForCC(e,t,i,r){if(null==e||!e.length)return 0;let n=0;if(Z(i)&&e){e=ic.getTimeRangeForCC(e,i,r);if(e.length){const s=ic.getTimeRangeForCC(t,i,r);n=s.length?Math.max(s[0],e[0]):e[0]}}return n},discoSeqNumForTime(e,t,i=0){i=Zu.search(e,tc.fragmentWithinToleranceTest.bind(null,t,i));return null==i?void 0:i.discoSeqNum}};var rc,nc,sc,ac=ic;function oc(e,t){var i=e.timeline;return{seconds:(e.seconds-i.rootTimeSeconds)/i.rate*t.rate+t.rootTimeSeconds,timeline:t}}class lc{constructor(){this._timeline=null}get forward(){var e;return 0<(null===(e=this.timeline)||void 0===e?void 0:e.rate)}get isStarted(){return Boolean(this.hostClock)}start(e){this.stopTime=null,this._timeline=Object.assign({},e);const t={rootTimeSeconds:performance.now()/1e3,rate:1};this.hostClock={timeline:t,getCurrentTime:()=>({seconds:performance.now()/1e3,timeline:t})}}pause(){this.isStarted&&(this.stopTime=this.getCurrentTime())}stop(){this.pause(),this.hostClock=null,this._timeline=null}get timeline(){return this._timeline}getCurrentTime(){return this.stopTime||oc(this.hostClock.getCurrentTime(),this.timeline)}}class dc{constructor(e){this._timeline=e,this.mediaRootTime=this.lastTimeSeconds=e.rootTimeSeconds}get timeline(){return Object.assign({},this._timeline)}getCurrentTime(){return{seconds:this.lastTimeSeconds,timeline:Object.assign({},this._timeline)}}}const uc={name:"ifm"};class cc{constructor(e,t){this.config=e,this.logger=t,this.scaledFragments=[],this.iframeClock=new lc,this.hasMore$=new Si(!0),this.logger=t.child(uc)}destroy(){this.stop()}resetScaledSegments(){this.scaledFragments=[]}get anchorFrag(){return this.scaledFragments.length?this.scaledFragments[0]:null}get lastFrag(){return this.scaledFragments.length?this.scaledFragments.slice(-1)[0]:null}get isStarted(){return Boolean(this.iframeClock.isStarted)}get iframeRate(){var e;return null!==(e=null===(e=this.iframeClock.timeline)||void 0===e?void 0:e.rate)&&void 0!==e?e:0}get iframeClockTimeSeconds(){return Math.max(0,this.iframeClock.getCurrentTime().seconds)}get mediaAppendClockTimeSeconds(){var e;return null!==(e=null===(e=this.mediaAppendClock)||void 0===e?void 0:e.getCurrentTime().seconds)&&void 0!==e?e:0}get mediaRootTime(){var e;return null===(e=this.mediaAppendClock)||void 0===e?void 0:e.mediaRootTime}pause(){this.iframeClock.pause()}stop(){this.hasMore$.next(!0),this.iframeClock.stop(),this.mediaAppendClock=null,this.resetScaledSegments()}checkHasMore(){this.hasMore$.next(!0)}startClocksAndGetFirstFragment(e,t,i,r,n){let s=Zu.search(e,tc.fragmentWithinToleranceTest.bind(null,r,1e-4));if(!s&&r>=e[e.length-1].start&&(s=e[e.length-1]),!s)return this.logger.error(`startClocksAndGetFirstFragment => no anchorFrag for time ${r}`),this.hasMore$.next(!1),null;var a=Z(n)?n:s.discoSeqNum,a=ac.getMinTimeForCC(e,t,a,this.logger),r=Z(n)&&1<i?a:r,a=1<i?Math.ceil(r):Math.ceil(a);return this.iframeClock.start({rootTimeSeconds:r,rate:i}),this.mediaAppendClock=new dc({rootTimeSeconds:a,rate:1}),{frag:s,newMediaRootTime:a}}getNextFragment(e,t,i){const r=this.lastFrag,{iframeClock:n,mediaAppendClock:s}=this,a=n.timeline;s.lastTimeSeconds=t;var o=n.forward?1:-1;let l,d=Math.max(0,Math.min(r.mediaSeqNum-e[0].mediaSeqNum+o,e.length-1));if(r.mediaSeqNum!==e[d].mediaSeqNum)do{l=e[d];const i=n.forward?l.start:l.start+l.duration;if(oc({seconds:i,timeline:a},s.timeline).seconds>=t&&(n.forward&&i>=this.iframeClockTimeSeconds||!n.forward&&i<=this.iframeClockTimeSeconds))break}while(d+=o,0<d&&d<e.length);return l||(this.logger.error(`getNextFragment(bufferEnd: ${t}) => no more frags, but we should have found an end fragment, setting hasMore to false`),this.hasMore$.next(!1)),{frag:l}}nextFragment(e,t,i,r){let n,s;if(this.isStarted&&i!==this.iframeRate&&(s=this.iframeClockTimeSeconds,this.stop()),this.isStarted){if(n=this.getNextFragment(e,r,i),!n.frag)return;if(n.frag.discoSeqNum!==this.anchorFrag.discoSeqNum){const a=this.iframeClockTimeSeconds;this.stop();const s=this.startClocksAndGetFirstFragment(e,t,i,a,n.frag.discoSeqNum)["newMediaRootTime"];n.newMediaRootTime=s}}else if(n=this.startClocksAndGetFirstFragment(e,t,i,null!=s?s:r),!n)return;var r=n["frag"],r=this.handleNextFrag(e,r);return Object.assign(Object.assign({},n),{frag:r})}handleNextFrag(e,t){const i=Object.assign(Object.assign({},t),{iframeMediaStart:NaN,iframeMediaDuration:NaN}),{mediaAppendClock:r,iframeClock:n}=this;this.iframeClockBounds=ac.getTimeRangeDictForCC(e,i.discoSeqNum,this.logger);var s=r.getCurrentTime().seconds,t=n.timeline.rate;return Z(i.iframeOriginalStart)||(i.iframeOriginalStart=i.start),i.start=i.iframeMediaStart=s,i.iframeMediaDuration=Math.max(i.duration/Math.abs(t),1/this.config.minIframeDuration),this.scaledFragments.push(i),this.isEndFrag(e,i)&&this.hasMore$.next(!1),i}get hasMore(){return this.hasMore$.value}isEndFrag(e,t){var i=e[0],r=e[e.length-1],e=this.iframeClock.forward;return!e&&(null==i?void 0:i.mediaSeqNum)===t.mediaSeqNum||e&&(null==r?void 0:r.mediaSeqNum)===t.mediaSeqNum}}class hc extends Error{constructor(e,t){super(e),this.statusCode=t}get isAuthOrCorsError(){return 401===this.statusCode||403===this.statusCode||407===this.statusCode||0===this.statusCode}}class pc extends g{constructor(e,t,i,r,n){super(M.NETWORK_ERROR,e,t,i,r),this.isTimeout=n,this.response=r}}class fc extends pc{constructor(e,t,i,r){super(r?P.MANIFEST_LOAD_TIMEOUT:P.MANIFEST_LOAD_ERROR,e,t,i,r)}}class mc extends pc{constructor(e,t,i,r,n,s,a){super(function(e){switch(n){case Tu.Variant:return e?P.LEVEL_LOAD_TIMEOUT:P.LEVEL_LOAD_ERROR;case Tu.AltAudio:return e?P.AUDIO_TRACK_LOAD_TIMEOUT:P.AUDIO_TRACK_LOAD_ERROR;case Tu.Subtitle:return e?P.SUBTITLE_TRACK_LOAD_TIMEOUT:P.SUBTITLE_TRACK_LOAD_ERROR}return P.UNKNOWN}(r),e,t,i,r),this.mediaOptionType=n,this.mediaOptionId=s,this.url=a}}class gc extends pc{constructor(e,t,i){super(P.SESSION_DATA_LOAD_ERROR,e,t,i,!1)}}class yc extends pc{constructor(e,t,i,r,n,s){super(r?P.FRAG_LOAD_TIMEOUT:P.FRAG_LOAD_ERROR,e,t,i,r),this.mediaOptionId=n.mediaOptionId,this.mediaOptionType=n.mediaOptionType,this.stats=s}}class vc extends ur{constructor(e,t){super(),this.message=e,this.stats=t}}class Sc extends pc{constructor(e,t,i){super(P.FRAG_ABORT_ERROR,!1,"Fragment abort",i,!1),this.candidateMediaOptionId=t,this.mediaOptionId=e.mediaOptionId,this.mediaOptionType=e.mediaOptionType}}class bc extends Al{constructor(e){super(e),this.store=e}get unresolvedUriLoading$(){return this.selectEntityAction(_o.Add).pipe(pr(e=>e.map(e=>this.getEntity(e))))}}class Tc{constructor(e){this.store=e}createUnresolvedUriLoading(e,t,i){Co("loader.create.unresolvedUriLoading"),this.store.add({uri:e,responseType:t,userAgent:i})}removeUnresolvedUriLoading(e){Co("loader.remove.unresolvedUriLoading"),this.store.remove(e)}}const Ic=new class extends fl{constructor(){super({},{name:"loader",producerFn:lu,idKey:"uri"})}};let Ec=null;class wc extends t{trigger(e,t){try{this.emit(e,e,t),"hlsFragLoadProgress"!==e.toString()&&("hlsInternalError"!==e&&"hlsError"!==e||!t.length||JSON.stringify(t[0],["fatal","details","reason"]),e.toString())}catch(t){Ge().warn(`error in event listener for ${e}: ${t.message}`)}}}class Oc{constructor(e,t){this.target=e,this._this=t}eventWithOptions(e,t,i,r=this._this){let n=nn(this.target,e,t);return this.target instanceof wc&&(n=n.pipe(pr(([,e])=>e))),i&&(r&&(i=i.bind(r)),n=n.pipe(eo(i))),n}event(e,t,i=this._this){return this.eventWithOptions(e,void 0,t,i)}listen(e,t,i,r=this._this){return this.event(e,i,r).pipe(Ka(t)).subscribe()}}function Ac(e,t){return new Oc(e,t)}function Rc(e,t,i){var r;return{currentTarget:null!==(r=null==i?void 0:i.currentTarget)&&void 0!==r?r:e,target:null!==(i=null==i?void 0:i.target)&&void 0!==i?i:e,type:t}}function kc(v,S){return new Kt(e=>{const{maxTimeToFirstByteMs:t,maxLoadTimeMs:i}=S,r=new XMLHttpRequest,n={trequest:performance.now(),tfirst:NaN,tload:NaN,loaded:0,total:NaN,complete:!1},s=Ac(r),a=s.event("progress").pipe(Ra(),pr(e=>(isNaN(n.tfirst)&&(n.tfirst=performance.now()),n.loaded=e.loaded,e.lengthComputable&&(n.total=e.total),e.target)),cn(e=>3<=e.readyState)),o=s.event("readystatechange").pipe(Ra(),pr(e=>e.target),cn(e=>2<=e.readyState),eo(e=>{isNaN(n.tfirst)&&3<=e.readyState&&(n.tfirst=performance.now())}));let l=wi;isFinite(t)&&0<t&&(l=dn(a,o).pipe(As(1),bo(0<v.extendMaxTTFB?v.extendMaxTTFB:t),La(()=>wi)));let d=wi;isFinite(i)&&0<i&&(d=o.pipe(cn(e=>4<=e.readyState),As(1),bo(i),La(()=>wi)));let u=wi;const c=v.onProgress;if(c){const S=c["samplePeriodMs"];let e;e=Z(c.samplePeriodMs)&&0<S?En(0,c.samplePeriodMs).pipe(Ys(r)):dn(Vi(r),a).pipe(oo(300,Ii,{leading:!0,trailing:!0})),u=e.pipe(pr(e=>{const{getData:t,cb:i}=c;return i(v.url,e.status,n,t?e.response:void 0)}),Wa(e=>!e,!0)).pipe(Va(wi))}const h=dn(a.pipe(La(()=>wi)),o,l,d,u).pipe(cn(e=>4<=e.readyState),As(1),La(e=>{if(n.complete=!0,200<=e.status&&e.status<300){if(n.tload=performance.now(),n.contentType=e.getResponseHeader("Content-Type"),S.reportCDNServer&&/^CDN-Server:/m.test(e.getAllResponseHeaders())&&(n.cdnServer=e.getResponseHeader("CDN-Server")),n.contentLength=S.forceContentLenCheckIfNoHeader?function(e){let t;const i=e.getResponseHeader("Content-Encoding"),r=e.getResponseHeader("Transfer-Encoding"),n=!i||i&&"identity"===i.toLowerCase(),s=!r||r&&"identity"===r.toLowerCase();return n&&s&&(t=function(e){e=/([0-9]+)\-([0-9]+)\/([0-9]+)/.exec(e);return e?parseInt(e[2])-parseInt(e[1])+1:void 0}(e.getResponseHeader("Content-Range")),Z(t)||(t=parseInt(e.getResponseHeader("Content-Length")))),t}(e):null,i=e,(r=v).collectServerInstanceInfo&&(r.serverInstanceInfo={},r.collectServerInstanceInfo.forEach(e=>{var t=i.getResponseHeader(e);t&&(r.serverInstanceInfo[e]=t)})),"arraybuffer"===v.responseType?n.loaded=e.response.byteLength:n.loaded=e.responseText.length,n.total=n.loaded,v.checkContentLength&&(0===n.total||Z(n.contentLength)&&n.total!=n.contentLength))throw new hc("Network error",e.status);return Fr(Vi([e,n]),Ii)}var i,r;throw new hc("Network error",e.status)}),Qn(e=>{if(e instanceof ur)throw new vc(e.message,n);if(!(e instanceof hc))throw new hc(e.message,K.XhrError.code);throw e})).subscribe(e),{url:p,method:f,byteRangeOffset:m,responseType:g,body:y}=v;v.mimeType&&r.overrideMimeType(v.mimeType);try{const S=v.xhrSetup;if(S)try{S(r,p)}catch(e){r.open(f,v.url,!0),S(r,v.url)}r.readyState||r.open(f,v.url,!0)}catch(e){throw new hc(e.message,r.status)}if(r.responseType=g,m&&Z(m.start)&&Z(m.end)&&0<=m.start&&m.end>m.start){const{start:v,end:S}=m;r.setRequestHeader("Range",`bytes=${v}-${S-1}`)}if(v.headers)for(const[S,e]of Object.entries(v.headers))r.setRequestHeader(S,e);return"POST"===f&&y?r.send(y):r.send(),()=>{r.abort(),h.unsubscribe()}})}const Cc={name:"CustomUrlLoader"};class Mc{constructor(e){this.loaderService=e,this.requestMap={},this.logger=Ge()}load(a,o){return new Kt(e=>{const t=a.url,i=o["maxTimeToFirstByteMs"],r={trequest:performance.now(),tfirst:NaN,tload:NaN,loaded:0,total:NaN,complete:!1},n=(this.requestMap[t]=new tr).pipe(bo(0<a.extendMaxTTFB?a.extendMaxTTFB:i),La(e=>(r.tfirst=performance.now(),this.handleExternalResponse(e,a,o,r))),Qn(e=>{if(e instanceof ur)throw new vc(e.message,r);throw e}),Bs(()=>{this.requestMap[t]=void 0,this.loaderService.removeUnresolvedUriLoading(t)}));a.onProgress&&a.onProgress.cb(t,0,r,void 0);const s=n.subscribe(e);return this.loaderService.createUnresolvedUriLoading(t,a.responseType,navigator.userAgent),()=>{s.unsubscribe(),this.requestMap[t]=void 0}})}setCustomUrlResponse(e,t){const i=this.requestMap[e];i&&(i.next(t),i.complete(),this.requestMap[e]=void 0)}handleExternalResponse(e,t,i,r){r.tload=performance.now();var n=e.response.status;return 200<=n&&n<300||0===n&&e.response.data?("arraybuffer"===t.responseType&&e.response.data instanceof ArrayBuffer?r.loaded=e.response.data.byteLength:r.loaded=e.response.data.toString().length,r.total=r.loaded,r.complete=!0,Fr(Vi({status:n,data:e,stats:r}),Ii)):300===n||302===n||303===n||305===n?this.redirectRequest(e.response.uri,t,i,r):(this.logger.warn(Cc,`unable to load custom url > uri=${re(e.response.uri)}, status=${n}`),Ki(new hc("Unable to load custom url",n)))}redirectRequest(e,t,i,n){var{maxLoadTimeMs:r,maxTimeToFirstByteMs:s}=i,r=r-(performance.now()-n.trequest),s=0<t.extendMaxTTFB?t.extendMaxTTFB:s-(performance.now()-n.trequest),i=Object.assign(Object.assign({},i),{maxLoadTimeMs:r,maxTimeToFirstByteMs:s}),e=Object.assign(Object.assign({},t),{url:e});return r<=0||s<=0?Ki(new ur):kc(e,i).pipe(pr(([e,t])=>{var{responseURL:i,status:r}=e,i=i||"",i={uri:i,response:{status:r,uri:i,data:e.response}};return n.loaded=n.total=t.loaded,n.tload=performance.now(),n.complete=!0,{status:e.status,data:i,stats:n}}))}}let Pc;function xc(e){return Pc||(e=e||(Ec=Ec||new Tc(Ic),Ec),Pc=new Mc(e)),Pc}function Dc(e,t){return!e.url||Ru(e.url)?t.customURL:t.default}function _c(e,t){return e instanceof pc?e.isTimeout?t.timeoutRetry:t.errorRetry:null}function Lc(e){var t=e.type,i=e.liveOrEvent;let r="VOD";"EVENT"===t&&i?r="EVENT":t&&0!==t.length&&"LIVE"!==t||!i||(r="LIVE"),e.type!==r&&(e.type=r)}function Nc(e,t,i,r,n){Bc(n);r=Fc(e,t,r);return i.load(e,r).pipe(Qn(e=>e instanceof hc&&e.isAuthOrCorsError?(Ge().warn(`Got auth or cors error on external response: status=${e.statusCode}`),Ki(new hc(`Tried to recover via customUrl, but got auth or cors error: originalStatus=${n.statusCode} retryStatus=${e.statusCode}`,e.statusCode))):Ki(e)))}function Fc(e,t,i){var{maxLoadTimeMs:r,maxTimeToFirstByteMs:n}=t,r=r-(performance.now()-i),i=0<e.extendMaxTTFB?e.extendMaxTTFB:n-(performance.now()-i);return Object.assign(Object.assign({},t),{maxLoadTimeMs:r,maxTimeToFirstByteMs:i})}function Bc(e){Ge().warn(`Auth or CORS error occured with statusCode: ${e.statusCode}. Will retry as custom URL`)}function Uc(t){return e=>e.pipe(pr(e=>[e.data.response.data,e.stats,t.serverInstanceInfo]))}function $c(t,i,r){const n=Object.assign(Object.assign({},t),{method:"GET",responseType:"arraybuffer"});if(Ru(n.url))return r.load(n,i).pipe(Uc(n));{const t=performance.now();return kc(n,i).pipe(pr(([e,t])=>[e.response,t,n.serverInstanceInfo])).pipe(Qn(e=>{if(e instanceof hc&&e.isAuthOrCorsError)return Nc(n,i,r,t,e).pipe(Uc(n));throw e}))}}const Vc=(r,e,t,i,n,s,a)=>{var o,{relativeUrl:l,byteRangeOffset:d,keyTagInfo:u,iframe:c,isInitSegment:h}=r,p=Au.buildAbsoluteURL(e,l,{alwaysNormalize:!0}),e=null==u?void 0:u.method,{start:l,end:u}=null!=d?d:{},i=Dc({url:p},i);let f,m=l,g=u,y=!1,v=Z(l)||Z(u)?d:void 0;if("AES-128"===e&&u&&(c||h)){const r=u-l;r%16&&(g=u+(16-r%16)),0!==l&&(y=!0,m=l-16),v={start:m,end:g}}return s&&Z(r.mediaSeqNum)&&r.mediaOptionType===Tu.Variant&&(f=[],null===(s=i.reportHTTPResponseHeaders)||void 0===s||s.forEach(function(e){Du.includes(e)?f.push(e):Ge().warn({name:"load-media-fragment"},`${e} is not in approved privacy list. Actions required.`)}),0===f.length&&(f=void 0)),$c({url:p,byteRangeOffset:v,checkContentLength:!0,extendMaxTTFB:a,collectServerInstanceInfo:f,onProgress:n,xhrSetup:t.xhrSetup},i,xc()).pipe(pr(([e,t,i])=>{if(y){const t=e;r.keyTagInfo.iv=new Uint8Array(t.slice(0,16)),e=t.slice(16)}return[r,e,t,i]}),(o=r,e=>e.pipe(Qn(e=>{if(e instanceof vc)throw new yc(!1,"Timeout",K.FragmentTimeoutError,!0,o,e.stats);if(e instanceof hc)throw new yc(!1,e.message,{code:e.statusCode,text:"Fragment Network Error"},!1,o);throw e}))))};(au=rc=rc||{})[au.Preroll=0]="Preroll",au[au.Midroll=1]="Midroll",au[au.Postroll=2]="Postroll",(p=nc=nc||{})[p.None=0]="None",p[p.Out=1]="Out",p[p.In=2]="In",p[p.InOut=3]="InOut",(ou=sc=sc||{})[ou.None=0]="None",ou[ou.Skip=1]="Skip",ou[ou.Jump=4]="Jump",ou[ou.SkipJump=5]="SkipJump";class Kc extends Ti{constructor(e){super(e),this.store=e,this.interstitials$=this.select("interstitials"),this.pastInterstitials$=this.select("pastInterstitials"),this.interstitialAssets$=this.select("interstitialAssets"),this.activeInterstitialId$=this.select("activeInterstitialId"),this.activeInterstitialAssetId$=this.select("activeInterstitialAssetId"),this.playingInterstitialId$=this.select("playingInterstitialId"),this.playingInterstitialAssetId$=this.select("playingInterstitialAssetId")}getInterstitialForId(t){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.interstitials.find(e=>e.identifier===t))&&void 0!==e?e:null}getInterstitialAssetForId(t){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.interstitialAssets.find(e=>e.identifier===t))&&void 0!==e?e:null}get interstitials(){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.interstitials)&&void 0!==e?e:[]}get pastInterstitials(){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.pastInterstitials)&&void 0!==e?e:[]}get interstitialAssets(){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.interstitialAssets)&&void 0!==e?e:[]}get activeInterstitialId(){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.activeInterstitialId)&&void 0!==e?e:null}get activeInterstitialAssetId(){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.activeInterstitialAssetId)&&void 0!==e?e:null}get playingInterstitialId(){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.playingInterstitialId)&&void 0!==e?e:null}get playingInterstitialAssetId(){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.playingInterstitialAssetId)&&void 0!==e?e:null}get playableInterstitials$(){return this.interstitials$.pipe(pr(e=>e.filter(e=>this.canPlayInterstitial(e))))}get playableInterstitials(){return this.interstitials.filter(e=>this.canPlayInterstitial(e))}get playableInterstitialsForSeek(){return this.interstitials.filter(e=>!e.hasPlayed||e.hasPlayed&&!e.playOnce).reverse()}get realCurrentTimeOffsetMap(){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.realCurrentTimeOffsetMap)&&void 0!==e?e:{}}canPlayInterstitial(e){var t=!e.hasPlayed||e.hasPlayed&&!e.playOnce,e=this.pastInterstitials.includes(e.identifier);return!(!t||e)}}class Qc{constructor(e){this.store=e,this._interstitialQuery=new Kc(e)}get interstitialQuery(){return this._interstitialQuery}addInterstitials(i){Co(`interstitials.add: interstitials=${i.map(e=>e.identifier)}`),this.store.update(e=>{var t=i.filter(t=>!e.interstitials.find(e=>e.identifier===t.identifier));e.interstitials=td(e.interstitials,t)})}updateInterstitial(t,i){Co(`interstitials.update: id=${t}`),this.store.update(({interstitials:e})=>({interstitials:ed(e,t,i,"identifier")}))}removeInterstitials(t){Co(`interstitials.remove: ids=${t}`),this.store.update(({interstitials:e})=>({interstitials:id(e,t,"identifier")}))}addInterstitialToPastEvents(t){Co(`interstitials.pastInterstitials.add: id=${t}`),this.store.update(({pastInterstitials:e})=>({pastInterstitials:function(e,t,i,r){void 0===r&&(r="id");var n=Fo(i);return e.some(function(e){return n?e[r]===t:e===t})?ed(e,t,i,r):td(e,n?pt({},i,((e={})[r]=t,e)):i)}(e,t,t,"identifier")}))}removeInterstitialsFromPastEvents(t){Co(`interstitials.pastInterstitials.remove: id=${t}`),this.store.update(({pastInterstitials:e})=>({pastInterstitials:id(e,t,"identifier")}))}removeInterstitialsFromPastEventsFromTime(i){var e=this._interstitialQuery.interstitials.reduce((e,t)=>(E(t.startTime)>=i&&t.cueType===rc.Midroll&&e.push(t.identifier),e),[]);this.removeInterstitialsFromPastEvents(e)}addInterstitialAsset(t){Co(`interstitials.interstitialAssets.add: id=${t.identifier}`),this.store.update(e=>{e.interstitialAssets.find(e=>e.identifier===t.identifier)||(e.interstitialAssets=td(e.interstitialAssets,t))})}updateInterstitialAsset(t,i){Co(`interstitial.interstitialAssets.update: id=${t}`),this.store.update(({interstitialAssets:e})=>({interstitialAssets:ed(e,t,i,"identifier")}))}removeInterstitialAssets(t){Co(`interstitials.interstitialAssets.remove: id=${t}`),this.store.update(({interstitialAssets:e})=>({interstitialAssets:id(e,t,"identifier")}))}setActiveInterstitialId(t){Co(`interstitials.activeInterstitial.set: id=${t}`),this.store.update(e=>{t&&!e.interstitials.find(e=>e.identifier===t)||(e.activeInterstitialId=t)})}setPlayingInterstitialId(t){Co(`interstitials.playingInterstitial.set: id=${t}`),this.store.update(e=>{t&&!e.interstitials.find(e=>e.identifier===t)||(e.playingInterstitialId=t)})}setActiveInterstitialAssetId(t){Co(`interstitials.activeInterstitialAsseId.set: id=${t}`),this.store.update(e=>{t&&!e.interstitialAssets.find(e=>e.identifier===t)||(e.activeInterstitialAssetId=t)})}setPlayingInterstitialAssetId(t){Co(`interstitials.playingInterstitialAsseId.set: id=${t}`),this.store.update(e=>{t&&!e.interstitialAssets.find(e=>e.identifier===t)||(e.playingInterstitialAssetId=t)})}updateRealCurrentTimeOffsetMap(t,i){Co(`interstitials.realCurrentTimeMap.update: id=${t}, offset=${i}`),this.store.update(e=>{e.realCurrentTimeOffsetMap[t]=i})}destroy(){this.store.destroy()}reset(){this.store.reset()}}const qc=new class extends pl{constructor(){super({interstitials:[],interstitialAssets:[],pastInterstitials:[],activeInterstitialId:null,activeInterstitialAssetId:null,playingInterstitialId:null,playingInterstitialAssetId:null,realCurrentTimeOffsetMap:{}},{name:"interstitials",producerFn:lu,resettable:!0})}};let jc=null;function Hc(e){return new L(M.MEDIA_ERROR,P.INTERSTITIAL_ASSET_LIST_PARSING_ERROR,!1,e,K.FormatError)}function Gc(){return e=>e.pipe(pr(e=>({responseText:e.data.response.data.toString(),responseURL:e.data.response.uri,stats:e.stats})))}const Wc=(t,i,e,r)=>{const n=Object.assign(Object.assign({},t),{method:"GET",responseType:"text",extendMaxTTFB:e});if(Ru(n.url))return r.load(n,i).pipe(Gc());{const t=performance.now();return kc(n,i).pipe(pr(([e,t])=>({responseText:e.responseText,responseURL:e.responseURL,stats:t})),Qn(e=>{if(e instanceof hc&&e.isAuthOrCorsError)return Nc(n,i,r,t,e).pipe(Gc());throw e}))}};function zc(e){let t=0;return null==e||!e.resumptionOffset||Z(e=E(e.resumptionOffset))&&(t=e),t}function Yc(e){e=/interstitial:(.*):asset/.exec(e);return e&&1<e.length?e[1]:null}function Xc(e,i){return function(e){if(null==e||e.length<1)return{element:null,index:-1};var t=e.findIndex(e=>e.itemId===i);return-1<t?{element:e[t],index:t}:{element:null,index:-1}}(e)}function Jc(t){return function(e){return e.lift(new th(t))}}var Zc,eh,th=(function(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(ih.prototype,[{key:"call",value:function(e,t){return t.subscribe(e)}}]),ih);function ih(e){!function(e){if(!(e instanceof ih))throw new TypeError("Cannot call a class as a function")}(this),"tag"in this?Object.defineProperty(this,"tag",{value:void 0,enumerable:!0,configurable:!0,writable:!0}):this.tag=void 0,this.tag=e}function rh(e){var{method:t,isEncrypted:i,uri:r,format:n,formatversions:s}=e;return{method:t,isEncrypted:i,uri:r,format:n,formatversions:s,iv:e.ivBuf?new Uint8Array(e.ivBuf):null,keyId:e.keyIdBuf?new Uint8Array(e.keyIdBuf):null,key:e.keyBuf?new Uint8Array(e.keyBuf):null,pssh:e.psshBuf?new Uint8Array(e.psshBuf):null}}(su=Zc=Zc||{}).MustRequestResponse="MustRequestResponse",su.WaitingForKeyResponse="WaitingForKeyResponse",su.GotKeyResponse="GotKeyResponse";class nh extends pc{constructor(e,t,i,r=[]){super(P.KEY_LOAD_TIMEOUT,!1,e,i,!0),this.keyuri=t,this.response=i,this.mediaOptionIds=r}}(t=eh=eh||{})[t.InvalidState=0]="InvalidState",t[t.Abort=1]="Abort",t[t.OutputRestricted=2]="OutputRestricted",t[t.AlreadyFailedKey=3]="AlreadyFailedKey",t[t.HttpError=4]="HttpError",t[t.InternalError=5]="InternalError",t[t.LicenseServerError=6]="LicenseServerError",t[t.InsufficientCPC=7]="InsufficientCPC";class sh extends pc{constructor(e,t,i,r,n,s=!1,a=[]){super(P.KEY_LOAD_ERROR,s,e,i,!1),this.keyuri=t,this.isOkToRetry=r,this.keyErrorReason=n,this.mediaOptionIds=a}}class ah extends g{constructor(e,t,i,r){super(M.OTHER_ERROR,P.KEY_SYSTEM_GENERIC_ERROR,!0,e,i),this.keyuri=t,this.response=i,this.keysystemstring=r}}function oh(e,t){return e instanceof sh?new sh(e.message,e.keyuri,e.response,e.isOkToRetry,e.keyErrorReason,e.fatal,t):e instanceof nh?new nh(e.message,e.keyuri,e.response,t):e?new Q(e.fatal,e.reason,K.InternalError):null}const lh={id:"fairplaystreaming",systemStringPrefix:"com.apple.fps",keyFormatString:"com.apple.streamingkeydelivery",securityLevels:{AppleBaseline:0,AppleMain:1,Main:1,Baseline:0}},dh={id:"playready",systemStringPrefix:"com.microsoft.playready",keyFormatString:"com.microsoft.playready",securityLevels:{SL2000:0,SL3000:1}},uh={id:"widevine",systemStringPrefix:"com.widevine.alpha",keyFormatString:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",securityLevels:{WIDEVINE_SOFTWARE:0,WIDEVINE_HARDWARE:1}};function ch(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/\=+$/,"")}class hh{static strToBase64Encode(e){return btoa(e)}static base64DecodeToStr(e){return atob(e)}static base64Encode(e){return btoa(String.fromCharCode(...e))}static base64UrlEncode(e){return ch(hh.base64Encode(e))}static base64Decode(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0))}}class ph{static strToBase64Encode(e){return l.Buffer.from(e).toString("base64")}static base64DecodeToStr(e){return l.Buffer.from(e,"base64").toString()}static base64Encode(e){return l.Buffer.from(e).toString("base64")}static base64UrlEncode(e){return ch(ph.base64Encode(e))}static base64Decode(e){e=l.Buffer.from(e,"base64");return new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}}var fh,mh,gh,yh=void 0!==l.Buffer?ph:hh;const vh={avc1:"video/mp4",avc3:"video/mp4",dvav:"video/mp4",dva1:"video/mp4",hev1:"video/mp4",hvc1:"video/mp4",dvh1:"video/mp4",dvhe:"video/mp4"},Sh={mp4a:"audio/mp4","ac-3":"audio/mp4","ec-3":"audio/mp4"};function bh(e){function t(e,t,i){var r=e[t];e[t]=e[i],e[i]=r}t(e,0,3),t(e,1,2),t(e,4,5),t(e,6,7)}function Th(e){const t=e.split(":");let i=null;if("data"===t[0]&&2===t.length){const e=t[1].split(";"),r=e[e.length-1].split(",");if(2===r.length){const t="base64"===r[0],n=r[1];i=t?(e.splice(-1,1),yh.base64Decode(n)):function(e){const t=B.strToUtf8array(e).subarray(0,16),i=new Uint8Array(16);return i.set(t,16-t.length),i}(n)}}return i}const Ih=function(e,t){const i={videoCapabilities:[],audioCapabilities:[]};return e&&e.forEach(e=>{var t=e.split(".")[0].trim();t in vh&&i.videoCapabilities.push({contentType:vh[t]+";codecs="+e,robustness:""})}),t&&t.forEach(e=>{var t=e.split(".")[0].trim();t in Sh&&i.audioCapabilities.push({contentType:Sh[t]+";codecs="+e,robustness:""})}),i};let Eh={};class wh{constructor(e,t="",i=null,r=null,n=null){if(this.method=e,this.uri=t,this.iv=i,this.format=r,this.formatversions=n,this.key=null,this.keyId=null,this.pssh=null,this.isEncrypted=this.method&&"NONE"!==this.method,this.formatversions&&0!==this.formatversions.length||(this.formatversions=[1]),this.key=void 0,this.keyId=void 0,this.isEncrypted){const a=Th(this.uri);if(a)switch(r){case dh.keyFormatString:{this.format=dh.keyFormatString,this.pssh=a;const e=new Uint16Array(a.buffer,a.byteOffset,a.byteLength/2),t=String.fromCharCode.apply(null,Array.from(e)),i=t.substring(t.indexOf("<"),t.length),r=(new DOMParser).parseFromString(i,"text/xml").getElementsByTagName("KID")[0];if(r){var s=null;if(s=r.childNodes[0]?r.childNodes[0].nodeValue:r.getAttribute("VALUE")){const t=yh.base64Decode(s).subarray(0,16);bh(t),this.keyId=t}}break}case uh.keyFormatString:this.format=uh.keyFormatString,this.pssh=a,22<=a.length&&(this.keyId=a.subarray(a.length-22,a.length-6));break;case lh.keyFormatString:this.format=lh.keyFormatString;default:{let e=a.subarray(0,16);if(16!==e.length){const t=new Uint8Array(16);t.set(e,16-e.length),e=t}this.keyId=e;break}}if(!this.keyId||16!==this.keyId.byteLength){let e=Eh[this.uri];if(!e){const t=Object.keys(Eh).length%Number.MAX_SAFE_INTEGER;e=new Uint8Array(16),new DataView(e.buffer,12,4).setUint32(0,t),Eh[this.uri]=e}this.keyId=e}}}get keyTagInfo(){var{method:e,isEncrypted:t,uri:i,iv:r,keyId:n,key:s,format:a,formatversions:o,pssh:l}=this;return{method:e,isEncrypted:t,uri:i,iv:r,keyId:n,key:s,format:a,formatversions:o,pssh:l}}static clearKeyUriToKeyIdMap(){Eh={}}}const Oh=Vi(void 0);function Ah(e,t,i=1){return e.pipe(cn(t),As(i))}(au=fh=fh||{}).NONE="NONE",au.GET_REQUEST_INFO="GET_REQUEST_INFO",au.GET_CHALLENGE="GET_CHALLENGE",au.GET_KEY_RESPONSE="GET_KEY_RESPONSE",au.PROCESS_LICENSE="PROCESS_LICENSE";class Rh{constructor(e,t,i,r){this.session=e,this.onkeystatuseschange=t,this.onkeymessage=i,this.logger=r,this.isClosing$=new Si(!1),this.closed$=new Si(!1);const n=Ac(this.session);n.listen("keystatuseschange",this.isClosing$.pipe(cn(e=>!0===e)),this.onkeystatuseschange),n.listen("message",this.closed$.pipe(cn(e=>!0===e)),this.onkeymessage)}get isClosing(){return this.isClosing$.value}get isClosed(){return this.closed$.value}destroy(){this.isClosing$.next(!0);const e=this.session;return Br(e.remove().catch(e=>{}).then(()=>e.close()).catch(e=>{})).pipe(eo(()=>{this.isClosing$.next(!1),this.closed$.next(!0)}),Bs(()=>{this.isClosing$.next(!1),this.closed$.next(!0)}))}}class kh{constructor(e,t=null){this.decryptdata=e,this._requestState$=new Si(fh.NONE),this.destroy$=new Jt,this.currentObservable=null,this.session=null,this.oldSessions=[],this.session=t}get requestState(){return this._requestState$.value}get onKeyRequestState$(){return this._requestState$}destroy(){this.destroy$.next()}abort(){var e;this.requestState!==fh.NONE&&(e=new sh("Aborted",this.decryptdata.uri,K.KeySystemAbort,!0,eh.Abort),this.error(e))}setKeyRequestState(e){if(this.currentObservable){const t=new sh(`Unexpected state transition ${this.requestState}->${e}`,this.decryptdata.uri,K.KeySystemUnexpectedStateTransition,!0,eh.InvalidState);this.error(t)}this._requestState$.next(e);const t=new tr;return e===fh.NONE?(t.complete(),this.currentObservable=null):this.currentObservable=t,t}resolveState(e,t){if(!this.currentObservable)return!1;if(e!==this.requestState){const t=new sh(`Unexpected state ${this.requestState} != ${e}`,this.decryptdata.uri,K.KeySystemUnexpectedState,!0,eh.InvalidState);return this.error(t),!1}if(t instanceof Error)return this.error(t),!1;{const e=this.currentObservable;return this.currentObservable=null,e.next(t),e.complete(),!0}}error(e){if(this.currentObservable){const t=this.currentObservable;this.currentObservable=null,t.error(e)}this.setKeyRequestState(fh.NONE)}}function Ch(e){return`uri=${re(e.uri)} keyId=${He(e.keyId)}`}class Mh{constructor(e,t,i,r,n,s,a){this.mediaKeys=e,this.systemString=t,this.config=i,this.eventEmitter=r,this.useSingleKeySession=n,this.sessionHandler=s,this.logger=a,this.destroy$=new Jt,this.setCert=!1,this.certificate$=new Si(null),this._keyStatusChange$=new Jt,this.shouldDestroyMediaKeys=!1,this.itemId="",this.sessions=[],this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={},this.onkeystatuseschange=this.handleKeyStatusesChange.bind(this),this.onkeymessage=this.handleKeyMessage.bind(this)}get keyStatusChange$(){return this._keyStatusChange$}destroy(){this.isDestroying=!0,this.destroy$.next();for(const e of Object.values(this.keyIdToKeyInfo))this._abortKeyRequest(e);const e=this.sessions.map(e=>e.destroy()),t=an(()=>0===e.length,Oh,tn(e)).pipe(Ys(void 0),Bs(()=>{this.mediaKeys=void 0,this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={}}));return wh.clearKeyUriToKeyIdMap(),t}setServerCertificate(e=null){return this.needsCert?(e&&this.certificate$.next(e),Ah(this.certificate$,e=>null!=e).pipe(bo(1e4)).pipe(La(e=>this.setCert?Vi(!0):!this.setCertSubject||this.setCertSubject.isStopped?(this.setCertSubject=new tr,Br(this.mediaKeys.setServerCertificate(e)).pipe(eo(e=>{e=void 0===e||e;this.setCert=e,this.setCertSubject.next(e),this.setCertSubject.complete()}),Qn(e=>(this.setCert=!1,this.setCertSubject.error(e),Oh)),La(()=>this.setCertSubject))):this.setCertSubject),Qn(e=>{throw e}))):Vi(!0)}ensureKeyContext(e){var t=e.uri;this.keyUriToKeyInfo[t]||(this.keyUriToKeyInfo[t]=new kh(e));const i=this.keyUriToKeyInfo[t];if(i.session)return i;if(this.useSingleKeySession&&0<this.sessions.length)return i.session=this.sessions[0].session,i;t=this.mediaKeys.createSession();return t&&this.sessions.push(new Rh(t,this.onkeystatuseschange,this.onkeymessage,this.logger)),i.session=t,i}startKeyRequest(t){const i=t.uri,r=this.ensureKeyContext(t);if(null==r||!r.session)return Ki(new ah("Could not create key session",t.uri,K.KeySystemFailedToCreateSession,this.systemString));var e=B.utf8arrayToStr(t.keyId);return this.keyIdToKeyInfo[e]=r,tn([this.getKeyRequestInfo(r),this.setServerCertificate()]).pipe(pr(e=>e[0]),La(e=>{var t;return null===(t=this.sessionHandler)||void 0===t||t.licenseChallengeSubmitted({keyuri:i,keyFormat:this.systemString}),this.generateLicenseChallenge(r,e).pipe(Qn(e=>{var t;throw null===(t=this.sessionHandler)||void 0===t||t.licenseChallengeError({keyuri:i}),e}))}),La(e=>{var t;if(0===e.length)throw new sh("empty license",i,K.KeySystemFailedToGenerateLicenseRequest,!0,eh.InternalError);return null===(t=this.sessionHandler)||void 0===t||t.licenseChallengeCreated({keyuri:i,cdmVersion:this.cdmVersion}),this.getKeyRequestResponse(r,e)}),La(e=>{var t;return null===(t=this.sessionHandler)||void 0===t||t.licenseResponseSubmitted({keyuri:i}),this.handleParsedKeyResponse(r,e).pipe(Qn(e=>{var t;throw null===(t=this.sessionHandler)||void 0===t||t.licenseResponseError({keyuri:i}),e}))}),pr(()=>{var e;return null===(e=this.sessionHandler)||void 0===e||e.licenseResponseProcessed({keyuri:i}),r.setKeyRequestState(fh.NONE),this.removeSessions(r.decryptdata,!1).subscribe(),t}),Qn(e=>{throw this.handleKeyExchangeError(r,e),e}),Bs(()=>{this._abortKeyRequest(r)}))}_abortKeyRequest(e){var t,i;e&&(i=e.decryptdata.uri,B.utf8arrayToStr(e.decryptdata.keyId),e.requestState!==fh.NONE&&(null===(t=this.sessionHandler)||void 0===t||t.keyAborted({keyuri:i})),e.abort())}handleKeyExchangeError(e,t){e.error(t),B.utf8arrayToStr(e.decryptdata.keyId)}updateItemId(e){this.itemId=e}removeKey(e){return this.removeKeyInternal(e)}removeKeyInternal(e){const t=this.keyUriToKeyInfo[e.uri];if(t&&t.session){var i=t.session;t.abort(),t.destroy();var r=B.utf8arrayToStr(e.keyId);return this.keyIdToKeyInfo[r]=void 0,this.keyUriToKeyInfo[e.uri]=void 0,this.removeSession(i)}return Oh}removeSessions(e,t){const i=this.keyUriToKeyInfo[e.uri];if(i){const r=i.oldSessions.map(e=>this.removeSession(e));return i.oldSessions=[],an(()=>0===r.length,Oh,tn(r)).pipe(La(()=>t?this.removeKeyInternal(e):Oh))}return Oh}removeSession(t){const e=this.sessions.findIndex(e=>e.session===t),i=this.sessions[e];return-1<e&&this.sessions.splice(e,1),this.sessionIdToKeyUri[t.sessionId]=void 0,i?i.destroy():Oh}getKeyRequestInfo(e){var t=e.decryptdata,i=t.uri,e=e.setKeyRequestState(fh.GET_REQUEST_INFO);return this.eventEmitter.trigger(D.KEY_REQUEST_STARTED,{keyuri:i,decryptdata:t,timestamp:Date.now()}),e}setKeyRequestInfo(e,t){const i=this.keyUriToKeyInfo[e];return!!i&&i.resolveState(fh.GET_REQUEST_INFO,t)}sanitizeRequest(e){return e}generateLicenseChallengeInternal(t,e,i){const r=t.decryptdata,n=t.session,s=r.uri,a=r.keyId;let o;var l=t.setKeyRequestState(fh.GET_CHALLENGE);if(n.generateRequestPromise)o=Fr(n.generateRequestPromise,Ii).pipe(La(()=>this.generateRequestInitialized(t,"usable"===i)));else{const i=this.generateInitData(a,r,e);n.generateRequestPromise=n.generateRequest(i.initDataType,i.initData),o=Fr(n.generateRequestPromise,Ii).pipe(eo(()=>{this.sessionIdToKeyUri[n.sessionId]=s}),Qn(e=>{throw new ah(e.message,t.decryptdata.uri,K.KeySystemFailedToGenerateLicenseRequest,this.systemString)}))}return tn([l,o]).pipe(pr(e=>new Uint8Array(e[0])))}generateLicenseChallenge(e,t){const i=e.decryptdata,r=e.session,n=i.uri,s=i.keyId;let a,o;if(B.utf8arrayToStr(i.keyId),e.licenseChallenge&&e.resolveState(fh.GET_CHALLENGE,e.licenseChallenge),t=this.sanitizeRequest(t),e.requestInfo=t,this.sessionId=this.sessionId||t&&t.sessionId||this.itemId,this.systemString===dh.systemStringPrefix){const e=new Uint8Array(s);bh(e),a=r.keyStatuses.get(e)}else a=r.keyStatuses.get(s);switch(a){case"status-pending":case"usable":case"expired":case void 0:o=this.generateLicenseChallengeInternal(e,t,a);break;default:o=Ki(new ah(`Bad internal state state=${a}`,n,K.KeySystemUnexpectedState,this.systemString))}return o}setParsedResponse(e,t){const i=this.keyUriToKeyInfo[e];i&&i.resolveState(fh.GET_KEY_RESPONSE,t)}handleKeyStatusesChange(e){e.target.keyStatuses.forEach((e,t,i)=>{t=new Uint8Array(t);this.systemString===dh.systemStringPrefix&&bh(t);t=B.utf8arrayToStr(t),t=this.keyIdToKeyInfo[t];t&&this.handleKeyStatusForKey(e,t)})}handleKeyStatusForKey(e,t){if(t){var i=t.decryptdata,r=i.uri;switch(e){case"internal-error":this.logger.error(`${this.systemString} internal-error for key ${Ch(i)}`),this._signalError(t,new sh("Got internal error from key system",r,K.KeySystemInternalError,!1,eh.InternalError));break;case"usable":t.requestState===fh.PROCESS_LICENSE&&t.resolveState(fh.PROCESS_LICENSE,void 0);break;case"output-restricted":this.logger.warn(`${this.systemString} output-restricted for key ${Ch(i)}`),t.session&&this.removeSession(t.session).pipe(Ka(this.destroy$)).subscribe(),this._signalError(t,new sh("output-restricted",r,K.KeySystemOutputRestricted,!1,eh.OutputRestricted));break;case"expired":this.logger.warn(`${this.systemString} expired for key ${Ch(i)}. Attempting renewal`),this._signalRenewal(t)}}}_scheduleRenewal(e,t){En(t).pipe(eo(()=>this._signalRenewal(e)),Ka(yn(e.destroy$,this.destroy$,Ah(e.onKeyRequestState$,e=>e===fh.GET_REQUEST_INFO)))).subscribe()}_signalRenewal(e){this._keyStatusChange$.next({decryptdata:e.decryptdata,status:"needs-renewal"})}_signalError(e,t){this._keyStatusChange$.next({decryptdata:e.decryptdata,status:"error",error:t}),e.error(t)}}const Ph="org.w3.clearkey",xh={id:"clearkey",systemStringPrefix:Ph,keyFormatString:Ph,securityLevels:{NONE:0}},Dh=["clearkey","fairplaystreaming","playready","widevine"],_h={initDataTypes:["keyids","cenc"]},Lh={initDataTypes:["cenc"]},Nh=new Uint8Array([148,206,134,251,7,255,79,67,173,184,147,210,250,150,140,162]);(p=mh=mh||{})[p.CENC=1667591779]="CENC",p[p.CBCS=1667392371]="CBCS",gh=gh||{},gh[gh.ISOFFLINE=2]="ISOFFLINE";class Fh extends Mh{constructor(e,t,i,r,n,s,a){super(e,t,i,r,n,s,a),this._hasSetRenewal=!1}static get systemId(){return Nh}static get requestAccessConfig(){return Lh}get needsCert(){return!0}sanitizeRequest(e){return{assetId:e&&e.assetId?new Uint8Array(e.assetId):void 0,ssc:e&&e.ssc?new Uint8Array(e.ssc):void 0,sessionId:e&&e.sessionId?e.sessionId:void 0,isOffline:!(!e||!e.isOffline)}}_scheduleRenewal(e,t){this.useSingleKeySession?this._hasSetRenewal||(this._hasSetRenewal=!0,En(t).pipe(eo(()=>{var e=Object.values(this.keyUriToKeyInfo)[0];e&&this._signalRenewal(e)}),Bs(()=>{this._hasSetRenewal=!1}),Ka(this.destroy$)).subscribe()):super._scheduleRenewal(e,t)}handleParsedKeyResponse(t,e){var i=t.decryptdata.uri,r=e.statusCode,n=e.ckc&&0!==e.ckc.byteLength?e.ckc:e.license&&0!==e.license.byteLength?e.license:void 0;if(0===r&&!n)return Ki(new sh("License request resulted in HTTP Error",i,{code:r,text:"HTTP Error"},!0,eh.HttpError));if(0!==r)return Ki(new sh("License server responded with error",i,{code:r,text:"Server Error"},!1,eh.LicenseServerError));if(!n)return Ki(new sh("License server responded with invalid license",i,{code:r,text:"Invalid license"},!1,eh.LicenseServerError));const s=e.renewalDate,a=new Date,o=s>a?s.getTime()-a.getTime():0;0<o&&o<Math.pow(2,31)&&this._scheduleRenewal(t,o);const l=this.makeProcessLicenseRequestMessage(t,n,o),d=t.session,u=Br(d.update(l)).pipe(eo(()=>{var e=t.decryptdata.keyId,e=d.keyStatuses.get(e);this.handleKeyStatusForKey(e,t)}),Qn(e=>{throw new ah(e.message,t.decryptdata.uri,K.KeySystemFailedToUpdateSession,this.systemString)}));return tn([t.setKeyRequestState(fh.PROCESS_LICENSE),u]).pipe(Ys(void 0))}makeKeyRequests(e){const t=[];for(const i of e){const e=i.decryptdata,r=i.requestInfo,n=e.keyId;t.push({keyId:n,assetId:r?r.assetId:void 0,ssc:r?r.ssc:void 0,versionList:e.formatversions})}return t}getSchemeAndFlags(e,t){e="ISO-23001-7"===e.method?mh.CENC:mh.CBCS;let i=0;return t&&(i|=gh.ISOFFLINE),{scheme:e,flags:i}}generateInitData(e,t,i){var{scheme:r,flags:n}=this.getSchemeAndFlags(t,i.isOffline),i=this.makeKeyRequests([{decryptdata:t,requestInfo:i}]);return{initData:this.makeFpsKeySystemInitData(r,n,i),initDataType:"cenc"}}generateRequestInitialized(t,e){Jc(`[Keys] challenge create start uri=${re(t.decryptdata.uri)} versions=${JSON.stringify(t.decryptdata.formatversions)}`);e=this.makeKeyRequestMessage(t,e);return e?Br(t.session.update(e)).pipe(eo(()=>{t.requestInfo=void 0}),Qn(e=>{throw Jc(`[Keys] ${this.systemString} FAIL: generateRequestInitialized keyuri=${re(t.decryptdata.uri)} message=${e.message}`),new ah(e.message,t.decryptdata.uri,K.KeySystemFailedToGenerateLicenseRenewal,this.systemString)})):Ki(new sh("Unable to generate request using existing keySession",t.decryptdata.uri,K.KeySystemFailedToGenerateLicenseRequest,!0,eh.InvalidState))}getKeyRequestResponse(e,t){var i=e.decryptdata.uri,e=e.setKeyRequestState(fh.GET_KEY_RESPONSE);return this.eventEmitter.trigger(D.LICENSE_CHALLENGE_CREATED,{keyuri:i,licenseChallenge:t,keysystem:this.systemString}),e}resolveSPCPromise(e,t){e.resolveState(fh.GET_CHALLENGE,t)}}const Bh=1919710053;function Uh(e,t,i){if(!(i+4>e.byteLength)){t=t.getUint32(i);if(!((i+=4)+t>e.byteLength)){e=e.slice(i,i+t);return{pos:i+=t,data:e}}}}function $h(t){const i={},r=new DataView(t.buffer);let n=4;const s=r.getUint32(n);n+=4;for(let e=0;e<s&&n<t.byteLength&&!(n+16>t.byteLength);++e){const s=t.slice(n,n+16);if(n+=16,n+4>t.byteLength)break;var a=Uh(t,r,n);if(!a)break;n=a.pos,i[B.utf8arrayToStr(s)]=a.data}return i}function Vh(e,t,i,r){var n=r?r.byteLength:0;return t.setUint32(i,n),n&&e.set(r,i+4),i+(4+n)}function Kh(e){let t=4;for(const i of e)t+=28+(i.assetId?i.assetId.byteLength:0)+(i.ssc?i.ssc.byteLength:0)+(i.versionList?4*i.versionList.length:0);return t}function Qh(e,t,i,r){t.setUint32(i,r.length),i+=4;for(const n of r)if(e.set(n.keyId,i),i=Vh(e,t,i+=16,n.assetId),i=Vh(e,t,i,n.ssc),t.setUint32(i,n.versionList?n.versionList.length:0),i+=4,n.versionList)for(const e of n.versionList)t.setUint32(i,e),i+=4;return i}class qh extends Fh{constructor(e,t,i,r,n,s){super(e,t,i,r,void 0===i.useMultipleKeySessions||!i.useMultipleKeySessions,n,s),this.offlineKeyExchange=!1}makeProcessLicenseRequestMessage(e,t,i){t=new Uint8Array(t);return function(e,t){let i=0;for(const t of e)i+=24+t.ckc.byteLength;let r=0;const n=new Uint8Array(8+i),s=new DataView(n.buffer);t?s.setUint32(0,1868786531):s.setUint32(0,1667982195),s.setUint32(4,e.length),r+=8;for(const t of e)n.set(t.keyId,r),r+=16,s.setUint32(r,t.expirySec),r+=4,r=Vh(n,s,r,t.ckc);return n}([{keyId:e.decryptdata.keyId,expirySec:i/1e3,ckc:t}],this.offlineKeyExchange)}makeFpsKeySystemInitData(e,t,i){this.isFlagOffline(t)&&(this.offlineKeyExchange=!0);i=function(e,t,i){var r=Kh(i);const n=new Uint8Array(8+r),s=new DataView(n.buffer);return s.setUint32(0,e),s.setUint32(4,1<<24|16777215&t),Qh(n,s,8,i),n}(e,t,i);return pe.pssh(qh.systemId,[],i)}isFlagOffline(e){return(e&gh.ISOFFLINE)===gh.ISOFFLINE}makeKeyRequestMessage(e){var t;return null!==(t=e.requestInfo)&&void 0!==t&&t.isOffline&&(this.offlineKeyExchange=!0),function(e,t){var i=Kh(e);const r=new Uint8Array(4+i),n=new DataView(r.buffer);return t?n.setUint32(0,1868788331):n.setUint32(0,1668442994),Qh(r,n,4,e),r}([{keyId:e.decryptdata.keyId,assetId:e.requestInfo?e.requestInfo.assetId:void 0,ssc:e.requestInfo?e.requestInfo.ssc:void 0,versionList:e.decryptdata.formatversions}],this.offlineKeyExchange)}handleKeyMessage(e){if(e.message.byteLength<4)this.logger.warn("Unexpected message");else{const t=new Uint8Array(e.message),i=new DataView(e.message),r=i.getUint32(0);if(this.isDestroying&&r!==Bh)this.logger.warn(`In the middle of destroying, ignore command: ${r.toString(16)}`);else switch(r){case 1667592820:this.logger.warn("Certificate not set!");break;case 1919837559:{const e=$h(t);for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t)){const e=this.keyIdToKeyInfo[t];e&&this._signalRenewal(e)}break}case 1936745331:{const e=$h(t);for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t)){const i=this.keyIdToKeyInfo[t],r=e[t];i&&r&&this.resolveSPCPromise(i,r)}break}case Bh:this._handleLicenseRelease(t);break;case 1667525993:{const e=Uh(t,i,4);e&&(this.cdmVersion=B.utf8arrayToStr(e.data));break}default:this.logger.warn(`Unrecognized command:'0x${r.toString(16)}'`)}}}_handleLicenseRelease(e){new DataView(e.buffer).getUint32(4),this.eventEmitter.trigger(D.LICENSE_RELEASED,{keysystem:this.systemString,itemId:this.itemId,releaseRecord:{}})}}ou=qh;const jh={fpsd:B.strToUtf8array("fpsd"),fpsi:B.strToUtf8array("fpsi"),fpsk:B.strToUtf8array("fpsk"),fkri:B.strToUtf8array("fkri"),fkai:B.strToUtf8array("fkai"),fkcx:B.strToUtf8array("fkcx"),fkvl:B.strToUtf8array("fkvl")};const Hh={initDataTypes:["cenc"]},Gh=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);class Wh extends Mh{constructor(e,t,i,r,n,s){super(e,t,i,r,!1,n,s),this.shouldDestroyMediaKeys=!0}static get systemId(){return Gh}static get requestAccessConfig(){return Hh}get needsCert(){return!1}generateInitData(e,t){t=t.pssh;return{initData:pe.pssh(Wh.systemId,[],t),initDataType:"cenc"}}removeKey(e){return super.removeSessions(e,!0)}ensureKeyContext(e){const t=e.uri,i=this.keyUriToKeyInfo[t];return null!=i&&i.session&&(i.oldSessions.push(i.session),i.session=null),super.ensureKeyContext(e)}getKeyRequestResponse(e,t){var i=e.decryptdata.uri,r=e.setKeyRequestState(fh.GET_KEY_RESPONSE);return this.eventEmitter.trigger(D.LICENSE_CHALLENGE_CREATED,{keyuri:i,licenseChallenge:t,keysystem:this.systemString,keyId:e.decryptdata.keyId}),r}generateRequestInitialized(e){var t=e.licenseChallenge;return e.requestInfo=void 0,e.resolveState(fh.GET_CHALLENGE,t),Oh}handleParsedKeyResponse(t,e){const i=t.decryptdata.uri,r=e.statusCode;if(0!==r)return Ki(new sh("License server responded with error",i,{code:r,text:"Server error"},!1,eh.LicenseServerError));if(!e.license||!e.license.byteLength)return Ki(new sh("License server responded with invalid license",i,{code:r,text:"Invalid license"},!1,eh.LicenseServerError));if(e.renewalDate){const i=e.renewalDate,r=new Date,n=i>r?i.getTime()-r.getTime():0;0<n&&n<Math.pow(2,31)&&this._scheduleRenewal(t,n)}return tn([t.setKeyRequestState(fh.PROCESS_LICENSE),Br(t.session.update(e.license)).pipe(eo(()=>{t.resolveState(fh.PROCESS_LICENSE,void 0)}),Qn(e=>{throw this.logger.error(`${this.systemString} FAIL: Failed to update with key response message=${e.message}`),new ah(e.message,t.decryptdata.uri,K.KeySystemFailedToUpdateSession,this.systemString)}))]).pipe(Ys(void 0))}handleKeyMessage(e){if(this.isDestroying)this.logger.warn("In the middle of destroying, ignore key message");else{const t=new DOMParser,i=new("utf16"===this.config.playReadyMessageFormat?Uint16Array:Uint8Array)(e.message.buffer||e.message),r=String.fromCharCode.apply(null,Array.from(i)),n=t.parseFromString(r,"application/xml").getElementsByTagName("PlayReadyKeyMessage")[0];if(n&&"LicenseAcquisition"===n.getAttribute("type")){const s=t.parseFromString(r,"application/xml").getElementsByTagName("Challenge")[0];if(s&&"base64encoded"===s.getAttribute("encoding")&&0!==s.childNodes.length){const a=yh.base64Decode(s.childNodes[0].nodeValue),o=B.utf8arrayToStr(a),l=t.parseFromString(o,"application/xml").getElementsByTagName("KID")[0];e=null,e=l.childNodes[0]?l.childNodes[0].nodeValue:l.getAttribute("VALUE"),e=yh.base64Decode(e).subarray(0,16);bh(e);const d=this.keyIdToKeyInfo[B.utf8arrayToStr(e)];d&&(d.licenseChallenge=a,d.resolveState(fh.GET_CHALLENGE,a))}else this.logger.warn(`${this.systemString} wrong challenge format or empty challenge`)}else this.logger.warn(`${this.systemString} unrecognized message ignore it`)}}}su=Wh;const zh={initDataTypes:["cenc","keyids"]},Yh=new Uint8Array([237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237]),Xh={clearkey:xh,fairplaystreaming:lh,playready:dh,widevine:uh},Jh={clearkey:[["org.w3.clearkey",class extends Mh{constructor(e,t,i,r,n,s){super(e,t,i,r,!1,n,s)}static get requestAccessConfig(){return _h}get needsCert(){return!1}getKeyRequestResponse(e,t){return $c({url:e.decryptdata.uri,xhrSetup:this.config.xhrSetup},{maxLoadTimeMs:0,maxTimeToFirstByteMs:0,autoRetry:!1,timeoutRetry:null,errorRetry:null},xc()).pipe(pr(([e])=>{e=new Uint8Array(e);return{response:this.parseResponse(t,e)}}))}parseResponse(e,t){t={kty:"oct",kid:yh.base64UrlEncode(e),k:yh.base64UrlEncode(t)};return B.strToUtf8array(JSON.stringify({keys:[t]}))}handleParsedKeyResponse(i,e){e=e.response;return tn([i.setKeyRequestState(fh.PROCESS_LICENSE),Br(i.session.update(e)).pipe(eo(()=>{var e=i.decryptdata.keyId,e=i.session.keyStatuses.get(e);this.handleKeyStatusForKey(e,i)}),Qn(e=>{var t={code:e.code,text:"Failed to update with key response"};throw new ah(e.message,i.decryptdata.uri,t,this.systemString)}))]).pipe(Ys(void 0))}generateInitData(e){return{initData:function(e){e={kids:e.map(yh.base64UrlEncode)};return B.strToUtf8array(JSON.stringify(e))}([e]),initDataType:"keyids"}}generateRequestInitialized(){return Oh}sanitizeRequest(e){return e}handleKeyMessage(e){if(!this.isDestroying&&"license-request"===e.messageType){e=new Uint8Array(e.message),e=JSON.parse(B.utf8arrayToStr(e).trim());if(1===e.kids.length){const t=yh.base64Decode(e.kids[0]),i=B.utf8arrayToStr(t),r=this.keyIdToKeyInfo[i];r&&r.resolveState(fh.GET_CHALLENGE,t)}}}}]],fairplaystreaming:[["com.apple.fps.3_0",class extends Fh{constructor(e,t,i,r,n,s){super(e,t,i,r,!1,n,s),this.sessions=[],this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={}}static get needsCert(){return!0}handleKeyExchangeError(e,t){this.removeKey(e.decryptdata).subscribe(),super.handleKeyExchangeError(e,t)}_abortKeyRequest(e){return!this.isDestroying&&e&&e.requestState!==fh.NONE&&this.removeKey(e.decryptdata).subscribe(),super._abortKeyRequest(e)}makeFpsKeySystemInitData(e,t,i){const r=[jh.fpsd,(n=e,e=t,t=new Uint8Array(4),pe.set32(n,t,0),pe.box(jh.fpsi,new Uint8Array([0,e>>16&255,e>>8&255,255&e]),t))];var n;for(const s of i)r.push(function(t,e,i,r){const n=[jh.fpsk],s=pe.box(jh.fkri,new Uint8Array([0,0,0,0]),t);if(n.push(s),e&&e.byteLength&&n.push(pe.box(jh.fkai,e)),i&&i.byteLength&&n.push(pe.box(jh.fkcx,i)),r&&r.length){const t=new Uint8Array(4*r.length);let e=0;for(const i of r)pe.set32(i,t,e),e+=4;n.push(pe.box(jh.fkvl,t))}return pe.box.apply(null,n)}(s.keyId,s.assetId,s.ssc,s.versionList));i=pe.box.apply(null,r);return pe.pssh(Fh.systemId,null,i)}makeKeyRequestMessage(e,t){if(t)return B.strToUtf8array("renew")}makeProcessLicenseRequestMessage(e,t,i){t=JSON.stringify([{keyID:yh.base64Encode(e.decryptdata.keyId),payload:yh.base64Encode(new Uint8Array(t))}]);return B.strToUtf8array(t)}handleKeyMessage(e){const t=e.target,i=t.sessionId,r=e.messageType,n=this.sessionIdToKeyUri[i];let s;if(n)s=this.keyUriToKeyInfo[n];else for(const e of Object.values(this.keyUriToKeyInfo))e&&e.session===t&&(s=e);if(s)switch(r){case"license-request":{const t=new Uint8Array(e.message),i=B.utf8arrayToStr(t);try{JSON.parse(i).forEach(e=>{var t=yh.base64DecodeToStr(e.keyID),e=yh.base64Decode(e.payload),t=this.keyIdToKeyInfo[t];t&&this.resolveSPCPromise(t,e)})}catch(e){this.logger.warn("[Keys] got unexpected license-request format"),this.resolveSPCPromise(s,t)}break}case"license-renewal":{const t=new Uint8Array(e.message);this.resolveSPCPromise(s,t);break}case"license-release":this._handleLicenseRelease(t);break;default:this.logger.warn(`[Keys] Unexpected messageType ${r}`)}else this.logger.warn("[Keys] No key associated with session")}_handleLicenseRelease(e){e.update(B.strToUtf8array("acknowledged")).catch(e=>{this.logger.error(`Promise error: ${e.message}`)})}}],["com.apple.fps",ou]],playready:[["com.microsoft.playready.recommendation",su]],widevine:[["com.widevine.alpha",class extends Mh{constructor(e,t,i,r,n,s){super(e,t,i,r,!1,n,s),this.shouldDestroyMediaKeys=!0}static get systemId(){return Yh}static get requestAccessConfig(){return zh}get needsCert(){return!0}removeKey(e){return super.removeSessions(e,!0)}ensureKeyContext(e){const t=e.uri,i=this.keyUriToKeyInfo[t];return null!=i&&i.session&&(i.oldSessions.push(i.session),i.session=null),super.ensureKeyContext(e)}getKeyRequestResponse(e,t){var i=e.decryptdata.uri,r=e.setKeyRequestState(fh.GET_KEY_RESPONSE);return this.eventEmitter.trigger(D.LICENSE_CHALLENGE_CREATED,{keyuri:i,licenseChallenge:t,keysystem:this.systemString,keyId:e.decryptdata.keyId}),r}handleParsedKeyResponse(t,e){t.licenseChallenge=void 0;const i=t.decryptdata.uri,r=e.statusCode;if(0!==r)return Ki(new sh("License server responded with error",i,{code:r,text:"Server error"},!1,eh.LicenseServerError));if(!e.license||!e.license.byteLength)return Ki(new sh("License server responded with invalid license",i,{code:r,text:"Invalid license"},!1,eh.LicenseServerError));if(e.renewalDate){const i=e.renewalDate,r=new Date,n=i>r?i.getTime()-r.getTime():0;0<n&&n<Math.pow(2,31)&&this._scheduleRenewal(t,n)}return tn([t.setKeyRequestState(fh.PROCESS_LICENSE),Br(t.session.update(e.license)).pipe(eo(()=>{var e=t.decryptdata.keyId,e=t.session.keyStatuses.get(e);this.handleKeyStatusForKey(e,t)}),Qn(e=>{throw this.logger.error(`${this.systemString} FAIL: Failed to update with key response code=${e.code} message=${e.message}`),new ah(e.message,t.decryptdata.uri,{code:e.code,text:"Failed to update with key response"},this.systemString)}))]).pipe(Ys(void 0))}generateInitData(e,t){return{initData:t.pssh,initDataType:"cenc"}}generateRequestInitialized(e){var t=e.licenseChallenge;return e.requestInfo=void 0,e.resolveState(fh.GET_CHALLENGE,t),Oh}handleKeyMessage(i){if(this.isDestroying)this.logger.warn("In the middle of destroying, ignore key message");else{const r=i.target;let e=null,t=null;if(r.sessionId in this.sessionIdToKeyUri)e=this.sessionIdToKeyUri[r.sessionId],t=this.keyUriToKeyInfo[e];else for(const[i,n]of Object.entries(this.keyUriToKeyInfo))if(n.session===r){e=i,t=n;break}if(t)switch(i.messageType){case"license-request":{const r=new Uint8Array(i.message);t.resolveState(fh.GET_CHALLENGE,r);break}}else this.logger.warn(`${this.systemString} empty keyuri and keyInfo`)}}}]]},Zh=xh.id;class ep{createMediaKeys(t,e,i,r,n){let s=ep.idToMediaKeysInfoMap[t];if(!s){const a=Ih(e,i),o=new tr;ep.requestKeySystemAccess(t,a,n,r).pipe(La(function(e){return Br((ep.idToMediaKeysInfoMap[t].keySystemAccess=e).createMediaKeys())}),eo(e=>{o.next(e),o.complete()}),Qn(e=>(o.error(new ah(`could not initialize key system: ${e.message}`,void 0,K.KeySystemFailedToInitialize,t)),wi)),Ka(ep.destroy$)).subscribe(),s=ep.idToMediaKeysInfoMap[t]={mediaKeys$:o,keySystemAccess:null}}return s.mediaKeys$}destroyMediaKeys(){ep.destroy$.next(),ep.idToMediaKeysInfoMap={}}static getKeySystemIdForDecryptData(e){let t;if(e){t=Zh;var i=e.format;for(const e of Dh){var r=Xh[e];if((null==r?void 0:r.keyFormatString)===i){t=e;break}}}if(!t)throw Error("No matching key system");return t}static requestKeySystemAccess(e,t,i,r){if("undefined"==typeof navigator||void 0===navigator.requestMediaKeySystemAccess)return Ki(new ah("navigator undefined",void 0,K.KeySystemUndefinedNavigator,e));const n=Jh[e];let s=Ki(new ah("no key systems to try",void 0,K.KeySystemNoKeySystemsToTry,e));for(const e of n){const n=e[0],o=e[1],l=(a=i)&&"object"==typeof a?i:o.requestAccessConfig,d=[Object.assign({},l,t)];s=s.pipe(Qn(()=>ep.requestKeySystemInternal(n,d,r)))}var a;return s}static requestKeySystemInternal(e,t,i){return en(()=>Br(navigator.requestMediaKeySystemAccess(e,t)))}make(e,t,i,r,n,s){var a=null===(l=ep.idToMediaKeysInfoMap[e])||void 0===l?void 0:l.keySystemAccess;if(!a)throw new ah(`No keySystemAccess for ${e}`,void 0,K.KeySystemNoKeySystemAccess,e);let o;var l=Xh[e].systemStringPrefix;for(const t of Jh[e])if(t[0]===a.keySystem){o=t[1];break}if(!o)throw new ah(`No constructor associated with ${e}`,void 0,K.KeySystemNoConstructor,l);return new o(t,l,i,r,n,s)}static get availableKeySystems(){return Object.keys(Xh)}static getKeySystemFormat(e){e=Xh[e];return e?e.keyFormatString:""}static getKeySystemSecurityLevel(e){e=Xh[e];return e?e.securityLevels:void 0}}ep.idToMediaKeysInfoMap={},ep.destroy$=new Jt;const tp=["avc1.42E01E"],ip=["mp4a.40.2"];function rp(e,t,i){if(t)if(t instanceof ur)t=new nh("Key request timed out",e,K.KeySystemRequestTimedOut);else if(t instanceof ah){const i=(null==t?void 0:t.response)||K.InternalError;t=new sh(t.message,e,i,!1,eh.InternalError,!0)}else t instanceof hc&&(t=new sh(t.message,e,{code:t.statusCode,text:"Http response error"},!1,eh.HttpError));else t=new sh("Unknown error from CDM",e,K.KeySystemCDMUnknownError,!1,eh.InternalError);return(t instanceof sh||t instanceof nh)&&(t.mediaOptionIds=[...i]),t}class np{constructor(e,t,i,r,n,s,a,o=new ep){this.ksService=e,this.mediaSink=t,this.config=i,this.platformQuery=r,this.eventEmitter=n,this.sessionHandler=s,this.keySystemFactory=o,this.reset$=new Jt,this.keyRequest$=new Jt,this.abort$=new Jt,this.keySystem$=new Si(null),this._keyStatusChange$=new Jt,this.protectionData={},this.keySystemId=null,this.keyUriToRequest={},this.ksQuery=e.getQuery(),this.logger=a.child({name:"eme"}),this.config.warmupCdms&&this.keySystemFactory.createMediaKeys(lh.id,tp,ip,this.logger,void 0).subscribe(),dn(r.platformInfo$.pipe(bs((e,t)=>e&&t&&e.requiresCDMAttachOnStart===t.requiresCDMAttachOnStart),La(e=>null!=e&&e.requiresCDMAttachOnStart?this.attachMediaKeys().pipe(Qn(e=>(this.handleKeySystemError(e),wi))):Oh),Va(wi)),this.keyRequest$.pipe(Hr(e=>e.pipe(Qn(()=>wi)))),this.keySystem$.pipe(La(e=>e?e.keyStatusChange$.pipe(eo(e=>{var t=e.decryptdata.uri,i=this.ksQuery.getKeyInfo(t);"needs-renewal"===e.status?this.ksService.updateKeyRequestState(t,Zc.MustRequestResponse,e=>e===Zc.GotKeyResponse):(i=rp(t,e.error,null!==(i=null==i?void 0:i.mediaOptionIds)&&void 0!==i?i:[]),this.ksService.setError(t,i)),this._keyStatusChange$.next(e)})):wi)),this.isKeyCleanupSupported()?this.mediaSink.mediaQuery.bufferedSegmentsTuple$.pipe(Hr(e=>{const[t,i]=e,r=new Set;return t.forEach(e=>{e=null===(e=null===(e=e.frag)||void 0===e?void 0:e.keyTagInfo)||void 0===e?void 0:e.uri;e&&r.add(e)}),i.forEach(e=>{e=null===(e=null===(e=e.frag)||void 0===e?void 0:e.keyTagInfo)||void 0===e?void 0:e.uri;e&&r.add(e)}),this.handleKeyCleanup(r)})):Oh).pipe(Ka(this.reset$)).subscribe()}get keyStatusChange$(){return this._keyStatusChange$}get keySystem(){return this.keySystem$.value}destroy(){this.reset$.next();let e=Oh;this.keySystemId=null;const t=this.keySystem;let i=Oh;var r;return t&&(r=this.ksQuery.getAll().map(e=>e.itemIds).reduce((e,t)=>e.concat(t),[]),e=this.removeKeysForItems(r),this.keySystem$.next(null),t.shouldDestroyMediaKeys&&this.keySystemFactory.destroyMediaKeys(),i=t.destroy()),this.ksService.removeAll(),Pr([Zr(e,i),this.mediaSink.clearMediaKeys()]).pipe(Ys(void 0))}attachMediaKeys(){if(this.keySystem)return Oh;var e=this.config.keySystemPreference?ep.getKeySystemFormat(this.config.keySystemPreference):lh.keyFormatString;return this.makeKeySystem(new wh("NONE",null,null,e,[1])).pipe(Ys(void 0))}isKeyCleanupSupported(){return!0===this.config.useMultipleKeySessions||"widevine"===this.config.keySystemPreference||"playready"===this.config.keySystemPreference}handleKeyCleanup(i){if(this.ksQuery.getCount()<6)return Oh;const r=performance.now(),e=this.ksQuery.getAll().map(e=>{var t=e.keyUri;if(!i.has(t)){const i=rh(e.decryptdata);if("AES-128"!==i.method&&r>e.minHoldTime)return this._removeKey(t,i)}return Oh});return e.length?tn(e).pipe(Va(Oh)):Oh}_removeKey(e,t){return this.abort$.next(e),this.ksService.removeKey(e),this.keySystem.removeKey(t)}removeKeysForItems(i){const r=[];return ol(()=>{for(const e of i){this.ksService.removeAllKeysForItem(e);const i=this.ksQuery.getAll({filterBy:e=>0===e.itemIds.length});for(const t of i)r.push(this._removeKey(t.keyUri,rh(t.decryptdata)))}}),r.length?tn(r).pipe(La(()=>Oh)):Oh}get availableKeySystems(){return ep.availableKeySystems}initialize(e,t){var i=this.protectionData;this.protectionData={};var r=this.config.keySystemPreference;for(const o of ep.availableKeySystems){var n=e[o];if(n)if(r===o){var s,a=n.certificate,n=n.serverCertUrl?Au.buildAbsoluteURL(window.location.href,n.serverCertUrl):void 0;let e;this.protectionData[o]={serverCertUrl:n,certificate:a},a?e=Vi({keysystem:o,certificate:a}):n&&(null===(s=null==i?void 0:i[o])||void 0===s?void 0:s.serverCertUrl)!==n&&(s=Ru(n)?t.customURL:t.default,e=$c({url:n,xhrSetup:this.config.xhrSetup},s,xc()).pipe(pr(([e])=>({keysystem:o,certificate:new Uint8Array(e)})))),e&&e.pipe(La(e=>this.onServerCertificateLoaded(e)),Qn(e=>{throw this.logger.error(`Error loading cert: ${e.message}`),this.eventEmitter.trigger(D.INTERNAL_ERROR,{type:M.NETWORK_ERROR,details:P.CERT_LOAD_ERROR,fatal:!1,handled:!0,reason:"Error handling cert",response:K.KeySystemCertificateLoadError,message:e.message,name:"certificateLoadError"}),e}),Ka(this.reset$)).subscribe()}else this.logger.warn(`Key system ${o} does not match preference ${r}, ignoring`)}}generateRequest(e,t){return!!this.keySystem&&this.keySystem.setKeyRequestInfo(e,t)}setLicenseResponse(e,t){this.keySystem&&this.keySystem.setParsedResponse(e,t)}getKeyFromDecryptData(e,t,i){if(!e||!e.isEncrypted)return Vi(e);let r;return ol(()=>{r=this._getKeyFromDecryptData(e,t,i)}),r}_getKeyFromDecryptData(t,i,r){let n=null,s=null;i&&(n=i.itemId,s=i.mediaOptionId);const a=t.uri;this.ksQuery.hasEntity(a)&&null!=i&&this.ksService.addMediaOption(a,i);i=this.ksQuery.getKeyInfo(a);if((null==i?void 0:i.error)instanceof sh&&!1===i.error.isOkToRetry)return Ki(i.error);if(i&&i.requestState!==Zc.MustRequestResponse)return i.requestState===Zc.GotKeyResponse?Vi(rh(i.decryptdata)):this.keyUriToRequest[a];{const l=performance.now()+this.config.keyMinHoldTimeBeforeCleanup;let e;this.abort$.next(a),this.ksService.upsertKey({keyUri:a,decryptdata:function(e){var{method:t,isEncrypted:i,uri:r,format:n,formatversions:s}=e;return{method:t,isEncrypted:i,uri:r,format:n,formatversions:s,ivBuf:null!==(s=null===(s=e.iv)||void 0===s?void 0:s.buffer)&&void 0!==s?s:null,keyIdBuf:null===(s=e.keyId)||void 0===s?void 0:s.buffer,keyBuf:null===(s=e.key)||void 0===s?void 0:s.buffer,psshBuf:null===(e=e.key)||void 0===e?void 0:e.buffer}}(t),minHoldTime:l,mediaOptionIds:[s],requestState:Zc.WaitingForKeyResponse,itemIds:[n]});var o=t.method;switch(o){case"SAMPLE-AES":case"ISO-23001-7":case"SAMPLE-AES-CTR":{const l=r.customURL;e=this.fetchKeyEME(t).pipe(bo(l.maxLoadTimeMs));break}case"AES-128":e=this.fetchKeyHTTP(t.uri,t,r);break;default:return Ki(new Q(!1,`Unexpected METHOD attribute ${o}`,K.KeySystemUnexpectedMETHOD))}i=this.keyUriToRequest[a]=e.pipe(pr(e=>{var t=e.decryptdata;return this.ksService.updateKeyValue(a,t.key),this.eventEmitter.trigger(D.KEY_LOADED,e),e.decryptdata}),Qn(e=>{var t=this.ksQuery.getKeyInfo(a);return e=rp(a,e,null!==(t=null==t?void 0:t.mediaOptionIds)&&void 0!==t?t:[]),this.ksService.setError(a,e),Ki(e)}),Bs(()=>{this.ksService.updateKeyRequestState(a,Zc.MustRequestResponse,e=>e===Zc.WaitingForKeyResponse),this.keyUriToRequest[a]=null}),Ra(),Ka(yn(this.abort$.pipe(cn(e=>e===a)),this.reset$).pipe(eo(e=>this.logger.warn(e?`aborted ${re(e)}`:"got reset")))));return this.keyRequest$.next(i),i}}fetchKeyEME(e){return this.requestKey(e).pipe(pr(e=>({timestamp:performance.now(),keyuri:e.uri,decryptdata:e})))}fetchKeyHTTP(e,t,i){return np.fetchKeyHTTP(e,this.config,t,i)}static fetchKeyHTTP(t,e,i,r){e={url:t,xhrSetup:e.xhrSetup};return $c(e,Dc(e,r),xc()).pipe(pr(([e])=>(i.key=new Uint8Array(e),{decryptdata:i,keyuri:t,timestamp:performance.now()})))}requestKey(t){return this.makeKeySystem(t).pipe(La(e=>e.startKeyRequest(t)))}ensureKeySystem(t){return en(()=>{if(!this.keySystem&&this.keySystemId){this.keySystem$.next(this.keySystemFactory.make(this.keySystemId,t,this.config,this.eventEmitter,this.sessionHandler,this.logger));var e=this.protectionData&&this.protectionData[this.keySystemId];if(e)return this.keySystem.setServerCertificate(e.certificate).pipe(Ys(this.keySystem))}return Vi(this.keySystem)})}makeKeySystem(e){return this.ensureMediaKeys(e).pipe(La(e=>this.mediaSink.setMediaKeys(e).pipe(La(()=>this.ensureKeySystem(e)))))}ensureMediaKeys(e){var t=ep.getKeySystemIdForDecryptData(e);if(null==this.keySystemId)this.keySystemId=t;else if(this.keySystemId!==t)return Ki(new sh(`New key system string does not match existing ${t} !== ${this.keySystemId}`,e.uri,K.KeySystemUnmatchedString,!1,eh.InternalError));return this.keySystemFactory.createMediaKeys(this.keySystemId,tp,ip,this.logger,null===(e=this.platformQuery.platformInfo)||void 0===e?void 0:e.keySystemConfig)}onServerCertificateLoaded(e){var t=e.keysystem,e=e.certificate;return this.protectionData[t].certificate=e,this.keySystem&&this.keySystemId===t?this.keySystem.setServerCertificate(e).pipe(Ys(void 0)):Oh}handleKeySystemError(e){e=new ah(e.message,void 0,K.KeySystemSetupError,void 0);this.eventEmitter.trigger(D.INTERNAL_ERROR,e)}}class sp extends Al{constructor(e){super(e)}getKeyInfo(e){e=this.getEntity(e);return e?Object.assign(Object.assign({},e),{error:oh(e.error,e.mediaOptionIds)}):null}getKeyInfo$(e){return this.selectEntity(e).pipe(pr(e=>e?Object.assign(Object.assign({},e),{error:oh(e.error,e.mediaOptionIds)}):null))}getKeyRequestState$(e){return this.selectEntity(e,e=>null==e?void 0:e.requestState)}getKeyStatus$(e){return this.selectEntity(e,e=>null==e?void 0:e.status)}getKeyError$(e){return this.selectEntity(e,e=>oh(null==e?void 0:e.error,null==e?void 0:e.mediaOptionIds)).pipe(El)}}class ap{constructor(e){this.store=e}getQuery(){return new sp(this.store)}upsertKey(i){Co("keys.upsert",i.keyUri);const r=new Set(i.itemIds.filter(e=>null!=e)),n=new Set(i.mediaOptionIds.filter(e=>null!=e));this.store.upsert(i.keyUri,e=>{const t=Object.assign(Object.assign({},e),i);if("itemIds"in e)for(const i of e.itemIds)r.add(i);if(t.itemIds=Array.from(r),"mediaOptionIds"in e)for(const i of e.mediaOptionIds)n.add(i);return t.mediaOptionIds=Array.from(n),t},()=>Object.assign(Object.assign({},i),{itemIds:Array.from(r),mediaOptionIds:Array.from(n)}))}removeKey(e){Co("keys.removeKey",e),this.store.remove(e)}removeAllKeysForItem(i){Co(`keys.removeAllKeysForItem ${i}`),this.store.update(null,e=>{var t=e.itemIds.findIndex(e=>e===i);0<=t&&e.itemIds.splice(t,1)})}removeAll(){Co("keys.remove"),this.store.remove()}updateKeyValue(e,t){Co("keys.updateKeyValue",e),this.store.update(e,e=>{null==e.decryptdata.keyBuf&&null!=t&&(e.decryptdata.keyBuf=t.buffer),e.requestState=Zc.GotKeyResponse})}updateKeyStatus(e,t){Co(`keys.updateKeyStatus ${t}`,e),this.store.update(e,e=>{e.status=t})}updateKeyRequestState(e,t,i){Co(`keys.updateKeyRequestState ${t}`,e),this.store.update(e,e=>{i&&!i(e.requestState)||(e.requestState=t)})}addMediaOption(e,t){const{itemId:i,mediaOptionId:r}=t;Co(`keys.addMediaOption itemId: ${i}, mediaOptionId: ${r}`,e),this.store.update(e,e=>{null!=r&&e.mediaOptionIds.every(e=>e!==r)&&e.mediaOptionIds.push(r),null!=i&&e.itemIds.every(e=>e!==i)&&e.itemIds.push(i)})}setError(e,t){var i;Co(`keys.setError ${null===(i=null==t?void 0:t.constructor)||void 0===i?void 0:i.name}`,e),this.store.update(e,e=>{e.error=oh(t),e.requestState=Zc.MustRequestResponse})}}const op=new class extends fl{constructor(){super({},{name:"key-system-store",idKey:"keyUri",producerFn:lu})}};let lp=null;var dp={},t={},au={},p={};Object.defineProperty(p,"__esModule",{value:!0}),p.isValidPercentValue=function(e){return"number"==typeof e&&0<=e&&e<=100},p.isValidAlignSetting=function(e){return"string"==typeof e&&["start","center","end","left","right","middle"].includes(e)},p.isValidDirectionSetting=function(e){return"string"==typeof e&&["","rl","lr"].includes(e)},p.isValidLineAndPositionSetting=function(e){return"number"==typeof e||"auto"===e},p.isValidLineAlignSetting=function(e){return"string"==typeof e&&["start","center","end"].includes(e)},p.isValidPositionAlignSetting=function(e){return"string"==typeof e&&["line-left","center","line-right","auto","left","start","middle","end","right"].includes(e)},p.isValidScrollSetting=function(e){return["","up"].includes(e)};ou={};Object.defineProperty(ou,"__esModule",{value:!0});const up={"&amp;":"&","&lt;":"<","&gt;":">","&lrm;":"‎","&rlm;":"‏","&nbsp;":" "},cp={c:"span",i:"i",b:"b",u:"u",ruby:"ruby",rt:"rt",v:"span",lang:"span"},hp={v:"title",lang:"lang"},pp={rt:"ruby"},fp={"text-combine-upright":"-webkit-text-combine:horizontal; text-orientation: mixed;"};class mp{static parseTimeStamp(e){function t(e){var[t,i,r,e]=e.map(e=>e?parseInt(""+e):0);return 3600*t+60*i+r+e/1e3}const i=/^(\d+):(\d{2})(:\d{2})?\.(\d{3})/.exec(e);return i?i[3]?t([i[1],i[2],i[3].substring(1),i[4]]):59<parseInt(i[1])?t([i[1],i[2],null,i[4]]):t([null,i[1],i[2],i[4]]):null}static parseContent(s,t,a){let i=t.text;function e(e){return up[e]}const r=s.document.createElement("div"),n=[];let o,l,d=r;for(;null!==(o=function(){if(!i)return null;var e=(e=/^([^<]*)(<[^>]+>?)?/.exec(i))[1]||e[2];return i=i.substr(e.length),e}());)if("<"!==o[0])d.appendChild(s.document.createTextNode(o.replace(/&(amp|lt|gt|lrm|rlm|nbsp);/g,e)));else{if("/"===o[1]){n.length&&n[n.length-1]===o.substr(2).replace(">","")&&(n.pop(),d=d.parentNode);continue}const t=mp.parseTimeStamp(o.substr(1,o.length-2));let e;if(t){e=s.document.createProcessingInstruction("timestamp",t.toString()),d.appendChild(e);continue}if(!(l=/^<([^.\s/0-9>]+)(\.[^\s\\>]+)?([^>\\]+)?(\\?)>?$/.exec(o)))continue;if(e=function(e,t,i){var r=cp[e];if(!r)return null;const n=s.document.createElement(r);if(n.dataset.localName=r,(e=hp[e])&&i&&(n[e]=i.trim()),t)if(a[t]){const s=function(e){let t="";for(const i in e)t+=fp[i]||i+":"+e[i]+";";return t}(a[t]);n.setAttribute("style",s)}else console.info(`WebVTT: parseContent: Style referenced, but no style defined for '${t}'!`);return n}(l[1],l[2],l[3]),!e)continue;if(u=d,c=e,pp[c.dataset.localName]&&pp[c.dataset.localName]!==u.dataset.localName)continue;n.push(l[1]),d.appendChild(e),d=e}var u,c;return r}}ou.default=mp;su=Ee&&Ee.__decorate||function(e,t,i,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;0<=o;o--)(n=e[o])&&(a=(s<3?n(a):3<s?n(t,i,a):n(t,i))||a);return 3<s&&a&&Object.defineProperty(t,i,a),a};Object.defineProperty(au,"__esModule",{value:!0});const gp=p,yp=ou;su=su([function(e){let t=e;return"undefined"!=typeof window&&null!=window.VTTCue&&(t=window.VTTCue,t.create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON),t}],su=class{constructor(e,t,i){this._id="",this._pauseOnExit=!1,this._region=null,this._vertical="",this._snapToLines=!0,this._line="auto",this._lineAlign="start",this._position="auto",this._positionAlign="auto",this._size=100,this._align="center",this.hasBeenReset=!1,this._startTime=e,this._endTime=t,this._text=i}get id(){return this._id}set id(e){this._id=""+e}get pauseOnExit(){return this._pauseOnExit}set pauseOnExit(e){this._pauseOnExit=!!e}get startTime(){return this._startTime}set startTime(e){if("number"!=typeof e)throw new TypeError(`Start time must be set to a number: ${e}`);this._startTime=e,this.hasBeenReset=!0}get endTime(){return this._endTime}set endTime(e){if("number"!=typeof e)throw new TypeError(`End time must be set to a number: ${e}`);this._endTime=e,this.hasBeenReset=!0}get text(){return this._text}set text(e){this._text=""+e,this.hasBeenReset=!0}get region(){return this._region}set region(e){this._region=e,this.hasBeenReset=!0}get vertical(){return this._vertical}set vertical(e){if(!gp.isValidDirectionSetting(e))throw new SyntaxError(`An invalid or illegal string was specified for vertical: ${e}`);this._vertical=e,this.hasBeenReset=!0}get snapToLines(){return this._snapToLines}set snapToLines(e){this._snapToLines=!!e,this.hasBeenReset=!0}get line(){return this._line}set line(e){if(!gp.isValidLineAndPositionSetting(e))throw new SyntaxError(`An invalid number or illegal string was specified for line: ${e}`);this._line=e,this.hasBeenReset=!0}get lineAlign(){return this._lineAlign}set lineAlign(e){if(!gp.isValidLineAlignSetting(e))throw new SyntaxError(`An invalid or illegal string was specified for lineAlign: ${e}`);this._lineAlign=e,this.hasBeenReset=!0}get position(){return this._position}set position(e){if(!gp.isValidLineAndPositionSetting(e))throw new Error(`Position must be between 0 and 100 or auto: ${e}`);this._position=e,this.hasBeenReset=!0}get positionAlign(){return this._positionAlign}set positionAlign(e){if(!gp.isValidPositionAlignSetting(e))throw new SyntaxError(`An invalid or illegal string was specified for positionAlign: ${e}`);this._positionAlign=e,this.hasBeenReset=!0}get size(){return this._size}set size(e){if(e<0||100<e)throw new Error(`Size must be between 0 and 100: ${e}`);this._size=e,this.hasBeenReset=!0}get align(){return this._align}set align(e){if(!gp.isValidAlignSetting(e))throw new SyntaxError(`An invalid or illegal string was specified for align: ${e}`);this._align=e,this.hasBeenReset=!0}getCueAsHTML(){return yp.default.parseContent(window,this,{})}static create(t){if(!t.hasOwnProperty("startTime")||!t.hasOwnProperty("endTime")||!t.hasOwnProperty("text"))throw new Error("You must at least have start time, end time, and text.");const i=new this(t.startTime,t.endTime,t.text);return Object.keys(t).forEach(e=>{i.hasOwnProperty(e)&&(i[e]=t[e])}),i}static fromJSON(e){return this.create(JSON.parse(e))}toJSON(){const t={};return Object.keys(this).forEach(e=>{this.hasOwnProperty(e)&&"getCueAsHTML"!==e&&"hasBeenReset"!==e&&"displayState"!==e&&(t[e]=this[e])}),t}});au.VTTCue=su;su={},Ee=Ee&&Ee.__decorate||function(e,t,i,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;0<=o;o--)(n=e[o])&&(a=(s<3?n(a):3<s?n(t,i,a):n(t,i))||a);return 3<s&&a&&Object.defineProperty(t,i,a),a};Object.defineProperty(su,"__esModule",{value:!0});const vp=p;Ee=Ee([function(e){let t=e;return"undefined"!=typeof window&&null!=window.VTTRegion&&(t=window.VTTRegion,t.create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON),t}],Ee=class{constructor(){this._id="",this._lines=3,this._regionAnchorX=0,this._regionAnchorY=100,this._scroll="",this._viewportAnchorX=0,this._viewportAnchorY=100,this._width=100}get id(){return this._id}set id(e){if("string"!=typeof e)throw new Error("ID must be a string.");this._id=e}get lines(){return this._lines}set lines(e){if("number"!=typeof e)throw new TypeError("Lines must be set to a number.");this._lines=e}get regionAnchorX(){return this._regionAnchorX}set regionAnchorX(e){if(!vp.isValidPercentValue(e))throw new TypeError("RegionAnchorX must be between 0 and 100.");this._regionAnchorX=e}get regionAnchorY(){return this._regionAnchorY}set regionAnchorY(e){if(!vp.isValidPercentValue(e))throw new TypeError("RegionAnchorY must be between 0 and 100.");this._regionAnchorY=e}get scroll(){return this._scroll}set scroll(e){if("string"==typeof e){e=e.toLowerCase();if(vp.isValidScrollSetting(e))return void(this._scroll=e)}throw new SyntaxError("An invalid or illegal string was specified.")}get viewportAnchorX(){return this._viewportAnchorX}set viewportAnchorX(e){if(!vp.isValidPercentValue(e))throw new TypeError("ViewportAnchorX must be between 0 and 100.");this._viewportAnchorX=e}get viewportAnchorY(){return this._viewportAnchorY}set viewportAnchorY(e){if(!vp.isValidPercentValue(e))throw new TypeError("ViewportAnchorY must be between 0 and 100.");this._viewportAnchorY=e}get width(){return this._width}set width(e){if(!vp.isValidPercentValue(e))throw new TypeError("Width must be between 0 and 100.");this._lines=e}toJSON(){const t={};return Object.keys(this).forEach(e=>{this.hasOwnProperty(e)&&(t[e]=this[e])}),t}static create(t){const i=new this;return Object.keys(t).forEach(e=>{i.hasOwnProperty(e)&&(i[e]=t[e])}),i}static fromJSON(e){return this.create(JSON.parse(e))}});su.VTTRegion=Ee,Object.defineProperty(t,"__esModule",{value:!0});const Sp=au;t.VTTCue=Sp.VTTCue;const bp=su;t.VTTRegion=bp.VTTRegion;const Tp=ou;class Ip extends Error{constructor(e,t){super(),this.name="ParsingError",this.code="number"==typeof e?e:e.code,t?this.message=t:e instanceof Ip&&(this.message=e.message)}}(t.ParsingError=Ip).Errors={BadSignature:new Ip(0,"Malformed WebVTT signature."),BadTimeStamp:new Ip(1,"Malformed time stamp.")};class Ep{constructor(){this.values={}}set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,i){return"object"==typeof t&&"string"==typeof i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(t,i,r){for(let e=0;e<r.length;++e)if(i===r[e]){this.set(t,i);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(t.match(/^([\d]{1,3})(\.[\d]*)?%$/))try{var i=parseFloat(t);if(0<=i&&i<=100)return this.set(e,i),!0}catch(e){return!1}return!1}}class wp{constructor(e,t,i){this.window=e,this.state="INITIAL",this.styleCollector="",this.buffer="",this.decoder=t||new TextDecoder("utf8"),this.regionList=[],this.alreadyCollectedLine="",this.onStylesParsedCallback=i,this._styles={},this.middleOrCenter="center";const r=new Sp.VTTCue(0,0,"middleOrCenter");try{(r.align="center")!==r.align&&(this.middleOrCenter="middle")}catch(e){this.middleOrCenter="middle"}}static StringDecoder(){return{decode:e=>{if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}}reportOrThrowError(e){if(!(e instanceof Ip&&"function"==typeof this.onparsingerror))throw e;this.onparsingerror(e)}parseOptions(e,t,i,r){e=r?e.split(r):[e];for(const n of e)if("string"==typeof n){const r=n.split(i);2===r.length&&t(r[0],r[1])}}parseCue(t,e,a){const i=t,r=()=>{var e=Tp.default.parseTimeStamp(t);if(null===e)throw new Ip(Ip.Errors.BadTimeStamp,"Malformed timestamp: "+i);return t=t.replace(/^[^\sa-zA-Z-]+/,""),e},n=()=>{t=t.replace(/^\s+/,"")};if(n(),e.startTime=r(),n(),"--\x3e"!==t.substr(0,3))throw new Ip(Ip.Errors.BadTimeStamp,`Malformed time stamp (time stamps must be separated by '--\x3e'): ${i}`);t=t.substr(3),n(),e.endTime=r(),n(),((e,t)=>{const s=new Ep;this.parseOptions(e,(t,i)=>{let e,r;switch(t){case"region":for(let e=a.length-1;0<=e;e--)if(a[e].id===i){s.set(t,a[e].region);break}break;case"vertical":s.alt(t,i,["rl","lr"]);break;case"line":e=i.split(","),r=e[0],s.integer(t,r),s.percent(t,r)&&s.set("snapToLines",!1),s.alt(t,r,["auto"]),2===e.length&&s.alt("lineAlign",e[1],["start","middle","center","end"]);break;case"position":e=i.split(","),s.percent(t,e[0]),2===e.length&&(n=["line-left","line-right","center","auto","left","start","middle","end","right"],s.alt("positionAlign",e[1],n));break;case"size":s.percent(t,i);break;case"align":var n=["start","center","end","left","right","middle"];s.alt(t,i,n)}},/:/,/\s/),t.region=s.get("region",null),t.vertical=s.get("vertical",""),t.line=s.get("line",void 0===t.line?"auto":t.line);e=s.get("lineAlign","start");t.lineAlign="center"===e||"middle"===e?this.middleOrCenter:e,t.snapToLines=s.get("snapToLines",!0),t.size=s.get("size",100);e=s.get("align","center");t.align="center"===e||"middle"===e?this.middleOrCenter:e,t.position=s.get("position","auto");e=s.get("positionAlign",{start:"start",left:"start",center:"center",middle:"middle",right:"end",end:"end"},t.align);t.positionAlign="center"===e||"middle"===e?this.middleOrCenter:{start:"start","line-left":"start",left:"start",center:"center",middle:"middle","line-right":"end",right:"end",end:"end"}[e]})(t,e)}parseRegion(e){const n=new Ep;if(this.parseOptions(e,(e,t)=>{switch(e){case"id":n.set(e,t);break;case"width":n.percent(e,t);break;case"lines":n.integer(e,t);break;case"regionanchor":case"viewportanchor":{var i=t.split(",");if(2!==i.length)break;const r=new Ep;if(r.percent("x",i[0]),r.percent("y",i[1]),!r.has("x")||!r.has("y"))break;n.set(e+"X",r.get("x")),n.set(e+"Y",r.get("y"));break}case"scroll":n.alt(e,t,["up"])}},/=/,/\s/),n.has("id")){const e=new bp.VTTRegion;e.width=n.get("width",100),e.lines=n.get("lines",3),e.regionAnchorX=n.get("regionanchorX",0),e.regionAnchorY=n.get("regionanchorY",100),e.viewportAnchorX=n.get("viewportanchorX",0),e.viewportAnchorY=n.get("viewportanchorY",100),e.scroll=n.get("scroll",""),this.onregion&&this.onregion(e),this.regionList.push({id:n.get("id"),region:e})}}parseStyle(i){const e=i.split("}");e.pop();for(const i of e){let e=null,t=null;const r=i.split("{");r[0]&&(e=r[0].trim()),r[1]&&(t=(e=>{const t={},i=e.split(";");for(let e=0;e<i.length;e++)if(i[e].includes(":")){const r=i[e].split(":",2),n=r[0].trim(),s=r[1].trim();""!==n&&""!==s&&(t[n]=s)}return t})(r[1])),e&&t&&(this._styles[e]=t)}this.onStylesParsedCallback&&this.onStylesParsedCallback(this._styles)}parseHeader(e){this.parseOptions(e,function(e,t){"Region"===e&&this.parseRegion(t)},/:/)}parse(t){t&&(this.buffer+=this.decoder.decode(t,{stream:!0}));const i=()=>{const e=this.buffer;let t=0;let i={start:e.length,length:0};for(;t<e.length;){const r=((t,i)=>{const r={start:-1,length:-1};if("\r"===t[i])r.start=i,r.length=1;else if("\n"===t[i])r.start=i,r.length=1;else if("<"===t[i]&&i+1<t.length&&"b"===t[i+1]&&i+2<t.length&&"r"===t[i+2]){let e=i+2;for(;e<t.length&&">"!==t[e++];);r.start=i,r.length=e-i}return r})(e,t);if(0<r.length){i=r;break}++t}const r=e.substr(0,i.start);return this.buffer=e.substr(i.start+i.length),r};try{let e;if("INITIAL"===this.state){if(!/\r\n|\n/.test(this.buffer))return this;this.alreadyCollectedLine="",e=i();var r=/^(ï»¿)?WEBVTT([ \t].*)?$/.exec(e);if(!r||!r[0])throw new Ip(Ip.Errors.BadSignature);this.state="HEADER"}for(;this.buffer;){if(!/\r\n|\n/.test(this.buffer))return this;switch(this.alreadyCollectedLine?(e=this.alreadyCollectedLine,this.alreadyCollectedLine=""):e=i(),this.state){case"HEADER":e.includes(":")?this.parseHeader(e):e||(this.state="ID");continue;case"NOTE":e||(this.state="ID");continue;case"STYLE":e?this.styleCollector+=e:(this.parseStyle(this.styleCollector),this.state="ID",this.styleCollector="");continue;case"ID":if(/^NOTE($|[ \t])/.test(e)){this.state="NOTE";break}if(/^STYLE($|[ \t])/.test(e)){this.state="STYLE";break}if(!e)continue;if(this.cue=new Sp.VTTCue(0,0,""),this.state="CUE",!e.includes("--\x3e")){this.cue.id=e;continue}case"CUE":try{this.parseCue(e,this.cue,this.regionList)}catch(t){this.reportOrThrowError(t),this.cue=null,this.state="BADCUE";continue}this.state="CUETEXT";continue;case"CUETEXT":{const i=e.includes("--\x3e");if(!e||i){this.alreadyCollectedLine=e,this.oncue&&this.oncue(this.cue),this.cue=null,this.state="ID";continue}this.cue.text&&(this.cue.text+="\n"),this.cue.text+=e;continue}case"BADCUE":e||(this.state="ID");continue}}}catch(t){this.reportOrThrowError(t),"CUETEXT"===this.state&&this.cue&&this.oncue&&this.oncue(this.cue),this.cue=null,this.state="INITIAL"===this.state?"BADWEBVTT":"BADCUE"}return this}flush(){try{if(this.buffer+=this.decoder.decode(),!this.cue&&"HEADER"!==this.state||(this.buffer+="\n\n",this.parse()),"INITIAL"===this.state)throw new Ip(Ip.Errors.BadSignature)}catch(e){this.reportOrThrowError(e)}return this.onflush&&this.onflush(),this}styles(){return this._styles}}t.default=wp,t.WebVTTParser=wp;var Op,su={};Object.defineProperty(su,"__esModule",{value:!0});const Ap=au;su.VTTCue=Ap.VTTCue;const Rp=ou,kp=[/^(::cue\()(\..*)(\))/,/^(::cue\()(#.*)(\))/,/^(::cue\()(c|i|b|u|ruby|rt|v|lang)(\))/],Cp=[[1470,1470],[1472,1472],[1475,1475],[1478,1478],[1488,1514],[1520,1524],[1544,1544],[1547,1547],[1549,1549],[1563,1563],[1566,1610],[1645,1647],[1649,1749],[1765,1766],[1774,1775],[1786,1805],[1807,1808],[1810,1839],[1869,1957],[1969,1969],[1984,2026],[2036,2037],[2042,2042],[2048,2069],[2074,2074],[2084,2084],[2088,2088],[2096,2110],[2112,2136],[2142,2142],[2208,2208],[2210,2220],[8207,8207],[64285,64285],[64287,64296],[64298,64310],[64312,64316],[64318,64318],[64320,64321],[64323,64324],[64326,64449],[64467,64829],[64848,64911],[64914,64967],[65008,65020],[65136,65140],[65142,65276],[67584,67589],[67592,67592],[67594,67637],[67639,67640],[67644,67644],[67647,67669],[67671,67679],[67840,67867],[67872,67897],[67903,67903],[67968,68023],[68030,68031],[68096,68096],[68112,68115],[68117,68119],[68121,68147],[68160,68167],[68176,68184],[68192,68223],[68352,68405],[68416,68437],[68440,68466],[68472,68479],[68608,68680],[126464,126467],[126469,126495],[126497,126498],[126500,126500],[126503,126503],[126505,126514],[126516,126519],[126521,126521],[126523,126523],[126530,126530],[126535,126535],[126537,126537],[126539,126539],[126541,126543],[126545,126546],[126548,126548],[126551,126551],[126553,126553],[126555,126555],[126557,126557],[126559,126559],[126561,126562],[126564,126564],[126567,126570],[126572,126578],[126580,126583],[126585,126588],[126590,126590],[126592,126601],[126603,126619],[126625,126627],[126629,126633],[126635,126651],[1114109,1114109]];class Mp{applyStyles(e,t){t=t||this.div;for(const i in e)e.hasOwnProperty(i)&&(t.style[i]=e[i])}formatStyle(e,t){return 0===e?"0":e+t}}su.StyleBox=Mp;class Pp extends Mp{constructor(e,t,i,r,n){super();let s={start:"left","line-left":"left",left:"left",center:"center",middle:"center","line-right":"right",right:"right",end:"right"}[(this.cue=t).positionAlign]||t.align;"middle"===s&&(s="center");let a={textAlign:s,whiteSpace:"pre-line",position:"absolute"};a.direction=this.determineBidi(this.cueDiv),a.writingMode=this.directionSettingToWritingMode(t.vertical),a.unicodeBidi="plaintext",this.div=e.document.createElement("div"),this.applyStyles(a),a={backgroundColor:r.backgroundColor,display:"inline-block"},this.parseOpacity(a.backgroundColor)&&(a.padding="5px",a.borderRadius="5px"),this.backgroundDiv=e.document.createElement("div"),this.applyStyles(a,this.backgroundDiv),a={color:i.color,backgroundColor:i.backgroundColor,textShadow:i.textShadow,fontSize:i.fontSize,fontFamily:i.fontFamily,position:"relative",left:"0",right:"0",top:"0",bottom:"0",display:"inline-block",textOrientation:"upright"},a.writingMode=this.directionSettingToWritingMode(t.vertical),a.unicodeBidi="plaintext",this.cueDiv=Rp.default.parseContent(e,t,n),this.applyStyles(a,this.cueDiv),this.backgroundDiv.appendChild(this.cueDiv),this.div.appendChild(this.backgroundDiv);let o=0;if("number"==typeof t.position){n=t.positionAlign||t.align;if(n)switch(n){case"start":case"left":o=t.position;break;case"center":case"middle":o=t.position-t.size/2;break;case"end":case"right":o=t.position-t.size}}""===t.vertical?this.applyStyles({left:this.formatStyle(o,"%"),width:this.formatStyle(t.size,"%")}):this.applyStyles({top:this.formatStyle(o,"%"),height:this.formatStyle(t.size,"%")})}determineBidi(e){let t=[],i="";if(!e||!e.childNodes)return"ltr";function n(t,i){for(let e=i.childNodes.length-1;0<=e;e--)t.push(i.childNodes[e])}for(n(t,e);i=function e(t){if(!t||!t.length)return null;let i=t.pop(),r=i.textContent||i.innerText;if(r){const i=/^.*(\n|\r)/.exec(r);return i?i[t.length=0]:r}return"ruby"===i.tagName?e(t):i.childNodes?(n(t,i),e(t)):void 0}(t);)for(let e=0;e<i.length;e++)if(function(e,t){for(const i of t)if(e>=i[0]&&e<=i[1])return 1}(i.charCodeAt(e),Cp))return"rtl";return"ltr"}parseOpacity(e){if(!e||"string"!=typeof e)return null;e=(e=e.replace(/ /g,"").replace("rgba(","").replace(")","")).split(",");return e&&4<=e.length?e[3]:null}directionSettingToWritingMode(e){return""===e?"horizontal-tb":"lr"===e?"vertical-lr":"vertical-rl"}move(e){this.applyStyles({top:this.formatStyle(e.top,"px"),bottom:this.formatStyle(e.bottom,"px"),left:this.formatStyle(e.left,"px"),right:this.formatStyle(e.right,"px"),height:this.formatStyle(e.height,"px"),width:this.formatStyle(e.width,"px")})}}su.CueStyleBox=Pp;class xp{constructor(e){var t;let i,r,n,s,a,o;if(e instanceof Pp&&e.cue?(t=e.cue)&&""!==t.vertical?this.property="width":this.property="height":e instanceof xp&&(this.property=e.property||"height"),e instanceof Pp&&e.div){n=e.div.offsetHeight,s=e.div.offsetWidth,a=e.div.offsetTop;const t=e.div.firstChild;if(o=(t||e.div).getBoundingClientRect(),i=o&&o[this.property]||null,t&&t.firstChild){const e=t.firstChild;e&&"string"==typeof e.textContent&&(r=i/this.calculateNewLines(e.textContent))}}else e instanceof xp&&(o=e);this.left=o.left,this.right=o.right,this.top=o.top||a,this.height=o.height||n,this.bottom=o.bottom||a+(o.height||n),this.width=o.width||s,this.lineHeight=null!==i?i:o.lineHeight,this.singleLineHeight=null!==r?r:o.singleLineHeight,this.singleLineHeight||(this.singleLineHeight=41)}calculateNewLines(t){let i=1;for(let e=0;e<t.length;e++)"\n"===t[e]&&i++;return i}move(e,t){switch(t=void 0!==t?t:this.singleLineHeight,e){case"+x":this.left+=t,this.right+=t;break;case"-x":this.left-=t,this.right-=t;break;case"+y":this.top+=t,this.bottom+=t;break;case"-y":this.top-=t,this.bottom-=t}}overlaps(e){return this.left<e.right&&this.right>e.left&&this.top<e.bottom&&this.bottom>e.top}overlapsAny(e){for(const t of e)if(this.overlaps(t))return!0;return!1}within(e){return this.top>=e.top&&this.bottom<=e.bottom&&this.left>=e.left&&this.right<=e.right}moveIfOutOfBounds(e,t){switch(t){case"+x":this.left<e.left&&(this.left=e.left,this.right=this.left+this.width);break;case"-x":this.right>e.right&&(this.right=e.right,this.left=this.right-this.width);break;case"+y":this.top<e.top&&(this.top=e.top,this.bottom=this.top+this.height);break;case"-y":this.bottom>e.bottom&&(this.bottom=e.bottom,this.top=this.bottom-this.height)}}toCSSCompatValues(e){return{top:this.top-e.top,bottom:e.bottom-this.bottom,left:this.left-e.left,right:e.right-this.right,height:this.height,width:this.width}}static getSimpleBoxPosition(e){let t=null;e instanceof Mp&&e.div?t=e.div:e instanceof HTMLElement&&(t=e);let i=t.offsetHeight||0,r=t.offsetWidth||0,n=t.offsetTop||0,s=n+i,a=t.getBoundingClientRect();var{left:o,right:e}=a;return a.top&&(n=a.top),a.height&&(i=a.height),a.width&&(r=a.width),a.bottom&&(s=a.bottom),{left:o,right:e,top:n,height:i,bottom:s,width:r}}static getBoxPosition(r,n){if(r&&0<r.length){let t=0,i=r[0][n];for(let e=0;e<r.length;e++)n in["top","right"]?r[e][n]>i&&(t=e,i=r[e][n]):n in["bottom","left"]&&r[e][n]<i&&(t=e,i=r[e][n]);return r[t]}return null}static moveToMinimumDistancePlacement(e,t,i){"height"===e.property?"+y"===t?(e.top=i.topMostBoxPosition.bottom+0,e.bottom=e.top+e.height):"-y"===t&&(e.bottom=+i.bottomMostBoxPosition.top,e.top=e.bottom-e.height):"width"===e.property&&("+x"===t?(e.left=i.rightMostBoxPosition.right+0,e.right=e.left+e.width):"-x"===t&&(e.right=+i.leftMostBoxPosition.left,e.left=e.right-e.width))}static moveBoxToLinePosition(e,a,o){var n=e.cue;let i,r=new xp(e),s=function(){if("number"==typeof n.line&&(n.snapToLines||0<=n.line&&n.line<=100))return n.line;if(!n.track||!n.track.textTrackList||!n.track.textTrackList.mediaElement)return-1;let t=0;var i=n.track,r=i.textTrackList;for(let e=0;e<r.length&&r[e]!==i;e++)"showing"===r[e].mode&&t++;return-1*++t}(),l=[];if(n.snapToLines){let t=0;switch(n.vertical){case"":l=["+y","-y"],i="height";break;case"rl":l=["+x","-x"],i="width";break;case"lr":l=["-x","+x"],i="width"}const o=r.lineHeight,d=a[i]+o,u=l[0];if(s<0){let e=0;switch(n.vertical){case"":e=a.height-o-.05*a.height;break;case"rl":case"lr":e=-a.width+o+.05*a.width}t=e,l=l.reverse()}else{switch(n.vertical){case"":t=o*Math.round(s);break;case"rl":t=a.width-o*Math.round(s);break;case"lr":t=o*Math.round(s)}Math.abs(t)>d&&(t=t<0?-1:1,t*=Math.ceil(d/o)*o)}r.move(u,t)}else{const o=""===n.vertical?a.height:a.width,i=r.lineHeight/o*100;switch(n.lineAlign){case"center":case"middle":s-=i/2;break;case"end":s-=i}switch(n.vertical){case"":e.applyStyles({top:e.formatStyle(s,"%")});break;case"rl":e.applyStyles({right:e.formatStyle(s,"%")});break;case"lr":e.applyStyles({left:e.formatStyle(s,"%")})}l=["+y","-y","+x","-x"],"+y"===n.axis?l=["+y","-y","+x","-x"]:"-y"===n.axis&&(l=["-y","+y","+x","-x"]),r=new xp(e)}const d=function(r,n){let s;for(let i=0;i<n.length;i++){r.moveIfOutOfBounds(a,n[i]);let e=0,t=!1;for(;r.overlapsAny(o)&&!(9<e);)t?r.move(n[i]):(o&&0<o.length&&(s=s||{topMostBoxPosition:xp.getBoxPosition(o,"top"),bottomMostBoxPosition:xp.getBoxPosition(o,"bottom"),leftMostBoxPosition:xp.getBoxPosition(o,"left"),rightMostBoxPosition:xp.getBoxPosition(o,"right")},xp.moveToMinimumDistancePlacement(r,n[i],s)),t=!0),e++}return r}(r,l);e.move(d.toCSSCompatValues(a))}}su.BoxPosition=xp;class Dp{constructor(e,t,i=!0){if(!e)return null;this.window=e,this.overlay=t,this.loggingEnabled=i,this.foregroundStyleOptions={fontFamily:"Helvetica",fontSize:"36px",color:"rgba(255, 255, 255, 1)",textShadow:"",backgroundColor:"rgba(0, 0, 0, 0)"},this.backgroundStyleOptions={backgroundColor:"rgba(0, 0, 0, 0.5)"},this.globalStyleCollection={};const r=e.document.createElement("div");r.style.position="absolute",r.style.left="0",r.style.right="0",r.style.top="0",r.style.bottom="0",r.style.margin="1.5%",this.paddedOverlay=r,t.appendChild(this.paddedOverlay),this.initSubtitleCSS()}initSubtitleCSS(){var e=[new Ap.VTTCue(0,0,"String to init CSS - Won't be visible to user")];this.paddedOverlay.style.opacity="0",this.processCues(e),this.processCues([]),this.paddedOverlay.style.opacity="1"}convertCueToDOMTree(e){return e?Rp.default.parseContent(this.window,e,this.globalStyleCollection):null}setStyles(i){function r(e,t,i){for(const r in t)t.hasOwnProperty(r)&&(!0===i&&void 0!==e[r]||!1===i)&&(e[r]=t[r])}for(const a in i){let t=!1,e=null;"::cue"===a?(e=this.foregroundStyleOptions,t=!0):"::-webkit-media-text-track-display"===a&&(e=this.backgroundStyleOptions,t=!0);var n=i[a];if(!0===t)r(e,n,t);else for(let e=0;e<kp.length;e++){var s=kp[e].exec(a);if(s&&4===s.length){const i=s[2],o={};r(o,n,t),this.globalStyleCollection[i]=o}}}this.initSubtitleCSS(),this.loggingEnabled&&(console.log("WebVTTRenderer setStyles foregroundStyleOptions: "+JSON.stringify(this.foregroundStyleOptions)),console.log("WebVTTRenderer setStyles backgroundStyleOptions: "+JSON.stringify(this.backgroundStyleOptions)),console.log("WebVTTRenderer setStyles globalStyleCollection: "+JSON.stringify(this.globalStyleCollection)))}processCues(r){if(r){for(;this.paddedOverlay.firstChild;)this.paddedOverlay.removeChild(this.paddedOverlay.firstChild);if(function(t){for(let e=0;e<t.length;e++)if(t[e].hasBeenReset||!t[e].displayState)return 1}(r)){const n=[],s=xp.getSimpleBoxPosition(this.paddedOverlay);1<r.length&&(r=function(t){const i=[];let r=0;for(let e=0;e<t.length;e++){var n=t[e];if("number"!=typeof n.line)return t;r+=n.line,i.push(n)}return r/=t.length,50<r?(i.forEach(function(e){e.axis="-y"}),i.sort((e,t)=>t.line-e.line)):(i.forEach(function(e){e.axis="+y"}),i.sort((e,t)=>e.line-t.line)),i}(r));for(let i=0;i<r.length;i++){let e=r[i],t=new Pp(this.window,e,this.foregroundStyleOptions,this.backgroundStyleOptions,this.globalStyleCollection);this.paddedOverlay.appendChild(t.div),xp.moveBoxToLinePosition(t,s,n),e.displayState=t.div,n.push(xp.getSimpleBoxPosition(t))}}else for(let e=0;e<r.length;e++)this.paddedOverlay.appendChild(r[e].displayState)}}setSize(e,t){e&&(this.overlay.style.width=e+"px"),t&&(this.overlay.style.height=t+"px")}getOverlay(){return this.overlay}}function _p(e){for(var t in e)Op.hasOwnProperty(t)||(Op[t]=e[t])}su.default=Dp,su.WebVTTRenderer=Dp,Op=dp,Object.defineProperty(Op,"__esModule",{value:!0}),_p(t),_p(su);function Lp(e,t,i){return e.substr(i||0,t.length)===t}function Np(e){let t=5381,i=e.length;for(;i;)t=33*t^e.charCodeAt(--i);return(t>>>0).toString()}function Fp(e){var t=Math.floor(e),i=t+.5,r=t+1;return i<=e?r-e<=e-i?r:i:i-e<=e-t?i:t}function Bp(e,t=0,i=8589934592){if(!Number.isFinite(t))return e;var r=i/2,n=Math.abs(e-t)%i;return t+(t<e?-1:1)*(r<n?i-n:-n)}function Up(e){let t=e;return Vp.hasOwnProperty(e)&&(t=Vp[e]),String.fromCharCode(t)}function $p(t){const i=[];for(let e=0;e<t.length;e++)i.push(t[e].toString(16));return i}const Vp={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Kp=100,Qp={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},qp={17:2,18:4,21:6,22:8,23:10,19:13,20:15},jp={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},Hp={25:2,26:4,29:6,30:8,31:10,27:13,28:15},Gp=["white","green","blue","cyan","red","yellow","magenta","black","transparent"],Wp={verboseFilter:{DATA:3,DEBUG:3,INFO:2,WARNING:2,TEXT:1,ERROR:0},time:null,verboseLevel:0,setTime:function(e){this.time=e},log:function(e,t){var i=this.verboseFilter[e];this.verboseLevel>=i&&console.log(this.time+" ["+e+"] "+t)}};class zp{constructor(e,t,i,r,n){this.foreground=e||"white",this.underline=t||!1,this.italics=i||!1,this.background=r||"black",this.flash=n||!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){Object.assign(this,e)}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class Yp{constructor(e,t,i,r,n,s){this.uchar=e||" ",this.penState=new zp(t,i,r,n,s)}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class Xp{constructor(){this.chars=[];for(let e=0;e<Kp;e++)this.chars.push(new Yp);this.pos=0,this.currPenState=new zp}equals(t){let i=!0;for(let e=0;e<Kp;e++)if(!this.chars[e].equals(t.chars[e])){i=!1;break}return i}copy(t){for(let e=0;e<Kp;e++)this.chars[e].copy(t.chars[e])}isEmpty(){let t=!0;for(let e=0;e<Kp;e++)if(!this.chars[e].isEmpty()){t=!1;break}return t}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(Wp.log("ERROR","Negative cursor position "+this.pos),this.pos=0):this.pos>Kp&&(Wp.log("ERROR","Too large cursor position "+this.pos),this.pos=Kp)}moveCursor(e){var t=this.pos+e;if(1<e)for(let e=this.pos+1;e<t+1;e++)this.chars[e].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){144<=e&&this.backSpace();var t=Up(e);this.pos>=Kp?Wp.log("ERROR","Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!"):(this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1))}clearFromPos(e){let t;for(t=e;t<Kp;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const t=[];let i=!0;for(let e=0;e<Kp;e++){var r=this.chars[e].uchar;" "!==r&&(i=!1),t.push(r)}return i?"":t.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class Jp{constructor(){this.rows=[];for(let e=0;e<15;e++)this.rows.push(new Xp);this.currRow=14,this.nrRollUpRows=null,this.reset()}reset(){for(let e=0;e<15;e++)this.rows[e].clear();this.currRow=14}equals(t){let i=!0;for(let e=0;e<15;e++)if(!this.rows[e].equals(t.rows[e])){i=!1;break}return i}copy(t){for(let e=0;e<15;e++)this.rows[e].copy(t.rows[e])}isEmpty(){let t=!0;for(let e=0;e<15;e++)if(!this.rows[e].isEmpty()){t=!1;break}return t}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){Wp.log("INFO","setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(t){Wp.log("INFO","pacData = "+JSON.stringify(t));let i=t.row-1;if(this.nrRollUpRows&&i<this.nrRollUpRows-1&&(i=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==i){for(let e=0;e<15;e++)this.rows[e].clear();const t=this.currRow+1-this.nrRollUpRows,r=this.lastOutputScreen;if(r){const e=r.rows[t].cueStartTime;if(e&&e<Wp.time)for(let e=0;e<this.nrRollUpRows;e++)this.rows[i-this.nrRollUpRows+e+1].copy(r.rows[t+e])}}this.currRow=i;const r=this.rows[this.currRow];if(null!==t.indent){const i=t.indent,e=Math.max(i-1,0);r.setCursor(t.indent),t.color=r.chars[e].penState.foreground}const e={foreground:t.color,underline:t.underline,italics:t.italics,background:"black",flash:!1};this.setPen(e)}setBkgData(e){Wp.log("INFO","bkgData = "+JSON.stringify(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(null!==this.nrRollUpRows){Wp.log("INFO","TEXT "+this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),Wp.log("INFO","Rolling up")}else Wp.log("DEBUG","roll_up but nrRollUpRows not set yet")}getDisplayText(t){t=t||!1;const i=[];let e="",r;for(let e=0;e<15;e++){const n=this.rows[e].getTextString();n&&(r=e+1,t?i.push("Row "+r+": '"+n+"'"):i.push(n.trim()))}return 0<i.length&&(e=t?"["+i.join(" | ")+"]":i.join("\n")),e}getTextAndFormat(){return this.rows}}class Zp{constructor(e,t){this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new Jp,this.nonDisplayedMemory=new Jp,this.lastOutputScreen=new Jp,this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.lastCueEndTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,Wp.log("INFO","MODE="+e),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(t){for(let e=0;e<t.length;e++)this.writeScreen.insertChar(t[e]);var e=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";Wp.log("INFO",e+": "+this.writeScreen.getDisplayText(!0)),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(Wp.log("TEXT","DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){Wp.log("INFO","RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){Wp.log("INFO","BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){Wp.log("INFO","DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){Wp.log("INFO","RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){Wp.log("INFO","FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){Wp.log("INFO","RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){Wp.log("INFO","TR"),this.setMode("MODE_TEXT")}ccRTD(){Wp.log("INFO","RTD"),this.setMode("MODE_TEXT")}ccEDM(){Wp.log("INFO","EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){Wp.log("INFO","CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){Wp.log("INFO","ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){var e;Wp.log("INFO","EOC - End Of Caption"),"MODE_POP-ON"===this.mode&&(e=this.displayedMemory,this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,Wp.log("TEXT","DISP: "+this.displayedMemory.getDisplayText())),this.outputDataUpdate(!0)}ccTO(e){Wp.log("INFO","TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1,underline:!1,italics:!1};t.underline=e%2==1,t.italics=46<=e,t.italics?t.foreground="white":(e=Math.floor(e/2)-16,t.foreground=["white","green","blue","cyan","red","yellow","magenta"][e]),Wp.log("INFO","MIDROW: "+JSON.stringify(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){var t=Wp.time;null!==t&&this.outputFilter&&(this.outputFilter.updateData&&this.outputFilter.updateData(t,this.displayedMemory),null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue&&(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),!0===e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue()),this.cueStartTime=this.displayedMemory.isEmpty()?null:t):this.cueStartTime=t,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}var ef,tf,rf,nf,sf={newCue:function(e,t,i,r,n,s){let a,o,l,d,u;var c,h,p={foreground:!1,background:!1,italics:!1,underline:!1,flash:!1,styleStack:[]};for([c,h]of r.rows.entries())if(o=!0,l=0,d="",!h.isEmpty()){for(let e=0;e<h.chars.length;e++)h.chars[e].uchar.match(/\s/)&&o?l++:(d+=this.getFormattedChar(h.chars[e],p),o=!1);(h.cueStartTime=t)===i&&(i+=1e-4),d=d.trim().replace(/<br(?: \/)?>/gi,"\n"),d+=this.closeStyles(p),a=new dp.VTTCue(t,i,d),16<=l?l--:l++,u=!navigator.userAgent.match(/Firefox\//)&&7<c?c:c+1,a.snapToLines=!1,a.line=10+5.33*u,a.align="left",a.position=this.getPosition(l,n,s),e.addCue(a)}},getPosition:function(e,t,i){let r=1.3333333333333333;t&&i&&1.6<=t/i&&(r=1.7777777777777777);let n=10+e/32*80,s=10,a=90;return 1.7777777777777777===r&&(n=12.5+.75*n,s=20,a=80),Math.max(s,Math.min(a,n+(navigator.userAgent.match(/Firefox\//)?50:0)))},getRootStyleTag:function(e){var t=e[0];return"c"===t?t:e},closeStyles:function(t){let i="";for(let e=t.styleStack.length-1;0<=e;--e)i+="</"+this.getRootStyleTag(t.styleStack[e])+">",t.styleStack.pop();return i},beginStyleAndBalance:function(e,t){let i="";return"c"===t[0]&&(i+=this.closeStyleAndBalance(e,"c")),i+="<"+t+">",e.styleStack.push(t),i},closeStyleAndBalance:function(t,i){var r=t.styleStack.length;let n=0,s="";for(let e=r-1;0<=e;--e){var a=t.styleStack[e],o=this.getRootStyleTag(a);if(i[0]===a[0]){s+="</"+o+">",t.styleStack.splice(r-1-n);break}"c"===o[0]?(t.background="",t.foreground="",t.flash=!1,s+="</c>"):"u"===o[0]?(t.underline=!1,s+="</u>"):"i"===o[0]&&(t.italics=!1,s+="</i>"),n++}return s},getFormattedChar:function(e,t){let i="",r=e.uchar,n="";var s=e.penState.foreground!==t.foreground,a=e.penState.background!==t.background,o=e.penState.flash!==t.flash;return(s||a||o)&&(n="."+e.penState.foreground,n+=".bg_"+e.penState.background,e.penState.flash&&o&&(n+=".blink"),e.penState.foreground||e.penState.background||e.penState.blink?i+=this.beginStyleAndBalance(t,"c"+n):i+=this.closeStyleAndBalance(t,"c"),s&&(t.foreground=e.penState.foreground),a&&(t.background=e.penState.background),o&&(t.flash=e.penState.flash)),e.penState.underline!==t.underline&&(i+=e.penState.underline?this.beginStyleAndBalance(t,"u"):this.closeStyleAndBalance(t,"u"),t.underline=e.penState.underline),e.penState.italics!==t.italics&&(i+=e.penState.italics?this.beginStyleAndBalance(t,"i"):this.closeStyleAndBalance(t,"i"),t.italics=e.penState.italics),i+r}};class af{constructor(e,t){this.handler=e,this.track=t,this.startTime=null,this.endTime=null,this.screen=null}dispatchCue(){null!==this.startTime&&(this.handler.addCues("cc"+this.track,this.startTime,this.endTime,this.screen),this.startTime=null)}newCue(e,t,i){(null===this.startTime||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.handler.createHTMLCaptionsTrack(this.track)}}(su=ef=ef||{}).CloseEnough="CloseEnough",su.TooFar="TooFar",su.Unknown="Unknown",(su=tf=tf||{})[su.TryAgain=1]="TryAgain",su[su.Complete=2]="Complete";const of=e=>"cc1"===e||"cc2"===e;function lf(t){const i=[];for(let e=0;e<t.length;e++){var r=t[e];("captions"===r.kind||"subtitles"===r.kind||"metadata"===r.kind&&r.customTextTrackCueRenderer)&&i.push(r)}return i}function df(e){if(e&&e.cues)for(;0<e.cues.length;)e.removeCue(e.cues[0])}class uf extends Kt{constructor(e,t,i,r,n){super(e=>{const t=Ac(this.hls,this);if(e.add(t.event(D.INLINE_STYLES_PARSED,this.onInlineStylesParsed).pipe(Bs(()=>this.destroy())).subscribe()),e.add(En(0,this.config.trottleCheckInterval).pipe(La(()=>(this.checkReadyToLoadNextSubtitleFragment(),Oh))).subscribe()),this.config.nativeTextTrackChangeHandling)if(this.mediaSink.textTracks&&"onchange"in this.mediaSink.textTracks){const t=Ac(this.mediaSink.textTracks,this);e.add(t.event("change",this._onTextTracksChanged).subscribe())}else e.add(En(0,500).pipe(La(()=>(this._onTextTracksChanged(),Oh))).subscribe())}),this.config=t,this.interstitialIsPlaying=!1,this.addCueToInterstitial=!1,this.destroy$=new Jt,this.hls=i,this.logger=n.child({name:"legible"}),this.mediaSink=e,this.id3Track=e.id3TextTrack,this.enableCaption=!0,this.Cues=sf,this.tracks=[],this.cueRanges=[],this.channelToTrackMap={},this.htmlTextTrackMap=new Map,this.lastCueEndTime=0,this.gotTracks=!1,this.tryAgain$=new Si(tf.TryAgain),this.needNextSubtitle$=new Si(!0),this.playingInterstitialListener(r).pipe(Ka(this.destroy$)).subscribe()}destroy(){this.destroy$.next(),this.clearInterstitialTextTracks(),df(this.textTrack1),df(this.textTrack2),this.mediaSink=void 0,this.nativeSubtitleTrackChange$=void 0}playingInterstitialListener(e){return e.pipe(eo(e=>{e?(this.interstitialIsPlaying=!0,this.interstitialSwitchTextTrack(),this._cleanTracks(!0)):(this.interstitialIsPlaying=!1,this.interstitialSwitchTextTrack())}),da(),eo(([e,t])=>{(null!=e&&null==t||null!=e&&null!=t&&e!==t)&&(this.clearInterstitialTextTracks(),this._availableInterstitialMediaOptions=[],this._interstitialDisableMediaOption=void 0,this._interstitialSelectedMediaOption=void 0)}))}convertCuesIntoSubtitleFragInfo(t,i){const r={};if(null!=t&&0<t.length)for(let e=0;e<t.length;e++){var n=t[e];if(Z(n.fragSN)&&n.itemId===i){const s=r[n.fragSN];s?(s.count++,s.startTime=Math.min(n.startTime,s.startTime),s.endTime=Math.max(n.endTime,s.endTime)):r[n.fragSN]={count:1,startTime:n.startTime,endTime:n.endTime}}}return r}checkReadyToLoadNextSubtitleFragment(){let e=!1;this.mediaSink.mediaQuery.currentTime>=this.lastCueEndTime-this.config.subtitleLeadTime&&(e=!0),this.needNextSubtitle$.next(e)}checkReadyToLoadNextSubtitleFragment$(e,t){return e.mediaSeqNum===(null===(t=t[0])||void 0===t?void 0:t.mediaSeqNum)?Vi(!0):(this.checkReadyToLoadNextSubtitleFragment(),this.needNextSubtitle$)}getNextFragment(e,t){t=t.mediaSeqNum+1;return t<e.fragments.length?e.fragments[t-e.startSN]:null}calculateFragInfoMap(e,t,i,r){var n=this.convertCuesIntoSubtitleFragInfo(t,r.itemId);let s={len:0,start:e,end:e},a=e,o=e,l=null,d=null;for(const t in n)if(Object.prototype.hasOwnProperty.call(n,t)){var u=Number(t);if(Z(u)){var c=n[u];if(!i||this.isFragmentCompleteOrEmpty(u,c.count,i))if(u===r.startSN&&e<c.startTime&&(a=o=s.start=s.end=e=c.startTime),e>=c.startTime&&(a===e||Z(l)&&1<u-l)&&(a=o=c.startTime),e>=c.startTime)o=c.endTime,l=u;else{if(!Z(l)||u-l!=1){d=u;break}o=c.endTime,l=u}}else this.logger.warn(`$fragInfoMap has invalid key ${u}`)}return s={len:o-a,start:a,end:o},{fragInfoMap:n,bufferInfo:s,prevFragSN:l,nextFragSN:d}}findFrags$(t,i,r){return this.tryAgain$.next(tf.TryAgain),this.tryAgain$.pipe(Hi(ir),La(()=>{var e=this.findFragmentsForPosition(r,i,t);return e.foundFrags?(this.lastCueEndTime=0,this.needNextSubtitle$.next(!0),Vi(e)):(this.tryAgain$.next(tf.Complete),wi)}),Ka(this.tryAgain$.pipe(cn(e=>e===tf.Complete))),Bs(()=>{}))}reviewParsedFrag(i,e,r,n){var s=e.frag,a=e.cueRange,t=r.subtitleBufferInfo,o=r.subtitleParsedInfo,e=r.foundFrags;let l=!0;if(s.gap)return ef.CloseEnough;if(s.mediaSeqNum===e[0].mediaSeqNum){if(this.selectedMediaOption==this._interstitialDisableMediaOption&&this.interstitialIsPlaying)return ef.CloseEnough;if(!r.timelineEstablished)return ef.TooFar;if(!a)return this.logger.warn(`[subtitle] 1st frag sn ${s.mediaSeqNum} has no cue; details ${n.fragments.length} frags`),ef.Unknown;if(a.startTime<i){const d=n.fragments,r=s.mediaSeqNum-n.startSN;let e=r,t=a.startTime;for(;e<d.length&&(t+=d[e].duration,!(t>=i));++e);l=e-r<=this.config.earlyFragTolerance}else if(a.startTime>i&&s.mediaSeqNum!==n.startSN){const d=a.startTime-i,r=t.prevFragSN;l=s.mediaSeqNum===r+1&&(null===(t=t.fragInfoMap[r])||void 0===t?void 0:t.count)===(null===(o=o[r])||void 0===o?void 0:o.count)||d<=this.config.lateTolerance}}return l?ef.CloseEnough:ef.TooFar}isFragmentEmpty(e){return e&&!Z(e.startTime)&&0===e.count}isFragmentCompleteOrEmpty(e,t,i){e=i?i[e]:null;return(null==e?void 0:e.count)===t||this.isFragmentEmpty(e)}getEarlierFragmentInSameDisco(e,t,i){var r=t.mediaSeqNum-e.startSN-1;if(r<0||r>e.fragments.length-1)return this.logger.error(`[subtitle] getEarlierFragmentInSameDisco index ${r} out of range`),t;r=e.fragments[r];return r&&r.discoSeqNum===t.discoSeqNum&&!i[t.mediaSeqNum]?r:t}inferSubtitleFragmentForPosition(r,n,s,a,o){var l,d;let u,c,e,h,p;if(Z(a.prevFragSN)&&(c=a.prevFragSN-o.startSN,e=s[a.prevFragSN]),Z(a.nextFragSN)&&(h=a.nextFragSN-o.startSN,p=s[a.nextFragSN]),Z(c)&&0<=c&&c<o.fragments.length&&e){let t,i=e.startTime;var f=Z(h)?h:o.fragments.length;for(let e=c;e<f;++e){const h=o.fragments[e];if(!Z(n)||h.discoSeqNum===n){if(!(t||Z(n)&&h.discoSeqNum!==n)){const r=null===(l=a.fragInfoMap[h.mediaSeqNum])||void 0===l?void 0:l.count;this.isFragmentCompleteOrEmpty(h.mediaSeqNum,null!=r?r:0,s)||(t=h)}if(e===f-1){u={foundFrag:h,timelineEstablished:!0};break}if(i+h.duration>r&&e>c){u={foundFrag:h,timelineEstablished:!0};break}i+=h.duration}}!u&&t&&(u={foundFrag:t,timelineEstablished:!1})}else if(Z(h)&&0<=h&&h<o.fragments.length&&p){let t,i=p.startTime;for(let e=h-1;0<=e;--e){const h=o.fragments[e];if(!Z(n)||h.discoSeqNum===n){if(!Z(n)||h.discoSeqNum===n){const r=null===(d=a.fragInfoMap[h.mediaSeqNum])||void 0===d?void 0:d.count;this.isFragmentCompleteOrEmpty(h.mediaSeqNum,null!=r?r:0,s)||(t=h)}if(i<=r){u={foundFrag:h,timelineEstablished:!0};break}i-=h.duration}}!u&&t&&(u={foundFrag:t,timelineEstablished:!1})}else for(let e=0;e<o.fragments.length;++e){const s=o.fragments[e];if(Z(n)&&s.discoSeqNum===n){u={foundFrag:s,timelineEstablished:!1};break}}return u}generateFragmentBatch(t,i,e,r,n,s){var a;const o=[],l=null==e?void 0:e.foundFrag;if(!l)return{foundFrags:void 0,subtitleParsedInfo:void 0,subtitleBufferInfo:void 0,timelineEstablished:null==e?void 0:e.timelineEstablished};for(let e=l?l.mediaSeqNum-s.startSN:s.fragments.length;e<s.fragments.length&&o.length<t;++e){const t=s.fragments[e];if(t.discoSeqNum===i){const l=null===(a=n.fragInfoMap[t.mediaSeqNum])||void 0===a?void 0:a.count;this.isFragmentCompleteOrEmpty(t.mediaSeqNum,null!=l?l:0,r)||o.push(t)}}return{foundFrags:o,subtitleParsedInfo:r,subtitleBufferInfo:n,timelineEstablished:null==e?void 0:e.timelineEstablished}}findFragmentsForPosition(e,t,i){let r=i.itemId+i.mediaOptionId;var n=this.mediaSelectionOptions.find(e=>e.mediaOptionId===i.mediaOptionId);n&&n.isInterstitial&&(r="interstitial");var s=this.mediaSink.mediaQuery.getParsedSubtitleRecordsForMediaOption(r),n=this.getCuesOfEnabledTrack(null===(a=this.selectedMediaOption)||void 0===a?void 0:a.mediaOptionId,!1),a=this.calculateFragInfoMap(e,n,s,i),n=a.bufferInfo,n=Math.max(e,n.end),n=this.inferSubtitleFragmentForPosition(n,t,s,a,i);return this.generateFragmentBatch(1/0,t,n,s,a,i)}get selectedMediaOption(){let e=this._disabledMediaOption;return this.interstitialIsPlaying&&(e=this._interstitialDisableMediaOption),this.selectedTrack||e}set selectedMediaOption(e){this.selectedTrack="groupId"in e?e:void 0}get selectedTrack(){return this.interstitialIsPlaying?this._interstitialSelectedMediaOption:this._selectedMediaOption}set selectedTrack(e){e!==this._selectedMediaOption&&e!==this._interstitialSelectedMediaOption&&(null!=e&&e.isInterstitial?this._interstitialSelectedMediaOption=e:this._selectedMediaOption=e,this.updateTextTrackState(e))}getTrack(t){return this.mediaSelectionOptions.find(e=>e.mediaOptionId===t)}updateTextTrackState(e){var t;this.mediaSink.textTracks&&(e&&e.isInterstitial&&!this.interstitialIsPlaying||e&&!e.isInterstitial&&this.interstitialIsPlaying||(t=this.selectedTrack?this.getExistingHTMLTextTrack(this.selectedTrack):void 0,e=lf(this.mediaSink.textTracks),this.performUpdateTextTrack(e,t)))}interstitialSwitchTextTrack(){if(this.mediaSink.textTracks){var t=lf(this.mediaSink.textTracks);let e=this._selectedMediaOption?this.getExistingHTMLTextTrack(this._selectedMediaOption):void 0;this.interstitialIsPlaying&&(e=this._interstitialSelectedMediaOption?this.getExistingHTMLTextTrack(this._interstitialSelectedMediaOption):void 0),this.performUpdateTextTrack(t,e)}}performUpdateTextTrack(t,i){for(let e=0;e<t.length;e++){var r=t[e];r===i&&"showing"!==t[e].mode?t[e].mode="showing":r!==i&&"hidden"!==t[e].mode&&(t[e].mode="hidden")}}mapHTMLTextTrackIndexToMediaOptionId(e){const i=this.mediaSink.textTracks[e];let r;return this.htmlTextTrackMap.forEach((e,t)=>{i===e&&(r=t)}),r}get mediaSelectionOptions(){var e;return this.interstitialIsPlaying?null!==(e=this._availableInterstitialMediaOptions)&&void 0!==e?e:[]:null!==(e=this._availableMediaOptions)&&void 0!==e?e:[]}_makeDisableOption(e){return{itemId:e.itemId,mediaOptionType:e.mediaOptionType,mediaOptionId:"Nah"}}_onTextTracksChanged(){var r;if(this.mediaSink&&this.nativeSubtitleTrackChange$){let t,i=!1;const n=lf(this.mediaSink.textTracks);for(let e=0;e<n.length;e++)n[e].seen?"showing"===n[e].mode&&(t=null!==(r=this.selectedTrack)&&void 0!==r&&r.isInterstitial?this.selectedTrack.persistentID:n[e].persistentId):(n[e].seen=!0,i=!0);if(!i){const r=this.selectedTrack;if((null==r?void 0:r.persistentID)!==t){const r=this.mediaSelectionOptions.find(function(e){return e.persistentID===t});this.nativeSubtitleTrackChange$.next(r||this._disabledMediaOption)}}}}addCues(e,t,i,r){const n=this.cueRanges;let s=!1;for(let e=n.length;e--;){const r=n[e],d=(a=r[0],o=r[1],l=t,Math.min(o,i)-Math.max(a,l));if(0<=d&&(r[0]=Math.min(r[0],t),r[1]=Math.max(r[1],i),s=!0,.5<d/(i-t)))return}var a,o,l;let d;s||n.push([t,i]),this.addCueToInterstitial&&(d=this.channelToTrackMap["i"+e]),d=d||this.channelToTrackMap[e],this.Cues.newCue(d,t,i,r,this.mediaSink.offsetWidth,this.mediaSink.offsetHeight)}getExistingHTMLTextTrackWithChannelNumber(t){var i=this.mediaSink;if(i)for(let e=0;e<i.textTracks.length;e++){var r=i.textTracks[e],n="cc"+t;if(of(n)&&!0===r[n])return r}return null}sendAddTrackEvent(e,t){let i=null;try{i=new window.Event("addtrack")}catch(e){i=document.createEvent("Event"),i.initEvent("addtrack",!1,!1)}i.track=e,t.dispatchEvent(i)}createHTMLCaptionsTrackGuts(e,t,i,r){var n="cc"+e;if(!this.channelToTrackMap[n]){e=this.getExistingHTMLTextTrackWithChannelNumber(e);if(e)this.channelToTrackMap[n]=e,df(this.channelToTrackMap[n]),this.sendAddTrackEvent(this.channelToTrackMap[n],this.mediaSink);else{const s=this.createHTMLTextTrackGuts("captions",t,i,r);s&&of(n)&&(s[n]=!0,this.channelToTrackMap[n]=s)}}return this.channelToTrackMap[n]}createHTMLCaptionsTrack(e){return this.createHTMLCaptionsTrackGuts(e,this.config[1===e?"captionsTextTrack1Label":"captionsTextTrack2Label"],this.config.captionsTextTrack1LanguageCode,!1)}getExistingHTMLTextTrack(e){return e.isInterstitial?e.mediaType===Ou.CLOSEDCAPTION?1===this.trackChannelNumber(e)?this.interstitialCCTrack1:this.interstitialCCTrack2:this.interstitialTextTrack:this.config.condenseSubtitleTrack?this.htmlTextTrackMap.get(e.persistentID):this.htmlTextTrackMap.get(e.id)}getExistingHTMLTextTrackWithSubtitleTrackId(t){var e=this.mediaSelectionOptions.find(e=>e.id===t);return e?this.getExistingHTMLTextTrack(e):void 0}getExistingHTMLTextTrackIndex(e){var t=this.getExistingHTMLTextTrack(e),i=this.mediaSink.textTracks;let r=-1;for(let e=0;e<i.length;++e)if(i[e]===t){r=e;break}return r}setExistingHTMLTextTrack(e,t){return t.persistentId=e.persistentID,this.config.condenseSubtitleTrack?this.htmlTextTrackMap.set(e.persistentID,t):this.htmlTextTrackMap.set(e.id,t)}createHTMLTextTrack(t){let i=this.getExistingHTMLTextTrack(t);if(i)this.tracksReused+=1;else{if("sbtl"===t.mediaType)this.subtitleTracksCreated+=1,i=this.createHTMLTextTrackGuts("subtitles",t.name,t.lang,t.forced);else{let e=1;t.inStreamID&&(e=Number(t.inStreamID.substring(2))),this.captionTracksCreated+=1,i=this.createHTMLCaptionsTrackGuts(e,t.name,t.lang,!1)}i?this.setExistingHTMLTextTrack(t,i):(this.logger.error(`failed to create HTML text track for track ${t.id}: persistent id ${t.persistentID} name ${t.name} lang ${t.lang} inStreamID ${t.inStreamID}`),this.tracksFailed+=1)}return i}createHTMLTextTrackGuts(t,i,r,e){const n=this.mediaSink;if(n){let e=!1;"metadata"!==t&&this.config.customTextTrackCueRenderer&&(e=!0,t="metadata");const s=n.addTextTrack(t,i,r);return e&&(s.customTextTrackCueRenderer=!0),s}}trackChannelNumber(e){let t=1;return e.inStreamID&&(t=Number(e.inStreamID.substring(2))),t}resetLoadSource(){this.resetTracks()}removeOldCues(t,i=50){if(this.mediaSink){var r=this.mediaSink.textTracks;for(let e=0;r&&e<r.length;e++){const n=r[e];if(n&&n.cues&&0<n.cues.length){let e=0;for(;0<n.cues.length&&e<i&&n.cues[0].endTime<t;)n.removeCue(n.cues[0]),e++}}this.removeOldCCCueRanges(t),this.mediaSink.removeOldParsedSubtitleFragmentRecord(t)}}removeOldCCCueRanges(t){const i=this.cueRanges;let r=0;for(let e=0;e<i.length&&!(i[e][0]>t);e++)i[e][1]<t?r++:i[e][0]<t&&i[e][1]>t&&(i[e][0]=t);0<r&&i.splice(0,r)}resetTracks(){this._cleanTracks(),this.cueRanges=[]}_cleanTracks(t=!1){var e=this.mediaSink;if(e){var i=e.textTracks;for(let e=0;i&&e<i.length;e++)t&&this._isInterstitialTextTrack(i[e])||df(i[e])}}_isInterstitialTextTrack(e){return e===this.interstitialTextTrack||e===this.interstitialCCTrack1||e===this.interstitialCCTrack1}getCuesOfEnabledTrack(e,t=!1){let i=[];if(t){const t=this._getCuesOfEnabledTrack(e);for(let e=0;e<t.length;e++){var r=t[e];Boolean(r.webVTTCue)&&i.push(r)}}else i=this._getCuesOfEnabledTrack(e);return i}_getCuesOfEnabledTrack(e){var t=this.getTrack(e),e=null!=t&&t.isInterstitial?t.mediaType===Ou.SUBTITLE?"interstitial":1===this.trackChannelNumber(t)?"interstitialCC1":"interstitialCC2":this.config.condenseSubtitleTrack?null==t?void 0:t.persistentID:null==t?void 0:t.id,e=this.htmlTextTrackMap.get(e);return null!=t&&t.isInterstitial&&this.interstitialIsPlaying&&this.updateInterstitialTextTrackIfNecessary(t,e),e&&e.cues?Array.from(e.cues):[]}updateInterstitialTextTrackIfNecessary(e,t){e.persistentID!==t.persistentId&&(t.persistentId=e.persistentID,df(t),this.mediaSink.clearParsedSubtitleRecordsForMediaOption("interstitial"))}clearInterstitialTextTracks(){df(this.interstitialTextTrack),df(this.interstitialCCTrack1),df(this.interstitialCCTrack2),this.mediaSink.clearParsedSubtitleRecordsForMediaOption("interstitial")}attachSubtitleTracks(){this.gotTracks&&(this.subtitleTracksCreated=0,this.captionTracksCreated=0,this.tracksReused=0,this.tracksFailed=0,this.tracks.forEach(e=>{this.createHTMLTextTrack(e)}))}setTracks(e,t,i){this._cleanTracks(),this.htmlTextTrackMap=new Map,this.cueRanges=[],this.config.enableWebVTT&&(this.tracks=e||[]),this.gotTracks=!0,this._availableMediaOptions=e,this._disabledMediaOption=i,this.attachSubtitleTracks(),this.selectedTrack=t,this.nativeSubtitleTrackChange$=new Jt,this.mediaSink.textTracksCreated=!0}setInterstitialTracks(e,t,i){this.clearInterstitialTextTracks(),this.htmlTextTrackMap||(this.htmlTextTrackMap=new Map);let r=!1,n=!1,s=!1;e.forEach(e=>{e.mediaType===Ou.SUBTITLE?r=!0:1===this.trackChannelNumber(e)?n=!0:s=!0}),!this.interstitialTextTrack&&r&&(this.interstitialTextTrack=this.createHTMLTextTrackGuts("subtitles","interstitialTextTrack","interstitialMulti",!1),this.htmlTextTrackMap.set("interstitial",this.interstitialTextTrack)),!this.interstitialCCTrack1&&n&&(this.interstitialCCTrack1=this.createHTMLTextTrackGuts("captions","interstitialCCTrack1","interstitialMulti",!1),this.htmlTextTrackMap.set("interstitialCC1",this.interstitialCCTrack1),this.channelToTrackMap.icc1=this.interstitialCCTrack1),!this.interstitialCCTrack2&&s&&(this.interstitialCCTrack2=this.createHTMLTextTrackGuts("captions","interstitialCCTrack2","interstitialMulti",!1),this.htmlTextTrackMap.set("interstitialCC2",this.interstitialCCTrack2),this.channelToTrackMap.icc2=this.interstitialCCTrack2),this._availableInterstitialMediaOptions=e,this._interstitialDisableMediaOption=i,t&&((this.selectedTrack=t).mediaType===Ou.SUBTITLE?this.interstitialTextTrack&&(this.interstitialTextTrack.persistentId=t.persistentID):1===this.trackChannelNumber(t)?this.interstitialCCTrack1.persistentId=t.persistentID:this.interstitialCCTrack2.persistentId=t.persistentID),this.nativeSubtitleTrackChange$=new Jt}onInlineStylesParsed(e){}processSubtitleFrag(e,t,i,r){var n=new Uint8Array(r),e=this.getExistingHTMLTextTrackIndex(e);return t&&r.byteLength?this._parseVTTs(e,t,i,n).pipe(pr(e=>(e&&Z(e.startTime)&&(this.lastCueEndTime=Math.max(this.lastCueEndTime,e.endTime)),e))):Vi(void 0)}_parseVTTs(i,o,t,r){return new Kt(e=>{!function(e,t,i,r,n,s){const a=B.utf8arrayToStr(new Uint8Array(e)).trim().replace(/\r\n|\n\r|\n|\r/g,"\n").split("\n"),o={baseTime:Math.floor(9e4*t.baseTime/t.timescale),timescale:9e4};let l=0,d=0;const u=[];let c=null,h=!0;const p=new dp.WebVTTParser(window,dp.WebVTTParser.StringDecoder(),s);p.oncue=function(e){var t=E({baseTime:Bp(Bp(l)-o.baseTime,9e4*i),timescale:9e4});e.startTime=Bp(e.startTime+t-d,0,95443.7176888889),e.endTime=Bp(e.endTime+t-d,0,95443.7176888889),e.id=Np(Fp(e.startTime).toString())+Np(Fp(e.endTime-e.startTime).toString())+Np(e.text),e.text=decodeURIComponent(encodeURIComponent(e.text)),0<e.endTime&&u.push(e)},p.onparsingerror=function(e){c=e},p.onflush=function(){c&&n?c:r(u)},a.forEach(a=>h&&Lp(a,"X-TIMESTAMP-MAP=")?(h=!1,void a.substr(16).split(",").forEach(e=>{if(Lp(e,"LOCAL:")){let t;try{t=(i=e.substr(6),r=parseInt(i.substr(-3)),n=parseInt(i.substr(-6,2)),s=parseInt(i.substr(-9,2)),i=9<i.length?parseInt(i.substr(0,i.indexOf(":"))):0,Z(r)&&Z(n)&&Z(s)&&Z(i)?(r+=1e3*n,r+=6e4*s,r+=36e5*i):-1)}catch(e){t=-1}-1!==t?d=t/1e3:c=new Error(`Malformed X-TIMESTAMP-MAP: ${a}`)}else Lp(e,"MPEGTS:")&&(l=parseInt(e.substr(7)));var i,r,n,s})):void p.parse(a+"\n")),p.flush()}(r,t,o.start,(o.discoSeqNum,n=>{const s=this.mediaSink.textTracks[i],t={count:0,startTime:Number.POSITIVE_INFINITY,endTime:0},a=new Si(0);a.pipe(Hi(ir),la((e,t)=>{var i=performance.now();let r=t;for(;r<n.length&&(r-t<100||performance.now()-i<200);++r){const t=n[r];!s||s.cues&&s.cues.getCueById(t.id)||(t.fragSN=o.mediaSeqNum,t.webVTTCue=!0,t.itemId=o.itemId,s.addCue(t),e.count++),e.startTime=Math.min(t.startTime,e.startTime),e.endTime=Math.max(t.endTime,e.endTime)}return r<n.length?a.next(r):a.complete(),e},t),eo(()=>{let e="interstitial";this.selectedTrack&&!this.selectedTrack.isInterstitial&&(e=this.selectedTrack.itemId+this.selectedTrack.mediaOptionId),this.mediaSink.archiveParsedSubtitleFragmentRecord(e,o.mediaSeqNum,t)}),Bs(()=>{e.complete()})).subscribe(e)}),e=>{},e=>{this.hls.trigger(D.INLINE_STYLES_PARSED,{styles:e})},this.logger)})}_ensureParser(){var e,t;this.cea608Parser||(e=new af(this,1),t=new af(this,2),this.cea608Parser=new class{constructor(e=1,t,i){this.field=e,this.currChNr=-1,this.lastCmdA=null,this.lastCmdB=null,this.channels=[new Zp(1,t),new Zp(2,i)],this.dataCounters={padding:0,char:0,cmd:0,other:0}}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){let i,r,n,s=null;Wp.setTime(e);for(let e=0;e<t.length;e+=2)r=127&t[e],n=127&t[e+1],16<=r&&r<=31&&r===this.lastCmdA&&n===this.lastCmdB?(this.lastCmdA=null,this.lastCmdB=null,Wp.log("DEBUG","Repeated command ("+$p([r,n])+") is dropped")):0!=r||0!=n?(Wp.log("DATA","["+$p([t[e],t[e+1]])+"] -> ("+$p([r,n])+")"),i=this.parseCmd(r,n),i=i||this.parseMidrow(r,n),i=i||this.parsePAC(r,n),i=i||this.parseBackgroundAttributes(r,n),!i&&(s=this.parseChars(r,n),s)&&(this.currChNr&&0<=this.currChNr?this.channels[this.currChNr-1].insertChars(s):Wp.log("WARNING","No channel found yet. TEXT-MODE?")),i?this.dataCounters.cmd+=2:s?this.dataCounters.char+=2:(this.dataCounters.other+=2,Wp.log("WARNING","Couldn't parse cleaned data "+$p([r,n])+" orig: "+$p([t[e],t[e+1]])))):this.dataCounters.padding+=2}parseCmd(e,t){var i;if(!((20===e||21===e||28===e||29===e)&&32<=t&&t<=47||(23===e||31===e)&&33<=t&&t<=35))return!1;const r=this.channels[(i=20===e||23===e?1:2)-1];return 20===e||21===e||28===e||29===e?32===t?r.ccRCL():33===t?r.ccBS():34===t?r.ccAOF():35===t?r.ccAON():36===t?r.ccDER():37===t?r.ccRU(2):38===t?r.ccRU(3):39===t?r.ccRU(4):40===t?r.ccFON():41===t?r.ccRDC():42===t?r.ccTR():43===t?r.ccRTD():44===t?r.ccEDM():45===t?r.ccCR():46===t?r.ccENM():47===t&&r.ccEOC():r.ccTO(t-32),this.lastCmdA=e,this.lastCmdB=t,this.currChNr=i,!0}parseMidrow(e,t){var i;if((17===e||25===e)&&32<=t&&t<=47){if((i=17===e?1:2)!==this.currChNr)return Wp.log("ERROR","Mismatch channel in midrow parsing"),!1;const r=this.channels[i-1];return r.insertChars([32]),r.ccMIDROW(t),Wp.log("DEBUG","MIDROW ("+$p([e,t])+")"),this.lastCmdA=e,this.lastCmdB=t,!0}return!1}parsePAC(e,t){if(!((17<=e&&e<=23||25<=e&&e<=31)&&64<=t&&t<=127||(16===e||24===e)&&64<=t&&t<=95))return!1;var i=e<=23?1:2,r=(64<=t&&t<=95?1==i?Qp:jp:1==i?qp:Hp)[e],r=this.interpretPAC(r,t);return this.channels[i-1].setPAC(r),this.lastCmdA=e,this.lastCmdB=t,this.currChNr=i,!0}interpretPAC(e,t){var i;const r={color:null,italics:!1,indent:null,underline:!1,row:e};return i=95<t?t-96:t-64,r.underline=1==(1&i),i<=13?r.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(r.italics=!0,r.color="white"):r.indent=4*Math.floor((i-16)/2),r}parseChars(e,t){let i=null,r=null,n=null;var s;if(n=25<=e?(i=2,e-8):(i=1,e),17<=n&&n<=19?(s=t,s=17===n?t+80:18===n?t+112:t+144,Wp.log("INFO","Special char '"+Up(s)+"' in channel "+i),r=[s],this.lastCmdA=e,this.lastCmdB=t):32<=e&&e<=127&&(r=0===t?[e]:[e,t],this.lastCmdA=null,this.lastCmdB=null),r){const e=$p(r);Wp.log("DEBUG",`Char codes =  ${e.join(",")}`)}return r}parseBackgroundAttributes(e,t){let i,r,n;return((16===e||24===e)&&32<=t&&t<=47||(23===e||31===e)&&45<=t&&t<=47)&&(i={underline:!1},16===e||24===e?(r=Math.floor((t-32)/2),i.background=Gp[r],t%2==1&&(i.background=i.background+"_semi")):45===t?i.background="transparent":(i.foreground="black",47===t&&(i.underline=!0)),n=this.channels[(e<24?1:2)-1],n.setBkgData(i),this.lastCmdA=null,!(this.lastCmdB=null))}reset(){for(let e=0;e<this.channels.length;e++)this.channels[e]&&this.channels[e].reset();this.lastCmdA=null,this.lastCmdB=null}cueSplitAtTime(t){for(let e=0;e<this.channels.length;e++)this.channels[e]&&this.channels[e].cueSplitAtTime(t)}}(0,e,t))}setupForFrag(e){e&&e.mediaOptionType===Tu.Variant&&!e.iframe&&((e=e.mediaSeqNum)!==this.lastVariantSeqNum+1&&this.resetClosedCaptionParser(),this.lastVariantSeqNum=e)}resetClosedCaptionParser(){var e;null===(e=this.cea608Parser)||void 0===e||e.reset()}addLegibleSamples(e,t,i,r,n,s){this.addCueToInterstitial=!!s,t&&this.addClosedCaptionSamples(e,t),i&&0<i.length&&this.addId3Samples(e,i,r,E(n))}addClosedCaptionSamples(e,t){t.mp4?this.addMP4CaptionSamples(e,t.mp4):t.ts&&this.addTSCaptionSamples(e,t.ts)}addMP4CaptionSamples(e,i){if(this.enableCaption&&this.config.enableCEA708Captions){var r=E(e);this._ensureParser();for(let e=0;e<i.length;e++){let t=i[e].pts-r;var n=i[e].bytes;for(let e=0;e<n.length;e+=2){const i=[];i.push(n[e]),e+1<n.length?i.push(n[e+1]):i.push(80),this.cea608Parser.addData(t,i),t+=.03336666666666667}}}}addTSCaptionSamples(e,t){if(this.enableCaption&&this.config.enableCEA708Captions){var i=E(e);this._ensureParser();for(let e=0;e<t.length;e++){var r=t[e].pts-i,n=function(t){var i=31&t[0];let r,n,s,a=2;const o=[];for(let e=0;e<i;e++)r=t[a++],n=127&t[a++],s=127&t[a++],0==n&&0==s||0!=(4&r)&&0==(3&r)&&(o.push(n),o.push(s));return o}(t[e].bytes);this.cea608Parser.addData(r,n)}}}addId3Samples(e,t,r,n){if(this.config.enableID3Cues){const s=window.WebKitDataCue||window.VTTCue||window.TextTrackCue,a=E(e);for(let e=0;e<t.length;e++){const o=this._adjustID3PtsForRollover(t[e].pts,r)-a;let i=this._adjustID3PtsForRollover(e<t.length-1?t[e+1].pts:n,r)-a;o===i&&(i+=1e-4),t[e].frames&&t[e].frames.forEach(e=>{if(e&&!this.id3shouldIgnore(e)){const t=new s(o,i,"");t.value=e,this.id3Track.addCue(t)}})}}}_adjustID3PtsForRollover(e,t){return Bp(e*t.timescale,t.baseTime,Math.pow(2,33))/t.timescale}id3shouldIgnore(e){return"PRIV"===e.key&&("com.apple.streaming.transportStreamTimestamp"===e.info||"com.apple.streaming.audioDescription"===e.info)}}const cf={name:"plist"};class hf{constructor(e,t,i){this.xhrLoader=e,this.customUrlLoader=t,this.sessionDataCheckForCompleteness=(e,t)=>{const i=t["sessionDataAutoLoad"],r=Object.assign({},e);return e.complete||(e.itemList?r.complete=e.itemList.every(e=>i[e["DATA-ID"]]&&!e.VALUE&&!e._STATUS&&e.URI?(this.logger.warn(`Incomplete because ${e["DATA-ID"]} was autoloaded but no response yet`),!1):(i[e["DATA-ID"]]&&!e.URI&&this.logger.warn(`id=${e["DATA-ID"]} missing uri`),!0)):this.logger.warn("Uninitialized SessionData")),r},this.logger=i.child({name:"SessionDataLoader"})}loadSessionData(r,n){const s=n["sessionDataAutoLoad"],t=r.itemList||[];let a=Vi(r);return t.forEach(e=>{const i=e["DATA-ID"],t=e.URI;if(t&&s[i]){const s=Au.buildAbsoluteURL(r.baseUrl,t,{alwaysNormalize:!0}),e="";a=a.pipe(La(t=>this.loadSessionDataItemWithUrl(s,i,"",n,t,this.xhrLoader,this.customUrlLoader).pipe(Qn(e=>(this.logger.error(`Error loading SessionData > url=${s}, id=${i}, err=${e}`),Vi(t))))))}}),a.pipe(pr(e=>{if(t.length<1)return e;e=this.sessionDataCheckForCompleteness(e,n);if(e.complete)return e;throw new Q(!1,"Session data not complete after loading all items",K.IncompleteSessionData)}),Bs(()=>{}))}loadSessionDataItemWithUrl(s,a,e,t,o,i,l){const r=Ge(),d={url:s,method:"GET",responseType:e,xhrSetup:t.xhrSetup,mimeType:"application/xml"},u=Dc({url:s},t.fragLoadPolicy);let n;if(Ru(s))n=l(d,u).pipe(pr(e=>this.onLoadSuccess(o,a,e.data.response.data.toString(),e.data.response.data)));else{const s=performance.now();n=i(d,u).pipe(pr(([e])=>this.onLoadSuccess(o,a,e.response,e.responseXML)),Qn(e=>{if(e instanceof hc&&e.isAuthOrCorsError)return t=d,i=u,r=l,n=s,Bc(e),r(t,Fc(t,i,n)).pipe(pr(e=>this.onLoadSuccess(o,a,e.data.response.data.toString(),e.data.response.data)));var t,i,r,n;throw e}))}return n.pipe(Qn(e=>(e instanceof ur?e=new gc(!1,e.message,K.SessionDataLoadTimeout):e instanceof hc&&(e=new gc(!1,e.message,{code:e.statusCode,text:"Failed to load SessionData"})),r.error(`Unable to load SessionData > err=${e}`),Vi(this.onLoadError(o,a,e)))))}onLoadSuccess(e,t,i,r){let n=null,s=e;if(function(e){const t=/[\s]*<\?xml/i;t.lastIndex=0;var i=t.exec(e);return i||/[\s]*<plist/i.exec(e)}(i)&&(n=r)){const i=function n(e){if(!e)return null;const t=Ge();let s=null;var a=e.childNodes;if(a)if(e.tagName){var i=null===(i=e.tagName)||void 0===i?void 0:i.toLowerCase();if("plist"===i){s=[];for(let e=0;e<a.length;++e){const r=a[e];r.tagName&&s.push(n(r))}1===s.length&&(s=s[0])}if("array"===i){s=[];for(let e=0;e<a.length;++e){const r=a[e];r.tagName&&s.push(n(r))}}if("dict"===i){let t,i,r=0;s={};for(let e=0;e<a.length;e++){var o=a[e],l=null===(l=o.tagName)||void 0===l?void 0:l.toLowerCase();l&&(r%2==0?"key"===l&&(t=n(o),r++):(i=n(o),s[t]=i,t=null,i=null,r++))}t&&(s[t]=i,t=null,i=null)}else if("key"===i){const e=a[0];s=e?e.nodeValue:(t.warn(cf,"Invalid dict key: Key is null, probably like this: <key/>"),null)}else if("string"===i){const e=a[0];s=e?e.nodeValue:null}else if("integer"===i){const e=a[0];s=e?parseInt(e.nodeValue):0}else if("float"===i){const e=a[0];s=e?parseFloat(e.nodeValue):0}else if("date"===i){const e=a[0];s=e?new Date(e.nodeValue):null}else if("data"===i){const e=a[0];s=e?atob(e.nodeValue):null}else"true"===i?s=!0:"false"===i&&(s=!1)}else if(a.length<1)t.warn(cf,`unknown node with unknown value > nodeType=${e.nodeType} tagName=${e.tagName} nodeName=${e.nodeName} value=${e.nodeValue}`);else{s=[];for(let e=0;e<a.length;++e){const r=a[e];r.tagName&&s.push(n(r))}1===s.length&&(s=s[0])}return s}(n);s=this.setSessionData(e,t,"VALUE",i)}else if(function(e){const t=/[\s]*[\{\[]/;return t.lastIndex=0,t.exec(e)}(i))try{const r=JSON.parse(i);s=this.setSessionData(e,t,"VALUE",r)}catch(r){this.logger.error(`JSON parser error: ${r}`),s=this.setSessionData(e,t,"VALUE",i),s=this.setSessionData(s,t,"_STATUS",-1)}else s=this.setSessionData(e,t,"VALUE",i);return s}setSessionData(t,i,r,n){let s=t;if(t.itemList){let e;const a=[...t.itemList];for(e=0;e<t.itemList.length;++e){const t=Object.assign({},a[e]);if(t["DATA-ID"]===i){t[r]=n,a[e]=t;break}}e===t.itemList.length&&this.logger.error(`Can't set ${r} of session data ${i}`),s=Object.assign(Object.assign({},t),{itemList:a})}else this.logger.error(`Can't set ${r} on uninitialized session data`);return s}onLoadError(e,t,i){return this.setSessionData(e,t,"_STATUS",null===(i=i.response)||void 0===i?void 0:i.code)}}const pf=new Set(["buildType","customTextTrackCueRenderer","debug","debugLevel","disableVideoCodecList","disableAudioCodecList","enablePerformanceLogging","enableQueryParamsForITunes","enableRtcReporting","nativeControlsEnabled","offlinePlayback","playReadyMessageFormat","rtcIntervalTimeout","sessionDataAutoLoad","storage","storageKeyPrefix","supportedStorebagVersion","useCustomMediaFunctions","useHighestVideoCodecPrivate","xhrSetup"]);function ff(e,t){var i=e.split(".").map(e=>Number.parseInt(e)),r=t.split(".").map(e=>Number.parseInt(e));for(let e=0;e<Math.min(i.length,r.length);e++){if(i[e]<r[e])return!1;if(i[e]>r[e])return!0}return!0}function mf(t){var i=Math.random();let r=0;for(let e=0;e<t.length;e++)if(r+=t[e],i<r)return e;return t.length-1}const gf={timeRangesToBufferedRange(t){const i=[];for(let e=0;t&&e<t.length;e++)i.push({start:t.start(e),end:t.end(e)});return i},getBufferedInfo(e,t,i){let r,n,s,a,o;var l=this.getBufferedTimeRanges(e,i),d=Math.max(i,.001);for(o=0,r=0,n=s=t;o<l.length;o++){const e=l[o]["start"],i=l[o]["end"];if(t+d>=e&&t<i)n=e,s=i,r=s-t;else if(t+d<e){a=e;break}}return{len:r,start:n,end:s,nextStart:a}},getBufferedTimeRanges(e,t){const i=[],r=e.map(({start:e,end:t})=>({start:e,end:t}));r.sort((e,t)=>e.start-t.start||t.end-e.end);for(let e=0;e<r.length;e++){var n,s=i.length;s?(n=i[s-1].end,r[e].start-n<t?r[e].end>n&&(i[s-1].end=r[e].end):i.push(r[e])):i.push(r[e])}return i},isTimeRangeContainedInRanges(t,i,r=.25){for(let e=0;e<t.length;e++)if(i.start>=t[e].start-r&&i.end<=t[e].end+r)return!0;return!1}};function yf(e){return null!=e&&"iframeMediaDuration"in e&&"iframeMediaStart"in e}function vf(e,t){return e===t||e&&t&&e.itemId===t.itemId&&e.mediaOptionId===t.mediaOptionId&&e.mediaSeqNum===t.mediaSeqNum&&e.discoSeqNum===t.discoSeqNum}function Sf(e){return JSON.stringify(e,["mediaOptionId","mediaSeqNum","discoSeqNum","start","duration"])}function bf(e){var{itemId:t,mediaOptionId:i,discoSeqNum:r,keyTagInfo:e}=e;return{itemId:t,mediaOptionId:i,discoSeqNum:r,keyId:He(null==e?void 0:e.keyId)}}function Tf(e,t){let i,r=0;for(const a of e)if(a.start<=t.endPTS&&a.end>t.startPTS){const e=(n=t,s=a,Math.min(n.endPTS,s.end)-Math.max(n.startPTS,s.start));e>r&&(i=a,r=e)}else if(0<r)break;var n,s;return i}function If(){return e=>e.pipe(cn(e=>null!=e),pr(e=>e))}function Ef(e){return ye.isDolby(e)?yu.DOVI:ye.isHEVC(e)?yu.HEVC:ye.isVP09(e)?yu.VP09:ye.isAVC(e)?yu.AVC:yu.UNKNOWN}function wf(e){return null==e?void 0:e.split(".")[0]}function Of(e){return ye.isALAC(e)?Su.ALAC:ye.isFLAC(e)?Su.FLAC:ye.isEC3(e)?Su.EC3:ye.isAC3(e)?Su.AC3:ye.isXHEAAC(e)?Su.XHEAAC:ye.isAAC(e)?Su.AAC:ye.isMP3(e)?Su.MP3:Su.UNKNOWN}class Af{constructor(...e){this.identifier=e}ensureSameIdentifierLength(e){if(this.identifier.length!==e.identifier.length)throw new Error(`Identifiers have non-matching lengths! (${this.identifier.length} vs ${e.identifier.length})`)}isGreaterThan(t){this.ensureSameIdentifierLength(t);for(let e=0;e<this.identifier.length;++e){if(this.identifier[e]<t.identifier[e])return!1;if(this.identifier[e]>t.identifier[e])return!0}return!1}isEqualTo(i){return this.ensureSameIdentifierLength(i),this.identifier.every((e,t)=>e===i.identifier[t])}}function Rf(e){return Z(e)&&0!==e&&1!==e}class kf extends Error{}class Cf{constructor(e){this.value=e,this.waiters=[],this.wcounter=0,this.rcounter=0}lock(e,t=!1){return this._lock(!0,e,t)}unlock(){this._unlock(!0)}readLock(e,t=!1){return this._lock(!1,e,t)}readUnlock(){this._unlock(!1)}_schedule(){const t=[];this.waiters=this.waiters.filter(e=>!this._canLock(e.rw)||(e.rw?++this.wcounter:++this.rcounter,t.push(e),!1));for(const e of t)e.observer.next(this.value),e.observer.complete()}_canLock(e){return e&&0===this.wcounter&&0===this.rcounter||!e&&0===this.wcounter}_lock(i,e,r=!1){"boolean"==typeof e&&([r,e]=[e,void 0]);const t=new Kt(e=>{var t=this._canLock(i);if(r&&!t)throw new kf;t?(i?++this.wcounter:++this.rcounter,e.next(),e.complete()):this.waiters.push({rw:i,observer:e})});return e?t.pipe(Hr(()=>((e,t,i,r)=>{if(!r)return Vi(e);let n,s;try{n=r(e,t)}catch(e){s=Ki(()=>e)}return s=s||(void 0===n?Vi(e):Br(n)),s.pipe(Bs(i))})(this.value,e=>{this.value=e},()=>this._unlock(i),e))):t}_unlock(e){e?this.wcounter=Math.max(this.wcounter-1,0):this.rcounter=Math.max(this.rcounter-1,0),this._schedule()}}class Mf extends Kt{constructor(){super(e=>this._count$.pipe(cn(e=>0===e),As(1),Ys(void 0)).subscribe(e)),this._count$=new Si(0)}wrap(e){return en(()=>(this.add(),Br(e))).pipe(eo({error:e=>this._count$.error(e)}),Bs(()=>this.done()))}add(e=1){this._count$.next(this._count$.value+e)}done(e=1){this._count$.next(this._count$.value-e)}}(su=rf=rf||{}).Seek="Seek",su.HighBuffer="HighBuffer",su.LowBuffer="LowBuffer",(su=nf=nf||{}).AlmostDry="AlmostDry",su.LowWater="LowWater",su.HighWater="HighWater",su.AboveHighWater="AboveHighWater";const Pf={[nf.AlmostDry]:0,[nf.LowWater]:1,[nf.HighWater]:2,[nf.AboveHighWater]:3};function xf(t,e){return[{threshold:e.highWaterLevelSeconds,level:nf.HighWater},{threshold:e.lowWaterLevelSeconds,level:nf.LowWater},{threshold:e.almostDryWaterLevelSeconds,level:nf.AlmostDry}].find(({threshold:e})=>e<t)}function Df(t,e){return[{threshold:e.almostDryWaterLevelSeconds,level:nf.AlmostDry},{threshold:e.lowWaterLevelSeconds,level:nf.LowWater},{threshold:e.highWaterLevelSeconds,level:nf.HighWater},{threshold:1/0,level:nf.AboveHighWater}].find(({threshold:e})=>t<=e)}function _f(t,i){const e=Df(t.getCurrentWaterLevel(i),t.bufferMonitorInfo).level,r=[null,null];return[Iu.Variant,Iu.AltAudio].forEach(e=>{null!=t.sourceBufferEntityByType(e)&&(r[e]=Df(t.getCurrentWaterLevelByType(e,i),t.bufferMonitorInfo).level)}),{combined:e,sbTuple:r}}function Lf(s,a){return rd([s.combinedBuffer$,s.gotPlaying$,s.seeking$,s.waterLevelChangedForType$(null),s.stallInfo$]).pipe(La(([e,t,i,r,n])=>0===e.length||!t||i||null==r||null!=n?wi:function t(i,r,e){const n=i.getCurrentWaterLevel(r),s=xf(n,i.bufferMonitorInfo);if(s){const e=s["threshold"];return En(Math.ceil(1e3*(n-e))).pipe(La(()=>{const e=xf(i.getCurrentWaterLevel(r),i.bufferMonitorInfo);return(null==e?void 0:e.level)===s.level?t(i,r):Oh}),pr(()=>_f(i,r)))}return wi}(s,a)))}class Nf extends Al{constructor(e,t){super(t),this.mediaElement=e}get mediaElementDuration$(){return this.selectActive(({mediaElementDuration:e})=>e)}get primaryContentMediaElementDuration(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.primaryContentMediaElementDuration)&&void 0!==e?e:1/0}get mediaElementDuration(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.mediaElementDuration)&&void 0!==e?e:1/0}get msDuration(){var e;return null!==(e=null===(e=this.mediaSourceEntity)||void 0===e?void 0:e.duration)&&void 0!==e?e:1/0}get minSBDuration(){var e;let i=Number.POSITIVE_INFINITY;return null===(e=null===(e=this.mediaSourceEntity)||void 0===e?void 0:e.sourceBufferEntities)||void 0===e||e.forEach((e,t)=>{e&&(i=Z(e.totalDuration)?Math.min(i,e.totalDuration):Number.NEGATIVE_INFINITY)}),Z(i)?i:1/0}get currentTime(){return this.mediaElement.currentTime}get clientWidth(){return this.mediaElement.clientWidth}get clientHeight(){return this.mediaElement.clientHeight}getBufferedDuration(e=.5){var t=gf.timeRangesToBufferedRange(this.mediaElement.buffered),e=gf.getBufferedInfo(t,this.currentTime,e);return e.end-e.start}get mediaSourceEntity(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.mediaSourceEntity}get msReadyState(){var e;return null===(e=this.mediaSourceEntity)||void 0===e?void 0:e.readyState}get sourceBufferEntities(){var e;return null===(e=this.mediaSourceEntity)||void 0===e?void 0:e.sourceBufferEntities}sourceBufferEntityByType(e){var t;return null===(t=this.sourceBufferEntities)||void 0===t?void 0:t[e]}initSegmentEntityByType(e){return null===(e=this.sourceBufferEntityByType(e))||void 0===e?void 0:e.initSegmentInfo}get maxBufferSize(){var e=null===(e=this.sourceBufferEntities)||void 0===e?void 0:e[Iu.Variant];let t=1/0;return null!=e&&e.gotQuotaExceeded&&(t=null!==(e=e.maxTotalBytes)&&void 0!==e?e:1/0),t}get postFlushSeek(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.postFlushSeek}get seekable(){return this.mediaElement.seekable}get liveSeekableRange(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.liveSeekableRange}get liveSeekableRange$(){return this.selectActive(({liveSeekableRange:e})=>e)}get seekableTimeRanges(){return Ff(this.liveSeekableRange,this.seekable)}get seekableTimeRanges$(){return Pr([this.liveSeekableRange$,this.mediaElementDuration$]).pipe(pr(([e])=>Ff(e,this.seekable)))}get isPlayingAtLive(){var{liveSeekableRange:e,isIframeRate:t}=this;return null!=e&&!t&&this.currentTime>=e.boundary}get expectSeekingEvent(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.expectSeekingEvent)&&void 0!==e&&e}get desiredRate(){var e;return(null===(e=this.getActive())||void 0===e?void 0:e.desiredRate)||0}get desiredRate$(){return this.selectActive(({desiredRate:e})=>null!=e?e:0)}get effectiveRate(){return this.isIframeRate?this.desiredRate:this.paused?0:1}get playbackRate(){return this.mediaElement.playbackRate}get isIframeRate(){return Rf(this.desiredRate)}get isIframeRate$(){return this.desiredRate$.pipe(pr(Rf))}get msObjectUrl$(){return this.selectActive(({mediaSourceEntity:e})=>null==e?void 0:e.objectUrl).pipe(bs())}get msReadyState$(){return this.selectActive(({mediaSourceEntity:e})=>{return null!==(e=null==e?void 0:e.readyState)&&void 0!==e?e:null})}get readyState(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.readyState)&&void 0!==e?e:0}get readyState$(){return this.selectActive(({readyState:e})=>null!=e?e:0)}get mediaSourceEntity$(){return this.selectActive(({mediaSourceEntity:e})=>e)}get expectedSbCount$(){return this.selectActive(({expectedSbCount:e})=>e)}get expectedSbCount(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.expectedSbCount}get paused$(){return this.selectActive(({paused:e})=>e)}get paused(){var e;return null===(e=null===(e=this.getActive())||void 0===e?void 0:e.paused)||void 0===e||e}get flushing$(){return this.selectActive(({flushing:e})=>e)}get flushing(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.flushing)&&void 0!==e&&e}get waitingForDisco$(){return this.selectActive(({waitingForDisco:e})=>e)}get waitingForDisco(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.waitingForDisco)&&void 0!==e&&e}get gotPlaying(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.gotPlaying)&&void 0!==e&&e}get gotPlaying$(){return this.selectActive(({gotPlaying:e})=>e).pipe(Ra())}get gotLoadStart$(){return this.selectActive(({gotLoadStart:e})=>e)}get seekTo(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.seekTo}get seekTo$(){return this.selectActive(({seekTo:e})=>e)}get seeking(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.seeking)&&void 0!==e&&e}get seeking$(){return this.selectActive(({seeking:e})=>e)}get nudgeTarget$(){return this.selectActive(({nudgeInfo:e})=>null==e?void 0:e.nudgeTarget)}get nudgeCount(){var e;return null!==(e=null===(e=null===(e=this.getActive())||void 0===e?void 0:e.nudgeInfo)||void 0===e?void 0:e.nudgeCount)&&void 0!==e?e:0}get inFlightRange(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.inFlightRanges}get inFlightRanges$(){return this.selectActive(({inFlightRanges:e})=>e)}get sourceBufferEntities$(){return this.selectActive(({mediaSourceEntity:e})=>null==e?void 0:e.sourceBufferEntities)}sourceBufferEntityByType$(t){return this.selectActive(({mediaSourceEntity:e})=>{return null===(e=null==e?void 0:e.sourceBufferEntities)||void 0===e?void 0:e[t]})}bufferedSegmentsByType$(t){return this.selectActive(({mediaSourceEntity:e})=>{return null!==(e=null===(e=null===(e=null==e?void 0:e.sourceBufferEntities)||void 0===e?void 0:e[t])||void 0===e?void 0:e.bufferedSegments)&&void 0!==e?e:[]})}getBufferedSegmentsByType(e){return null!==(e=null===(e=this.sourceBufferEntityByType(e))||void 0===e?void 0:e.bufferedSegments)&&void 0!==e?e:[]}get bufferedSegmentsTuple$(){return rd([this.bufferedSegmentsByType$(Iu.Variant),this.bufferedSegmentsByType$(Iu.AltAudio)]).pipe(Yn(10))}get timeupdate$(){return Ac(this.mediaElement).event("timeupdate").pipe(Ra(),oo(125,void 0,{leading:!0,trailing:!0}),pr(e=>this.currentTime),cn(e=>Z(e)))}get playingEvent$(){return Ac(this.mediaElement).event("playing").pipe(pr(()=>{}))}get mediaElementEntity$(){return this.selectActive(e=>Boolean(e))}get ended$(){return this.selectActive(e=>{return null!==(e=null==e?void 0:e.ended)&&void 0!==e&&e})}sbUpdating$(t){return this.selectActive(e=>{return null!==(e=null===(e=null===(e=null===(e=null==e?void 0:e.mediaSourceEntity)||void 0===e?void 0:e.sourceBufferEntities)||void 0===e?void 0:e[t])||void 0===e?void 0:e.updating)&&void 0!==e&&e})}sbUpdating(e){var t;return null!==(e=null===(e=null===(t=null===(t=null===(t=this.getActive())||void 0===t?void 0:t.mediaSourceEntity)||void 0===t?void 0:t.sourceBufferEntities)||void 0===t?void 0:t[e])||void 0===e?void 0:e.updating)&&void 0!==e&&e}sbError$(t){return this.selectActive(e=>{return null===(e=null===(e=null===(e=null==e?void 0:e.mediaSourceEntity)||void 0===e?void 0:e.sourceBufferEntities)||void 0===e?void 0:e[t])||void 0===e?void 0:e.error})}get updating$(){return rd([this.sbUpdating$(Iu.Variant),this.sbUpdating$(Iu.AltAudio)]).pipe(pr(e=>e.some(e=>e)))}get bufferedRangeTuple$(){return rd([this.selectActive(e=>{return null!==(e=null===(e=null===(e=null===(e=null==e?void 0:e.mediaSourceEntity)||void 0===e?void 0:e.sourceBufferEntities)||void 0===e?void 0:e[Tu.Variant])||void 0===e?void 0:e.bufferedRanges)&&void 0!==e?e:null}),this.selectActive(e=>{return null!==(e=null===(e=null===(e=null===(e=null==e?void 0:e.mediaSourceEntity)||void 0===e?void 0:e.sourceBufferEntities)||void 0===e?void 0:e[Tu.AltAudio])||void 0===e?void 0:e.bufferedRanges)&&void 0!==e?e:null})])}getBufferedRangeByType(e){return null!==(e=null===(e=this.sourceBufferEntities[e])||void 0===e?void 0:e.bufferedRanges)&&void 0!==e?e:[]}get combinedBuffer$(){return this.selectActive(e=>{return null!==(e=null==e?void 0:e.bufferedRanges)&&void 0!==e?e:[]})}get desiredPos(){var e;return ee(null===(e=this.seekTo)||void 0===e?void 0:e.pos,this.currentTime)}mediaBufferInfo$(i){return Pr([this.seekTo$.pipe(bs((e,t)=>Math.abs((null==e?void 0:e.pos)-(null==t?void 0:t.pos))<Number.EPSILON)),this.combinedBuffer$.pipe(If(),To(this.bufferedSegmentsByType$(Iu.Variant)),La(([,e])=>Ah(this.updating$,e=>!e).pipe(Ys(e))))]).pipe(pr(([e,t])=>{e=ee(null==e?void 0:e.pos,this.currentTime);return this.getMediaBufferInfo(e,t,i)}))}getMediaBufferInfo(t,e,i){var r=e.find(e=>e.startPTS<=t&&e.endPTS>t),e=this.getBufferInfo(t,i),i=this.getCombinedBufferInfo(t,i);return{pos:t,sbTuple:e,combined:i,playingFrag:null!==(r=null==r?void 0:r.frag)&&void 0!==r?r:null}}getBufferInfo(n,s){var e;const t=null===(e=this.sourceBufferEntities)||void 0===e?void 0:e.map(e=>null==e?void 0:e.bufferedRanges),i={buffered:{start:n,end:n,len:0},bufferedSegments:[]},a=[i,i];return t&&t.forEach((e,t)=>{if(e){const i=gf.getBufferedInfo(e,n,s),r=(null!==(e=this.sourceBufferEntities[t].bufferedSegments)&&void 0!==e?e:[]).filter(e=>!(e.endPTS<i.start||e.startPTS>i.end));a[t]={buffered:i,bufferedSegments:r}}}),a}getCombinedBufferInfo(e,t){var i=this.getActive();return i?gf.getBufferedInfo(i.bufferedRanges,e,t):null}getContentGapRanges(){var e=this.getActive();return e?e.contentGapRanges:[]}avoidContentGap(t,i,e){let r=t;var n=this.getActive();if(n)for(let e=0;e<n.contentGapRanges.length;e++){var s=n.contentGapRanges[e];if(t>s.start-i&&t<s.end){r=s.end;break}}return r}get bufferMonitorInfo(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.bufferMonitorInfo)&&void 0!==e?e:null}get bufferMonitorThresholds$(){return this.selectActive(e=>{var t=null==e?void 0:e.bufferMonitorInfo;if(!t)return null;var{almostDryWaterLevelSeconds:i,lowWaterLevelSeconds:r,highWaterLevelSeconds:e,maxBufferSeconds:t}=t;return{almostDryWaterLevelSeconds:i,lowWaterLevelSeconds:r,highWaterLevelSeconds:e,maxBufferSeconds:t}}).pipe(bs((e,t)=>(null==e?void 0:e.lowWaterLevelSeconds)===(null==t?void 0:t.lowWaterLevelSeconds)))}get waterLevelType$(){return this.selectActive(e=>{return null!==(e=null==e?void 0:e.bufferMonitorInfo.waterLevelType)&&void 0!==e?e:null})}waterLevelForType(e){var t;return null!==(e=null===(t=null===(t=this.getActive())||void 0===t?void 0:t.bufferMonitorInfo.waterLevelType)||void 0===t?void 0:t.sbTuple[e])&&void 0!==e?e:null}waterLevelChangedForType$(t){return this.waterLevelType$.pipe(pr(e=>null==e?null:null==t?e.combined:e.sbTuple[t]))}get fellBelowLowWater$(){return this.waterLevelChangedForType$(Iu.Variant).pipe(da(),pr(([e,t])=>function(e,t){return Pf[e]>Pf[t]}(e,t)&&(t===nf.LowWater||t===nf.AlmostDry)),To(this.seekTo$,this.waitingForDisco$),pr(([e,t,i])=>e&&!Z(null==t?void 0:t.pos)&&!i),_a(!1))}isBufferedToEnd$(r,t=!0){return rd([this.combinedBuffer$,this.selectActive(e=>e.bufferMonitorInfo).pipe(If(),pr(e=>t?e.almostDryWaterLevelSeconds:Math.max(e.almostDryWaterLevelSeconds,e.lowWaterLevelSeconds/2))),this.seeking$]).pipe(pr(([e,t])=>{var i=this.minSBDuration;if(!e||!Z(i))return!1;e=gf.getBufferedInfo(e,this.currentTime,r).end;return Math.abs(i-e)<=t}),bs())}needData$(e,a=!1){var t=!a;return rd([this.msReadyState$,this.waterLevelChangedForType$(null),this.isBufferedToEnd$(e,t),this.bufferedRangeTuple$,this.seekTo$,this.desiredRate$]).pipe(Hi(ir),pr(([e,t,i,,r,n])=>{if("closed"===e)return!1;if(a)return!0;var s=this.haveEnough,e=0===n,r=Rf(n)||!!r;return null==t||!i&&t!==nf.AboveHighWater&&(!e||!s)||t!==nf.AboveHighWater&&r}),Jc("needData"))}getSourceBufferInfoAction(e,t,i,r){var{currentTime:n,sourceBufferEntities:s,msReadyState:a}=this;let o=[null,null];return!e&&i.every(e=>!(null!=e&&e.userInitiated))?null:"open"===a&&s&&null!=s[0]?(o=this.getBufferInfo(n,r),{position:n,discoSeqNum:null==t?void 0:t.discoSeqNum,bufferInfoTuple:o,switchContexts:i}):{position:null==t?void 0:t.pos,discoSeqNum:null==t?void 0:t.discoSeqNum,bufferInfoTuple:o,switchContexts:i}}get haveEnough(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.haveEnough)&&void 0!==e&&e}get haveEnough$(){return this.selectActive(({haveEnough:e})=>e)}withinFragDurationOfContentGap(t,i=10){var r=this.getContentGapRanges();for(let e=0;e<r.length;e++)if(t>r[e].start-i&&t<r[e].start)return!0;return!1}static likelyToKeepUp(e,t,i){return t&&i>=e.HAVE_FUTURE_DATA}get playbackLikelyToKeepUp(){return Nf.likelyToKeepUp(this.mediaElement,this.haveEnough,this.readyState)}get playbackLikelyToKeepUp$(){return rd([this.haveEnough$,this.readyState$]).pipe(pr(([e,t])=>Nf.likelyToKeepUp(this.mediaElement,e,t)))}getCurrentWaterLevel(e){var t=this.currentTime,i=null!==(i=null===(i=this.getActive())||void 0===i?void 0:i.bufferedRanges)&&void 0!==i?i:[];return gf.getBufferedInfo(i,t,e).len}getCombinedMediaSourceBufferInfo(e){var t=this.currentTime,[i,r]=null===(r=null===(i=this.getActive())||void 0===i?void 0:i.mediaSourceEntity)||void 0===r?void 0:r.sourceBufferEntities;return[gf.getBufferedInfo(null!==(i=null==i?void 0:i.bufferedRanges)&&void 0!==i?i:[],t,e),gf.getBufferedInfo(null!==(r=null==r?void 0:r.bufferedRanges)&&void 0!==r?r:[],t,e)]}getCurrentWaterLevelByType(e,t){var i=this.currentTime,e=this.sourceBufferEntityByType(e),e=null!==(e=null==e?void 0:e.bufferedRanges)&&void 0!==e?e:[];return gf.getBufferedInfo(e,i,t).len}canContinuePlaybackWithoutGap(e,t,i,r){if("LIVE"!==e.type)return!0;if(!e.ptsKnown)return!1;var n=this.currentTime,s=performance.now()+i.avgPlaylistLoadTimeMs+1e3*e.targetduration,a=e.fragments,i=a[0].start,a=a[a.length-1].start+a[a.length-1].duration,t=i+(s-t)/1e3;let o=this.getBufferInfo(n,r)[Xu(e.mediaOptionType)].buffered["end"];return o>=i-r&&o<=a&&(o=a),t<=o+r}get stallInfo$(){return this.selectActive(e=>{return null!==(e=null==e?void 0:e.stallInfo)&&void 0!==e?e:null})}get stallInfo(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.stallInfo)&&void 0!==e?e:null}get textTracks(){return this.mediaElement.textTracks}get textTracksCreated$(){return this.selectActive(e=>null==e?void 0:e.textTracksCreated)}get mediaOptionParsedSubtitleRecord(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.mediaOptionParsedSubtitleRecord}getParsedSubtitleRecordsForMediaOption(e){return this.mediaOptionParsedSubtitleRecord?this.mediaOptionParsedSubtitleRecord[e]||{}:null}}function Ff(e,t){let i=gf.timeRangesToBufferedRange(t);if(e){const t=[];for(const r of i)r.end<e.start||r.start>e.edge||t.push({start:Math.max(e.start,r.start),end:Math.min(e.edge,r.end)});i=t}return i}class Bf{constructor(e,t,i,r){this.mediaSink=e,this.media=t,this.logger=r,this.useCustomMediaFunctions=i.useCustomMediaFunctions,this.overridePlaybackRate=i.overridePlaybackRate}install(){const e=this.media;e&&(this.useCustomMediaFunctions&&e&&e.play&&e.pause&&(e.originalPlay||(e.originalPlay=e.play.bind(e)),e.originalPause||(e.originalPause=e.pause.bind(e)),e.play=()=>(this.mediaSink.checkForReplay(),this.mediaSink.desiredRate=1,0<e.currentTime&&!e.paused&&!e.ended&&2<e.readyState?Promise.resolve():new Promise((e,t)=>{this.pendingPlayPromises||(this.pendingPlayPromises=[]),this.pendingPlayPromises.push({resolve:e,reject:t})})),e.pause=()=>{this.mediaSink.desiredRate=0}),"function"==typeof HTMLMediaElement&&this.overridePlaybackRate&&Object.defineProperty(e,"playbackRate",{enumerable:!0,configurable:!0,get:function(){return 1},set:function(e){Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype,"playbackRate").set.call(this,e)}}),this.playPromise=null,this.expectPauseEvent=this.expectPlayEvent=!1)}uninstall(){const e=this.media;e&&(e.originalPlay&&(e.play=e.originalPlay,delete e.originalPlay),e.originalPause&&(e.pause=e.originalPause,delete e.originalPause),this.overridePlaybackRate&&(e.playbackRate=1,delete e.playbackRate)),this.playPromise=null,this.expectPauseEvent=this.expectPlayEvent=!1}play(){var e;this.media&&(e=this.mediaSink.flushing,this.playPromise||e?this.logger.warn(`Ignoring play command playPromise/flushing ${Boolean(this.playPromise)}/${e}`):(this.expectPlayEvent=this.expectPlayEvent||this.media.paused,this.playPromise=this._mediaPlayInternal(),this.playPromise&&this.playPromise.then(function(){this.playPromise=null,this._handlePendingPlayPromises(null)}.bind(this)).catch(function(e){this.playPromise=null,this.expectPlayEvent=!1,this._handlePendingPlayPromises(e||new Error("Play rejected for unknown reason")),"NotAllowedError"===(null==e?void 0:e.name)?(this.logger.warn("play() not allowed, going back to rate 0"),this.mediaSink.desiredRate=0):this.logger.error(`play() error: ${null==e?void 0:e.message}`)}.bind(this))))}pause(){this.media&&(this.playPromise?this.playPromise.then(()=>{var e=this.mediaSink.mediaQuery;(0===this.mediaSink.desiredRate||e.seeking&&!e.playbackLikelyToKeepUp)&&this._mediaPauseInternal()}).catch(e=>{this.logger.error(`Promise error in pause(): ${e.message}`)}):this._mediaPauseInternal())}_handlePendingPlayPromises(t){var e,i=null===(e=this.pendingPlayPromises)||void 0===e?void 0:e.length;if(t)for(let e=0;e<i;e++)this.pendingPlayPromises[e].reject(t);else for(let e=0;e<i;e++)this.pendingPlayPromises[e].resolve();this.pendingPlayPromises=[]}_mediaPlayInternal(){return(this.media.originalPlay||this.media.play.bind(this.media))()}_mediaPauseInternal(){return this.expectPauseEvent=this.expectPauseEvent||!this.media.paused,(this.media.originalPause||this.media.pause.bind(this.media))()}}class Uf extends Error{}class $f extends g{constructor(e,t,i,r,n){super(M.MEDIA_ERROR,e,t,i,r),this.sbType=n,this.response=r}}class Vf extends $f{constructor(e,t,i,r){super(P.BUFFER_ADD_CODEC_ERROR,!1,e,t,i),this.mediaOptionId=r,this.mediaOptionType=Ju(this.sbType)}}class Kf extends $f{constructor(e,t,i,r,n,s){super(e,t,i,r,n),this.isTimeout=s,this.mediaOptionType=Ju(this.sbType)}}class Qf extends Kf{constructor(e,t,i,r){super(P.BUFFER_FULL_ERROR,!1,e,t,i,!1),this.maxTotalBytes=r}}class qf extends Kf{constructor(e,t,i){super(P.BUFFER_APPEND_ERROR,!1,e,t,i,!0)}}class jf extends Kf{constructor(e,t,i,r){super(P.BUFFER_APPEND_ERROR,!1,e,t,i,!1),this.mediaOptionId=r,this.mediaOptionType=Ju(this.sbType)}}class Hf extends g{constructor(e,t,i,r,n,s,a=NaN){super(M.MEDIA_ERROR,e,t,i,r),this.stallType=n,this.bufferLen=s,this.nudgePosition=a,this.response=r}}class Gf extends Kt{constructor(n,e,s,a,o,l,d,u,t){super(e=>{const t=Ac(l),i=this.logger=u.child({sb:o});n.setSourceBufferEntity(o,d),d.mimeType.includes("audio/mpeg")&&(this.updateMp3Timestamps=!0);const r=dn(t.event("updatestart").pipe(eo(()=>{n.setSourceBufferUpdating(o)})),t.event("updateend").pipe(Hi(ir),eo(()=>{var e=gf.timeRangesToBufferedRange(l.buffered),t=gf.timeRangesToBufferedRange(s.buffered);this.updateEndFn&&(this.updateEndFn(),this.updateEndFn=null),n.setBufferedRangesUpdated(o,e,t,!1)})),t.event("error").pipe(eo(()=>{this.updateEndFn=null,n.setSourceBufferError(o,"Got source buffer error")})),t.event("abort").pipe(eo(()=>{this.updateEndFn=null}))).pipe(La(()=>wi)).subscribe(e);return()=>{r.unsubscribe();try{"open"===a.readyState&&l.abort(),this.updateEndFn=null,a.removeSourceBuffer(l)}catch(e){i.error(`Error aborting SourceBuffer on unsubscribe: ${e.message}`)}}}),this.mediaElementStore=n,this.mediaElementQuery=e,this.mediaElement=s,this.type=o,this.sourceBuffer=l,this.config=t,this.updateMp3Timestamps=!1}get buffered(){return this.sourceBuffer.buffered}appendBuffer(e,t,i){return en(()=>this.sourceBuffer.updating?this._waitForUpdateEndOrError().pipe(La(()=>this.appendBuffer(e,t,i))):this._appendBufferAsync(e,t,i))}updateInitSegmentInfo(e){e=bf(e);this.mediaElementStore.setInitSegmentEntity(this.type,e)}_appendBufferAsync(e,t,i){let r=NaN,n=null;const s=("startPTS"in t?t.frag:t).mediaOptionId;try{"startPTS"in t&&(n={startPTS:t.startPTS,endPTS:t.endPTS,bytes:t.bytes,frag:Object.assign({},t.frag)}),this.mediaElementStore.setInflightSegment(this.type,n),"initParsedData"in t&&(this.updateEndFn&&this.logger.warn(`[sb${this.type}] stale updateEndFn exist !`),this.updateEndFn=this.updateInitSegmentInfo.bind(this,t)),r=performance.now(),Z(i)&&this.sourceBuffer.timestampOffset!==i&&(this.sourceBuffer.timestampOffset=i),this.sourceBuffer.appendBuffer(e)}catch(e){return 22!==(this.updateEndFn=null,e.code)?(this.mediaElementStore.setInflightSegment(this.type,null),this.mediaElement.error?Ki(new jf(e.message,K.VideoDecoderBadDataErr,this.type,s)):Ki(e)):(this.mediaElementStore.setBufferedRangesUpdated(this.type,gf.timeRangesToBufferedRange(this.sourceBuffer.buffered),gf.timeRangesToBufferedRange(this.mediaElement.buffered),!0),Ki(new Qf(e.message,K.AllocationFailed,this.type,this.maxTotalBytes)))}return this._waitForUpdateEndOrError().pipe(pr(()=>({startAppend:r,endAppend:performance.now(),bytesAppend:e.byteLength})),bo(1e4),Qn(e=>{throw e instanceof ur?(this.sourceBuffer.abort(),e=new qf("Append took longer than 10000ms",K.InternalError,this.type)):e instanceof $f&&(e=new jf("Decode error",K.VideoDecoderBadDataErr,this.type,s)),e}))}remove(e,t){return this._waitForUpdateEndOrError().pipe(La(this._removeAsync.bind(this,e,t)))}_removeAsync(e,t){try{this.sourceBuffer.remove(e,t)}catch(e){return Ki(new $f(P.INTERNAL_EXCEPTION,!1,e.message,K.InternalError,this.type))}return this._waitForUpdateEndOrError()}abort(){try{this.sourceBuffer.abort()}catch(e){return Ki(new $f(P.INTERNAL_EXCEPTION,!1,e.message,K.InternalError,this.type))}return this._waitForUpdateEndOrError()}get updating(){return this.sourceBuffer.updating}get timestampOffset(){return this.sourceBuffer.timestampOffset}set timestampOffset(e){this.sourceBuffer.timestampOffset=e}get gotQuotaExceeded(){var e;return null!==(e=null===(e=this.mediaElementQuery.sourceBufferEntityByType(this.type))||void 0===e?void 0:e.gotQuotaExceeded)&&void 0!==e&&e}get bufferedSegments(){var e;return null!==(e=null===(e=this.mediaElementQuery.sourceBufferEntityByType(this.type))||void 0===e?void 0:e.bufferedSegments)&&void 0!==e?e:[]}get totalBytes(){var e;return null!==(e=null===(e=this.mediaElementQuery.sourceBufferEntityByType(this.type))||void 0===e?void 0:e.totalBytes)&&void 0!==e?e:0}get maxTotalBytes(){var e=null!==(e=null===(e=this.mediaElementQuery.sourceBufferEntityByType(this.type))||void 0===e?void 0:e.maxTotalBytes)&&void 0!==e?e:1/0;return this.gotQuotaExceeded?e:1/0}_waitForUpdateEndOrError(){return this.sourceBuffer.updating&&this.mediaElementStore.setSourceBufferUpdating(this.type),this.mediaElementQuery.sbUpdating$(this.type).pipe(cn(e=>!1===e),To(this.mediaElementQuery.sbError$(this.type)),pr(([,e])=>{if(e)throw new $f(P.INTERNAL_EXCEPTION,!1,"Got error during sourceBuffer operation",K.InternalError,this.type)}),As(1))}changeType(e){var t;let i=!1;if(this.config.changeType&&"function"==typeof this.sourceBuffer.changeType)try{this.sourceBuffer.changeType(e),i=!0}catch(i){null===(t=this.logger)||void 0===t||t.error(`changeType(${e}) failed: ${i.msg}`)}return i}}class Wf extends Kt{constructor(a,o,e,l,t){super(e=>{const t=Ac(l),i=dn(t.event("sourceopen"),t.event("sourceclose"),t.event("sourceended")).pipe(eo(e=>{e=(null!==(e=null==e?void 0:e.target)&&void 0!==e?e:l).readyState;o.msReadyState=e})),r=this.sourceBuffers$.pipe(La(e=>e?dn(...e.filter(e=>null!=e)):wi)),n=dn(i,r).pipe(La(()=>wi)).subscribe(e),s=URL.createObjectURL(l);return a.src=s,o.setMediaSourceEntity(s,l.readyState),()=>{n.unsubscribe(),URL.revokeObjectURL(s),a.src===s&&(a.removeAttribute("src"),a.load(),o.setMediaSourceEntity(null)),this.sourceBuffers$.next(null)}}),this.mediaElement=a,this.mediaElementStore=o,this.mediaElementQuery=e,this.mediaSource=l,this.logger=t,this.sourceBuffers$=new Si(null)}get readyState(){return this.mediaSource.readyState}set duration(e){this.mediaSource.duration=e}get duration(){return this.mediaSource.duration}endOfStream(e){this.mediaSource.endOfStream(e)}createSourceBuffers(e,a){const o=this.mediaSource;ol(()=>{try{const s=[null,null];e.forEach((t,i)=>{if(t){var{mimeType:r,mediaOptionId:n}=t;let e;try{e=o.addSourceBuffer(r)}catch(t){throw new Vf(t.message,K.IncompatibleAsset,i,n)}s[i]=new Gf(this.mediaElementStore,this.mediaElementQuery,this.mediaElement,this.mediaSource,i,e,t,this.logger,a)}}),this.sourceBuffers$.next(s)}catch(e){if(!(e instanceof g))throw new Uf(`error initializing sourcebuffers ${e.message} readyState=${o.readyState}`);throw e}})}get needSourceBuffers(){return null==this.sourceBuffers$.value||null==this.sourceBuffers$.value[0]}get sourceBuffers(){return this.sourceBuffers$.value}getSourceBufferByType(e){var t=this.sourceBuffers$.value;return t?t[e]:null}updateLiveSeekableRange(e,t){const i=this.mediaSource;null!=i&&i.setLiveSeekableRange&&"open"===(null==i?void 0:i.readyState)&&i.setLiveSeekableRange(e,t)}clearLiveSeekableRange(){const e=this.mediaSource;null!=e&&e.clearLiveSeekableRange&&"open"===(null==e?void 0:e.readyState)&&e.clearLiveSeekableRange()}}function zf(e,t,i,r,n,s){var a=performance.now()-i;return{type:e,isLowBufferStall:r.len<=n||!s,tstalled:i,stallDurationMs:a,currentTime:t}}class Yf extends Kt{constructor(C,M,e,t,i,r,n){super(e=>{const t=this.config,i=M.startMediaSession(C,t.maxBufferLength,t.almostDryBufferSec,t.defaultTargetDuration),r=Xf(C,M,this._mediaQuery,this,this.hlsGapless,t,this.logger,this.rtcService),n=this.mediaSource$.pipe(La(e=>e||wi)),s=this.flushAndCallback$.pipe(cn(e=>!!e),La(({start:e,end:t,cb:i})=>this.flushAll(e,t).pipe(eo(()=>i())))),a=this._mediaQuery.seekTo$.pipe((c=C,h=this._mediaQuery,f=(p=this).config,m=(m=this.logger).child({name:"seek"}),e=>e.pipe(eo(e=>{}),cn(e=>e&&Z(e.pos)),La(e=>h.readyState$.pipe(cn(e=>e>=c.HAVE_METADATA),As(1),Ys(e),La(({pos:e,fromEvent:t})=>(p.checkForInconsistentStoreBufferRangesAndUpdate(),c.paused||p.pause(),t||(c.currentTime=e),Ah(h.haveEnough$,e=>e).pipe(Ys({pos:e,fromEvent:t})))),La(({pos:e,fromEvent:t})=>{var i=h.getCombinedBufferInfo(e,0),r=i.nextStart;return(!t||f.nudgeFromEventSeek)&&0===i.len&&Z(r)&&e<r&&r-e<=f.maxSeekHole?(p.seekTo=r,wi):Vi(e)}),To(h.desiredRate$),pr(([,e])=>{c.paused&&0!==e&&p.play()}),Va(wi),Qn(e=>(m.error(`error during seek ${e.message}`),wi))))))),o=this._mediaQuery.desiredRate$.pipe((l=C,d=this._mediaQuery,u=this,e=>e.pipe(To(d.seekTo$),La(([e,t])=>Z(null==t?void 0:t.pos)?wi:(0!==e||l.paused||u.pause(),1!==e?wi:Ah(d.haveEnough$,e=>e).pipe(eo(()=>{l.paused&&u.play()})))),Va(wi))));var l,d,u,c,h,p,f,m,g,y,v,S,b,T,I,E,w;this.mediaFunctions=this.mediaFunctions||new Bf(this,C,t,this.logger),this.mediaFunctions.install();const O=dn(function(c,e){const{lowBufferThreshold:h,lowBufferWatchdogPeriod:p,highBufferWatchdogPeriod:f,seekWatchdogPeriod:m}=e,t=rd([c.desiredRate$,c.ended$,c.combinedBuffer$,c.seekTo$,c.inFlightRanges$]).pipe(pr(e=>{var t,[i,r,n,s,a]=e;return t=c.currentTime,e=i,i=r,r=n,n=isFinite(null==s?void 0:s.pos),s=a,a=r.some(e=>e.start<=t&&e.end>t),s=s&&s.some(e=>e&&e.start<=t&&t<=e.end),!(!a&&s||1!==e||i||0===r.length||n&&!a)}),bs()),i=c.combinedBuffer$.pipe(pr(()=>c.getCurrentWaterLevel(0)<=e.lowBufferThreshold||!c.haveEnough?rf.LowBuffer:rf.HighBuffer),bs()),r=rd([t,c.seekTo$,c.gotPlaying$,i]).pipe(La(e=>{var[t,i,r]=e;if(!t)return Vi(null);var s,a,o,l,n,d,u,e=c.nudgeCount,t=m+ +e;return isFinite(null==i?void 0:i.pos)||!r?(n=c,d=performance.now(),t=t,u=h,En(1e3*t).pipe(pr(()=>{var e=n.currentTime,t=n.getCombinedBufferInfo(e,0);if(null===n.stallInfo||n.stallInfo.type===rf.Seek)return zf(rf.Seek,e,d,t,u,n.haveEnough)}),If())):(s=c,a=p,o=f+ +e,l=h,dn(Vi(s.currentTime),s.timeupdate$).pipe(La(e=>{const t=performance.now(),i=s.getCombinedBufferInfo(e,0);let r,n;return r=i.len<=l||!s.haveEnough?(n=a,rf.LowBuffer):(n=o,rf.HighBuffer),En(Math.max(100,1e3*n)).pipe(pr(()=>e<s.currentTime?null:zf(r,e,t,i,l,s.haveEnough)))})))})),n=r.pipe(If(),To(c.combinedBuffer$),La(([])=>rd([c.seeking$,c.paused$])),La(([e,t])=>e||t?wi:c.timeupdate$.pipe(da(),cn(([e,t])=>Z(e)&&Z(t)&&e<t),As(1))),pr(()=>null));return dn(r,n)}((this.logger,this._mediaQuery),this.config).pipe(eo(e=>{M.setStallInfo(e)})),this.mediaQuery.stallInfo$.pipe((S=M,b=(v=this).config,T=this.logger,e=>e.pipe(xs(e=>e?function(i,e,r,n){const s=i.mediaQuery;return dn(rd([s.seekTo$,s.nudgeTarget$]).pipe(cn(([e,t])=>e&&Z(e.pos)&&Z(t)&&(e.pos<t||e.pos-t>r.maxSeekHole)),Ys(null)),s.stallInfo$).pipe(To(s.desiredRate$),Hi(ir),pr(([c,e],t)=>{if(!c)return NaN;var h=s.getCombinedBufferInfo(c.currentTime,0),e=Rf(e);return function(e,t,i,r,n){var{type:s,isLowBufferStall:a,currentTime:o}=c,l=h.len,d=t.maxSeekHole;let u=NaN;if(a){const i=h.nextStart-o<=d?h.nextStart:1/0;Z(i)?u=i:e.mediaQuery.msDuration-o<t.nudgeOffset&&(u=o+t.nudgeOffset)}else if(n<t.nudgeMaxRetry)u=o+t.nudgeOffset;else{if(!r)throw i.error(`still stuck in high buffer @${o} after ${t.nudgeMaxRetry}, raise fatal error`),new Hf(P.BUFFER_STALLED_ERROR,!0,"got fatal buffer error",K.VideoDecoderBadDataErr,s,l);i.error(`still stuck in high buffer @${o} after ${t.nudgeMaxRetry}, non fatal in iframeMode`)}return Z(u)&&e.nudgeSeek(u,n+1),u}(i,r,n,e,t)}),Wa(e=>Z(e)),Bs(()=>{e.setNudgeInfo(null)}))}(v,S,b,T):Vi(NaN)))))),A=(I=this.mediaQuery,E=M,dn((g=I,y=w=t.maxBufferHole,rd([g.bufferMonitorThresholds$,g.combinedBuffer$,g.seeking$]).pipe(pr(([e])=>null==e?null:_f(g,y)))),Lf(I,w)).pipe(Hi(ir),eo(({combined:e,sbTuple:t})=>{E.updateWaterLevels(e,t)}))),R=t["contentGapPlaythroughIntervalSeconds"],k=1e3*R;dn(r,n,a,o,O,A,s,rd([this.mediaQuery.timeupdate$,this.mediaQuery.desiredRate$]).pipe(eo(([])=>{}),La(([e,t])=>{return 0!==t&&e!==this.mediaQuery.avoidContentGap(e,this.config.timeAccuracyThresholdSeconds,this.logger)?(i=k,void 0===r&&(r=rr),(!on(i=void 0===i?0:i)||i<0)&&(i=0),r&&"function"==typeof r.schedule||(r=rr),new Kt(function(e){return e.add(r.schedule(ln,i,{subscriber:e,counter:0,period:i})),e}).pipe(eo(()=>{var e=this.mediaQuery.currentTime,t=e+R;this.logger.warn(`In GAP move to ${e}->${t}`),this.seekTo=t}))):wi;var i,r}))).pipe(Va(wi),Bs(()=>{this.toggleTrickPlaybackMode(!1),M.remove(i),this.mediaFunctions.uninstall(),this.mediaFunctions=void 0})).subscribe(e)}),this.mediaElement=C,this.mediaElementStore=M,this.config=e,this.hlsGapless=t,this.logger=i,this.teardownWG$=r,this.rtcService=n,this.flushAndCallback$=new Jt,this.mediaSource$=new Si(null),this.mediaKeysMutex=new Cf,this._mediaQuery=new Nf(C,M),this.logger=i.child({name:"mse"}),this.createId3Track(C),this.mediaFunctions=new Bf(this,C,e,this.logger)}get mediaSourceAdapter(){return this.mediaSource$.value}get sourceBuffers(){var e;return null!==(e=null===(e=this.mediaSourceAdapter)||void 0===e?void 0:e.sourceBuffers)&&void 0!==e?e:[]}get needSourceBuffers(){return!this.sourceBuffers[0]}get mediaQuery(){return this._mediaQuery}sourceBuffersBufferedRangeByType(e){var t,e=null===(t=null===(t=this.mediaSourceAdapter)||void 0===t?void 0:t.sourceBuffers)||void 0===t?void 0:t[e];return e?gf.timeRangesToBufferedRange(e.sourceBuffer.buffered):null}createId3Track(e){this.id3Track=e.addTextTrack("metadata","id3"),this.id3Track.mode="hidden"}checkForInconsistentStoreBufferRangesAndUpdate(){var e=gf.timeRangesToBufferedRange(this.mediaElement.buffered),t=this.sourceBuffersBufferedRangeByType(Iu.Variant),i=this.sourceBuffersBufferedRangeByType(Iu.AltAudio),r=null!==(n=null===(r=this.mediaQuery.sourceBufferEntityByType(Iu.Variant))||void 0===r?void 0:r.bufferedRanges)&&void 0!==n?n:null,n=null!==(n=null===(n=this.mediaQuery.sourceBufferEntityByType(Iu.AltAudio))||void 0===n?void 0:n.bufferedRanges)&&void 0!==n?n:null;this.shouldUpdateStoreValues(t,r)&&(this.logger.warn(`[${Yu[Iu.Variant]}] SourceBuffer's loaded bufferedRanges ${JSON.stringify(t)} & mediaElementStore's bufferedRanges ${JSON.stringify(r)} are out of sync!`),this.updateMediaElementStoreBufferedRanges(e,Iu.Variant)),this.shouldUpdateStoreValues(i,n)&&(this.logger.warn(`[${Yu[Iu.AltAudio]}] SourceBuffer's loaded bufferedRanges ${JSON.stringify(i)} & mediaElementStore's bufferedRanges ${JSON.stringify(n)} are out of sync!`),this.updateMediaElementStoreBufferedRanges(e,Iu.AltAudio))}updateInFlightRange(r,n){this.mediaElementStore.updateActive(e=>{var t;const i=null!==(t=e.inFlightRanges)&&void 0!==t?t:[null,null];i[r]=n,e.inFlightRanges=i})}shouldUpdateStoreValues(e,i){return!(null==e&&null==i||(null==e?void 0:e.length)==(null==i?void 0:i.length)&&!e.find(t=>{var e=Zu.search(i,e=>t.start>=e.start&&t.end<=e.end?0:t.end<e.start?-1:1);return null==e||e.start!=t.start||e.end!=t.end||void 0}))}updateMediaElementStoreBufferedRanges(e,t){var i=this.sourceBuffersBufferedRangeByType(t);i&&!this.mediaQuery.sbUpdating(t)&&this.mediaElementStore.setBufferedRangesUpdated(t,i,e,!1)}destroyMediaSource(){this.mediaSource$.next(null)}makeMediaSource(){return new MediaSource}openMediaSource(t){ol(()=>{var e;t?(e=new Wf(this.mediaElement,this.mediaElementStore,this.mediaQuery,t,this.logger),this.mediaSource$.next(e)):this.mediaSource$.next(null)})}createSourceBuffers(e){const t=this.mediaSourceAdapter;if(!t)throw new Error("createSourceBuffers empty mediaSource");t.createSourceBuffers(e,this.config)}_waitForMediaSourceOpen(i){const r=this.mediaQuery.mediaSourceEntity.objectUrl;return rd([this.mediaQuery.msReadyState$,this.mediaQuery.msObjectUrl$]).pipe(La(([e,t])=>t!==r?Vi(null):"open"===e||"ended"===e?Vi(i):wi))}get appendOrder(){return this.mediaQuery.isIframeRate?[Iu.Variant,Iu.AltAudio]:[Iu.AltAudio,Iu.Variant]}clearFlush(e){e.forEach(e=>{e&&(e.dataSeg.flushBeforeAppend={start:0,end:0})})}getSwitchPosition(e){return e.reduce((e,t)=>{t=t?t.dataSeg.switchPosition:void 0;return Z(t)?Z(e)?Math.min(e,t):t:e},void 0)}checkForReplay(){var e=this.mediaElement;e.paused&&!e.seeking&&e.duration&&e.currentTime&&e.currentTime>=e.duration-this.config.maxTotalDurationTolerance&&(this.seekTo=0)}isCompatibleWithSourceBuffers(e){return Jf(e,this.mediaElementStore,this.mediaSourceAdapter,this.mediaQuery.sourceBufferEntities,this.mediaQuery.expectedSbCount,this.config.changeType?Object.assign(Object.assign({},this.config),{changeType:!1}):this.config,this.logger)}resetMediaSourceIfNeeded(r){const{mediaQuery:n,mediaElementStore:e}=this,t=n["sourceBufferEntities"],i=n.getActive()["expectedSbCount"];if(!t||this.needSourceBuffers)return this._waitForMediaSourceOpen(r);const s=Jf(r,e,this.mediaSourceAdapter,t,i,this.config,this.logger);if(s.compatible)return this._waitForMediaSourceOpen(r);let a=s.boundary;const o=s.allowance,l=this.getSwitchPosition(r);if(Z(l)&&(a=l),!Z(a))return Vi(null);const d=n.getCombinedBufferInfo(n.currentTime,this.config.maxBufferHole),u=yn(Ah(dn(Vi(n.currentTime),n.timeupdate$),e=>0===d.len||a-e<=.001),Ah(n.stallInfo$.pipe(pr(e=>{return null!==(e=null==e?void 0:e.currentTime)&&void 0!==e?e:NaN})),e=>e>=a-o-this.config.discontinuitySeekTolerance));return this.mediaElementStore.waitingForDisco=!0,u.pipe(Ys(a),La(e=>{performance.now();var t=n.currentTime,i=this.msDuration;return this.resetMediaSource(Math.max(t,e),s.discoSeqNum),this.msDuration=i,this._waitForMediaSourceOpen(r).pipe(eo(()=>{var e,t,i,r,n;performance.now(),this.liveSeekableRange&&({start:e,end:t,edge:i,boundary:r,tupdate:n}=this.liveSeekableRange,this.updateLiveSeekableRange(e,t,i,r,n))}))}),Bs(()=>{this.mediaElementStore.waitingForDisco=!1}))}resetMediaSource(e=NaN,t){var i;Z(e)||(e=null!==(i=null===(i=this.mediaQuery.seekTo)||void 0===i?void 0:i.pos)&&void 0!==i?i:this.mediaQuery.currentTime),Z(t)||(t=null===(i=this.mediaQuery.seekTo)||void 0===i?void 0:i.discoSeqNum),0<this.sourceBuffers.length&&(this.openMediaSource(this.makeMediaSource()),this.seekWithOptions(e,t,!1,!1))}setExpectedSbCount(e){this.mediaElementStore.expectedSbCount=e}appendInitSegments(o,l){const{mediaQuery:e,sourceBuffers:d}=this,u=e["sourceBufferEntities"];if(!d)throw new Error("appendInitSegments: null sourceBuffers");if(!u)throw new Error("appendInitSegments: null sourceBufferEntities");var t=this.appendOrder.map(e=>{if(o[e]){const r=d[e],n=o[e],s=u[e],a=n["initSeg"];if(!s)throw new Error(`appendInitSegments: sb[${Yu[e]}] null currentSbEntity`);if(!r)throw new Error(`appendInitSegments: sb[${Yu[e]}] null source buffer`);if(i=s.initSegmentInfo,(t=bf(a))&&i&&t.itemId===i.itemId&&t.mediaOptionId===i.mediaOptionId&&t.discoSeqNum===i.discoSeqNum&&t.keyId===i.keyId)return Vi(null);var t,i,e=Ju(e);return r.appendBuffer(a.data,a).pipe(eo(e=>{}),l(r,e,a.mediaOptionId,this.config,this.mediaQuery))}}).filter(e=>Boolean(e));return 0===t.length?Vi(null):tn(t)}appendDataSegments(y,v){var e=this.appendOrder.map(i=>{const e=y[i],{mediaQuery:r,sourceBuffers:t}=this,n=r["sourceBufferEntities"];if(!t)throw new Error("appendDataSegments: null sourceBuffers");if(!n)throw new Error("appendDataSegments: null sourceBufferEntities");if(!e)return null;const s=t[i],a=y[i],o=n[i];if(!o)throw new Error("appendDataSegments: null currentSbEntity");const l=o.initSegmentInfo,{dataSeg:d,offsetTimestamp:u}=a;if(!l)throw new Error(`appendDataSegments: sb[${Yu[i]}] null currentInitSegmentInfo`);if(!o)throw new Error(`appendDataSegments: sb[${Yu[i]}] null currentSbEntity`);if(!s)throw new Error(`appendDataSegments: sb[${Yu[i]}] null source buffer`);var c=E(d.startPts);let h=-1*E(u);s.updateMp3Timestamps&&.1<Math.abs(s.timestampOffset-c)&&(h=c+h);const p=s.timestampOffset!==h,f={startPTS:c+h,endPTS:E(d.endPts)+h,firstKeyframePts:d.firstKeyframePts?E(d.firstKeyframePts)+h:void 0,bytes:d.data2?d.data1.byteLength+d.data2.byteLength:d.data1.byteLength,frag:{itemId:d.itemId,mediaOptionId:d.mediaOptionId,mediaSeqNum:d.mediaSeqNum,discoSeqNum:d.discoSeqNum,keyTagInfo:d.keyTagInfo,isLastFragment:d.isLastFragment,iframe:d.iframe,framesWithoutIDR:d.framesWithoutIDR,dropped:d.dropped}},m=Ju(i);let g=Oh;c=e.dataSeg.flushBeforeAppend;return c&&c.start!==c.end&&(g=this.flushData(i,c.start,c.end)),g.pipe(La(()=>Vi(d.data1,d.data2).pipe(If()).pipe(zn(e=>s.appendBuffer(e,f,h).pipe(v(s,m,d.mediaOptionId,this.config,this.mediaQuery))))),eo(e=>{var t;r.getBufferedRangeByType(i),null===(t=this.rtcService)||void 0===t||t.handleVariantBufferAppended(e),p&&this.mediaElementStore.setTimestampOffset(i,s.timestampOffset)}))}).filter(e=>Boolean(e));return 0===e.length?Vi(null):tn(e)}adjustJaggedStart(e){const{mediaQuery:t,logger:n}=this,{sourceBufferEntities:i,currentTime:s,seekTo:a}=t,o=e.reduce((e,t)=>{var{start:i,end:e}=e;return{start:null!=t&&t.dataSeg.startPts?Math.min(y(t.dataSeg.startPts,t.offsetTimestamp),i):i,end:null!=t&&t.dataSeg.endPts?Math.min(y(t.dataSeg.endPts,t.offsetTimestamp),e):e}},{start:Number.POSITIVE_INFINITY,end:Number.POSITIVE_INFINITY});if(!i)throw new Error("appendSourceBufferData null currentSbEntity");const l=(null==a?void 0:a.pos)||s;if(t.avoidContentGap(l,0,n)===l){const d=Z(this.config.jaggedSeekTolerance)?this.config.jaggedSeekTolerance:0;let r=NaN;i.forEach((e,t)=>{if(e){e=gf.getBufferedInfo(e.bufferedRanges,l,0);if(0===e.len){const i=e["nextStart"];n.warn(`sb[${Yu[t]}] jagged start: ${i} appendTimes=${JSON.stringify(o)} seekToPos=${r} position=${l} tolerance=${d}`),Z(i)&&(!Z(r)||i>r)&&(r=i)}}}),Z(r)&&o.end>r&&r-l>d&&(Z(o.start)&&l+this.config.maxSeekHole<o.start||(n.warn(`[seek] jagged start, adjusting currentTime:${s.toFixed(3)} seekTo=${null===(e=null==a?void 0:a.pos)||void 0===e?void 0:e.toFixed(3)}->${r} appendTimes=${JSON.stringify(o)}`),this.seekTo=r))}}addCues(e,t){const i=this.mediaElement.textTracks[e];i&&t.forEach(e=>{i.addCue(e)})}_flushInternal(e,t,i){return en(()=>e.remove(t,i)).pipe(eo(()=>{}))}flushAll(i,r,n=!1){return 0===this.sourceBuffers.length?Oh:tn(this.sourceBuffers.map((e,t)=>e?this.flushData(t,i,r,n):Oh)).pipe(Ys(void 0))}flushAndCallback(e,t,i){this.flushAndCallback$.next({start:e,end:t,cb:i})}flushData(o,l,d,u=!1){const{mediaQuery:t,logger:c}=this;return Ah(t.updating$,e=>!1===e).pipe(La(()=>{var e=t["sourceBufferEntities"],e=e[o];null!=e&&e.updating&&this.logger.warn(`trying to flush while updating ${o}`);const r=this.sourceBuffers[o];if(!r)return Oh;let n,s,a=Oh;e=-1===navigator.userAgent.toLowerCase().indexOf("firefox");if(this.flushing=!0,e)return this._flushInternal(r,l,d);for(let i=0;i<r.buffered.length;i++){let e,t;n=r.buffered.start(i),s=r.buffered.end(i),t=d===1/0?(e=l,d):(e=Math.max(n,l),Math.min(s,d)),Math.min(t,s)>e&&(u||.5<Math.min(t,s)-e)?a=a.pipe(Va(this._flushInternal(r,e,t))):c.warn(`ignoring sb[${Yu[o]}] flush ${e},${t}`)}return a}),Bs(()=>{this.flushing=!1}))}static convertInitSegToCompatInfo(e){return{mimeType:e.mimeType,audioCodec:e.initParsedData.audioCodec,videoCodec:e.initParsedData.videoCodec,startPTSSec:void 0,endPTSSec:void 0,discoSeqNum:e.discoSeqNum,mediaOptionId:e.mediaOptionId}}static combineAppendDataInfoWithCompatInfo(e,t,i,r,n=0){const s=[...t];e.forEach((e,t)=>{null!=e&&e.initSeg&&(s[t]=Yf.convertInitSegToCompatInfo(e.initSeg)),1===r&&(s[1]=null)});e=null===(t=s[Iu.Variant])||void 0===t?void 0:t.videoCodec,t=wf(e);if(i&&i.has(t)){const a=i.get(t);s[Iu.Variant].mimeType=s[Iu.Variant].mimeType.replace(e,a),s[Iu.Variant].videoCodec=a}return s}convertSourceBufferEntitiesToCompatInfo(e){const t=e.sourceBufferEntities,i=[null,null];return t.forEach((e,t)=>{e&&(i[t]={mimeType:e.mimeType,audioCodec:e.audioCodec,videoCodec:e.videoCodec,startPTSSec:void 0,endPTSSec:void 0,discoSeqNum:void 0,mediaOptionId:null===(e=e.initSegmentInfo)||void 0===e?void 0:e.mediaOptionId})}),i}appendData(e,i,r){const{mediaQuery:t,logger:n}=this,o=t.expectedSbCount,l=this.convertSourceBufferEntitiesToCompatInfo(t);return e.every(e=>null==e)?Vi([]):this.resetMediaSourceIfNeeded(e).pipe(As(1),La(e=>e?t.updating$.pipe(cn(e=>!1===e),As(1),Ys(e)):Vi(null)),La(t=>{if(!t)return Vi([]);let s=NaN,a=NaN;if(this.needSourceBuffers){s=performance.now();const i=Yf.combineAppendDataInfoWithCompatInfo(t,l,r,o,n);this.createSourceBuffers(i),a=performance.now(),this.clearFlush(t)}return t.forEach(e=>{e=null==e?void 0:e.dataSeg;null!=e&&e.cues&&Z(null==e?void 0:e.texttrackIdx)&&this.addCues(e.texttrackIdx,e.cues)}),Zr(en(()=>this.appendInitSegments(t,i)),en(()=>this.appendDataSegments(t,i))).pipe(la((e,t)=>(e.push(t),e),new Array),pr(([i,r])=>{const n=[null,null];return[Iu.Variant,Iu.AltAudio].forEach(e=>{var t;null!=(null==i?void 0:i[e])&&(t={fragmentType:Ju(e),bufferCreationStart:s,bufferCreationEnd:a,startInitAppend:i[e].startAppend,endInitAppend:i[e].endAppend,initBytesAppend:i[e].bytesAppend,startDataAppend:r[e].startAppend,endDataAppend:r[e].endAppend,dataBytesAppend:r[e].bytesAppend},n[e]=t)}),n}),eo(e=>{this.adjustJaggedStart(t)}))}),As(1))}endStream(){try{this.mediaSourceAdapter.endOfStream()}catch(e){this.logger.warn(`endOfStream failed: ${e.message}`)}}setMediaKeys(e){return this.teardownWG$.wrap(this.mediaKeysMutex.lock(()=>Br(this.mediaElement.setMediaKeys(e))).pipe(eo(()=>{}),ba(e=>e.pipe(La((e,t)=>{if(t<3)return En(100*t);throw e})))))}clearMediaKeys(){return en(()=>{if(!this.mediaElement)return Oh;var e=this.mediaQuery.getCombinedBufferInfo(this.mediaQuery.currentTime,0);let t=Oh;return 0<(null==e?void 0:e.len)&&(t=Ah(this.mediaQuery.stallInfo$,e=>null!=e).pipe(pr(()=>null))),t.pipe(La(()=>{const e=-1<navigator.userAgent.toLowerCase().indexOf("chrome"),t=this.mediaElement.src;return e&&(this.mediaElement.src=""),this.setMediaKeys(null).pipe(eo(()=>this.mediaElement.src=t))}))})}set postFlushSeek(e){this.mediaElementStore.postFlushSeek=e}set seekTo(e){this.seekWithOptions(e,void 0,!1)}seekWithOptions(e,t,i,r=!1){const n=this.liveSeekableRange,s=this.mediaElement.currentTime,a=Z(this.mediaElement.duration)?this.mediaElement.duration:1/0;let o=0,l=a;if(i&&n){const{start:t,edge:i,end:d,tupdate:u}=n,c=(performance.now()-u)/1e3;if(o=Math.min(a,d,t+c),l=Math.min(a,d,i+c),!r&&e>=l&&s>=l)return this.logger.warn(`[seek] already at live ${s.toFixed(3)}>${i.toFixed(3)}`),!1}const d=Math.max(o,Math.min(l,e));return d!==e&&this.logger.warn(`[seek] snapping ${te({currentTime:s,seekTo:e,resolvedSeek:d,minSeekPosition:o,maxSeekPosition:l,useLiveRange:i&&n})}`),this.mediaElementStore.setSeekToPos(d,!1,t),!0}updateContentGapRanges(e,r){var n=null===(n=this.mediaQuery)||void 0===n?void 0:n.getContentGapRanges();if(n){let t=[...n];t.sort((e,t)=>t.start-e.start);let i=!0;for(let e=0;e<t.length;e++){const s=t[e];if(r.start>s.start-.25&&r.start<s.start+.25&&r.end>s.end-.25&&r.end<s.end+.25)return void(i=!1)}i&&(t.push(r),t.sort()),1<t.length&&(t=gf.getBufferedTimeRanges(t,.25)),this.mediaElementStore.updateContentGapRanges(t)}}nudgeSeek(e,t){ol(()=>{this.mediaElementStore.setSeekToPos(e),this.mediaElementStore.setNudgeInfo({nudgeTarget:e,nudgeCount:t})})}set desiredRate(e){this.mediaElementStore.desiredRate=e}toggleTrickPlaybackMode(e){if(this.config.overridePlaybackRate){const t=e?2:1;try{this.mediaElement.playbackRate=t}catch(e){this.logger.error({name:"iframes"},`Exception when setting playbackRate=${t}: ${e.message}`)}}const t=this.muteValueOnTrickPlaybackToggle;e&&void 0===t?(this.muteValueOnTrickPlaybackToggle=this.mediaElement.muted,this.mediaElement.muted=e):e||void 0===t||(this.mediaElement.muted=t,this.muteValueOnTrickPlaybackToggle=void 0)}play(){this.mediaFunctions.play()}pause(){this.mediaFunctions.pause()}get expectPlayEvent(){return this.mediaFunctions.expectPlayEvent}set expectPlayEvent(e){this.mediaFunctions.expectPlayEvent=e}get expectPauseEvent(){return this.mediaFunctions.expectPauseEvent}set expectPauseEvent(e){this.mediaFunctions.expectPauseEvent=e}get expectSeekingEvent(){return this.mediaQuery.expectSeekingEvent}set textTracksCreated(e){const t=this["mediaElementStore"];t.textTracksCreated=e}get msDuration(){return this._mediaQuery.msDuration}set msDuration(e){try{const t=this["mediaElementStore"],i=this.mediaSourceAdapter;i.duration!==e&&(i.duration=e,t.msDuration=e)}catch(e){this.logger.warn(`Error setting duration ${e.message}`)}}set primaryContentDuration(e){this.mediaElementStore.primaryContentMediaElementDuration=e}set haveEnough(e){this.mediaElementStore.haveEnough=e}set flushing(e){this.mediaElementStore.flushing=e}set bufferMonitorTargetDuration(e){this.mediaElementStore.bufferMonitorTargetDuration=e}get textTracks(){return this.mediaElement.textTracks}get id3TextTrack(){return this.id3Track}addTextTrack(e,t,i){return this.mediaElement.addTextTrack(e,t,i)}dispatchEvent(e){return this.mediaElement.dispatchEvent(e)}get offsetWidth(){return this.mediaElement.offsetWidth}get offsetHeight(){return this.mediaElement.offsetHeight}get liveSeekableRange(){return this.mediaQuery.liveSeekableRange}get seekable(){return this.mediaQuery.seekable}archiveParsedSubtitleFragmentRecord(e,t,i){return this.mediaElementStore.archiveParsedSubtitleFragmentRecord(e,t,i)}removeOldParsedSubtitleFragmentRecord(e){this.mediaElementStore.removeOldSubtitleFragmentRecord(e)}clearParsedSubtitleRecordsForMediaOption(e){return this.mediaElementStore.clearParsedSubtitleFragmentRecord(e)}updateLiveSeekableRange(e,t,i,r,n){var s;const a=this.mediaQuery.liveSeekableRange,o=Math.max(null!==(s=null==a?void 0:a.start)&&void 0!==s?s:0,e),l=Math.max(null!==(s=null==a?void 0:a.end)&&void 0!==s?s:0,t),d=Math.max(null!==(s=null==a?void 0:a.edge)&&void 0!==s?s:0,i),u=Math.max(null!==(i=null==a?void 0:a.boundary)&&void 0!==i?i:0,r);o>l&&this.logger.warn(`got invalid range ${e.toFixed(3)},${t.toFixed(3)}`),ol(()=>{this.mediaElementStore.setLiveSeekableRange({start:o,end:l,edge:d,boundary:u,tupdate:n}),this.mediaSourceAdapter.updateLiveSeekableRange(o,l)})}clearLiveSeekableRange(){null!=this.liveSeekableRange&&ol(()=>{this.mediaElementStore.setLiveSeekableRange(void 0),this.mediaSourceAdapter.clearLiveSeekableRange()})}}const Xf=(t,r,n,s,a,o,l,d)=>{if(!t)return wi;const e=Ac(t);return dn(e.event("durationchange").pipe(pr(e=>Rc(t,"durationchange",e)),eo(e=>{e=e.currentTarget;r.mediaElementDuration=e.duration})),e.event("seeking").pipe(oo(o.seekEventThrottleMs),pr(e=>Rc(t,"seeking",e)),dl(e=>{const t=e.currentTarget,i=t.currentTime;if(t.readyState>=t.HAVE_METADATA){const e=n.seekTo;if(!e||!e.fromEvent&&1e-5<Math.abs(e.pos-i))if(!a.inGaplessMode||o.enableInterstitialPlayback){if(s&&!s.expectSeekingEvent){const e=t.controls||o.nativeControlsEnabled;if(l.warn(`[seek] unexpected seek ${i.toFixed(3)} fromControls=${e}`),e&&s.liveSeekableRange&&s.seekWithOptions(i,void 0,!0,!0))return}r.setSeekToPos(i,!0)}else!function(e,t,i,r,n){let s=!1;e<t.playingItem.itemStartOffset&&(n.warn(`[Gapless] Seeking past track boundary oldSeek=${e}, adjustedSeek=${t.playingItem.itemStartOffset}`),e=t.playingItem.itemStartOffset,s=!0),t.isPreloading&&(e>t.loadingItem.itemStartOffset&&(n.warn(`[Gapless] Seeking past track boundary oldSeek=${e}, adjustedSeek=${t.loadingItem.itemStartOffset}`),e=t.loadingItem.itemStartOffset,s=!0),t.dequeueSource("SeekToUnbufferedTimeRanges")),s?i.resetMediaSource(e):r.setSeekToPos(e,!0)}(i,a,s,r,l);else r.seeking=!0}})),e.event("seeked").pipe(pr(e=>Rc(t,"seeked",e)),eo(()=>{r.setSeekToPos(null,!0),0!==n.desiredRate||t.paused?0!==n.desiredRate&&n.haveEnough&&t.paused&&s.play():s.pause()})),e.event("play").pipe(pr(e=>Rc(t,"play",e)),To(n.desiredRate$),pr(([e])=>{var t=e.currentTarget;r.paused=t.paused;var i=s.expectPlayEvent,t=t.controls||o.nativeControlsEnabled;return!i&&t&&(s.checkForReplay(),r.desiredRate=1),s.expectPlayEvent=!1,e})),e.event("playing").pipe(pr(e=>Rc(t,"playing",e)),eo(e=>{e=e.currentTarget;r.paused=e.paused,r.gotPlayingEvent()})),e.event("loadstart").pipe(pr(e=>Rc(t,"loadstart",e)),eo(()=>{r.gotLoadStartEvent()})),e.event("pause").pipe(pr(e=>Rc(t,"pause",e)),eo(e=>{var t=e.currentTarget;r.paused=t.paused;e=s.expectPauseEvent,t=t.controls||o.nativeControlsEnabled;!e&&t&&(r.desiredRate=0),s.expectPauseEvent=!1})),e.event("loadedmetadata").pipe(pr(e=>Rc(t,"loadedmetadata",e))),e.event("loadeddata").pipe(pr(e=>Rc(t,"loadeddata",e))),e.event("canplay").pipe(pr(e=>Rc(t,"canplay",e))),e.event("canplaythrough").pipe(pr(e=>Rc(t,"canplaythrough",e))),e.event("waiting").pipe(pr(e=>Rc(t,"waiting",e))),e.event("emptied").pipe(pr(e=>Rc(t,"emptied",e))),e.event("error").pipe(pr(e=>Rc(t,"error",e)),zn(e=>Ki(t.error))),e.event("ended").pipe(pr(e=>Rc(t,"ended",e)))).pipe(To(n.bufferedRangeTuple$),dl(([e])=>{var t=e.currentTarget,e=t.readyState;r.readyState=e,r.ended=t.ended}),Qn(e=>{var t,i;try{e instanceof MediaError?(l.warn(`mediaElementError, code: ${e.code}, message: ${e.message}`),null==d||d.handleMediaElementError(e,null!==(i=null===(t=a.loadingItem)||void 0===t?void 0:t.isInterstitial)&&void 0!==i&&i)):l.error(`media event error: ${e.message}`)}catch(e){l.error("MediaError may be undefined on the platform")}return wi}),Va(un))};function Jf(e,a,o,l,t,d,i){const r=l.filter(e=>Boolean(e)).length,n=e.filter(e=>Boolean(e)).length,u=[null,null];e.forEach((e,t)=>{var i,r,n,s,a,o;e&&(s=e["offsetTimestamp"],a=E(s),i=e.initSeg.mimeType,{audioCodec:r,videoCodec:n}=e.initSeg.initParsedData,o=e["dataSeg"],s=E(o.startPts)-a,a=E(o.endPts)-a,o=o.discoSeqNum,u[t]={audioCodec:r,videoCodec:n,mimeType:i,startPTSSec:s,endPTSSec:a,discoSeqNum:o,mediaOptionId:e.initSeg.mediaOptionId})});let c=r===t,s=n===t;if(1===n&&n<t&&0!==r){const a=e[Tu.Variant]?Tu.Variant:Tu.AltAudio,o=1-a,t=u[a],d=u[o]=function(e,i,r,n,t,s){const a=null==e?void 0:e.bufferedSegments;if(!a)return s.warn("getMatchingInfo trying to query null sbEntity"),null;s=a.find(e=>{var t=e.frag.discoSeqNum===n,e=Math.max(i,e.startPTS)<Math.min(r,e.endPTS);return t&&e});if(null==s)return null;{const{audioCodec:i,videoCodec:r,mimeType:o}=e;return{mimeType:o,audioCodec:i,videoCodec:r,startPTSSec:s.startPTS,endPTSSec:s.endPTS,discoSeqNum:n,mediaOptionId:t}}}(l[o],t.startPTSSec,t.endPTSSec,t.discoSeqNum,t.mediaOptionId,i);if(!d&&a===Tu.Variant&&u[a]){const e=l[a].videoCodec,o=u[a].videoCodec;if(c=c&&(e===o||ye.isCompatibleVideoCodec(e,o)),c)return{compatible:c,boundary:NaN,allowance:NaN,discoSeqNum:u[a].discoSeqNum}}s=null!=d}let h=NaN,p=NaN,f=NaN;return s&&u.forEach((t,i)=>{if(!t)return null;Z(f)?f!==t.discoSeqNum&&(f=NaN):f=t.discoSeqNum;var r=l[i];if(r){const l=r.audioCodec,n=r.videoCodec,s=r.mimeType,{audioCodec:h,videoCodec:p,mimeType:f}=t;let e=d.changeType;if(e){const t=null===(r=o.sourceBuffers)||void 0===r?void 0:r[i];t&&(!!l==!!h&&!!n==!!p?s!==f&&"string"==typeof f&&(e=t.changeType(f),e&&a.updateSourceBufferEntity(i,u[i])):e=!1)}e||(c=c&&(n===p||ye.isCompatibleVideoCodec(n,p)),c=c&&(l===h||ye.isCompatibleAudioCodec(l,h)))}else c=!1;h=Z(h)?(p=Math.abs(t.startPTSSec-h),Math.max(t.startPTSSec,h)):(p=0,t.startPTSSec)}),{compatible:c&&s,boundary:h,allowance:p,discoSeqNum:f}}const Zf=new class extends fl{constructor(){super({},{name:"media-element-store",producerFn:lu}),this._activeId=""}get activeId(){return this._activeId}startMediaSession(i,r,n,s){return Co("playback.session.start"),this._activeId=`media session: ${(new Date).toISOString()}`,ol(()=>{var e=s,t=Math.max(e,r-e),t={id:this.activeId,desiredRate:!i.autoplay&&i.paused?0:1,paused:i.paused,gotPlaying:!1,gotLoadStart:!1,seeking:i.seeking,flushing:!1,readyState:i.readyState,ended:i.ended,bufferedRanges:[],contentGapRanges:[],haveEnough:!1,mediaSourceEntity:null,expectSeekingEvent:!1,expectedSbCount:NaN,bufferMonitorInfo:{waterLevelType:null,almostDryWaterLevelSeconds:n,lowWaterLevelSeconds:e,highWaterLevelSeconds:t,maxBufferSeconds:r},mediaOptionParsedSubtitleRecord:{},textTracksCreated:!1,waitingForDisco:!1};this.add(t),this.setActive(this.activeId)}),this.logger=Ge().child({name:"UpdateBufferedSegments"}),this.activeId}setMediaSourceEntity(t,i){Co("playback.set.msObjectUrl"),this.updateActive(e=>{e.mediaSourceEntity=null!=t&&null!=i?{objectUrl:t,readyState:i,duration:NaN,sourceBufferEntities:[null,null]}:null,e.bufferedRanges=[],e.haveEnough=!1,e.expectSeekingEvent=!1,e.readyState=0,e.bufferMonitorInfo.waterLevelType=null})}set mediaElementDuration(t){Co("playback.set.mediaElementDuration"),this.updateActive(e=>{e&&(e.mediaElementDuration=t)})}set primaryContentMediaElementDuration(i){Co("playback.set.primaryContentMediaElementDuration"),this.updateActive(e=>{var t;!e||((t=e.primaryContentMediaElementDuration)===1/0||!t||0<i&&t<i)&&(e.primaryContentMediaElementDuration=i)})}set msReadyState(t){Co("playback.set.msReadyState"),this.updateActive(({mediaSourceEntity:e})=>{e&&(e.readyState=t)})}set readyState(t){Co(`playback.set.readyState ${t}`),this.updateActive(e=>{(e.readyState=t)>=HTMLMediaElement.HAVE_METADATA&&(e.expectSeekingEvent=null!=e.seekTo)})}set ended(t){Co(`playback.set.ended ${t}`),this.updateActive(e=>{e.ended=t})}set msDuration(t){Co("playback.set.msDuration"),this.updateActive(e=>{e.mediaSourceEntity.duration=t})}set textTracksCreated(t){Co("playback.set.textTracksCreated ${created}"),this.updateActive(e=>{e.textTracksCreated=t})}set expectedSbCount(t){Co("playback.set.expectedSbCount"),this.updateActive(e=>{e.expectedSbCount=t})}set postFlushSeek(e){this.updateActive({postFlushSeek:e})}setSeekToPos(t,i=!1,r){Co(`playback.set.seekToPos: ${null==t?void 0:t.toFixed(3)} cc: ${r}`),this.updateActive(e=>{Z(t)?(e.seekTo={pos:t,fromEvent:i,discoSeqNum:r},e.postFlushSeek=void 0,e.gotPlaying=!1,e.haveEnough=!1,e.expectSeekingEvent=e.readyState>=HTMLMediaElement.HAVE_METADATA):e.seekTo=null,i&&(e.seeking=Z(t),e.expectSeekingEvent=!1)})}setLiveSeekableRange(t){this.updateActive(e=>{e.liveSeekableRange=t})}set seeking(t){Co(`playback.set.seeking: ${t}`),this.updateActive(e=>{e.seeking=t,e.expectSeekingEvent=!1})}set paused(t){Co(`playback.set.paused: ${t}`),this.updateActive(e=>{(e.paused=t)&&(e.gotPlaying=!1)})}gotPlayingEvent(){Co("playback.set.playing"),this.updateActive(e=>{e.paused||(e.gotPlaying=!0)})}gotLoadStartEvent(){Co("playback.set.loadstart"),this.updateActive(e=>{e.gotLoadStart=!0})}set desiredRate(t){Co(`playback.set.desiredRate: ${t}`),this.updateActive(e=>{e.desiredRate=t})}set haveEnough(t){Co(`playback.set.haveEnough: ${t}`),this.updateActive(e=>{e.haveEnough=t})}set flushing(e){Co(`playback.set.flushing: ${e}`),this.updateActive({flushing:e})}set waitingForDisco(t){Co(`playback.set.waitingForDisco: ${t}`),this.updateActive(e=>{e&&(e.waitingForDisco=t)})}setSourceBufferUpdating(i){Co(`playback.set.sourcebuffers[${Yu[i]}].updating`),this.updateActive(({mediaSourceEntity:e})=>{const t=null===(e=null==e?void 0:e.sourceBufferEntities)||void 0===e?void 0:e[i];t&&(t.updating=!0,t.error=void 0)})}setTimestampOffset(i,r){Co(`playback.set.sourcebuffers[${Yu[i]}].timestampOffset`),this.updateActive(({mediaSourceEntity:e})=>{const t=null===(e=null==e?void 0:e.sourceBufferEntities)||void 0===e?void 0:e[i];t&&(t.timestampOffset=r)})}setBufferedRangesUpdated(a,o,l,d){Co(`playback.set.sourcebuffers[${Yu[a]}].bufferupdated`),this.updateActive(e=>{var t,i,r;const n=null==e?void 0:e.mediaSourceEntity,s=null===(r=null==n?void 0:n.sourceBufferEntities)||void 0===r?void 0:r[a];s&&(s.updating=!1,s.bufferedRanges=[...o],t=s,i=t.inFlight,r=t.bufferedSegments,i&&Z(i.startPTS)&&Z(i.endPTS)&&function(t,i){let r=!1;for(let e=t.length-1;-1<e;e--){const s=t[e],a=Math.max(i.startPTS,s.startPTS),o=Math.min(i.endPTS,s.endPTS);var n;o<=a||((n=(1-(o-a)/(s.endPTS-s.startPTS))*s.bytes)<=0?(!s.evicting&&vf(s.frag,i.frag)&&(i.rebuffered=!0),t.splice(e,1)):(s.bytes=n,s.startPTS<i.startPTS?s.endPTS=a:(s.startPTS=o,r||(t.splice(e,0,i),r=!0))))}r||t.push(i)}(r,i),t.inFlight=null,function(t,i){const r=t.bufferedSegments,n=t.bufferedRanges;let s,a=0,o=!1;if(n.length)for(let e=r.length-1;-1<e;e--){const i=r[e],u=!i.frag.iframe;u&&i.frag.isLastFragment&&e===r.length-1&&(s=i.frag);var l=i.endPTS-i.startPTS,d=Tf(n,i);if(d){const t=Math.max(d.start,i.startPTS),r=Math.min(d.end,i.endPTS),n=r-t;a+=i.bytes*n/l,u&&(n<l&&Z(i.appendStart)&&Z(i.appendEnd)&&(i.appendStart<t||i.appendEnd>r)&&(i.evicting=!0),i.appendStart=t,i.appendEnd=r)}else r.splice(e,1),o=i.frag===s}else r.length&&r.splice(0,r.length);t.totalDuration=s&&!o&&0<n.length?n[n.length-1].end:1/0,t.gotQuotaExceeded=t.gotQuotaExceeded||i,t.totalBytes=a,t.maxTotalBytes=Math.max(t.totalBytes,t.maxTotalBytes)}(s,d)),e.bufferedRanges=[...l]})}updateContentGapRanges(t){this.updateActive(e=>{e.contentGapRanges=t})}updateSourceBufferEntity(s,a){Co(`playback.update.sourcebuffers[${Yu[s]}].updateSourceBufferEntity`),this.updateActive(({mediaSourceEntity:e})=>{var t,i,r,n;e&&({mimeType:t,audioCodec:i,videoCodec:n}=a,r=e.sourceBufferEntities[s],n=Object.assign(Object.assign({},r),{mimeType:t,audioCodec:i,videoCodec:n,initSegmentInfo:null}),e.sourceBufferEntities[s]=n)})}setSourceBufferEntity(n,s){Co(`playback.set.sourcebuffers[${Yu[n]}].setSourceBufferEntity`),this.updateActive(({mediaSourceEntity:e})=>{var t,i,r;e&&({mimeType:t,audioCodec:i,videoCodec:r}=s,e.sourceBufferEntities[n]={mimeType:t,audioCodec:i,videoCodec:r,updating:!1,bufferedRanges:[],timestampOffset:0,inFlight:null,bufferedSegments:[],totalBytes:0,maxTotalBytes:0,gotQuotaExceeded:!1,totalDuration:1/0})})}setInflightSegment(i,r){Co(`playback.set.sourcebuffers[${Yu[i]}].setInflightSegment`),this.updateActive(({mediaSourceEntity:e})=>{const t=null===(e=null==e?void 0:e.sourceBufferEntities)||void 0===e?void 0:e[i];t&&(t.inFlight=r)})}setInitSegmentEntity(i,r){Co(`playback.set.sourcebuffers[${Yu[i]}].setInitSegmentEntity`),this.updateActive(({mediaSourceEntity:e})=>{const t=null===(e=null==e?void 0:e.sourceBufferEntities)||void 0===e?void 0:e[i];t&&(t.initSegmentInfo=r)})}setSourceBufferError(i,r){Co(`playback.set.sourcebuffers[${i}].error: ${r}`),this.updateActive(({mediaSourceEntity:e})=>{const t=null===(e=null==e?void 0:e.sourceBufferEntities)||void 0===e?void 0:e[i];t&&(t.inFlight=null,t.updating=!1,t.error=r)})}setStallInfo(t){Co(`playback.set.stallInfo stalled=${null!=t}`),this.updateActive(e=>{e.stallInfo=t,null!=e.stallInfo&&(e.gotPlaying=!1)})}setNudgeInfo(t){Co(`playback.set.nudgeInfo ${te(t)}`),this.updateActive(e=>{e.nudgeInfo=t})}updateWaterLevels(t,i){Co("playback.set.updateWaterLevels"),this.updateActive(e=>{e.bufferMonitorInfo.waterLevelType={combined:t,sbTuple:[...i]}})}set bufferMonitorTargetDuration(i){Co(`playback.set.targetDuration: ${i}`),this.updateActive(e=>{if(Z(i)&&0<i){const t=e.bufferMonitorInfo;t.lowWaterLevelSeconds=Math.min(i,t.maxBufferSeconds),t.highWaterLevelSeconds=Math.max(t.lowWaterLevelSeconds,t.maxBufferSeconds-i)}})}archiveParsedSubtitleFragmentRecord(i,r,n){Co(`playback.cues.set Record key ${i} mediaSeqNum ${r}: parsed ${n.count} time-range ${n.startTime}:${n.endTime}`),this.updateActive(e=>{let t=e.mediaOptionParsedSubtitleRecord[i];t||(t={},e.mediaOptionParsedSubtitleRecord[i]=t),t[r]=n})}clearParsedSubtitleFragmentRecord(t){this.updateActive(e=>{e.mediaOptionParsedSubtitleRecord[t]&&(e.mediaOptionParsedSubtitleRecord[t]={})})}removeOldSubtitleFragmentRecord(r){this.updateActive(e=>{for(const t in e.mediaOptionParsedSubtitleRecord){const i=e.mediaOptionParsedSubtitleRecord[t];for(const e in i){if(!(i[e].endTime<r))break;delete i[e]}}})}};function em(e){return e.matches}class tm extends Ti{constructor(e){super(e),this.store=e,this.displaySupportsHdr$=this.select("supportsHdr"),this.platformInfo$=this.select("platformInfo"),this.viewportInfo$=this.select("viewportInfo")}get platformInfo(){return this.getValue().platformInfo}get displaySupportsHdr(){return this.getValue().supportsHdr}get viewportInfo(){return this.getValue().viewportInfo}}class im{constructor(e){this.store=e}getQuery(){return new tm(this.store)}updateSupportsHdr(t){this.store.update(e=>{e.supportsHdr=t})}updatePlatformInfo(e){this.store.update({platformInfo:e})}updateViewportInfo(t){this.store.update(e=>{e.viewportInfo=t})}}const rm=new class extends pl{constructor(){super({supportsHdr:!0},{name:"platform",producerFn:lu})}};let nm=null;function sm(){return nm=nm||new im(rm),nm}class am extends Kt{constructor(e,t){super(e=>{null==t||t.add(),e.add(this._handler$.pipe(Hr(([e,t,i])=>e(...t).pipe(eo({next(e){i(e,null)},error(e){i(null,e)}})))).subscribe())}),this._vanillaRPC=e,this.teardownWG$=t,this._handler$=new Jt}register(e,i){return this._vanillaRPC.register(e,(...t)=>e=>{this._handler$.next([i,t,e])})}invoke(e,t,r){return new Kt(i=>{this._vanillaRPC.invoke(e,t,r)((e,t)=>{null!=t?i.error(t):(i.next(e),i.complete())})})}}class om extends am{constructor(e){super(e)}decrypt(e,t,i,r,n){return this.invoke("decrypt",[e,t,i,r,n],[e,t,r])}}class lm extends am{constructor(e){super(e),this.rpcService=e,this.sessions={},this._onEvent=(e,t,i)=>()=>{null!=this.sessions[e]&&this.sessions[e].observer.trigger(t,i)},this.rpcService.register("demuxer.event",this._onEvent)}init(e,t,i){return[{maxSeekHole:r,maxBufferHole:n,audioPrimingDelay:s,stretchShortVideoTrack:a,forceKeyFrameOnDiscontinuity:o}]=[t],this.invoke("demuxer.init",[e,t={maxSeekHole:r,maxBufferHole:n,audioPrimingDelay:s,stretchShortVideoTrack:a,forceKeyFrameOnDiscontinuity:o},i],[]).pipe(pr(e=>{var t=new dm(this,e);return this.sessions[e]=t}));var r,n,s,a,o}}class dm{constructor(e,t){this.rpc=e,this.demuxSessionID=t,this.observer=new r}push(e,t,i,r,n,s,a,o,l,d,u,c,h){return this.rpc.invoke("demuxer.push",[this.demuxSessionID,e,t,i,r,n,s,a,o,l,d,u,c],null!=h?h:[e])}destroy(){this.observer.removeAllListeners(),this.rpc.invoke("demuxer.destroy",[this.demuxSessionID],[]).subscribe()}}class um{constructor(){this.handlers={}}register(e,t){if(null!=this.handlers[e])return!1;this.handlers[e]=t}unregister(e){if(null!=this.handlers[e])return!1;delete this.handlers[e]}invoke(e,i){return(t=um._fallbackCallback)=>{try{if(null==this.handlers[e])throw new Error(`command ${e} not found`);this.handlers[e](...i)(t)}catch(e){t(void 0,e)}}}teardown(e){this.handlers=null,e()}}um._fallbackCallback=(e,t)=>{if(null!=t)throw t};const cm=e=>{e=e.child({name:"InlineRPCService"});var t=new um;return new i(t,e),new dt(t,e),t};let hm;const pm=t=>{try{if(null==hm){const t=new Blob(["var exports = {};var module = { exports: exports };function define(f){f()};define.amd = true;("+l0.toString()+")(true);"],{type:"text/javascript"}),r=URL.createObjectURL(t);hm=new Worker(r)}var e=new ut(hm);return i=e,s=t.child({name:"WorkerRPCService"}),i.register("logger.log",(i,r,...n)=>t=>{try{let e=s;for(const s of i)e=e.child(s);"function"==typeof e[r]&&e[r](...n),t()}catch(e){t(void 0,e)}}),e}catch(e){throw t.error("Failed to create WebWorker.",e),e}var i,s},fm=(...r)=>i=>{for(let t=0;t<r.length;t++){const e=r[t];try{return e(i)}catch(e){if(t===r.length-1)throw e;i.warn(e)}}},mm=e=>fm(pm,cm)(e);class gm{constructor(e,t){this.hls=e,this.sessionID=t,this.rtcQuery=null,this.accessLogData=this.createAccessLogEntry(),this.accesslog=[],this.errorlog=[]}destroy(){this.rtcQuery=null,this.accesslog=[],this.errorlog=[],this.accessLogData=void 0,this.accessLogReporter=void 0}setRTCQuery(e){this.rtcQuery=e}setupReporter(e){this.accessLogReporter={SessionID:this.sessionID,ClientName:null==e?void 0:e.clientName,ServiceName:null==e?void 0:e.serviceName}}addPlayTime(e){var t=null===(t=this.rtcQuery)||void 0===t?void 0:t.getEntity(e);t&&(e=t.sessionControlRecord,t=performance.now()-e.eventStartTime,"RTC_STATE_PLAY"===e.state&&(this.accessLogData.PlayTimeWC=(this.accessLogData.PlayTimeWC||0)+t))}updatePlaybackInfo(e,t){this.accessLogData.ViFrDr=this.rtcQuery.getEntity(e).sessionControlRecord.droppedVideoFrames||0}updateStallCount(e){"RTC_STATE_PLAY"===this.rtcQuery.getEntity(e).sessionControlRecord.state&&this.accessLogData.StallCount++}updateMediaEngineStallCount(e){"RTC_STATE_PLAY"===this.rtcQuery.getEntity(e).sessionControlRecord.state&&this.accessLogData.MediaEngineStallCount++}updateCanPlay(e){this.accessLogData.StartupTime=this.rtcQuery.getEntity(e).sessionControlRecord.eventStartTime}updateFragLoaded(e,t,i){var r;i.fragType===Tu.Variant?(this.accessLogData.NetBytes+=i.bytes,this.accessLogData.ADT+=i.adt,r=this.aggregateFragObserverdBitrate(i,++this.accessLogData.fragmentCnt,this.accessLogData.NetBytes,this.accessLogData.ADT),this.accessLogData.OBRLast=r.obrLast,this.accessLogData.OBRMean=r.obrMean,this.aggregateFragMinMaxBitrate(this.accessLogData,r.obr),this.hls.realCurrentTime>i.startPTS&&!t&&this.accessLogData.overdue++,this.hasGap(i.startPTS,i.endPTS,this.accessLogData.lastStartPTS,this.accessLogData.lastEndPTS)&&this.addToAccessLog(e),this.accessLogData.startPTS||(this.accessLogData.startPTS=i.startPTS),this.accessLogData.lastStartPTS=i.startPTS,this.accessLogData.lastEndPTS=i.endPTS,this.accessLogData.videoBytes+=i.bytes,this.accessLogData.videoDuration+=i.duration):i.fragType===Tu.AltAudio&&(this.accessLogData.audioBytes+=i.bytes,this.accessLogData.audioDuration+=i.duration)}addToAccessLog(e){var t=this.getVariantInfo(e),i=this.rtcQuery.getEntity(e).sessionControlRecord.curLevelUrl,r=this.rtcQuery.getEntity(e).playEndedRecord.PlayType;if(i&&""!==i){r=this.translateToAccessLogItem(e,i,t,r);if(r){const n=this.accesslog.length-20;0<n&&this.accesslog.splice(0,n),this.accesslog.push(r)}this.accessLogData=this.createAccessLogEntry();e=this.rtcQuery.getEntity(e).switchCompleteRecord.MediaDur;this.accessLogData.lastMediaDur=e||this.hls.bufferedDuration}}addToErrorLog(e,t){var i=null===(r=this.rtcQuery)||void 0===r?void 0:r.getEntity(e);if(i){var r=Number(("mediaError"===t?i.playErrorRecord:i.nwErrorRecord).ErrCode),i=i.sessionControlRecord.curLevelUrl,r=this.translateToErrorLogItem(e,i,{domain:t,code:r});if(r){const e=this.errorlog.length-20;0<e&&this.errorlog.splice(0,e),this.errorlog.push(r)}}}getAccessLog(e){var t;const i=this.accesslog.slice(0),r=null===(t=this.rtcQuery)||void 0===t?void 0:t.getEntity(e);if(i&&r){const t=r.sessionControlRecord.curLevelUrl;if(t&&""!==t){const r=this.getVariantInfo(e),n=this.translateToAccessLogItem(e,t,r,this.rtcQuery.getEntity(e).playEndedRecord.PlayType);n&&(n["c-provisional-entry"]=!0,i.push(n))}}return i}get errorLog(){return this.errorlog}createAccessLogEntry(){return{fragmentCnt:0,overdue:0,startPTS:0,obrMax:0,obrMin:0,audioBytes:0,audioDuration:0,videoBytes:0,videoDuration:0,svrAddrChanged:0,svrAddr:"",PlayTimeWC:0,ViFrDr:0,StallCount:0,MediaEngineStallCount:0,ADT:0,NetBytes:0,StartupTime:0,OBRMean:0,OBRLast:0}}convertStringObjectToPrimitive(e){return e?"object"==typeof e?e.toString():e:""}updateSvrAddrStats(t){const i=Au.parseURL(t);if(i&&i.netLoc){const t=i.netLoc.indexOf(":");let e=0<=t?i.netLoc.slice(0,t):i.netLoc;e.startsWith("//")&&(e=e.slice(2)),this.accessLogData.svrAddr?e!==this.accessLogData.svrAddr&&this.accessLogData.svrAddrChanged++:this.accessLogData.svrAddrChanged=0,this.accessLogData.svrAddr=e}}translateToAccessLogItem(e,t,i,r){t=this.convertStringObjectToPrimitive(t);this.updateSvrAddrStats(t);let n=this.rtcQuery.getEntity(e).switchCompleteRecord.MediaDur;n=n||this.hls.bufferedDuration,n=n||0;const s={uri:t,"s-ip":this.accessLogData.svrAddr,"s-ip-changes":this.accessLogData.svrAddrChanged,"sc-wwan-count":-1,"c-transfer-duration":this.accessLogData.ADT,bytes:this.accessLogData.NetBytes,"c-total-media-requests":this.accessLogData.fragmentCnt,"cs-guid":this.accessLogReporter.SessionID,"c-start-time":this.accessLogData.startPTS,"c-startup-time":this.accessLogData.StartupTime,"c-duration-watched":this.accessLogData.PlayTimeWC/1e3,"c-frames-dropped":this.accessLogData.ViFrDr,"c-stalls":this.accessLogData.StallCount+this.accessLogData.MediaEngineStallCount,"c-duration-downloaded":this.accessLogData.lastMediaDur?n-this.accessLogData.lastMediaDur:n,"c-overdue":this.accessLogData.overdue,"c-avg-video-bitrate":8*this.accessLogData.videoBytes/(this.accessLogData.videoDuration||1),"c-observed-max-bitrate":this.accessLogData.obrMax,"c-observed-min-bitrate":this.accessLogData.obrMin,"sc-indicated-bitrate":i.bandwidth||0,"sc-indicated-avg-bitrate":i.avgBandwidth||0,"c-observed-bitrate":this.accessLogData.OBRMean,"c-switch-bitrate":this.accessLogData.OBRLast,"c-provisional-entry":!1};return s["s-playback-type"]=r,this.accessLogData.audioBytes&&(s["c-avg-audio-bitrate"]=8*this.accessLogData.audioBytes/(this.accessLogData.audioDuration||1)),s}translateToErrorLogItem(e,t,i){t=this.convertStringObjectToPrimitive(t);return this.updateSvrAddrStats(t),{date:new Date,"cs-guid":this.accessLogReporter.SessionID+"-"+e,uri:t,"s-ip":this.accessLogData.svrAddr,status:""+i.code,domain:i.domain}}hasGap(e,t,i,r){return void 0!==e&&void 0!==i&&(1<e-r||1<i-t)}aggregateFragObserverdBitrate(e,t,i,r){r=8*i/(r/1e3);return{obr:r,obrLast:8*e.bytes/(e.adt/1e3),obrMean:r/t}}aggregateFragMinMaxBitrate(e,t){(!e.obrMax||t>e.obrMax)&&(e.obrMax=t),(!e.obrMin||t<e.obrMin)&&(e.obrMin=t)}getVariantInfo(e){var t=this.rtcQuery.getEntity(e).sessionControlRecord.curLevelUrl,e=null===(e=this.rtcQuery.getEntity(e).sessionControlRecord.manifestData)||void 0===e?void 0:e.variantList;return t&&e&&e[t]?e[t]:{}}}class ym{}ym.PlayEnded=6101,ym.Periodic=6110,ym.PlayStalled=6103,ym.KeySessionComplete=6104,ym.PlayLikelyToKeepUp=6105,ym.PlayRateChanged=6106,ym.PlayError=6107,ym.MediaEngineStalled=6108,ym.SwitchComplete=6109,ym.VariantEnded=6111,ym.InterstitialStarted=6121,ym.InterstitialAssetStarted=6122,ym.InterstitialAssetEnded=6123,ym.InterstitialEnded=6124,ym.NwError=6202;const vm={avc1:1,avc3:1,hvc1:{SDR:2,HLG:10,PQ:11},hev1:{SDR:2,HLG:10,PQ:11},vp09:{SDR:3,HLG:14,PQ:13},dvh1:{PQ:12}};class Sm{constructor(e,t){this.query=e,this.logger=t}setReportingAgent(e){this.reportingAgent=e}sendPlayEnded(e){var t=ym.PlayEnded;this.fillAndFire(t,this.query.playEnded(e))}sendPlayStalled(e){var t=ym.PlayStalled;this.fillAndFire(t,this.query.playStalled(e))}sendMediaEngineStalled(e){var t=ym.MediaEngineStalled;this.fillAndFire(t,this.query.mediaEngineStalled(e))}sendKeySessionComplete(e){var t=ym.KeySessionComplete;this.fillAndFire(t,this.query.keySessionComplete(e))}sendPlayLikelyToKeepUp(e){var t=ym.PlayLikelyToKeepUp;this.fillAndFire(t,this.query.playLikelyToKeepUp(e))}sendPlayRateChange(e){var t=ym.PlayRateChanged;this.fillAndFire(t,this.query.playRateChanged(e))}sendSwitchComplete(e){var t=ym.SwitchComplete;this.fillAndFire(t,this.query.switchComplete(e))}sendVariantEnded(e){var t=ym.VariantEnded;this.fillAndFire(t,this.query.variantEnded(e))}sendPlayError(e){var t=ym.PlayError;this.fillAndFire(t,this.query.playError(e))}sendNwError(e){var t=ym.NwError;this.fillAndFire(t,this.query.nwError(e))}sendPeriodic(e){var t=ym.Periodic;this.fillAndFire(t,this.query.periodic(e))}sendInterstitialStart(e){var t=ym.InterstitialStarted;this.fillAndFire(t,this.query.periodic(e))}sendInterstitialAssetStart(e){var t=ym.InterstitialAssetStarted;this.fillAndFire(t,this.query.periodic(e))}sendInterstitialAssetEnd(e){var t=ym.InterstitialAssetEnded;this.fillAndFire(t,this.query.periodic(e))}sendInterstitialEnd(e){var t=ym.InterstitialEnded;this.fillAndFire(t,this.query.periodic(e))}fillAndFire(e,t){if(e!==ym.Periodic||t.PlayTimeWC||t.ADT){var r=e===ym.PlayEnded||e===ym.Periodic?1:0;if(this.reportingAgent){let i={};Object.entries(t).forEach(([e,t])=>{"object"==typeof(t=Z(t)?Number(Number(t).toFixed(2)):t)?"ServerInfo"===e&&Object.entries(t).forEach(([e,t])=>{i[e]=t}):i[e]=t}),i=JSON.parse(JSON.stringify(i));try{this.reportingAgent.issueReportingEvent(e,i,r)}catch(e){}}}}}class bm extends Al{constructor(e,t){super(e),this.logger=t}get activeEntity(){return this.getActive()}entity(e){return this.getEntity(e)}playEnded(e){return null===(e=this.getEntity(e))||void 0===e?void 0:e.playEndedRecord}periodic(e){return null===(e=this.getEntity(e))||void 0===e?void 0:e.periodicRecord}sessionControlRecord(e){return null===(e=this.getEntity(e))||void 0===e?void 0:e.sessionControlRecord}playStalled(e){return null===(e=this.getEntity(e))||void 0===e?void 0:e.playStalledRecord}mediaEngineStalled(e){return null===(e=this.getEntity(e))||void 0===e?void 0:e.mediaEngineStalledRecord}keySessionComplete(e){return null===(e=this.getEntity(e))||void 0===e?void 0:e.keySessionCompleteRecord}playLikelyToKeepUp(e){return null===(e=this.getEntity(e))||void 0===e?void 0:e.playLikelyToKeepUpRecord}playRateChanged(e){return null===(e=this.getEntity(e))||void 0===e?void 0:e.playRateChangedRecord}switchComplete(e){return null===(e=this.getEntity(e))||void 0===e?void 0:e.switchCompleteRecord}variantEnded(e){return null===(e=this.getEntity(e))||void 0===e?void 0:e.variantEndedRecord}playError(e){return null===(e=this.getEntity(e))||void 0===e?void 0:e.playErrorRecord}nwError(e){return null===(e=this.getEntity(e))||void 0===e?void 0:e.nwErrorRecord}interstitialPlayTime(e){return null!==(e=null===(e=this.getEntity(e))||void 0===e?void 0:e.periodicRecord.InterstitialPlayTime)&&void 0!==e?e:0}}class Tm extends fl{constructor(e){super({},{name:"rtc-store",idKey:"itemId",producerFn:lu,resettable:!0}),this.logger=e}createEntity(e,t,i,r=!1){r={itemId:e,sessionControlRecord:{state:"RTC_STATE_INIT",rate:0,oldRate:0,eventStartTime:performance.now(),sessionStartTime:performance.now(),lastLikelyToKeepUpTime:performance.now(),lastPeriodicTime:performance.now(),lastWaitForCanPlay:performance.now(),playLikelyToKeepUpEventCounter:1,periodicEventCounter:1,activeKeySessions:{},intervalVariantList:{},sessionVariantList:{}},playEndedRecord:{HLSJSVersion:t,InterstitialsEnabled:i,IsLoopingPlayer:r},periodicRecord:{},playStalledRecord:{},keySessionCompleteRecord:{},playLikelyToKeepUpRecord:{},playRateChangedRecord:{},playErrorRecord:{},mediaEngineStalledRecord:{},switchCompleteRecord:{},variantEndedRecord:{},nwErrorRecord:{}};this.add(r)}removeEntityByID(e){this.remove(e)}updateEnded(e){this._prepareEventPlayEnded(e)}updatePeriodic(e,t){this._prepareEventPeriodic(e,{isFinal:t})}updateBufferStalled(e,t){this.update(e,({sessionControlRecord:e,variantEndedRecord:t,periodicRecord:i,playEndedRecord:r})=>{e.rate=0,t.StallCount=(t.StallCount||0)+1,i.StallCount=(i.StallCount||0)+1,r.StallCount=(r.StallCount||0)+1}),this._prepareEventPlayStalled(e,t)}updateSegmentKeyLoaded(e,r){this.update(e,({sessionControlRecord:e})=>{const t={},i=r.timestamp;t.keyFormat="identity",t.keyDeliveryTime=r.adt,t.currentMediaTime=r.currentTime,t.forInterstitial=r.forInterstitial,"RTC_STATE_INIT"===e.state&&(t.keyInitTime=i-e.sessionStartTime),e.activeKeySessions[r.keyuri]=t}),this._prepareEventKeySessionComplete(e,r)}updateLicenseResponseProcessed(e,i){this.update(e,({sessionControlRecord:e})=>{const t=e.activeKeySessions[i.keyuri];t.licenseResponseProcessTime=i.timestamp-t.licenseResponseSubmitTime,e.lastKeyDeliveryTime=t.keyDeliveryTime=i.timestamp-t.licenseChallengeStartTime,t.currentMediaTime=i.currentTime,e.finishedKeyUri=i.keyuri}),this._prepareEventKeySessionComplete(e,i)}updateLicenseChallengeError(e,i){this.update(e,({sessionControlRecord:e})=>{const t=e.activeKeySessions[i.keyuri];e.lastKeyErrorType=t.keyErrorType="licenseChallengeError",e.finishedKeyUri=i.keyuri}),this._prepareEventKeySessionComplete(e,i)}updateLicenseResponseError(e,i){this.update(e,({sessionControlRecord:e})=>{const t=e.activeKeySessions[i.keyuri];e.lastKeyErrorType=t.keyErrorType="licenseResponseError",e.finishedKeyUri=i.keyuri}),this._prepareEventKeySessionComplete(e,i)}updateKeyAborted(e,t){this.update(e,({sessionControlRecord:e})=>{e.activeKeySessions[t.keyuri].keyErrorType="keyAborted",e.finishedKeyUri=t.keyuri}),this._prepareEventKeySessionComplete(e,t)}updateCanPlay(e,r){this.update(e,({sessionControlRecord:e,playLikelyToKeepUpRecord:t,playRateChangedRecord:i})=>{this._isIFrameToggle(r.oldRate,r.newRate)?e.iFrameToggle=!0:e.iFrameToggle=!1,t.StartupTime=i.StartupTime=performance.now()-e.lastWaitForCanPlay}),this._prepareEventPlayLikelyToKeepUp(e,r)}updateRateChanged(e,t){this.update(e,({sessionControlRecord:e})=>{e.rate=100*t.rate,0<t.rate&&0===e.oldRate&&(e.playInfo||(e.playInfo=[]),e.playInfo.push({latency:t.latency}),e.curLevelUrl||(e.curLevelUrl=t.url))}),this._prepareEventPlayRateChanged(e,t)}updateMediaError(e,r){this.update(e,({sessionControlRecord:e,periodicRecord:t,playEndedRecord:i})=>{t.PlayerErrCount=(t.PlayerErrCount||0)+1,i.PlayerErrCount=(i.PlayerErrCount||0)+1,r.fatal&&(e.rate=0,t.FatalPlayerErrCount=(t.FatalPlayerErrCount||0)+1,i.FatalPlayerErrCount=(i.FatalPlayerErrCount||0)+1,i.ErrCode=r.details,i.ErrReason=r.code,i.ErrIsFatal=!0,i.ErrDomain="mediaError")}),r.fatal?this._prepareEventPlayError(e,r):this.update(e,({sessionControlRecord:e})=>{var t=r.details+"/"+r.code;e.nonFatalPlayErrList[t]=(e.nonFatalPlayErrList[t]||0)+1})}updateMediaElementError(e,t,i){let r;try{r=JSON.parse(t.message)}catch(e){this.logger.warn(`message is not JSON, ignoring; ${t.message}`)}var n=r?parseInt(r.ErrReason):null,s=r?parseInt(r.ErrDetail):null;this._prepareEventPlayError(e,{domain:"mediaElementError",mediaElemCode:t.code,mediaElemReason:n,mediaElemDetail:s,code:null,details:null,fatal:null,forInterstitial:i})}updateMediaEngineStalled(e,t){this.update(e,({sessionControlRecord:e,variantEndedRecord:t,periodicRecord:i,playEndedRecord:r})=>{e.rate=0,t.MediaEngineStallCount=(t.MediaEngineStallCount||0)+1,i.MediaEngineStallCount=(i.MediaEngineStallCount||0)+1,r.MediaEngineStallCount=(r.MediaEngineStallCount||0)+1}),this._prepareEventMediaEngineStalled(e,t)}updateLevelSwitched(e,d){this.update(e,({sessionControlRecord:e,switchCompleteRecord:t,periodicRecord:i,playEndedRecord:r})=>{i.SwCnt=(i.SwCnt||0)+1,r.SwCnt=(r.SwCnt||0)+1;var n=performance.now(),s=e.curLevelUrl,a=d.url,i=this._getVariantInfo(s,e),r=this._getVariantInfo(a,e);let o,l=!1;s&&(o=r.bandwidth<i.bandwidth?"Down":"Up",l=r.iframes),t.BadSw=this._isBadSw(o,e.lastSwitchDir||o,l,e.lastLevelIsIframe||l,n,e.lastSwitchTime||n,d.isSeeking),e.lastSwitchDir=o,e.lastSwitchTime=n,e.lastLevelIsIframe=l,e.curLevelUrl=a,e.variantStartTimeMedia=d.currentTime}),this._prepareEventSwitchComplete(e,d)}updateLevelLoadError(e,o){this.update(e,({sessionControlRecord:e,switchCompleteRecord:t,periodicRecord:i,playEndedRecord:r})=>{var n=performance.now();let s,a=!1;if(e.curLevelUrl){const t=this._getVariantInfo(e.curLevelUrl,e),i=this._getVariantInfo(o.url,e);s=i.bandwidth<t.bandwidth?"Down":"Up",a=i.iframes}i.SwCnt=(i.SwCnt||0)+1,r.SwCnt=(r.SwCnt||0)+1,t.BadSw=this._isBadSw(s,e.lastSwitchDir||s,a,e.lastLevelIsIframe||a,n,e.lastSwitchTime||n,o.isSeeking),t.SwFail=!0}),this._prepareEventSwitchComplete(e,o)}updateVariantEnd(e,t){this._prepareEventVariantEnded(e,t)}updateNwError(e,r){this.update(e,({sessionControlRecord:e,periodicRecord:t,playEndedRecord:i})=>{t.NwErrCount=(t.NwErrCount||0)+1,i.NwErrCount=(i.NwErrCount||0)+1,r.fatal&&(e.rate=0,t.FatalNwErrCount=(t.FatalNwErrCount||0)+1,i.FatalNwErrCount=(i.FatalNwErrCount||0)+1,i.ErrCode=r.details,i.ErrReason=r.code,i.ErrIsFatal=!0,i.ErrDomain="networkError")}),r.fatal?this._prepareEventNwError(e,r):this.update(e,({sessionControlRecord:e})=>{var t=r.details+"/"+r.code;e.nonFatalNwErrList[t]=(e.nonFatalNwErrList[t]||0)+1})}updateInterstitialPlayTime(e,a){this.update(e,({playEndedRecord:e,periodicRecord:t,variantEndedRecord:i,playStalledRecord:r,playErrorRecord:n,mediaEngineStalledRecord:s})=>{e.InterstitialPlayTime=(e.InterstitialPlayTime||0)+a,t.InterstitialPlayTime=(t.InterstitialPlayTime||0)+a,i.InterstitialPlayTime=(i.InterstitialPlayTime||0)+a,r.InterstitialPlayTime=(r.InterstitialPlayTime||0)+a,n.InterstitialPlayTime=(n.InterstitialPlayTime||0)+a,s.InterstitialPlayTime=(s.InterstitialPlayTime||0)+a})}finalize(e,t){switch(t){case ym.PlayEnded:this.update(e,({sessionControlRecord:e})=>{e.state="RTC_STATE_STOP",e.oldRate=0}),this.update(e,e=>{e.playEndedRecord={}});break;case ym.Periodic:this.update(e,({sessionControlRecord:t})=>{t.lastPeriodicTime=performance.now(),t.periodicEventCounter+=1,t.bufferAppendInfo=[],t.playInfo=[],t.seekInfo=[],Object.keys(t.intervalVariantList).forEach(e=>{t.intervalVariantList[e].playTime=0})}),this.update(e,e=>{e.periodicRecord={}});break;case ym.PlayStalled:this.update(e,({sessionControlRecord:e})=>{e.state="RTC_STATE_STALL",e.oldRate=0}),this.update(e,e=>{e.playStalledRecord={}});break;case ym.KeySessionComplete:this.update(e,({sessionControlRecord:e})=>{delete e.activeKeySessions[e.finishedKeyUri]}),this.update(e,e=>{e.keySessionCompleteRecord={}});break;case ym.PlayLikelyToKeepUp:this.update(e,({sessionControlRecord:e})=>{"RTC_STATE_PLAY"===e.state&&!e.iFrameToggle||(e.state="RTC_STATE_CANPLAY",e.lastLikelyToKeepUpTime=performance.now(),e.playLikelyToKeepUpEventCounter+=1)}),this.update(e,e=>{e.playLikelyToKeepUpRecord={}});break;case ym.PlayRateChanged:this.update(e,({sessionControlRecord:e,playEndedRecord:t,playStalledRecord:i,mediaEngineStalledRecord:r,playErrorRecord:n,nwErrorRecord:s})=>{0!==e.rate?(e.state="RTC_STATE_PLAY",delete t.LastStall,delete t.LastMediaEngineStall,delete t.LastPause,delete n.LastPause,delete s.LastPause):(e.state="RTC_STATE_PAUSE",delete i.LastResume,delete r.LastResume,delete n.LastResume,delete s.LastResume),e.oldRate=e.rate}),this.update(e,e=>{e.playRateChangedRecord={}});break;case ym.PlayError:this.update(e,({sessionControlRecord:e})=>{e.state="RTC_STATE_PLAYERROR"}),this.update(e,e=>{e.playErrorRecord={}});break;case ym.MediaEngineStalled:this.update(e,({sessionControlRecord:e})=>{e.state="RTC_STATE_MEDIAENGINESTALL",e.oldRate=0}),this.update(e,e=>{e.mediaEngineStalledRecord={}});break;case ym.SwitchComplete:this.update(e,e=>{e.switchCompleteRecord={},e.sessionControlRecord.prevLevelUrl=e.sessionControlRecord.curLevelUrl});break;case ym.VariantEnded:this.update(e,({sessionControlRecord:e})=>{e.decodedFramesForVariant=0,e.decodedFramesForVariantSampleCount=0}),this.update(e,e=>{e.variantEndedRecord={}});break;case ym.NwError:this.update(e,({sessionControlRecord:e})=>{e.state="RTC_STATE_NWERROR"}),this.update(e,e=>{e.nwErrorRecord={}})}this.update(e,({sessionControlRecord:e})=>{e.eventStartTime=performance.now()})}updatePlaybackInfo(e,s){this.update(e,({sessionControlRecord:e,periodicRecord:t,playEndedRecord:i})=>{s.droppedVideoFrames<e.droppedVideoFrames&&(e.droppedVideoFrames=0),s.decodedFrameCount<e.decodedFrameCount&&(e.decodedFrameCount=0);var r=s.droppedVideoFrames-(e.droppedVideoFrames||0),n=s.decodedFrameCount-(e.decodedFrameCount||0);e.droppedVideoFrames=s.droppedVideoFrames,e.decodedFrameCount=s.decodedFrameCount,e.decodedFramesForVariant+=n,e.decodedFramesForVariantSampleCount+=1,r&&(3<=r?(t.GroupViFrDr=(t.GroupViFrDr||0)+r,t.GroupViFrDrEvtCount=(t.GroupViFrDrEvtCount||0)+1,i.GroupViFrDr=(i.GroupViFrDr||0)+r,i.GroupViFrDrEvtCount=(i.GroupViFrDrEvtCount||0)+1):(t.SparseViFrDr=(t.SparseViFrDr||0)+r,t.SparseViFrDrEvtCount=(t.SparseViFrDrEvtCount||0)+1,i.SparseViFrDr=(i.SparseViFrDr||0)+r,i.SparseViFrDrEvtCount=(i.SparseViFrDrEvtCount||0)+1))})}updateBufferAppended(e,t){this.update(e,({sessionControlRecord:e})=>{e.bufferAppendInfo||(e.bufferAppendInfo=[]),e.bufferAppendInfo.push(t)})}updateSeeked(e,t){this.update(e,({sessionControlRecord:e})=>{e.seekInfo||(e.seekInfo=[]),e.seekInfo.push(t)})}updateManifestParsed(e,r){this.update(e,({sessionControlRecord:e,periodicRecord:t,playEndedRecord:i})=>{t.MasterPlaylistADT=(t.MasterPlaylistADT||0)+r.adt,i.MasterPlaylistADT=(i.MasterPlaylistADT||0)+r.adt;t=this._computeVariantInfo(r.levels);i.IsAudioOnly=r.isAudioOnly,i.IsGapless=r.isGapless,i.IsFirstItem=r.isFirstItem,i.ForInterstitial=r.forInterstitial,i.ItemID=r.itemID,i.MaxVideoQltyIndex=t.maxVideoQltyIndex,i.MaxReWd=t.maxWidth,i.MaxReHt=t.maxHeight,e.manifestData={variantList:t.variantList,varListString:t.varListString}})}updateFragLoaded(e,r){this.update(e,({sessionControlRecord:e,periodicRecord:t,playEndedRecord:i})=>{if(t.MediaRequestsSent=(t.MediaRequestsSent||0)+1,i.MediaRequestsSent=(i.MediaRequestsSent||0)+1,r.cdnServer){const e=r.cdnServer.toLowerCase();"aapl"!==e&&"akam"!==e&&"llnw"!==e||(i.LastMediaCDNServer=e)}r.serverInfo&&(i.ServerInfo=r.serverInfo),e.segmentMimeTypes||(e.segmentMimeTypes=[]),void 0===e.segmentMimeTypes.find(e=>e==r.contentType)&&e.segmentMimeTypes.push(r.contentType),r.fragType===Tu.Variant?(e.variantVideoBytes=(e.variantVideoBytes||0)+r.bytes,e.variantVideoDuration=(e.variantVideoDuration||0)+r.duration,e.intervalVideoBytes=(e.intervalVideoBytes||0)+r.bytes,e.intervalVideoDuration=(e.intervalVideoDuration||0)+r.duration,e.sessionVideoBytes=(e.sessionVideoBytes||0)+r.bytes,e.sessionVideoDuration=(e.sessionVideoDuration||0)+r.duration,e.obrLast=8*r.bytes/(r.duration/1e3),t.NetBytes=(t.NetBytes||0)+r.bytes,t.ADT=(t.ADT||0)+r.adt,t.SegmentProcessTime=(t.SegmentProcessTime||0)+r.processTime,i.ADT=(i.ADT||0)+r.adt,i.NetBytes=(i.NetBytes||0)+r.bytes,i.SegmentProcessTime=(i.SegmentProcessTime||0)+r.processTime):r.fragType===Tu.AltAudio&&(e.variantAudioBytes=(e.variantAudioBytes||0)+r.bytes,e.variantAudioDuration=(e.variantAudioDuration||0)+r.duration,e.intervalAudioBytes=(e.intervalAudioBytes||0)+r.bytes,e.intervalAudioDuration=(e.intervalAudioDuration||0)+r.duration,e.sessionAudioBytes=(e.sessionAudioBytes||0)+r.bytes,e.sessionAudioDuration=(e.sessionAudioDuration||0)+r.duration)})}updateFragBuffered(e,i){this.update(e,({periodicRecord:e,playEndedRecord:t})=>{i.fragType===Tu.Variant&&(e.SegmentParseTime=(e.SegmentParseTime||0)+i.parseTime,t.SegmentParseTime=(t.SegmentParseTime||0)+i.parseTime)})}updateLevelLoaded(e,n){this.update(e,({sessionControlRecord:e,playLikelyToKeepUpRecord:t,periodicRecord:i,playEndedRecord:r})=>{t.PlaylistADT=(t.PlaylistADT||0)+n.adt,i.PlaylistADT=(i.PlaylistADT||0)+n.adt,r.PlaylistADT=(r.PlaylistADT||0)+n.adt,i.MaxPlaylistDT=n.adt>i.MaxPlaylistDT?n.adt:i.MaxPlaylistDT,r.MaxPlaylistDT=n.adt>r.MaxPlaylistDT?n.adt:r.MaxPlaylistDT,r.PlayType=n.playType,r.ContentDur||(r.ContentDur=300*Math.round((n.totalduration||0)/300)),this._setTargetDuration(n.url,n.targetduration,e),e.playlistMimeTypes||(e.playlistMimeTypes=[]),void 0===e.playlistMimeTypes.find(e=>e==n.contentType)&&e.playlistMimeTypes.push(n.contentType);i=n.url,r=this._getVariantInfo(i,e);e.intervalVariantList[i]||(e.intervalVariantList[i]=Object.assign({},r)),e.sessionVariantList[i]||(e.sessionVariantList[i]=Object.assign({},r))})}updateLevelsChanged(e,r){this.update(e,({sessionControlRecord:t,playEndedRecord:e})=>{const i=this._computeVariantInfo(r.levels);e.MaxVideoQltyIndex=i.maxVideoQltyIndex,e.MaxReWd=i.maxWidth,e.MaxReHt=i.maxHeight,t.manifestData={variantList:i.variantList,varListString:i.varListString},Object.keys(i.variantList).forEach(e=>{t.intervalVariantList[e]&&(t.intervalVariantList[e].brRnk=i.variantList[e].brRnk),t.sessionVariantList[e]&&(t.sessionVariantList[e].brRnk=i.variantList[e].brRnk)})})}updateLicenseChallengeRequested(e,r){this.update(e,({sessionControlRecord:e})=>{const t={},i=r.timestamp;t.licenseChallengeStartTime=i,t.forInterstitial=r.forInterstitial,"RTC_STATE_INIT"===e.state&&(t.keyInitTime=i-e.sessionStartTime),e.activeKeySessions[r.keyuri]=t})}updateLicenseChallengeReceived(e,i){this.update(e,({sessionControlRecord:e})=>{const t=e.activeKeySessions[i.keyuri];t.licenseChallengeRequestTime=i.timestamp-t.licenseChallengeStartTime})}updateLicenseChallengeSubmitted(e,i){this.update(e,({sessionControlRecord:e})=>{const t=e.activeKeySessions[i.keyuri];t.keyFormat=i.keyFormat,t.licenseChallengeSubmitTime=i.timestamp})}updateLicenseChallengeCreated(e,i){this.update(e,({sessionControlRecord:e})=>{const t=e.activeKeySessions[i.keyuri];t.cdmVersion=i.cdmVersion,t.licenseChallengeCreationTime=i.timestamp-t.licenseChallengeSubmitTime})}updateLicenseResponseRequested(e,t){this.update(e,({sessionControlRecord:e})=>{e.activeKeySessions[t.keyuri].licenseResponseRequestTime=t.timestamp})}updateLicenseResponseReceived(e,i){this.update(e,({sessionControlRecord:e})=>{const t=e.activeKeySessions[i.keyuri];t.licenseResponseReceiveTime=i.timestamp-t.licenseResponseRequestTime})}updateLicenseResponseSubmitted(e,t){this.update(e,({sessionControlRecord:e})=>{e.activeKeySessions[t.keyuri].licenseResponseSubmitTime=t.timestamp})}updateWaitForCanPlay(e){this.update(e,({sessionControlRecord:e})=>{e.lastWaitForCanPlay=performance.now()})}_prepareEventPlayEnded(e){this.update(e,({sessionControlRecord:e,playEndedRecord:t})=>{t.AvgVideoBitrate=8*(e.sessionVideoBytes||0)/(e.sessionVideoDuration||1),t.AvgAudioBitrate=8*(e.sessionAudioBytes||0)/(e.sessionAudioDuration||1);var i=1e3*Math.round((t.NetBytes||0)/1e3);t.NetBytes=i;var r=t.ADT||1,n=t.ADT+t.SegmentProcessTime||1,s=t.ADT+t.SegmentProcessTime+t.SegmentParseTime||1;t.TWOBR=8*i/(r/1e3),t.PerceivedTWOBR=8*i/(n/1e3),t.NetTWOBR=8*i/(s/1e3);var s=this._findTimeWeightedValues("RTC_STATE_PLAY"===e.state?performance.now()-e.eventStartTime:0,e.sessionVariantList,e.curLevelUrl);t.PlayerTWIBR=s.twIBR,t.PlayerTWIABR=s.twIABR,t.TWBitRk=s.twBRnk;s=this._getVariantInfo(e.curLevelUrl,e);t.TargetDur=s.targetduration,t.ReWd=s.width,t.ReHt=s.height,t.VariantList=null===(s=e.manifestData)||void 0===s?void 0:s.varListString;let a="";e.playlistMimeTypes&&(e.playlistMimeTypes.forEach(e=>{a+=e+","}),a=a.slice(0,-1));let o="";e.segmentMimeTypes&&(e.segmentMimeTypes.forEach(e=>{o+=e+","}),o=o.slice(0,-1)),t.PlaylistMimeType=a,t.SegmentMimeType=o,t.Rate=e.rate}),this._aggregateTimes(e)}_prepareEventPeriodic(e,o){this.update(e,({sessionControlRecord:e,periodicRecord:t,playEndedRecord:i})=>{t.EventCounter=e.periodicEventCounter,t.PInterval=performance.now()-e.lastPeriodicTime,t.AvgVideoBitrate=8*(e.intervalVideoBytes||0)/(e.intervalVideoDuration||1),t.AvgAudioBitrate=8*(e.intervalAudioBytes||0)/(e.intervalAudioDuration||1);let r=t.NetBytes||0;o.isFinal&&(t.NetBytes=r=1e3*Math.round(r/1e3));var n=t.ADT||1,s=t.ADT+t.SegmentProcessTime||1,a=t.ADT+t.SegmentProcessTime+t.SegmentParseTime||1;t.TWOBR=8*r/(n/1e3),t.PerceivedTWOBR=8*r/(s/1e3),t.NetTWOBR=8*r/(a/1e3);var a=this._findTimeWeightedValues("RTC_STATE_PLAY"===e.state?performance.now()-e.eventStartTime:0,e.intervalVariantList,e.curLevelUrl);t.PlayerTWIBR=a.twIBR,t.PlayerTWIABR=a.twIABR,t.TWBitRk=a.twBRnk;a=this._getVariantInfo(e.curLevelUrl,e);t.TargetDur=a.targetduration,t.ReWd=a.width,t.ReHt=a.height,t.VariantList=null===(a=e.manifestData)||void 0===a?void 0:a.varListString,t.Rate=e.rate;e=this._computeMediaStats(e);e&&(t.MedianBufferAppendLatency=e.bufLatencyInfo.median,t.MaxBufferAppendLatency=e.bufLatencyInfo.max,t.MedianBufferAppendSize=e.bufSizeInfo.median,t.MaxBufferAppendSize=e.bufSizeInfo.max,t.MedianSeekLatency=e.seekLatencyInfo.median,t.MaxSeekLatency=e.seekLatencyInfo.max,t.MedianPlayLatency=e.playLatencyInfo.median,t.MaxPlayLatency=e.playLatencyInfo.max),this._copyCommonKeys(t,i)}),this._aggregateTimes(e)}_prepareEventPlayStalled(e,s){this.update(e,({sessionControlRecord:e,playStalledRecord:t,playEndedRecord:i})=>{var r=this._getVariantInfo(e.curLevelUrl,e),n=performance.now();t.MediaDur=s.mediaDur,t.BitRnk=r.brRnk,t.Codecs=r.codecs,t.LastLikelyToKeepUp=n-e.lastLikelyToKeepUpTime,t.LastSwitch=n-e.lastSwitchTime,t.StallDetectionTime=s.stallDurationMs,t.StallType=s.type,t.BufferLength=s.bufferLen,"networkError"===i.ErrDomain&&(t.NwErrTime=i.NwErrTime,t.NwErrCode=i.ErrCode),t.LaSwDir=e.lastSwitchDir,t.TargetDur=r.targetduration,t.PlayerIABR=r.avgBandwidth,t.PlayerIBR=r.bandwidth,t.Rate=e.rate,t.OBRLast=e.obrLast,t.OBRMean=8*i.NetBytes/(i.ADT/1e3),t.ForInterstitial=s.forInterstitial,this._copyCommonKeys(t,i)}),this._aggregateTimes(e)}_prepareEventKeySessionComplete(e,r){this.update(e,({sessionControlRecord:e,keySessionCompleteRecord:t,playEndedRecord:i})=>{e=e.activeKeySessions[r.keyuri];e?(t.KeyFormat=e.keyFormat,t.CDMVersion=e.cdmVersion,t.LicenseChallengeRequestTime=e.licenseChallengeRequestTime,t.LicenseChallengeCreationTime=e.licenseChallengeCreationTime,t.LicenseResponseReceiveTime=e.licenseResponseReceiveTime,t.LicenseResponseProcessTime=e.licenseResponseProcessTime,t.KeyDeliveryTime=e.keyDeliveryTime,t.CurrentMediaTime=1e3*e.currentMediaTime,t.KeyInitTime=e.keyInitTime,t.KeyErrorType=e.keyErrorType,t.ForInterstitial=e.forInterstitial,this._copyCommonKeys(t,i)):this.logger.warn(`_prepareEventKeySessionComplete no keySessionInfo for ${re(r.keyuri)}`)}),this._aggregateTimes(e)}_prepareEventPlayLikelyToKeepUp(e,n){this.update(e,({sessionControlRecord:e,playLikelyToKeepUpRecord:t,playEndedRecord:i})=>{var r=this._getVariantInfo(e.curLevelUrl,e);t.EventCounter=e.playLikelyToKeepUpEventCounter,t.PlayerIABR=r.avgBandwidth,t.PlayerIBR=r.bandwidth,t.MediaDur=n.mediaDur,t.BitRnk=r.brRnk,t.Codecs=r.codecs,t.TargetDur=r.targetduration,t.ForInterstitial=n.forInterstitial,this._copyCommonKeys(t,i)}),this._aggregateTimes(e)}_prepareEventPlayRateChanged(e,n){this.update(e,({sessionControlRecord:e,playRateChangedRecord:t,playEndedRecord:i})=>{var r=this._getVariantInfo(e.curLevelUrl,e);t.Rate=e.rate,t.StNPT=n.currentTime,t.PlayerIABR=r.avgBandwidth,t.PlayerIBR=r.bandwidth,t.BitRnk=r.brRnk,t.MediaDur=n.mediaDur,t.Codecs=r.codecs,t.ForInterstitial=n.forInterstitial,this._copyCommonKeys(t,i)}),this._aggregateTimes(e)}_prepareEventPlayError(e,s){this.update(e,({sessionControlRecord:e,playErrorRecord:t,playEndedRecord:i})=>{var r=this._getVariantInfo(e.curLevelUrl,e),n=performance.now();"mediaElementError"==s.domain?(t.ErrDomain=t.ErrCode="mediaElementError",t.ErrIsFatal=!0,t.ErrCodeMediaElement=s.mediaElemCode,t.ErrReason=s.mediaElemReason,t.ErrDetail=s.mediaElemDetail):(t.ErrCode=s.details,t.ErrReason=s.code,t.ErrIsFatal=s.fatal,t.ErrDomain="mediaError"),t.PlayerErrCount=s.count||1,t.BitRnk=r.brRnk,t.MediaDur=s.mediaDur,t.PlayTime=i.PlayTime,t.PlayTimeWC=i.PlayTimeWC,t.PlayerIABR=r.avgBandwidth,t.PlayerIBR=r.bandwidth,t.LastLikelyToKeepUp=n-e.lastLikelyToKeepUpTime,t.LastSwitch=n-e.lastSwitchTime,t.VideoQltyIndex=r.qltyIndex,t.Rate=e.rate,t.KeyErrorType=e.lastKeyErrorType,t.KeyDeliveryTime=e.lastKeyDeliveryTime,t.ForInterstitial=s.forInterstitial,this._copyCommonKeys(t,i)}),this._aggregateTimes(e)}_prepareEventMediaEngineStalled(e,s){this.update(e,({sessionControlRecord:e,mediaEngineStalledRecord:t,playEndedRecord:i})=>{var r=performance.now(),n=this._getVariantInfo(e.curLevelUrl,e);t.MediaDur=s.mediaDur,t.BitRnk=n.brRnk,t.Codecs=n.codecs,t.LastLikelyToKeepUp=r-e.lastLikelyToKeepUpTime,t.LastSwitch=r-e.lastSwitchTime,t.StallDetectionTime=s.stallDurationMs,t.StallType=s.type,t.BufferLength=s.bufferLen,t.LaSwDir=e.lastSwitchDir,t.TargetDur=n.targetduration,t.PlayerIABR=n.avgBandwidth,t.PlayerIBR=n.bandwidth,t.Rate=e.rate,t.OBRLast=e.obrLast,t.OBRMean=8*i.NetBytes/(i.ADT/1e3),t.ForInterstitial=s.forInterstitial,this._copyCommonKeys(t,i)}),this._aggregateTimes(e)}_prepareEventSwitchComplete(e,s){this.update(e,({sessionControlRecord:e,switchCompleteRecord:t,playEndedRecord:i})=>{var r=this._getVariantInfo(e.prevLevelUrl,e),n=this._getVariantInfo(e.curLevelUrl,e);t.FrBitRnk=r.brRnk,t.ToBitRnk=n.brRnk,t.TimeToBitrate=performance.now()-e.sessionStartTime,t.MediaDur=s.mediaDur,t.Rate=e.rate,t.PlayerIBR=n.bandwidth,t.PlayerIABR=n.avgBandwidth,t.LastPlayerIBR=r.bandwidth,t.LastPlayerIABR=r.avgBandwidth,t.ReWd=n.width,t.ReHt=n.height,t.ForInterstitial=s.forInterstitial,this._copyCommonKeys(t,i)}),this._aggregateTimes(e)}_prepareEventVariantEnded(e,n){this.update(e,({sessionControlRecord:e,variantEndedRecord:t,playEndedRecord:i})=>{var r=this._getVariantInfo(e.curLevelUrl,e);t.Rate=e.rate,t.VarAvgBitrate=r.avgBandwidth,t.VarPeakBitrate=r.bandwidth,t.VarBitRk=r.brRnk,t.VarSTTime=e.variantStartTimeMedia,t.VarEndTime=1e3*n.currentTime,t.IFR=r.framerate,t.ODR=e.decodedFramesForVariant/e.decodedFramesForVariantSampleCount,t.ReWd=r.width,t.ReHt=r.height,t.Codecs=r.codecs,t.AvgVideoBitrate=8*(e.variantVideoBytes||0)/(e.variantVideoDuration||1),t.AvgAudioBitrate=8*(e.variantAudioBytes||0)/(e.variantAudioDuration||1),t.ForInterstitial=n.forInterstitial,this._copyCommonKeys(t,i)}),this._aggregateTimes(e)}_prepareEventNwError(e,n){this.update(e,({sessionControlRecord:e,nwErrorRecord:t,playEndedRecord:i})=>{var r=this._getVariantInfo(e.curLevelUrl,e);t.ErrCode=n.details,t.ErrReason=n.code,t.ErrIsFatal=n.fatal,t.NwErrCount=n.count||1,t.ErrDomain="networkError",t.PlayTime=i.PlayTime,t.PlayTimeWC=i.PlayTimeWC,t.BitRnk=r.brRnk,t.Rate=e.rate,t.KeyErrorType=e.lastKeyErrorType,t.KeyDeliveryTime=e.lastKeyDeliveryTime,t.ForInterstitial=n.forInterstitial,this._copyCommonKeys(t,i)}),this._aggregateTimes(e)}_copyCommonKeys(e,t){e.HLSJSVersion=t.HLSJSVersion,e.PlayType=t.PlayType,e.LastMediaCDNServer=t.LastMediaCDNServer,e.MaxVideoQltyIndex=t.MaxVideoQltyIndex,e.MaxReWd=t.MaxReWd,e.MaxReHt=t.MaxReHt,e.InterstitialsEnabled=t.InterstitialsEnabled,e.IsGapless=t.IsGapless,e.IsLoopingPlayer=t.IsLoopingPlayer,e.IsAudioOnly=t.IsAudioOnly,e.IsFirstItem=t.IsFirstItem,e.ItemID=t.ItemID,e.ServerInfo=t.ServerInfo,e.TestGroupId=t.TestGroupId}_computeVariantInfo(e){const r={};let n=0,s=0,a=0,o=0;const l=this._getMaxNormalizedPeak(e);e.forEach(e=>{var t=this._getVideoFourCC(e.levelCodec),i=this._getVideoQualityIndex(t,e.videoRange)||0,t={codecs:e.levelCodec,width:e.width,height:e.height,bandwidth:e.bandwidth,avgBandwidth:e.avgBandwidth,framerate:e.frameRate,iframes:e.iframes,brRnk:this._getBitrateRank(e.bandwidth,t,l),qltyIndex:i,targetduration:0,playTime:0};o=i>o?i:o,r[e.url]=t;t=e.width*e.height;t>a&&(a=t,n=e.width,s=e.height)});e=0<Object.keys(r).length?Object.values(r).map(e=>e.bandwidth+":"+e.avgBandwidth).join(","):void 0;return{variantList:r,varListString:e,maxVideoQltyIndex:o,maxWidth:n,maxHeight:s}}_getMaxNormalizedPeak(e){let i=0;return e.forEach(e=>{var t=e.bandwidth||0,e=this._getNormalizedPeak(t,this._getVideoFourCC(e.levelCodec)),e=Math.max(t,e);i=e>i?e:i}),i}_getNormalizedPeak(e,t){return"object"==typeof vm[t]?1.5*e:+e}_getVideoFourCC(e){return e&&e.split(",").map(e=>e.split(".")[0].trim()).find(e=>!!vm[e])}_getVideoQualityIndex(e,t){return"object"==typeof vm[e]?vm[e][t]:vm[e]}_getBitrateRank(e,t,i){t=Math.max(1,this._getNormalizedPeak(e,t));return Math.ceil(100*t/i)}_findTimeWeightedValues(o,l,d){const e={twBRnk:0,twIBR:0,twIABR:0};if(l){let i=0,r=0,n=0,s=0,a=0;Object.values(l).forEach(e=>{let t=e.playTime;e===l[d]&&(t+=o||0),t&&(r+=e.bandwidth*t,i+=e.brRnk*t,n+=t,e.avgBandwidth&&(s+=e.avgBandwidth*t,a+=t))}),n&&(e.twBRnk=i/n,e.twIBR=r/n),s&&a&&(e.twIABR=s/a)}return e}_computeMediaStats(e){const t=e.bufferAppendInfo;let i=[];const r=[];t&&t.forEach&&t.forEach(e=>{i.push(e.latency),r.push(e.size)});var n=this._computeStats(i),s=this._computeStats(r),a=e.seekInfo;i=[],a&&a.forEach&&e.seekInfo.forEach(e=>i.push(e.latency));var o=this._computeStats(i),a=e.playInfo;return i=[],a&&a.forEach&&e.playInfo.forEach(e=>i.push(e.latency)),{bufLatencyInfo:n,bufSizeInfo:s,seekLatencyInfo:o,playLatencyInfo:this._computeStats(i)}}_computeStats(e){let t,i;if(e){const r=e.filter(e=>0<e);if(0<r.length){t=r.reduce((e,t)=>Math.max(e,t));const e=r.length,n=r.sort((e,t)=>e-t),s=Math.ceil(e/2);i=e%2==0?(n[s]+n[s-1])/2:n[s-1]}}return{max:t,median:i}}_getVariantInfo(e,t){return e&&t.manifestData&&t.manifestData.variantList&&t.manifestData.variantList[e]?t.manifestData.variantList[e]:{}}_setTargetDuration(e,t,i){e&&i.manifestData&&i.manifestData.variantList&&i.manifestData.variantList[e]&&(i.manifestData.variantList[e].targetduration=t)}_isIFrameToggle(e,t){e=Math.abs(e),t=Math.abs(t);return e!==t&&(1<e||1<t)&&!(1<e&&1<t)}_isBadSw(e,t,i,r,n,s,a){let o=n-s<1e4&&t!==e&&r===i&&!a?!0:!1;return o}_aggregateTimes(e){this.update(e,({sessionControlRecord:t,playStalledRecord:i,mediaEngineStalledRecord:r,switchCompleteRecord:n,playRateChangedRecord:s,variantEndedRecord:a,playErrorRecord:o,nwErrorRecord:l,periodicRecord:d,playEndedRecord:u})=>{var c=performance.now()-t.eventStartTime;switch(t.state){case"RTC_STATE_INIT":case"RTC_STATE_CANPLAY":d.InitTime=(d.InitTime||0)+c,u.InitTime=(u.InitTime||0)+c;break;case"RTC_STATE_PAUSE":d.PauseTime=(d.PauseTime||0)+c,u.PauseTime=(u.PauseTime||0)+c,s.LastPause=(s.LastPause||0)+c,u.LastPause=(u.LastPause||0)+c,o.LastPause=(o.LastPause||0)+c,l.LastPause=(l.LastPause||0)+c;break;case"RTC_STATE_STALL":a.StallTime=(a.StallTime||0)+c,d.StallTime=(d.StallTime||0)+c,u.StallTime=(u.StallTime||0)+c,s.LastStall=(s.LastStall||0)+c,o.LastStall=(o.LastStall||0)+c,u.LastStall=(u.LastStall||0)+c;break;case"RTC_STATE_MEDIAENGINESTALL":a.MediaEngineStallTime=(a.MediaEngineStallTime||0)+c,d.MediaEngineStallTime=(d.MediaEngineStallTime||0)+c,u.MediaEngineStallTime=(u.MediaEngineStallTime||0)+c,s.LastMediaEngineStall=(s.LastMediaEngineStall||0)+c,o.LastMediaEngineStall=(o.LastMediaEngineStall||0)+c,u.LastMediaEngineStall=(u.LastMediaEngineStall||0)+c;break;case"RTC_STATE_NWERROR":u.NwErrTime=(u.NwErrTime||0)+c,d.NwErrTime=(d.NwErrTime||0)+c;break;case"RTC_STATE_PLAYERROR":d.PlayErrTime=(d.PlayErrTime||0)+c,u.PlayErrTime=(u.PlayErrTime||0)+c;break;case"RTC_STATE_PLAY":{s.RateChangePlayTime=(s.RateChangePlayTime||0)+c,n.PlayTime=(n.PlayTime||0)+c,n.PlayTimeLastSW=(n.PlayTimeLastSW||0)+c*(t.oldRate/100),i.LastResume=(i.LastResume||0)+c,r.LastResume=(r.LastResume||0)+c,o.LastResume=(o.LastResume||0)+c,l.LastResume=(l.LastResume||0)+c;const p=(i.StallDetectionTime||0)+(r.StallDetectionTime||0);a.VarPlayTimeWC=(a.VarPlayTimeWC||0)+c-p,a.VarPlayTime=(a.VarPlayTime||0)+c*(t.oldRate/100)-p,d.PlayTimeWC=(d.PlayTimeWC||0)+c-p,d.PlayTime=(d.PlayTime||0)+c*(t.oldRate/100)-p,u.PlayTimeWC=(u.PlayTimeWC||0)+c-p,u.PlayTime=(u.PlayTime||0)+c*(t.oldRate/100)-p,r.PlayTime=u.PlayTime,i.PlayTime=u.PlayTime;var h=t.curLevelUrl;let e=t.intervalVariantList[h];if(!e){this.logger.warn("RTC_STATE_PLAY > missing variantInfo for url");break}e.playTime=(e.playTime||0)+c,e=t.sessionVariantList[h],e.playTime=(e.playTime||0)+c;break}}})}}const Im={name:"rtc-service"};class Em{constructor(e,t,i,r,n){this.hls=e,this.config=t,this.hlsjsVersion=i,this.accessLog=r,this.logger=n,this.destroy$=new Jt,this.isSeeking=!1,this.seekStart=null,this.periodicInterval=t.rtcIntervalTimeout||3e5,this.intervalFunc=null,this.rtcStore=new Tm(this.logger),this.rtcQuery=new bm(this.rtcStore,this.logger),this.rtcComponent=new Sm(this.rtcQuery,this.logger),r.setRTCQuery(this.rtcQuery)}destroy(){this.destroy$.next(),this.clearPeriodic(),this.rtcStore.reset()}detachMedia(){this.clearPeriodic();var e;try{e=this.hls.realCurrentTime,this.rtcStore.updateVariantEnd(this.rtcEventItemId(!0),{currentTime:e,forInterstitial:this.hls.interstitialActive}),this.sendAndFinalize(this.rtcEventItemId(!0),ym.VariantEnded),this.rtcStore.updatePeriodic(this.rtcEventItemId(!0),!0),this.sendAndFinalize(this.rtcEventItemId(!0),ym.Periodic),this.rtcStore.updateEnded(this.rtcEventItemId(!0)),this.sendAndFinalize(this.rtcEventItemId(!0),ym.PlayEnded)}catch(e){this.logger.warn(Im,e)}}handleError(e,t){var i;e instanceof mc&&!e.fatal?(this.rtcStore.updateLevelLoadError(this.rtcEventItemId(),{url:e.url,mediaDur:this.hls.bufferedDuration,isSeeking:this.isSeeking,forInterstitial:t}),this.sendAndFinalize(this.rtcEventItemId(),ym.SwitchComplete)):e.type===M.NETWORK_ERROR?(this.rtcStore.updateNwError(this.rtcEventItemId(),{fatal:e.fatal,details:e.details,code:null===(i=e.response)||void 0===i?void 0:i.code,forInterstitial:t}),this.sendAndFinalize(this.rtcEventItemId(),ym.NwError)):(this.rtcStore.updateMediaError(this.rtcEventItemId(),{fatal:e.fatal,details:e.details,code:null===(e=e.response)||void 0===e?void 0:e.code,forInterstitial:t}),this.sendAndFinalize(this.rtcEventItemId(),ym.PlayError))}handleMediaElementError(e,t){this.rtcStore.updateMediaElementError(this.rtcEventItemId(),e,t),this.sendAndFinalize(this.rtcEventItemId(),ym.PlayError)}handleConfigLoaded(t){var e=this.rtcEventItemId();this.rtcStore.update(e,({playEndedRecord:e})=>{e.TestGroupId=t})}handleFragLoaded(e,t,i){var r,n,s;this.checkMediaOptionType(t.mediaOptionType)&&(e!==this.rtcEventItemId()&&this.logger.warn(Im,`Frag id does not match current item id. Frag Id=${e}, playing id=${this.rtcEventItemId()}, loading id=${null===(s=this.hls.loadingItem)||void 0===s?void 0:s.itemId}`),r=i.tload-i.trequest,n=i.tload-i.tfirst,s=this.serverInfoInstance||{},this.rtcStore.updateFragLoaded(e,{fragType:t.mediaOptionType,bytes:i.loaded,duration:t.duration,adt:r,processTime:n,contentType:i.contentType,cdnServer:i.cdnServer,serverInfo:s}),this.accessLog.updateFragLoaded(e,this.isSeeking,{fragType:t.mediaOptionType,bytes:i.loaded,duration:t.duration,adt:r,processTime:n,startPTS:t.start,endPTS:t.start+t.duration}))}handleFragBuffered(e){var t;this.checkMediaOptionType(e.fragmentType)&&(t=e.endDataAppend-e.startDataAppend,this.rtcStore.updateFragBuffered(this.rtcEventItemId(),{fragType:e.fragmentType,bytes:e.dataBytesAppend,parseTime:t}))}handleLevelLoaded(e,t,i){if(t){if(e!==this.rtcEventItemId()&&this.logger.warn(Im,`media option id does not match current item id. media Id=${e}, current id=${this.rtcEventItemId()}`),t.mediaOptionType===Tu.Variant){const e=i.tload-i.trequest;this.rtcStore.updateLevelLoaded(this.rtcEventItemId(),{url:t.url,targetduration:t.targetduration,totalduration:t.totalduration,adt:e,contentType:i.contentType,playType:t.type})}}else this.logger.warn(`handleLevelLoaded called with mediaOptionDetails as ${t}`)}handleLevelSwitched(e,t){var i={url:e.url,isSeeking:this.isSeeking,mediaDur:this.hls.bufferedDuration,currentTime:this.hls.realCurrentTime,forInterstitial:t};e.oldVariant&&(this.rtcStore.updateVariantEnd(this.rtcEventItemId(),{currentTime:this.hls.realCurrentTime,forInterstitial:t}),this.sendAndFinalize(this.rtcEventItemId(),ym.VariantEnded)),this.rtcStore.updateLevelSwitched(this.rtcEventItemId(),i),this.sendAndFinalize(this.rtcEventItemId(),ym.SwitchComplete)}handleLevelSwitching(e){this.levelSwitchingUrl=e}handleLevelsChanged(e){this.rtcStore.updateLevelsChanged(this.rtcEventItemId(),{levels:e})}handleManifestParsed(e){var t=e.stats.tload-e.stats.trequest;this.rtcStore.updateManifestParsed(this.rtcEventItemId(),{levels:e.levels,adt:t,contentType:e.stats.contentType,isAudioOnly:this.hls.inGaplessMode,isGapless:this.hls.inGaplessMode,isFirstItem:this.hls.isFirstItem,itemID:((null===(e=this.hls.reportingAgent)||void 0===e?void 0:e.SessionID)||Zl())+"-"+this.rtcEventItemId(),forInterstitial:this.hls.interstitialActive})}handleSeek(e){if("SEEKING"===e)this.isSeeking=!0,this.seekStart=performance.now();else if("SEEKED"===e){this.isSeeking=!1;let e=0;this.seekStart&&(e=performance.now()-this.seekStart),this.seekStart=null,this.rtcStore.updateSeeked(this.rtcEventItemId(!0),{latency:e})}}handleDesiredRateChanged(e,t){0===t||1<Math.abs(e)&&1<Math.abs(t)?(this.rtcStore.updateRateChanged(this.rtcEventItemId(!0),{rate:t,latency:0,mediaDur:this.hls.bufferedDuration,currentTime:this.hls.realCurrentTime,url:this.levelSwitchingUrl,forInterstitial:this.hls.interstitialActive}),this.sendAndFinalize(this.rtcEventItemId(!0),ym.PlayRateChanged)):(1!==e&&1===t&&(this.playStart=performance.now()),this.rtcStore.updateWaitForCanPlay(this.rtcEventItemId(!0))),this.oldRate=e,this.newRate=t}handleVariantBufferAppended(e){var t;Z(e.startAppend)&&Z(e.endAppend)&&(t=e.endAppend-e.startAppend,this.rtcStore.updateBufferAppended(this.rtcEventItemId(),{latency:t,size:e.bytesAppend}))}handleStalled(e,t,i){t={type:e.type,stallDurationMs:e.stallDurationMs,bufferLen:t,mediaDur:this.hls.bufferedDuration,forInterstitial:i},i=this.rtcQuery.getEntity(this.rtcEventItemId(!0)).sessionControlRecord.state;e.type===rf.LowBuffer||e.type===rf.Seek&&e.isLowBufferStall?"RTC_STATE_PLAY"===i&&(this.rtcStore.updateBufferStalled(this.rtcEventItemId(!0),t),this.sendAndFinalize(this.rtcEventItemId(!0),ym.PlayStalled)):"RTC_STATE_PLAY"===i&&(this.rtcStore.updateMediaEngineStalled(this.rtcEventItemId(!0),t),this.sendAndFinalize(this.rtcEventItemId(!0),ym.MediaEngineStalled))}handlePlaybackInfo(e,t){this.rtcStore.updatePlaybackInfo(this.rtcEventItemId(!0),{droppedVideoFrames:e,decodedFrameCount:t}),this.accessLog.updatePlaybackInfo(this.rtcEventItemId(!0),{droppedVideoFrames:e,decodedFrameCount:t})}checkMediaOptionType(e){return e===Tu.Variant||e===Tu.AltAudio||(this.logger.error(Im,'Should not have media option type = "%s" in RTC',Gu[e]),!1)}rtcEventItemId(e=!1,t=!1){var i;let r=this.hls.currentItem;return this.hls.isPreloading&&(r=e?this.hls.playingItem:this.hls.loadingItem),null==r?null:!t&&null!==(i=r.parentItemId)&&void 0!==i?i:r.itemId}itemTransitioned(e,t){this.rtcStore.updateVariantEnd(e,{currentTime:this.hls.realCurrentTime,forInterstitial:this.hls.interstitialActive}),this.sendAndFinalize(e,ym.VariantEnded),this.rtcStore.updatePeriodic(e,!0),this.sendAndFinalize(e,ym.Periodic),this.rtcStore.updateEnded(e),this.sendAndFinalize(e,ym.PlayEnded),this.setPeriodic(t)}removeItemList(e){e.forEach(e=>{this.rtcStore.removeEntityByID(e)})}keyRequestStarted(e,t){e.timestamp=performance.now(),e.forInterstitial=t,this.rtcStore.updateLicenseChallengeRequested(this.rtcEventItemId(),e)}keyLoaded(e,t){e.timestamp=performance.now(),e.currentTime=this.hls.realCurrentTime,e.forInterstitial=t,this.rtcStore.updateSegmentKeyLoaded(this.rtcEventItemId(),e)}licenseChallengeReceived(e){this.rtcStore.updateLicenseChallengeReceived(this.rtcEventItemId(),{timestamp:performance.now(),keyuri:e.keyuri})}licenseChallengeSubmitted(e){this.rtcStore.updateLicenseChallengeSubmitted(this.rtcEventItemId(),{timestamp:performance.now(),keyFormat:e.keyFormat,keyuri:e.keyuri})}licenseChallengeCreated(e){this.rtcStore.updateLicenseChallengeCreated(this.rtcEventItemId(),{timestamp:performance.now(),cdmVersion:e.cdmVersion,keyuri:e.keyuri}),this.rtcStore.updateLicenseResponseRequested(this.rtcEventItemId(),{timestamp:performance.now(),keyuri:e.keyuri})}licenseResponseSubmitted(e){this.rtcStore.updateLicenseResponseReceived(this.rtcEventItemId(),{timestamp:performance.now(),keyuri:e.keyuri}),this.rtcStore.updateLicenseResponseSubmitted(this.rtcEventItemId(),{timestamp:performance.now(),keyuri:e.keyuri})}licenseResponseProcessed(e){this.rtcStore.updateLicenseResponseProcessed(this.rtcEventItemId(),{timestamp:performance.now(),keyuri:e.keyuri,currentTime:this.hls.realCurrentTime}),this.sendAndFinalize(this.rtcEventItemId(),ym.KeySessionComplete)}licenseChallengeError(e){this.rtcStore.updateLicenseChallengeError(this.rtcEventItemId(),{timestamp:performance.now(),keyuri:e.keyuri}),this.sendAndFinalize(this.rtcEventItemId(),ym.KeySessionComplete)}licenseResponseError(e){this.rtcStore.updateLicenseResponseError(this.rtcEventItemId(),{timestamp:performance.now(),keyuri:e.keyuri}),this.sendAndFinalize(this.rtcEventItemId(),ym.KeySessionComplete)}keyAborted(e){var t;null!=(null===(t=this.rtcQuery.getEntity(this.rtcEventItemId()))||void 0===t?void 0:t.sessionControlRecord.activeKeySessions[e.keyuri])?(this.rtcStore.updateKeyAborted(this.rtcEventItemId(),{timestamp:performance.now(),keyuri:e.keyuri}),this.sendAndFinalize(this.rtcEventItemId(),ym.KeySessionComplete)):this.logger.warn(`keyAbort called without active key session ${re(e.keyuri)}`)}setPeriodic(e){this.clearPeriodic(),this.intervalFunc=setInterval(this.handlePeriodic.bind(this,e),this.periodicInterval)}interstitialStarted(e){this.sendAndFinalize(e,ym.InterstitialStarted)}interstitialAssetStarted(e){this.sendAndFinalize(e,ym.InterstitialAssetStarted)}interstitialAssetEnded(e,t){this.rtcStore.updateInterstitialPlayTime(e,t),this.sendAndFinalize(e,ym.InterstitialAssetEnded)}interstitialEnded(e){this.sendAndFinalize(e,ym.InterstitialEnded)}handlePeriodic(e){this.rtcStore.updatePeriodic(e,!1),this.sendAndFinalize(e,ym.Periodic)}clearPeriodic(){this.intervalFunc&&clearInterval(this.intervalFunc),this.intervalFunc=null}sendAndFinalize(e,t){switch(this.accessLog.addPlayTime(e),t){case ym.PlayEnded:this.rtcComponent.sendPlayEnded(e);break;case ym.Periodic:this.rtcComponent.sendPeriodic(e);break;case ym.PlayStalled:this.accessLog.updateStallCount(e),this.rtcComponent.sendPlayStalled(e);break;case ym.KeySessionComplete:this.rtcComponent.sendKeySessionComplete(e);break;case ym.PlayLikelyToKeepUp:this.accessLog.updateCanPlay(e),this.rtcComponent.sendPlayLikelyToKeepUp(e);break;case ym.PlayRateChanged:this.rtcComponent.sendPlayRateChange(e);break;case ym.PlayError:this.accessLog.addToErrorLog(e,"mediaError"),this.rtcComponent.sendPlayError(e);break;case ym.MediaEngineStalled:this.accessLog.updateMediaEngineStallCount(e),this.rtcComponent.sendMediaEngineStalled(e);break;case ym.SwitchComplete:this.accessLog.addToAccessLog(e),this.rtcComponent.sendSwitchComplete(e);break;case ym.VariantEnded:this.rtcComponent.sendVariantEnded(e);break;case ym.NwError:this.accessLog.addToErrorLog(e,"networkError"),this.rtcComponent.sendNwError(e);break;case ym.InterstitialStarted:this.rtcComponent.sendInterstitialStart(e);break;case ym.InterstitialAssetStarted:this.rtcComponent.sendInterstitialAssetStart(e);break;case ym.InterstitialAssetEnded:this.rtcComponent.sendInterstitialAssetEnd(e);break;case ym.InterstitialEnded:this.rtcComponent.sendInterstitialEnd(e);break;default:return void this.logger.error(Im,`Unknown rtc event eventGroupId:${e}`)}this.rtcStore.finalize(e,t)}}const wm=a=>(e,t)=>{let i=0,r=0;for(var{timestamp:n,value:s}of e){const e=Math.pow(Math.max(0,n-t)/1e3,a);i+=e*s,r+=e}return i/r},Om={"uniform-time-weighted":wm(0),"linear-time-weighted":wm(1),"quadratic-time-weighted":wm(2)};function Am(e,t){return e.start!==t.start?e.start-t.start:e.end-t.end}function Rm(e,t,i){let r=e.length-1;for(;0<=r&&i(t,e[r])<=0;)--r;e.splice(r+1,0,t)}class km{constructor(e,t="quadratic-time-weighted",i={avgLatencyMs:NaN,avgBandwidth:NaN}){this.windowSize=e,this.aggregationMethod=t,this.latencyEntries=[],this.bandwidthEntries=[],this.minEntries=1,this.cleanUpExpiredEntries=this.cleanUpExpiredEntries.bind(this),this.bwSubject=new Si(i)}get estimate$(){return this.bwSubject.asObservable()}record(e){var{trequest:t,tfirst:i,tload:r,bitsDownloaded:e}=e;t!==r&&(this.recordLatency(t,i),this.recordBandwidth(t,r,1e3*e/(r-t)),this.bwSubject.closed||(t=this.getEstimate(),this.bwSubject.next(t)))}getEstimate(){if(this.latencyEntries.length<this.minEntries)return{avgLatencyMs:NaN,avgBandwidth:NaN};const e=performance.now()-this.windowSize,t=Om[this.aggregationMethod],i=this.latencyEntries.map(({start:e,end:t})=>({timestamp:t,value:t-e,duration:1}));this.bandwidthEntries=function(r){function n(t,i){if(t.length){for(let e=0;e<t.length;e++)if(t[e].start>i.start||t[e].start===i.start&&t[e].end>i.end){t.splice(e,0,i);break}}else t.push(i)}const t=[];for(;r.length;){const o=r[0];let e;if(r.shift(),t.length&&(e=t[t.length-1]),0===t.length||e.end<=o.start)t.push(o);else if(o.start===e.start)o.end===e.end?e.bitsPerSec+=o.bitsPerSec:o.end<e.end||(e.bitsPerSec+=o.bitsPerSec,o.start=e.end,n(r,o));else{var s=e.end,a=e.bitsPerSec;e.end=o.start;var i={start:o.start,end:Math.min(s,o.end),bitsPerSec:o.bitsPerSec+a};if(t.push(i),s!==o.end){let e=0,t=0,i=0;i=s<o.end?(e=s,t=o.end,o.bitsPerSec):(e=o.end,t=s,a),n(r,{start:e,end:t,bitsPerSec:i})}}}return t}(this.bandwidthEntries);var r=this.bandwidthEntries.map(({end:e,bitsPerSec:t})=>({timestamp:e,duration:1,value:t}));return{avgLatencyMs:t(i,e),avgBandwidth:t(r,e)}}getLatest(){if(0===this.latencyEntries.length)return{avgLatencyMs:NaN,avgBandwidth:NaN};var e=this.latencyEntries[this.latencyEntries.length-1],t=this.bandwidthEntries[this.bandwidthEntries.length-1];return{avgLatencyMs:e.end-e.start,avgBandwidth:t.bitsPerSec}}recordLatency(e,t){Rm(this.latencyEntries,{start:e,end:t},Am),this.updateCleanupTimeout(t)}recordBandwidth(e,t,i){Rm(this.bandwidthEntries,{start:e,end:t,bitsPerSec:i},Am),this.updateCleanupTimeout(t)}setCleanupTimeout(e){this.cleanupTimeout=setTimeout(this.cleanUpExpiredEntries,Math.max(e-performance.now(),0)),this.cleanupTimestamp=e}clearCleanupTimeout(){void 0!==this.cleanupTimeout&&(clearTimeout(this.cleanupTimeout),this.cleanupTimeout=void 0),this.cleanupTimestamp=void 0}updateCleanupTimeout(e){e+=this.windowSize;(!this.cleanupTimestamp||e<this.cleanupTimestamp)&&(this.clearCleanupTimeout(),this.setCleanupTimeout(e))}cleanUpExpiredEntries(){this.clearCleanupTimeout();const t=performance.now()-this.windowSize;if(this.latencyEntries=this.latencyEntries.filter(e=>e.end>=t),this.bandwidthEntries=this.bandwidthEntries.filter(e=>e.end>=t),this.bwSubject.closed||this.bwSubject.next(this.getEstimate()),0<this.latencyEntries.length||0<this.bandwidthEntries.length){const t=Math.min(...this.latencyEntries.map(e=>e.end),...this.bandwidthEntries.map(e=>e.end));this.updateCleanupTimeout(t)}}destroy(){this.clearCleanupTimeout()}}const Cm={setCombinedEstimate:function(t,i,r){const n=Ge();if(void 0!==t.storage.set){var s=t.bandwidthHistoryStorageKey,a={avgLatencyMs:i.avgLatencyMs,avgBandwidth:i.avgBandwidth},a=Object.assign({},a,{expires:Date.now()+t.bandwidthHistoryTTL});try{t.storage.set(s,JSON.stringify(a))}catch(t){n.warn(`Error stringifying! Not persisting bandwidth estimates: ${t.message}`)}i={maxDuration:i.maxDurationSec,avgFragParseTimeMs:i.avgParseTimeMs,avgFragBufferCreationDelayMs:i.avgBufferCreateMs,avgPlaylistLoadTimeMs:i.avgPlaylistLoadTimeMs,avgPlaylistParseTimeMs:i.avgPlaylistParseTimeMs,avgInitFragAppendMs:i.avgInitFragAppendMs,avgDataFragAppendMs:i.avgDataFragAppendMs};let e=t.storageKeyPrefix;r&&(e+=r);try{t.storage.set(e,JSON.stringify(i))}catch(t){n.warn(`Error stringifying! Not persisting bandwidth estimates: ${t.message}`)}}else n.warn("storage.set is not supported! Not persisting bandwidth estimates")},getCombinedEstimate:function(t,e){const i=Ge();let r={};if(void 0===t.storage.get)return i.warn("storage.get is not supported! unable to retreive bandwidth estimates"),this.convertStorageJsonToCombinedEstimate(r);try{let e=JSON.parse(t.storage.get(t.bandwidthHistoryStorageKey));e=null!=e&&e.expires&&e.expires<Date.now()?null:{avgLatencyMs:null==e?void 0:e.avgLatencyMs,avgBandwidth:null==e?void 0:e.avgBandwidth},r=Object.assign(Object.assign({},r),e)}catch(t){i.warn(`Unable to get persisted bandwidth history: ${t.message}`)}let n=t.storageKeyPrefix;e&&(n+=e);try{const e=JSON.parse(t.storage.get(n));r=Object.assign(Object.assign({},r),e)}catch(t){i.warn(`Unable to get persisted bandwidth history: ${t.message}`)}return this.convertStorageJsonToCombinedEstimate(r)},convertStorageJsonToCombinedEstimate:function(e){return{avgLatencyMs:(null==e?void 0:e.avgLatencyMs)||NaN,avgBandwidth:(null==e?void 0:e.avgBandwidth)||NaN,maxDurationSec:(null==e?void 0:e.maxDuration)||NaN,avgParseTimeMs:(null==e?void 0:e.avgFragParseTimeMs)||NaN,avgBufferCreateMs:(null==e?void 0:e.avgFragBufferCreationDelayMs)||NaN,avgPlaylistLoadTimeMs:(null==e?void 0:e.avgPlaylistLoadTimeMs)||NaN,avgPlaylistParseTimeMs:(null==e?void 0:e.avgPlaylistParseTimeMs)||NaN,avgInitFragAppendMs:(null==e?void 0:e.avgInitFragAppendMs)||NaN,avgDataFragAppendMs:(null==e?void 0:e.avgDataFragAppendMs)||NaN}},getBandwidthEstimate:function(e,t){const i=this.getCombinedEstimate(e,t),r={avgLatencyMs:null==i?void 0:i.avgLatencyMs,avgBandwidth:null==i?void 0:i.avgBandwidth};return Z(r.avgLatencyMs)||(r.avgLatencyMs=NaN),Z(r.avgBandwidth)||(r.avgBandwidth=NaN),r},getPlaylistEstimate:function(e,t){const i=this.getCombinedEstimate(e,t),r={avgPlaylistLoadTimeMs:null==i?void 0:i.avgPlaylistLoadTimeMs,avgPlaylistParseTimeMs:null==i?void 0:i.avgPlaylistParseTimeMs};return Z(r.avgPlaylistLoadTimeMs)||(r.avgPlaylistLoadTimeMs=NaN),Z(r.avgPlaylistParseTimeMs)||(r.avgPlaylistParseTimeMs=NaN),r},getFragEstimate:function(e,t){const i=this.getCombinedEstimate(e,t),r={maxDurationSec:null==i?void 0:i.maxDurationSec,avgParseTimeMs:null==i?void 0:i.avgParseTimeMs};return Z(r.maxDurationSec)||(r.maxDurationSec=NaN),Z(r.avgParseTimeMs)||(r.avgParseTimeMs=NaN),r},getBufferEstimate:function(e,t){const i=this.getCombinedEstimate(e,t),r={avgBufferCreateMs:null==i?void 0:i.avgBufferCreateMs,avgInitFragAppendMs:null==i?void 0:i.avgInitFragAppendMs,avgDataFragAppendMs:null==i?void 0:i.avgDataFragAppendMs};return Z(r.avgBufferCreateMs)||(r.avgBufferCreateMs=NaN),Z(r.avgInitFragAppendMs)||(r.avgInitFragAppendMs=NaN),Z(r.avgDataFragAppendMs)||(r.avgDataFragAppendMs=NaN),r}};var Mm,Pm,xm,Dm,_m,Lm=Cm;class Nm{constructor(e=0){this._minSamples=e,this._sum=0,this._max=Number.NEGATIVE_INFINITY,this._numSamples=0}get avg(){return this._numSamples<this._minSamples?NaN:this._sum/this._numSamples}get max(){return 0<this.count?this._max:NaN}get count(){return this._numSamples}reset(){this._sum=0,this._numSamples=0,this._max=Number.NEGATIVE_INFINITY}add(e){this._sum+=e,this._max=Math.max(this._max,e),++this._numSamples}}class Fm extends Al{constructor(e,t){super(e),this.id=t}getBandwidthEstimate(e,t,i=!0){var r;const n=Object.assign({},null===(r=this.statsEntity)||void 0===r?void 0:r.bandwidthEstimate);if(Z(n.avgBandwidth)&&Z(n.avgLatencyMs))return n;if(null!=e&&e.storage&&i){const i=Cm.getBandwidthEstimate(e,t);Z(n.avgBandwidth)||(n.avgBandwidth=i.avgBandwidth),Z(n.avgLatencyMs)||(n.avgLatencyMs=i.avgLatencyMs)}return n}getPlaylistEstimate(e,t,i=!0){var r;const n=Object.assign({},null===(r=this.statsEntity)||void 0===r?void 0:r.playlistEstimate),s=e=>Z(e.avgPlaylistLoadTimeMs)&&Z(e.avgPlaylistParseTimeMs);if(s(n))return n;if(null!=e&&e.storage&&i){const i=Cm.getPlaylistEstimate(e,t);if(Z(n.avgPlaylistLoadTimeMs)||(n.avgPlaylistLoadTimeMs=i.avgPlaylistLoadTimeMs),Z(n.avgPlaylistParseTimeMs)||(n.avgPlaylistParseTimeMs=i.avgPlaylistParseTimeMs),s(n))return n}return null!=e&&e.statDefaults&&(Z(n.avgPlaylistLoadTimeMs)||(n.avgPlaylistLoadTimeMs=e.statDefaults.playlistLoadTimeMs),Z(n.avgPlaylistParseTimeMs)||(n.avgPlaylistParseTimeMs=e.statDefaults.playlistParseTimeMs)),n}getBufferEstimate(e,t,i=!0){var r;const n=Object.assign({},null===(r=this.statsEntity)||void 0===r?void 0:r.bufferEstimate),s=e=>Z(e.avgBufferCreateMs)&&Z(e.avgDataFragAppendMs)&&Z(e.avgInitFragAppendMs);if(s(n))return n;if(null!=e&&e.storage&&i){const i=Cm.getBufferEstimate(e,t);if(Z(n.avgBufferCreateMs)||(n.avgBufferCreateMs=i.avgBufferCreateMs),Z(n.avgDataFragAppendMs)||(n.avgDataFragAppendMs=i.avgDataFragAppendMs),Z(n.avgInitFragAppendMs)||(n.avgInitFragAppendMs=i.avgInitFragAppendMs),s(n))return n}return null!=e&&e.statDefaults&&(Z(n.avgBufferCreateMs)||(n.avgBufferCreateMs=e.statDefaults.fragBufferCreationDelayMs),Z(n.avgDataFragAppendMs)||(n.avgDataFragAppendMs=e.statDefaults.dataFragAppendMs),Z(n.avgInitFragAppendMs)||(n.avgInitFragAppendMs=e.statDefaults.initFragAppendMs)),n}getFragEstimate(e,t,i=!0){var r;const n=Object.assign({},null===(r=this.statsEntity)||void 0===r?void 0:r.fragEstimate),s=e=>Z(e.maxDurationSec)&&Z(e.avgParseTimeMs);if(s(n))return n;if(null!=e&&e.storage&&i){const i=Cm.getFragEstimate(e,t);if(Z(n.maxDurationSec)||(n.maxDurationSec=i.maxDurationSec),Z(n.avgParseTimeMs)||(n.avgParseTimeMs=i.avgParseTimeMs),s(n))return n}return null!=e&&e.statDefaults&&(Z(n.maxDurationSec)||(n.maxDurationSec=e.defaultTargetDuration),Z(n.avgParseTimeMs)||(n.avgParseTimeMs=e.statDefaults.fragParseTimeMs)),n}getCombinedEstimate(e,t,i=!0){return Object.assign(Object.assign(Object.assign(Object.assign({},this.getFragEstimate(e,t,i)),this.getPlaylistEstimate(e,t,i)),this.getBufferEstimate(e,t,i)),this.getBandwidthEstimate(e,t,i))}get statsEntity(){return this.getEntity(this.id)}get bandwidthSample(){var e;return null===(e=this.statsEntity)||void 0===e?void 0:e.bandwidthSample}get bandwidthStatus(){var e;return null===(e=this.statsEntity)||void 0===e?void 0:e.bandwidthStatus}get fragSample(){var e;return null===(e=this.statsEntity)||void 0===e?void 0:e.fragSample}get playlistSample(){var e;return null===(e=this.statsEntity)||void 0===e?void 0:e.playlistSample}get bandwidthEstimate$(){return this.selectEntity(this.id,"bandwidthEstimate")}get fragEstimate$(){return this.selectEntity(this.id,"fragEstimate")}get playlistEstimate$(){return this.selectEntity(this.id,"playlistEstimate")}get bufferEstimate$(){return this.selectEntity(this.id,"bufferEstimate")}get bandwidthSample$(){return this.selectEntity(this.id,({bandwidthSample:e})=>e).pipe(If())}get fragSample$(){return this.selectEntity(this.id,({fragSample:e})=>e).pipe(If())}get playlistSample$(){return this.selectEntity(this.id,({playlistSample:e})=>e).pipe(If())}get bufferMetric$(){return this.selectEntity(this.id,({bufferMetric:e})=>e).pipe(If())}}class Bm{constructor(e){this.statsStore=e}getQuery(){return new Al(this.statsStore)}getQueryForItem(e){return new Fm(this.statsStore,e)}remove(e){this.statsStore.remove(e)}removeAll(){this.statsStore.remove()}setBandwidthSample(e){this.statsStore.bandwidthSample=e}setFragSample(e){this.statsStore.fragSample=e}setPlaylistSample(e){this.statsStore.playlistSample=e}setBufferMetric(e){this.statsStore.bufferMetric=e}setBandwidthEstimate(e){this.statsStore.bandwidthEstimate=e}setFragEstimate(e){this.statsStore.fragEstimate=e}setPlaylistEstimate(e){this.statsStore.playlistEstimate=e}setBufferEstimate(e){this.statsStore.bufferEstimate=e}}const Um=new class extends fl{constructor(){super({},{name:"stats-store",producerFn:lu})}set statsEntity(e){Co("statsStore.set.stats"),ol(()=>{this.add(e),this.setActive(e.id)})}set playlistSample(t){Co(`stats.set.playlistSample: ${t}`),this.updateActive(e=>{e.playlistSample=t})}set bandwidthSample(t){Co(`stats.set.bandwidthSample: ${t}`),this.updateActive(e=>{e.bandwidthSample=t,e.bandwidthStatus.bandwidthSampleCount+=1,t.mediaOptionType===Tu.Variant&&(e.bandwidthStatus.instantBw=8e3*t.loaded/(t.tload-t.trequest))})}set fragSample(t){Co(`stats.set.fragSample: ${t}`),this.updateActive(e=>{e.fragSample=t})}set bufferMetric(t){Co(`stats.set.bufferMetric: ${t}`),this.updateActive(e=>{e.bufferMetric=t})}set bandwidthEstimate(t){Co(`stats.set.bandwidthEstimate: ${t}`),this.updateActive(e=>{e.bandwidthEstimate=t})}set fragEstimate(t){Co(`stats.set.fragEstimate: ${t}`),this.updateActive(e=>{e.fragEstimate=t})}set playlistEstimate(t){Co(`stats.set.playlistEstimate: ${t}`),this.updateActive(e=>{e.playlistEstimate=t})}set bufferEstimate(t){Co(`stats.set.bufferEstimate: ${t}`),this.updateActive(e=>{e.bufferEstimate=t})}};let $m=null;const Vm=(e,t)=>{let i=new Fm(Um,e);if(!t)return i;var{avgBandwidth:r,avgLatencyMs:e}=i.getBandwidthEstimate();return Z(r)&&Z(e)||(i=new Fm(Um,t)),i};function Km(e,t){if(e===t)return!0;if(!e||!t)return!1;let i=Object.keys(e).length===Object.keys(t).length;for(const r of Object.keys(e))i=i&&(isNaN(e[r])&&isNaN(t[r])||e[r]===t[r]);return i}const Qm={isWebkitMediaElement:e=>"webkitDroppedFrameCount"in e,isHtmlVideoElement:e=>"getVideoPlaybackQuality"in e,timeRangeToArray(t){const i=[];for(let e=0;e<t.length;e++)i.push([t.start(e),t.end(e)]);return i}};function qm(e){return new L(M.MEDIA_ERROR,P.STEERING_MANIFEST_PARSING_ERROR,!1,e,K.FormatError)}function jm(e){return"string"!=typeof e?qm("invalid steering manifest PATHWAY-PRIORITY list item data type"):/^[\w\-\.]+$/.test(e)?void 0:qm("steering manifest contains invalid pathway ID: "+e)}(pl=Mm=Mm||{})[pl.Low=100]="Low",pl[pl.Normal=500]="Normal",pl[pl.High=900]="High",(pl=Pm=Pm||{}).ContentSteering="Content Steering",pl.EnterTrickPlay="EnterTrickPlay",pl.ExitTrickPlay="ExitTrickPlay",pl.VariantSwitch="Variant Switch",pl.AudioSwitch="Audio Switch",pl.SubtitleSwitch="Subtitle Switch",pl.RendererSwitch="RendererSwitch",pl.Idle="Idle";class Hm extends Al{constructor(e){super(e)}get currentConfig(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.config}get extendMaxTTFB(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.extendMaxTTFB}get config$(){return this.selectActive(e=>null==e?void 0:e.config)}get pendingSeek$(){return this.selectActive(e=>null==e?void 0:e.userSeek)}get alternateMatchingInfo(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.alternateMatchingInfo}get alternateMatchingInfo$(){return this.selectActive(e=>null==e?void 0:e.alternateMatchingInfo)}}f();class Gm extends fl{constructor(){super({},{name:"hls-store",producerFn:lu})}}class Wm{constructor(e){this.store=e}getQuery(){return new Hm(this.store)}setHlsEntity(e){const t=e.id;Co(`hls.set.entity ${t}`),ol(()=>{this.store.add(ne(e)),this.store.setActive(t)})}removeEntity(e){Co(`hls.remove ${e}`),this.store.remove(e)}setUserSeek(t){this.store.updateActive(e=>{e.userSeek=t})}setExtendMaxTTFB(t){this.store.updateActive(e=>{e.extendMaxTTFB=t})}set config(t){this.store.updateActive(e=>{e.config=t})}setAlternateMatchingInfo(t){this.store.updateActive(e=>{e.alternateMatchingInfo=t})}setAudioAlternateMatchingInfo(t){this.store.updateActive(e=>{e.alternateMatchingInfo=Object.assign(Object.assign({},e.alternateMatchingInfo),{audioMatchingInfo:t})})}setSubtitleAlternateMatchingInfo(t){this.store.updateActive(e=>{e.alternateMatchingInfo=Object.assign(Object.assign({},e.alternateMatchingInfo),{subtitleMatchingInfo:t})})}}let zm;function Ym(){return zm=zm||new Wm(new Gm),zm}function Xm(){return Ym().getQuery()}function Jm(){return Ym().getQuery().currentConfig}function Zm(e){return e.every(e=>null==e||!1===e.liveOrEvent)}function eg(e){return e.every(e=>null==e||e.ptsKnown)}function tg(e,t){switch(e){case Dm.SendAlternateToPenaltyBox:e=Dm.RetryRequest,401!==t&&403!==t&&407!==t&&t!==K.CorruptStream.code&&t!==K.LivePlaylistUpdateError.code||(e=Dm.SendEndCallback);break;case Dm.RemoveAlternatePermanently:e=Dm.SendEndCallback}return e}function ig(e,t,i,r,n,s,a,o=!1){var l=s.mediaOptionListQueries[n].mediaOptionFromId(r),d=0!=(e.errorActionFlags&_m.MoveAllAlternatesMatchingHost),u=a.getFallbackMediaOptionTupleFromMediaOptionId(s,n,r,l.backingMediaOptionId,!1,d,o);let{errorAction:c,errorActionFlags:h}=e;return s.isValidMediaOptionTuple(u)?xu(s.enabledVariantMediaOption,u[n])&&(h&=~_m.MoveAllAlternatesMatchingHost):(t||(c=tg(c,i),h=0),cu(l)&&(!0===l.iframes?(c=Dm.DoNothing,h=0):!t&&a.canSwitchToSDR(s,r,d,o)&&(c=e.errorAction,h=_m.SwitchToSDR))),{errorAction:c,errorActionFlags:h}}function rg(e){let t,i=0;switch(e){case 0:t=Dm.SendAlternateToPenaltyBox,i=_m.MoveAllAlternatesMatchingHost;break;case 410:t=Dm.RemoveAlternatePermanently;break;case 500:case 502:case 503:case 504:case 404:case 409:case 401:case 403:case 407:case K.LivePlaylistUpdateError.code:case K.PlaylistNotReceived.code:default:t=Dm.SendAlternateToPenaltyBox,i=0}return{errorAction:t,errorActionFlags:i}}function ng(i,r,n,s,a,o,l){var{errorAction:d,errorActionFlags:u}=i;let e=!0;switch(d){case Dm.RemoveAlternatePermanently:case Dm.SendAlternateToPenaltyBox:{if(null==a||null==o)return r.handled=!1;const i=n.itemId;let e=o,t=n.mediaOptionListQueries[a].mediaOptionFromId(o);t.backingMediaOptionId&&(e=t.backingMediaOptionId,t=n.mediaOptionListQueries[a].mediaOptionFromId(e));var c=0!=(u&_m.MoveAllAlternatesMatchingHost),h=0!=(u&_m.MoveAllAlternatesMatchingHDCP),p=0!=(u&_m.SwitchToSDR),f=d===Dm.RemoveAlternatePermanently;if(h&&"hdcpLevel"in t){const r=t.hdcpLevel;s.setMaxHdcpLevel(i,r)}if(p&&s.switchToSDROnly(i),c?s.moveAllWithMatchingHosts(i,a,t,f):f?s.removePermanently(i,a,e):s.addToPenaltyBox(i,a,e),n.enabledMediaOptionIdByType(a)===o){let e=[qu,qu,qu];e=s.getFallbackMediaOptionTupleFromMediaOptionId(n,a,o,null,!1,c,l),n.isValidMediaOptionTuple(e)||(r.fatal=!0),r.fatal&&(e=[qu,qu,qu]),s.setEnabledMediaOptions(n.itemId,e)}break}case Dm.SendEndCallback:r.fatal=!0;break;case Dm.RetryRequest:case Dm.DoNothing:default:e=!1}return r.handled=e,e}function sg(e,t){t instanceof fc||t instanceof mc||t instanceof yc||(t instanceof sh||t instanceof nh)&&re(t.keyuri)}function ag(t,i,r){if(t.handled=!0,r&&i<r.maxNumRetry&&Z(r.retryDelayMs)){let e;return e="linear"===r.backoff?(i+1)*r.retryDelayMs:Math.pow(2,i)*r.retryDelayMs,e=Math.min(r.maxRetryDelayMs,e),sg(0,t),En(e)}return t.fatal=!0,sg(0,t),Ki(t)}function og(e,t,i,r,n,s,a,o,l=!1){return(null==r?void 0:r.errorAction)===Dm.RetryRequest?ag(e,t,i,s.logger):lg(e,0,r,n,s,a,o,l)}function lg(e,t,i,r,n,s,a,o=!1){const l=new tr;return ol(()=>{i&&(sg(n.logger,e),ng(i,e,r,n,s,a,o)),l.error(e)}),l}function dg(e,t,i,r,n,s){return lg(e,0,ig({errorAction:Dm.RemoveAlternatePermanently,errorActionFlags:0},!1,e.response.code,i,t,s,n),s,n,t,i).pipe(Qn(e=>{throw!1===e.fatal&&r.resetMediaSource(),e}))}function ug(t,i,r=NaN){var n=t.fragments;for(let e=r>t.startSN?r-t.startSN:0;e<n.length;++e){const t=n[e],r=t["start"];if(i(t))return{timelineOffset:r,mediaFragment:t}}return null}function cg(e,t,i,r,n){if(gf.isTimeRangeContainedInRanges(r,{start:n.start,end:n.start+n.duration}))return!1;const s=0<n.duration,a=n.start+n.duration,o=null==t||t<a||t-a<1&&n.isLastFragment,l=e.find(e=>vf(e.frag,n)),d=!(!l||(r=n,(l.evicting||!l.rebuffered)&&function(e,t,i,r,n){if(Z(t.appendEnd)&&Z(t.appendStart)){if((r=void 0===r?e.start:r)+n<t.appendStart&&r>=e.start)return 1;e=e.start+e.duration;if(r>t.appendEnd&&r<=e)return 1;n=e>t.appendEnd+n;if(r>=t.appendStart&&r<=t.appendEnd&&n&&i.find(e=>e.frag.mediaSeqNum===t.frag.mediaSeqNum+1))return 1}}(r,l,e,t,i)));return s&&!d&&o}function hg(e,i,t,r,n,s,a=[]){t=null!==(t=ug(r,cg.bind(null,n,void 0,s,a),t))&&void 0!==t?t:null;let o=null;t&&(o=null!==(a=ug(r,cg.bind(null,n,e,s,a),t.mediaFragment.mediaSeqNum))&&void 0!==a?a:null,o||!r.liveOrEvent||r.ptsKnown||(o=t));let l=NaN;if(null!=o&&Z(i)&&o.mediaFragment.discoSeqNum!==i&&(l=o.mediaFragment.discoSeqNum,o=null),o&&o.mediaFragment.mediaSeqNum>r.startSN){const e=o.mediaFragment.mediaSeqNum-r.startSN,d=(null===(i=r.fragments[e-1])||void 0===i?void 0:i.start)+(null===(i=r.fragments[e-1])||void 0===i?void 0:i.duration)/2;let t;for(let e=n.length;e--;)if(n[e].startPTS<d&&n[e].endPTS>d){t=n[e];break}(null==t?void 0:t.frag.mediaOptionId)!==r.mediaOptionId&&n.some(e=>0<e.frag.framesWithoutIDR)&&(o=null!==(r=ug(r,e=>e.mediaSeqNum===o.mediaFragment.mediaSeqNum-1))&&void 0!==r?r:o)}return{foundFrag:o,nextDisco:l}}function pg(e){return null!==(e=null===(e=e.fragments[0])||void 0===e?void 0:e.start)&&void 0!==e?e:0}function fg(e){e=e.fragments[e.fragments.length-1];return e?e.start+e.duration:0}(f=xm=xm||{}).LowBandwidth="LowBandwidth",f.HighBandwidth="HighBandwidth",f.PreferredListChanged="PreferredListChanged",f.IframeModeChange="IframeModeChange",f.None="",f.Seek="Seek",(f=Dm=Dm||{})[f.DoNothing=0]="DoNothing",f[f.SendEndCallback=1]="SendEndCallback",f[f.SendAlternateToPenaltyBox=2]="SendAlternateToPenaltyBox",f[f.RemoveAlternatePermanently=3]="RemoveAlternatePermanently",f[f.InsertDiscontinuity=4]="InsertDiscontinuity",f[f.RetryRequest=5]="RetryRequest",(f=_m=_m||{})[f.MoveAllAlternatesMatchingHost=1]="MoveAllAlternatesMatchingHost",f[f.MoveAllAlternatesMatchingHDCP=2]="MoveAllAlternatesMatchingHDCP",f[f.SwitchToSDR=4]="SwitchToSDR";class mg{constructor(e,t,i,r,n,s,a="fpicker",o=!0){this.logger=e,this._rootPlaylistService=t,this._rootQuery=i,this._mediaQuery=r,this._iframeMachine=n,this._useService=o,this._anchorMSNs=[NaN,NaN],this._avDetails=[null,null],this.logger=e.child({name:a}),this.setDiscoSeqNum(NaN),this.lookUpTolerance=Math.max(s.maxBufferHole,s.maxFragLookUpTolerance),this.firstAudioMustOverlapVideoStart=s.firstAudioMustOverlapVideoStart,this.bufferedSegmentAppendTolerance=s.maxFragLookUpTolerance,this.lookUpToleranceAlt=s.firstAudioMustOverlapVideoStart?0:s.maxFragLookUpTolerance,this.liveSyncDuration=s.liveSyncDuration,this.liveSyncDurationCount=s.liveSyncDurationCount}destroy(){this._anchorMSNs=[NaN,NaN],this._avDetails=[null,null],this._rootQuery=null,this._mediaQuery=null,this._rootPlaylistService=null,this._iframeMachine=null}get discoSeqNum(){return this._discoSeqNum}get _discoSeqNum(){var e;return null===(e=this._discoSeqNumRecord)||void 0===e?void 0:e.seqNum}get _discoSeqNumRecord(){return this._useService?this._rootQuery.discoSeqNumObject:this._discoSeqNumObject}setDiscoSeqNum(e,t=!1){this._useService?this._rootPlaylistService.setDiscoSeqNum(this._rootQuery.itemId,e,t):this._discoSeqNumObject={seqNum:e,wasSetInIframe:t}}get anchorMSNs(){return this._anchorMSNs}getDiscoSeqNumForTime(e,t){return this._mediaQuery.isIframeRate&&e.iframesOnly?ac.discoSeqNumForTime(e.fragments,t):function(i,r){for(let e=0,t=i.length;e<t;e++){var n=i[e],s=i[e+1];if((null==s?void 0:s.start)>r||null==s&&n.start+n.duration>r-1)return n.discoSeqNum}}(e.fragments,t)}_updateAnchorByPosition(e,t){let i=NaN;const r=t[Iu.Variant];if(r){const t=r.fragments;if(i=this.getDiscoSeqNumForTime(r,e),!Z(i)){const r=t[0],n=t[t.length-1],s=null==r?void 0:r.start,a=(null==n?void 0:n.start)+(null==n?void 0:n.duration);this.logger.warn(`${e.toFixed(3)} out of range [${null==s?void 0:s.toFixed(3)},${null==a?void 0:a.toFixed(3)}]`),e<=s?i=r.discoSeqNum:e>=a?i=n.discoSeqNum:this.logger.warn(`Unable to determine newCC. fragFirst: ${JSON.stringify(r)} fragLast: ${JSON.stringify(n)}`),Z(i)||this.logger.warn(`Unable to determine newCC. fragFirst: ${JSON.stringify(r)} fragLast: ${JSON.stringify(n)}`)}}else this.logger.warn("No variant details for anchoring");return this._updateAnchor(i,t),e}_updateAnchor(e,s){var t;const i=s[Tu.Variant].iframesOnly,a=e!==this._discoSeqNum;!a&&(null===(t=this._discoSeqNumRecord)||void 0===t?void 0:t.wasSetInIframe)===i||this.setDiscoSeqNum(e,i),zu.forEach(e=>{const t=this._avDetails[e],i=s[e],r=(null==t?void 0:t.mediaOptionId)!==(null==i?void 0:i.mediaOptionId);if(a||r)this._updateAnchorForType(Xu(e),i);else if(i){const{mediaOptionId:s,ptsKnown:t,startSN:a,endSN:r,itemId:n}=i;this._avDetails[e]={mediaOptionId:s,ptsKnown:t,startSN:a,endSN:r,itemId:n}}})}getNextFragments(i,r,n){const{position:s,bufferInfoTuple:e,switchContexts:a}=i;let t=e.map((e,t)=>{var i;return this._rootQuery.isInterstitial&&Z(this._rootQuery.itemStartOffset)&&0<this._rootQuery.itemStartOffset&&!(null!==(i=null==e?void 0:e.bufferedSegments)&&void 0!==i?i:[]).find(e=>e.frag.itemId===this._rootQuery.itemId)?this._rootQuery.itemStartOffset:gg(s,r[t],a[t],null==e?void 0:e.buffered,t===Tu.AltAudio?this.lookUpToleranceAlt:this.lookUpTolerance)}).reduce((e,t)=>Math.min(t,e),Number.POSITIVE_INFINITY);var o=this._discoSeqNum;if(Z(i.discoSeqNum)&&!Z(o)){const s=r.reduce((e,t)=>{if(t){t=ac.getTimeRangeForCC(t.fragments,i.discoSeqNum,n);if(t.length)return[Math.max(e[0],t[0]),Math.min(e[1],t[1])]}return e},[Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY]);t=Math.min(Math.max(t,s[0]),s[1])}return i.position=this._updateAnchorByPosition(t,r),{chosenFrags:this._getNextFragmentsInternal(i,r),discoChanged:this._discoSeqNum!==o}}isFirstFragInCC(e,t){var i=e.mediaFragment.mediaSeqNum,e=e.mediaFragment.discoSeqNum,t=t.fragments[i-t.startSN-1];return!t||t.discoSeqNum!==e}_getNextFragmentsInternal(r,n){var e;const s=[null,null];let a;const o=zu.reduce((e,t)=>{t=r.bufferInfoTuple[t];return e&&t&&0<t.buffered.len},!0);n.forEach((e,t)=>{var i;if(this.firstAudioMustOverlapVideoStart&&t===Tu.AltAudio&&this._mediaQuery.seekTo&&!o){const e=null===(i=s[Tu.Variant])||void 0===i?void 0:i.foundFrag;e&&!this.isFirstFragInCC(e,n[Tu.Variant])&&(a=r.position,r.position=s[Tu.Variant].foundFrag.mediaFragment.start)}s[t]=this._getNextFragmentForType(r,n,t)});let t=s[Iu.Variant],i=s[Iu.AltAudio],l=null===(e=null==t?void 0:t.foundFrag)||void 0===e?void 0:e.mediaFragment,d=null===(e=null==i?void 0:i.foundFrag)||void 0===e?void 0:e.mediaFragment;if(l&&d&&(d.start>l.start+(l.iframe?d:l).duration?(n[Iu.Variant].iframesOnly||this.logger.warn("Audio too far ahead"),i=s[Iu.AltAudio]=mg.noopResult,d=null):l.start>d.start+d.duration&&!l.iframe&&(this.logger.warn("Video too far ahead"),t=s[Iu.Variant]=mg.noopResult,l=null)),l||!d||this._rootQuery.getInitPTS(d.discoSeqNum)||(i=s[Iu.AltAudio]=mg.noopResult,d=null),!isFinite(null==t?void 0:t.nextDisco)||null!=i&&!Z(i.nextDisco))return s;{const u=s[Iu.Variant].nextDisco;return this._updateAnchor(u,n),Z(a)&&(r.position=a,a=NaN),this._getNextFragmentsInternal(r,n)}}_getNextFragmentForType(e,t,i){var{position:r,bufferInfoTuple:n,switchContexts:s}=e,a=t[i];if(!a)return null;const o=null!==(e=null===(c=n[i])||void 0===c?void 0:c.buffered)&&void 0!==e?e:{start:r,end:r,len:0},l=this._mediaQuery.getBufferedSegmentsByType(i),d=null!==(e=null===(c=s[i])||void 0===c?void 0:c.userInitiated)&&void 0!==e&&e;let u=gg(r,a,s[i],o,this.lookUpTolerance);this._rootQuery.isInterstitial&&Z(this._rootQuery.itemStartOffset)&&0<this._rootQuery.itemStartOffset&&(l.find(e=>e.frag.itemId===this._rootQuery.itemId)||(u=this._rootQuery.itemStartOffset));var{highWaterLevelSeconds:c,lowWaterLevelSeconds:e}=this._mediaQuery.bufferMonitorInfo,r=o.len;if(!d&&c<=r&&(i!==Iu.Variant||0===l.length||l[l.length-1].frag.itemId===a.itemId))return mg.noopResult;var c=i===Iu.Variant?Iu.AltAudio:Iu.Variant,n=null===(n=n[c])||void 0===n?void 0:n.buffered,c=null!==(c=null===(c=s[c])||void 0===c?void 0:c.userInitiated)&&void 0!==c&&c;let h=!1;i===Iu.Variant&&e<=r&&1<this._mediaQuery.expectedSbCount&&null!=n&&n.end<o.end&&(c||n.end-n.start<e)&&(h=!0);let p,f=null,m=NaN;if(this._mediaQuery.isIframeRate&&i===Iu.Variant&&a.iframesOnly){const g=function(e,t,i,r){i=r.nextFragment(a.fragments,(null==t?void 0:t.fragments)||[],i,e);if(!i)return null;var{frag:e,newMediaRootTime:i}=i;return{foundFrag:{timelineOffset:e.iframeMediaStart,mediaFragment:e},nextDisco:NaN,newMediaRootTime:i}}(u,t[Iu.AltAudio],this._mediaQuery.desiredRate,this._iframeMachine);if(g){({foundFrag:f,nextDisco:m,newMediaRootTime:p}=g);const i=f.mediaFragment;i.discoSeqNum!==this._discoSeqNum&&this._updateAnchor(i.discoSeqNum,t)}}else{const g=this._anchorMSNs[i];({foundFrag:f,nextDisco:m,newMediaRootTime:p}=hg(u,this._discoSeqNum,g,a,l,this.bufferedSegmentAppendTolerance,this._mediaQuery.getContentGapRanges()))}return h&&this._rootQuery.getInitPTS(null==f?void 0:f.mediaFragment.discoSeqNum)?mg.noopResult:{foundFrag:f,nextDisco:m,newMediaRootTime:p}}_updateAnchorForType(e,t){var i,r,n,s,a;if(!t)return this._anchorMSNs[e]=NaN,void(this._avDetails[e]=null);Z(this._discoSeqNum)?(a=this._discoSeqNum,a=null!==(s=null==(n=(r=t.fragments,i=a,r.find(e=>e.discoSeqNum===i)))?void 0:n.mediaSeqNum)&&void 0!==s?s:t.startSN,this._anchorMSNs[e]=a,{mediaOptionId:r,ptsKnown:n,startSN:s,endSN:a,itemId:t}=t,this._avDetails[e]={mediaOptionId:r,ptsKnown:n,startSN:s,endSN:a,itemId:t}):this.logger.warn("Trying to anchor with non-finite discoSeqNum")}}function gg(e,t,i,r,n){if(!t||!ju(t))return Number.POSITIVE_INFINITY;r=null!=r?r:{start:e,end:e,len:0};i=null!==(i=null==i?void 0:i.userInitiated)&&void 0!==i&&i,n=null!=t&&t.iframesOnly?0:n;return i||0===r.len?e:r.end+n}function yg(e,t,i){let r=1/0;i.playingFrag&&(r=null!==(s=null===(n=t.fragments[i.playingFrag.mediaSeqNum-t.startSN])||void 0===n?void 0:n.duration)&&void 0!==s?s:1/0);var{minRequiredStartDuration:i,maxRequiredStartDuration:n,startTargetDurationFactor:s}=e,{targetduration:e,averagetargetduration:t}=t,n=s*Math.min(r,t,e,n);return Math.max(i,n)}function vg(e,t,i,r,n){const{pos:s,combined:a,playingFrag:o}=i;if(!a||0===a.len)return!1;var l=t.details,i=l.fragments;let d=0!=r&&1!=r||a.len>=n;t=i[l.fragments.length-1],r=fg(l);let u=!1;if(o){const c=ec.search(i,e=>o.discoSeqNum-e.discoSeqNum);u=e&&o.discoSeqNum!==e.discoSeqNum||null==c||vf(c,o)}return d&&l.liveOrEvent?d=s<=r-t.duration:l.liveOrEvent||(d=d||r-n<=s),d=d||u,d}function Sg(e,t,i,r,n,s=!1){var a=e.state;let o=e.tstart,l=0;switch(a){case"loading":l+=function(e,t,i,r=!1){var{bwSample:n,duration:e}=e;if(!n)return 1/0;e=Z(n.total)?8*n.total:Math.ceil(e*t),t=8*n.loaded,e-=t,n=t/(performance.now()-n.tfirst)*1e3;if(!Z(n))return 1/0;i=i.avgBandwidth;return e/(r?n:Math.min(i,n))}(e,t,i,s),o=e.tstart+1e3*l;case"loaded":case"parsing":l+=bg(o,r),o=e.tstart+1e3*l;case"parsed":case"appending":l+=Tg(o,n);break;default:l=1/0}return l}function bg(e,t){t=Z(t.avgParseTimeMs)?t.avgParseTimeMs:0;return performance.now()<e?t/1e3:Math.max(0,t-(performance.now()-e))/1e3}function Tg(e,t){t=Z(t.avgDataFragAppendMs)?t.avgDataFragAppendMs:0;return performance.now()<e?t/1e3:Math.max(0,t-(performance.now()-e))/1e3}mg.noopResult={foundFrag:null,nextDisco:NaN};const Ig={minValidBitrate:2e6,maxValidBitrate:5e6,maxPreferredBitrate:3e6,minValidHeight:480,maxValidHeight:720};function Eg(e,t,i,r,n,s){var{targetDuration:a,targetStartupMs:o}=i,l=r["avgPlaylistLoadTimeMs"],d=n["avgParseTimeMs"],{avgBufferCreateMs:i,avgInitFragAppendMs:r,avgDataFragAppendMs:n}=s,{avgBandwidth:s,avgLatencyMs:t}=t;return e.bandwidth<=s&&(e.avgBandwidth||e.bandwidth)*a/s*1e3+l+i+ +(t+d+(r+n))<=o}const wg={ID:(e,t)=>Object.assign(Object.assign({},e),{identifier:t}),"START-DATE":(e,t,i,r)=>{var n=new Date(Date.parse(t)).getTime(),[t,r]=oe(n,r),r=n&&null!=r?n-t+r:NaN;return Object.assign(Object.assign({},e),{startTime:{baseTime:r,timescale:1e3}})},"X-ASSET-LIST":(e,t)=>Object.assign(Object.assign({},e),{urls:[t]}),"X-ASSET-URI":(e,t)=>Object.assign(Object.assign({},e),{urls:[t]}),"X-RESUME-OFFSET":(e,t)=>Object.assign(Object.assign({},e),{resumptionOffset:{baseTime:1e3*parseFloat(t),timescale:1e3}}),"X-PLAYOUT-LIMIT":(e,t)=>Object.assign(Object.assign({},e),{playoutLimit:{baseTime:1e3*parseFloat(t),timescale:1e3}}),"X-SNAP":(e,t)=>{var i=-1<t.indexOf("IN"),t=-1<t.indexOf("OUT");let r=nc.None;return i&&t?r=nc.InOut:i?r=nc.In:t&&(r=nc.Out),Object.assign(Object.assign({},e),{snapOptions:r})},"X-RESTRICT":(e,t)=>{var i=-1<t.indexOf("SKIP"),t=-1<t.indexOf("JUMP");let r=sc.None;return i&&t?r=sc.SkipJump:i?r=sc.Skip:t&&(r=sc.Jump),Object.assign(Object.assign({},e),{referenceRestrictions:r})},CUE:Og,"X-CUE":Og,default:(e,t,i)=>{if(0!==i.indexOf("X-"))return e;const r=Object.assign({},e);return r.extraAttributes[i]=t,r}};function Og(e,t){let i=rc.Midroll;-1<t.indexOf("PRE")?i=rc.Preroll:-1<t.indexOf("POST")&&(i=rc.Postroll);let r=!1;return-1<t.indexOf("ONCE")&&(r=!0),Object.assign(Object.assign({},e),{cueType:i,playOnce:r})}const Ag={clearkey:xh,fairplaystreaming:lh,playready:dh,widevine:uh},Rg={getKeySystemFormat(e){e=Ag[e];return e?e.keyFormatString:""},getKeySystemSecurityLevel(e){e=Ag[e];return e?e.securityLevels:null}},kg={NONE:"","AES-128":"","ISO-23001-7":"","SAMPLE-AES":"","SAMPLE-AES-CTR":""},Cg={NONE:0,"TYPE-0":1,"TYPE-1":2,"TYPE-2":3};function Mg(e){return e in Cg}function Pg(e){return null==e?4:Cg[e]}const xg={afr:"af",aka:"ak",amh:"am",ara:"ar",arg:"an",asm:"as",ava:"av",ave:"ae",aym:"ay",aze:"az",bam:"bm",bel:"be",ben:"bn",bih:"bh",bod:"bo",bos:"bs",bre:"br",bul:"bg",cat:"ca",ces:"cs",cha:"ch",che:"ce",chu:"cu",chv:"cv",cor:"kw",cos:"co",cre:"cr",cym:"cy",dan:"da",deu:"de",div:"dv",dzo:"dz",ell:"el",eng:"en",epo:"eo",est:"et",eus:"eu",ewe:"ee",fao:"fo",fas:"fa",fin:"fi",fra:"fr",fry:"fy",ful:"ff",gla:"gd",gle:"ga",glg:"gl",glv:"gv",grn:"gn",guj:"gu",hat:"ht",heb:"he",her:"hz",hin:"hi",hmo:"ho",hrv:"hr",hun:"hu",hye:"hy",ibo:"ig",ido:"io",iii:"ii",iku:"iu",ile:"ie",ina:"ia",ind:"id",isl:"is",ita:"it",jav:"jv",jpn:"ja",kal:"kl",kan:"kn",kas:"ks",kat:"ka",kau:"kr",kaz:"kk",khm:"km",kik:"ki",kin:"rw",kir:"ky",kom:"kv",kon:"kg",kor:"ko",kua:"kj",kur:"ku",lao:"lo",lat:"la",lav:"lv",lim:"li",lit:"lt",ltz:"lb",lub:"lu",lug:"lg",mah:"mh",mal:"ml",mar:"mr",mkd:"mk",mlg:"mg",mlt:"mt",mol:"mo",mon:"mn",mri:"mi",msa:"ms",mya:"my",nav:"nv",nbl:"nr",nde:"nd",ndo:"ng",nep:"ne",nld:"nl",nno:"nn",nob:"nb",nya:"ny",oci:"oc",oji:"oj",ori:"or",orm:"om",oss:"os",pan:"pa",pli:"pi",pol:"pl",por:"pt",pus:"ps",que:"qu",roh:"rm",ron:"ro",run:"rn",rus:"ru",san:"sa",sin:"si",slk:"sk",slv:"sl",sme:"se",snd:"sd",som:"so",spa:"es",sqi:"sq",srd:"sc",srp:"sr",sun:"su",swa:"sw",swe:"sv",tah:"ty",tam:"ta",tat:"tt",tel:"te",tgk:"tg",tgl:"tl",tha:"th",tir:"ti",ton:"to",tuk:"tk",tur:"tr",uig:"ug",ukr:"uk",urd:"ur",uzb:"uz",ven:"ve",vie:"vi",wln:"wa",yid:"yi",zha:"za",zho:"zh"},Dg={isLanguageCode:e=>e in xg,shortenLanguageCode(e){let t;var i,r;return e&&(r=0<=(i=e.indexOf("-"))?e.slice(0,i):e,Dg.isLanguageCode(r)&&(t=xg[r]),t=t||r,0<i&&(t+="-"+e.slice(i+1))),t}},_g={getRichestVideoCodec(e){if(e&&e.length){e=e.sort((e,t)=>Ef(t)-Ef(e));return e&&e.length?e[0]:void 0}},getRichestAudioCodec(e){if(e&&e.length){e=e.sort((e,t)=>Of(t)-Of(e));return e&&e.length?e[0]:void 0}},getRichestChannelLayoutForGroupId(t,i){if(t&&i&&i.length){let e;const r=i.filter(e=>e.groupId===t);if(r&&r.length){const t=r.sort((e,t)=>ye.getChannelCount(t.channels)-ye.getChannelCount(e.channels));t&&t.length&&(e=t[0].channels)}return e}}};class Lg{constructor(){this._programDateTime=null,this._byteRange=null,this.relurl=null,this.baseurl=null,this.isInitSegment=!1,this.mediaSeqNum=NaN,this.cc=NaN,this.iframe=!1,this.bitrate=NaN,this.start=NaN,this.duration=NaN,this.lastByteRangeEndOffset=NaN,this.gap=!1,this.iframe=!1}getMediaFragment(e,t,i){const r={mediaOptionType:i,relativeUrl:this.relurl,start:this.start,duration:this.duration,mediaSeqNum:this.mediaSeqNum,discoSeqNum:this.cc,mediaOptionId:t,itemId:e,isLastFragment:!1,isInitSegment:this.isInitSegment,gap:this.gap};return null!==(e=this.byteRange)&&void 0!==e&&e.length&&(r.byteRangeOffset={start:this.byteRangeStartOffset,end:this.byteRangeEndOffset}),this.iframe&&(r.iframe=this.iframe),this.levelkey&&(r.keyTagInfo=this.levelkey),this.programDateTime&&(r.programDateTime=this.programDateTime),r}get programDateTime(){return!this._programDateTime&&this.rawProgramDateTime&&(this._programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime}get byteRange(){if(!this._byteRange&&this.rawByteRange){const t=new Array(2),i=this.rawByteRange.split("@",2);var e;1===i.length?(e=this["lastByteRangeEndOffset"],t[0]=e||0):t[0]=parseInt(i[1]),t[1]=parseInt(i[0])+t[0],this._byteRange=t}return this._byteRange}get byteRangeStartOffset(){var e;return null===(e=this.byteRange)||void 0===e?void 0:e[0]}get byteRangeEndOffset(){var e;return null===(e=this.byteRange)||void 0===e?void 0:e[1]}get rangeString(){return 0<=this.start&&0<=this.duration?`${this.start.toFixed(2)}-${(this.start+this.duration).toFixed(2)}`:"N/A"}get fragTag(){return`sn/cc/levelId: ${this.mediaSeqNum}/${this.cc}`}}const Ng={parseMediaCharacteristics:e=>e?e.split(/\s*,\s*/):new Array,addMediaToSelectionArray(e,t,i){if(void 0===e)return-1;const r=e.MediaSelectionGroupOptions;let n=r.find(e=>e.MediaSelectionOptionsMediaType===t.mediaType&&e.MediaSelectionOptionsName===t.name&&e.MediaSelectionOptionsExtendedLanguageTag===t.lang);return n||(n={MediaSelectionOptionsMediaType:t.mediaType,MediaSelectionOptionsExtendedLanguageTag:t.lang,MediaSelectionOptionsIsDefault:t.default,MediaSelectionOptionsName:t.name,MediaSelectionOptionsPersistentID:i,MediaSelectionOptionsTaggedMediaCharacteristics:t.characteristics,MediaSelectionOptionsIsAutoSelect:null!==(e=t.autoselect)&&void 0!==e&&e},t.mediaType===Ou.SUBTITLE&&(n.MediaSelectionOptionsDisplaysNonForcedSubtitles=t.forced?wu.NO:wu.YES),i++,r.push(n)),t.persistentID=n.MediaSelectionOptionsPersistentID,i},addDefaultClosedCaptionOption(e,t,i,r){e={itemId:e,mediaOptionType:Tu.Subtitle,id:0,mediaOptionId:"cc1_"+Zl(),mediaType:Ou.CLOSEDCAPTION,inStreamID:"CC1",groupId:"cc",name:"English-CC",type:"CLOSED-CAPTIONS",default:!1,autoselect:!1,forced:!1,lang:"en",characteristics:["public.accessibility.transcribes-spoken-dialog","public.accessibility.describes-music-and-sound"],persistentID:r};t.push(e),Ng.addMediaToSelectionArray(i,e,r)}},Fg=/^(\d+)x(\d+)$/,Bg=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g;class Ug{constructor(e){this.validTags=e}isKey(e){return e in this.validTags}trySetValue(e,t,i){return!!this.isKey(e)&&(i[e]=this.parseFunc(t),!0)}}class $g extends Ug{parseFunc(e){return(" "+e).slice(1)}}class Vg{static parseTags(t){let i;const r={};if(!t)return r;for(Bg.lastIndex=0;null!==(i=Bg.exec(t));){const t=i[1].toUpperCase();let e=i[2];0===e.indexOf('"')&&e.lastIndexOf('"')===e.length-1&&(e=e.slice(1,-1));for(const i of Vg.tagParsers){if(i.trySetValue(t,e,r))break;if(i instanceof $g&&0===t.indexOf("X-")){r[t]=i.parseFunc(e);break}}}return r}}Vg.tagParsers=[new $g({NAME:"",TYPE:"",DEFAULT:"",AUTOSELECT:"",FORCED:"",LANGUAGE:"",URI:"",AUDIO:"","VIDEO-RANGE":"","CLOSED-CAPTIONS":"",CODECS:"",BYTERANGE:"","INSTREAM-ID":"","GROUP-ID":"",CHANNELS:"",CHARACTERISTICS:"",KEYFORMAT:"",KEYFORMATVERSIONS:"","DATA-ID":"",VALUE:"",METHOD:"","HDCP-LEVEL":"","ALLOWED-CPC":"",SUBTITLES:"",ID:"",CLASS:"","START-DATE":"","END-DATE":"","END-ON-NEXT":"",CUE:"","SERVER-URI":"","PATHWAY-ID":""}),new class extends Ug{parseFunc(e){e=parseInt(e);return e>Number.MAX_SAFE_INTEGER?1/0:e}}({BANDWIDTH:NaN,"AVERAGE-BANDWIDTH":NaN}),new class extends Ug{constructor(){super(...arguments),this.parseFunc=parseFloat}}({"TIME-OFFSET":NaN,"FRAME-RATE":NaN,SCORE:NaN,"PLANNED-DURATION":NaN,DURATION:NaN}),new class extends Ug{parseFunc(e){let t=(e||"0x").slice(2);t=(1&t.length?"0":"")+t;const i=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++){var r=parseInt(t.slice(2*e,2*e+2),16);if(!Z(r))return;i[e]=r}return i}}({IV:null}),new class extends Ug{parseFunc(e){e=Fg.exec(e);let t;return null!==e&&(t={width:parseInt(e[1],10),height:parseInt(e[2],10)}),t}}({RESOLUTION:null})];const Kg={ExtractVariableParameter:/{\$(.*?)}/g,LevelPlaylistFast:/#EXTINF:(\d*(?:\.\d+)?)(?:,(.*))?|(?!#)(\S.+)|#EXT-X-BYTERANGE:(.+)|#EXT-X-PROGRAM-DATE-TIME:(.+)|#EXT-X-BITRATE:(.+)|#EXT-X-DATERANGE:(.+)|#EXT-X-(.*)/g,LevelPlaylistSlow:/(PLAYLIST-TYPE|MEDIA-SEQUENCE|TARGETDURATION|KEY|START|DISCONTINUITY-SEQUENCE|DISCONTINUITY|VERSION|MAP|DEFINE|ENDLIST|I-FRAMES-ONLY|GAP)(?::(.+)){0,1}/,MasterPlaylist:/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)|#EXT-X-I-FRAME-STREAM-INF:([^\r\n]+)|#EXT-X-DEFINE:([^\n\r]*)|#EXT-X-CONTENT-STEERING:([^\n\r]*)|#EXT-X-START:([^\n\r]*)/g,MasterPlaylistAlternateMedia:/#EXT-X-MEDIA:(.*)/g,SessionData:/#EXT-X-SESSION-DATA[^:]*:(.*)/g,SessionKeys:/#EXT-X-SESSION-KEY:([^\n\r]*)/g,VARIABLE_PLAYLIST_REGEX:/(NAME|VALUE)=\"(.*)\",(NAME|VALUE)=\"(.*)\"|(IMPORT)=\"(.*)\"/};function Qg(e,t){return gu.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}class qg{static isValidPlaylist(e){return 0===e.indexOf("#EXTM3U")}static isMediaPlaylist(e){return 0<e.indexOf("#EXTINF:")||0<e.indexOf("#EXT-X-PLAYLIST-TYPE:")}static replaceVariables(e,t,i){let r=e?(" "+e).slice(1):void 0;return r&&0<Object.keys(t).length&&(r=r.replace(Kg.ExtractVariableParameter,e=>{Kg.ExtractVariableParameter.lastIndex=0;e=Kg.ExtractVariableParameter.exec(e),e=null==e?void 0:e[1];if("string"==typeof t[e])return t[e];throw new L(M.MEDIA_ERROR,i?P.MANIFEST_PARSING_ERROR:P.LEVEL_LOAD_ERROR,!1,K.PlaylistErrorInvalidEXTXDEFINE.text,K.PlaylistErrorInvalidEXTXDEFINE)})),r}static parseDecryptData(e,t,i){const r=Vg.parseTags(e),n=(e=r.METHOD)&&e in kg?r.METHOD:null;e=null!==(e=r.KEYFORMAT)&&void 0!==e?e:null;if(n&&qg.shouldSelectKeyTag(e,n,i)){const s=r.URI,i=r.IV||null;if(s&&r.IV&&!i){const s=new L(M.MEDIA_ERROR,P.MANIFEST_PARSING_ERROR,!0,`Invalid IV: ${r.IV}`,K.PlaylistErrorInvalidEntry);throw s.url=t,s}const a=s?gu.buildAbsoluteURL(t,s,{alwaysNormalize:!0}):"",o=(r.KEYFORMATVERSIONS||"1").split("/").map(Number).filter(isFinite);return new wh(n,a,i,e,o)}}static shouldSelectKeyTag(e,t,i){return"AES-128"===t||"NONE"===t||null==i||e===Rg.getKeySystemFormat(i)}static optOutClosedCaption(t){let i=!1,r=!1;if(t)for(let e=0;e<t.length;++e){const n=t[e];if(n.videoCodec&&((r=!0)!==n.iframes&&n.closedcaption&&"none"===n.closedcaption.toLowerCase())){i=!0;break}}return!r||i}static parseRootPlaylistAlternateMediaOptions(a,o,l,d,u,c){var h,p={MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.audible"],MediaSelectionGroupMediaType:Ou.AUDIO,MediaSelectionGroupOptions:[]},f={MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.legible"],MediaSelectionGroupMediaType:Ou.SUBTITLE,MediaSelectionGroupOptions:[]},m={videoAlternateOptions:[],audioAlternateOptions:[],subtitleAlternateOptions:[],audioMediaSelectionGroup:p,subtitleMediaSelectionGroup:f};let g=0;for(Kg.MasterPlaylistAlternateMedia.lastIndex=0;null!=(h=Kg.MasterPlaylistAlternateMedia.exec(o));){const o=qg.replaceVariables(h[1],u,!0),y=Vg.parseTags(o);let e,t,i,r=Ou.UNKNOWN;const v=Ng.parseMediaCharacteristics(y.CHARACTERISTICS),S=y["GROUP-ID"],b=y.CHANNELS;let n,s=null;switch(y.TYPE){case"VIDEO":r=Ou.VIDEO,t=m.videoAlternateOptions;break;case"AUDIO":r=Ou.AUDIO,s=Tu.AltAudio,t=m.audioAlternateOptions,i=p;const a=d.find(e=>e.audioGroupId===S);n=a?a.audioCodecList:[];break;case"SUBTITLES":r=Ou.SUBTITLE,s=Tu.Subtitle,t=m.subtitleAlternateOptions,i=f;break;case"CLOSED-CAPTIONS":r=Ou.CLOSEDCAPTION,s=Tu.Subtitle,e=y["INSTREAM-ID"],t=m.subtitleAlternateOptions,i=f}const T={itemId:a,mediaOptionType:s,mediaType:r,groupId:S,channels:b,groupCodecList:n,name:y.NAME,type:y.TYPE,default:"YES"===y.DEFAULT,autoselect:"YES"===y.AUTOSELECT,forced:"YES"===y.FORCED,characteristics:v,persistentID:g,id:t?t.length:0,mediaOptionId:`${y.NAME}_${S}_${g}`,lang:Dg.shortenLanguageCode(y.LANGUAGE),isInterstitial:c};y.URI&&(T.url=Qg(y.URI,l)),T.name||(T.name=T.lang,T.mediaType===Ou.CLOSEDCAPTION&&(T.name+=" CC")),T.mediaType===Ou.CLOSEDCAPTION&&e&&(T.inStreamID=e),t&&(T.id=t.length,t.push(T)),g=Ng.addMediaToSelectionArray(i,T,g)}return 0!==m.subtitleAlternateOptions.length||qg.optOutClosedCaption(d)||Ng.addDefaultClosedCaptionOption(a,m.subtitleAlternateOptions,f,g),{alternateMediaInfo:m,playlistParsingError:void 0}}static parseMediaOptionPlaylist(t,e,i,r,n,s,a,o,l=0,d=!1,u){let c=0,h=0;const p={itemId:n,mediaOptionId:s,mediaOptionType:a,type:"",version:0,url:e,initSegments:{},fragments:[],liveOrEvent:!0,startSN:0,endSN:0,iframesOnly:d,targetduration:0,totalduration:0,averagetargetduration:0,ptsKnown:!1,dateToMediaTime:[],pdtToMSN:[]};let f,m,g=new wh("NONE"),y=!1,v=!1,S=0,b=null,T=new Lg,I=0;const E={};let w,O,A=!0,R=!0,k=!1;Kg.LevelPlaylistFast.lastIndex=0;for(var C=()=>new L(M.MEDIA_ERROR,P.MANIFEST_PARSING_ERROR,!0,"Invalid key system preference for the playlist",K.IncompatibleAsset);null!==(f=Kg.LevelPlaylistFast.exec(t));){const t=f[1];if(t){T.duration=parseFloat(t);const e=(" "+f[2]).slice(1);T.title=e||null}else if(f[3]){if(Z(T.duration)){const t=c++;if(v&&!y)throw C();if(y=!1,v=!1,T.start=h+l,T.levelkey=g,T.mediaSeqNum=t,T.cc=S,T.iframe=p.iframesOnly,T.baseurl=e,w=qg.replaceVariables(f[3],E,!1),T.relurl=w,T.bitrate=Z(T.byteRangeEndOffset)?8*(T.byteRangeEndOffset-T.byteRangeStartOffset)/T.duration:I,p.startSN>=(null==u?void 0:u.startSN)&&p.startSN<=(null==u?void 0:u.endSN)&&(k=!0),!k||t>(null==u?void 0:u.endSN)){if(null!=m&&(T.rawProgramDateTime=m,(null==b?void 0:b.cc)!==S)){const t=T.programDateTime;p.pdtToMSN.push([t,T.mediaSeqNum]),p.dateToMediaTime.push([t,T.start])}p.fragments.push(T.getMediaFragment(n,s,a)),h+=T.duration}if(m=void 0,b=T,A||!p.initSegments[S]||R)if(p.iframesOnly&&0<T.byteRangeStartOffset&&!p.initSegments[S]&&!R){const t=new Lg;if(t.relurl=T.relurl,t.rawByteRange=Math.min(T.byteRangeStartOffset,1316)+"@0",t.baseurl=e,t.isInitSegment=!0,t.cc=S,t.levelkey=g,t.iframe=!0,v&&!y)throw C();y=!1,v=!1,p.initSegments[S]=t.getMediaFragment(n,s,a)}else O&&(p.initSegments[S]=Object.assign(Object.assign({},O),{discoSeqNum:S}));A=!1,R=!1,T=new Lg}}else if(f[4]){if(T.rawByteRange=(" "+f[4]).slice(1),b){const t=b.byteRangeEndOffset;t&&(T.lastByteRangeEndOffset=t)}}else if(f[5])m=(" "+f[5]).slice(1);else if(f[6]){const t=parseInt(f[6]);Z(t)&&(I=1e3*t)}else if(f[7]){const t=f[7];let e=Vg.parseTags(t);e.ID&&(p.daterangeTags||(p.daterangeTags={}),p.daterangeTags[e.ID]&&(e=qg.validateAndUpdateDateRangeTag(p.daterangeTags[e.ID],e,o)),p.daterangeTags[e.ID]=e)}else if(null!=(f=f[8].match(Kg.LevelPlaylistSlow))){const t=f[1],l=qg.replaceVariables(f[2],E,!1);switch(t){case"PLAYLIST-TYPE":p.type=l.toUpperCase(),"VOD"===p.type&&(p.liveOrEvent=!1);break;case"MEDIA-SEQUENCE":0===p.fragments.length&&(c=p.startSN=parseInt(l));break;case"TARGETDURATION":p.targetduration=parseFloat(l);break;case"VERSION":p.version=parseInt(l);break;case"ENDLIST":p.liveOrEvent=!1;break;case"DISCONTINUITY":S++,A=!0;break;case"DISCONTINUITY-SEQUENCE":S=parseInt(l);break;case"KEY":const t=l;v=!0,y||(g=qg.parseDecryptData(t,e,i),g&&(y=!0));break;case"START":const d=l,u=Vg.parseTags(d)["TIME-OFFSET"];Z(u)&&(p.startTimeOffset=u);break;case"I-FRAMES-ONLY":p.iframesOnly=!0;break;case"MAP":const h=Vg.parseTags(l);if(T.relurl=h.URI,T.rawByteRange=h.BYTERANGE,T.baseurl=e,T.isInitSegment=!0,T.levelkey=g,v&&!y)throw C();y=!1,v=!1,O=T.getMediaFragment(n,s,a),R=!0,T=new Lg;break;case"DEFINE":const f=Kg.VARIABLE_PLAYLIST_REGEX.exec(l),m="NAME"===f[1]?f[2]:f[4],b="VALUE"===f[1]?f[2]:f[4],I=f[5],w=f[6];if(m||b||"IMPORT"!==I||!r.hasOwnProperty(w)){if(!m||I||f[1]===f[3]||E.hasOwnProperty(m))throw new L(M.MEDIA_ERROR,P.MANIFEST_PARSING_ERROR,!0,K.PlaylistErrorMissingImportReference.text,K.PlaylistErrorMissingImportReference);E[m]=b}else E[w]=r[w];break;case"GAP":o.warn("GAP tag seen"),T.gap=!0}}}return T=b,T&&!T.relurl&&(p.fragments.pop(),h-=T.duration),!p.liveOrEvent&&0<p.fragments.length&&(p.fragments[p.fragments.length-1].isLastFragment=!0),p.totalduration=h,p.averagetargetduration=h/p.fragments.length,p.endSN=c-1,{mediaOptionDetails:p,isDeltaPlaylist:k}}static parseRootPlaylist(t,e,i){const r=[],n={},s={};let a,o,l,d,u=0,c=null,h=!0,p=NaN;for(Kg.MasterPlaylist.lastIndex=0;null!=(a=Kg.MasterPlaylist.exec(e));)if(a[4]){a=Kg.VARIABLE_PLAYLIST_REGEX.exec(a[4]);const t="NAME"===a[1]?a[2]:a[4],e="VALUE"===a[1]?a[2]:a[4],i=a[5];if(!t||n.hasOwnProperty(t)||i||a[1]===a[3]){d=new L(M.MEDIA_ERROR,P.MANIFEST_PARSING_ERROR,!0,K.PlaylistErrorInvalidEXTXDEFINE.text,K.PlaylistErrorInvalidEXTXDEFINE);break}n[t]=e}else if(a[5]){const t=qg.replaceVariables(a[5],n,!0),e=Vg.parseTags(t);if("string"!=typeof e["SERVER-URI"]){d=new L(M.MEDIA_ERROR,P.MANIFEST_PARSING_ERROR,!0,K.PlaylistErrorInvalidSERVERURI.text,K.PlaylistErrorInvalidSERVERURI);break}if(null!=e["PATHWAY-ID"]&&"string"!=typeof e["PATHWAY-ID"]){d=new L(M.MEDIA_ERROR,P.MANIFEST_PARSING_ERROR,!0,K.PlaylistErrorInvalidPATHWAYID.text,K.PlaylistErrorInvalidPATHWAYID);break}c={serverURI:Qg(e["SERVER-URI"],i),initPathwayID:e["PATHWAY-ID"]||".",initPathwayPriority:[]}}else if(a[6])p=Vg.parseTags(a[6])["TIME-OFFSET"];else{l=qg.replaceVariables(a[1]||a[3],n,!0);const e=Vg.parseTags(l);if(o=qg.replaceVariables(a[2]||e.URI,n,!0),void 0!==e.SCORE&&!Z(e.SCORE)||e.SCORE<0){d=new L(M.MEDIA_ERROR,P.MANIFEST_PARSING_ERROR,!0,K.PlaylistErrorInvalidSCORE.text,K.PlaylistErrorInvalidSCORE),h=!1;break}h&&void 0===e.SCORE&&(h=!1);const c=e.BANDWIDTH,p=e["AVERAGE-BANDWIDTH"],m=p||c,g=null!==(f=e["VIDEO-RANGE"])&&void 0!==f?f:"SDR";if(null==(f=g)||!uu.includes(f))continue;const y={itemId:t,mediaOptionId:`level_${(m||0)+r.length%1e3/1e3}`,mediaOptionType:Tu.Variant,url:Qg(o,i),name:e.NAME,audioGroupId:e.AUDIO,subtitleGroupId:e.SUBTITLES,iframes:!!a[3],bandwidth:c,avgBandwidth:p,bitrate:m,videoRange:g,frameRate:e["FRAME-RATE"],allowedCPCMap:qg.parseAllowedCPC(e["ALLOWED-CPC"]),closedcaption:e["CLOSED-CAPTIONS"],levelCodec:e.CODECS,score:e.SCORE,pathwayID:e["PATHWAY-ID"]||"."},v=e["HDCP-LEVEL"];Mg(v)&&(y.hdcpLevel=v);var f=e.RESOLUTION;if(f&&(y.width=f.width,y.height=f.height),e.CODECS){y.videoCodecList=new Array,y.audioCodecList=new Array;const t=e.CODECS.split(/[ ,]+/),i=t["length"];for(let e=0;e<i;e++){const i=t[e];switch(i.slice(0,4)){case"avc1":y.videoCodec=ye.avc1toavcoti(i),y.videoCodecList.push(y.videoCodec);break;case"mjpg":case"jpeg":y.imageCodec=i;case"avc3":case"dvav":case"dva1":case"hev1":case"hvc1":case"dvh1":case"dvhe":case"vp09":y.videoCodec=i,y.videoCodecList.push(y.videoCodec);break;default:y.audioCodec=i,y.audioCodecList.push(y.audioCodec)}}1<y.audioCodecList.length&&(y.audioCodec=_g.getRichestAudioCodec(y.audioCodecList)),1<y.videoCodecList.length&&(y.videoCodec=_g.getRichestVideoCodec(y.videoCodecList))}if(null!=(d=jm(y.pathwayID)))break;Object.prototype.hasOwnProperty.call(s,y.pathwayID)||(s[y.pathwayID]=u++),r.push(y)}null!=(null==c?void 0:c.initPathwayID)&&(s[c.initPathwayID]=-1,c.initPathwayPriority=Object.keys(s).sort((e,t)=>s[e]-s[t]));const m={variantMediaOptions:r,contentSteeringOption:c,masterVariableList:n,playlistParsingError:d,scoreAvailable:h};return Z(p)&&(m.startTimeOffset=p),m}static parseAllowedCPC(e){if("string"!=typeof e)return null;const n={};return e.split(",").forEach(e=>{const t=e.split(":");let i,r;if(2===t.length)i=t[0].trim(),r=t[1].trim();else{if(!(2<t.length))return;r=t[t.length-1].trim(),t.pop(),i=t.join(":")}if(!(i in n)){let e=new Array;""!==r&&(e=r.split("/").map(e=>e.trim())),n[i]=e}}),n}static parseSessionKeys(e,t,i){var r;const n=[];for(Kg.SessionData.lastIndex=0;r=Kg.SessionKeys.exec(e);)try{const e=qg.parseDecryptData(r[1],t,i);e&&e.isEncrypted&&n.push(e)}catch(e){}return n}static parseSessionData(e,t){var i;const r=[],n=new Set;for(Kg.SessionData.lastIndex=0;null!=(i=Kg.SessionData.exec(e));){const e=Vg.parseTags(i[1]);e.LANGUAGE=Dg.shortenLanguageCode(e.LANGUAGE);const t=e.LANGUAGE?e["DATA-ID"]+"|"+e.LANGUAGE:void 0;"DATA-ID"in e?t&&n.has(t)||("com.apple.hls.other-tags"===e["DATA-ID"]&&(e.VALUE=function(t){let i;try{i=JSON.parse(yh.base64DecodeToStr(t))}catch(e){i=t}return i}(e.VALUE)),r.push(e),t&&n.add(t)):Ge().error(`Error processing DATA-ID ${e["DATA-ID"]} and LANGUAGE ${e.LANGUAGE}`)}return{itemList:r,baseUrl:t}}static validateAndUpdateDateRangeTag(e,t,i){let r=!0;const n=Object.assign({},e);for(const e in t)if("ID"!==e){var s=t[e];if(Object.prototype.hasOwnProperty.call(n,e)){if(n[e]!==s){i.error(`Date Range Tag for attribute: "${e}" does not match for ID: "${t.ID}". This violates HLS spec`),r=!1;break}}else n[e]=s}return r?n:e}}var jg,Hg,Gg,Wg=qg;const zg=(e,a,t,o,i,l,d,u,r,c)=>{const{url:h,itemId:p,mediaOptionId:f,mediaOptionType:m}=e,g=!!cu(e)&&e.iframes,n=Dc(e,i);return Wc({url:h,xhrSetup:t.xhrSetup},n,r,xc()).pipe(pr(({responseText:e,responseURL:t,stats:i})=>{t||(l.warn("Missing response url. Reusing request url as base url"),t=h);var r=performance.now(),n=qg.parseMediaOptionPlaylist(e,t,d,u,p,f,m,l,a,g,c);let s=[];m===Tu.Variant&&(s=function(i,e,t){var{daterangeTags:r,pdtToMSN:n}=i;let s=[];e=-1<e.indexOf("interstitial");return r&&!e&&t.allowServerGeneratedInterstitials&&0<n.length&&(s=Object.entries(r).reduce((e,[,t])=>{t=function(e,t){if(!e||"com.apple.hls.interstitial"!==e.CLASS)return null;let i={extraAttributes:{},resumptionOffset:{baseTime:NaN,timescale:1e3},identifier:"",cueType:rc.Midroll,snapOptions:nc.None,referenceRestrictions:sc.None,startTime:{baseTime:NaN,timescale:1e3},urls:[],hasPlayed:!1,playOnce:!1,assets:[]};for(const n in e){var r;Object.prototype.hasOwnProperty.call(e,n)&&(r=e[n],i=(wg[n]||wg.default)(i,r,n,t))}return function(e){let t=!1;var i=""!==e.identifier,r=0<e.urls.length,e=!isNaN(e.startTime.baseTime);return i&&r&&e&&(t=!0),t}(i)?i:null}(t,i.dateToMediaTime);return t&&e.push(t),e},[])),s}(n.mediaOptionDetails,p,o)),Lc(n.mediaOptionDetails);var e=performance.now(),t=n["mediaOptionDetails"],r={playlistLoadTimeMs:i.tload-i.trequest,playlistParseTimeMs:e-r};return{mediaOptionDetails:t,isDeltaPlaylist:n.isDeltaPlaylist,interstitials:s,bwSample:i,playlistSample:r}}),(s=m,y=f,v=h,e=>e.pipe(Qn(e=>{if(e instanceof vc)throw new mc(!1,"Timeout",K.PlaylistTimeoutError,!0,s,y,v);if(e instanceof hc)throw new mc(!1,e.message,{code:e.statusCode,text:"Playlist Network Error"},!1,s,y,v);throw e}))));var s,y,v};function Yg(e,t){var i=e.fragments,r=t.mediaSeqNum-e.startSN;return 0<=r&&r<e.fragments.length&&vf(t,i[r])}function Xg(t,r,n,s,a=!1,o=!1){if(Yg(t,r)){var l=r.mediaSeqNum-t.startSN;let i=t.fragments,e=i[l];var{startPts:d,endPts:r}=r;a&&(i=t.fragments=t.fragments.slice(),e=i[l]=Object.assign({},e)),e.startPts=d,e.endPts=r,!s&&void 0===e.isIframeStart||(e.isIframeStart=s),e.start=n,e.duration=y(r,d);for(let e=l,t=!0;0<e&&(o||t);e--)t=Jg(i,e,e-1,s,d.timescale,a);for(let e=l,t=!0;e<i.length-1&&(o||t);e++)t=Jg(i,e,e+1,s,d.timescale,a);l=i[i.length-1];t.totalduration=l.start+l.duration-i[0].start,t.ptsKnown=!0}}function Jg(e,t,i,r,n,s=!1){var a=e[t];let o=e[i];var l=null!=r&&null!=o.isIframeStart&&o.isIframeStart!==r&&o.discoSeqNum===a.discoSeqNum;let d=o.start;!l&&null!=o.startPts||(d=t<i?a.start+a.duration:Math.max(a.start-o.duration,0));n=Z(n)?1/n:Number.EPSILON,n=Math.abs(o.start-d)>n;return!(!l&&!n||(s&&(o=e[i]=Object.assign({},o)),n&&(o.start=d),l&&(o.isIframeStart=r),0))}function Zg(r){if(0<r.pdtToMSN.length){const n=[],s=[];r.pdtToMSN.forEach(([e,t])=>{var i,t=null!==(i=r.fragments[t-r.startSN])&&void 0!==i?i:r.fragments.find(e=>null!=e.programDateTime);t&&(i=null!==(i=t.programDateTime)&&void 0!==i?i:e,n.push([i,t.mediaSeqNum]),s.push([e,t.start]))}),0<n.length&&(r.pdtToMSN=n),0<s.length&&(r.dateToMediaTime=s)}}function ey(t,i,r,n){return e=>e.pipe(Qn(e=>{if(t.logger.error(`Got demux error ${e.message}`),e instanceof b||e instanceof N){Dm.SendAlternateToPenaltyBox;return lg(e,0,{errorAction:e.fatal?Dm.SendEndCallback:e instanceof N?Dm.SendAlternateToPenaltyBox:Dm.RemoveAlternatePermanently,errorActionFlags:0},i,t,r,n)}throw e}))}function ty(e,t,i,r,n){e=null!==(e=null===(e=n.getKeyInfo(e))||void 0===e?void 0:e.mediaOptionIds)&&void 0!==e?e:[];for(const s of e)for(const n of i.mediaOptionListQueries)null!=n.mediaOptionFromId(s)&&r.updateConsecutiveTimeouts(i.itemId,n.mediaOptionType,t,"key")}function iy(r,t,e,n,s,a){const o=n.logger,i=s.enabledMediaOptionKeys,l=[];for(const t of r.mediaOptionIds){const r=i.some(e=>e.mediaOptionId===t),e=s.mediaOptionListQueries.find(e=>null!=e.mediaOptionFromId(t));if(e){const n=e.mediaOptionType,a={mediaOptionId:t,mediaOptionType:n};r?l.push(a):l.unshift(a)}else o.warn(`Couldn't find query for ${t}`)}const d=new tr;return ol(()=>{const e=r instanceof nh;ty(r.keyuri,e,s,n,a);let t,i=!1;for(const{mediaOptionId:e,mediaOptionType:a}of l)t=function(e,t,i,r,n){let s={errorAction:Dm.SendAlternateToPenaltyBox,errorActionFlags:0};if(e instanceof nh)s.errorAction=Dm.SendAlternateToPenaltyBox;else{const t=e.isOkToRetry;e.keyErrorReason===eh.OutputRestricted?(s.errorAction=Dm.RemoveAlternatePermanently,s.errorActionFlags|=_m.MoveAllAlternatesMatchingHDCP):t?s=rg(e.response.code):s.errorAction=Dm.RemoveAlternatePermanently}s.errorActionFlags&=~_m.MoveAllAlternatesMatchingHost;var a=r.enabledMediaOptionIdByType(i);return t===a?ig(s,!1,e.response.code,a,i,r,n,e.isTimeout):s}(r,e,a,s,n),o.error(`[Keys] handleNetworkError uri=${re(r.keyuri)} mediaOptionId=${e} mediaOptionType=${a} action=${JSON.stringify(t)}`),t.errorAction===Dm.RetryRequest&&(i=!0),ng(t,r,s,n,a,e);i?(d.next(),d.complete()):(sg(0,r),d.error(r))}),d.pipe(La(()=>ag(r,t,e,n.logger)))}function ry(t,i,r,n,s,a,o,l){return n=Math.max(0,n),e=>e.pipe(eo(()=>{null!=i&&o.updateConsecutiveTimeouts(t,i,!1,"load")}),ba(e=>e.pipe(La((e,t)=>function(e,t,i,r,n,s,a,o){var l;if(!(e instanceof g))return Ki(e);let d,u,c,h=!1;if(e instanceof fc)c={errorAction:tg(rg((l=e).response.code).errorAction,l.response.code),errorActionFlags:0};else if(e instanceof mc||e instanceof yc){({mediaOptionType:u,mediaOptionId:d,isTimeout:h}=e);const t=null===(l=s.mediaOptionListQueries[u])||void 0===l?void 0:l.mediaOptionFromId(d);if(!r&&e.isTimeout&&null!=t&&(!("iframes"in t)||!0!==t.iframes)&&(a.updateConsecutiveTimeouts(s.itemId,e.mediaOptionType,!0,"load"),e instanceof yc&&e.stats)){const t=performance.now();o.setBandwidthSample(Object.assign(Object.assign({},e.stats),{tfirst:e.stats.tfirst||t,tload:e.stats.tload||t,complete:!0,mediaOptionType:u}))}c=function(e,t,i,r,n){var s=e.response.code;let a=rg(s);var{mediaOptionId:o,mediaOptionType:l}=e;return t?a.errorActionFlags&=~_m.MoveAllAlternatesMatchingHost:a=function(e,t,i,r,n){let{errorAction:s,errorActionFlags:a}=t;if(e.isTimeout){const t=e["mediaOptionType"],o=null!==(n=null===(n=n.getErrorInfoByType(t))||void 0===n?void 0:n.timeouts.load)&&void 0!==n?n:0;!i&&r<=o&&(s=Dm.SendEndCallback,a=0)}return{errorAction:s,errorActionFlags:a}}(e,a,t,i,r),a=ig(a,t,s,o,l,r,n,e.isTimeout),a}(e,r,n,s,a)}return og(e,t,i,c,s,a,u,d,h)}(e,t,_c(e,r),s,n,a,o,l)))))}function ny(i,r,n,s){var a;const o=i.mediaOptionId===r.mediaOptionId;if("VOD"!==i.type&&i.iframesOnly===r.iframesOnly&&(!n||o)){s=s.child({name:"live"});const l=i.fragments,d=r.fragments;!function(e,r){const t=e.fragments,i=r.fragments;let n=0;var s=sy(t,r.startSN),e=sy(i,r.startSN);if(s&&e&&(n=s.discoSeqNum-e.discoSeqNum),0!==n){const a={};i.forEach(e=>{var t=e.discoSeqNum,i=t+n;r.initSegments[t]&&(a[i]=r.initSegments[t],a[i].discoSeqNum=i),e.discoSeqNum=i}),r.initSegments=a}}(i,r);let t=null;if(o)for(let e=0;e<d.length;e++){const r=d[e],n=sy(l,r.mediaSeqNum);r&&null!=(null==n?void 0:n.startPts)&&(r.start=n.start,r.duration=n.duration,r.startPts=n.startPts,r.endPts=n.endPts,t=r)}if(t)Xg(r,t,t.start,void 0,!1,!0);else if(d.length){const r=d[0],n=Math.max(0,r.start);let t=0;const o=sy(l,r.mediaSeqNum);t=o?o.start-n:fg(i)+(r.mediaSeqNum-i.endSN-1)*i.averagetargetduration-n,t<0&&(s.warn("sliding value is negative, use 0 value instead"),t=0);for(let e=0;e<d.length;++e)d[e].start+=t}if(n){const n=r.startSN-i.startSN,{pdtToMSN:s,dateToMediaTime:o}=function(i,r){const n=[];return{pdtToMSN:i.pdtToMSN.concat(r.pdtToMSN.filter(([,e],t)=>{e=sy(r.fragments,e);if(e){const r=sy(i.fragments,i.endSN);if(e.discoSeqNum!==r.discoSeqNum)return n.push(t),!0}return!1})),dateToMediaTime:i.dateToMediaTime.concat(r.dateToMediaTime.filter((e,t)=>-1<n.indexOf(t)))}}(i,r);r.pdtToMSN=s,r.dateToMediaTime=o;const e=l[n].discoSeqNum;if(Z(e))for(const[n,s]of Object.entries(i.initSegments)){const i=Number(n);i>=e&&!r.initSegments[i]&&(r.initSegments[i]=s)}const u=l.slice(n),c=u[u.length-1].keyTagInfo;if(c)for(const i of d){if((null===(a=i.keyTagInfo)||void 0===a?void 0:a.uri)!==c.uri)break;i.keyTagInfo=c}r.fragments=u.concat(d),r.averagetargetduration=(i.totalduration+r.totalduration)/(l.length+d.length)}const u=pg(r),c=fg(r);r.ptsKnown=r.ptsKnown||o&&!0===i.ptsKnown&&i.endSN>=r.startSN,r.totalduration=c-u,Zg(r)}}function sy(e,t){return e[t-(null===(e=e[0])||void 0===e?void 0:e.mediaSeqNum)]}function ay(e,t){t=function(e,t){let i=3*e.targetduration;return Z(e.holdBackSeconds)&&(i=Math.max(i,e.holdBackSeconds)),Z(t.liveSyncDuration)?i=Math.max(i,t.liveSyncDuration):Z(t.liveSyncDurationCount)&&(i=Math.max(i,t.liveSyncDurationCount*e.targetduration)),i}(e,t);return Math.max(e.fragments[0].start,fg(e)-t)}function oy(e,t){var i=pg(e),r=fg(e),t=ay(e,t);return{start:i,end:r,edge:t,boundary:Math.max(0,t-2*e.targetduration)}}function ly(e,t){const i=oy(e[Tu.Variant],t),r=e[Tu.AltAudio];if(r){const e=oy(r,t);i.start=Math.max(i.start,e.start),i.end=Math.max(i.start,Math.min(i.end,e.end)),i.edge=Math.max(i.start,Math.min(i.edge,e.edge)),i.boundary=Math.min(i.boundary,e.boundary)}return i}function dy(e,t,i){i=ly(t,i);return Math.max(i.start,Math.min(i.edge,e))}function uy(e,t,i){return!(e.start>t.end+i||e.end<t.start-i)}function cy(e){return 1e3*(e.averagetargetduration||e.targetduration)}function hy(e,t){var i=cy(e),t=performance.now()-t;return e.liveOrEvent&&i<=t}class py extends Al{constructor(e,t){super(e),this.mediaOption=t}get itemId(){var e;return null===(e=this.mediaOption)||void 0===e?void 0:e.itemId}get mediaOptionId(){return this.mediaOption.mediaOptionId}get initSegmentEntities(){var e;return null===(e=this.mediaOptionDetailsEntity)||void 0===e?void 0:e.initSegmentCacheEntities}get mediaLibraryEntity(){return this.getEntity(this.itemId)}get mediaOptionDetailsEntityRecord(){var e;return null===(e=this.mediaLibraryEntity)||void 0===e?void 0:e.mediaOptionDetailsEntityRecord}get mediaOptionDetailsEntity(){return this.mediaOptionDetailsEntityRecord?this.mediaOptionDetailsEntityRecord[this.mediaOptionId]:null}get mediaOptionDetails(){var e;return null===(e=this.mediaOptionDetailsEntity)||void 0===e?void 0:e.mediaOptionDetails}get playlistDuration(){var e;return null===(e=this.mediaOptionDetailsEntity)||void 0===e?void 0:e.playlistDuration}get mediaOptionDetailsEntity$(){const{itemId:e,mediaOptionId:t}=this;return this.selectEntity(e,e=>{if(null!=e&&e.mediaOptionDetailsEntityRecord)return null==e?void 0:e.mediaOptionDetailsEntityRecord[t]})}get mediaOptionDetails$(){return this.selectEntity(this.itemId,e=>{return null===(e=null==e?void 0:e.mediaOptionDetailsEntityRecord[this.mediaOptionId])||void 0===e?void 0:e.mediaOptionDetails}).pipe(If())}get playlistDuration$(){return this.mediaOptionDetailsEntity$.pipe(pr(e=>null==e?void 0:e.playlistDuration),If(),bs())}get live$(){return this.mediaOptionDetails$.pipe(pr(e=>null==e?void 0:e.liveOrEvent),bs())}get liveEdgeGrows$(){return this.mediaOptionDetails$.pipe(pr(e=>e.endSN),bs((e,t)=>t<=e),ka(1),Ys(!0))}}class fy extends fl{constructor(){super({},{name:"media-library-store",idKey:"itemId",producerFn:lu})}}class my{constructor(e){this.store=e,this.inFlightDetails=null}getQuery(){return new Al(this.store)}getQueryForOption(e){return new py(this.store,e)}createMediaLibraryEntity(e){var t={itemId:e,mediaOptionDetailsEntityRecord:{}};Co(`library.entity.create: ${e}`),this.store.add(t)}setDetailsLoading(e,t=!0){const{itemId:i,mediaOptionId:r}=e;Co(`library.details.loading: ${r}`),this.store.update(i,({mediaOptionDetailsEntityRecord:e})=>{e[r]||(e[r]={initSegmentCacheEntities:{},unchangedCount:0}),e[r].detailsLoading=t})}setLastAccessed(e){const{itemId:t,mediaOptionId:i}=e;Co(`library.details.lastAccessed: ${i}`),this.store.update(t,({mediaOptionDetailsEntityRecord:e})=>{e[i]&&(e[i].lastAccessedMillis=performance.now())})}archiveMediaOptionDetails(r,n,s){const{itemId:e,mediaOptionId:a}=r,o=performance.now(),l=fg(r);Co(`library.details.loaded: ${a}`),this.store.update(e,e=>{const t=e.mediaOptionDetailsEntityRecord,i=t[a];i.detailsLoading=!1,i.lastUpdateMillis=o,i.lastAccessedMillis=o,i.stats=n,s?(i.mediaOptionDetails=r,i.playlistDuration=l,i.unchangedCount=0,e.liveOrEvent=r.liveOrEvent):++i.unchangedCount,function(t,i,r){var n=Object.values(t).filter(e=>{var t;return(null===(t=e.mediaOptionDetails)||void 0===t?void 0:t.mediaOptionType)===i&&(null===(t=e.mediaOptionDetails)||void 0===t?void 0:t.iframesOnly)===r&&null!=e.lastAccessedMillis}).sort((e,t)=>e.lastAccessedMillis-t.lastAccessedMillis);for(let e=0;e<n.length-2;++e)delete t[n[e].mediaOptionDetails.mediaOptionId]}(t,r.mediaOptionType,r.iframesOnly)})}setInitSegmentLoading(e){const{itemId:t,mediaOptionId:i,discoSeqNum:r}=e;Co(`library.initsegs.loading: ${i}/${r}`),this.store.update(t,e=>{e.mediaOptionDetailsEntityRecord[i].initSegLoading=r})}archiveInitSegmentEntity(i,r){const{itemId:e,mediaOptionId:n,discoSeqNum:s}=i||r;Co(`library.initseg.loaded: ${n}/${s}`),this.store.update(e,({mediaOptionDetailsEntityRecord:e})=>{const t=e[n];t.initSegmentCacheEntities[s]=[i,r],t.initSegLoading=null})}updatePTSDTS(e,i,t,r){var n=null===(n=this.getQueryForOption({itemId:e,mediaOptionId:i}))||void 0===n?void 0:n.mediaOptionDetails;if(n&&Yg(n,r)){const s=r["startDtsTs"],{variantDTS:a,timelineOffset:o,iframeMode:l}=t,d=y(s,a)+o,u=Object.assign({},n);Xg(u,r,d,l,!0),Zg(u);const c=fg(u);this.store.update(e,({mediaOptionDetailsEntityRecord:e})=>{const t=e[i];null!=t&&t.mediaOptionDetails&&(t.mediaOptionDetails=u,t.playlistDuration=c)})}}remove(e){this.store.remove(e)}clear(){this.store.remove()}}let gy;function yy(){return gy=gy||new my(new fy),gy}const vy=e=>yy().getQueryForOption(e),Sy=(v,e,t=!1,i=!1)=>{if(null==e||!ju(e))return Vi(null);const r=e["itemId"],n=v["mediaLibraryService"],s=n.getQueryForOption(e);s.hasEntity(r)||n.createMediaLibraryEntity(r);var a=s.mediaOptionDetailsEntity,o=s.mediaOptionDetails;return null==o||i||"VOD"!==o.type&&(!o.liveOrEvent||hy(o,a.lastUpdateMillis))?(n.setDetailsLoading(e),function(e,t){var i;const{logger:r,config:n,rootPlaylistQuery:s,rootPlaylistService:a,statsService:o,mediaLibraryService:l,mediaSink:d,interstitialService:u,legibleSystemAdapter:c}=v,h=d.mediaQuery,p=n.playlistLoadPolicy,f=n.keySystemPreference,m=s.masterVariableList,g=null===(i=null===(i=Ym())||void 0===i?void 0:i.getQuery())||void 0===i?void 0:i.extendMaxTTFB,y=null===(i=l.getQueryForOption(e))||void 0===i?void 0:i.mediaOptionDetails;return zg(e,s.itemStartOffset,n,n,p,r,f,m,g,y).pipe(pr(by(e,s,a,h,l,u,o,c,n,r)),Jc("getMediaOptionDetailsCommon.emit.loaded"),ry(e.itemId,e.mediaOptionType,Dc(e,p),n.maxNumAddLevelToPenaltyBox,t,s,a,o)).pipe(As(1))}(e,t)):(n.setLastAccessed(e),Vi(o).pipe(Jc("retrieveMediaOptionDetails.emit.cached")).pipe(As(1)))};function by(y,v,S,b,T,I,E,w,O,A){return e=>{const t=T.getQueryForOption(y),i=t.mediaOptionDetails,{mediaOptionDetails:r,interstitials:n,isDeltaPlaylist:s}=e,{bwSample:a,playlistSample:o}=e;let l=!0;if(r.liveOrEvent||null!=i&&i.liveOrEvent){if(r.endSN<(null==i?void 0:i.endSN))l=!1,A.warn(`endSN went backward ${null==i?void 0:i.endSN} -> ${r.endSN}`);else{const y=r["mediaOptionType"];if(g=r,l=null==i||g.endSN!==i.endSN||g.liveOrEvent!==i.liveOrEvent,""===r.type&&(r.type="LIVE"),i){ny(i,r,s,A);const y=i.startSN!==r.startSN,v=i.endSN!==r.endSN;y||v?!y&&v&&(r.type="EVENT"):r.type=i.type}const S=v.lastLoadedMediaOptionByType(y),b=S?null===(c=T.getQueryForOption(S))||void 0===c?void 0:c.mediaOptionDetails:null;!r.ptsKnown&&b&&b.mediaOptionId!==(null==i?void 0:i.mediaOptionId)&&ny(b,r,s,A)}if(w){let e=b.currentTime-O.liveOldCueRemovalOffsetSec;const v=null===(h=b.getCombinedBufferInfo(b.currentTime,O.maxBufferHole))||void 0===h?void 0:h.start;Z(v)&&v>e&&(e=v),w.removeOldCues(e)}}else""===r.type&&(r.type="VOD");const d=I.interstitialQuery,u=d.getInterstitialAssetForId(r.itemId);if(null!=u){const y=d.getInterstitialForId(u.parentIdentifier),v=u.duration||0,S=(p=r,m=p.fragments[0],p=p.fragments[p.fragments.length-1],m&&p?p.start+p.duration-m.start:0),b=y.duration||0;ol(()=>{I.updateInterstitialAsset(u.identifier,{duration:S}),I.updateInterstitial(y.identifier,{duration:Math.max(b-v,0)+S})})}ol(()=>{r&&(T.archiveMediaOptionDetails(r,a,l),S.setLastLoadedMediaOptionByType(v.itemId,y.mediaOptionType,y)),n&&0<n.length&&I.addInterstitials(n),E.setPlaylistSample(o)});var c,h,p,f,m,g=!l&&t.mediaOptionDetailsEntity.unchangedCount>=O.liveMaxUnchangedPlaylistRefresh,m=(c=r,h=a.tload,p=O.maxBufferHole,f=O,m=function(e,t,i,r,n){if(!t.ptsKnown)return 0;var s=t.targetduration,a=oy(t,f).start,r=n.canContinuePlaybackWithoutGap(t,i,{avgPlaylistLoadTimeMs:0,avgPlaylistParseTimeMs:0},r);let o=Math.max(0,e-s);return e<a&&!r&&(o=a),o}(b.currentTime,c,h,p,b),h=c.fragments[c.fragments.length-1],p=(null==h?void 0:h.start)+(null==h?void 0:h.duration),{expired:null!=h&&c.liveOrEvent&&c.ptsKnown&&p<m,windowEnd:p,minPosition:m});if(g||m.expired){g=g?K.LivePlaylistUpdateError:K.LivePlaylistTooFar;throw new mc(!1,g.text,g,!1,y.mediaOptionType,y.mediaOptionId,y.url)}return r}}const Ty=(t,e)=>{if(!e)return Vi(null);const i=t["logger"],r=t["mediaLibraryService"],n=r.getQueryForOption(e),{mediaOption:s,mediaOptionDetailsEntityRecord:a,mediaOptionDetails:o}=n,l=s["mediaOptionId"];if(null==a||!a[l])throw new Error("retrieveInitSegmentCacheEntity no details entity");if(!o)throw new Error("retrieveInitSegmentCacheEntity no details");var d=a[l]["initSegmentCacheEntities"],u=o["initSegments"],e=e["discoSeqNum"];if(d[e]){const[t,h]=d[e];return Vi(h||t)}const c=u[e];return Iy(c)?(r.setInitSegmentLoading(c),i.child({name:"timing"}),Oy(t,c,!1,!1).pipe(eo(()=>{}),Hi(ir),La(e=>Ey(e,c,t)),eo(()=>{}))):Vi(null)};function Iy(e){return!0===(null==e?void 0:e.isInitSegment)}function Ey(e,t,l){const{mediaSink:i,rootPlaylistService:r,rootPlaylistQuery:n,mediaParser:s,mediaLibraryService:a}=l,o=i["mediaQuery"],d=a.getQueryForOption(t),{mediaOption:u,mediaOptionDetails:c}=d,h=u["mediaOptionId"],p=t["mediaOptionType"],f=o.seeking,m=c.liveOrEvent,g=p===Tu.Variant&&c.ptsKnown,y={segment:void 0,initSegment:new Uint8Array(e),frag:t,ptsKnown:g,seeking:f,live:m,totalDuration:c.totalduration};return s.parseInitSegment(y,null!==(e=null===navigator||void 0===navigator?void 0:navigator.vendor)&&void 0!==e?e:"").pipe(pr(e=>function(e,t,i){const{logger:r,mediaLibraryService:n,gaplessInstance:s,config:a}=l,o=e["track"];s.inGaplessMode&&ye.isVideoCodec(o.codec)&&!a.enableInterstitialPlayback&&(r.warn(`Video codec discovered in gapless mode codec:${o.codec}`),s.dequeueSource("InvalidFormat"));i=wy(e,t,i);return n.archiveInitSegmentEntity(i),i}(e,t,d)),ey(r,n,p,h))}function wy(e,t,i){var r=i["mediaOption"],{itemId:n,mediaOptionId:s}=r,{keyTagInfo:a,discoSeqNum:o}=t,{track:i,moovData:r,mimeType:e}=e,i=i["initSegment"];return{itemId:n,mediaOptionId:s,discoSeqNum:o,initParsedData:r,data:i,mimeType:e,keyTagInfo:a,fragment:t}}function Oy(n,s,i,r){var e;const{rootPlaylistQuery:t,rootPlaylistService:a,config:o,rtcService:l,statsService:d}=n,{itemId:u,mediaOptionType:c,mediaOptionId:h}=s,p=o.fragLoadPolicy,f=Z(s.mediaSeqNum),m=c===Tu.Variant||c===Tu.AltAudio,g=t.mediaOptionListQueries[c].mediaOptionFromId(h);let y;if(f){if(m){const{start:i,duration:r}=s;n.mediaSink.updateInFlightRange(c,{start:i,end:i+r})}a.updateInflightFrag(u,s.mediaOptionType,s,"loading",null),c===Tu.Variant&&(y={getData:!1,cb:(e,t,i,r)=>(a.updateInflightFrag(u,s.mediaOptionType,s,"loading",i),!1),samplePeriodMs:Z(o.abrSamplePeriodMs)?Math.max(100,o.abrSamplePeriodMs):NaN})}let v=!1;r&&null===l.serverInfoInstance&&(v=!0);const S=Vc(s,g.url,o,p,y,v,null===(e=null===(e=Ym())||void 0===e?void 0:e.getQuery())||void 0===e?void 0:e.extendMaxTTFB).pipe(eo(([,,e,t])=>{i&&d.setBandwidthSample(Object.assign(Object.assign({},e),{mediaOptionType:s.mediaOptionType})),r&&v&&(l.serverInfoInstance=t),f&&a.updateInflightFrag(u,s.mediaOptionType,s,"loaded",e)}),eo(([e,,t])=>{r&&n.playerEvents.triggerFragLoaded(e,t)}),ry(u,c,Dc(s,p),o.maxNumAddLevelToPenaltyBox,!1,t,a,d));return"AES-128"===(null===(e=s.keyTagInfo)||void 0===e?void 0:e.method)?tn([Ay(n,s.keyTagInfo,{itemId:s.itemId,mediaOptionId:s.mediaOptionId}),S]).pipe(La(([e,t])=>{const[i,r]=t;return i.keyTagInfo.key=e.key,f=i,e=r,m=o,n.logger,g=n.rpcClients.crypto,Vi(e).pipe(La(e=>{const{keyTagInfo:t,isInitSegment:i,iframe:r,byteRangeOffset:n}=f,s=t["method"],{start:a,end:o}=null!=n?n:{};if("AES-128"!==s)return Vi(e);{!t.uri||t.iv||t.format&&"identity"!==t.format||(t.iv=function(t){const i=new Uint8Array(16);for(let e=12;e<16;e++)i[e]=t>>8*(15-e)&255;return i}(f.mediaSeqNum));const n=e,s=t.key.buffer,l=t.iv.buffer,d=o&&(r||i)?o-a:void 0,u=!m.enableWebCrypto||!!d,c=s.slice(0),h=l.slice(0),p={useJSCrypto:u,plainTextLength:d};return g.decrypt(c,h,"AES-CBC",n,p)}}));var f,m,g})):S.pipe(pr(e=>e[1]))}function Ay(e,t,i){const{keySystemAdapter:r,rootPlaylistQuery:n,rootPlaylistService:s,config:a}=e,o=a["keyLoadPolicy"];return r.getKeyFromDecryptData(t,i,o).pipe((l=t.uri,d=Dc({url:t.uri},o),u=n,c=s,h=r.ksQuery,e=>e.pipe(dl(()=>{ty(l,!1,u,c,h)}),ba(e=>e.pipe(La((e,t)=>{if(e instanceof nh||e instanceof sh)return iy(e,t,_c(e,d),c,u,h);throw e}))))));var l,d,u,c,h}function Ry(t){return e=>e.pipe(pr(e=>e&&e.url&&ju(e)?t.getQueryForOption(e):null))}function ky(t){return e=>e.pipe(Ry(t),La(e=>e?e.mediaOptionDetails$:Vi(null)))}function Cy(e,t){return Pr([e.enabledMediaOptionByType$(Tu.Variant).pipe(ky(t)),e.enabledMediaOptionByType$(Tu.AltAudio).pipe(ky(t))])}class My{constructor(e){this.option=e}get name(){return this.option.name}get priority(){return this.option.priority}get expiry(){return this.option.expiry}filter(i,e){const r=this.option.initFn&&this.option.initFn(i,e)||(e?Object.assign({},e):{});let t=i;return this.option.firstPassFn&&i.forEach((e,t)=>this.option.firstPassFn(e,t,r,i)),this.option.filterFn&&(t=i.filter((e,t)=>this.option.filterFn(e,t,r,i))),this.option.shouldSortFn&&this.option.minSortingFn&&this.option.shouldSortFn(t,r,i)&&(t=i.sort((e,t)=>this.option.minSortingFn(e,t,r,i))),this.option.finalFn&&this.option.finalFn(t,r,i),t}}function Py(e,t,i){return(t||[]).reduce((e,t)=>t.filter(e,i),Array.from(e))}function xy(e,t){return e-t}function Dy(e){return()=>e}function _y(i){return(e,t)=>-1*i(e,t)}function Ly(...r){return(e,t)=>{for(const i of r){const r=i(e,t);if(r)return r}return 0}}function Ny(n,s,{AgtB:a,AltB:o,ABgtPvt:l,ABltPvt:d,ABeqPvt:u,AeqPvt:c,BeqPvt:h}={}){return(e,t)=>{var i=n(e,s),r=n(t,s);return u&&0===i&&0===r?u(e,t):c&&0===i?c(e,t):h&&0===r?h(e,t):0<=i&&r<0||0<i&&r<=0?a?a(e,t):1:i<=0&&0<r||i<0&&0<=r?o?o(e,t):-1:0<=i&&0<=r?l?l(e,t):0:i<=0&&r<=0&&d?d(e,t):0}}const Fy=(e=[])=>{const t=e.reduce((e,t,i,r)=>(e[t]=r.length-i,e),{});let i=-1;const r={};return e=>Object.prototype.hasOwnProperty.call(t,e)?t[e]:Object.prototype.hasOwnProperty.call(r,e)?r[e]:r[e]=i--};function By(){return new My({name:"Content Steering Pathway Filter",priority:5,initFn:(e,t={})=>{var i=Fy(t.pathwayPriority);return Object.assign(Object.assign({},t),{pathwayRanking:i})},firstPassFn(e,t,i,r){var n=i.pathwayRanking(e.pathwayID);(null==i.selectedPathwayRanking||n>i.selectedPathwayRanking)&&(i.selectedPathway=e.pathwayID,i.selectedPathwayRanking=n)},filterFn:(e,t,i)=>e.pathwayID===i.selectedPathway})}function Uy(){return[new My({name:"Remove Filter",priority:0,filterFn:(t,e,i)=>!i||i.removed.every(e=>t.mediaOptionId!==e)}),new My({name:"Penalty Box Filter",priority:1,filterFn:(t,e,i)=>{const r=performance.now();return!i||i.penaltyBoxQueue.every(e=>e.expiry<=r||t.mediaOptionId!==e.mediaOptionId)}}),new My({name:"Compatible IDs Filter",priority:1,filterFn:(t,e,i)=>!i||null==i.compatibleIds||i.compatibleIds.some(e=>e===t.mediaOptionId)})]}class $y extends Al{constructor(e,t,i){super(e),this.itemId=t,this.mediaOptionType=i,this.allowFilters=this._initFilters()}get mediaOptionList(){var e;return(null===(e=this.mediaOptionListInfo)||void 0===e?void 0:e.mediaOptions)||null}get mediaOptionList$(){return this.mediaOptionListInfo$.pipe(pr(({mediaOptions:e})=>e))}mediaOptionFromId(t){var e;return null!==(e=(null!==(e=this.mediaOptionList)&&void 0!==e?e:[]).find(e=>e.mediaOptionId===t))&&void 0!==e?e:null}_getFilteredList(e){return Py(e.mediaOptions,this.allowFilters,e)}get filteredMediaOptionList(){return this.mediaOptionListInfo?this._getFilteredList(this.mediaOptionListInfo):[]}get filteredMediaOptionList$(){return this.mediaOptionListInfo$.pipe(La(e=>{const t=[Oh],i=performance.now();for(const r of e.penaltyBoxQueue)Z(r.expiry)&&r.expiry>i&&t.push(En(r.expiry-i));return dn(...t).pipe(pr(()=>this._getFilteredList(e)))}),Sl())}}function Vy(e){return"PQ"===e.videoRange||"HLG"===e.videoRange}function Ky(e,{hasScore:i,pivotVariant:r,pathwayPriority:t,preferHostOverQuality:n,preferCloseToPivotQuality:s}={hasScore:!1,pivotVariant:null,pathwayPriority:null,preferHostOverQuality:!0,preferCloseToPivotQuality:!1}){const a=[...e],o=(e,t)=>e.bitrate-t.bitrate,l=i?Ly((e,t)=>i&&Z(e.score)&&Z(t.score)?e.score-t.score:0,_y(o)):o,d=(()=>{const t={};let i=0;return null!=r&&(t[ku(r.url)]=e.length),e=>{e=ku(e.url);return null==e?-1:(Object.prototype.hasOwnProperty.call(t,e)||(t[e]=i++),t[e])}})(),u=(e,t)=>_y(xy)(d(t),d(e)),c=[];return null!=t&&c.push(((e,i=Fy(e))=>(e,t)=>i(e.pathwayID)-i(t.pathwayID))(t)),n&&c.push(u),s&&null!=r?c.push(Ny(_y(l),r,{AeqPvt:Dy(1),BeqPvt:Dy(-1),ABgtPvt:l,ABltPvt:_y(l)})):(null!=r&&c.push(Ny(l,r)),c.push(l)),n||c.push(u),null!=r&&c.push(Ny((e,t)=>null==e.audioGroupId||null==t.audioGroupId||e.audioGroupId===t.audioGroupId?1:-1,r)),a.sort(Ly(...c)),a}(f=jg=jg||{})[f.Better=1]="Better",f[f.Same=0]="Same",f[f.Worse=-1]="Worse";class Qy extends $y{constructor(e,t){super(e,t,Tu.Variant)}static makeFilters(){return[...Uy().concat([new My({name:"HDR Filter",priority:1,filterFn:(e,t,i)=>!i||(i.hasHdrLevels&&i.preferHDR)===Vy(e)}),new My({name:"Viewport Filter",priority:1,firstPassFn:(e,t,i)=>{if(i&&e&&!e.iframes&&e.videoCodec){const t=!i.lowestBitrate||e.bitrate<i.lowestBitrate?e.bitrate:i.lowestBitrate;i.lowestBitrate=t}},filterFn:(e,t,i)=>!(e&&i&&i.viewportInfo&&e.videoCodec&&i.lowestBitrate)||function(e,t){return e.width<1.35*t.width&&e.height<1.35*t.height&&e.width*e.height<t.width*t.height*1.35}({width:e.width,height:e.height},i.viewportInfo)||e.bitrate===i.lowestBitrate}),new My({name:"HDCP Filter",priority:2,filterFn:(e,t,i)=>!i||!Mg(i.maxHdcpLevel)||Pg(e.hdcpLevel)<Pg(i.maxHdcpLevel)}),By()])].sort((e,t)=>{return(null!==(e=e.priority)&&void 0!==e?e:Number.MAX_SAFE_INTEGER)-(null!==(t=t.priority)&&void 0!==t?t:Number.MAX_SAFE_INTEGER)})}_initFilters(){return Qy.kAllowFilters}get currentPathwayID(){var e;return null===(e=this.mediaOptionListInfo)||void 0===e?void 0:e.currentPathwayID}get currentPathwayID$(){return this.selectEntity(this.itemId,e=>null==e?void 0:e.mediaOptionListTuple[Tu.Variant].currentPathwayID)}get mediaOptionListInfo(){var e;return null!==(e=null===(e=this.getEntity(this.itemId))||void 0===e?void 0:e.mediaOptionListTuple[Tu.Variant])&&void 0!==e?e:null}get mediaOptionListInfo$(){return this.selectEntity(this.itemId,e=>{return null===(e=null==e?void 0:e.mediaOptionListTuple)||void 0===e?void 0:e[Tu.Variant]}).pipe(If())}get hdrMode$(){return this.mediaOptionListInfo$.pipe(pr(e=>!0===e.preferHDR&&e.hasHdrLevels),bs())}get maxHdcpLevel$(){return this.selectEntity(this.itemId,e=>{e=null===(e=null==e?void 0:e.mediaOptionListTuple)||void 0===e?void 0:e[Tu.Variant];return null==e?void 0:e.maxHdcpLevel}).pipe(bs())}listFallbackVariants(t,e,i,r,n){var s=this.mediaOptionListInfo,a=null===(o=this.mediaOptionList)||void 0===o?void 0:o.find(e=>e.mediaOptionId===t);if(!a||!s)return null;var o=this.makeFilteredListFromVariant(a,e,n);if(!o)return null;var{hasScore:e,pathwayPriority:s}=s;return Qy._listFallbackVariants(o,a,e,s,i,r,n)}getFallbackVariant(t,e,i,r){var n=this.mediaOptionListInfo,s=null===(s=this.mediaOptionList)||void 0===s?void 0:s.find(e=>e.mediaOptionId===t);if(!s||!n)return null;e=this.makeFilteredListFromVariant(s,e,r);if(!e)return null;var{hasScore:r,pathwayPriority:n}=n;return Qy._getFallbackVariant(e,s,r,n,i)}makeFilteredListFromVariant(e,t,i){if(!e||!this.mediaOptionList||!this.mediaOptionListInfo)return null;const r=Object.assign({},this.mediaOptionListInfo);t&&(r.compatibleIds=null,r.preferHDR=!1);let n=Py(Array.from(this.mediaOptionList),this.allowFilters,r);return n?(i&&0<i.length&&(n=n.filter(e=>!i.includes(e.mediaOptionId))),n):null}get hasIframes(){return this.filteredMediaOptionList.some(e=>e.iframes)}canSwitchToSDR(e,t,i=!1){var r=this.mediaOptionListInfo;if(!this.mediaOptionList||!r)return!1;var n=this.mediaOptionFromId(e);if(!n)return!1;if(!Vy(n))return!1;var s=Py(Array.from(this.mediaOptionList),this.allowFilters,Object.assign(Object.assign({},r),{preferHDR:!1,compatibleIds:null})),{hasScore:e,pathwayPriority:r}=r;return null!=Qy._getFallbackVariant(s,n,e,r,t,i)}static _listFallbackVariants(e,r,t,i,n,s=!1,a=null){let o=!1;const l=Ky(e.filter(e=>{var t=!(e.iframes!==r.iframes||n&&xu(r,e)),i=s?e.bitrate<r.bitrate:e.bitrate<=r.bitrate,i=t&&i;return r.mediaOptionId===e.mediaOptionId?(o=i,!1):i}),{pivotVariant:r,hasScore:t,pathwayPriority:i,preferHostOverQuality:!1,preferCloseToPivotQuality:!0});return!o||a&&a.includes(r.mediaOptionId)||l.push(r),l}static _getFallbackVariant(e,t,i,r,n,s=!1){r=Ky(e=e.filter(e=>!(t.mediaOptionId===e.mediaOptionId||e.iframes!==t.iframes||n&&null!=ku(t.url)&&xu(t,e)||s&&e.bitrate>=t.bitrate)),{pivotVariant:t,hasScore:i,pathwayPriority:r,preferHostOverQuality:!1,preferCloseToPivotQuality:!0});let a=null;return 0<r.length&&(a=r[r.length-1]),a}getMatchingVariant(e,t){var i,r,n=this.mediaOptionFromId(e),s=t.mediaOptionType===Tu.AltAudio?"audioGroupId":"subtitleGroupId";let a=null;this.mediaOptionListInfo.hasScore;for(const e of this.filteredMediaOptionList)if(e[s]===t.groupId){if(!n){a=e;break}var o=(i=n,r=e,!(o=a)||r.bitrate>o.bitrate&&r.bitrate<=i.bitrate?jg.Better:r.bitrate===o.bitrate?jg.Same:jg.Worse);o!==jg.Better&&(o!==jg.Same||a.mediaOptionId===n.mediaOptionId||e.mediaOptionId!==n.mediaOptionId&&!xu(n,e))||(a=e)}return a}}Qy.kAllowFilters=Qy.makeFilters();const qy={name:"abr"};function jy(e,t){var i=e.bitrate;if(e.iframes){e=e.frameRate||1;return i*(t.minIframeDuration/e)}return i}function Hy(e,t){return Z(e)?Math.min(e,t):t}function Gy(e){return Z(null==e?void 0:e.avgBandwidth)}function Wy(e){return 0!==e.playbackRate?Math.abs(e.playbackRate):1}function zy(e,t){return e.getCurrentWaterLevelByType(Iu.Variant,t)/Wy(e)}function Yy(t,i,e,r){if(e)return t;let n=-1;if(t<0)return n;for(let e=t;e<i.length;++e){const t=Jy(i[e],r);if(t.altAudio&&t.subtitle){n=e;break}}return n}function Xy(t,e,i,r,n,s,a){let o=i.filteredMediaOptions[Tu.Variant].filter(e=>e.iframes===t&&Pu(e.pathwayID,i.currentPathwayID));if(t&&!o.length&&(o=i.filteredMediaOptions[Tu.Variant].filter(e=>e.iframes===t)),!o.length)return a.warn("No variants available for playback."),{variantMediaOption:qu.mediaOptionId,holdOffDuration:0,lowestCandidate:null};let l=0;const d=i.nextMinAutoOptionId;if(d!==qu.mediaOptionId){const t=o.findIndex(e=>e.mediaOptionId===d);0<=t&&(l=t)}if(l=Yy(l,o,t,i),l<0)return{variantMediaOption:qu.mediaOptionId,holdOffDuration:0,lowestCandidate:null};let u=o.length-1;const c=i.nextMaxAutoOptionId;if(c!==qu.mediaOptionId){const t=o.findIndex(e=>e.mediaOptionId===c);0<=t&&(u=t)}var h=i.variantMediaOptionById(r.mediaOptionId),p=r.mediaOptionDetails,a=(null==h?void 0:h.iframes)!==t?0:zy(n,e.maxBufferHole);let f,m;if(t){const t=e.desiredIframeFPS;m=p?p.targetduration/t:0,m=Math.max(1/t,m)}else m=p?p.targetduration:0;h=e.abrBandWidthUpFactor,p=e.abrBandWidthFactor;return f=Zy(o,m,l,u,a,t,s.getCombinedEstimate(e,void 0,!1),s.bandwidthStatus,p,h,e,i,r,n),f.variantMediaOption===qu.mediaOptionId&&(f=Zy(o,m,l,u,a+Hy(m,e.maxStarvationDelay),t,s.getCombinedEstimate(e,void 0,!1),s.bandwidthStatus,p,h,e,i,r,n),f.variantMediaOption===qu.mediaOptionId&&0<=l&&(f.variantMediaOption=o[l].mediaOptionId,f.alternates=t?null:Jy(o[l],i))),f}function Jy(e,t){var i=t.enabledMediaOptionKeys,r=i[Tu.AltAudio],r=ju(r)?t.mediaOptionListQueries[Tu.AltAudio].getMatchingAlternate(r.mediaOptionId,e):qu,i=i[Tu.Subtitle];return{altAudio:r,subtitle:ju(i)?t.mediaOptionListQueries[Tu.Subtitle].getMatchingAlternate(i.mediaOptionId,e):qu}}function Zy(e,t,i,r,n,s,a,o,l,d,u,c,h,p){return u.abrAlgorithm,function(i,r,n,e,s,a,o,l,t,d,u,c,h,p){const f=l.bandwidthSampleCount,m=c.abrStatus,g=p.maxBufferSize,y=u.minTargetDurations||1,v=c.mediaOptionListQueries[Tu.Variant].mediaOptionListInfo.hasScore;if(!i.length)return{variantMediaOption:qu.mediaOptionId,holdOffDuration:-1,lowestCandidate:null};const S=c.enabledMediaOptionIdByType(Tu.Variant),b=c.variantMediaOptionById(S),T=null!=i.find(e=>e.mediaOptionId===S),I=b&&b.iframes===a,E=b&&I?b.score:void 0,w=b&&I?b.frameRate:void 0,O=b&&I?b.height:void 0,A=I?zy(p,u.maxBufferHole):0,R=p.getMediaBufferInfo(p.desiredPos,p.getBufferedSegmentsByType(Iu.Variant),u.maxBufferHole);e=Math.max(0,Math.min(i.length-1,e)),n=Math.max(0,Math.min(i.length-1,n));var k=h.mediaOptionDetailsEntityRecord,C=tv(o.avgBandwidth,d,t,f);let M;for(let t=e;t>=n;t--){const n=i[t];let e=n.mediaOptionId;const h=n.score,p=k&&k[e]?k[e].mediaOptionDetails:void 0,U=k&&k[e]?k[e].lastUpdateMillis:null,$=p?p.totalduration/p.fragments.length:r,f=null!=b&&n.bitrate>b.bitrate,V=null!=b&&n.bitrate<b.bitrate,K=!(null!=w&&(f&&n.frameRate<w||V&&n.frameRate>w)),Q=!(f&&null!=O&&O>n.height),q=!(V&&(n.bitrate===b.bitrate-1||n.bitrate===b.bitrate+1)),j=!(v&&f&&null!=E&&(h<E||h===E&&b&&n.bitrate>=b.bitrate)),H=n.iframes===a;if(Z($)&&H&&K&&Q&&q&&j){var{adjustedbw:P,adjustedBitrate:x,fetchDuration:D,rejectLevelDueToPeakBW:_,canFitMultipleSegments:L,requireAlternates:N,alternates:F,validFlowRate:B}=function(e,t,i,r,n,s,a,o,l,d,u,c,h,p,f){var m=a?d.bwUp:d.bwDown,g=e["trickPlaybackConfig"],a=jy(t,g),d=i?i.totalduration/i.fragments.length:u,{totalTime:h,avgTime:o}=iv(e,t,i,u,l,n,h,o),g=jy({bitrate:t.bandwidth,iframes:t.iframes,frameRate:t.frameRate},g),i=null!==(i=null==i?void 0:i.targetduration)&&void 0!==i?i:d,r=a<m&&m<g&&r<=2*d,c=s*((g||t.bitrate||0)*i)/8<=c,d=o<=d;let y=null;p=!p;return p&&(y=Jy(t,f),y.altAudio&&y.subtitle||(y=null)),{adjustedbw:m,adjustedBitrate:a,fetchDuration:h,rejectLevelDueToPeakBW:r,canFitMultipleSegments:c,requireAlternates:p,alternates:y,validFlowRate:d}}(u,n,p,A,R,y,f,(null==b?void 0:b.mediaOptionId)!==n.mediaOptionId,o,C,r,g,U,a,c);if((a||N&&Boolean(F))&&(M=e),x<P&&L&&!_&&B&&(!N||Boolean(F))&&(a||!D||D<s)){if(B=P,N=m,P=(P=l).instantBw,(N.fragDownloadSlow||N.fragDownloadTooSlow||Z(P)&&P<B)&&T&&I)if(A<=2*$&&f)e=S;else if(f&&d*l.instantBw<x)continue;return{variantMediaOption:e,holdOffDuration:D,alternates:F,lowestCandidate:M}}}}return{variantMediaOption:qu.mediaOptionId,holdOffDuration:-1,lowestCandidate:M}}(e,t,i,r,n,s,a,o,l,d,u,c,h,p)}function ev(e){let t=0;var{avgPlaylistLoadTimeMs:i,avgLatencyMs:e}=e;return Z(i)?t=i:Z(e)&&(t=e),t}function tv(e,t,i,r){let n,s;return 4<=r?(n=e*t,s=e*i):n=s=e/1.8,{bwUp:n,bwDown:s}}function iv(e,t,i,r,n,s,a,o){var l=n.avgBandwidth,d=t.bitrate,u=i?i.totalduration/i.fragments.length:r,t=d*u,r=ev(n),d=t/l,t=null==i||i.liveOrEvent,l=rv(n,!1,!1),o=rv(n,o,t);let c=0;if(s){const h=(null===(t=null===(t=s.sbTuple[Tu.Variant])||void 0===t?void 0:t.buffered)||void 0===t?void 0:t.len)||0,p=i?yg(e,i,s):Hy(u,e.maxStarvationDelay);c=Math.max(0,Math.ceil((p-h)/u))}null==i||!i.liveOrEvent||i.ptsKnown&&!sv(i.totalduration,r,a)||(c=1);l=d+l;return{totalTime:d+o+c*l,avgTime:l}}function rv(t,i,e){let r=bg(1/0,t)+Tg(1/0,t);if(i){const i=t["avgInitFragAppendMs"];Z(i)&&(r+=i/1e3)}if(e){const i=t["avgPlaylistParseTimeMs"];let e=ev(t);Z(i)&&(e+=i),r+=e/1e3}return r}function nv(t,e){let i=1/0;if(t===qu.mediaOptionId)return i;var r=e.find(e=>e.mediaOptionId===t);if(!r)return 1/0;const n=r.iframes,s=r.bitrate,a=r.frameRate,o=e.find(e=>e.iframes===n&&(void 0===a||e.frameRate>=a)&&e.bitrate>s);return o&&(i=o.bitrate),i}function sv(e,t,i){return t=Z(t)?t:0,!Z(i)||performance.now()-i+t>1e3*e}function av(e,t){return(null==e?void 0:e.fragDownloadSlow)===(null==t?void 0:t.fragDownloadSlow)&&e.fragDownloadTooSlow===(null==t?void 0:t.fragDownloadTooSlow)}function ov(e){return"loading"===(null==e?void 0:e.state)&&Z(null===(e=e.bwSample)||void 0===e?void 0:e.trequest)}function lv(e,t,i,r){let{fragDownloadSlow:n,fragDownloadTooSlow:s}=t;var a=i.variantMediaOptionById(e.mediaOptionId).bitrate,t=e.bwSample;r=r.child(qy);i=t.total||Math.max(t.loaded,Math.round(e.duration*a/8)),a=performance.now()-t.tfirst,i=t.loaded*e.duration*1e3/i;return 2e3<=a&&1e3<=a-i&&(n||r.warn(`flow indicates low bandwidth, after time/duration behind real time: ${a}/${a-i}`),n=!0),a>=1e3*e.duration&&(s||r.warn(`too much time spent downloading fragment, likely to switch down ${a} > ${1e3*e.duration}`),s=!0),{fragDownloadSlow:n,fragDownloadTooSlow:s}}function dv(e,t,i,r,n){r=function(e,t,i,r,n){var s;const a=n.logger.child(qy),o=r.isIframeRate,l=i.mediaOptionListQueries[Tu.Variant].filteredMediaOptionList,d=i.enabledMediaOptionKeys[Tu.Variant];let u=e;if(u!==xm.None||l.some(e=>e.mediaOptionId===d.mediaOptionId)||(u=xm.PreferredListChanged),u===xm.None)return null;if(o&&u!==xm.IframeModeChange&&r.getBufferedSegmentsByType(Iu.Variant).filter(e=>e.frag.iframe).length<t.minFramesBeforeSwitchingLevel)return null;o&&u===xm.IframeModeChange&&n.setEnabledVariantMediaOptionIdBeforeTrickplaySwitch(i.itemId,d.mediaOptionId);const c=Vm(i.itemId,i.parentItemId),h=vy(d),p=[qu,qu,qu];if(!o&&e===xm.IframeModeChange){const e=function(e,t,i,r){const n=i.mediaOptionListQueries[Tu.Variant].filteredMediaOptionList,s=t.targetStartupMs,a={avgPlaylistParseTimeMs:0,avgPlaylistLoadTimeMs:0},o=r.getFragEstimate(),l={avgBufferCreateMs:0,avgInitFragAppendMs:0,avgDataFragAppendMs:0},d=o.maxDurationSec,u={avgLatencyMs:0,avgBandwidth:r.getBandwidthEstimate().avgBandwidth},c={targetDuration:d,targetStartupMs:s,metricsOverride:{maxValidHeight:0,maxValidBitrate:0,maxPreferredBitrate:0}},h=n.filter(e=>!e.iframes&&(!e.width||!e.height||e.width*e.height<=2488320));let p=e;0<h.length&&(p=h[0].mediaOptionId);e=h.filter(e=>Eg(e,u,c,a,o,l));return 0<e.length&&(p=e[e.length-1].mediaOptionId),p}(i.enabledVariantMediaOptionIdBeforeTrickplaySwitch,t,i,c);n.setNextMaxAutoOptionId(i.itemId,e),n.setEnabledVariantMediaOptionIdBeforeTrickplaySwitch(i.itemId,void 0)}var f=function(e,t,i,r,n,s,a){let o=t.nextMaxAutoOptionId;const l=t.abrStatus["fragDownloadTooSlow"];if(o===qu.mediaOptionId||!l&&Gy(s.getBandwidthEstimate()))return d=e,u=t,c=r,e=n,r=s,s=a.child({name:"abr"}),a=e.isIframeRate,u.enabledMediaOptionIdByType(Tu.Variant),Xy(a,d,u,c,e,r,s);if(n.isIframeRate)return{variantMediaOption:o,holdOffDuration:0,lowestCandidate:null};{const h=t.variantMediaOptionById(o),p=t.enabledAlternateMediaOptionByType(Tu.Subtitle),n=t.enabledAlternateMediaOptionByType(Tu.AltAudio),f=null==n?void 0:n.persistentID,m=null==p?void 0:p.persistentID,l=!t.preferHDR,g=i.getBestMediaOptionTupleFromVariantAndPersistentId(t,h,f,m,void 0,[],l,!1,!1);return t.isValidMediaOptionTuple(g)?(o=g[Tu.Variant].mediaOptionId,{variantMediaOption:o,holdOffDuration:0,alternates:{altAudio:g[Tu.AltAudio],subtitle:g[Tu.Subtitle]},lowestCandidate:null}):{variantMediaOption:t.enabledMediaOptionKeys[Tu.Variant].mediaOptionId,holdOffDuration:0,lowestCandidate:null}}var d,u,c}(t,i,n,h,r,c,a);if(o||e!==xm.IframeModeChange||n.setNextMaxAutoOptionId(i.itemId,qu.mediaOptionId),f.variantMediaOption===d.mediaOptionId)return null;p[Tu.Variant]={itemId:i.itemId,mediaOptionId:f.variantMediaOption};for(const e of[Tu.AltAudio,Tu.Subtitle]){const t=i.enabledMediaOptionIdByType(e);if(t!==qu.mediaOptionId){const r=e===Tu.AltAudio?null===(s=f.alternates)||void 0===s?void 0:s.altAudio:null===(s=f.alternates)||void 0===s?void 0:s.subtitle;p[e]=r||{itemId:i.itemId,mediaOptionId:t}}}return p}(e,t,i,r,n);r&&n.setEnabledMediaOptions(i.itemId,r)}function uv(e,t){var i=null==e?void 0:e.mediaOptionDetails;if(!i)return!1;var r=performance.now();return r-(e.lastUpdateMillis||r)<t*i.targetduration*1e3}const cv={name:"avpipe"},hv=(r,n)=>e=>{const t=r["rootPlaylistQuery"],i=r.logger.child(cv);return e.pipe(Hi(ir),To(t.enabledMediaOptionKeys$),La(([t,e])=>function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=e[e.length-1];return"function"==typeof i&&e.pop(),$i(e,void 0).lift(new kn(i))}(pv(t,Tu.Variant,r,e),pv(t,Tu.AltAudio,r,e)).pipe(pr(e=>({action:t,detailsAndContext:e})))),La(({action:e,detailsAndContext:t})=>function(r,n,s,a,o){const{mediaSink:l,config:d,interstitialController:e}=s,u=[o[Tu.Variant].detailsEntity.mediaOptionDetails,null===(p=null===(p=o[Tu.AltAudio])||void 0===p?void 0:p.detailsEntity)||void 0===p?void 0:p.mediaOptionDetails];let t=n.getNextFragments(a,u,r);for(;t.chosenFrags.some(e=>{return null===(e=null===(e=null==e?void 0:e.foundFrag)||void 0===e?void 0:e.mediaFragment)||void 0===e?void 0:e.gap});)t.chosenFrags.forEach(e=>{e=null===(e=null==e?void 0:e.foundFrag)||void 0===e?void 0:e.mediaFragment;null!=e&&e.gap&&l.updateContentGapRanges(Xu(e.mediaOptionType),{start:e.start,end:e.start+e.duration})}),t=n.getNextFragments(a,u,r);let c=t.chosenFrags;const h=t.discoChanged,i=c.reduce((e,t)=>Math.max(e,Z(null==t?void 0:t.newMediaRootTime)?t.newMediaRootTime:-1/0),-1/0);if(Z(i)&&(l.seekTo=i,c=[null,null]),c.every(e=>null==(null==e?void 0:e.foundFrag)))return Vi(null);var p=c[0];return(null!=p&&p.foundFrag?e.fragmentIsInterstitialBoundary(p.foundFrag.mediaFragment,s):Vi(!1)).pipe(As(1),La(e=>{if(e)return Vi(null);{const t=null!==(e=null===(e=l.mediaQuery.bufferMonitorInfo)||void 0===e?void 0:e.lowWaterLevelSeconds)&&void 0!==e?e:0,i=eg(u)&&c.every(e=>null!=(null==e?void 0:e.foundFrag))&&!1===h&&a.bufferInfoTuple.every(e=>{return(null===(e=null==e?void 0:e.buffered)||void 0===e?void 0:e.len)<=t})&&d.firstAudioMustOverlapVideoStart;e=c.map(function(i,r,n,s,t,a){const{mediaSink:o,iframeMachine:l,rootPlaylistQuery:d}=n;if(t&&null!=t.foundFrag){var u=t.foundFrag["mediaFragment"],c=Ay(n,u.keyTagInfo,{itemId:u.itemId,mediaOptionId:u.mediaOptionId}),u=a===Tu.Variant?Ah(function(e,t){const{config:i,mediaSink:r,rootPlaylistQuery:n,rootPlaylistService:s}=e,a=r.mediaQuery,o=e.logger.child(qy);return a.isIframeRate&&i.abrTrickplayLevelLocked?un:dn((t=n.getInFlightFragByType$(Tu.Variant),l=n,d=o,rd([a.fellBelowLowWater$,t]).pipe(La(e=>{var[,t]=e;return ov(t)?Vi(e):wi}),ia((e,[t,i])=>{const r=Object.assign({},e);return t&&(r.fragDownloadSlow=!0),lv(i,r,l,d)},{fragDownloadSlow:!1,fragDownloadTooSlow:!1}),_a({fragDownloadSlow:!1,fragDownloadTooSlow:!1}),bs(av))),function(e,r){const a=r.mediaSink.mediaQuery,{rootPlaylistQuery:n,config:o}=r;return a.desiredRate$.pipe(La(i=>0===i?wi:rd([e,n.mediaOptionListQueries[Tu.Variant].filteredMediaOptionList$.pipe(pr(e=>e.filter(e=>{return t=Rf(i),e.iframes===t&&Pu(e.pathwayID,n.currentPathwayID);var t})))])),La(e=>{const[t,i]=e;if(!ov(t)||i.findIndex(e=>e.mediaOptionId===t.mediaOptionId)<=0)return wi;var{tfirst:r,trequest:n}=t.bwSample,s=Z(r),r=performance.now()-(s?r:n),n=Hy(t.duration,o.maxStarvationDelay);return r<Math.min(1e3*n,500*t.duration/a.playbackRate)?wi:Vi(e)})).pipe(ia((e,[t,i])=>function(t,i,r,n){let{fragDownloadSlow:e,fragDownloadTooSlow:s}=t;const{config:a,rootPlaylistService:o,rootPlaylistQuery:l,mediaSink:d,statsService:u,mediaLibraryService:c}=n,h=n.logger.child(qy),p=d.mediaQuery,f=i.bwSample;if(!Z(f.tfirst))return t;var m=performance.now(),g=m-f.tfirst,y=Hy(i.duration,a.maxStarvationDelay);if(p.paused&&g/1e3<y)return t;const v=Tu.Variant,S=i.mediaOptionId,b=l.variantMediaOptionById(S),T=c.getQueryForOption(b),I=i.itemId,E=u.getQueryForItem(I),w=E.getCombinedEstimate(a,void 0,!1),O=b.bitrate,A=Math.max(1,8e3*f.loaded/g),R=Sg(i,O,w,w,w,!0),k=zy(p,a.maxBufferHole);let C;if(Z(k)&&0<k&&!Z(null===(P=p.seekTo)||void 0===P?void 0:P.pos))C=k;else{const D=g/1e3;C=D<y?y-D:y}var M=e;({fragDownloadSlow:e,fragDownloadTooSlow:s}=lv(i,t,l,h));var P=2*((null===(n=T.mediaOptionDetails)||void 0===n?void 0:n.targetduration)||i.duration);if(!(k<=P&&(R>=C||e)))return Xm().extendMaxTTFB&&Ym().setExtendMaxTTFB(0),{fragDownloadSlow:e,fragDownloadTooSlow:s};let x;M||h.warn(`likely to stall ${te({maxTimeToLoadSec:C,minSwitchDuration:P,stats:f,elapsedMs:g,remainingTimeSec:R,instantBw:A,bufferAheadSec:k,fragDownloadSlow:e})}`),e=!0,Xm().extendMaxTTFB||Ym().setExtendMaxTTFB(6e5);y=Object.assign(Object.assign({},w),{avgBandwidth:A}),t=E.bandwidthStatus,n=b.iframes,M=R>=C&&!n,P=Yy(0,r,n,l);if(P<0)return{fragDownloadSlow:e,fragDownloadTooSlow:s};g=Math.max(P,r.findIndex(e=>e&&e.mediaOptionId===b.mediaOptionId)-1);if(M){let e=Zy(r,i.duration,P,g,C,n,y,t,1,1,a,l,T,p);const _=qu.mediaOptionId;x=e.variantMediaOption!==_||(e=Zy(r,i.duration,P,g,R,n,y,t,1,1,a,l,T,p)).variantMediaOption!==_?e.variantMediaOption:e.lowestCandidate}else{const D=Yy(0,r.slice(P,g+1).reverse(),n,l),i=g-D;(0<=D||g===P)&&(x=r[i].mediaOptionId)}if(null!=x&&x!==l.abrStatus.nextMaxAutoOptionId&&o.setNextMaxAutoOptionId(I,x),M)throw h.warn(`loading too slow, abort fragment loading and switch to level ${x}`),u.setBandwidthSample(Object.assign(Object.assign({},f),{tfirst:f.tfirst||m,tload:f.tload||m,complete:!0,mediaOptionType:v})),s=!0,new Sc({mediaOptionType:v,mediaOptionId:S},x,K.FragmentAbortError);return{fragDownloadSlow:e,fragDownloadTooSlow:s}}(e,t,i,r),{fragDownloadSlow:!1,fragDownloadTooSlow:!1}),_a({fragDownloadSlow:!1,fragDownloadTooSlow:!1}),bs(av))}(t,e)).pipe(_a({fragDownloadSlow:!1,fragDownloadTooSlow:!1}),ia((e,t)=>({fragDownloadSlow:e.fragDownloadSlow||t.fragDownloadSlow,fragDownloadTooSlow:e.fragDownloadTooSlow||t.fragDownloadTooSlow})),bs(av),pr(e=>(s.setFragLoadSlow(n.itemId,e),{abort:!1})),Qn(e=>{if(e instanceof Sc){var t={fragDownloadSlow:!0,fragDownloadTooSlow:!0};return s.setFragLoadSlow(n.itemId,t),Vi({abort:!0,error:e})}return Ki(e)}));var l,d}(n),e=>null!=e.error).pipe(pr(e=>{throw e.error})):un;let e=((i,r,e,n=un)=>{const{rootPlaylistService:s,rootPlaylistQuery:a}=i,{timelineOffset:o,mediaFragment:l}=e.foundFrag,{itemId:d,discoSeqNum:u}=l;return Ty(i,l).pipe(La(t=>yn(Oy(i,l,!0,!0),n).pipe(As(1),La(e=>{return s.updateInflightFrag(d,r,l,"parsing",null),function(e,t,i,g,y,v){const r=new Uint8Array(e),{legibleSystemAdapter:n,rootPlaylistService:s,mediaSink:a,mediaParser:o,rootPlaylistQuery:l,mediaLibraryService:S}=v,d=a["mediaQuery"],b=S.getQueryForOption(g),{mediaOption:u,mediaOptionDetails:c,mediaOptionDetailsEntityRecord:h}=b,p=c["initSegments"],{itemId:T,mediaOptionId:I}=u,f=h[I]["initSegmentCacheEntities"],{discoSeqNum:E,mediaSeqNum:w,mediaOptionType:m,isLastFragment:O}=g,A=d.seeking,R=c.liveOrEvent,k=p[E],C=f[E],M=m===Tu.Variant&&c.ptsKnown,P={segment:r,frag:g,seeking:A,live:R,ptsKnown:M,totalDuration:c.totalduration,defaultInitPTS:t,iframeMediaStart:yf(g)?g.iframeMediaStart:void 0,iframeDuration:yf(g)?g.iframeMediaDuration:void 0,iframeOriginalStart:yf(g)?g.iframeOriginalStart:void 0};let x;if(null!=i&&(null===(t=g.keyTagInfo)||void 0===t?void 0:t.uri)===(null===(t=i.keyTagInfo)||void 0===t?void 0:t.uri)){if(x=Vi(i),C){const e=C[0];if(e){const D=e["data"],i=new Uint8Array(D);P.initSegment=i}}}else if(null!=i&&Iy(i.fragment)){const D=Object.assign(Object.assign({},i.fragment),{keyTagInfo:g.keyTagInfo}),y=k?i.data:e;x=Ey(y,D,v),P.initSegment=new Uint8Array(y)}else Iy(g)?(x=Ey(e,g,v),P.initSegment=r):x=Vi(null);return x.pipe(La(f=>{const m=performance.now();return g.mediaOptionType===Tu.Variant&&(null==n||n.setupForFrag(g)),o.parseSegment(P,"").pipe(pr(e=>{var t=performance.now(),{startPTS:i,startDTS:r,endPTS:n,endDTS:s,firstKeyframePts:a,framesWithoutIDR:o,dropped:l,data1:d,data2:u,captionData:c,id3Samples:h,parsedInitSegment:e}=e,t={durationSec:n.baseTime/n.timescale-i.baseTime/i.timescale,parseTimeMs:t-m};if(v.statsService.setFragSample(t),e){const{track:m,moovData:p,mimeType:y}=e,v=m["initSegment"];f=null===f?wy(e,g,b):{itemId:T,mediaOptionId:I,discoSeqNum:E,initParsedData:p,data:v,mimeType:y,keyTagInfo:g.keyTagInfo,fragment:g};const t=C?C[0]:null;S.archiveInitSegmentEntity(t,f)}t=g.keyTagInfo,h={itemId:T,mediaOptionId:I,mediaSeqNum:w,discoSeqNum:E,startDtsTs:r,endDtsTs:s,timelineOffset:y,firstKeyframePts:a,framesWithoutIDR:o,dropped:l,data1:d,data2:u,startPts:i,endPts:n,keyTagInfo:t,isLastFragment:O,iframe:null!==(t=g.iframe)&&void 0!==t&&t,duration:g.duration,iframeMediaDuration:yf(g)?g.iframeMediaDuration:void 0,iframeOriginalStart:yf(g)?g.iframeOriginalStart:void 0,captionData:c,id3Samples:h};return[f,h]}))}),ey(s,l,m,I))}(e,null===(e=a.getInitPTS(u))||void 0===e?void 0:e.offsetTimestamp,t,l,o,i)}),eo(e=>{s.updateInflightFrag(d,r,l,"parsed",null)}),Jc(`retrieveMediaFragmentCacheEntity.${r}.emit`))),As(1))})(n,a,t,u).pipe(eo(e=>{const t=e[1],i=s[a].switchContext;t.switchPosition=null==i?void 0:i.switchPosition;var r=null!==(n=null==i?void 0:i.userInitiated)&&void 0!==n&&n,e=o["mediaQuery"],{desiredRate:n,isIframeRate:e}=e,n=e&&l.isStarted&&n&&n<0&&n!==l.iframeRate;(r||n)&&(t.flushBeforeAppend={start:0,end:Number.POSITIVE_INFINITY})}));return e=a===Tu.Variant?e.pipe(eo(e=>{var t=function(t,i,r){if(!e)return null;const{rootPlaylistService:n,rootPlaylistQuery:s}=i,a=s.itemId,o=e[1],l=o.iframe;let d=s.getInitPTS(r);if(null==d||!l&&d.iframeMode){const u=null!==(i=o.startDtsTs)&&void 0!==i?i:null;if(null==u)return t.warn("updateInitPTS: Variant data missing."),null;let e=null!==(t=o.timelineOffset)&&void 0!==t?t:0;l&&(e=null!==(t=o.iframeOriginalStart)&&void 0!==t?t:0),u.timescale<1e3&&(u.timescale=1e3*u.timescale,u.baseTime=1e3*u.baseTime);const s=F(e,u.timescale),c={baseTime:u.baseTime-s.baseTime,timescale:u.timescale};n.setInitPTS(a,r,u,e,c,l),d={variantDTS:u,timelineOffset:e,offsetTimestamp:c,iframeMode:l}}return d}(i,n,r.discoSeqNum);fv(i,n,e,t)})):tn([e,Ah(d.initPTS$(r.discoSeqNum),e=>{var t=o.mediaQuery.isIframeRate;return null!=e&&(t||!e.iframeMode)})]).pipe(pr(([e,t])=>(fv(i,n,e,t),e))),tn([c,e]).pipe(pr(e=>e[1]))}return Vi(null)}.bind(null,r,n,s,o));return i?dn(...e).pipe(pr(e=>{const t=[null,null];return t[e[0].fragment.mediaOptionType]=e,mv(r,s,n.discoSeqNum,t)}),ia((e,i,t)=>{if(!i)return{consumerInput:i,emit:!0};var r=i["appendDataTuple"],r=s.mediaSink.isCompatibleWithSourceBuffers(r);if(!(0!==t||r.compatible&&Z(r.boundary)))return{consumerInput:i,emit:!1};if(null!=e.consumerInput&&!1===e.emit){const s=e.consumerInput;zu.forEach(e=>{var t;i.appendDataTuple[e]=null!==(t=i.appendDataTuple[e])&&void 0!==t?t:s.appendDataTuple[e],i.inFlightFrags[e]=null!==(t=i.inFlightFrags[e])&&void 0!==t?t:s.inFlightFrags[e]}),i.initPTSInfo=null!==(e=i.initPTSInfo)&&void 0!==e?e:s.initPTSInfo}return{consumerInput:i,emit:!0}},{consumerInput:null,emit:!1}),cn(e=>e.emit),pr(e=>e.consumerInput)):tn(e).pipe(pr(e=>mv(r,s,n.discoSeqNum,e)))}}),Qn(e=>{if(e instanceof Sc)return Vi(null);throw e}))}(i,n,r,e,t)),Jc("mediaProducerEpic.emit"))};function pv(e,i,t,r){const{rootPlaylistQuery:n,mediaLibraryService:s,config:a}=t,o=r[i];if(t.logger.child({name:Gu[i]}),!o||"Nah"===o.mediaOptionId)return Vi({detailsEntity:null,switchContext:null});const l=s.getQueryForOption(o);return Pr([Vi(e),l.mediaOptionDetailsEntity$.pipe(bs((e,t)=>(null==e?void 0:e.lastUpdateMillis)===(null==t?void 0:t.lastUpdateMillis)),cn(e=>{var t=null==e?void 0:e.mediaOptionDetails;return!t||!t.liveOrEvent||uv(e,a.livePlaylistUpdateStaleness)}))]).pipe(cn(([,e])=>{if(i===Tu.AltAudio&&!n.altMediaOptionHasValidUrl(i,o.mediaOptionId))return!0;var t=null==e?void 0:e.mediaOptionDetails;return null!=t&&(e=null!==(e=e.lastUpdateMillis)&&void 0!==e?e:0,!t.liveOrEvent||!t.ptsKnown||!sv(null==t?void 0:t.totalduration,0,e))}),As(1),To(n.enabledMediaOptionSwitchContextsByType$(i)),pr(([[,e],t])=>({detailsEntity:e,switchContext:t})))}function fv(e,t,i,r){const{mediaLibraryService:n,rootPlaylistQuery:s,mediaSink:a}=t,o=s.itemId;null!=r&&(a.mediaQuery.isIframeRate||!r.iframeMode?i&&!Z(i[1].iframeMediaDuration)&&(performance.now(),n.updatePTSDTS(o,i[1].mediaOptionId,r,i[1])):e.warn("updatePTSDTS iframeMode mismatch"))}function mv(p,t,e,i){const{rootPlaylistQuery:r,mediaSink:n,config:f}=t,m=n.mediaQuery,s=m.isIframeRate,a=r.getInitPTS(e);if(null==a)return p.warn("No initPTS info found"),null;t=i[Tu.Variant],e=null==t?void 0:t[1];if(e&&e.iframe!==s)return p.warn(`frag mediaSeqNum ${e.mediaSeqNum} discoSeqNum ${e.discoSeqNum} mediaOptionId ${e.mediaOptionId} doesn't match mediaSink's iframeMode ${s}; discard`),null;const g=[null,null];if(t){const[p,l]=t;let e=a.offsetTimestamp;if(s){const p=l.startDtsTs,d=F(l.timelineOffset,p.timescale);e={baseTime:p.baseTime-d.baseTime,timescale:p.timescale}}g[Iu.Variant]={initSeg:p,dataSeg:l,offsetTimestamp:e}}i=i[Tu.AltAudio];if(null!=i){const[p,l]=i;g[Iu.AltAudio]={initSeg:p,dataSeg:l,offsetTimestamp:a.offsetTimestamp}}const o=g.map((t,i)=>{var e=null==t?void 0:t.dataSeg;if(e){var{itemId:r,mediaOptionId:n,mediaSeqNum:s,discoSeqNum:a,startPts:o,endPts:l,duration:d,iframe:u}=e,c=t["offsetTimestamp"],t=y(o,c),o=y(l,c),l=vy(e),c=g[0];if((!c||!c.dataSeg.dropped)&&!e.flushBeforeAppend&&(null===(e=null===(e=m.getBufferInfo(t,f.maxBufferHole)[i])||void 0===e?void 0:e.buffered)||void 0===e?void 0:e.len)>=o-t){let e;if(c){const p=t+(o-t)/2,h=m.getBufferedSegmentsByType(i).find(e=>e.startPTS<p&&e.endPTS>p);e=c.dataSeg.mediaOptionId===(null==h?void 0:h.frag.mediaOptionId)}if(!c||e)return p.warn(`${Gu[i]} Discarding append due to complete overlap with existing buffer`),g[i]=null}return{start:t,duration:u?d:o-t,itemId:r,mediaOptionId:n,mediaSeqNum:s,discoSeqNum:a,targetDuration:l.mediaOptionDetails.targetduration}}return null});return o.every(e=>!e)?null:{appendDataTuple:g,inFlightFrags:o,initPTSInfo:a}}function gv(e,t,i,r){return dn(function(y,r,e){const{config:d,mediaLibraryService:n,rootPlaylistService:u,rootPlaylistQuery:c,mediaSink:s,gaplessInstance:a,iframeMachine:t}=y,h=s.mediaQuery,i=e.enabledMediaOptionSwitchInfo$.pipe(If()),o=Vm(c.itemId),p=y.logger.child(cv),l=c.anchorTime$.pipe(Jc("anchorTime.audiovideo.in")),f=h.isIframeRate$.pipe(bs()),m=new mg(p,u,c,s.mediaQuery,t,d);return i.pipe(La(e=>{e=Vi(e).pipe(La(e=>{e=e.map(({fromId:e,toId:t},i)=>function(t,i,r,n,s){var e,a,o;const{rootPlaylistQuery:l,rootPlaylistService:d,mediaSink:u,mediaParser:c,config:h,iframeMachine:p,interstitialController:f}=t,m=u.mediaQuery;if(!n||!s||n===s&&(r===Tu.AltAudio||!p.isStarted))return Oh;switch(r){case Tu.Variant:{n!==s&&c.reset(Tu.Variant);const t=Xu(r),y=l.variantMediaOptionById(n),d=l.variantMediaOptionById(s);if(null==d||null==y)return Oh;const v=!d.iframes&&p.isStarted,S=0<p.iframeRate;if(y.iframes!==d.iframes||v)return u.toggleTrickPlaybackMode(d.iframes),v&&(Z(u.mediaQuery.postFlushSeek)||(u.postFlushSeek=p.iframeClockTimeSeconds),p.stop()),u.pause(),(v?u.flushAll(0,1/0,!0):u.flushData(t,0,1/0,!0)).pipe(eo(()=>{var e=u.mediaQuery.postFlushSeek;Z(e)&&(e=f.getAdjustedSeek(e,S?0:1/0,u.mediaQuery)["adjustedSeek"],u.seekTo=e)}));if(!h.allowFastSwitchUp||d.iframes)return Oh;var g=vy(y).mediaOptionDetails;if(null!=g&&null!=d&&y.bitrate<d.bitrate){const r=g.targetduration,n=vy(d),s=n.mediaOptionDetails,c=n.mediaOptionDetailsEntity.lastUpdateMillis,v=m.getCurrentWaterLevelByType(t,h.maxBufferHole),p=function(e,t,i,r,n,s,a,o,l){var d=s.nextMaxAutoOptionId,s=a.getCombinedEstimate(e,void 0,!1);if(d!==qu.mediaOptionId&&!Gy(s))return Number.POSITIVE_INFINITY;if(t.mediaOptionId===i.mediaOptionId)return Number.POSITIVE_INFINITY;d=tv(s.avgBandwidth,e.abrBandWidthUpFactor,e.abrBandWidthFactor,a.bandwidthStatus.bandwidthSampleCount),a=ev(s),d=i.bitrate>t.bitrate?d.bwUp:d.bwDown;if(null!=r&&r.liveOrEvent&&(!r.ptsKnown||sv(r.totalduration,a,l)))return Number.POSITIVE_INFINITY;a=o.seekTo,a=Z(null==a?void 0:a.pos)?a.pos:o.currentTime,o=o.getMediaBufferInfo(a,o.getBufferedSegmentsByType(Iu.Variant),e.maxBufferHole);return iv(e,i,r,n,Object.assign(Object.assign({},s),{avgBandwidth:d}),o,l,!0).totalTime}(h,y,d,s,r,l.abrStatus,i,m,c)+h.maxStarvationDelay,f=Math.max(l.itemStartOffset||0,m.currentTime)+p,b=null===(o=null===(a=m.sourceBufferEntityByType(t))||void 0===a?void 0:a.bufferedSegments)||void 0===o?void 0:o.find(e=>e.startPTS>=f);let e;if(b){const t=b.endPTS-b.startPTS;e=b.startPTS+Math.min(Math.max(t-h.maxFragLookUpTolerance,.5*t),.75*t)}if(Z(e)&&v>=p)return u.flushData(t,e,1/0)}}break;case Tu.AltAudio:e=l,g=s,o="Nah"===(a=n)?null:e.alternateMediaOptionById(Tu.AltAudio,a),o=Boolean(o&&o.url),g="Nah"===a?null:e.alternateMediaOptionById(Tu.AltAudio,g),g=Boolean(g&&g.url),o&&!g&&(d.setEnabledMediaOptionSwitchContextByType(l.itemId,Tu.AltAudio,s,void 0),u.resetMediaSource(m.currentTime)),c.reset(Tu.AltAudio)}return Oh}(y,(r.operation,o),i,e,t));return Zr(Vi(!0),tn(e).pipe(Ys(!1)))}),Jc("mediaOptionSwitch.audiovideo.out"));return Pr([l,e,f])}),La(([i,e,t])=>{const l=c.enabledVariantMediaOption;if(e||l.iframes!==t)return wi;t=c.enabledAVOptions$.pipe(La(e=>dn(...e.map(e=>ju(e)?n.getQueryForOption(e).liveEdgeGrows$:wi))),_a(!1));return Pr([h.needData$(d.maxBufferHole,a.inGaplessMode),t]).pipe(pr(([e])=>{var t=[c.enabledMediaOptionSwitchContexts[Tu.Variant],c.enabledMediaOptionSwitchContexts[Tu.AltAudio]];return h.getSourceBufferInfoAction(e,i,t,d.maxBufferHole)}),xs(e=>e?Vi(e).pipe(hv(y,m),(t=>e=>{const{rootPlaylistQuery:g,rootPlaylistService:y,mediaSink:v,legibleSystemAdapter:o,statsService:l,rtcService:d,interstitialController:u,itemQueue:c,config:h}=t;return e.pipe(Jc("mediaConsumerEpic.in"),zn(e=>{if(!e)return Vi(!1);const{appendDataTuple:r,inFlightFrags:m,initPTSInfo:t}=e,i=t["offsetTimestamp"];return m.forEach((e,t)=>{e&&y.updateInflightFrag(e.itemId,t,e,"appending",null)}),r.forEach(e=>{var t;e&&(t=e.dataSeg,e=c.getQueueItemForId(t.itemId).isInterstitial,o.addLegibleSamples(i,t.captionData,t.id3Samples,t.startPts,t.endPts,e))}),v.appendData(r,(e,t,i,r,n)=>{var s,a,o,l,d,u,c,h,p,f=null!==(f=m[t].targetDuration)&&void 0!==f?f:10;return s=v,a=e,o=t,l=i,d=f,u=r,c=g,h=y,p=n,e=>e.pipe(eo(()=>{h.updateConsecutiveTimeouts(c.itemId,o,!1,"append")}),ba(e=>e.pipe(La((e,t)=>{var i=e instanceof Kf&&e.isTimeout;if(h.updateConsecutiveTimeouts(c.itemId,o,i,"append"),i)return function(e,t,i,r,n,s,a,o){let l={errorAction:Dm.SendAlternateToPenaltyBox,errorActionFlags:0};var d=s.getCurrentWaterLevel(i.maxBufferHole),u=d<i.almostDryBufferSec;let c=NaN;s=i.appendErrorMaxRetry,i=a.rootPlaylistEntity.errorsByType[r].timeouts.append;u&&s<=i||s<=t?l.errorAction=Dm.SendEndCallback:c=1e3*d;s={retryDelayMs:c,maxNumRetry:s,maxRetryDelayMs:c};return l=ig(l,!1,e.response.code,n,r,a,o),og(e,t,s,l,a,o,r,n).pipe()}(e,t,u,o,l,p,c,h);if(e instanceof Qf)return function(e,t,i,r,n,s,a,o,l,d){var u=t.type,u=o.getCurrentWaterLevelByType(u,n.maxBufferHole);if(u>=n.almostDryBufferSec&&!o.isIframeRate){const t=1e3*r,n={errorAction:Dm.RetryRequest,errorActionFlags:0};return 1e3*u<t&&(d.hasFallbackMediaOptionTuple(l,s,a,!1)?n.errorAction=Dm.SendAlternateToPenaltyBox:n.errorAction=Dm.SendEndCallback),og(e,i,{retryDelayMs:t,maxNumRetry:1/0,maxRetryDelayMs:t},n,l,d,s,a)}return i<n.appendErrorMaxRetry?t.remove(0,Number.POSITIVE_INFINITY):(e.fatal=!0,Ki(e))}(e,a,t,d,u,o,l,p,c,h);if(e instanceof jf){const{mediaOptionType:a,mediaOptionId:o}=e;return dg(e,a,o,s,h,c)}throw e}))))},g.highestVideoCodec).pipe(As(1),pr(e=>{m.forEach((e,t)=>{e&&(y.updateInflightFrag(e.itemId,t,e,"appended",null),t!==Tu.Variant&&t!==Tu.AltAudio||v.updateInFlightRange(t,null))});var t=e.filter(e=>(null==e?void 0:e.fragmentType)===Tu.Variant);t.length&&(l.setBufferMetric(t[0]),null==d||d.handleFragBuffered(t[0]));e=r[Iu.AltAudio];if(null!==(t=null==e?void 0:e.dataSeg)&&void 0!==t&&t.flushBeforeAppend||Z(null===(t=null==e?void 0:e.dataSeg)||void 0===t?void 0:t.switchPosition)){const{itemId:i,mediaOptionId:r}=e.dataSeg;y.setEnabledMediaOptionSwitchContextByType(i,Tu.AltAudio,r,void 0)}e=r[Iu.Variant],e=null==e?void 0:e.dataSeg;return h.enableInterstitialPlayback&&e&&u.fragmentAppended({itemId:e.itemId,isLastFragment:e.isLastFragment}),!0}),(n=v,s=y,a=g,e=>e.pipe(Qn(e=>{if(e instanceof Vf){var{mediaOptionType:t,mediaOptionId:i}=e;return dg(e,t,i,n,s,a)}throw e}))));var n,s,a}),la((e,t)=>Boolean(t||e)))})(y)).pipe(Bs(()=>{zu.forEach(e=>{u.updateInflightFrag(c.itemId,e,null,null,null),s.updateInFlightRange(e,null)})})):wi),pr(()=>{if(!(c.getEntity(c.itemId).manualMode||h.isIframeRate&&d.abrTrickplayLevelLocked)){var i,r,n,s,a,o=c.enabledVariantMediaOption;if(o.mediaOptionId===l.mediaOptionId){let e=xm.None;i=sm(),r=h,n=d,s=null==r?void 0:r.clientWidth,a=null==r?void 0:r.clientHeight,r="object"==typeof window&&window.devicePixelRatio?window.devicePixelRatio:1,a=s&&a?{width:s*r,height:a*r}:void 0,r=(r=(null===(r=i.getQuery())||void 0===r?void 0:r.viewportInfo)||{})&&a&&(r.width!==a.width||r.height!==a.height),n.useViewportSizeForLevelCap&&r&&(i.updateViewportInfo(a),1)&&(e=xm.PreferredListChanged);let t=!1;!function(e,t){const i=u.logger.child(qy),r=e.abrStatus,n=r.fragDownloadSlow||r.fragDownloadTooSlow,s=Z(null===(t=t.seekTo)||void 0===t?void 0:t.pos);return n&&!r.fragDownloadTooSlow&&s?(i.warn("could be ignoring low bandwidth due to seek"),0):n}(c,h)?function(e,t){const i=Vm(t.itemId),r=i.getBandwidthEstimate(),n=t.abrStatus;if(Gy(r)){var s=(null===(s=i.bandwidthStatus)||void 0===s?void 0:s.bandwidthSampleCount)||0,s=tv(r.avgBandwidth,e.abrBandWidthUpFactor,e.abrBandWidthFactor,s)["bwUp"];return s>jy(Object.assign(Object.assign({},t.enabledVariantMediaOption),{bitrate:n.highBWTrigger}),e.trickPlaybackConfig)}}(d,c)&&function(){var e;const{config:t,mediaSink:i,mediaLibraryService:r,rootPlaylistQuery:n}=y,s=i.mediaQuery,a=n.enabledVariantMediaOption,o=n.getInFlightFragByType(Tu.Variant),l=s.seekTo,d=Z(null==l?void 0:l.pos)?l.pos:s.currentTime,u=s.getBufferedSegmentsByType(Iu.Variant).find(e=>e.startPTS<=d&&e.endPTS>d),c=s.getBufferInfo(d,t.maxBufferHole),h=s.getCombinedBufferInfo(d,t.maxBufferHole),p={pos:d,sbTuple:c,combined:h,playingFrag:null!==(e=null==u?void 0:u.frag)&&void 0!==e?e:null},f=r.getQueryForOption(a),m={variant:a,details:f.mediaOptionDetails},g=yg(t,f.mediaOptionDetails,p);return s.gotPlaying||vg(o,m,p,s.desiredRate,g)}()&&(e=xm.HighBandwidth,u.setNextMinAutoOptionId(o.itemId,o.mediaOptionId)):(e=xm.LowBandwidth,c.nextMaxAutoOptionId===qu.mediaOptionId&&(u.setNextMaxAutoOptionId(o.itemId,o.mediaOptionId),t=!0)),dv(e,d,c,h,u),t?u.setNextMaxAutoOptionId(o.itemId,qu.mediaOptionId):e===xm.HighBandwidth&&u.setNextMinAutoOptionId(o.itemId,qu.mediaOptionId)}else p.warn(`skip auto switch: option changed ${l.mediaOptionId}->${o.mediaOptionId}`)}}),Qn(e=>{if(y.logger.warn(`[operation] needData handle error ${JSON.stringify(e)}`),!(e instanceof g)||e.fatal)throw e;return wi}))}),Bs(()=>{}))}(e,t,r),Ah((n=e).mediaSink.mediaQuery.mediaElementEntity$,e=>e).pipe(La(e=>yv(n).pipe(Jc("anchorTime.subtitle.in"),vv(n))),Bs(()=>{})));var n}const yv=e=>{const{rootPlaylistQuery:t,rootPlaylistService:i,legibleSystemAdapter:r,itemQueue:n}=e,s=t.anchorTime$.pipe(cn(e=>Z(null==e?void 0:e.pos))),a=n.getQueueItemForId(t.itemId),o=t.enabledAlternateMediaOptionByType(Tu.Subtitle);if(a.isInterstitial){const e=t.filteredMediaOptions[Tu.Subtitle];if(0===e.length)return wi;r.setInterstitialTracks(e,o,t.getDisabledMediaOption(Tu.Subtitle))}else if(r.gotTracks){if(!o)return wi;r.selectedTrack=o}else{const e=t.filteredMediaOptions[Tu.Subtitle];r.setTracks(e,o,t.getDisabledMediaOption(Tu.Subtitle))}return rd([s,dn(r.nativeSubtitleTrackChange$.pipe(La(e=>(e.mediaOptionId!==r.selectedMediaOption.mediaOptionId&&i.setEnabledMediaOptionByType(e.itemId,Tu.Subtitle,e),wi))),t.enabledMediaOptionByType$(Tu.Subtitle).pipe(pr(e=>{e=ju(e)?t.alternateMediaOptionById(Tu.Subtitle,e.mediaOptionId):e;return r.selectedMediaOption=e}))).pipe(bs((e,t)=>(null==e?void 0:e.mediaOptionId)===(null==t?void 0:t.mediaOptionId)))]).pipe(eo(([])=>{}))},vv=s=>e=>{const{mediaSink:t,rootPlaylistQuery:r}=s,n=t.mediaQuery;return Pr([e,n.isIframeRate$.pipe(_a(!1),da(),pr(e=>e[0]&&!e[1]))]).pipe(La(([e])=>{var[,e]=e;return e&&e.url&&ju(e)?vy(e).mediaOptionDetails$.pipe(La(i=>r.discoSeqNum$.pipe(cn(({seqNum:e,wasSetInIframe:t})=>Z(e)&&!t&&!n.isIframeRate),zn(e=>{const t=e.seqNum;return Ah(r.initPTS$(t),e=>e&&!e.iframeMode).pipe(La(e=>((i,r,n,s)=>{const{legibleSystemAdapter:a,mediaSink:o}=i;return en(()=>{const e=o.mediaQuery,t=e.seekTo?e.seekTo.pos:e.currentTime;return a.findFrags$(r,n,t).pipe(La(e=>r&&null!=e&&e.foundFrags?((r,t,n,i,s)=>{const a=r["legibleSystemAdapter"],o=i.foundFrags;return en(()=>{let e=o.length;return Br(o).pipe(pr(t=>{if(t.gap){const n=r["mediaSink"];return(void 0).frag=t,(void 0).cueRange=void 0,n.updateContentGapRanges(Iu.Variant,{start:t.start,end:t.start+t.duration}),Vi(void 0)}return((e,t,i)=>{const{rootPlaylistQuery:r,legibleSystemAdapter:n}=e;return en(()=>((t,i)=>Oy(e,i,!1,!1).pipe(pr(e=>({initPTS:t,data:e,mediaFragment:i})),Jc("retrieveSubtitleFragmentCacheEntity.emit")))(t,i).pipe(La(({initPTS:e,data:t,mediaFragment:i})=>function(e,t,i,r,n){return e?n.processSubtitleFrag(e,t,i,r):Vi(void 0)}(r.enabledAlternateMediaOptionByType(Tu.Subtitle),i,e,t,n).pipe(pr(e=>({frag:i,cueRange:e}))))))})(r,n,t).pipe((i=e=>a.checkReadyToLoadNextSubtitleFragment$(t,o).pipe(cn(e=>e)),function(e){return e.lift(new fs(i))}),eo(()=>{e--}));var i}),Jr(r.config.vttConcurrentLoadCount),La(e=>a.reviewParsedFrag(t,e,i,s)!==ef.CloseEnough?(a.tryAgain$.next(tf.TryAgain),wi):Oh),Bs(()=>{0===e&&a.tryAgain$.next(tf.Complete)}))})})(i,t,s.offsetTimestamp,e,r):Oh),Bs(()=>{}))})})(s,i,t,e)),Bs(()=>{}))}),Bs(()=>{})))):Vi([null,null,null])}),Jc("subtitleEpic.process.emit"))};function Sv(r,e,n,s,a,o,l){return rd([e,a.combinedBuffer$]).pipe(La(([e])=>{if(!n.getEntity(n.itemId))return l.warn(`[operation] attempt to use stale rootPlaylistQuery for ${n.itemId}`),Oh;var t=n.enabledVariantMediaOption,i=s.getQueryForOption(t).mediaOptionDetails;if(e.some(e=>e.priority>r.priority||e.priority===r.priority&&r.priority!==Mm.Low))return Oh;t=function(e,t){t=e.getCombinedBufferInfo(e.currentTime,t);return t?t.len/Wy(e):0}(a,o.maxBufferHole),i=!!i&&t>=Math.min(o.minSteeringRunway*i.targetduration,o.maxBufferLength/2);return 1<=e.length&&i?Oh:un}))}function bv(e,t,i,r){if(200===t&&r&&10<r.length){if(Wg.isValidPlaylist(r))return!0;{const t=new L(M.NETWORK_ERROR,P.MANIFEST_PARSING_ERROR,!0,"response doesnt have #EXTM3U tag",K.PlaylistErrorMissingEXTM3U);throw t.url=e,t}}return!1}const Tv={name:"pltfrm"};function Iv(e,t){t=ep.getKeySystemSecurityLevel(t);return null!=e&&void 0!==t[e]}function Ev(e){return e.every(e=>e.iframes)}function wv(e,t){return!Z(e)||!Z(t)||e<=t}function Ov(){const r=new Set,n=new Set;return e=>{const t=(e,i)=>((e=>{var t=i?"audio":"video";r.has(e)||n.has(e)||(((e,t)=>{let i=MediaSource.isTypeSupported(`${e}/mp4;codecs=${t}`);return"mp4a.40.34"!==t||i||(i=MediaSource.isTypeSupported(`${e}/mpeg`)),i})(t,e)?r:n).add(e)})(e),n.has(e));let i=!1;return e.audioCodecList&&(i=e.audioCodecList.some(e=>t(e,!0))),!i&&e.videoCodecList&&(i=e.videoCodecList.some(e=>t(e,!1))),!i}}function Av(e,t){for(const i in e)if(e[i].type===t)return e[i];return{}}function Rv(e,t,i){t.filter(e=>!i.includes(e)).map(e=>e.mediaOptionId)}function kv(e){var t=e.filter(e=>!e.iframes||!e.width||!e.height||e.width*e.height<=2488320);return Rv(0,e,t),t}function Cv(e,o,d,l,u,c){var r=(null==l?void 0:l.maxHdcpLevel)||void 0;let h=[...e];(0<u.disableVideoCodecList.size||0<u.disableAudioCodecList.size)&&(h=function(e,t,i){let r=e.filter(e=>!e.videoCodec||e.videoCodecList.every(e=>{e=Ef(e);return!t.has(e)}));return r=r.filter(e=>!(!e.iframes&&e.audioCodec)||e.audioCodecList.every(e=>{e=Of(e);return!i.has(e)})),Rv(0,e,r),r}(h,u.disableVideoCodecList,u.disableAudioCodecList)),r&&Mg(r)&&(h=function(e){const t=Pg(r),i=e.filter(e=>{e=e.hdcpLevel;return!e||Pg(e)<=t});return Rv(0,e,i),i}(h));var t=null==l?void 0:l.maxSecurityLevel,e=null==u?void 0:u.keySystemPreference;t&&e&&Iv(t,e)&&(h=function(e,t,i){function r(e){return Iv(e,i)?n[e]:-1}const n=ep.getKeySystemSecurityLevel(i),s=ep.getKeySystemFormat(i),a=r(t),o=e.filter(e=>{e=null!==(e=null===(e=e.allowedCPCMap)||void 0===e?void 0:e[s])&&void 0!==e?e:[];let t=!0;for(const i of e)if(t=r(i)<=a,!t)break;return t});return Rv(0,e,o),[...o]}(h,t,e)),h=h.map(t=>{var e;return t.audioCodecList&&t.audioGroupId&&((e=null==(e=o.find(e=>e.groupId===t.audioGroupId))?void 0:e.channels)&&(t.audioChannelCount=parseInt(e))),t});const p=!(null==u||!u.useMediaKeySystemAccessFilter)&&e&&navigator&&"function"==typeof navigator.requestMediaKeySystemAccess;return(p?function(e,i,s){const a=new Map,r=new Array;return e.forEach(t=>{var e=Array();!function(e,t,i){var c,r=Ih(t.videoCodecList,t.audioCodecList),t=JSON.stringify(r);let n;a.has(t)?n=a.get(t):(n=ep.requestKeySystemAccess(e,r,void 0,s).pipe(pr(()=>!0),Qn(e=>(s.warn(`Request key system error: ${e.message}`),Vi(!1))),(c="object"==typeof(r={bufferSize:1,refCount:!0})?r:{bufferSize:r,windowTime:void 0,refCount:!1,scheduler:void 0},function(e){return e.lift((n=void 0===(e=c.bufferSize)?Number.POSITIVE_INFINITY:e,s=void 0===(e=c.windowTime)?Number.POSITIVE_INFINITY:e,a=c.refCount,o=c.scheduler,l=0,u=d=!1,function(e){var t;l++,!i||d?(d=!1,i=new Zi(n,s,o),t=i.subscribe(this),r=e.subscribe({next:function(e){i.next(e)},error:function(e){d=!0,i.error(e)},complete:function(){u=!0,r=void 0,i.complete()}}),u&&(r=void 0)):t=i.subscribe(this),this.add(function(){l--,t.unsubscribe(),t=void 0,r&&!u&&a&&0===l&&(r.unsubscribe(),i=r=void 0)})}));var i,r,n,s,a,o,l,d,u})),a.set(t,n)),i.push(n)}(i,t,e);e=tn(e).pipe(pr(e=>{if(void 0===e.find(e=>!1===e))return t}));r.push(e)}),tn(r).pipe(pr(e=>e.filter(e=>Boolean(e))))}(h,e,c):Vi(h)).pipe(La(e=>{if(0===e.length||Ev(e))throw new L(M.MEDIA_ERROR,P.MANIFEST_INCOMPATIBLE_CODECS_ERROR,void 0,"no media option with compatible codecs found in playlist",void 0);p&&Rv(0,h,e);let r=h.filter(e=>e.iframes&&e.imageCodec);const t=navigator&&navigator.mediaCapabilities,n=!(null==u||!u.useMediaCapabilities)&&t&&"function"==typeof t.decodingInfo;let i;return i=n?function(e,n,s){const a=[],o=Ov(),l=function(o){const l=new Map,d=navigator&&navigator.mediaCapabilities;return(i,e,t,n,r)=>{const s={type:"media-source"};n?s.video=function(e){const t={contentType:`video/mp4;codecs=${e}`,width:i.width,height:i.height,bitrate:i.bandwidth||i.avgBandwidth,framerate:i.iframes?8:i.frameRate};if(i.videoRange)switch(i.videoRange){case"PQ":ye.isDolby(e)?(t.hdrMetadataType=Hg.DoVi,t.colorGamut="rec2020"):(ye.isHEVC(e)||ye.isVP09(e))&&(t.hdrMetadataType=Hg.HDR10,t.colorGamut="rec2020"),t.transferFunction="pq";break;case"HLG":t.colorGamut="rec2020",t.transferFunction="hlg"}return t}(t):s.audio=function(e,t,i){const r={contentType:`audio/mp4;codecs=${e}`},n=_g.getRichestChannelLayoutForGroupId(t.audioGroupId,i);return n&&(r.channels=ye.getChannelCount(n).toString(),r.spatialRendering=ye.isDolbyAtmos(e,n)),r}(t,i,e);e=JSON.stringify(s);let a;return l.has(e)?a=l.get(e):(a=Br(d.decodingInfo(s)).pipe(pr(e=>{const t=e.configuration||e.supportedConfiguration,i=t instanceof Object&&(!s.video||null==Object.keys(s.video).find(e=>!(e in t.video)))&&(!s.audio||null==Object.keys(s.audio).find(e=>!(e in t.audio))),r=e.supported&&(!n||e.powerEfficient)&&i;return r||o.warn(Tv,`Unsupported config ${e.supported}/${e.powerEfficient}/${i} ${JSON.stringify(s)} supportedConfig=${JSON.stringify(t)}`),r})),l.set(e,a)),[...r,a]}}(s);return e.forEach(t=>{var e;let i=[];if(null===(e=t.videoCodecList)||void 0===e||e.forEach(e=>{i=l(t,n,e,!0,i)}),0<(null===(e=t.audioCodecList)||void 0===e?void 0:e.length)){const s=_g.getRichestAudioCodec(t.audioCodecList);i=l(t,n,s,!1,i)}let r=Vi(t);0<i.length&&(r=tn(i).pipe(pr(e=>null==e.find(e=>!1===e)?t:null),Qn(e=>(s.warn(Tv,`decodingInfo errror: ${e.message}`),Vi(o(t)?t:null))))),a.push(r)}),tn(a).pipe(pr(e=>e.filter(e=>Boolean(e))))}(e,o,c):Vi(e=function(e,r){const o=new Set,l=new Set,d=!MediaSource.isTypeSupported('audio/mp4; codecs="mp4a.40.2"; channels="-1"'),u=d&&!MediaSource.isTypeSupported('audio/mp4; codecs="mp4a.40.2"; channels="2"; features="INVALID"'),t=e.filter(e=>{let t=!1;var i;return e.audioCodecList&&e.audioGroupId&&(i=_g.getRichestChannelLayoutForGroupId(e.audioGroupId,r),0<e.audioCodecList.length&&i&&(t=((e,t)=>{var i,r,n,s=ye.isDolbyAtmos(e,t);if(u||d&&!s){n=`${i=e}/${r=t}`,o.has(n)||l.has(n)||(((e,t)=>{const i=t.split("/"),r=parseInt(i[0]);let n,s;if(1<i.length){const t=i[1].split(",")[0];n=`audio/mp4;codecs="${e}";channels="${r}";features="${t}"`,s=`audio/mp4;codecs="${e}";channels="8";features="${t}"`}else n=`audio/mp4;codecs="${e}";channels="${r}"`;let a=MediaSource.isTypeSupported(n);return!a&&s&&(a=MediaSource.isTypeSupported(s)),a})(i,r)?o:l).add(n);const a=`${e}/${t}`;return l.has(a)}return!!s})(_g.getRichestAudioCodec(e.audioCodecList),i))),!t});return Rv(0,e,t),t}((s=e,a=Ov(),a=s.filter(a),Rv(0,s,a),e=a),o)),i.pipe(pr(e=>{if(0===e.length||Ev(e))throw new L(M.MEDIA_ERROR,P.MANIFEST_INCOMPATIBLE_CODECS_ERROR,void 0,"no media option with compatible codecs found in manifest",void 0);if(e=kv(e=function(e,l){const n=0<(null==d?void 0:d.length),t=e.filter(o=>{var e=function(){if(!l)return{highestPlayableAverageBitRate:void 0,highestPlayablePeakBitRate:void 0,highestPlayableWidth:void 0,highestPlayableHeight:void 0,highestPlayableFrameRate:void 0};const e=o.videoCodec,t=o.videoRange,i=l.videoDynamicRangeFormats,r=l.videoCodecs,n=ye.getDynamicRangeType(t,e),s=ye.getCompressionType(e),a=function(e,t,i,r){if(!r&&!i)return{};var n,s,t=i?Av(i,t):{},r=r?Av(r,e):{};let a,o;return o=e===ce.SDR?(a=t,r):(a=r,t),n=Object.assign({},a),s=o,Object.keys(s).forEach(e=>{n[e]||(n[e]=s[e])}),n}(n,s,r,i);return s!==he.VP09&&(a.highestPlayablePeakBitRateForClearContent=void 0),a}(),t=e["highestPlayablePeakBitRateForClearContent"],i=o.allowedCPCMap||n,r=wv(o.bandwidth,e.highestPlayablePeakBitRate);return(i||!t?r:r||wv(o.bandwidth,t))&&wv(o.avgBandwidth,e.highestPlayableAverageBitRate)&&wv(o.width,e.highestPlayableWidth)&&wv(o.height,e.highestPlayableHeight)&&wv(o.frameRate,e.highestPlayableFrameRate)});return Rv(0,e,t),t}(e,l)),r=kv(r),0===e.length||Ev(e))throw new L(M.MEDIA_ERROR,P.MANIFEST_INCOMPATIBLE_CODECS_ERROR,void 0,"no media option with compatible codecs found in manifest",void 0);let t=(null==l?void 0:l.videoDynamicRangeFormats)||[];n&&0===t.length&&(t=[{type:ce.SDR},{type:ce.HDR},{type:ce.HDR10},{type:ce.DolbyVision},{type:ce.HLG}]);var{hdrMediaOptions:i,sdrMediaOptions:e}=function(e,t){const i=t.reduce((e,t)=>{switch(t.type){case ce.DolbyVision:e.doViSupported=!0;break;case ce.HDR10:e.hdr10Supported=!0;break;case ce.HLG:e.hlgSupported=!0}return e},{doViSupported:!1,hdr10Supported:!1,hlgSupported:!1}),{doViSupported:r,hdr10Supported:n,hlgSupported:s}=i;return e.reduce((e,t)=>{var i;switch(ye.getDynamicRangeType(t.videoRange,null!==(i=t.videoCodec)&&void 0!==i?i:"")){case ce.HDR:case ce.HDR10:n&&e.hdrMediaOptions.push(t);break;case ce.DolbyVision:r&&e.hdrMediaOptions.push(t);break;case ce.HLG:s&&e.hdrMediaOptions.push(t);break;default:"SDR"!==t.videoRange&&null!=t.videoRange||e.sdrMediaOptions.push(t)}return e},{hdrMediaOptions:new Array,sdrMediaOptions:new Array})}(e,t);if(0===i.length&&0===e.length||Ev(i)&&Ev(e))throw new L(M.MEDIA_ERROR,P.MANIFEST_INCOMPATIBLE_VIDEO_RANGE_ERROR,void 0,"mediaOption with compatible VIDEO-RANGE not found in manifest",void 0);return{hdrMediaOptions:i,sdrMediaOptions:e,imageIframeVariants:r}}),Qn(e=>{throw e instanceof L&&(e.fatal=!0,e.response=K.IncompatibleAsset),e}));var s,a}))}function Mv(e,t){return t.mediaOptionId!==e.mediaOptionId&&t.persistentID===e.persistentID&&t.groupId!==e.groupId}(f=Hg=Hg||{}).HDR10="smpteSt2086",f.DoVi="smpteSt2094-10",f.HDR10Plus="smpteSt2094-40";class Pv extends $y{constructor(e,t,i){super(e,t,i)}static makeFilters(){return Uy()}_initFilters(){return Pv.kAllowFilters}get _mediaOptionType(){return this.mediaOptionType}get mediaOptionListInfo(){var e;return null!==(e=null===(e=this.getEntity(this.itemId))||void 0===e?void 0:e.mediaOptionListTuple[this._mediaOptionType])&&void 0!==e?e:null}get mediaOptionListInfo$(){return this.selectEntity(this.itemId,e=>e&&e.mediaOptionListTuple?e.mediaOptionListTuple[this._mediaOptionType]:null).pipe(If())}getFallbackVariant(t,e,i,r){var n;const s=null===(n=this.mediaOptionList)||void 0===n?void 0:n.find(e=>e.mediaOptionId===t);if(!s)return null;const a=this.filteredMediaOptionList;if(!a||!a.length)return null;if(i)return null!==(i=a.find(e=>Mv(s,e)&&!xu(s,e)))&&void 0!==i?i:null;let o=null;for(const t of a)!Mv(s,t)||o&&!xu(s,t)||(o=t);return o}getMatchingAlternateWithPersistentId(t,i,r){var e;return null!==(e=this.mediaOptionList.find(e=>!(0<(null==r?void 0:r.length)&&r.includes(e.mediaOptionId))&&(!Z(t)||e.persistentID===t)&&(!i||this.matchGroup(e,i.audioGroupId,i.subtitleGroupId,i.closedcaption))))&&void 0!==e?e:null}matchGroup(e,t,i,r){let n=!1;switch(e.type){case"CLOSED-CAPTIONS":n=!r||e.groupId===r;break;case"SUBTITLES":n=!i||e.groupId===i;break;case"AUDIO":n=!t||e.groupId===t}return n}getMatchingAlternate(e,t){e=this.mediaOptionFromId(e);return this.getMatchingAlternateWithPersistentId(null==e?void 0:e.persistentID,t,[])}packageAlternateMediaOption(e,t){return t.mediaType===Ou.CLOSEDCAPTION?this.augmentClosedCaptionsWithForcedSubtitles(null==e?void 0:e.subtitleGroupId,t):t}augmentClosedCaptionsWithForcedSubtitles(e,t){e=this.pairForcedSubtitleMediaOptionWithClosedCaption(e,t);return e?Object.assign(Object.assign({},t),{url:e.url,backingMediaOptionId:e.mediaOptionId}):t}pairForcedSubtitleMediaOptionWithClosedCaption(e,t){let i;return t&&t.mediaType===Ou.CLOSEDCAPTION&&(i=Pv.pairForcedSubtitleMediaOptionWithClosedCaptionInList(e,t,this.mediaOptionList)),i}static pairForcedSubtitleMediaOptionWithClosedCaptionInList(t,i,e){return e.find(function(e){return e.mediaType===Ou.SUBTITLE&&e.lang===i.lang&&e.forced&&e.autoselect&&(!t||e.groupId===t)})}}Pv.kAllowFilters=Pv.makeFilters();const xv=new fl({},{name:"item-queue",producerFn:lu,idKey:"itemId",resettable:!0}),Dv=new class extends Al{}(xv);class _v{constructor(){this.firstItem=!0,this.playing$=new Si(null)}static createItem(e,t,i=!1,r={}){var n;const s=new Date,a=`${s.getHours()}:${s.getMinutes()}:${s.getSeconds()}`;Ge();var o=function(e){e=gu.parseURL(e).fragment.substr(1);if(0===e.length)return null;const t=new URLSearchParams(e);if(!t.has("t"))return null;e=Number(t.get("t"));return Z(e)?e:null}(t);let l=null!==(n=r.initialSeekTime)&&void 0!==n?n:NaN;if(!Z(l))if(Z(o))l=o;else{const e=Jm();Z(null==e?void 0:e.startPosition)&&(l=e.startPosition)}return{itemId:`${e}_${a}`,parentItemId:r.parentItemId,clientName:r.clientName,serviceName:r.serviceName,initialRate:r.initialRate,platformInfo:r.platformInfo,loopCount:r.loopCount,itemStartOffset:r.itemStartOffset||0,seekImmediately:r.seekImmediately,initialSeekTime:l,name:e,url:t,createTime:a,config:{},isInterstitial:i,itemTimelineStartPosition:0,itemTimelineEndPosition:1/0}}get activeItemById$(){return Dv.selectActiveId().pipe(pr(e=>Dv.getActive()))}get removedItems$(){return Dv.selectEntityAction(_o.Remove).pipe(pr(e=>e))}get activeItem(){return Dv.getActive()}getQueueItemForId(e){return Dv.getEntity(e)}get queueItems$(){return Dv.selectAll().pipe(pr(e=>null!=e?e:[]))}get queueItems(){return Dv.getAll()}get isFirstItem(){return this.firstItem}get playingItem(){return this.playing$.getValue()}get loadingItem(){if(null==this.playingItem)return null;const e=Dv.getAll(),t=e.findIndex(e=>e.itemId===this.playingItem.itemId);return t<0||t>=e.length-1?null:e[t+1]}addQueueItem(e,t,i=!1,r={}){const n=_v.createItem(e,t,i,r);return null!=this.playingItem&&(n.initialSeekTime=void 0),null!=r&&r.itemStartOffset&&(n.itemStartOffset=r.itemStartOffset,this.firstItem=!1,this.playing$.next(this.activeItem)),Co(`queue.add.item: ${e} itemStartOffset=${n.itemStartOffset}`),ol(()=>{xv.add(n),xv.setActive(n.itemId)}),n}get primaryItem(){var e;return Dv.getEntity(null!==(e=null===(e=this.playingItem)||void 0===e?void 0:e.parentItemId)&&void 0!==e?e:null===(e=this.playingItem)||void 0===e?void 0:e.itemId)}insertQueueItem(e){Co(`queue.add.item: ${e.itemId}`),xv.add(e)}setPlayingItem(e){this.playing$.next(e)}updatePlayingItemId(e=!0){this.playing$.next(this.loadingItem),e&&this.clearAllButActive()}resetLoadingItem(){ol(()=>{this.loadingItem&&this.removeQueueItem(this.loadingItem.itemId),xv.setActive(this.playingItem.itemId)})}getQueueItemForTime(e,t=!1){for(const i of this.queueItems)if(e>=i.itemTimelineStartPosition&&e<=i.itemTimelineEndPosition&&(!i.isInterstitial||i.isInterstitial&&t))return i;return null}setActive(e,t,i,r){const n=Object.assign({},Dv.getEntity(e)),s=null!=i?i:n.initialSeekTime;n.itemStartOffset=t,n.initialSeekTime=s,n.seekImmediately=r,this.firstItem=!1,Co(`queue.set.active.item: ${e}`),ol(()=>{xv.update(e,{itemStartOffset:t,initialSeekTime:s,seekImmediately:r}),xv.setActive(e)})}updateItemById(e,t){xv.update(e,t)}isPreloading(){return null!=this.playingItem&&null!=this.loadingItem}setQueueItem(t,i,r=!1,n){Co("queue.set.item"),ol(()=>{xv.reset();var e=_v.createItem(t,i,r,n);xv.add(e),xv.setActive(e.itemId)}),this.playing$.next(this.activeItem)}removeQueueItem(e){xv.remove(e)}clearQueue(){xv.reset()}clearAllButActive(){var e;const t=null===(e=this.activeItem)||void 0===e?void 0:e.itemId;ol(()=>{Dv.getAll().forEach(e=>{e.itemId!==t&&xv.remove(e.itemId)})})}}class Lv extends Al{constructor(e,t){super(e),this.itemId=t,this.mediaOptionListQueries=[new Qy(e,this.itemId),new Pv(e,this.itemId,Tu.AltAudio),new Pv(e,this.itemId,Tu.Subtitle)]}get rootPlaylistEntity(){return this.getEntity(this.itemId)}get parentItemId(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.parentItemId}get rootMediaOptionsTuple(){var e=null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.mediaOptionListTuple;return e?[e[0].mediaOptions,e[1].mediaOptions,e[2].mediaOptions]:[[],[],[]]}get itemStartOffset(){var e,t;return null!==(e=this.rootPlaylistEntity)&&void 0!==e&&e.itemStartOffset&&Z(null===(t=this.rootPlaylistEntity)||void 0===t?void 0:t.itemStartOffset)?null===(t=this.rootPlaylistEntity)||void 0===t?void 0:t.itemStartOffset:0}get startTimeOffset(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.startTimeOffset}get highestVideoCodec(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.highestVideoCodec}get baseUrl(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.baseUrl}get anchorTime(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.anchorTime}get discoSeqNum(){var e;return null!==(e=null===(e=null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.discoSeqNumObject)||void 0===e?void 0:e.seqNum)&&void 0!==e?e:NaN}get discoSeqNumObject(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.discoSeqNumObject}get discoSeqNum$(){return this.selectEntity(this.itemId,"discoSeqNumObject")}get audioMediaSelectionGroup(){var e;return null!==(e=null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.audioMediaSelectionGroup)&&void 0!==e?e:null}get subtitleMediaSelectionGroup(){var e;return null!==(e=null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.subtitleMediaSelectionGroup)&&void 0!==e?e:null}get audioMediaSelectionOptions(){var e;return null!==(e=null===(e=null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.audioMediaSelectionGroup)||void 0===e?void 0:e.MediaSelectionGroupOptions)&&void 0!==e?e:[]}get subtitleMediaSelectionOptions(){var e;return null!==(e=null===(e=null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.subtitleMediaSelectionGroup)||void 0===e?void 0:e.MediaSelectionGroupOptions)&&void 0!==e?e:[]}get contentSteeringOption(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.contentSteeringOption}get masterVariableList(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.masterVariableList}get loadStats(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.loadStats}get isMediaPlaylist(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.isMediaPlaylist}getInitPTS(e){var t;return null===(t=this.rootPlaylistEntity)||void 0===t?void 0:t.initPtsRecord[e]}get abrStatus$(){return this.selectEntity(this.itemId,e=>null==e?void 0:e.abrStatus)}get abrStatus(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.abrStatus}get nextMaxAutoOptionId(){var e;return null===(e=null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.abrStatus)||void 0===e?void 0:e.nextMaxAutoOptionId}get nextMinAutoOptionId(){var e;return null===(e=null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.abrStatus)||void 0===e?void 0:e.nextMinAutoOptionId}initPTS$(t){return this.selectEntity(this.itemId,({initPtsRecord:e})=>e[t])}get rootPlaylistEntity$(){return this.selectEntity(this.itemId).pipe(cn(e=>Boolean(e)),pr(e=>e))}get rootPlaylistEntityAdded$(){return this.selectEntityAction(_o.Add).pipe(pr(e=>e.map(e=>this.getEntity(e))))}get rootMediaOptionsTuple$(){return rd([this.selectEntity(this.itemId,e=>e.mediaOptionListTuple[0].mediaOptions),this.selectEntity(this.itemId,e=>e.mediaOptionListTuple[1].mediaOptions),this.selectEntity(this.itemId,e=>e.mediaOptionListTuple[2].mediaOptions)])}get sessionData(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.sessionData}get sessionData$(){return this.selectEntity(this.itemId,({sessionData:e})=>e).pipe(If())}get anchorTime$(){return this.selectEntity(this.itemId,"anchorTime").pipe(La(e=>{var t;return Z(null==e?void 0:e.pos)?(null==e?void 0:e.pos)!==(null===(t=this.anchorTime)||void 0===t?void 0:t.pos)?(Ge().warn(`anchorTime doesn't match stored value! ${null==e?void 0:e.pos} !== ${null===(t=this.anchorTime)||void 0===t?void 0:t.pos}`),wi):Vi(e):wi}))}get enabledMediaOptionKeys$(){return this.selectEntity(this.itemId,"enabledMediaOptionKeys").pipe(cn(e=>Boolean(e)))}get enabledMediaOptionKeys(){var e;return null!==(e=null===(e=this.getEntity(this.itemId))||void 0===e?void 0:e.enabledMediaOptionKeys)&&void 0!==e?e:[qu,qu,qu]}get enabledMediaOptionSwitchContexts(){var e;return null!==(e=null===(e=this.getEntity(this.itemId))||void 0===e?void 0:e.mediaOptionSwitchContexts)&&void 0!==e?e:[null,null,null]}enabledMediaOptionSwitchContextsByType$(t){return this.selectEntity(this.itemId,"mediaOptionSwitchContexts").pipe(pr(e=>null==e?void 0:e[t]))}get enabledMediaOptions$(){return rd([this.enabledMediaOptionByType$(Tu.Variant),this.enabledMediaOptionByType$(Tu.AltAudio),this.enabledMediaOptionByType$(Tu.Subtitle)])}get enabledAVOptions$(){return rd([this.enabledMediaOptionByType$(Tu.Variant),this.enabledMediaOptionByType$(Tu.AltAudio)])}rawEnabledMediaOptionByType$(i){return this.enabledMediaOptionKeys$.pipe(pr(e=>{const t=e[i];return ju(t)&&this.rootMediaOptionsTuple[i].find(e=>Hu(e,t))||qu}))}enabledMediaOptionByType$(e){return this.rawEnabledMediaOptionByType$(e).pipe(bs((e,t)=>e.mediaOptionId===t.mediaOptionId&&e.url===t.url))}enabledMediaOptionSwitchForType$(e){return this.rawEnabledMediaOptionByType$(e).pipe(To(this.enabledMediaOptionSwitchContextsByType$(e)),_a(null),da(),pr(([e,t])=>({fromId:null==e?void 0:e[0].mediaOptionId,toId:null==t?void 0:t[0].mediaOptionId,switchContext:null==t?void 0:t[1]})),bs((e,t)=>e.fromId===t.fromId&&e.toId===t.toId))}enabledMediaOptionsSwitchInfo$(e){return rd(zu.map(e=>this.enabledMediaOptionSwitchForType$(e).pipe(eo(e=>{}))))}enableMediaOptionSwitchedForType$(t){return this.enabledMediaOptionByType$(t).pipe(La(e=>Ah(Pr([Vi(e),this.enabledMediaOptionSwitchContextsByType$(t).pipe(da())]),([,e])=>e[0]&&!e[1])),pr(([e])=>e))}enabledMediaOptionIdByType(e){return this.getEntity(this.itemId).enabledMediaOptionKeys[e].mediaOptionId}get enabledVariantMediaOptionIdBeforeTrickplaySwitch(){return this.getEntity(this.itemId).enabledVariantMediaOptionIdBeforeTrickplaySwitch}variantMediaOptionById(e){return this.mediaOptionListQueries[Tu.Variant].mediaOptionFromId(e)}alternateMediaOptionById(e,t){return this.mediaOptionListQueries[e].mediaOptionFromId(t)}enabledAlternateMediaOptionByType(e){var t=this.enabledMediaOptionIdByType(e);return this.alternateMediaOptionById(e,t)}get enabledVariantMediaOption(){var e=this.enabledMediaOptionIdByType(Tu.Variant);return this.variantMediaOptionById(e)}lastLoadedMediaOptionByType(e){var t;return null===(t=this.getEntity(this.itemId).lastLoadedMediaOptionKeys)||void 0===t?void 0:t[e]}lastLoadedMediaOptionByType$(t){return this.selectEntity(this.itemId).pipe(pr(e=>e.lastLoadedMediaOptionKeys),If(),pr(e=>e[t]))}get nextMediaOptionsKeys$(){return this.selectEntity(this.itemId,"nextMediaOptionKeys")}get filteredMediaOptions(){return[this.mediaOptionListQueries[0].filteredMediaOptionList,this.mediaOptionListQueries[1].filteredMediaOptionList,this.mediaOptionListQueries[2].filteredMediaOptionList]}get filteredMediaOptions$(){return rd([this.mediaOptionListQueries[0].filteredMediaOptionList$,this.mediaOptionListQueries[1].filteredMediaOptionList$,this.mediaOptionListQueries[2].filteredMediaOptionList$])}getDisabledMediaOption(e){return{itemId:this.itemId,mediaOptionType:e,mediaOptionId:"Nah"}}getEnabledMediaOptionMask(){return this.enabledMediaOptionKeys.map(e=>ju(e))}get isInterstitial(){var e;return null!==(e=null===(e=this.getEntity(this.itemId))||void 0===e?void 0:e.isInterstitial)&&void 0!==e&&e}getPreferredMediaOptionsByType$(e){return this.mediaOptionListQueries[e].filteredMediaOptionList$}altMediaOptionHasValidUrl(e,t){t=this.alternateMediaOptionById(e,t);return Boolean(null==t?void 0:t.url)}get hdrMode$(){return this.mediaOptionListQueries[Tu.Variant].hdrMode$}get maxHdcpLevel$(){return this.mediaOptionListQueries[Tu.Variant].maxHdcpLevel$}get currentPathwayID(){return this.mediaOptionListQueries[Tu.Variant].currentPathwayID}getErrorInfoByType(e){var t;return null!=(null===(t=this.rootPlaylistEntity)||void 0===t?void 0:t.errorsByType)?this.rootPlaylistEntity.errorsByType[e]:null}getInFlightFrags(){var e;return null!==(e=null===(e=this.getEntity(this.itemId))||void 0===e?void 0:e.inFlightFrags)&&void 0!==e?e:[null,null]}getInFlightFragByType(e){var t;return null!==(e=null===(t=this.getInFlightFrags())||void 0===t?void 0:t[e])&&void 0!==e?e:null}getInFlightFragByType$(t){return this.selectEntity(this.itemId,e=>{return null===(e=null==e?void 0:e.inFlightFrags)||void 0===e?void 0:e[t]})}matchAlternates(e,t,i,r){t=Z(t)?this.mediaOptionListQueries[Tu.AltAudio].getMatchingAlternateWithPersistentId(t,e,r):void 0,r=Z(i)?this.mediaOptionListQueries[Tu.Subtitle].getMatchingAlternateWithPersistentId(i,e,r):void 0;return[t||qu,r||qu]}getLegacyMatchingAlternateWithPersistentId(e,t,i){let r=this.mediaOptionListQueries[e].getMatchingAlternateWithPersistentId(t,i,[]);return r=r||this.mediaOptionListQueries[e].getMatchingAlternateWithPersistentId(t,void 0,[]),r}isValidMediaOptionTuple(i,e){const r=e||this.getEnabledMediaOptionMask();return[Tu.Variant,Tu.AltAudio,Tu.Subtitle].reduce((e,t)=>e&&r[t]===ju(i[t]),!0)}matchGroup(e,t,i,r){var n=e.mediaOptionType;return this.mediaOptionListQueries[n].matchGroup(e,t,i,r)}get preferHDR(){return this.mediaOptionListQueries[Tu.Variant].mediaOptionListInfo.preferHDR}}const Nv={name:"rps"};class Fv{constructor(e,t,i){this.store=e,this.logger=t,this.config=i}getQuery(){return new Al(this.store)}getQueryForId(e){return new Lv(this.store,e)}set rootPlaylistEntity(e){Co("root.add.rootPlaylist"),this.store.add(e)}removeItems(e){Co(`root.add.remove ${JSON.stringify(e)}`),this.store.remove(e)}removeAll(){Co("root.add.clear"),this.store.remove()}setRootPlaylistEntity(e,t){Co("root.set.rootPlaylistEntity"),this.store.update(e,e=>t)}setSessionData(e,t){Co("root.set.sessionData"),this.store.update(e,e=>{e.sessionData=t})}setAnchorTime(e,t){Co(`root.set.anchorTime: ${null==t?void 0:t.pos} ${null==t?void 0:t.discoSeqNum}`),this.store.update(e,e=>{e.anchorTime={pos:t.pos,discoSeqNum:t.discoSeqNum}})}setDiscoSeqNum(e,t,i){Co(`root.set.discoSeqNum: ${t}`),this.store.update(e,e=>{e.discoSeqNumObject.seqNum=t,e.discoSeqNumObject.wasSetInIframe=i})}setEnabledMediaOptionSwitchContextByType(e,i,r,n){this.store.update(e,e=>{var t;if(e.enabledMediaOptionKeys[i].mediaOptionId===r){const r=null!==(t=e.mediaOptionSwitchContexts)&&void 0!==t?t:[null,null,null];r[i]=n?{userInitiated:n.userInitiated,switchPosition:n.switchPosition}:null,e.mediaOptionSwitchContexts=r}else Co(`root.set.mediaOptionSwitchContextByType ${r} doesn't match existing mediaOption ${e.enabledMediaOptionKeys[i].mediaOptionId}`)})}setEnabledVariantMediaOptionIdBeforeTrickplaySwitch(e,t){this.store.update(e,e=>{e.enabledVariantMediaOptionIdBeforeTrickplaySwitch=t})}setEnabledMediaOptionByType(r,n,s,a=!1,o){s=s||{itemId:r,mediaOptionType:n,mediaOptionId:"Nah"},this.store.update(r,e=>{var t;const i=null!==(t=[...e.enabledMediaOptionKeys])?t:[qu,qu,qu];if(i[n]={itemId:r,mediaOptionId:s.mediaOptionId},this._updateEnabledMediaOptionKeys(e,i),a){const r=null!==(t=e.mediaOptionSwitchContexts)&&void 0!==t?t:[null,null,null];r[n]=o?{userInitiated:o.userInitiated,switchPosition:o.switchPosition}:null,e.mediaOptionSwitchContexts=r}})}_associateForcedSubtitleWithClosedCaption(e,t,i,r){if((null==i?void 0:i.mediaType)===Ou.CLOSEDCAPTION){t=r.variantMediaOptionById(t),r=r.mediaOptionListQueries[Tu.Subtitle].packageAlternateMediaOption(t,i);if(r.url!==i.url){const n=Qv(t,r,e.mediaOptionListTuple[Tu.Subtitle].mediaOptions,Ge());e.mediaOptionListTuple[Tu.Subtitle].mediaOptions=n}}}_updateEnabledMediaOptionKeys(t,i){var e,r;const n=null!==(e=t.enabledMediaOptionKeys)&&void 0!==e?e:[qu,qu,qu];let s;for(let e=0;e<i.length;++e){var a=i[e],o=n[e].mediaOptionId!==a.mediaOptionId;o&&(n[e]=Object.assign({},a));const l=this.getQueryForId(a.itemId);if(e===Tu.Variant){const i=l.mediaOptionListQueries[e].mediaOptionList;if(o){const s=l.variantMediaOptionById(n[e].mediaOptionId),d=t.mediaOptionListTuple[Tu.Variant],{mediaOptions:u,hasScore:c,pathwayPriority:h}=d;d.mediaOptions=Ky(u,{hasScore:c,pivotVariant:s,pathwayPriority:h,preferHostOverQuality:!0,preferCloseToPivotQuality:!1}),t.abrStatus=(r=a.mediaOptionId,o=i,o=nv(r,o),{fragDownloadSlow:!1,fragDownloadTooSlow:!1,nextMinAutoOptionId:qu.mediaOptionId,nextMaxAutoOptionId:qu.mediaOptionId,highBWTrigger:o}),d.currentPathwayID=null==s?void 0:s.pathwayID}else t.abrStatus.highBWTrigger=nv(a.mediaOptionId,i);s=a}else if(e===Tu.Subtitle&&ju(a)){const i=l.alternateMediaOptionById(e,a.mediaOptionId);this._associateForcedSubtitleWithClosedCaption(t,s.mediaOptionId,i,l)}}t.enabledMediaOptionKeys=n,t.nextMediaOptionKeys=void 0}setManualMode(e,t){this.store.update(e,e=>{e.manualMode=t})}setEnabledMediaOptions(e,i){this.store.update(e,e=>{var t=i.map(({mediaOptionId:e,itemId:t})=>({mediaOptionId:e,itemId:t}));this._updateEnabledMediaOptionKeys(e,t)})}setEnabledMediaOptionsAndSwitchContexts(e,i,r){this.store.update(e,e=>{var t=i.map(({mediaOptionId:e,itemId:t})=>({mediaOptionId:e,itemId:t}));this._updateEnabledMediaOptionKeys(e,t),e.mediaOptionSwitchContexts=r})}setNextMediaOptions(e,i){Co(`root.set.nextMediaOptions: ${JSON.stringify(null==i?void 0:i.map(e=>e.mediaOptionId))}`),this.store.update(e,e=>{var t=i?i.map(({itemId:e,mediaOptionId:t})=>({itemId:e,mediaOptionId:t})):null;e.nextMediaOptionKeys=t})}updateEnabledMediaOptions(e){Co("root.set.updateEnabledMediaOptions"),this.store.update(e,e=>{e.nextMediaOptionKeys&&!0!==e.manualMode&&(Co(`root.set.updateEnabledMediaOptions ${JSON.stringify(e.nextMediaOptionKeys)}`),this._updateEnabledMediaOptionKeys(e,[...e.nextMediaOptionKeys])),e.nextMediaOptionKeys=void 0})}setLastLoadedMediaOptionByType(r,n,s){Co(`root.set.lastLoadedMediaOptionByType: ${n} ${(s=s||{itemId:r,mediaOptionType:n,mediaOptionId:"Nah"}).mediaOptionId}`),this.store.update(r,e=>{var t;const i=null!==(t=e.lastLoadedMediaOptionKeys)&&void 0!==t?t:[qu,qu,qu];i[n]={itemId:r,mediaOptionId:s.mediaOptionId},e.lastLoadedMediaOptionKeys=i})}setViewportInfo(e,t){Co(`root.set.viewportInfo: ${JSON.stringify(t)}`),this.store.update(e,e=>{e&&(e.mediaOptionListTuple[Tu.Variant].viewportInfo=t)})}static doUpdateRootHDRSwitch(e,t,i,r,n){const s=e.mediaOptionListTuple.map(e=>Object.assign({},e));s[Tu.Variant].preferHDR=t,s[Tu.Variant].hasHdrLevels=i;const a=Jm(),o=Dv.getEntity(e.itemId),l=Vm(e.itemId),d=l.getBandwidthEstimate(a,null==o?void 0:o.serviceName),u=l.getPlaylistEstimate(a,null==o?void 0:o.serviceName),c=l.getFragEstimate(a,null==o?void 0:o.serviceName),h=l.getBufferEstimate(a,null==o?void 0:o.serviceName),p={targetDuration:c.maxDurationSec||(null==a?void 0:a.defaultTargetDuration),targetStartupMs:null==a?void 0:a.targetStartupMs},f=Ym().getQuery().alternateMatchingInfo;return qv(Object.assign(Object.assign({},e),{mediaOptionListTuple:s,nextMediaOptionKeys:null}),f,r,n,d,p,u,c,h)}switchToSDROnly(e){Co("root.switchToSDROnly"),this.store.update(e,e=>{var t=Fv.doUpdateRootHDRSwitch(e,!1,!1,this.logger,this.config)["mediaOptionListTuple"];e.mediaOptionListTuple=t})}setHDRPreference(e,i,r){Co(`root.set.HDRPreference: ${i}`),this.store.update(e,e=>{var t=e.mediaOptionListTuple[Tu.Variant];if(t.preferHDR!==i&&(!i||t.hasHdrLevels)){t=Fv.doUpdateRootHDRSwitch(e,i,t.hasHdrLevels,this.logger,this.config);if(r)return t;e.mediaOptionListTuple=t.mediaOptionListTuple}})}setPathwayPriority(e,t){Co(`root.set.PathwayPriority: [ ${t.join(", ")} ]`),this.store.update(e,e=>{e&&(e.mediaOptionListTuple[Tu.Variant].pathwayPriority=t)})}setCurrentPathwayID(e,t){Co(`root.set.currentPathwayID: ${t}`),this.store.update(e,e=>{e&&(e.mediaOptionListTuple[Tu.Variant].currentPathwayID=t)})}setInitPTS(e,t,i,r,n,s){Co(`root.set.initPTS: ${e} ${t} variantDTS:${JSON.stringify(i)} timelineOffset: ${r}`),this.store.update(e,e=>{e.initPtsRecord[t]={variantDTS:i,timelineOffset:r,offsetTimestamp:n,iframeMode:s}})}static prunePenaltyBox(e,t){return e.filter(e=>!(e.expiry<=t))}static addToPenaltyBox(e,t,i){return e.push({mediaOptionId:i,expiry:t+12e4})}addToPenaltyBox(e,r,n){Co(`root.set.penaltyBox: ${r}: ${n}`),this.store.update(e,({mediaOptionListTuple:e})=>{const t=e[r],i=performance.now();t.penaltyBoxQueue=Fv.prunePenaltyBox(t.penaltyBoxQueue,i),Fv.addToPenaltyBox(t.penaltyBoxQueue,i,n)})}prunePenaltyBox(e,r=null){Co(`root.set.prunePenaltyBox: ${r}`),this.store.update(e,({mediaOptionListTuple:e})=>{var e=r?[e[r]]:e,t=performance.now();for(const i of e)i.penaltyBoxQueue=Fv.prunePenaltyBox(i.penaltyBoxQueue,t)})}removePermanently(e,r,n){Co(`root.set.removePermanently: ${r}: ${n}`),this.store.update(e,({mediaOptionListTuple:e})=>{const t=e[r],i=new Set(t.removed);i.add(n),t.removed=Array.from(i)})}moveAllWithMatchingHosts(e,r,n,s){Co(`root.set.moveAllMatchingHosts: ${r}:${ku(n.url)} remove:${s}`),this.store.update(e,({mediaOptionListTuple:e})=>{const t=e[r],i=[...t.mediaOptions].filter(e=>xu(n,e)).map(e=>e.mediaOptionId);if(s){const e=new Set([...t.removed,...i]);t.removed=Array.from(e)}else{const e=performance.now();t.penaltyBoxQueue=Fv.prunePenaltyBox(t.penaltyBoxQueue,e);for(const r of i)Fv.addToPenaltyBox(t.penaltyBoxQueue,e,r)}})}setMaxHdcpLevel(e,i,r=!1){Co(`root.set.maxHdcpLevel: ${i}`),this.store.update(e,({mediaOptionListTuple:e})=>{const t=e[Tu.Variant];(r||Pg(i)<Pg(t.maxHdcpLevel))&&(t.maxHdcpLevel=i)})}updateConsecutiveTimeouts(e,i,r,n){this.store.update(e,e=>{const t=e.errorsByType||[{timeouts:{load:0,append:0,key:0}},{timeouts:{load:0,append:0,key:0}},{timeouts:{load:0,append:0,key:0}}];r?++t[i].timeouts[n]:t[i].timeouts[n]=0,e.errorsByType=t})}updateInflightFrag(d,u,c,h,p){Co("root.set.updateInflightFrag"),this.store.update(d,t=>{if(t.inFlightFrags||(t.inFlightFrags=[null,null]),!(u===Tu.Subtitle||c&&c.itemId!==d))if(c){var{start:i,duration:r,mediaOptionId:n,mediaSeqNum:s,discoSeqNum:a,iframe:o}=c,l=t.inFlightFrags[u];let e=null==l?void 0:l.tstart;h!==(null==l?void 0:l.state)&&(e=performance.now()),t.inFlightFrags[u]={itemId:d,mediaOptionId:n,mediaSeqNum:s,discoSeqNum:a,start:i,duration:r,tstart:e,state:h,iframe:o,bwSample:Object.assign({},p)}}else t.inFlightFrags[u]=null})}setNextMaxAutoOptionId(e,t){Co(`root.set.nextMaxAutoOptionId: ${t}`),this.store.update(e,({abrStatus:e})=>{e.nextMaxAutoOptionId=t})}setNextMinAutoOptionId(e,t){Co(`root.set.nextMinAutoOptionId: ${t}`),this.store.update(e,({abrStatus:e})=>{e.nextMinAutoOptionId=t})}setHighBWTrigger(e,t){Co(`root.set.setHighBWTrigger: ${t}`),this.store.update(e,({abrStatus:e})=>{e.highBWTrigger=t})}setFragLoadSlow(e,t){Co(`root.set.setFragLoadSlow ${e} ${JSON.stringify(t)}`),this.store.update(e,({abrStatus:e})=>{e.fragDownloadSlow=t.fragDownloadSlow,e.fragDownloadTooSlow=t.fragDownloadTooSlow})}pickMediaOptionTupleByAlternateMatchingInfo(e,t,i,r=!1,n=!1){var s=e.enabledMediaOptionIdByType(Tu.Variant),a=e.variantMediaOptionById(s),o=t===Tu.AltAudio?null===(s=i.audioMatchingInfo)||void 0===s?void 0:s.persistentId:null===(o=i.subtitleMatchingInfo)||void 0===o?void 0:o.persistentId;let l,d;if(t===Tu.AltAudio){const t=e.enabledAlternateMediaOptionByType(Tu.Subtitle);d=null==t?void 0:t.persistentID,l=o}else{const t=e.enabledAlternateMediaOptionByType(Tu.AltAudio);l=null==t?void 0:t.persistentID,d=o}const u=e.getEnabledMediaOptionMask();return u[t]=!!(Z(o)&&0<=o),a?this.getBestMediaOptionTupleFromVariantAndPersistentId(e,a,l,d,u,void 0,r,n,!1):[qu,qu,qu]}getFallbackMediaOptionTupleFromMediaOptionId(e,t,i,r,n=!1,s=!1,a=!1){var o=r?[r]:[i],l=e.enabledMediaOptionIdByType(Tu.Variant),r=e.variantMediaOptionById(l),l=t===Tu.AltAudio?e.alternateMediaOptionById(Tu.AltAudio,i):e.enabledAlternateMediaOptionByType(Tu.AltAudio),l=null==l?void 0:l.persistentID,i=t===Tu.Subtitle?e.alternateMediaOptionById(Tu.Subtitle,i):e.enabledAlternateMediaOptionByType(Tu.Subtitle),i=null==i?void 0:i.persistentID;return r?this.getBestMediaOptionTupleFromVariantAndPersistentId(e,r,l,i,void 0,o,n,s,a):[qu,qu,qu]}hasFallbackMediaOptionTuple(e,t,i,r){var n=e.mediaOptionListQueries[t].mediaOptionFromId(i);return e.isValidMediaOptionTuple(this.getFallbackMediaOptionTupleFromMediaOptionId(e,t,i,n.backingMediaOptionId,!1,r))}setLegacyAlternateMediaOption(e,t,i,r,n){var s=e.enabledMediaOptionIdByType(Tu.Variant),s=e.variantMediaOptionById(s),s=e.getLegacyMatchingAlternateWithPersistentId(i,r,s);s?this.setEnabledMediaOptionByType(t,i,s,!0,n):this.logger.warn(`${Gu[i]} can't find matching mediaOption for persistent id ${r}`)}setEnabledMediaOptionTupleWithMatchedGroups(t,i,e,r){var n;const s=$v(t),a=i===Tu.AltAudio?null===(n=e.audioMatchingInfo)||void 0===n?void 0:n.persistentId:null===(n=e.subtitleMatchingInfo)||void 0===n?void 0:n.persistentId,o=this.pickMediaOptionTupleByAlternateMatchingInfo(s,i,e);if(!s.isValidMediaOptionTuple(o))return this.setLegacyAlternateMediaOption(s,t,i,a,r);ol(()=>{this.setEnabledMediaOptionByType(t,i,o[i],!0,r);var e=o[Tu.Variant];this.setEnabledMediaOptionByType(t,Tu.Variant,e);e=i===Tu.AltAudio?Tu.Subtitle:Tu.AltAudio;o[e].mediaOptionId!==s.enabledMediaOptionIdByType(e)&&this.setEnabledMediaOptionByType(t,e,o[e],!1)})}canSwitchToSDR(e,t,i,r=!1){var n=e.mediaOptionListQueries[Tu.Variant].mediaOptionFromId(t),r=this.getFallbackMediaOptionTupleFromMediaOptionId(e,Tu.Variant,t,n.backingMediaOptionId,!0,i,r);return e.isValidMediaOptionTuple(r)}getBestMediaOptionTupleFromVariantAndPersistentId(t,e,i,r,n,s,a,o,l){var d,u=t.mediaOptionListQueries[Tu.Variant].listFallbackVariants(e.mediaOptionId,a,o,l,s);let c=[qu,qu,qu];for(let e=u.length;0<e--;){const a=u[e];if(d=t.matchAlternates(a,i,r,s),t.isValidMediaOptionTuple([a,...d],n)){c=[a,...d];break}}return c}}const Bv=new class extends fl{constructor(){super({},{name:"root-playlist-store",idKey:"itemId",producerFn:lu})}akitaPreAddEntity(e){return null==e.errorsByType?Object.assign(Object.assign({},e),{errorsByType:[{timeouts:{load:0,append:0,key:0}},{timeouts:{load:0,append:0,key:0}},{timeouts:{load:0,append:0,key:0}}]}):e}};new Al(Bv);let Uv=null;function $v(e){return new Lv(Bv,e)}function Vv(e,t,i,r=!1){let n=null;try{const i=new Intl.Locale(e.language);for(let e=0;e<t.length;e++){var s=t[e],a=new Intl.Locale(s.MediaSelectionOptionsExtendedLanguageTag);if(s.MediaSelectionOptionsIsAutoSelect&&(!r||!s.MediaSelectionOptionsDisplaysNonForcedSubtitles)){if(a.baseName&&i.baseName&&a.baseName===i.baseName){n=s;break}a.language===i.language&&(n=s)}}return n}catch(t){return i.child(Nv).warn(`Unable to match with audioMatchingInfo > err=${t.toString()}, matchingInfo=${JSON.stringify(e)}`),n}}function Kv(e,t,i,r,n,s,a){var o,l,d,u,c,h,p,f,m,g,y,v=e.mediaOptionListTuple[Tu.Variant],S=[...Qy.kAllowFilters,By()],b=Py(v.mediaOptions,S,Object.assign(Object.assign({},v),{compatibleIds:null}));return{firstVariant:(e=b,S=Ig,v=v.hasScore,t=t,i=i,r=r,n=n,s=s,a=a,!e||e.length<1||e.every(e=>e.iframes)?void t.warn("no non-iframe media option found"):((e=v?(p=i,f=r,m=n,g=s,y=a,e.reduceRight((e,t)=>{if(t.iframes)return e;let i=e;const r=(n=t.score,s=p&&f&&m&&g&&!Eg(t,p,f,m,g,y)?bu.INVALID:bu.VALID,new Af(s,n));var n,s;return(!e||r.isGreaterThan(e.bestRank)||r.isEqualTo(e.bestRank)&&t.bandwidth<e.selected.bandwidth)&&(i={selected:t,bestRank:r}),i},null).selected):(o=S,l=i,d=r,u=n,c=s,h=a,e.reduceRight((e,t)=>{if(t.iframes)return e;let i=e;const r=function(e,t,i,r,n,s,a){var o,l,d=(o=e.bitrate,u=e.height,(l=(e,t,i)=>(e-t)*(e-i)<=0)(o,t.minValidBitrate,t.maxValidBitrate)&&l(u,t.minValidHeight,t.maxValidHeight)?bu.VALID:bu.INVALID),o="PQ"===(c=e.videoRange)?vu.PQ:"HLG"===c?vu.HLG:"SDR"===c?vu.SDR:vu.UNKNOWN,{videoCodecRank:u,audioCodecRank:c}={videoCodecRank:Ef((l=e).videoCodec),audioCodecRank:Of(l.audioCodec)},l=e.bitrate<t.maxPreferredBitrate?bu.VALID:bu.INVALID,t=e.audioChannelCount||1,a=i&&r&&n&&s&&!Eg(e,i,r,n,s,a)?bu.INVALID:bu.VALID;return new Af(d,o,u,t,c,a,l,e.height)}(t,o,l,d,u,c,h);return(!e||r.isGreaterThan(e.bestRank)||r.isEqualTo(e.bestRank)&&t.bitrate>e.selected.bitrate)&&(i={selected:t,bestRank:r}),i},null).selected))||t.warn("no valid first media option found"),e)),filteredVariants:b}}function Qv(e,t,i){if((null==t?void 0:t.mediaType)===Ou.CLOSEDCAPTION){const r=Pv.pairForcedSubtitleMediaOptionWithClosedCaptionInList(e.subtitleGroupId,t,i);if(r)return t=Object.assign(Object.assign({},t),{url:r.url,backingMediaOptionId:r.mediaOptionId}),i.map(e=>e.mediaOptionId===t.mediaOptionId?t:e)}return i}function qv(e,t,s,l,i,r,n,a,o){var d;const u=e.itemId,c=e.mediaOptionListTuple[Tu.Variant],h=e.mediaOptionListTuple[Tu.AltAudio],p=e.mediaOptionListTuple[Tu.Subtitle],f=Py(h.mediaOptions,Pv.kAllowFilters,h),m=Py(p.mediaOptions,Pv.kAllowFilters,p);let{firstVariant:g,filteredVariants:y}=Kv(e,s,i,r,n,a,o);if(!g){const V=c.preferHDR;c.preferHDR=!V&&c.hasHdrLevels,c.preferHDR!==V&&(s.warn(`No valid first variant found, toggling hdr preference=${V}->${c.preferHDR}`),{firstVariant:g,filteredVariants:y}=Kv(e,s,i,r,n,a,o))}if(!g)throw new Q(!0,"No valid first variant found",K.NoValidAlternates);const v={itemId:u,mediaOptionId:null!==(o=null==g?void 0:g.mediaOptionId)&&void 0!==o?o:null},S=null!=f&&f.length?null===($=((i,r,e,n)=>{if(e){let t;return t=l.enableInterstitialPlayback&&i?Vv(i,e.MediaSelectionGroupOptions,s):Z(null==i?void 0:i.persistentId)?e.MediaSelectionGroupOptions.find(function(e){return e.MediaSelectionOptionsPersistentID===i.persistentId}):e.MediaSelectionGroupOptions.find(function(e){return e.MediaSelectionOptionsIsDefault}),t=t||e.MediaSelectionGroupOptions[0],n.find(e=>(!r||e.groupId===r)&&e.persistentID===(null==t?void 0:t.MediaSelectionOptionsPersistentID))}})(null==t?void 0:t.audioMatchingInfo,g.audioGroupId,e.audioMediaSelectionGroup,f))||void 0===$?void 0:$.mediaOptionId:null,b=S?{itemId:u,mediaOptionId:S}:qu,T=((i,r,n,s,a,o)=>{if(s){let t,e;return t=l.enableInterstitialPlayback&&i?Vv(i,s.MediaSelectionGroupOptions,o,i.forced):Z(null==i?void 0:i.persistentId)?s.MediaSelectionGroupOptions.find(function(e){return e.MediaSelectionOptionsPersistentID===i.persistentId}):s.MediaSelectionGroupOptions.find(function(e){return e.MediaSelectionOptionsIsDefault}),t&&(e=a.find(e=>e.mediaType===Ou.CLOSEDCAPTION?(!r||e.groupId===r)&&e.persistentID===t.MediaSelectionOptionsPersistentID:e.mediaType===Ou.SUBTITLE?(!n||e.groupId===n)&&e.persistentID===t.MediaSelectionOptionsPersistentID:void o.warn(Nv,`subtitle media option has unknown type ${e.mediaType}`))),e}})(null==t?void 0:t.subtitleMatchingInfo,g.closedcaption,g.subtitleGroupId,e.subtitleMediaSelectionGroup,m,s),I=null!=m&&m.length?null==T?void 0:T.mediaOptionId:null,E=I?{itemId:u,mediaOptionId:I,mediaOptionType:Tu.Subtitle}:qu,{mediaOptions:w,audioGroups:O,subtitleGroups:A}=($=y,d=g,$.reduce((e,t)=>{if(((e,t)=>{let i=!0;e.videoCodec&&t.videoCodec&&(i=ye.isCompatibleVideoCodec(e.videoCodec,t.videoCodec));let r=!1;e.videoRange&&t.videoRange?r=e.videoRange==t.videoRange:e.videoRange||t.videoRange||(r=!0);let n=!0;return e.audioCodec&&t.audioCodec&&(n=ye.isCompatibleAudioCodec(e.audioCodec,t.audioCodec)),i&&r&&n})(d,t)){const d=t.audioGroupId;d&&e.audioGroups.add(d),e.mediaOptions.add(t)}var i=t.subtitleGroupId;i&&e.subtitleGroups.add(i);t=t.closedcaption;return t&&e.closedCaptionGroups.add(t),e},{mediaOptions:new Set,audioGroups:new Set,subtitleGroups:new Set,closedCaptionGroups:new Set})),R=Array.from(w).map(e=>e.mediaOptionId),k=g.pathwayID,C=Ky(c.mediaOptions,{hasScore:c.hasScore,pivotVariant:g,pathwayPriority:c.pathwayPriority,preferHostOverQuality:!0,preferCloseToPivotQuality:!1}),M=Object.assign(Object.assign({},c),{mediaOptions:C,compatibleIds:R,currentPathwayID:k}),P=[],x=h.mediaOptions.reduce((e,t)=>(O.has(t.groupId)&&(e.persistentIds.add(t.persistentID),P.push(t.mediaOptionId),e.filteredAudioMediaOptions.push(t),e.altAudio||(e.altAudio=!!t.url)),e),{filteredAudioMediaOptions:[],persistentIds:new Set,altAudio:!1}),D=Object.assign(Object.assign({},h),{compatibleIds:P});let _=e.audioMediaSelectionGroup;const L=null==_?void 0:_.MediaSelectionGroupOptions;if(L){const e=L.reduce((e,t)=>(x.persistentIds.has(t.MediaSelectionOptionsPersistentID)&&e.push(t),e),new Array);_=Object.assign(Object.assign({},_),{MediaSelectionGroupOptions:e})}p.mediaOptions=Qv(g,T,p.mediaOptions);const N=p.mediaOptions.reduce((e,t)=>(A.has(t.groupId)&&(e.persistentIds.add(t.persistentID),e.filteredSubtitleMediaOptions.push(t)),e),{filteredSubtitleMediaOptions:[],persistentIds:new Set});let F=e.subtitleMediaSelectionGroup;const B=null==F?void 0:F.MediaSelectionGroupOptions;if(B){const e=B.reduce((e,t)=>(N.persistentIds.has(t.MediaSelectionOptionsPersistentID)&&e.push(t),e),new Array);F=Object.assign(Object.assign({},F),{MediaSelectionGroupOptions:e})}t=[M,D,p];let U=new Map;Jm().useHighestVideoCodecPrivate&&(U=null==M?void 0:M.mediaOptions.reduce((e,t)=>{const i=t.videoCodecList;if(i)for(const t of i){const i=wf(t),r=e.get(i);ye.isHigherCodecByFamily(r,t)&&e.set(i,t)}return e},U)),U.size&&U.forEach((e,t)=>{});var $={fragDownloadSlow:!1,fragDownloadTooSlow:!1,nextMinAutoOptionId:qu.mediaOptionId,nextMaxAutoOptionId:qu.mediaOptionId,highBWTrigger:nv(v.mediaOptionId,M.mediaOptions)};return Object.assign(Object.assign({},e),{enabledMediaOptionKeys:[v,b,E],mediaOptionListTuple:t,audioMediaSelectionGroup:_,abrStatus:$,highestVideoCodec:U})}class jv{constructor(e,t,i){this.hls=e,this.destroy$=new Jt,this.iframeSwitchStart=0,this.logger=t.child({name:"hls-player-events"}),this.rtc=i,this.subscribeAndEmit()}destroy(){this.destroy$.next()}subscribeAndEmit(){var e=this.loaderQueryListener(new bc(Ic)),t=this.hls.publicQueries$.pipe(La(([e,t,i])=>dn(this.rootPlaylistQueryListener(e,t),this.mediaElementQueryListener(t,e),this.interstitialQueryListener(i,this.hls.itemQueue))));dn(e,t,this.activeItemListener(this.hls.itemQueue)).pipe(Qn(e=>{var t=e.message;return this.logger.error(`Got error in HlsPlayerEvents ${t}`,e),wi}),Ka(this.destroy$),Bs(()=>{})).subscribe()}activeItemListener(e){return e.activeItemById$.pipe(If(),La(e=>{e=e.url;return this.hls.trigger(_.MANIFEST_LOADING,{url:e}),wi}))}detailsUpdated(){return e=>e.pipe(La(e=>null!=(null==e?void 0:e.url)&&ju(e)?vy(e).mediaOptionDetailsEntity$.pipe(bs((e,t)=>(null==e?void 0:e.lastUpdateMillis)===(null==t?void 0:t.lastUpdateMillis)),cn(e=>!1===(null==e?void 0:e.detailsLoading)&&null!==e.stats)):wi))}rootPlaylistQueryListener(i,e){var t=i.enabledMediaOptionByType$(Tu.Variant).pipe(cn(e=>!!e),La(e=>{var t;return null===(t=this.rtc)||void 0===t||t.handleLevelSwitching(e.url),this.hls.trigger(_.LEVEL_SWITCHING,e),wi})),r=i.enabledMediaOptionByType$(Tu.Variant).pipe(La(i=>vy(i).mediaOptionDetailsEntity$.pipe(cn(e=>!0===(null==e?void 0:e.detailsLoading)),eo(e=>{var t={url:re(null==i?void 0:i.url),level:i.mediaOptionId,type:Gu[i.mediaOptionType]};return this.hls.trigger(_.LEVEL_LOADING,t),wi})))),n=i.enabledMediaOptionByType$(Tu.Variant).pipe(this.detailsUpdated(),La(e=>{var t=e.mediaOptionDetails,i=e.stats,r={mediaOptionId:t.mediaOptionId,details:t,playlistType:t.type,stats:i},n=this.hls.itemQueue.getQueueItemForId(t.itemId),n=null!==(i=null!==(i=null==n?void 0:n.parentItemId)&&void 0!==i?i:null==n?void 0:n.itemId)&&void 0!==i?i:t.itemId;if(null===(i=this.rtc)||void 0===i||i.handleLevelLoaded(n,t,r.stats),this.hls.trigger(_.LEVEL_LOADED,r),0===e.unchangedCount){const e={level:0,details:t};this.hls.trigger(_.LEVEL_UPDATED,e)}if(null!=t&&t.daterangeTags){const e={daterangeTags:t.daterangeTags};this.hls.trigger(_.DATERANGE_UPDATED,e)}return wi})),s=i.enableMediaOptionSwitchedForType$(Tu.AltAudio).pipe(La(e=>{e=i.alternateMediaOptionById(Tu.AltAudio,e.mediaOptionId);return e&&this.triggerAudioSwitch(e),wi})),a=i.enabledMediaOptionKeys$.pipe(cn(e=>null!==e[Tu.AltAudio].mediaOptionId),As(1),La(e=>{e=e[Tu.AltAudio].mediaOptionId;if(e){const t=i.alternateMediaOptionById(Tu.AltAudio,e);this.triggerAudioSwitch(Object.assign(Object.assign({},t),{url:re(null==t?void 0:t.url)}))}return wi}));return dn(t,s,Ah(e.textTracksCreated$,e=>e).pipe(La(()=>i.enabledMediaOptionByType$(Tu.Subtitle).pipe(La(e=>{var t=this.hls.itemQueue.activeItem.isInterstitial,e=i.alternateMediaOptionById(Tu.Subtitle,e.mediaOptionId);return e?this.hls.trigger(_.SUBTITLE_TRACK_SWITCH,{track:Object.assign({},e),hidden:!1,fromInterstitial:t}):this.hls.trigger(_.SUBTITLE_TRACK_SWITCH,{track:void 0,hidden:!1,fromInterstitial:t}),wi})))),i.sessionData$.pipe(cn(e=>null!=e.complete),As(1),eo(e=>{}),pr(e=>{this.hls.trigger(_.SESSION_DATA_COMPLETE,e)})),i.getPreferredMediaOptionsByType$(Tu.Variant).pipe(ka(1),pr(e=>{const t=e;null===(e=this.rtc)||void 0===e||e.handleLevelsChanged(t),t.forEach(e=>{}),this.hls.trigger(_.LEVELS_CHANGED,{requiresReset:!1,levels:t})})),i.getPreferredMediaOptionsByType$(Tu.AltAudio).pipe(pr(e=>{var t=this.hls.itemQueue.activeItem.isInterstitial;this.hls.trigger(_.AUDIO_TRACKS_UPDATED,{audioTracks:e,fromInterstitial:t})})),Ah(e.textTracksCreated$,e=>e).pipe(La(()=>i.getPreferredMediaOptionsByType$(Tu.Subtitle).pipe(As(1),pr(e=>{var t=this.hls.itemQueue.activeItem.isInterstitial;this.hls.trigger(_.SUBTITLE_TRACKS_UPDATED,{subtitleTracks:e,fromInterstitial:t}),this.hls.trigger(_.SUBTITLE_TRACKS_CREATED)})))),n,r,a)}mediaElementQueryListener(s,e){return dn(s.seekTo$.pipe(pr(e=>{var t;e&&Z(e.pos)?(null===(t=this.rtc)||void 0===t||t.handleSeek("SEEKING"),this.hls.trigger(_.SEEKING,{seekToPos:e.pos})):null===e&&(null===(e=this.rtc)||void 0===e||e.handleSeek("SEEKED"),this.hls.trigger(_.SEEKED))})),s.desiredRate$.pipe(_a(0),da(),pr(e=>{var t=e[0],i=e[1];Rf(i)?0==this.iframeSwitchStart&&(this.iframeSwitchStart=performance.now()):this.iframeSwitchStart=0,null===(e=this.rtc)||void 0===e||e.handleDesiredRateChanged(t,i),this.hls.trigger(_.DESIRED_RATE_CHANGED,{oldRate:t,newRate:i})})),s.sourceBufferEntityByType$(Iu.AltAudio).pipe(cn(e=>!!e),bs((e,t)=>e.totalBytes===t.totalBytes),pr(e=>{this.hls.trigger(_.BUFFER_APPENDED)})),s.sourceBufferEntityByType$(Iu.Variant).pipe(cn(e=>!!e),bs((e,t)=>e.totalBytes===t.totalBytes),pr(e=>{this.hls.trigger(_.BUFFER_APPENDED)})),s.stallInfo$.pipe(If(),To(s.combinedBuffer$),pr(([e])=>{var t;null===(t=this.rtc)||void 0===t||t.handleStalled(e,s.getCombinedBufferInfo(e.currentTime,0).len,this.hls.interstitialActive),this.hls.trigger(_.STALLED,e)})),Pr([Vi(e),rd([s.timeupdate$,s.bufferedSegmentsByType$(Iu.Variant)]).pipe(oo(1e3),pr(([t,e])=>null==e?void 0:e.find(e=>e.startPTS<=t&&e.endPTS>t)),cn(e=>!!e),_a(null),da())]).pipe(La(([e,[t,i]])=>{var r=null==i?void 0:i.frag,t=null==t?void 0:t.frag;if(r&&!vf(t,r)&&(this.hls.trigger(_.FRAG_CHANGED,i),this.hls.inGaplessMode&&this.checkAndTriggerReadyForNext(s,i),!t||r.mediaOptionId!==t.mediaOptionId)){const s=e.mediaOptionListQueries[Tu.Variant].mediaOptionFromId(r.mediaOptionId);if(!s)return this.logger.warn("variantInfo is undefined in fragChangeMonitor"),wi;const n=t?t.mediaOptionId:"",i=r.mediaOptionId;s.iframes&&(performance.now(),this.iframeSwitchStart),null===(r=this.rtc)||void 0===r||r.handleLevelSwitched({url:s.url,mediaOptionId:s.mediaOptionId,oldVariant:""!==n?n:void 0,newVariant:i},this.hls.interstitialActive),this.hls.trigger(_.LEVEL_SWITCHED,s)}return wi})),s.isBufferedToEnd$(this.hls.config.maxBufferHole,!1).pipe(cn(e=>!0===e),Hi(ir),pr(e=>{if(e&&!this.hls.itemQueue.isPreloading()&&this.hls.inGaplessMode){const i=s.getCombinedBufferInfo(s.currentTime,0);var t=0;i&&(t=i.end,e=s.mediaElementDuration,0<t&&e-s.currentTime<10&&this.hls.trigger(_.READY_FOR_NEXT_ITEM,{duration:t}))}})))}interstitialQueryListener(d,e){return dn(d.interstitials$.pipe(eo(e=>{this.hls.trigger(_.INTERSTITIALS_UPDATED,{events:e})})),d.playingInterstitialId$.pipe(da(),To(e.activeItemById$),eo(([[e,t],i])=>{var r,n,i=null!==(r=i.parentItemId)&&void 0!==r?r:i.itemId;if(null==e&&null!=t){const e=d.getInterstitialForId(t);this.hls.trigger(_.INTERSTITIAL_STARTED,{event:e}),null===(n=this.rtc)||void 0===n||n.interstitialStarted(i)}else if(null!=e&&null==t){const s=d.getInterstitialForId(e);this.hls.trigger(_.INTERSTITIAL_ENDED,{event:s}),null===(n=this.rtc)||void 0===n||n.interstitialEnded(i)}else if(null!=e&&null!=t&&e!==t){const a=d.getInterstitialForId(e),r=d.getInterstitialForId(t);this.hls.trigger(_.INTERSTITIAL_ENDED,{event:a}),null===(t=this.rtc)||void 0===t||t.interstitialEnded(i),this.hls.trigger(_.INTERSTITIAL_STARTED,{event:r}),null===(t=this.rtc)||void 0===t||t.interstitialStarted(i)}})),d.playingInterstitialAssetId$.pipe(da(),To(d.playingInterstitialId$,e.activeItemById$),eo(([[e,t],i,r])=>{var n,s,r=null!==(n=r.parentItemId)&&void 0!==n?n:r.itemId,i=d.getInterstitialForId(i);if(null==e&&null!=t){const e=d.getInterstitialAssetForId(t);this.hls.trigger(_.INTERSTITIAL_ASSET_STARTED,{asset:e,event:i}),null===(s=this.rtc)||void 0===s||s.interstitialAssetStarted(r)}else if(null!=e&&null==t){const a=d.getInterstitialAssetForId(e);this.hls.trigger(_.INTERSTITIAL_ASSET_ENDED,{asset:a,event:i}),null===(s=this.rtc)||void 0===s||s.interstitialAssetEnded(r,a.duration)}else if(null!=e&&null!=t&&e!==t){const o=d.getInterstitialAssetForId(e),l=d.getInterstitialAssetForId(t);this.hls.trigger(_.INTERSTITIAL_ASSET_ENDED,{asset:o,event:i}),null===(t=this.rtc)||void 0===t||t.interstitialAssetEnded(r,o.duration),this.hls.trigger(_.INTERSTITIAL_ASSET_STARTED,{asset:l,event:i}),null===(i=this.rtc)||void 0===i||i.interstitialAssetStarted(r)}})))}checkAndTriggerReadyForNext(e,t){var i,r;t&&t.frag&&(i=e.currentTime,(r=e.getCombinedBufferInfo(i,0))&&(i=r.end,r=e.mediaElementDuration,e=e.bufferMonitorInfo,e=Math.max(e.almostDryWaterLevelSeconds,e.lowWaterLevelSeconds/2),(r-t.endPTS<=e||t.frag.isLastFragment)&&this.hls.inGaplessMode&&!this.hls.isPreloading&&this.hls.trigger(_.READY_FOR_NEXT_ITEM,{duration:i})))}loaderQueryListener(e){return dn(e.unresolvedUriLoading$.pipe(pr(e=>e.map(e=>{e={uri:e.uri,responseType:e.responseType,userAgent:e.userAgent};this.hls.trigger(_.UNRESOLVED_URI_LOADING,e)}))))}triggerAudioSwitch(e){var t;e&&(t=this.hls.itemQueue.activeItem.isInterstitial,this.hls.trigger(_.AUDIO_TRACK_SWITCHED,{id:e.id,track:e,fromInterstitial:t}))}triggerManifestLoaded(e){const t=e.rootMediaOptionsTuple[Tu.Variant],i=t.filter(e=>e.iframes),r={levels:t,audioTracks:e.rootMediaOptionsTuple[Tu.AltAudio],subtitleTracks:e.rootMediaOptionsTuple[Tu.Subtitle],iframeVariants:i,url:e.baseUrl,audioMediaSelectionGroup:e.audioMediaSelectionGroup,subtitleMediaSelectionGroup:e.subtitleMediaSelectionGroup,stats:e.stats,isMediaPlaylist:e.isMediaPlaylist};this.hls.trigger(_.MANIFEST_LOADED,r)}triggerManifestParsed(e){var t={levels:e.mediaOptionListQueries[Tu.Variant].filteredMediaOptionList,firstLevel:0,audio:!1,video:!0,altAudio:!1,audioTracks:e.mediaOptionListQueries[Tu.AltAudio].filteredMediaOptionList,subtitleTracks:e.mediaOptionListQueries[Tu.Subtitle].filteredMediaOptionList,iframeVariants:null!==(t=null===(t=e.rootPlaylistEntity)||void 0===t?void 0:t.iframeVariants)&&void 0!==t?t:[],audioMediaSelectionGroup:e.audioMediaSelectionGroup,subtitleMediaSelectionGroup:e.subtitleMediaSelectionGroup,stats:e.loadStats};null===(e=this.rtc)||void 0===e||e.handleManifestParsed(t),this.hls.trigger(_.MANIFEST_PARSED,t)}triggerFragLoaded(e,t){var i,r={frag:e,stats:t},n=this.hls.itemQueue.getQueueItemForId(e.itemId),n=null!==(i=null!==(i=null==n?void 0:n.parentItemId)&&void 0!==i?i:null==n?void 0:n.itemId)&&void 0!==i?i:e.itemId;null===(i=this.rtc)||void 0===i||i.handleFragLoaded(n,e,t),this.hls.trigger(_.FRAG_LOADED,r)}urlRedactedManifestLoaded(e){const t=Object.assign({},e);return t.url=re(t.url),t.levels=se(t.levels),t.audioTracks=ae(t.audioTracks),t.subtitleTracks=ae(t.subtitleTracks),t}urlRedactedManifestParsed(e){const t=Object.assign({},e);return t.levels=se(t.levels),t.audioTracks=ae(t.audioTracks),t}}const Hv={name:"iframes"};(fl=Gg=Gg||{})[fl.DISABLED=0]="DISABLED",fl[fl.ERRORED=1]="ERRORED",fl[fl.SUCCESS=2]="SUCCESS";class Gv{constructor(e,t,i,r,n,s){this.itemQueue=e,this.interstitialService=t,this.publicQueries$=i,this.config=r,this.rtcQuery=n,this.queuedInterstitialIdx=-1,this.mediaFragmentAppended$=new Jt,this.activeAssets=[],this.savedInterstitials=null,this.savedInterstitialsOffset=null,this.savedSeekValue=null,this.cancelInterstitial$=new Jt,this.logger=s.child(Gv.loggerName)}destroy(){this.queuedInterstitials=null,this.queuedInterstitialIdx=-1,this.savedInterstitials=null,this.savedInterstitialsOffset=null,this.activeAssets=[],this.activeInterstitial=null,this._primaryResumptionTime=void 0,this.savedSeekValue=null}reset(){this.destroy()}cancelInterstitial(e,t,i){this.cancelInterstitial$.next({seekTo:e,initialRate:t,seekImmediately:i})}postRollCheck$(t,e){const{config:i,mediaLibraryService:r,rootPlaylistQuery:n}=e;return i.enableInterstitialPlayback?rd([r.getQuery().selectEntity(n.itemId).pipe(pr(e=>null==e?void 0:e.liveOrEvent)),this.interstitialService.interstitialQuery.playableInterstitials$,t.isBufferedToEnd$(i.maxBufferHole,!1)]).pipe(pr(([e,t,i])=>{var r=this.itemQueue.playingItem;return e||!i||this.activeInterstitial||null!=r&&r.isInterstitial?[]:(this._primaryQueueItem&&this._primaryQueueItem.itemId===r.itemId||(this._primaryQueueItem=r),t.filter(e=>e.cueType===rc.Postroll))}),La(e=>this.getQueuedInterstitials(e,null,i)),pr(e=>(0<e.length&&null!=this.savedInterstitials&&(this.savedInterstitials=null),0!==e.length&&(this.queuedInterstitials=e,this.queueNextInterstitial(t,1/0)))),Va(wi)):wi}fragmentIsInterstitialBoundary(r,e){const{config:h,mediaLibraryService:t}=e,i=Vi(!1),n=this.interstitialService.interstitialQuery,s=h.enableInterstitialPlayback?n.playableInterstitials:[];if(0===s.length)return i;e=this.itemQueue.getQueueItemForId(r.itemId);if(!e||r.iframe)return this.logger.warn("boundary check > missing queueItem or media fragment is iframe"),i;const p=r.start,f=p+r.duration;if(e.isInterstitial){if(this.activeInterstitial){const r=n.getInterstitialForId(this.activeInterstitial.identifier);if(r.playoutLimit){const o=E(r.playoutLimit),h=E(r.startTime);p>=h+o&&this.cancelInterstitial$.next({})}}return i}const m=t.getQueryForOption(r).mediaOptionDetails;this._primaryPlaylistType=m.type,this._primaryQueueItem&&this._primaryQueueItem.itemId===e.itemId||(this._primaryQueueItem=e);let g=NaN,a=this.savedInterstitials;if(null==a){let c;a=s.filter(e=>{var t;const i=e.cueType===rc.Preroll,r=e.cueType===rc.Midroll,n=null!==(o=e.snapOptions)&&void 0!==o?o:nc.None,s="LIVE"===this._primaryPlaylistType?0:this._primaryQueueItem.itemStartOffset,a=!c||(l=e.startTime,t=c,l.baseTime===t.baseTime&&l.timescale===t.timescale);var o=s+E(e.startTime),l=p<=o&&f>o&&r;let d=!1;if(h.enablePartialInterstitialPlaybackForLiveEdge&&m.liveOrEvent&&Z(e.duration)){d=o<=p&&o+e.duration>p;const c=(null===(t=m.fragments[m.fragments.length-1])||void 0===t?void 0:t.start)||0,u=fg(m)-ay(m,h),i=c-o;g=Math.max(0,i-u)}if((i||l||d)&&a&&!this.activeInterstitial){if(i||o===p||d)return!0;{this.savedInterstitials?this.savedInterstitials.push(e):(c=e.startTime,this.savedInterstitials=[e]);const h=n===nc.Out||n===nc.InOut,u=o-p,t=f-o;return h?u<t&&!(this.savedInterstitials=null):(this.savedInterstitialsOffset||(this.savedInterstitialsOffset=f-o),!1)}}return!1})}return null==a||0===a.length?i:this.getQueuedInterstitials(a,g,h).pipe(To(this.publicQueries$),pr(([e,[,t]])=>{if(0===e.length)return!1;this.queuedInterstitials=e,this.savedInterstitials=null;var i=e[0].interstitial,e=i.snapOptions,i=e===nc.In||e===nc.InOut?r.start:E(i.startTime);return this.queueNextInterstitial(t,i)}))}get playback$(){return dn(this._activeInterstitial$(),this._playingInterstitial$())}fragmentAppended(e){this.mediaFragmentAppended$.next(e)}getAdjustedSeek(i,r,e,t){const n=this.interstitialService.interstitialQuery,s=this.config.enableInterstitialPlayback?n.playableInterstitialsForSeek:[];let a,o;if(r<i&&0===s.length)return{adjustedSeek:i};var l=n.getInterstitialForId(n.playingInterstitialId);if(l){const r=null==t?void 0:t.find(e=>e.start<=i&&e.end>=i);return i=r?i:Math.min(i,l.duration),{adjustedSeek:this.seekWithinInterstitial(i,e)}}if(r<i){const d=s.find(e=>{var t=E(e.startTime);return(e.referenceRestrictions===sc.Jump||e.referenceRestrictions===sc.SkipJump)&&r<t&&t<=i});if(d){const r=E(d.startTime),t=this.itemQueue.getQueueItemForTime(r),e=null==t?void 0:t.itemStartOffset;return this.savedSeekValue=i,{adjustedSeek:Math.max(e,e+r-this.config.adjustedSeekToleranceMs/1e3)}}{const r=this.itemQueue.getQueueItemForTime(i);return{adjustedSeek:i+r.itemStartOffset}}}{const r=this.itemQueue.getQueueItemForTime(i),{itemId:d,itemStartOffset:t}=r;return d!==(null===(e=this.itemQueue.activeItem)||void 0===e?void 0:e.itemId)&&(ol(()=>{a=d,o=t,this.interstitialService.setActiveInterstitialAssetId(null),this.interstitialService.setActiveInterstitialId(null)}),this.activeInterstitial=null,this.activeAssets=[]),this.interstitialService.removeInterstitialsFromPastEventsFromTime(i),{adjustedSeek:i+t,newItemId:a,startOffset:o}}}getQueuedInterstitials(t,i,e){return function(s,a){const{interstitials:e,startOffset:o}={interstitials:t,startOffset:i};return Br(e).pipe(zn(n=>Br(n.urls).pipe(Hr(e=>{if(-1!==e.indexOf(".m3u"))return Vi({assets:[{uri:e,duration:n.duration}]});var t,i,r;{const n=new URL(e);return Z(o)&&n.searchParams.append("_HLS_start_offset",o.toString()),e=n.toString(),t=e,i=s,r=a,en(()=>{var e=Dc({url:t},r);return Wc({url:t,xhrSetup:i.xhrSetup},e,0,xc()).pipe(pr(({responseText:e})=>{var{interstitialAssetList:t,playlistParsingError:e}=function(e){let t,i,r;try{try{t=JSON.parse(e)}catch(e){throw Hc("interstitial asset list JSON format is malformed")}if(null==t)throw Hc("interstitial asset list is empty");if(!Array.isArray(t.ASSETS))throw Hc("invalid interstitial asset list ASSETS data type");r={assets:t.ASSETS.map(e=>({uri:e.URI,duration:e.DURATION}))};const i=function(e){for(const r of e.assets){const e=(t=r,i=void 0,"string"!=typeof t.uri?Hc("invalid interstitial asset URI data type"):null==(i=t.uri)||0!==i.indexOf("//")&&(-1===i.indexOf("://")||-1===i.indexOf(".")||-1===i.indexOf("/")||i.indexOf(":")>i.indexOf("/")||!(i.indexOf("://")<i.indexOf(".")))?Hc("interstitial asset uri is not absolute "+t.uri):"number"!=typeof t.duration?Hc("invalid interstitial asset DURATION data type"):void 0);if(null!=e)return e}var t,i}(r);if(null!=i)throw i}catch(e){i=e instanceof L?e:Hc(`unknown exception when parsing interstitial asset list: ${e}`)}return{interstitialAssetList:r,playlistParsingError:i}}(e);if(null!=e)throw e;return{interstitialAssetList:t}}))}).pipe(pr(e=>({assets:e.interstitialAssetList.assets})),Qn(()=>Vi({assets:[]})))}}),la((e,t)=>[...e,...t.assets],[]),pr(e=>({id:n.identifier,assets:e})))),la((e,t)=>(e[t.id]=t.assets,e),{}))}(e,e.playlistLoadPolicy).pipe(pr(r=>t.reduce((e,t)=>{var i=r[t.identifier];return i&&e.push({interstitial:t,assets:i}),e},[])))}queueNextInterstitial(i,r){return!(!this.queuedInterstitials||this.queuedInterstitialIdx>this.queuedInterstitials.length||!this.queuedInterstitials.find(()=>{var e=this.queuedInterstitials[++this.queuedInterstitialIdx];if(e){var{interstitial:t,assets:e}=e;if(this.updateAndSetActive(t,e,r,i))return!0}return!1}))}seekWithinInterstitial(e,t){const i=this.interstitialService.interstitialQuery,r=i.playingInterstitialId,n=i.getInterstitialForId(r),s=null==n?void 0:n.assets.map(e=>this.itemQueue.getQueueItemForId(e)).filter(e=>null!=e);if(0===s.length)return e;const a=s[0].itemStartOffset+e,o=s.reduce((e,t)=>t.itemStartOffset>e.itemStartOffset&&t.itemStartOffset<a?t:e,s[0]);return this.activeInterstitial=n,ol(()=>{this.interstitialService.setActiveInterstitialAssetId(o.itemId),this.interstitialService.setActiveInterstitialId(n.identifier),this.interstitialService.removeInterstitialsFromPastEvents([n.identifier]),Wv(t,o.itemId,a)||this.itemQueue.setActive(o.itemId,o.itemStartOffset),this.itemQueue.playing$.next(o)}),a}_activeInterstitial$(){const r=this.interstitialService.interstitialQuery;return r.activeInterstitialId$.pipe(Hi(ir),If(),To(this.publicQueries$),pr(([e,[,t]])=>{var i=r.getInterstitialForId(e);return[null!==(e=null===(e=null==i?void 0:i.assets)||void 0===e?void 0:e.map(e=>this.itemQueue.getQueueItemForId(e)))&&void 0!==e?e:[],t,i.cueType]}),La(([n,s,a])=>{if(n.length<1)return wi;var e=null!==(e=Xc(n,r.activeInterstitialAssetId).element)&&void 0!==e?e:n[0];this.setNextActiveQueueItem(e,s,a),this.activeAssets=n;e=this.mediaFragmentAppended$.pipe(If(),La(e=>{const t=e.itemId,i=this.itemQueue.getQueueItemForId(t),r=e.isLastFragment||Wv(s,t,s.currentTime);if(i&&i.isInterstitial&&r){const e=Xc(n,i.itemId).index,t=n[e+1];return Ah(Vi(t).pipe(La(e=>e||"VOD"===this._primaryPlaylistType?Vi(!0):s.timeupdate$.pipe(pr(e=>e>=this.getItemStartOffset(s)-this.config.livePlaylistPreloadDelayMs/1e3)))),e=>e).pipe(eo(()=>{this.setNextActiveQueueItem(t,s,a)}))}return wi}),Ka(this.cancelInterstitial$));return dn(this.cancelInterstitial$.pipe(eo(e=>{this.savedSeekValue=null,this.setNextActiveQueueItem(null,s,a,e.seekTo,e.initialRate,e.seekImmediately)})),e).pipe(Va(wi))}))}_playingInterstitial$(){return this.publicQueries$.pipe(cn(e=>!!e),cn(([,e])=>!!e),La(([,e])=>rd([e.timeupdate$,e.bufferedSegmentsByType$(Iu.Variant)]).pipe(pr(([t,e])=>null==e?void 0:e.find(e=>e.startPTS<=t&&e.endPTS>t)),cn(e=>!!e),_a(null),da())),pr(([e,t])=>this.updatePlayingItems(e,t)),bs())}interstitialIsPlaying(){var e=this.itemQueue.playingItem;return e&&e.isInterstitial}itemIdIsInterstitial(e){var e=this.itemQueue.getQueueItemForId(e);return null!==(e=null==e?void 0:e.isInterstitial)&&void 0!==e&&e}handleError(r){return r instanceof g&&!r.fatal||!this.activeInterstitial?Vi({handled:!1,error:r}):(this.logger.error("Error during interstitial, switching to next available asset or primary content"),this.publicQueries$.pipe(As(1),pr(([,e])=>{var t=this.interstitialService.interstitialQuery.activeInterstitialAssetId,i=Xc(this.activeAssets,t).index+1;return this.itemQueue.removeQueueItem(t),this.setNextActiveQueueItem(this.activeAssets[i],e,this.activeInterstitial.cueType),{handled:!0,error:r}})))}snapIn(e,t){const i=e["initialSeekTime"];if(!Z(i))return NaN;if(null==t||t.iframesOnly)return i;t=(null==t?void 0:t.fragments)||[],t=ec.search(t,e=>{var t=e.start,e=t+e.duration,t=i-t,e=e-i;return t<e&&0<=t&&0<=e?0:t});if(t){const r=t.start;return this.itemQueue.updateItemById(e.itemId,{initialSeekTime:r}),r}return i}updatePlayingItems(e,t){var i;let r=!1;var n=this.interstitialService.interstitialQuery.playingInterstitialId;if(null==e&&null!=t){const s=t.frag,e=this.itemQueue.getQueueItemForId(s.itemId);if(e)if(e.isInterstitial){const s=Yc(e.itemId);n!==s?(null!==n&&(this.rtcQuery.interstitialPlayTime(null!==(i=e.parentItemId)&&void 0!==i?i:e.itemId),this.interstitialService.interstitialQuery.getInterstitialForId(n)),this.interstitialService.interstitialQuery.getInterstitialForId(s),this.interstitialService.setPlayingInterstitialId(s),this.interstitialService.setPlayingInterstitialAssetId(e.itemId),r=!n):n&&s||this.logger.warn(`Unable to set playingInterstitialId or playingInterstitialAssetId. Missing parent interstitialId from curFragItem.itemId=${e.itemId}`)}else n&&(this.interstitialService.setPlayingInterstitialAssetId(null),this.interstitialService.setPlayingInterstitialId(null),r=!0);else this.logger.warn(`Unable to set playingItem. Missing queueItem for id=${s.itemId}`)}else if(null!=e&&null!=t){const i=e.frag,a=t.frag,o=this.itemQueue.getQueueItemForId(i.itemId),l=this.itemQueue.getQueueItemForId(a.itemId);if(o&&l&&o.itemId!==l.itemId){this.rtcQuery.interstitialPlayTime(null!==(e=o.parentItemId)&&void 0!==e?e:o.itemId);const s=Yc(o.itemId),t=Yc(l.itemId);!o.isInterstitial&&l.isInterstitial?n!==t?(this.interstitialService.interstitialQuery.getInterstitialForId(t),this.interstitialService.setPlayingInterstitialId(t),this.interstitialService.setPlayingInterstitialAssetId(l.itemId),r=!0):n&&t||this.logger.warn(`Unable to set playingInterstitialId or playingInterstitialAssetId. Missing parent interstitialId from curFragItem.itemId=${l.itemId}`):o.isInterstitial&&l.isInterstitial?(s&&t&&s!==t&&(this.interstitialService.interstitialQuery.getInterstitialForId(s),this.interstitialService.interstitialQuery.getInterstitialForId(t),this.interstitialService.setPlayingInterstitialId(t)),this.interstitialService.setPlayingInterstitialAssetId(a.itemId)):o.isInterstitial&&!l.isInterstitial&&(this.interstitialService.interstitialQuery.getInterstitialForId(s),this.interstitialService.setPlayingInterstitialAssetId(null),this.interstitialService.setPlayingInterstitialId(null),r=!0)}}return r}setNextActiveQueueItem(i,e,r,n,s,a){const o=r===rc.Postroll?e.mediaElementDuration:this.getItemStartOffset(e),l=this.interstitialService.interstitialQuery;if(i)ol(()=>{var e=Z(i.itemStartOffset)?i.itemStartOffset:o;!l.activeInterstitialAssetId&&this.activeInterstitial&&this.interstitialService.updateRealCurrentTimeOffsetMap(this.activeInterstitial.identifier,e),this.itemQueue.setActive(i.itemId,e),this.interstitialService.setActiveInterstitialAssetId(i.itemId)});else if(!this.queueNextInterstitial(e)){const i=_v.createItem(this._primaryQueueItem.name,this._primaryQueueItem.url,!1,{initialSeekTime:null!=n?n:this._primaryResumptionTime,initialRate:s,parentItemId:null!==(s=this._primaryQueueItem.parentItemId)&&void 0!==s?s:this._primaryQueueItem.itemId,platformInfo:this._primaryQueueItem.platformInfo,clientName:this._primaryQueueItem.clientName,serviceName:this._primaryQueueItem.serviceName,seekImmediately:a});let e=null!=n?n:0;var s=null!==(s=this.activeInterstitial)&&void 0!==s?s:l.getInterstitialForId(l.playingInterstitialId);s&&!n&&(e=zc(s));let t=o+e;if("LIVE"!==this._primaryPlaylistType)switch(r){case rc.Preroll:0!==e||n||(t=NaN);break;case rc.Midroll:t+=n?0:this._primaryResumptionTime;break;case rc.Postroll:t=-1}else t=0<e?o+e:NaN;const d=this.savedSeekValue?this.savedSeekValue+e+o:null,u=this.activeInterstitial?E(this.activeInterstitial.startTime)+e:1/0;i.itemStartOffset=o,i.initialSeekTime=null!=d?d:t,i.itemTimelineStartPosition=u;s=null!==(s=null==s?void 0:s.snapOptions)&&void 0!==s?s:nc.None;i.snapIn=s===nc.In||s===nc.InOut,ol(()=>{var e;this.itemQueue.insertQueueItem(i),this.itemQueue.updateItemById(this._primaryQueueItem.itemId,{itemTimelineEndPosition:u}),this.itemQueue.setActive(i.itemId,i.itemStartOffset,i.initialSeekTime,a),null===(e=this.queuedInterstitials)||void 0===e||e.forEach(({interstitial:e})=>{this.interstitialService.updateInterstitial(e.identifier,{hasPlayed:!0}),this.interstitialService.addInterstitialToPastEvents(e.identifier)}),this.interstitialService.setActiveInterstitialAssetId(null),this.interstitialService.setActiveInterstitialId(null)}),this.reset()}}getItemStartOffset(e){e=e.getCombinedBufferInfo(e.currentTime,.5);let t=0;return e&&(t=e.end),t}updateAndSetActive(o,t,e,l){if(o&&0<t.length){const d=[],u=[];let a=0;return ol(()=>{t.forEach((e,t)=>{const i=`interstitial:${o.identifier}:asset_${t+1}`,r=null!==(t=this._primaryQueueItem.parentItemId)&&void 0!==t?t:this._primaryQueueItem.itemId,n=_v.createItem(i,e.uri,!0,{parentItemId:r});let s=Number.POSITIVE_INFINITY;Z(this.savedInterstitialsOffset)&&0===this.queuedInterstitialIdx&&(s=this.getItemStartOffset(l)-this.savedInterstitialsOffset),n.itemStartOffset=s,this.interstitialService.addInterstitialAsset({parentIdentifier:o.identifier,identifier:n.itemId,url:e.uri,duration:e.duration}),this.itemQueue.insertQueueItem(n),u.push(n.itemId),d.push(e.uri),a+=e.duration||0});var e=Math.max(a,o.duration||0);this.interstitialService.updateInterstitial(o.identifier,{urls:d,assets:u,duration:e}),this.interstitialService.setActiveInterstitialId(o.identifier)}),!this._primaryResumptionTime&&e&&(this._primaryResumptionTime=e),this.activeInterstitial=o}return o&&(this.logger.warn("interstitial.updateAndSetActive > interstitial is missing urls, removing interstitial entirely"),this.interstitialService.removeInterstitials([o.identifier])),null}}function Wv(e,t,i){var r=e.getBufferedSegmentsByType(Iu.Variant).filter(e=>e.frag.itemId===t).sort((e,t)=>e.startPTS-t.startPTS),r=0<r.length?r[r.length-1]:null;return!(!r||!r.frag.isLastFragment)&&e.getCombinedBufferInfo(i,.5).end>r.startPTS}Gv.loggerName={name:"Interstitials"};class zv extends Si{constructor(e){super(e),this.pipe=super.pipe,this.next=super.next}get first(){return null==this.value||this.value.length?null:this.value[0]}takeUntil(e){return Ka(this.pipe(cn(e)))}}const Yv={name:"seek"};function Xv(e,t,i,r,n,s,a){var o=Zm(i),l=i[Tu.Variant],d=l.totalduration,u=n.itemStartOffset,n=n.startTimeOffset;if(o)return Z(e)?0<=e?(e>fg(l)&&(e=Math.max(l.fragments[0].start,fg(l)-l.targetduration),a.warn(`seekTo position exceeds available duration. resetting to ${e}`)),e):u+(d+e):u+Jv(l,n,a);{const c=!Z(e)||e<0;if(t&&(c||0===e&&r.liveEdgeForZeroStartPositon&&"LIVE"===l.type)){if(e=1/0,Z(l.startTimeOffset)||Z(n)){const t=Jv(l,n,a);e=Math.max(0,null===(l=l.fragments[0])||void 0===l?void 0:l.start)+t}}else c&&(e=1/0);return s?e:dy(e,i,r)}}function Jv(e,t=NaN,i=null){let r=0;if(Z(e.startTimeOffset))r=e.startTimeOffset;else{if(!Z(t))return r;r=t}t=e.totalduration;Math.abs(r)>t&&(r=0<=r?t:-1*t,null==i||i.warn(`absolute startTimeOffset:${r} exceeds totalDuration:${t} and is reset to ${r}`));let n=r<0?t-Math.abs(r):r;return e.liveOrEvent&&(n>t-3*e.targetduration&&(null==i||i.warn(`startOffset: ${n} needs to be revised as it is close to live edge. live playback edge: ${t-3*e.targetduration}`)),n=Math.min(n,t-3*e.targetduration)),n}function Zv(i,e,t){var r;const n=t.rootPlaylistQuery.itemId,s=i.getQueueItemForId(n),a=(null===(r=i.playingItem)||void 0===r?void 0:r.itemId)===n,o=a||s.seekImmediately?s.initialSeekTime:null;return t.logger.child(Yv),e.getQuery().pendingSeek$.pipe(pr((e,t)=>0===t&&null==e&&null!=o?(s.seekImmediately&&i.setPlayingItem(s),o):e),function(u){const{config:c,mediaSink:h,rootPlaylistQuery:p,mediaLibraryService:f}=t,m=t.logger.child(Yv);return e=>e.pipe(La((e,t)=>{if(null==e)return wi;var i,r,n,s,o,a,l,d=h.mediaQuery.seekTo$.pipe(ka(1),If(),Ys(null));return yn([(i=e,r=0===t,n=c,s=m,e=p,o=f,t=h.mediaQuery,i instanceof Date?(a=i,l=n,Cy(e,o).pipe(pr(e=>{var t=function(e,t){if(!e||0===e.length)return 0;var i=t.getTime(),[t,e]=oe(i,e),t=e+(i-t)/1e3;return Z(t)?Math.max(0,t):0}(e[Tu.Variant].dateToMediaTime,a);return Zm(e)?t:dy(t,e,l)}),As(1))):function(i,r,n,s,e,a){let t=Cy(s,o).pipe(To(e.liveSeekableRange$),As(1),pr(([e,t])=>Xv(i,r,e,n,s,null!=t,a)),eo(e=>{}));return r&&(t=t.pipe(eo(e=>{}))),t}(i,r,n,e,t,s)),d]).pipe(As(1),eo(e=>{null!=e&&h.seekWithOptions(e,void 0,!0)}),Bs(()=>{u.setUserSeek(void 0)}))}))}(e),Bs(()=>{(a||s.seekImmediately)&&i.updateItemById(n,{initialSeekTime:null,seekImmediately:null})}))}function e0(e,t){const i=e["logger"];return e=>e.pipe(ba(e=>e.pipe(eo(e=>i.error(`Got error in ${t} ${e.message} fatal:${null==e?void 0:e.fatal} handled:${null==e?void 0:e.handled}`)),La(e=>{if(!(e instanceof g)||e.fatal)throw e;return e.handled?Oh:wi}))))}const t0=()=>e=>e.pipe(Jc("mediaFragmentPipelineEpic.in"),La(i=>{if(!i)return wi;const{config:t,platformService:e,rootPlaylistService:r,rootPlaylistQuery:n,keySystemAdapter:s,mediaSink:a,mediaParser:o,gaplessInstance:l,operationQueue$:d}=i,u=n["itemId"],c=a["mediaQuery"],h=s.keyStatusChange$.pipe((p=i,e=>e.pipe(La(e=>{const{decryptdata:t,status:i,error:r}=e,n=p["rootPlaylistQuery"];if("needs-renewal"===i)return Ay(p,t,null);if("error"!==i||!(r instanceof sh||r instanceof nh)||r.handled)return wi;{const{rootPlaylistService:e,keySystemAdapter:t}=p;return iy(r,0,null,e,n,t.ksQuery)}}),La(()=>wi))));var p,f;const m=e.getQuery(),g=m.displaySupportsHdr$.pipe(bs(),La(e=>{e=function(s,a,o){const{config:l,logger:d,mediaLibraryService:u,mediaSink:e,rootPlaylistQuery:c,rootPlaylistService:h}=s,p=e["mediaQuery"];return{operation:Pm.RendererSwitch,priority:Mm.Normal,execute:(t,i,r)=>{var e=en(()=>(h.setHDRPreference(a,o,!0),Oh)).pipe(La(e=>gv(s,t,0,r).pipe(Ka(Sv(t,i,c,u,p,l,d))))),n=en(()=>{});return an(()=>!1,Vi(void 0).pipe(eo(()=>{})),Zr(e,n))},logger:d}}(i,u,e);return d.next(e),wi})),y=m.viewportInfo$.pipe(bs((e,t)=>e&&t&&e.width===t.width&&e.height===t.height),eo(e=>{t.useViewportSizeForLevelCap&&r.setViewportInfo(u,e)}),Va(wi)),v=rd([n.hdrMode$.pipe(bs()),n.maxHdcpLevel$.pipe(bs())]).pipe(La(([])=>(l.inGaplessMode||0!==n.itemStartOffset||(a.resetMediaSource(),o.reset()),wi))),S=dn(function(r){const{rootPlaylistQuery:e,mediaLibraryService:t,mediaSink:n,config:i}=r,s=i.canUseNetworkResourcesForLiveStreamingWhilePaused;return dn(e.enabledMediaOptions$.pipe(If(),eo(e=>{e=e[Tu.AltAudio],e=ju(e)&&null!=(null==e?void 0:e.url)?2:1;n.setExpectedSbCount(e)})),tn([e.enabledMediaOptionByType$(Tu.Variant).pipe(ky(t),As(1)),Ah(n.mediaQuery.updating$,e=>e)]).pipe(Hi(ir),eo(([e])=>{n.bufferMonitorTargetDuration=e.targetduration})),dn(...Wu.map(i=>e.enabledMediaOptionByType$(i).pipe(Jc("mediaOptionRetrieve.switch"),La(t=>{if(!t||!t.url||!ju(t)){if(i===Tu.Variant)throw new Q(!0,"No valid variant enabled",K.NoValidAlternates);return wi}var e=s?Vi(!0):n.mediaQuery.desiredRate$.pipe(pr(e=>0!==e),bs());return Sy(r,t).pipe(Jc("mediaOptionRetrieve.first"),Va(e),La(e=>e?function e(t,i){const r=t.mediaLibraryService;return function(e){if(!e)return wi;var{mediaOptionDetails:t,lastUpdateMillis:i,unchangedCount:e}=e;if(null==t||!t.liveOrEvent)return wi;if(hy(t,i))return En(0).pipe(eo(()=>{}));let r=cy(t);return 0<e&&(r/=2,r=Math.max(r,5e3)),r-=performance.now()-i,r+=0,r=Math.max(1e3,Math.round(r)),En(r).pipe(eo(()=>{}))}(r.getQueryForOption(i).mediaOptionDetailsEntity).pipe(La(()=>Sy(t,i,!1,!0)),La(()=>e(t,i)))}(r,t):wi))}))))).pipe(Va(wi))}(i).pipe(e0(i,"enabledOptions")),(f=i,en(()=>{const r={};return r.enabledMediaOptionSwitchInfo$=new Si(void 0),dn(f.rootPlaylistQuery.enabledMediaOptionsSwitchInfo$(f.logger).pipe(La(e=>(r.enabledMediaOptionSwitchInfo$.next(e),wi))),f.operationQueue$.pipe((i=(e,t,i)=>e.execute(e,i,r),t=>new Kt(e=>function(e,i,r){const n=new zv([]);let s=0,a=0,t=!1;const o=()=>{!t||n.value.length||s||i.complete()},l=e=>{s++;let t=!1;i.add(Br(r(e,a++,n)).pipe(eo({next(e){i.next(e)},error(e){i.error(e)},complete(){t=!0}}),Bs(()=>{if(t)try{for(s--;n.value.length&&s<1;){var e=n.value[0];n.next(n.value.slice(1)),l(e)}o()}catch(e){i.error(e)}})).subscribe())};i.add(e.pipe(eo({next:e=>s<1?l(e):n.next([...n.value,e]),error(e){i.error(e)},complete(){t=!0,o()}})).subscribe())}(t,e,i)))));var i}).pipe(e0(i,"operationQueue"))),h.pipe(e0(i,"keyStatusChange"))).pipe(Ys(void 0));var b=function(e){const{rootPlaylistQuery:h,rootPlaylistService:p,mediaLibraryService:t,mediaSink:f,config:m,iframeMachine:g,itemQueue:i}=e,r=h.itemId,y=f.mediaQuery,v=e.logger.child({name:"anchor"}),n=y.seekTo$.pipe(bs((e,t)=>Math.abs((null==e?void 0:e.pos)-(null==t?void 0:t.pos))<Number.EPSILON),If()),s=Cy(h,t),a=s.pipe(pr(e=>{var t;return{pos:Xv(null===(t=i.getQueueItemForId(r))||void 0===t?void 0:t.initialSeekTime,!0,e,m,h,!1,v),fromEvent:!1}}),As(1));return dn(y.readyState>=HTMLMediaElement.HAVE_METADATA?a:wi,n).pipe(La(({pos:u,discoSeqNum:c})=>Ah(Pr([s,y.updating$]),([e,t])=>!1===t&&e.every((e,t)=>{var i=ju(h.enabledMediaOptionKeys[t]),t=h.enabledMediaOptionIdByType(t),i=!e&&!i||e&&t===e.mediaOptionId;return i||v.warn(`updateAnchor skipped details ${null==e?void 0:e.mediaOptionId} for enabled mediaOption ${t}`),i})).pipe(La(([e])=>{let t=!1;if(y.isIframeRate)return Vi({anchor:{pos:u,discoSeqNum:c},shouldSwitchVariant:t});const i=[h.enabledMediaOptionSwitchContexts[Tu.Variant],h.enabledMediaOptionSwitchContexts[Tu.AltAudio]],r=y.getSourceBufferInfoAction(!0,{pos:u,discoSeqNum:c},i,m.maxBufferHole),n=new mg(v,p,h,f.mediaQuery,g,m,"apicker",!1),s=n.getNextFragments(r,e,v)["chosenFrags"],a=h.anchorTime;Z(c)&&n.discoSeqNum!==c&&v.warn(`fragmentPicker.discoSeqNum != seek to discoSeqNum (${n.discoSeqNum} != ${c}) sbAction: ${JSON.stringify(r)} chosen frags: ${JSON.stringify(s)}`);var o={pos:u,discoSeqNum:n.discoSeqNum},l=(null==a?void 0:a.discoSeqNum)===o.discoSeqNum;n.destroy();const d=zu.map(e=>h.getInFlightFragByType(e));if(l&&s.every((e,t)=>{e=null===(e=null==e?void 0:e.foundFrag)||void 0===e?void 0:e.mediaFragment,t=d[t];return!e&&!t||vf(e,t)}))return v.warn(`Not re-anchoring @${u.toFixed(3)} cc:${o.discoSeqNum}`),wi;if(y.readyState>=HTMLMediaElement.HAVE_METADATA&&l&&!y.isIframeRate){const u=y.getBufferedSegmentsByType(Iu.Variant),h=y.getMediaBufferInfo(o.pos,u,m.maxBufferHole);t=(h.combined.len||0)<yg(m,e[Tu.Variant],h)}return Vi({anchor:o,shouldSwitchVariant:t})}))),dl(e=>{e.shouldSwitchVariant&&dv(xm.Seek,m,h,y,p),p.setAnchorTime(r,e.anchor)}))}(i),T=c.gotPlaying$.pipe(cn(e=>e),eo(e=>{n.mediaOptionListQueries[Tu.Variant].filteredMediaOptionList.forEach(e=>{})}),As(1),Va(wi));return dn(function(d){const{rootPlaylistQuery:u,mediaSink:c,mediaLibraryService:e,config:h,itemQueue:p}=d,i=h["livePlaylistUpdateStaleness"],f=c.mediaQuery,t=Pr([u.enabledMediaOptionByType$(Tu.Variant).pipe(i0(e)),u.enabledMediaOptionByType$(Tu.AltAudio).pipe(i0(e))]);return Pr([t,f.msReadyState$,f.desiredRate$]).pipe(La(([e,t])=>"open"!==t||e.some(e=>null!=e&&!0===e.mediaOptionDetails.liveOrEvent&&!uv(e,i))?wi:Ah(f.updating$,e=>!e).pipe(Ys(e),To(f.bufferedRangeTuple$),dl(([[e,t],i])=>{var r;const n=[e.mediaOptionDetails,null==t?void 0:t.mediaOptionDetails],s=!Zm(n),a=eg(n);let o=!0,l=NaN;if(s)if(a){const d=ly(n,h),p=Math.max(e.lastUpdateMillis,null!==(r=null==t?void 0:t.lastUpdateMillis)&&void 0!==r?r:-1/0);c.updateLiveSeekableRange(d.start,d.end,d.edge,d.boundary,p),function(e,r,n,s){if(1===s.desiredRate){const t=s.currentTime,a=n.maxSeekHole,o={avgPlaylistLoadTimeMs:0,avgPlaylistParseTimeMs:0},l=s.getBufferInfo(t,a);return e.map(e=>e?oy(e.mediaOptionDetails,n):null),!e.every((e,t)=>{var i=null==e?void 0:e.mediaOptionDetails;if(null==i||s.canContinuePlaybackWithoutGap(i,e.lastUpdateMillis,o,a))return!0;e=r[t],t=null===(t=l[t])||void 0===t?void 0:t.buffered;if(!e||!t)return!1;e={start:e.start,end:e.start+e.duration},i=oy(i,n);return uy(e,t,a)&&uy(e,i,a)})}}([e,t],u.getInFlightFrags(),h,f)&&(l=h.liveResumeAtWindowStart?0:1/0)}else o=!1;else c.clearLiveSeekableRange();if(o){const d=i[Iu.Variant],u=i[Iu.AltAudio],e=null!==(i=null===(i=null==d?void 0:d[d.length-1])||void 0===i?void 0:i.end)&&void 0!==i?i:0,h=null!==(i=null===(i=null==u?void 0:u[u.length-1])||void 0===i?void 0:i.end)&&void 0!==i?i:0,t=Math.max(e,h),f=isNaN(c.msDuration)?0:c.msDuration,s=Math.max(fg(n[Tu.Variant]),n[Tu.AltAudio]?fg(n[Tu.AltAudio]):0);c.msDuration=Math.max(f,s,t);const a=p.getQueueItemForId(n[Tu.Variant].itemId);c.primaryContentDuration=s-a.itemStartOffset}return isNaN(l)||d.interstitialController.interstitialIsPlaying()||c.seekWithOptions(l,void 0,!0),wi}))))}(i),b,S,g,y,v,function(){const{mediaSink:e,interstitialController:d,statsService:u}=i,t=e.mediaQuery;return Pr([Vi(i),t.desiredRate$.pipe(da())]).pipe(La(([e,[t,i]])=>{const{rootPlaylistQuery:s,rootPlaylistService:r,config:a,mediaSink:n,mediaLibraryService:o}=e,l=n.mediaQuery;if(Rf(t)!==Rf(i))dv(xm.IframeModeChange,a,s,l,r);else if(0===t&&1===i&&!zu.every(e=>{const t=s.enabledMediaOptionKeys[e],i=o.getQueryForOption(t),r=u.getQueryForItem(s.itemId),n=i.mediaOptionDetailsEntity;return!(null!==(e=null==n?void 0:n.mediaOptionDetails)&&void 0!==e&&e.ptsKnown)||l.canContinuePlaybackWithoutGap(n.mediaOptionDetails,n.lastUpdateMillis,r.getPlaylistEstimate(),a.maxBufferHole)})&&!d.interstitialIsPlaying())return n.pause(),n.flushAll(0,1/0,!0);return wi}),Va(wi))}(),function(e){const t=e.rootPlaylistQuery,i=e.mediaSink.mediaQuery,r=t.enabledMediaOptionByType$(Tu.Variant);return Pr([Vi(e),i.desiredRate$.pipe(da())]).pipe(bs((e,t)=>e[1]===t[1]),To(r),La(([[e,[t,i]],r])=>{t=Rf(t),i=Rf(i);if(t===i)return wi;const n=e["rootPlaylistService"];return i&&e.rootPlaylistQuery.nextMaxAutoOptionId===qu.mediaOptionId&&n.setNextMaxAutoOptionId(e.rootPlaylistQuery.itemId,r.mediaOptionId),wi}))}(i),T).pipe(Jc("mediaFragmentPiplineEpic.emit"),Ys(void 0))}));function i0(t){return e=>e.pipe(function(t){return e=>e.pipe(Ry(t),La(e=>e?e.mediaOptionDetailsEntity$.pipe(If()):Vi(null)))}(t),cn(e=>null==e||null!=e.mediaOptionDetails),bs((e,t)=>{e=null==e?void 0:e.mediaOptionDetails,t=null==t?void 0:t.mediaOptionDetails;return(null==e?void 0:e.endSN)===(null==t?void 0:t.endSN)&&(null==e?void 0:e.ptsKnown)===(null==t?void 0:t.ptsKnown)&&(null==e?void 0:e.liveOrEvent)===(null==t?void 0:t.liveOrEvent)}))}const r0=(e,t)=>{let i,r="";return i=e.videoCodec&&e.audioCodec?(r=`${e.videoCodec}, ${e.audioCodec}`,t=null!=t?t:"video/mp4","audiovideo"):e.videoCodec?(r=`${e.videoCodec}`,t=null!=t?t:"video/mp4","video"):(r=`${null!==(e=e.audioCodec)&&void 0!==e?e:""}`,t=null!=t?t:"audio/mp4","audio"),{mimeType:`${t};codecs=${r}`,codec:r,container:t,type:i}};class n0{constructor(e,t,i){this.config=e,this.logger=t,this.demuxClient=i,this.typeSupported={mp4:MediaSource.isTypeSupported("video/mp4"),mpeg:MediaSource.isTypeSupported("audio/mpeg"),mp3:MediaSource.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:MediaSource.isTypeSupported('audio/mp4; codecs="ac-3"'),ec3:MediaSource.isTypeSupported('audio/mp4; codecs="ec-3"')},this.demuxers=[],this.lastInitFrags=[],this.lastFrags=[]}parseInitSegment(e,t){const i=e["frag"],{keyTagInfo:r,mediaOptionType:n}=i;if(this.lastInitFrags[n]=i,et.probeInitSegment(e.initSegment)){const t=Ye.remuxInitSegment(new Uint8Array(e.initSegment),this.logger,r),i=et.parseInitSegment(t),{mimeType:n,type:s,codec:a,container:o}=r0(i);return Vi({moovData:i,mimeType:n,track:{type:s,codec:a,initSegment:t,container:o}})}return Vi({moovData:null,mimeType:null,track:{type:null,codec:null,initSegment:e.initSegment,container:null}})}parseSegment(g,e){return this.getDemuxerInfo(g,this.lastFrags,e,this.demuxClient).pipe(La(({demuxer:e,contiguous:t,trackSwitch:i,discontinuity:r,accurateTimeOffset:n})=>{const{frag:h,defaultInitPTS:s}=g,{keyTagInfo:a,start:o,duration:p,mediaOptionType:f}=h;let m;this.lastFrags[f]=h;const l=Ac(e.observer);return Vi(l.event(I.FRAG_PARSING_INIT_SEGMENT).pipe(La(e=>{var t;return e.track.initSegment.byteLength!==(null===(t=g.initSegment)||void 0===t?void 0:t.byteLength)&&(m=this.handleInitSegmentData(e)),wi})),l.event(I.FRAG_PARSING_DATA).pipe(pr(e=>{var{startPTS:t,startDTS:i,firstKeyframePts:r,framesWithoutIDR:n,dropped:s,data1:a,data2:o,captionData:l,id3Samples:d}=e;let{endPTS:u,endDTS:c}=e;return null==u&&(this.logger.warn(`${Gu[f]} ${Sf(h)}: null endPTS parsed, using duration ${p}`),u=Object.assign(Object.assign({},t),{baseTime:t.baseTime+F(p,t.timescale).baseTime})),null==c&&(this.logger.warn(`${Gu[f]} ${Sf(h)}: null endDTS parsed, using duration ${p}`),c=Object.assign(Object.assign({},i),{baseTime:i.baseTime+F(p,i.timescale).baseTime})),Z(g.iframeMediaStart)||function(e,t,i,r){let n=NaN,s=NaN;Z(i)&&(s=i,n=.01,isFinite(s)&&isFinite(r)&&(s+=r));var{startPTS:a,startDTS:i,endPTS:r,endDTS:t}=t;if(!(0<=a.baseTime&&0<=i.baseTime&&0<e.duration&&(null==r||0<y(r,a))&&(null==t||0<y(t,i)))||Z(n)&&Z(s)&&!(Math.abs(E(i)-s)<=n))throw new b(!1,`Failed demuxer sanity check frag=${Sf(e)} parsed=${JSON.stringify({startPTS:a,endPTS:r,startDTS:i,endDTS:t})} ${te({expectedStartDTS:s,fudge:n})}`,K.FailedDemuxerSanityCheck)}(h,e,g.iframeMediaStart,this.config.audioPrimingDelay),{startPTS:t,endPTS:u,startDTS:i,endDTS:c,firstKeyframePts:r,framesWithoutIDR:n,dropped:s,data1:a,data2:o,captionData:l,id3Samples:d,parsedInitSegment:m}})),l.event(D.INTERNAL_ERROR).pipe(La(this.handleError)),e.push(g.segment,a,g.initSegment,o,r,i,t,g.totalDuration,n,s,g.iframeMediaStart,g.iframeDuration).pipe(Va(wi))).pipe(Jr(),As(1))}))}reset(e){if(null==e)return this.demuxers.forEach(e=>{e&&e.destroy()}),void(this.demuxers=[]);const t=this.demuxers[e];null==t||t.destroy(),this.demuxers[e]=null}destroy(e){null!=e?this.reset(e):this.reset()}willBeTrackSwitch(e,t){var{mediaOptionType:i,mediaOptionId:e}=e,i=(t||this.lastFrags)[i];return!(i&&i.mediaOptionId===e)}getDemuxerInfo(e,r,t,i){const{frag:n,ptsKnown:s,seeking:a,live:o}=e,{discoSeqNum:l,mediaSeqNum:d,mediaOptionType:u}=n;return en(()=>{var e=this.demuxers[u];return e?Vi(e):i.init(this.typeSupported,this.config,t).pipe(eo(e=>this.demuxers[u]=e))}).pipe(pr(e=>{var t=r[u],i=this.willBeTrackSwitch(n,r);return{demuxer:e,trackSwitch:i,discontinuity:!(t&&l===t.discoSeqNum),contiguous:!!t&&!i&&t.mediaSeqNum+1===d,accurateTimeOffset:!a&&(s||!o)}}))}handleInitSegmentData(e){var t=e["track"],i=t["initSegment"],r=et.parseInitSegment(i),{mimeType:n,type:s,codec:a,container:e}=r0(r,t.container);return{moovData:r,mimeType:n,track:Object.assign(Object.assign({},t),{type:s,codec:a,initSegment:i,container:e})}}handleError(e){return Ki(e)}}class s0{constructor(e,t,i,r){this.hls=e,this.rtcService=t,this.config=i,this.logger=r,this.destroy$=new Jt,this.subscribeAndUpdateStore(),this.registerForEvents()}destroy(){this.rtcService.destroy(),this.destroy$.next()}registerForEvents(){const e=Ac(this.hls,this);dn(e.event(D.KEY_REQUEST_STARTED,this._keyRequestStarted,this),e.event(D.KEY_LOADED,this._keyLoaded,this)).pipe(Ka(this.destroy$)).subscribe()}subscribeAndUpdateStore(){this.hls.publicQueries$.pipe(La(([,e])=>this.mediaElementQueryListener(e)),Ka(this.destroy$)).subscribe(),this.hls.itemQueue.activeItemById$.pipe(eo(t=>{if(t&&!t.parentItemId){let e=!1;if(this.hls.userInfo?this.hls.userInfo.internalBuild?e=!0:this.hls.userInfo.diagnosticsAndUsage&&(e=this.config.enableRtcReporting):e=this.config.enableRtcReporting,e){const t=this.hls.reportingAgent;t?this.rtcService.rtcComponent.setReportingAgent(t):this.logger.warn(s0.loggerName,"[RTCA] - Reporting is enabled but reportingAgent is null")}else this.rtcService.rtcComponent.setReportingAgent(null);this.rtcService.serverInfoInstance=null;var i=t.itemId;this.rtcService.rtcStore.createEntity(i,this.rtcService.hlsjsVersion,this.config.enableInterstitialPlayback,0<t.loopCount),!this.hls.isFirstItem&&this.hls.inGaplessMode||this.rtcService.setPeriodic(i)}}),Ka(this.destroy$)).subscribe()}mediaElementQueryListener(e){return e.gotPlaying$.pipe(eo(e=>{if(e){const e=this.rtcService.oldRate,t=this.rtcService.newRate||1;1<Math.abs(e)&&1<Math.abs(t)||(this.rtcService.rtcStore.updateCanPlay(this.rtcService.rtcEventItemId(!0),{mediaDur:this.hls.bufferedDuration,oldRate:e,newRate:t,forInterstitial:this.hls.interstitialActive}),this.rtcService.sendAndFinalize(this.rtcService.rtcEventItemId(!0),ym.PlayLikelyToKeepUp),this.rtcService.rtcStore.updateRateChanged(this.rtcService.rtcEventItemId(!0),{rate:t,latency:Z(this.rtcService.playStart)?Date.now()-this.rtcService.playStart:0,mediaDur:this.hls.bufferedDuration,currentTime:this.hls.realCurrentTime,url:this.rtcService.levelSwitchingUrl,forInterstitial:this.hls.interstitialActive}),this.rtcService.sendAndFinalize(this.rtcService.rtcEventItemId(!0),ym.PlayRateChanged))}}))}_keyRequestStarted(e){this.rtcService.keyRequestStarted(e,this.hls.interstitialActive)}_keyLoaded(e){this.rtcService.keyLoaded(e,this.hls.interstitialActive)}}function a0(y,v,S,b,T,I){return e=>e.pipe(If(),La(({activeItem:e,config:t})=>{if(!e)return Vi(null);const i=Ym().getQuery().alternateMatchingInfo,r=Vi(e).pipe((l=t.manifestLoadPolicy,d=v,u=t,c=S,h=i,p=b,f=T,e=>e.pipe(Jc("retrieveRootMediaOptions.input"),La(t=>{var e;if(null==t)return wi;const{itemId:i,platformInfo:r,isInterstitial:n}=t,s=$v(i),a=d["logger"];if(s.hasEntity(i))return Vi(s);Bv.setLoading(!0);const o=performance.now();return function(e,t,h,p,i){const{parentItemId:f,itemId:m,url:g,itemStartOffset:y,isInterstitial:v}=e,r=Dc(e,t);return Wc({url:g,onProgress:{getData:!0,cb:bv},xhrSetup:p.xhrSetup},r,i,xc()).pipe(pr(({responseText:e,responseURL:t,stats:i})=>{var r=p["keySystemPreference"];if(t||(h.warn("Missing response url. Reusing request url as base url"),t=g),Wg.isMediaPlaylist(e)){const p="media-pl-"+Zl(),v=Wg.parseMediaOptionPlaylist(e,t,r,{},m,p,Tu.Variant,h,y);Lc(v.mediaOptionDetails);var n={itemId:m,mediaOptionId:p,mediaOptionType:Tu.Variant,url:g,bandwidth:0,bitrate:0,iframes:v.mediaOptionDetails.iframesOnly,pathwayID:"."};return{parentItemId:f,itemId:m,itemStartOffset:y,rootMediaOptionsTuple:[[n],[],[]],stats:i,baseUrl:t,initialDetails:v.mediaOptionDetails,isMediaPlaylist:!0}}{const h=Wg.parseSessionData(e,t),p=Wg.parseSessionKeys(e,t,r),g=Wg.parseRootPlaylist(m,e,t);if(g.playlistParsingError)throw g.playlistParsingError;const{variantMediaOptions:o,contentSteeringOption:l,masterVariableList:d,startTimeOffset:u}=g,c=Wg.parseRootPlaylistAlternateMediaOptions(m,e,t,g.variantMediaOptions,d,v);if(c.playlistParsingError)throw c.playlistParsingError;var s=o.reverse(),{audioAlternateOptions:a,subtitleAlternateOptions:n,audioMediaSelectionGroup:r,subtitleMediaSelectionGroup:e}=c.alternateMediaInfo;return{parentItemId:f,itemId:m,itemStartOffset:y,rootMediaOptionsTuple:[s,a,n],stats:i,baseUrl:t,audioMediaSelectionGroup:r,subtitleMediaSelectionGroup:e,contentSteeringOption:l,sessionData:h,sessionKeys:p,masterVariableList:d,startTimeOffset:u}}}),e=>e.pipe(Qn(e=>{if(e instanceof vc)throw new fc(!1,"Timeout",K.ManifestTimeoutError,!0);if(e instanceof hc)throw new fc(!1,e.message,{code:e.statusCode,text:"Manifest network error"},!1);throw e})))}(t,l,a,u,null===(e=null===(e=Ym())||void 0===e?void 0:e.getQuery())||void 0===e?void 0:e.extendMaxTTFB).pipe(eo(e=>f.triggerManifestLoaded(e)),eo(({initialDetails:e,stats:t})=>{e&&(e=e,t=t,yy().archiveMediaOptionDetails(e,t,!0))}),To(c.displaySupportsHdr$),La(([e,t])=>((r,e,t,n,s,i)=>{const{rootMediaOptionsTuple:a,sessionKeys:o}=r,l=Array.from(a[Tu.Variant]),d=Array.from(a[Tu.AltAudio]);let u=!1,c=!1;l.forEach(e=>{u=u||Boolean(e.videoCodec),c=c||Boolean(e.audioCodec)||Boolean(e.audioGroupId)});let h=l;return u&&c&&(h=l.filter(({videoCodec:e})=>Boolean(e))),Cv(h,d,o,e,t,i).pipe(pr(({hdrMediaOptions:e,sdrMediaOptions:t,imageIframeVariants:i})=>{t=e.concat(t),e=0<e.length;return function(e,t,i,r,n,s){var{parentItemId:a,itemId:o,itemStartOffset:l,rootMediaOptionsTuple:d,audioMediaSelectionGroup:u,subtitleMediaSelectionGroup:c,startTimeOffset:h=NaN}=e,p=Array.from(d[Tu.AltAudio]),f=Array.from(d[Tu.Subtitle]),m=e=>Z(e.score),g=t.every(m),y=e.baseUrl,v=null===(S=e.contentSteeringOption)||void 0===S?void 0:S.initPathwayID,S=null===(d=e.contentSteeringOption)||void 0===d?void 0:d.initPathwayPriority,d=e.sessionData,m=s.every(m),t=Ky(t,{hasScore:g,pathwayPriority:S,pivotVariant:null,preferHostOverQuality:!0,preferCloseToPivotQuality:!1}),m=Ky(s,{hasScore:m,pathwayPriority:S,pivotVariant:null,preferHostOverQuality:!0,preferCloseToPivotQuality:!1});return{parentItemId:a,itemId:o,baseUrl:y,mediaOptionListTuple:[{mediaOptions:t,hasHdrLevels:i,hasScore:g,preferHDR:r,compatibleIds:null,penaltyBoxQueue:[],removed:[],currentPathwayID:v,pathwayPriority:S},{mediaOptions:p,compatibleIds:null,penaltyBoxQueue:[],removed:[]},{mediaOptions:f,penaltyBoxQueue:[],removed:[]}],audioMediaSelectionGroup:u,subtitleMediaSelectionGroup:c,enabledMediaOptionKeys:[qu,qu,qu],mediaOptionSwitchContexts:[null,null,null],anchorTime:null,discoSeqNumObject:{seqNum:NaN,wasSetInIframe:!1},itemStartOffset:l,startTimeOffset:h,initPtsRecord:{},contentSteeringOption:e.contentSteeringOption,masterVariableList:e.masterVariableList,loadStats:e.stats,isMediaPlaylist:e.isMediaPlaylist,isInterstitial:n,iframeVariants:m,abrStatus:{fragDownloadSlow:!1,fragDownloadTooSlow:!1,nextMinAutoOptionId:qu.mediaOptionId,nextMaxAutoOptionId:qu.mediaOptionId,highBWTrigger:NaN},sessionData:d}}(r,t,e,n,s,i)}))})(e,r,u,t,n,a)),pr(e=>(d.rootPlaylistEntity=function(e,t,i,r,n,s){const a=e["itemId"],o=Vm(a),l=n.enableAdaptiveStartup?o.getBandwidthEstimate(n,e.serviceName):void 0,d=n.enableAdaptiveStartup?o.getPlaylistEstimate(n,e.serviceName):void 0,u=n.enableAdaptiveStartup?o.getFragEstimate(n,e.serviceName):void 0,c=n.enableAdaptiveStartup?o.getBufferEstimate(n,e.serviceName):void 0,h=performance.now()-r;let p;return n.targetStartupMs>h?p=n.targetStartupMs-h:(p=n.targetStartupMs,s.warn(`Manifest load took ${h}ms and exceeds targetStartupMs: ${n.targetStartupMs}; resetting targetStartupMs to ${n.targetStartupMs}`)),qv(t,i,s,n,l,n.enableAdaptiveStartup?{targetDuration:u.maxDurationSec||n.defaultTargetDuration,targetStartupMs:p}:void 0,d,u,c)}(t,e,h,o,u,a),s)),ry(i,null,Dc(t,l),0,!1,s,d,p),Bs(()=>{Bv.setLoading(!1)}))}),Jc("retrieveRootMediaOptions.emit")))),n=Object.assign({},t);var l,d,u,c,h,p,f,s,a,o,m,g;if(null!=e&&e.isInterstitial)for(const y of _u){const v=t[y].interstitial,S=t[y];n[y]=Object.assign(Object.assign({},S),{default:v,customURL:v})}return Pr([r,(o=t,m=y,g=I.mux,new Kt(e=>{const t=new n0(o,m,g);return e.next(t),()=>{t.destroy()}})),(s=t.trickPlaybackConfig,a=y,new Kt(e=>{const t=new cc(s,a);return e.next(t),()=>{t.destroy()}})),Vi(n)]).pipe(pr(([e,t,i,r])=>({rootPlaylistQuery:e,mediaParser:t,iframeMachine:i,config:r})))}))}s0.loggerName={name:"rtc-service"};wc;return class o0 extends wc{constructor(e={},t,i,r){var n,s,a,o,l,d;if(super(),this.destroy$=new Jt,this.mediaElement$=new Si(null),this.publicQueriesInternal$=new Si(null),this.mediaElementAdapter=null,this.rpcService=null,this.rpcClients=null,this.hlsService=Ym(),this.platformService=sm(),this.interstitialService=(jc=jc||new Qc(qc),jc),this.keySystemAdapter=null,this.legibleSystemAdapter=null,this.sessionID=Zl(),this.statsService=($m=$m||new Bm(Um),$m),this.gaplessCapable=!0,this.teardownWG$=new Mf,this.commitedEarlyAlternateSelection=!1,this.operationQueue$=new Jt,this.itemQueue=new _v,e.liveSyncDurationCount&&e.liveSyncDuration)throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount and liveSyncDuration");const u=function(e,t,i,r){if(!(e&&i&&(n=e,s=Ku,null!=n&&n.BagDict&&n.ConfigurationDict&&function(e,t){return e&&t&&(e=e.split("."),t=t.supportedStorebagVersion.split("."),e[0]===t[0])}(n.Version,s))))return{};var n,s;const a=new Set(Object.keys(r).filter(e=>!!Object.prototype.hasOwnProperty.call(r,e)&&r[e]!==Qu[e])),o=e.ConfigurationDict;let l={};const d=e.BagDict[i.clientName],u=d?d[i.serviceName]:null;if(function(t,i){if(t&&i){const s=t.VersionRange;if(s){const a=s[0],o=s[1];if(a&&o&&ff(a,o)){var r=t.SamplingThreshold;if(Z(r)&&r<=1&&0<=r){var n=t.Configurations;if(n){let e=0;for(const t of n){if(!t)return;const s=t[0],a=t[1],o=s?i[s]:null;if(!(s&&o&&o.Patch&&o.GroupId&&Z(a)))return;e+=a}if(r=Math.abs(1-e)<=Number.EPSILON,n&&0<n.length&&r){const l=new Date(t.ExpirationDate);return l&&l.getTime()>Date.now()}}}}}}}(u,o)){const c=Math.max(0,Math.min(u.SamplingThreshold,1)),h=0===mf([c,1-c]);if(e=u,i=t,t=e.VersionRange,e=t[0],t=t[1],(null==e||ff(i,e))&&(null==t||ff(t,i))&&h){const c=(t=u.Configurations.map(e=>[o[e[0]],e[1]]),i=mf(t.map(([,e])=>e)),t[i][0]),p=Object.keys(c.Patch).filter(e=>(e=>e in Qu&&!pf.has(e)&&!a.has(e))(e));if(0===p.length)return{};const h=p.reduce((e,t)=>(Object.prototype.hasOwnProperty.call(c.Patch,t)&&(e[t]=c.Patch[t]),e),{});l.testGroupId=c.GroupId,l=Object.assign(l,h)}}return l}(r,o0.version,i,e),E=Object.assign(Object.assign(Object.assign({},Qu),e),u);if(E.maxRequiredStartDuration<E.minRequiredStartDuration||E.minRequiredStartDuration<0)throw new Error("Illegal config: bad maxRequiredStartDuration or minRequiredStartDuration");i=(this.hlsConfig=E).buildType,ie="production"===i;const c=this.sessionID;let h="silent";e.debug&&(h=E.debugLevel),du(!0),this.logger=null!==(i=this.logger)&&void 0!==i?i:([x,D,M={}]=[c,"hls",(M={allowed:e.allowedLogs,buildType:E.buildType,consoleOverride:"boolean"!=typeof e.debug?e.debug:void 0,disallowed:e.disallowedLogs,level:"log"===h?"debug":h,sendLogs:E.sendLogs||null},e=M.consoleOverride,x=new Set(M.allowed),D=new Set(M.disallowed),Object.assign({name:"hls",timestamp:M.sendLogs?Ae.stdTimeFunctions.epochTime:Ae.stdTimeFunctions.isoTime,browser:{asObject:!0,serialize:!0,transmit:{send:(e,t)=>{}},write:{debug:qe.bind(null,Qe(e||console,"debug"),"debug",x,D),info:qe.bind(null,Qe(e||console,"info"),"info",x,D),warn:qe.bind(null,Qe(e||console,"warn"),"warn",x,D),error:qe.bind(null,Qe(e||console,"error"),"error",x,D),fatal:qe.bind(null,Qe(e||console,"error"),"fatal",x,D)}}},M))],Ue&&Ue.sessionId===x?Ue.warn("Logger Singleton already setup, returning existing singleton"):(Ue=Ae($e(M)).child({sessionId:x,name:D}),Ue.qe=Ve(M.allowed,M.disallowed),Ue.sessionId=x,"function"!=typeof Ue.isLevelEnabled&&(Ue.isLevelEnabled=function(e){return this.levelVal>=this.levels.values[e]}.bind(Ue))),Ue),No=!1,Lo&&(delete window.$$stores,delete window.$$queries),this.hlsConfig.audioPrimingDelay=0,this.rootPlaylistService=(D=this.logger,M=this.hlsConfig,Uv=new Fv(Bv,D,M),Uv),this.customUrlLoader=xc(),this.sessionDataLoader=new hf(kc,this.customUrlLoader.load,this.logger);const p=this.hlsService;p.setHlsEntity({id:c,config:E});const f=yy(),m=new tm(rm),g=(lp=lp||new ap(op),lp);this.accessLogInstance=new gm(this,c),this.rtcService=new Em(this,E,o0.version,this.accessLogInstance,this.logger),this.rtcController=new s0(this,this.rtcService,this.hlsConfig,this.logger),E.testGroupId&&(null===(P=this.rtcService)||void 0===P||P.handleConfigLoaded(E.testGroupId)),this.interstitialController=new Gv(this.itemQueue,this.interstitialService,this.publicQueriesInternal$,this.hlsConfig,this.rtcService.rtcQuery,this.logger),this.playerEvents=new jv(this,this.logger,this.rtcService);const y=(x=this.platformService,d=x,(()=>{if("function"==typeof matchMedia){const t=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(t.media!==e.media){let e;return e="function"==typeof t.addEventListener?nn(t,"change"):"function"==typeof t.addListener?sn(t.addListener.bind(t),t.removeListener.bind(t)):wi,dn(Vi(t.matches),e.pipe(pr(em)))}}return Vi(!0)})().pipe(eo(e=>{d.updateSupportsHdr(e)})).pipe(Va(wi))),v=this.mediaElement$.pipe((n=E,a=(s=this).logger,o=this.teardownWG$,l=this.rtcService,e=>e.pipe(Jc("playback.mediaElementServiceEpic.in"),La(e=>{if(!e)return Vi(null);const t=new Yf(e,Zf,n,s,a,o,l);return t.openMediaSource(new MediaSource),dn(Vi(t),t)}),Jc("playback.mediaElementServiceEpic.emit"))),Ra()),S=this.itemQueue.activeItemById$.pipe(La(e=>e?function(f,m,g){return new Kt(e=>{(e=>{const t=Vm(e);var i;t.hasEntity(e)?Vi(t):(i=Um,Co("stats.loading"),i.setLoading(!0),i.statsEntity={id:e,bandwidthEstimate:{avgLatencyMs:NaN,avgBandwidth:NaN},bandwidthStatus:{bandwidthSampleCount:0,instantBw:NaN},fragEstimate:{maxDurationSec:NaN,avgParseTimeMs:NaN},playlistEstimate:{avgPlaylistLoadTimeMs:NaN,avgPlaylistParseTimeMs:NaN},bufferEstimate:{avgBufferCreateMs:NaN,avgInitFragAppendMs:NaN,avgDataFragAppendMs:NaN}},i.setLoading(!1),Co("stats.loaded"))})(g.itemId);const t=Vm(g.itemId),{fragSample$:i,playlistSample$:r,bandwidthSample$:n,bufferMetric$:s}=t;return dn(r.pipe(Hi(ir),(h=f,p=m,e=>e.pipe(Jc("statsPlaylistProcessingEpic.in"),ia((e,t)=>(e.playlistLoadTimeMs.add(t.playlistLoadTimeMs),e.playlistParseTimeMs.add(t.playlistParseTimeMs),e),{playlistLoadTimeMs:new Nm(h.minPlaylistCount),playlistParseTimeMs:new Nm(h.minPlaylistCount)}),pr(e=>({avgPlaylistLoadTimeMs:e.playlistLoadTimeMs.avg,avgPlaylistParseTimeMs:e.playlistParseTimeMs.avg})),bs(Km),eo(e=>{p.setPlaylistEstimate(e)})))),n.pipe(Hi(ir),(u=f,c=m,n=>new Kt(e=>{let t=new km(u.bandwidthHistoryWindowSize,u.bandwidthHistoryAggregationMethod,{avgLatencyMs:NaN,avgBandwidth:NaN});const i=t.estimate$,r=dn(n.pipe(cn(e=>e.complete),eo(e=>{}),pr(e=>({trequest:e.trequest,tfirst:e.tfirst,tload:e.tload,bitsDownloaded:8*e.loaded})),Jc("statsBandwidthProcessingEpic.in"),La(e=>(t.record(e),wi))),i.pipe(bs(),Jc("statsBandwidthProcessingEpic.change"),eo(e=>{c&&c.setBandwidthEstimate(e)}))).subscribe(e);return()=>{r.unsubscribe(),t.destroy(),t=void 0}}))),i.pipe(Hi(ir),(l=f,d=m,e=>e.pipe(Jc("statsFragProcessingEpic.in"),ia((e,t)=>(e.durationSec.add(t.durationSec),e.fragParseMs.add(t.parseTimeMs),e),{durationSec:new Nm,fragParseMs:new Nm(l.minFragmentCount)}),pr(e=>({maxDurationSec:e.durationSec.max,avgParseTimeMs:e.fragParseMs.avg})),bs(Km),eo(e=>d.setFragEstimate(e))))),s.pipe(Hi(ir),(a=f,o=m,e=>e.pipe(Jc("statsBufferMetricProcessingEpic.in"),ia((e,t)=>(Z(t.bufferCreationStart)&&Z(t.bufferCreationEnd)&&e.bufferCreateMs.add(t.bufferCreationEnd-t.bufferCreationStart),Z(t.startInitAppend)&&Z(t.endInitAppend)&&e.initFragAppendMs.add(t.endInitAppend-t.startInitAppend),Z(t.startDataAppend)&&Z(t.endDataAppend)&&e.dataFragAppendMs.add(t.endDataAppend-t.startDataAppend),e),{bufferCreateMs:new Nm,initFragAppendMs:new Nm,dataFragAppendMs:new Nm(a.minFragmentCount)}),pr(e=>({avgBufferCreateMs:e.bufferCreateMs.avg,avgInitFragAppendMs:e.initFragAppendMs.avg,avgDataFragAppendMs:e.dataFragAppendMs.avg})),bs(Km),eo(e=>{o.setBufferEstimate(e)}))))).pipe(Va(wi)).subscribe(e),()=>{Lm.setCombinedEstimate(f,Object.assign(Object.assign(Object.assign(Object.assign({},t.getFragEstimate()),t.getPlaylistEstimate()),t.getBufferEstimate()),t.getBandwidthEstimate()),g.serviceName)};var a,o,l,d,u,c,h,p})}(E,this.statsService,e,this.logger):wi));this.rpcService=(()=>{let e=null;return null!=E.createRPCService&&(e=fm(E.createRPCService,cm)),E.enableWorker&&null==e&&(e=mm),null==e&&(e=cm),e(this.logger)})(),this.rpcClients=(D=this.rpcService,{crypto:new om(D),mux:new lm(D)});var b,T,I,w,O,A,R,k,C,M=Pr([this.itemQueue.activeItemById$.pipe(pr(e=>({activeItem:e,preloading:this.itemQueue.isPreloading(),config:E})),a0(this.logger,this.rootPlaylistService,m,this.statsService,this.playerEvents,this.rpcClients),ba(e=>e.pipe(La(e=>this._handleError(e)))),eo(e=>{var t=null==e?void 0:e.rootPlaylistQuery;this.publicQueriesInternal$.next([t,null,this.interstitialService.interstitialQuery]),this.iframeMachine=null==e?void 0:e.iframeMachine,t&&this.playerEvents.triggerManifestParsed(t)})),v.pipe((b=this.itemQueue.removedItems$,T=this.teardownWG$,I=g,w=E,O=m,R=(A=this).rtcService,k=this.interstitialService.interstitialQuery.playingInterstitialId$,C=this.logger,e=>Pr([((n,s,a,o,l,d,u,c)=>e.pipe(Jc("[Keys] playback.keySystemServiceEpic.in"),La(r=>r?new Kt(e=>{let t=new np(n,r,o,l,d,u,c);const i=dn(Vi(t),s.pipe(Hr(e=>t.removeKeysForItems(e)),Va(wi))).subscribe(e);return function(){c.warn("[Keys] playback.keySystemServiceEpic.unsubscribe"),i.unsubscribe(),a.wrap(t.destroy()).subscribe(),t=void 0}}):Vi(null)),Jc("[Keys] playback.keySystemServiceEpic.emit")))(I,b,T,w,O,A,R,C),((t,i,r,n)=>e.pipe(Jc("playback.legibleServiceEpic.in"),La(e=>e?dn(Vi(e=new uf(e,t,i,r,n)),e):Vi(null)),Jc("playback.legibleServiceEpic.emit")))(w,A,k,C),e]).pipe(pr(([e,t,i])=>({keySystemAdapter:e,legibleSystemAdapter:t,mediaSink:i})))),eo(({keySystemAdapter:e,legibleSystemAdapter:t,mediaSink:i})=>{this.keySystemAdapter=e,this.legibleSystemAdapter=t,this.mediaElementAdapter=i}))]).pipe(pr(([e,t])=>{var{keySystemAdapter:i,legibleSystemAdapter:r,mediaSink:n}=t;if(!(e&&i&&r&&n))return null;var{rootPlaylistQuery:s,iframeMachine:a,mediaParser:t,config:e}=e;return{logger:this.logger,config:e,platformService:this.platformService,statsService:this.statsService,rtcService:this.rtcService,rpcClients:this.rpcClients,rootPlaylistService:this.rootPlaylistService,rootPlaylistQuery:s,mediaLibraryService:f,keySystemAdapter:i,legibleSystemAdapter:r,mediaSink:n,mediaParser:t,iframeMachine:a,playerEvents:this.playerEvents,interstitialService:this.interstitialService,interstitialController:this.interstitialController,customUrlLoader:this.customUrlLoader,gaplessInstance:this,itemQueue:this.itemQueue,operationQueue$:this.operationQueue$}}),Ra()).pipe(La(a=>{if(!a)return wi;const{rootPlaylistQuery:n,mediaSink:s,mediaLibraryService:e,itemQueue:t}=a;this.publicQueriesInternal$.next([n,s.mediaQuery,this.interstitialService.interstitialQuery]);const o=s.mediaQuery,i=this.interstitialController.postRollCheck$(o,a),r=Vi(a).pipe(t0(),ba(e=>e.pipe(La(e=>this._handleError(e))))),l=Vi(a).pipe((T=E,I=E.steeringManifestLoadPolicy,e=>e.pipe(Jc("contentSteeringEpic.in"),La(i=>{var e,t;const{logger:r,operationQueue$:n,rootPlaylistQuery:s}=i,a=s.itemId,o=s.rootPlaylistEntity,l=o.contentSteeringOption;if(null==l)return un;const d=Vm(a),u=new Si(3e5);let c=l.serverURI,h=o.baseUrl;const p=null===(e=null===(e=Ym())||void 0===e?void 0:e.getQuery())||void 0===e?void 0:e.extendMaxTTFB;return Oh.pipe(Jc("loadSteeringManifest"),La(()=>function(r,n,s,a,o,l,d){return en(()=>{var e=Th(r);if(null!=e)return Vi({responseText:B.utf8arrayToStr(e),responseURL:r});const t=gu.parseURL(r),i=[];return""!==t.query&&"?"!==t.query&&i.push(t.query.substr(1)),null!=o&&i.push(`_HLS_pathway=${encodeURIComponent(o)}`),null!=l&&Z(l.avgBandwidth)&&i.push(`_HLS_throughput=${l.avgBandwidth}`),0<i.length&&(t.query="?"+i.join("&"),r=gu.buildURLFromParts(t)),e=Dc({url:r},a),Wc({url:r,xhrSetup:s.xhrSetup},e,d,xc())}).pipe(pr(({responseText:e,responseURL:t})=>{var{steeringManifest:i,playlistParsingError:e}=function(e,t){let i,r,n;try{try{i=JSON.parse(e)}catch(e){throw qm("steering manifest JSON format is malformed")}if(null==i)throw qm("steering manifest is empty");if(n={version:i.VERSION,ttl:i.TTL,universal:i.UNIVERSAL,pathwayPriority:i["PATHWAY-PRIORITY"]},null!=i["RELOAD-URI"]){if("string"!=typeof i["RELOAD-URI"])throw qm("invalid steering manifest RELOAD-URI data type");n.reloadURI=gu.buildAbsoluteURL(t,i["RELOAD-URI"])}const r=function(e){if("number"!=typeof e.version)return qm("invalid steering manifest VERSION data type");if(e.version<1||1<e.version)return qm("steering manifest VERSION "+e.version+" is unsupported");if("number"!=typeof e.ttl)return qm("invalid steering manifest TTL data type");if(e.ttl<0)return qm("invalid steering manifest TTL value");if(null!=e.reloadURI&&"string"!=typeof e.reloadURI)return qm("invalid steering manifest RELOAD-URI data type");if(null!=e.universal&&"boolean"!=typeof e.universal)return qm("invalid steering manifest UNIVERSAL data type");if(!Bo(e.pathwayPriority))return qm("invalid steering manifest PATHWAY-PRIORITY data type");for(const t of e.pathwayPriority){const e=jm(t);if(null!=e)return e}}(n);if(null!=r)throw r}catch(e){r=e instanceof L?e:qm(`unknown exception when parsing steering manifest: ${e}`)}return{steeringManifest:n,playlistParsingError:r}}(e,n);if(null!=e)throw e;return{steeringManifest:i,responseURL:t}}))}(c,h,T,I,s.currentPathwayID,d.getBandwidthEstimate(),p)),eo(({steeringManifest:e,responseURL:t})=>{h=t,null!=e.reloadURI&&(c=e.reloadURI),u.next(1e3*e.ttl),e=function(s,a,o){const{config:l,logger:d,mediaLibraryService:u,mediaSink:e,rootPlaylistQuery:c,rootPlaylistService:h}=s,p=e.mediaQuery;return{operation:Pm.ContentSteering,priority:Mm.Low,execute:(t,i,r)=>{var e=en(()=>(ol(()=>{var e=o.pathwayPriority,t=c.rootPlaylistEntity,i=t.mediaOptionListTuple[Tu.Variant];if(!function(t=[],i=[]){if(t.length===i.length){for(let e=0;e<t.length;e++)if(t[e]!==i[e])return;return 1}}(i.pathwayPriority,e)){const r=Vm(a),n=qv(Object.assign(Object.assign({},t),{mediaOptionListTuple:[Object.assign(Object.assign({},i),{pathwayPriority:e}),Object.assign(Object.assign({},t.mediaOptionListTuple[Tu.AltAudio]),{compatibleIds:null}),t.mediaOptionListTuple[Tu.Subtitle]]}),Ym().getQuery().alternateMatchingInfo,d,l,r.getBandwidthEstimate(),null,r.getPlaylistEstimate(),r.getFragEstimate(),r.getBufferEstimate());h.setRootPlaylistEntity(a,n)}}),Oh)).pipe(La(e=>gv(s,t,0,r).pipe(Ka(Sv(t,i,c,u,p,l,d))))),n=en(()=>{});return an(()=>!1,Vi(void 0).pipe(eo(()=>{})),Zr(e,n))},logger:d}}(i,a,e),n.next(e)}),Qn(e=>(r.error("error in Content Steering epic:",e),Oh)),(t=()=>u.pipe(Wa(e=>0<e),La(e=>En(e))),function(e){return e.lift(new fa(t))}))}),Va(un)))),d=n.rootPlaylistEntity$.pipe(If(),As(1),eo(()=>{var e=null===(e=t.activeItem)||void 0===e?void 0:e.initialRate;Rf(e)&&(s.desiredRate=e)}),cn(e=>!e.isInterstitial&&!this.commitedEarlyAlternateSelection),eo(()=>{this.commitAlternateMatchingInfo(a.logger)})),u=Ah(Pr([o.haveEnough$,n.sessionData$,Xm().config$]),([e])=>!0===e,1).pipe(La(([,e,t])=>this.sessionDataLoader.loadSessionData(e,t)),eo(e=>{this.rootPlaylistService.setSessionData(n.itemId,e)}),Qn(e=>(this.logger.error(e.message),wi))),h=Vm(n.itemId),c=function(d,e,r,u,n){const c=u.mediaQuery,t=Pr([h.bandwidthEstimate$,h.fragEstimate$,h.bufferEstimate$]);return e=e.child({name:"haveEnough"}),Ah(c.combinedBuffer$,e=>0<(null==e?void 0:e.length)).pipe(La(()=>{var e=c.mediaBufferInfo$(d.maxBufferHole);return Pr([r.getInFlightFragByType$(Tu.Variant).pipe(cn(e=>null==e||null==e.bwSample||0<e.bwSample.tfirst),La(t=>{let i=r.enabledVariantMediaOption;return t&&(i=r.variantMediaOptionById(t.mediaOptionId)),n.getQueryForOption(i).mediaOptionDetails$.pipe(pr(e=>[t,{variant:i,details:e}]))})),e,c.desiredRate$])}),To(t),pr(([[e,i,r],n])=>{var[s,a]=e,e=s?s.duration:10;let o;if(c.withinFragDurationOfContentGap(c.currentTime,e))o=!0;else{const[l,u,c]=n;let e=u,t=c;u&&(e={maxDurationSec:Z(u.maxDurationSec)?u.maxDurationSec:d.defaultTargetDuration,avgParseTimeMs:Z(u.avgParseTimeMs)?u.avgParseTimeMs:d.statDefaults.fragParseTimeMs}),c&&(t={avgBufferCreateMs:Z(c.avgBufferCreateMs)?c.avgBufferCreateMs:d.statDefaults.fragBufferCreationDelayMs,avgInitFragAppendMs:Z(c.avgInitFragAppendMs)?c.avgInitFragAppendMs:d.statDefaults.initFragAppendMs,avgDataFragAppendMs:Z(c.avgDataFragAppendMs)?c.avgDataFragAppendMs:d.statDefaults.dataFragAppendMs}),o=function(e,t,i,r,n,s,a,o){var l,d,u=r.combined,c=yg(e,i.details,r);let h=vg(t,i,r,n,c);return!h&&u&&0<u.len&&null!=t&&t.state&&(h=(l=t,d=i.variant.bitrate,n=c,t=e.maxBufferHole,c=null===(i=r.sbTuple[Tu.Variant])||void 0===i?void 0:i.buffered,i=null===(e=r.sbTuple[Tu.AltAudio])||void 0===e?void 0:e.buffered,((null==c?void 0:c.len)>=n&&(!i||i.len>=n)?0:c&&l&&(e=r.pos,(i=l.start+l.duration)>c.end&&(l.start-c.end<=t||l.start<=c.end)&&n<=i-e)?Sg(l,d,s,a,o):1/0)<=u.len)),h}(d,s,a,i,r,l,e,t)}return u.haveEnough=o,o}),bs(),eo(e=>{}),Va(wi))}(E,this.logger,n,s,e),p=function(){const{config:e,mediaSink:t,rootPlaylistQuery:i,mediaLibraryService:r,gaplessInstance:n}=a,s=t.mediaQuery;return Ah(s.combinedBuffer$,e=>0<(null==e?void 0:e.length)).pipe(Va(Pr([Cy(i,r),s.msReadyState$,s.updating$,s.isIframeRate$,s.isBufferedToEnd$(e.maxBufferHole,!n.inGaplessMode)])),Jc("checkForEndOfStream"),cn(([,e,t,i,r])=>"open"===e&&!1===t&&!i&&r),eo(([e])=>{null!=e[0]&&e.every(e=>null==e||!1===e.liveOrEvent&&!1===e.iframesOnly)&&!n.inGaplessMode&&t.endStream()}),Va(wi))}(),f=function(l){const{config:d,iframeMachine:u,mediaSink:i}=a,c=i.mediaQuery;return c.desiredRate$.pipe(La(o=>Rf(o)?En(0,Math.abs(1e3/o)).pipe(pr(()=>{let e=null;const t=c.seekable;if(!u.isStarted||t.length<1)return e;var i=u.iframeClockTimeSeconds,r=l.getQueueItemForTime(i),n=null!==(a=null==r?void 0:r.itemStartOffset)&&void 0!==a?a:0,s=d.leftMediaTimeToAutoPause,r=t.start(0),a=t.end(t.length-1);return 1<o&&a-i<s?(e={newRate:0,postFlushSeek:a-s},u.pause()):o<0&&i-n-r<o/-2&&(e={newRate:1,postFlushSeek:r}),e}),If(),eo(({newRate:e,postFlushSeek:t})=>{i.postFlushSeek=t,i.desiredRate=e}),Va(wi)):wi))}(this.itemQueue),m=a.config.enableIFramePreloading?function(t){const{mediaSink:e,rootPlaylistQuery:r,mediaLibraryService:n}=t,i=e.mediaQuery;return rd([i.desiredRate$,i.waterLevelChangedForType$(Iu.Variant)]).pipe(La(([e,t])=>Rf(e)||t!==nf.AboveHighWater?wi:r.enabledMediaOptionByType$(Tu.Variant).pipe(pr(e=>{var t=r.mediaOptionListQueries[Tu.Variant].hasIframes,i=null!==(i=null===(i=n.getQuery().getEntity(r.itemId))||void 0===i?void 0:i.liveOrEvent)&&void 0!==i&&i;return!t||i?Gg.DISABLED:e}))),As(1),xs(e=>function(e,t){const i=t.logger;return e===Gg.DISABLED?Vi(e):function(e,t){const{rootPlaylistQuery:i,logger:r,config:n,mediaSink:s,statsService:a}=t,o=s.mediaQuery,l=a.getQueryForItem(i.itemId),d=Xy(!0,n,i,vy(e),o,l,r),u=i.variantMediaOptionById(d.variantMediaOption);return Sy(t,u,!0)}(e,t).pipe(xs(o=>function(e){const{mediaSink:t,rootPlaylistQuery:i,config:r}=e,n=t.mediaQuery,s=hg(n.currentTime,i.discoSeqNum,0,o,[],r.maxFragLookUpTolerance,n.getContentGapRanges());if(null===(a=null==s?void 0:s.foundFrag)||void 0===a||!a.mediaFragment)return Ki("Unable to find fragment for iframe prefetch");var a=s.foundFrag.mediaFragment;return tn([Ay(e,a.keyTagInfo,{itemId:a.itemId,mediaOptionId:a.mediaOptionId}),Ty(e,a)]).pipe(eo(()=>{}),Ys(Gg.SUCCESS))}(t)),Ys(Gg.SUCCESS),Qn(e=>(i.error(Hv,`got error ${e.message} in prefetch`),Vi(Gg.ERRORED))))}(e,t)),Bs(()=>{}))}(a):Vi(Gg.DISABLED),g=Ah(rd([o.gotPlaying$,o.gotLoadStart$,o.readyState$]),([e,t,i])=>!0===e||!0===t||1<=i).pipe(La(()=>o.ended$),La(e=>En(0,e?void 0:1e3)),eo(()=>{this.playbackInfo(E,o)})),y=o.timeupdate$.pipe(La(e=>{if(this.inGaplessMode&&this.isPreloading){var t=this.itemQueue.playingItem,i=this.itemQueue.loadingItem,r=this.itemQueue.activeItem;if(Z(i.itemStartOffset)&&e>=i.itemStartOffset&&t!==r)return this.itemQueue.updatePlayingItemId(!E.enableInterstitialPlayback),this.traverseItemBoundary(i,this.interstitialController,n,s)}return wi})),v=o.isBufferedToEnd$(E.maxBufferHole).pipe(cn(e=>e),pr(t=>{var i=this.itemQueue.activeItem,r=o.minSBDuration-i.itemStartOffset;if(Math.abs(r)<E.maxBufferHole)return null;const n=null==i?void 0:i.loopCount;if(Z(n)&&0<n||n===1/0){const t=o.getCombinedBufferInfo(o.currentTime,.5);let e=0;t&&(e=t.end);const n=Object.assign(Object.assign({itemStartOffset:e,initialSeekTime:Z(i.initialSeekTime)?i.initialSeekTime-i.itemStartOffset+e:NaN,parentItemId:null!==(r=i.parentItemId)&&void 0!==r?r:i.itemId},i),{loopCount:i.loopCount-1,seekImmediately:!1});return{activeItem:i,nextItem:_v.createItem(i.name,i.url,!1,n)}}}),If(),La(({nextItem:e})=>(ol(()=>{this.itemQueue.insertQueueItem(e),this.itemQueue.setActive(e.itemId,e.itemStartOffset,e.initialSeekTime)}),wi))),S=this.itemQueue.playing$.pipe(If(),cn(()=>!this.hlsConfig.enableInterstitialPlayback),bs((e,t)=>e.itemId===t.itemId),da(),eo(([e,t])=>{var i=e.itemId,e=t.itemId,t={prevItemId:i,nextItemId:e,nextStartTime:t.itemStartOffset,nextDuration:o.msDuration-t.itemStartOffset};this.trigger(_.ITEM_TRANSITIONED,t),this.rtcService.itemTransitioned(i,e)}),Va(wi)),b=[Zv(this.itemQueue,this.hlsService,a),r,l,u,c,g,f,m,y,S,p,i,v,d];var T,I;if(E.enablePerformanceLogging&&null!=["info","debug","trace"].find(e=>e===E.debugLevel)){this.logger.child({name:"timing"});const a=dn(...zu.map(r=>n.getInFlightFragByType$(r).pipe(bs((e,t)=>(null==e?void 0:e.state)===(null==t?void 0:t.state)),If(),To(o.bufferedRangeTuple$),eo(([e,t])=>{const i=Object.assign(Object.assign({},e),{event:"fragment",name:Gu[r],buffered:void 0});"appended"===e.state&&(i.buffered=t)}),Qn(()=>wi)))),s=dn(...Wu.map(e=>n.enabledMediaOptionByType$(e).pipe(La(e=>null!=(null==e?void 0:e.url)&&ju(e)?vy(e).mediaOptionDetailsEntity$.pipe(pr(e=>null==e?void 0:e.detailsLoading),bs(),eo(e=>{})):wi),Qn(()=>wi))));b.push(a,s)}return dn(...b)})),P=this.itemQueue.removedItems$.pipe(dl(e=>{var t;t=e,yy().remove(t),this.rootPlaylistService.removeItems(e),this.rtcService.removeItemList(e)})),x=this.interstitialController.playback$.pipe(eo(e=>{e&&this.config.forcePauseOnInterstitialBoundary&&this.setRate(0)})),D=p.getQuery().selectEntityAction(_o.Add).pipe(eo(()=>{this.logger.warn(`new Hls instance added while old one still active sessionId:${c}`)}));dn(v.pipe(Qn(()=>wi)),dn(y,S,P,M,x,this.teardownWG$).pipe(Qn(e=>this._handleError(e)))).pipe(Bs(()=>{var e,t;try{this.detachMedia(),this.trigger(_.DESTROYING),this.playerEvents.destroy(),null===(e=this.accessLogInstance)||void 0===e||e.destroy(),null===(t=this.rtcController)||void 0===t||t.destroy(),this.statsService.removeAll(),yy().clear(),this.rootPlaylistService.removeAll(),this.itemQueue.clearQueue(),p.removeEntity(this.sessionID),this.interstitialService.reset(),this.interstitialController.destroy()}catch(e){this.logger.error(`Got error in finalize ${e.message}`)}}),Ka(yn(this.destroy$,D))).subscribe()}get publicQueries$(){return this.publicQueriesInternal$.pipe(cn(e=>Boolean(e)&&Boolean(e[0])&&Boolean(e[1])&&Boolean(e[2])))}get _activeRootQuery(){var e=this.publicQueriesInternal$.value;return null!==(e=null==e?void 0:e[0])&&void 0!==e?e:null}get _mediaElementQuery(){var e=this.publicQueriesInternal$.value;return null!==(e=null==e?void 0:e[1])&&void 0!==e?e:null}static get version(){return"2.330.1"}static get Events(){return _}static get ErrorTypes(){return M}static get ErrorDetails(){return P}get Events(){return o0.Events}get ErrorTypes(){return o0.ErrorTypes}get ErrorDetails(){return o0.ErrorDetails}static get DefaultConfig(){return ne(Qu)}get DefaultConfig(){return o0.DefaultConfig}static isSupported(){try{const e=window.MediaSource||window.WebKitMediaSource,t=window.SourceBuffer||window.WebKitSourceBuffer,i=e&&"function"==typeof e.isTypeSupported&&e.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),r=!t||t.prototype&&"function"==typeof t.prototype.appendBuffer&&"function"==typeof t.prototype.remove;return!!i&&!!r}catch(e){return!1}}static loadRemoteConfigurations(e,t,i){var r,n,s,a={maxNumRetry:0,maxRetryDelayMs:0,retryDelayMs:0};return r=e,n={xhrSetup:i},s=Object.assign(Object.assign({},t),{autoRetry:!1,timeoutRetry:a,errorRetry:a}),en(()=>Wc({url:r,xhrSetup:n.xhrSetup},s,0,xc()).pipe(pr(({responseText:e})=>JSON.parse(e))))}traverseItemBoundary(t,i,e,r){let n=t.initialSeekTime;const s=r.mediaQuery,a=s.getBufferedSegmentsByType(Iu.Variant).find(e=>e.frag.itemId===t.itemId);return Ah(null!=a&&a.frag?Vi(a.frag):e.lastLoadedMediaOptionByType$(Tu.Variant),e=>!!e).pipe(La(e=>{if(null!=(e=null===(e=yy().getQueryForOption(e))||void 0===e?void 0:e.mediaOptionDetails)&&e.liveOrEvent){const t=ay(e,this.config);n=Math.min(t,n)}return this.config.enableInterstitialPlayback&&t.snapIn&&i&&(n=i.snapIn(t,e)),Ah(s.mediaElementDuration$,e=>(!Z(n)||e>n)&&0<e).pipe(pr(e=>n<0?e-.5:n),pr(e=>this._seekAcrossJaggedSegment(t.itemStartOffset,e,s)),eo(e=>{Z(e)&&e>=s.currentTime-this.config.maxSeekHole&&r.seekWithOptions(e,void 0,!0,!1)}),Va(wi))}))}_seekAcrossJaggedSegment(e,t,i){const r=Z(t)?t:e,n=i.getCombinedBufferInfo(r,0).nextStart;if(Z(n)){const e=i.getBufferedSegmentsByType(Iu.Variant).find(e=>e.startPTS<=r&&e.endPTS>r);e&&e.startPTS<=n&&e.endPTS>n&&(t=n)}return t}commitAlternateMatchingInfo(e){var t=null===(t=null===(t=Ym().getQuery().alternateMatchingInfo)||void 0===t?void 0:t.audioMatchingInfo)||void 0===t?void 0:t.persistentId;Z(t)&&(this.audioSelectedPersistentID=t),Z(t=null===(t=null===(t=Ym().getQuery().alternateMatchingInfo)||void 0===t?void 0:t.subtitleMatchingInfo)||void 0===t?void 0:t.persistentId)&&(this.subtitleSelectedPersistentID=t),this.commitedEarlyAlternateSelection=!0}_handleError(e){var t;try{var i,r=e.message;if(this.logger.error(`Got unhandled or fatal error ${r}`),i=e instanceof g?e:new Q(!0,e.message,K.InternalError),null===(t=this.rtcService)||void 0===t||t.handleError(i,this.interstitialActive),i.fatal&&this.isPreloading&&!this.config.enableInterstitialPlayback&&(this.logger.warn("Fatal error seen while preloading, calling dequeueSource"),this.dequeueSource("FatalErrorWhileLoading")),i.fatal)return this.interstitialController.handleError(i).pipe(eo(({handled:e,error:t})=>{e&&this.trigger(_.ERROR,Object.assign(Object.assign({},t),{fatal:!1,interstitial:!0}))}),cn(({handled:e,error:t})=>!e&&t.fatal),Hr(({error:e})=>this.mediaElementAdapter&&this.mediaElementAdapter.mediaQuery.gotPlaying?Ah(this.mediaElementAdapter.mediaQuery.stallInfo$,e=>null!=e).pipe(Ys(e)):Vi(e)),Hr(e=>(this.trigger(_.ERROR,e),wi)));this.trigger(_.ERROR,i)}catch(e){throw this.logger.error(`Error thrown inside _handleError ${e.message}`,e),e}return wi}playbackInfo(i,r){const n=this.mediaElement$.getValue();if(n){const s=n.readyState>=n.HAVE_FUTURE_DATA,a={readyToPlay:s,playbackLikelyToKeepUp:r.haveEnough&&s,rate:n.playbackRate,paused:n.paused,position:n.currentTime,duration:n.duration,seekableTimeRanges:this.seekableTimeRanges.map(e=>[e.start,e.end]),loadedTimeRanges:Qm.timeRangeToArray(n.buffered),interstitialActive:this.interstitialActive};let e=0,t=0;if(Qm.isHtmlVideoElement(n)){const o=n.getVideoPlaybackQuality;if(o&&typeof o==typeof Function){const o=n.getVideoPlaybackQuality();e=a.droppedVideoFrames=o.droppedVideoFrames,a.corruptedVideoFrames=o.corruptedVideoFrames,a.totalVideoFrames=o.totalVideoFrames,t=a.totalVideoFrames-e}}else Qm.isWebkitMediaElement(n)&&(e=a.droppedVideoFrames=n.webkitDroppedFrameCount,t=a.decodedFrameCount=n.webkitDecodedFrameCount);i.enablePerformanceLogging&&r.getCombinedMediaSourceBufferInfo(i.maxBufferHole),null===(i=this.rtcService)||void 0===i||i.handlePlaybackInfo(e,t)}}get currentItem(){return this.isPreloading?this.playingItem:this.itemQueue.activeItem}get realCurrentTime(){var e,t=this._mediaElementQuery;if(!t){const r=this.itemQueue.activeItem;return null!==(e=null==r?void 0:r.initialSeekTime)&&void 0!==e?e:NaN}if(null!==(e=this.iframeMachine)&&void 0!==e&&e.isStarted){const n=t.mediaElementDuration,r=this.iframeMachine.iframeClockTimeSeconds;return r>n?n:r}let i;if(i=Z(t.postFlushSeek)?t.postFlushSeek:t.desiredPos,t=null===(e=this.playingItem)||void 0===e?void 0:e.itemStartOffset,Z(i)&&Z(t))if(this.hlsConfig.enableInterstitialPlayback)if(this.interstitialActive){const n=this.interstitialService.interstitialQuery,r=n.playingInterstitialId;i-=null!==(e=n.realCurrentTimeOffsetMap[r])&&void 0!==e?e:0}else i-=t;else i-=t;return Math.max(0,i)}set realCurrentTime(e){var t;!this.hlsConfig.enableInterstitialPlayback&&Z(null===(t=this.playingItem)||void 0===t?void 0:t.itemStartOffset)&&(e+=this.playingItem.itemStartOffset),this.seekTo=e}get realDuration(){return this._mediaElementQuery?this._mediaElementQuery.primaryContentMediaElementDuration:1/0}get bufferedDuration(){var e;const t=this._mediaElementQuery;return null!==(e=null==t?void 0:t.getBufferedDuration())&&void 0!==e?e:0}get sessionData(){var e=this._activeRootQuery;return null==e?void 0:e.sessionData}get supportedFrameRates(){const e=this.hlsConfig.trickPlaybackConfig.enabled,t=this.hlsConfig.liveAllowTrickplay,i=[0,1],r=this._activeRootQuery,n=yy().getQuery();return e&&r&&n.getEntity(r.itemId)&&(n.getEntity(r.itemId).liveOrEvent&&!t||i.push(8,24,48,96)),i}loadSource(e,i={},t){var r,n,s,a,o,l;if("playready"===this.config.keySystemPreference&&!this.config.enablePlayReadyKeySystem)throw new Q(!0,"Playready key system is not supported now",K.UnsupportedKeySystemError);if(!e||!e.trim().length)throw new Q(!0,"Empty loadSource url",K.EmptyLoadSourceError);if(e=Au.buildAbsoluteURL(window.location.href,e,{alwaysNormalize:!0}),i&&Object.keys(i).filter(e=>0<=["itemId","streamID"].indexOf(e)).reduce((e,t)=>t in i?Object.assign(e,{[t]:i[t]}):e,{}),null!==(l=null==i?void 0:i.appData)&&void 0!==l&&l.reportingAgent&&(this.reportingAgent=i.appData.reportingAgent),null!=i&&i.userInfo&&(this.userInfo=i.userInfo),null===(a=this.accessLogInstance)||void 0===a||a.setupReporter(null==i?void 0:i.appData),null!=i&&i.platformInfo&&this.platformService.updatePlatformInfo(i.platformInfo),function(e,t){if(t){const t=ku(e);return void 0!==Cu.find(e=>new RegExp(e).exec(t))}}(e,this.config.enableQueryParamsForITunes)){const d={language:i.language,dsid:i.dsid,subs:i.subs};r=e,n=null==i?void 0:i.platformInfo,s=d,o=n.model,l=n.manufacturer,o&&l||Ge().warn(`Missing model/manufacturer in platformInfo model ${o} manufacturer ${l}`),o&&l&&(a=r,o=n.model,l=n.manufacturer,n=-1!==a.indexOf("?"),o=encodeURIComponent(o),l=encodeURIComponent(l),r=(a=n?a:a+"?")+Mu.deviceName+l+Mu.deviceModel+o),e=function(e,t){let i;e=-1!==e.indexOf("?")?e:e+"?";const r=Ge();for(i in t)t[i]?e+=Mu[i]+("subs"===i?encodeURIComponent(t[i]):t[i]):r.warn(`Missing ${i} info`);return e}(r,s)}this.commitedEarlyAlternateSelection=!1,t={initialSeekTime:t,platformInfo:null==i?void 0:i.platformInfo,clientName:null===(s=null==i?void 0:i.appData)||void 0===s?void 0:s.clientName,serviceName:null===(t=null==i?void 0:i.appData)||void 0===t?void 0:t.serviceName,appName:null===(s=null==i?void 0:i.appData)||void 0===s?void 0:s.appName,loopCount:null==i?void 0:i.loopCount},this.itemQueue.setQueueItem(`item:${null!==(s=null==i?void 0:i.itemId)&&void 0!==s?s:Zl()}`,e,!1,t)}queueSource(e,t,i){var r;null!=t&&t.userInfo&&(this.userInfo=t.userInfo);var n=null===(r=this._mediaElementQuery)||void 0===r?void 0:r.getCombinedBufferInfo(null===(n=this._mediaElementQuery)||void 0===n?void 0:n.currentTime,0);let s=0;n&&(s=n.end),i={itemStartOffset:s,initialSeekTime:i,platformInfo:null==t?void 0:t.platformInfo,clientName:null===(i=null==t?void 0:t.appData)||void 0===i?void 0:i.clientName,serviceName:null===(i=null==t?void 0:t.appData)||void 0===i?void 0:i.serviceName,appName:null===(i=null==t?void 0:t.appData)||void 0===i?void 0:i.appName,loopCount:null==t?void 0:t.loopCount},this.itemQueue.addQueueItem(`item:${null!==(t=null==t?void 0:t.itemId)&&void 0!==t?t:Zl()}`,e,!1,i)}dequeueSource(e="ApplicationInitiated"){if(this.config.enableInterstitialPlayback)this.logger.warn("Refusing to dequeueSource because interstitials are enabled");else{if(!this.isPreloading&&"InvalidFormat"===e&&this.isFirstItem)return this.logger.error("First item has invalid format for gapless. Probably video. Disabling gapless."),void(this.gaplessCapable=!1);var t,i;this.isPreloading?(t=this.loadingItem.url,i=this.loadingItem.itemId,this.mediaElementAdapter.flushData(Iu.Variant,this.loadingItem.itemStartOffset,1/0),this.mediaElementAdapter.msDuration=this.loadingItem.itemStartOffset,this.itemQueue.resetLoadingItem(),"InvalidFormat"!==e&&"FatalErrorWhileLoading"!==e||(this.gaplessCapable=!1),this.triggerItemEvicted({url:t,itemId:i},e)):this.logger.warn(`Nothing to dequeue, no item is preloading dequeue reason: ${e}`)}}triggerItemEvicted(e,t){null!==e?(t={url:e.url,evictedItemId:e.itemId,reason:t},Object.assign(Object.assign({},t),{url:re(e.url)}),this.trigger(_.ITEM_EVICTED,t)):this.logger.error("dequeueSource called with no playing or loading item")}endSource(){this.gaplessCapable=!1,this.isPreloading&&(this.logger.warn("EndSource called during preloading. Loading item will be removed"),this.mediaElementAdapter.flushData(Iu.Variant,this.loadingItem.itemStartOffset,1/0),this.mediaElementAdapter.msDuration=this.loadingItem.itemStartOffset,this.itemQueue.resetLoadingItem())}get inGaplessMode(){var e;return(null===(e=Jm())||void 0===e?void 0:e.gapless)&&this.gaplessCapable}get isPreloading(){return this.itemQueue.isPreloading()}get isFirstItem(){return this.itemQueue.isFirstItem}get loadingItem(){return this.itemQueue.loadingItem}get playingItem(){return this.itemQueue.playingItem}get url(){return this.playingItem?this.playingItem.url:this.loadingItem?this.loadingItem.url:void 0}destroy(){const t=this.logger;return this.destroy$.next(),null!=this.rpcService&&(this.teardownWG$.add(),this.rpcService.teardown(e=>{e&&t.error("RPCService teardown error:",e),this.teardownWG$.done()}),this.rpcService=null),null!=this.iframeMachine&&(this.iframeMachine.destroy(),this.iframeMachine=null),this.teardownWG$.toPromise()}attachMedia(e){this.trigger(_.MEDIA_ATTACHING,{media:e}),this.mediaElement$.next(e),this.trigger(_.MEDIA_ATTACHED,{media:e})}detachMedia(){var e;this.mediaElement$.getValue()&&(this.trigger(_.MEDIA_DETACHING),null===(e=this.rtcService)||void 0===e||e.detachMedia(),null!=this.iframeMachine&&this.iframeMachine.stop(),this.mediaElement$.next(null),this.trigger(_.MEDIA_DETACHED))}handleResolvedUri(e,t){this.customUrlLoader.setCustomUrlResponse(e,{uri:t.uri,response:t})}get variantOptions$(){return this.publicQueries$.pipe(La(e=>{const[t,i]=e;return Pr([t.filteredMediaOptions$,i.desiredRate$]).pipe(pr(([e])=>{const t=i.isIframeRate;return e[Tu.Variant].filter(e=>(null!==(e=e.iframes)&&void 0!==e&&e)===t).map(e=>e.mediaOptionId)}))}))}get altAudioOptions$(){return this.publicQueries$.pipe(La(e=>{var[e]=e;return Vi(e.audioMediaSelectionOptions)}))}get subtitleOptions$(){return this.publicQueries$.pipe(La(e=>{var[e]=e;return Vi([{MediaSelectionOptionsName:"Disable subtitle",MediaSelectionOptionsPersistentID:-1}].concat(e.subtitleMediaSelectionOptions))}))}get levels(){var e;return null!==(e=null===(e=this._activeRootQuery)||void 0===e?void 0:e.filteredMediaOptions[Tu.Variant])&&void 0!==e?e:[]}get audioTracks(){var e;return null!==(e=null===(e=this._activeRootQuery)||void 0===e?void 0:e.filteredMediaOptions[Tu.AltAudio])&&void 0!==e?e:[]}get audioMediaOptions(){var e;return null!==(e=null===(e=this._activeRootQuery)||void 0===e?void 0:e.audioMediaSelectionOptions)&&void 0!==e?e:[]}get subtitleMediaOptions(){var e;return null!==(e=null===(e=this._activeRootQuery)||void 0===e?void 0:e.subtitleMediaSelectionOptions)&&void 0!==e?e:[]}get playbackLikelyToKeepUp(){var e;return null!==(e=null===(e=this._mediaElementQuery)||void 0===e?void 0:e.playbackLikelyToKeepUp)&&void 0!==e&&e}get duration$(){return this.publicQueries$.pipe(La(e=>{var[,e]=e;return e.mediaElementDuration$}))}get timeupdate$(){return this.publicQueries$.pipe(La(e=>{var[,e]=e;return e.timeupdate$}))}get playing$(){return this.publicQueries$.pipe(La(e=>{var[,e]=e;return e.gotPlaying$}))}get desiredRate$(){return this.publicQueries$.pipe(La(e=>{var[,e]=e;return e.desiredRate$}))}bufferedRangesForPlayerType(e){if(!this._mediaElementQuery)return[];const o=e===Eu.Interstitial,t=this._mediaElementQuery.getBufferedSegmentsByType(Iu.Variant).reduce((e,t)=>{var i=this.itemQueue.getQueueItemForId(t.frag.itemId);if(i.isInterstitial===o){const o=i.itemStartOffset,r=Z(i.initialSeekTime)?i.initialSeekTime:0,n=Math.max(0,r-o),s=null!==(i=t.appendStart)&&void 0!==i?i:0,a=null!==(t=t.appendEnd)&&void 0!==t?t:0;e.push({start:Math.max(0,s-o+n),end:Math.max(0,a-o+n)})}return e},[]);return gf.getBufferedTimeRanges(t,this.hlsConfig.maxBufferHole)}seekableTimeRangesForPlayerType(e){if(e!==Eu.Interstitial)return 0===this._mediaElementQuery.getBufferedSegmentsByType(Iu.Variant).filter(e=>!(null!=(e=this.itemQueue.getQueueItemForId(e.frag.itemId))&&e.isInterstitial)).length?[{start:0,end:this.realDuration}]:this.seekableTimeRanges.map(e=>{var t=this.itemQueue.getQueueItemForTime((e.end-e.start)/2);return t?{start:Math.max(0,e.start-t.itemStartOffset),end:e.end-t.itemStartOffset}:e});{const t=this.interstitialService.interstitialQuery,i=[],r=null!==(e=t.playingInterstitialId)&&void 0!==e?e:t.activeInterstitialId;if(r){const n=t.getInterstitialForId(r);n&&i.push({start:0,end:null!==(e=n.duration)&&void 0!==e?e:0})}return i}}set desiredRate(e){null!=e&&this.setRate(e)}get desiredRate(){var e;return null!==(e=null===(e=this._mediaElementQuery)||void 0===e?void 0:e.desiredRate)&&void 0!==e?e:0}get effectiveRate(){var e;return null!==(e=null===(e=this._mediaElementQuery)||void 0===e?void 0:e.effectiveRate)&&void 0!==e?e:0}get iframeMode(){var e;return null!==(e=null===(e=this._mediaElementQuery)||void 0===e?void 0:e.isIframeRate)&&void 0!==e&&e}get accessLog(){var e;if(!this.accessLogInstance||!this._activeRootQuery)return[];var t=this._activeRootQuery.itemId,i=this.itemQueue.getQueueItemForId(t),t=null!==(i=null!==(e=null==i?void 0:i.parentItemId)&&void 0!==e?e:null==i?void 0:i.itemId)&&void 0!==i?i:t;return this.accessLogInstance&&this._activeRootQuery?this.accessLogInstance.getAccessLog(t):[]}get errorLog(){return this.accessLogInstance?this.accessLogInstance.errorLog:[]}setRate(e){var t;const i=this.logger.child({name:"iframes"});if(e===this.desiredRate)return-2;const r=this.mediaElementAdapter;if(!r||isNaN(e))return i.warn("unable to switch to rate, missing adapter or newRate isNaN"),-1;e=Number(e);const n=Math.abs(e);if(!this.supportedFrameRates.some(e=>e===n))return i.warn(`unsupported rate(${e})`),-3;const s=Rf(e),a=this.iframeMachine;if(s){if(this.interstitialActive)return i.warn("unable to switch to rate, trickplay disabled during interstitials"),-1;if(this.playingItem&&this.playingItem.itemId!==this.itemQueue.activeItem.itemId){const t=this.rootPlaylistService.getQueryForId(this.playingItem.itemId);if(null==t||!t.mediaOptionListQueries[Tu.Variant].hasIframes)return i.warn("no iframe variants available"),-1;if(this.loadingItem&&this.loadingItem.isInterstitial)return this.interstitialController.cancelInterstitial(this.realCurrentTime,e),0}const t=this._activeRootQuery;if(null==t||!t.mediaOptionListQueries[Tu.Variant].hasIframes)return i.warn("no iframe variants available"),-1;r.postFlushSeek=null}else null!=a&&a.isStarted&&!Z(null===(t=r.mediaQuery)||void 0===t?void 0:t.postFlushSeek)&&(a.pause(),r.postFlushSeek=a.iframeClockTimeSeconds);return r.desiredRate=e,0}get sessionData$(){return this.publicQueries$.pipe(La(([e])=>e.sessionData$))}set skip(e){this._mediaElementQuery&&(this.realCurrentTime=Math.max(0,this.realCurrentTime+e),this.resetIframeClock())}gaplessSeekTo(e){var t;this.playingItem&&e<this.playingItem.itemStartOffset&&(this.logger.warn(`[Gapless] Seeking past track boundary oldSeek=${e}, adjustedSeek=${this.playingItem.itemStartOffset}`),e=this.playingItem.itemStartOffset),this.isPreloading&&(e>this.loadingItem.itemStartOffset&&(this.logger.warn(`[Gapless] Seeking past track boundary oldSeek=${e}, adjustedSeek=${this.loadingItem.itemStartOffset}`),e=this.loadingItem.itemStartOffset),(t=this._mediaElementQuery.getBufferInfo(this._mediaElementQuery.currentTime,this.config.maxBufferHole)[Tu.Variant])&&e<t.buffered.start&&this.dequeueSource("SeekToUnbufferedTimeRanges")),this.hlsService.setUserSeek(e)}interstitialSeekTo(e){var t,i=this.itemQueue.activeItem;if(!i)return e;const r=i.isInterstitial?Eu.Interstitial:Eu.Primary,n=this.realCurrentTime,{adjustedSeek:s,newItemId:a,startOffset:o}=this.interstitialController.getAdjustedSeek(e,this.realCurrentTime,this._mediaElementQuery,this.seekableTimeRangesForPlayerType(r));if((s<n||0===s)&&!this.interstitialActive){if((null!==(t=null===(t=this._mediaElementQuery)||void 0===t?void 0:t.getBufferedSegmentsByType(Iu.Variant))&&void 0!==t?t:[]).find(e=>{var t=this.itemQueue.getQueueItemForId(e.frag.itemId);return null!==(t=null==t?void 0:t.isInterstitial)&&void 0!==t&&t&&s<e.appendStart&&this._mediaElementQuery.currentTime>e.appendStart})||a)return this.interstitialController.reset(),void this.mediaElementAdapter.flushAndCallback(Math.max(s-1,0),1/0,()=>{a&&this.itemQueue.setActive(a,o,s,!0)})}else if((null===(t=this.playingItem)||void 0===t?void 0:t.itemId)!==i.itemId&&(null===(t=this.playingItem)||void 0===t||!t.isInterstitial)&&s>=e){const l=Yc(i.itemId)||Yc(null===(i=this.itemQueue.loadingItem)||void 0===i?void 0:i.itemId);if(l){const d=this.interstitialService.interstitialQuery.getInterstitialForId(l);if(s>E(d.startTime))return void this.interstitialController.cancelInterstitial(e,null,!0)}}this.hlsService.setUserSeek(s)}set seekTo(e){var t,i=Number(e);if(Z(i))if(this.hlsConfig.enableInterstitialPlayback)this.interstitialSeekTo(i);else if(this.inGaplessMode)this.gaplessSeekTo(i);else{const r=this.mediaElementAdapter;r&&Z(null===(t=r.mediaQuery)||void 0===t?void 0:t.postFlushSeek)&&!r.mediaQuery.seekTo?r.postFlushSeek=i:(this.hlsService.setUserSeek(i),this.resetIframeClock())}else this.logger.error(`[seek] got invalid seek value ${e}`)}resetIframeClock(){var e;null!==(e=this.iframeMachine)&&void 0!==e&&e.isStarted&&this.iframeMachine.stop()}seekToDate(e){this.hlsService.setUserSeek(e)}get availableProgramDateTime(){return new Map(this._currentDateToMediaTimeTuple)}get _currentDateToMediaTimeTuple(){if(!this._activeRootQuery||!this.playingItem)return[];let e=this.playingItem.itemId;if(this.hlsConfig.enableInterstitialPlayback&&this.playingItem.isInterstitial){this.currentItem.isInterstitial||(e=this.currentItem.itemId);const s=this.itemQueue.primaryItem;s&&(e=s.itemId)}var t=this.itemQueue.getQueueItemForId(e),i=this.rootPlaylistService.getQueryForId(e).lastLoadedMediaOptionByType(Tu.Variant);if(!i||!ju(i))return[];const r=null!==(i=null===(i=yy().getQueryForOption(i).mediaOptionDetails)||void 0===i?void 0:i.dateToMediaTime)&&void 0!==i?i:[],n=this.hlsConfig.enableInterstitialPlayback?t.itemStartOffset:0;return r.map(([e,t])=>[e,t-n])}get playingDate(){return function(e,t){if(e&&0!==e.length){var i,[r,e]=(i=t,0===e.length?[]:null!==(r=le(e,([,e])=>e<=i))&&void 0!==r?r:e[0]);return Z(e=r+1e3*(t-e))?new Date(e):void 0}}(this._currentDateToMediaTimeTuple,this.realCurrentTime)}get seekableTimeRanges(){var e;return null!==(e=null===(e=this._mediaElementQuery)||void 0===e?void 0:e.seekableTimeRanges)&&void 0!==e?e:[]}get isLive(){if(!this.playingItem)return!1;var e=this.playingItem.isInterstitial?this.playingItem.parentItemId:this.playingItem.itemId;return null!==(e=null===(e=yy().getQuery().getEntity(e))||void 0===e?void 0:e.liveOrEvent)&&void 0!==e&&e}get isPlayingAtLive(){var e;return null!==(e=null===(e=this._mediaElementQuery)||void 0===e?void 0:e.isPlayingAtLive)&&void 0!==e&&e}set variantId(e){}set audioSelectedPersistentID(t){const e=this._activeRootQuery,i=null==e?void 0:e.filteredMediaOptions[Tu.AltAudio];if(i){var r,n=e.itemId;t!==this.audioSelectedPersistentID&&(r={language:null==(r=i.find(e=>e.persistentID===t))?void 0:r.lang,name:null==r?void 0:r.name,persistentId:t},Ym().setAudioAlternateMatchingInfo(r),r=Ym().getQuery().alternateMatchingInfo,this.rootPlaylistService.setEnabledMediaOptionTupleWithMatchedGroups(n,Tu.AltAudio,r,{userInitiated:!0}))}else if(Z(t)&&!(t<0)){this.logger.warn(`[audio] no active item, defer audio track selection: persistentId ${t}`);const e={language:void 0,name:void 0,persistentId:t};Ym().setAudioAlternateMatchingInfo(e)}}get audioSelectedPersistentID(){var e;return this._activeRootQuery?null===(e=this._activeRootQuery.enabledAlternateMediaOptionByType(Tu.AltAudio))||void 0===e?void 0:e.persistentID:null===(e=null===(e=Ym().getQuery().alternateMatchingInfo)||void 0===e?void 0:e.audioMatchingInfo)||void 0===e?void 0:e.persistentId}set subtitleSelectedPersistentID(t){const e=this._activeRootQuery,i=null==e?void 0:e.filteredMediaOptions[Tu.Subtitle];if(i){if(t!==this.subtitleSelectedPersistentID){var r=e.itemId;if(0!==i.length||Z(t)&&!(t<0))if(Z(t)&&-1!==t){const e=i.find(e=>e.persistentID===t),s={language:null==e?void 0:e.lang,name:null==e?void 0:e.name,forced:null==e?void 0:e.forced,persistentId:t};Ym().setSubtitleAlternateMatchingInfo(s);var n=Ym().getQuery().alternateMatchingInfo;this.rootPlaylistService.setEnabledMediaOptionTupleWithMatchedGroups(r,Tu.Subtitle,n)}else Ym().setSubtitleAlternateMatchingInfo(null),this.rootPlaylistService.setEnabledMediaOptionByType(r,Tu.Subtitle,qu)}}else if(Z(t)&&!(t<0)){this.logger.warn(`[subtitle] no active item, defer subtitle track selection: persistentId ${t}`);const e={language:void 0,name:void 0,forced:void 0,persistentId:t};Ym().setSubtitleAlternateMatchingInfo(e)}}get subtitleSelectedPersistentID(){var e;return this._activeRootQuery?null===(e=this._activeRootQuery.enabledAlternateMediaOptionByType(Tu.Subtitle))||void 0===e?void 0:e.persistentID:null===(e=null===(e=Ym().getQuery().alternateMatchingInfo)||void 0===e?void 0:e.subtitleMatchingInfo)||void 0===e?void 0:e.persistentId}get iframeVariants(){var e;return null!==(e=null===(e=this._activeRootQuery)||void 0===e?void 0:e.rootPlaylistEntity.iframeVariants)&&void 0!==e?e:[]}loadImageIframeData$(n,s){var e;return yn([this.publicQueriesInternal$.pipe(As(1),La(e=>{const[t,i]=e,r=function(e,t){if(!e)throw new TypeError("Expected variant array");var i=t?e.find(e=>e.mediaOptionId===t):e[0];if(!i)throw new Error(`Could not find image I-frame variant "${t}" of ${e.length} avaiable variants`);return i}(null==t?void 0:t.rootPlaylistEntity.iframeVariants,null==s?void 0:s.variantId);return function(n,s,a,o,l,d,u,c,h){if(null==n||!ju(n))return Vi(null);const e=n.itemId,t=l.getQueryForOption(n);t.hasEntity(e)||l.createMediaLibraryEntity(e);const p=t.mediaOptionDetails;if(p&&("VOD"===p.type||p.liveOrEvent&&!hy(p,t.mediaOptionDetailsEntity.lastUpdateMillis)))return l.setLastAccessed(n),Vi(p);var i=l.inFlightDetails;return null!==i&&Hu(i.mediaOption,n)?i.request:(i=en(()=>{var{playlistLoadPolicy:e,keySystemPreference:t}=c,i=s.masterVariableList,r=null===(r=null===(r=Ym())||void 0===r?void 0:r.getQuery())||void 0===r?void 0:r.extendMaxTTFB;return l.setDetailsLoading(n),zg(n,s.itemStartOffset,c,c,e,h,t,i,r,p).pipe(pr(by(n,s,a,o,l,d,u,void 0,c,h)),Qn(e=>{if(p)return Vi(p);throw e}),Bs(()=>{l.inFlightDetails=null,l.setDetailsLoading(n,!1)}))}).pipe(Ra()),l.inFlightDetails={mediaOption:n,request:i},i)}(r,t,this.rootPlaylistService,i,yy(),this.interstitialService,this.statsService,this.config,this.logger).pipe(As(1),La(e=>function(e,i,t,r=0){const n=i.fragments,s=e+(Z(r)?r:0);let a=ec.search(n,e=>{var t=e.start;return s>=t&&s<t+e.duration?0:s-t});if(!a){let e,t;if(n.length){const i=n[n.length-1];e=n[0].start,t=i.start+i.duration,s<t&&s+1>e?a=n[0]:s>e&&s-1<t&&(a=n[n.length-1])}if(!a)return Ki(new Error(`Could not find fragment at pos ${s} in playlist "${i.mediaOptionId}" [${e}-${t}]`))}return Vc(a,i.url,t,t.fragLoadPolicy).pipe(pr(([e,t,i])=>r?[Object.assign(Object.assign({},e),{start:e.start-r}),t,i]:[e,t,i]))}(n,e,this.hlsConfig,t.itemStartOffset)),pr(e=>function([e,t,i],r){if(!(t=We.findBox(new Uint8Array(t),["mdat"])).length)throw new Error("could not find mdat");return{fragment:e,data:t[0],stats:i,variant:r}}(e,r)))}),bo(null!==(e=null==s?void 0:s.timeoutMs)&&void 0!==e?e:5e3)),this.destroy$]).pipe(pr(e=>{if(!e)throw new Error("Player destroyed");return e}))}get selectedMediaArray(){const e=this._activeRootQuery;if(!e)return[];const t=[],i=e.enabledAlternateMediaOptionByType(Tu.AltAudio),r=e.enabledAlternateMediaOptionByType(Tu.Subtitle),n=i?e.audioMediaSelectionOptions.find(e=>e.MediaSelectionOptionsPersistentID===i.persistentID):void 0,s=r?e.subtitleMediaSelectionOptions.find(e=>e.MediaSelectionOptionsPersistentID===r.persistentID):void 0;if(n){const e={MediaSelectionGroupMediaType:Ou.AUDIO,MediaSelectionOptionsPersistentID:n.MediaSelectionOptionsPersistentID};t.push(e)}if(s){let e=wu.NO;s.MediaSelectionOptionsDisplaysNonForcedSubtitles&&(e=s.MediaSelectionOptionsDisplaysNonForcedSubtitles);const i={MediaSelectionGroupMediaType:Ou.SUBTITLE,MediaSelectionOptionsDisplaysNonForcedSubtitles:e,MediaSelectionOptionsPersistentID:s.MediaSelectionOptionsPersistentID};t.push(i)}return t}set selectedMediaArray(e){this._activeRootQuery?e.forEach(e=>{e.MediaSelectionGroupMediaType===Ou.AUDIO||e.MediaSelectionOptionsMediaType===Ou.AUDIO?this.audioSelectedPersistentID=e.MediaSelectionOptionsPersistentID:e.MediaSelectionGroupMediaType!==Ou.SUBTITLE&&e.MediaSelectionOptionsMediaType!==Ou.SUBTITLE&&e.MediaSelectionOptionsMediaType!==Ou.CLOSEDCAPTION||(this.subtitleSelectedPersistentID=e.MediaSelectionOptionsPersistentID)}):this.logger.warn("selectedMediaArray: no active item")}getHTMLTextTrack(e){return this.legibleSystemAdapter.getExistingHTMLTextTrackWithSubtitleTrackId(e)}get keysystems(){return this.keySystemAdapter.availableKeySystems}setProtectionData(e){this.keySystemAdapter.initialize(e,Xm().currentConfig.certLoadPolicy)}generateKeyRequest(e,t){this.keySystemAdapter.generateRequest(e,t)&&this.rtcService.licenseChallengeReceived({keyuri:e})}setLicenseResponse(e,t){this.keySystemAdapter.setLicenseResponse(e,t)}get interstitialActive(){return!!this.interstitialService.interstitialQuery.playingInterstitialId}removeInterstitials(e){this.interstitialService.removeInterstitials(e)}cancelInterstitial(e,t){var i=this.interstitialService.interstitialQuery.getInterstitialForId(e);i&&(t=null!=t?t:E(i.startTime)+zc(i),i=Yc(this.itemQueue.playingItem.itemId),this.itemQueue.playingItem.isInterstitial&&i===e&&this.interstitialController.cancelInterstitial(t,null,!0))}createInterstitials(e){this.interstitialService.addInterstitials(e)}updateInterstitial(e,t){this.interstitialService.updateInterstitial(e,t)}levelWithPersistentId(e){this.logger.warn("levelWithPersistentId is deprecated")}startLoad(e){this.logger.warn("startLoad is deprecated"),Z(e)&&(this.logger.warn(`[seek] Seeking to ${null==e?void 0:e.toFixed(3)} via deprecated "startLoad" method. Use loadSource(url, options, startTime) instead.`),this.seekTo=e)}stopLoad(){}get config(){return Jm()}get media(){return null!=this.mediaElement$.value}set subtitleDisplay(e){this.logger.warn(`set subtitleDisplay ${e} is deprecated`)}}},"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||u0).Hls=t()}(!1);
//# sourceMappingURL=hls.js.map
